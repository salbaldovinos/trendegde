# FSD-011d: Analytics & Playbook Views

**TrendEdge -- AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-011d |
| Parent FSD | FSD-011 (Frontend Dashboard & UI/UX) |
| Title | Analytics & Playbook Views |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-12 |

---

## 1. Introduction

### 1.1 Purpose

This sub-FSD specifies the Analytics Dashboard and Playbook Management pages of the TrendEdge frontend. It covers the analytics filter bar, 27 metric cards across 5 groups, equity curve chart, P&L calendar heatmap, R-multiple distribution histogram, time-based analysis charts, MAE/MFE scatter plots, drawdown chart, and all playbook views (list, detail, CRUD, comparison).

### 1.2 Scope

**In Scope**:
- Analytics page (`/analytics`) with all visualizations and metric cards
- Playbook list page (`/playbooks`) with card grid layout
- Playbook detail page (`/playbooks/[id]`) with metrics and charts
- Playbook create/edit/delete forms and workflows
- Playbook comparison view (`/playbooks/compare`)
- Analytics filter bar with URL-synced filter state
- All chart rendering specifications (D3.js)
- Analytics and playbook API endpoints (BFF routes)
- Data models (Playbook, PlaybookMetrics, ClassifyRules, analytics response types)
- TanStack Query caching for analytics and playbook data

**Out of Scope**:
- App shell, navigation, sidebar, command palette -- see [FSD-011a]
- Dashboard home, trendline views -- see [FSD-011b]
- Execution page, journal views, trade detail -- see [FSD-011c]
- Settings, onboarding, AI chat -- see [FSD-011e]
- Backend metric computation formulas -- see [FSD-006]
- Playbook auto-classification engine -- see [FSD-005]

### 1.3 Cross-References

| FSD | Relationship |
|---|---|
| FSD-011a | App shell, sidebar navigation, design system tokens, theme |
| FSD-011b | Dashboard home, trendline chart (shares TradingView charting) |
| FSD-011c | Trade table component (reused in playbook detail), journal views |
| FSD-011e | Settings page, onboarding wizard |
| FSD-005 | Playbook system: auto-classification engine, metric computation |
| FSD-006 | Performance analytics: metric calculation formulas, data aggregation |
| FSD-003 | Trade execution: order routing, position management |

---

## 2. Functional Specifications -- Analytics Dashboard

**Route**: `/analytics`

### 2.1 Analytics Filter Bar

**Source**: FE-FR-032

**Description**: A sticky filter bar at the top of the analytics page that remains visible on scroll. All analytics data re-fetches when any filter changes.

**Filters**:

| Filter | Type | Default | Options |
|---|---|---|---|
| Date Range | Calendar date range picker | Last 90 Days | This Month, Last 30 Days, Last 90 Days, YTD, All Time, Custom |
| Instrument | Multi-select dropdown | All Instruments | All user-traded instruments (dynamic) |
| Playbook | Multi-select dropdown | All Playbooks | All user playbooks (dynamic) |
| Mode | Toggle buttons | Both | Paper, Live, Both |

**Behavior on Filter Change**:
1. All analytics data re-fetches from `GET /api/analytics?date_from=...&date_to=...&instruments=...&playbooks=...&mode=...`.
2. A thin progress bar appears at the top of the content area during the refetch.
3. All charts and metrics update simultaneously once data returns.
4. URL query parameters update to reflect current filter state (enabling bookmarking and sharing).
5. Filter changes debounce at 100ms to prevent excessive API calls during rapid changes.

**Applied Filters Display**: Displayed as removable chips below the filter bar. Each chip shows the filter label and an X button to remove it. A "Clear all" link appears when any non-default filter is active.

**Error Handling**:
- If the analytics fetch fails, display inline error: "Unable to load analytics. Retry." with a retry button.
- Individual chart errors do not affect other charts (each chart handles its own error state independently).

---

### 2.2 Metric Cards Grid

**Source**: FE-FR-033

**Description**: A responsive grid of 27 metric cards organized into 5 labeled groups.

**Layout**: 4 columns on desktop (>1280px), 3 columns on tablet (768-1280px), 2 columns on mobile (<768px). Gap: 16px.

**Card Design**:
- Metric label: `text-xs text-muted-foreground font-medium` (top of card)
- Metric value: `text-lg font-semibold font-mono` (center of card)
- Trend indicator: Small arrow icon (ArrowUp or ArrowDown, 12px) + percentage change text (`text-xs`). Green for improvement, red for deterioration. "Improvement" semantics are defined per metric (e.g., higher win rate = improvement, higher max drawdown = deterioration).
- Optional sparkline: 32px height, `--primary` color, no axis labels.

#### Group 1: Trade Performance

| ID | Metric | Format | Calculation | Improvement = |
|---|---|---|---|---|
| M01 | Win Rate | "68.2%" | Winners / Total Closed | Higher |
| M02 | Loss Rate | "31.8%" | Losers / Total Closed | Lower |
| M03 | Average Winner | "$342" | Mean P&L of winners | Higher |
| M04 | Average Loser | "-$198" | Mean P&L of losers | Lower absolute value |
| M05 | Largest Win | "$1,240" | Max single-trade P&L | Higher |
| M06 | Largest Loss | "-$580" | Min single-trade P&L | Lower absolute value |
| M07 | Profit Factor | "2.14" | Gross Profit / Gross Loss | Higher |
| M08 | Expectancy | "$87/trade" | (Win% x AvgWin) - (Loss% x AvgLoss) | Higher |
| M09 | Total Net P&L | "$4,230" | Sum of all closed P&L | Higher |
| M10 | Total Trades | "47" | Count of closed trades | Neutral (no arrow) |

#### Group 2: Risk-Adjusted

| ID | Metric | Format | Calculation | Improvement = |
|---|---|---|---|---|
| M11 | Sharpe Ratio | "1.82" | Mean return / Std dev (annualized) | Higher |
| M12 | Sortino Ratio | "2.45" | Mean return / Downside deviation | Higher |
| M13 | Calmar Ratio | "3.10" | Annual return / Max drawdown | Higher |
| M14 | Max Drawdown ($) | "$2,340" | Largest peak-to-trough decline | Lower |
| M15 | Max Drawdown (%) | "4.5%" | Max DD as % of peak equity | Lower |
| M16 | Recovery Time | "12 days" | Time from DD trough to new high | Shorter |

#### Group 3: R-Multiple Analysis

| ID | Metric | Format | Improvement = |
|---|---|---|---|
| M17 | Average R | "0.72R" | Higher |
| M18 | Best R | "4.2R" | Higher |
| M19 | Worst R | "-1.0R" | Higher (closer to 0) |
| M20 | R Expectancy | "0.35R" | Higher |

#### Group 4: Execution Quality

| ID | Metric | Format | Improvement = |
|---|---|---|---|
| M21 | Avg Slippage | "0.8 ticks" | Lower |
| M22 | Avg MAE | "12 ticks" | Lower |
| M23 | Avg MFE | "28 ticks" | Higher |
| M24 | Fill Quality | "92%" | Higher |

#### Group 5: Behavioral

| ID | Metric | Format | Improvement = |
|---|---|---|---|
| M25 | Rule Compliance | "85%" | Higher |
| M26 | Cost of Mistakes | "$1,240" | Lower |
| M27 | Avg Conviction | "3.8/5" | Higher |

**States**:

| State | Display |
|---|---|
| Loading | Grid of skeleton metric cards with shimmer animation |
| Success | Populated metric cards with values and trend indicators |
| Empty | "Start trading to see your analytics. Paper trades count! Need at least 5 closed trades for meaningful metrics." CTA: "Go to Execution" button |
| Error | "Unable to calculate analytics. Retry." |
| Partial | If some metrics cannot be computed (e.g., no trades with conviction ratings), those cards show "--" as the value with no trend indicator |

---

### 2.3 Equity Curve Chart

**Source**: FE-FR-034

**Description**: A full-width line chart showing cumulative P&L over time. Rendered with D3.js.

**Axes**:
- X-axis: Time (dates). Auto-scaled to the selected date range in the filter bar.
- Y-axis: Cumulative P&L in dollars. Starting from $0 at the first trade.

**Line**: Smooth curved interpolation with area fill below. Green shaded area above the $0 line; red shaded area below the $0 line.

**Optional Toggles** (checkboxes above the chart):
- "Show Drawdown": Overlays shaded red areas between the equity curve and its running maximum.
- "Show Break-even": Draws a horizontal dashed line at $0.

**Tooltips**: Hover displays a tooltip card with:
- Date
- Cumulative P&L (formatted as dollar amount)
- Trade count up to that point
- Current drawdown percentage

**Paper vs. Live**: If "Both" is selected in the mode filter, two separate lines are rendered: Paper (blue, `--primary`) and Live (green, `--mode-live`), with a legend above the chart.

**Click Interaction**: Clicking a data point on the curve navigates to the trade detail page (`/journal/trade/[id]`) for the trade that occurred on that date.

**States**:

| State | Display |
|---|---|
| Loading | Chart area skeleton with shimmer |
| Success | Rendered equity curve with area fills |
| Empty (no trades) | Empty chart area with $0 horizontal line and message: "No trade data to display." |
| Error | "Unable to render equity curve. Retry." |

---

### 2.4 P&L Calendar Heatmap

**Source**: FE-FR-035

**Description**: A calendar heatmap visualization showing daily P&L as colored cells. Rendered with D3.js.

**Layout**: Monthly grid. One cell per trading day. Weekends and market holidays are grayed out or omitted.

**Color Scale**: Continuous gradient:
- Deep red (`#EF4444` at full saturation): Worst losing day in the visible period.
- White/neutral (`--background`): $0 P&L.
- Deep green (`#22C55E` at full saturation): Best winning day in the visible period.
- Color intensity is proportional to P&L magnitude relative to the min/max of the visible period.

**Cell Content**: Dollar P&L text inside the cell if cell size >= 48px. Otherwise, P&L shown only in tooltip.

**Tooltip on Hover**: Date (full format, e.g., "Tuesday, January 15, 2026"), Day P&L ($, colored green/red), Trade Count, Win/Loss breakdown (e.g., "3W / 1L").

**Navigation**: Month/year navigation arrows (< and >). Default view: current month with 2 prior months visible (3 months total).

**Click Behavior**: Clicking a cell navigates to `/journal?date_from=[date]&date_to=[date]` (filtering journal to that day's trades).

**Legend**: Horizontal color scale bar at the bottom showing the P&L range (e.g., "-$500" on the red end, "$0" in the center, "+$1,200" on the green end).

**States**:

| State | Display |
|---|---|
| Loading | Calendar grid skeleton with shimmer |
| Success | Colored heatmap with P&L values |
| Empty (no trades) | Calendar renders with all cells in neutral color, all values at $0 |
| Error | "Unable to render calendar. Retry." |

---

### 2.5 R-Multiple Distribution Histogram

**Source**: FE-FR-036

**Description**: A bar chart showing how R-multiples are distributed across trades. Rendered with D3.js.

**X-axis**: R-multiple buckets in 0.5R increments: ..., -2R to -1.5R, -1.5R to -1R, -1R to -0.5R, -0.5R to 0R, 0R to 0.5R, 0.5R to 1R, ..., 3R to 3.5R, 3.5R+.

**Y-axis**: Trade count.

**Bar Colors**: Red (`--loss` / `#EF4444`) for negative R buckets. Green (`--profit` / `#22C55E`) for positive R buckets. Gray (`--breakeven` / `#7B8BA5`) for the 0R bucket.

**Reference Lines**:
- Vertical dashed line at 0R (breakeven) in `--muted-foreground`.
- Vertical dashed line at the mean R value, labeled "Avg R: [value]" in `--primary`.

**Annotations**: Text in the chart margin: "Average R: 0.72" and "Median R: 0.45".

**Tooltip on Bar Hover**: R-range (e.g., "1.0R to 1.5R") and exact trade count (e.g., "8 trades").

---

### 2.6 Time-Based Analysis Charts

**Source**: FE-FR-037

**Description**: A section with multiple small charts analyzing performance across time dimensions. All rendered with D3.js.

| Chart | Type | X-axis | Bar Color | Insight Text Example |
|---|---|---|---|---|
| P&L by Day of Week | Horizontal bar | Mon-Fri | Green/red by P&L sign | "Tuesdays are your most profitable day (+$1,240 avg)" |
| P&L by Hour of Day | Vertical bar | 7am-4pm CT (RTH hours) | Green/red | "The 9:30-10:00 hour produces your highest average P&L" |
| P&L by Month | Vertical bar | Calendar months | Green/red | "January was your best month (+$3,200)" |
| Win Rate by Session | Donut chart | RTH vs Overnight segments | Green (RTH) / Blue (Overnight) | "Your RTH win rate (72%) exceeds overnight (54%)" |

Each chart includes a title, the chart visualization, and a one-line insight text auto-generated from the data.

---

### 2.7 MAE/MFE Scatter Plots

**Source**: FE-FR-038

**Description**: Two side-by-side scatter plot charts for analyzing execution quality. Rendered with D3.js.

#### MAE Scatter (Left Panel)
- X-axis: MAE (maximum adverse excursion, in ticks)
- Y-axis: Trade P&L ($)
- Each dot: Green for winners, red for losers
- Reference lines: Horizontal at $0 P&L, Vertical at average MAE
- Insight: Cluster of losing trades with high MAE suggests stops are too wide

#### MFE Scatter (Right Panel)
- X-axis: MFE (maximum favorable excursion, in ticks)
- Y-axis: Trade P&L ($)
- Each dot: Green for winners, red for losers
- Reference line: 45-degree diagonal representing "captured all favorable excursion"
- Insight: Winners with high MFE but low captured P&L suggests exiting too early

**Both Plots**:
- Tooltip on dot hover: Instrument, Date, P&L, R-Multiple
- Click a dot: Navigate to the trade detail view in the journal (`/journal/trade/[id]`)
- Dot size: 6px diameter. On hover: 10px with 150ms transition
- Minimum 5 trades required to render scatter plots

---

### 2.8 Drawdown Chart

**Source**: FE-FR-039

**Description**: A standalone area chart showing drawdown periods and depth. Rendered with D3.js.

- X-axis: Time
- Y-axis: Drawdown percentage (0% at top, negative percentages going down)
- Area fill: Red (`--loss` / `#EF4444`) with opacity gradient (deeper = more opaque, max 60% opacity)
- Max drawdown annotation: Label at the deepest point showing percentage and date (e.g., "Max DD: -4.5% on Jan 22")
- Recovery periods: Subtle vertical span markers between drawdown start and recovery (return to 0%)
- Tooltip on hover: Date, Drawdown %, Drawdown $ amount, Days in drawdown at that point

---

## 3. Functional Specifications -- Playbook Management

**Route**: `/playbooks`

### 3.1 Playbook List View

**Source**: FE-FR-028

**Description**: A card grid layout displaying all user playbooks with summary metrics.

**Layout**: 2 columns on desktop (>1280px), 1 column on mobile (<768px). Gap: 16px.

**Each Playbook Card**:

| Element | Format | Position |
|---|---|---|
| Header | Playbook name (`text-lg font-semibold`) + auto-classify badge (if rules configured) | Top |
| System badge | "System" badge (lock icon, muted color) for default playbooks | Top-right |
| Metrics row | Win Rate, Expectancy, Trade Count, Profit Factor | Below header, 4 columns |
| Mini equity curve | Sparkline of cumulative P&L, 64px height, `--primary` color | Below metrics |
| Last trade | "Last trade: Jan 15, 2026" in `text-xs text-muted-foreground` | Below sparkline |
| Actions | "View Details" link + three-dot menu (Edit, Delete) | Bottom-right |

**Metrics Row Format**:
- Win Rate: "68.2%"
- Expectancy: "$87/trade"
- Trade Count: "47"
- Profit Factor: "2.14"

Each metric has a label above (`text-xs text-muted-foreground`) and value below (`text-sm font-semibold font-mono`).

**Sort Dropdown**: Top-right of the page. Options: Name (alphabetical), Win Rate (descending), Expectancy (descending), Trade Count (descending), Last Trade Date (newest first). Default: Name.

**System Playbooks**: "A+ Trendline Break", "Standard Trendline Break", "Trendline Bounce" are marked with a "System" badge and a lock icon. They cannot be deleted. They can be edited (name and description only, not classification rules).

**"+ New Playbook" Button**: Prominent button at the top of the page. Opens the playbook create form (3.3).

**States**:

| State | Display |
|---|---|
| Loading | 3-card skeleton grid with shimmer |
| Success | Playbook cards with metrics |
| Empty | "No playbooks configured. Create your first playbook to start tracking strategy-specific performance." CTA: "Create Playbook" button |
| Error | "Unable to load playbooks. Retry." |

---

### 3.2 Playbook Detail View

**Source**: FE-FR-029, Route: `/playbooks/[id]`

**Description**: A dedicated page for analyzing a single playbook's performance.

**Header**: Playbook name (editable inline: click to edit, Enter to save, Escape to cancel). Description text below. Auto-classification rules summary (e.g., "Auto-classifies: Grade A+ AND Long AND Touch Count >= 3"). "Edit" button (opens form modal) and "Delete" button (with confirmation dialog).

**Metrics Section**: Full metric cards in a responsive grid (same layout as analytics metric cards, see section 2.2), but scoped to this playbook only. Minimum metrics displayed:

| Metric | Format |
|---|---|
| Win Rate, Loss Rate, Breakeven Rate | Percentages |
| Average Winner ($), Average Loser ($) | Dollar amounts |
| Largest Win, Largest Loss | Dollar amounts |
| Profit Factor, Expectancy, Avg R-Multiple | Ratios/dollars |
| Total Trades, Total P&L, Average Duration | Count/dollar/duration |

**Equity Curve**: Full-width line chart showing cumulative P&L over time for this playbook's trades only. Same rendering as the analytics equity curve (section 2.3).

**Trade List**: Embedded trade table (same component as FSD-011c trade table) pre-filtered to this playbook. All sorting and filtering available.

**Time Analysis**: Bar chart showing P&L by month for this playbook. Green bars for profitable months, red for losing months.

**States**:

| State | Display |
|---|---|
| Loading | Skeleton: header + 6 metric card skeletons + chart placeholder + table skeleton |
| Success | Full content |
| Playbook Not Found | "Playbook not found." with "Back to Playbooks" link |
| Error | "Unable to load playbook details. Retry." |

---

### 3.3 Playbook CRUD Forms

**Source**: FE-FR-030

**Description**: A modal/slide-over form for creating and editing playbooks.

**Fields**:

| Field | Type | Required | Validation |
|---|---|---|---|
| Name | Text input | Yes | 2-50 characters. Unique per user. |
| Description | Textarea | No | Max 500 characters. |
| Auto-Classify Rules | Rule builder | No | See below. |
| Target R:R | Number input | No | Range 1.0-10.0, step 0.1 |
| Max Risk Per Trade | Number input (% of equity) | No | Range 0.1-10.0, step 0.1 |

**Validation Error Messages**:

| Condition | Error Message |
|---|---|
| Name empty | "Playbook name is required." |
| Name < 2 chars | "Playbook name must be at least 2 characters." |
| Name > 50 chars | "Playbook name must be 50 characters or fewer." |
| Name not unique | "A playbook with this name already exists." |
| Target R:R out of range | "Target R:R must be between 1.0 and 10.0." |
| Max Risk out of range | "Max risk per trade must be between 0.1% and 10.0%." |

**Auto-Classification Rule Builder**:
- Condition fields presented as a row of dropdowns/inputs:
  - Trendline Grade: dropdown (A+, A, B, Any)
  - Direction: dropdown (Long, Short, Both)
  - Min Touch Count: number input (2-10)
  - Setup Type: dropdown (Break, Bounce, Any)
- Logic: All conditions use AND logic (all must match).
- Preview text renders dynamically below: "Trades will be auto-assigned to this playbook when: Grade is [grade] AND Direction is [direction] AND Touch Count >= [count] AND Setup Type is [type]."

**Create Flow**:
1. User fills form and clicks "Create Playbook".
2. Client-side validation runs (Zod schema).
3. `POST /api/playbooks` with form data.
4. On success: toast "Playbook '[name]' created." Modal closes. Playbook list refetches via TanStack Query cache invalidation.
5. On error: toast (error) with API error message. Modal remains open.

**Edit Flow**:
1. User modifies fields and clicks "Save".
2. `PUT /api/playbooks/{id}` with updated data.
3. On success: toast "Playbook updated." Modal closes.
4. On error: toast (error) with API error message.

**Delete Flow**:
1. User clicks "Delete" button.
2. Confirmation dialog: "Delete playbook '[name]'? This will not delete the trades, but they will be unassigned from this playbook."
3. Confirm button: "Delete" (destructive red styling). Cancel button: "Cancel".
4. On confirm: `DELETE /api/playbooks/{id}`. Trades' `playbook_id` is set to null on the backend.
5. On success: toast "Playbook '[name]' deleted." Navigate back to `/playbooks`.
6. On error: toast (error) with API error message.

**System Playbook Restrictions**: The three system playbooks show the Edit button (for name/description only) but the Delete button is hidden. If a user attempts to delete via API manipulation, the backend returns 403 and the frontend shows: "System playbooks cannot be deleted."

---

### 3.4 Playbook Comparison View

**Source**: FE-FR-031, Route: `/playbooks/compare?ids=[id1],[id2]`

**Feature Flag**: Gated behind `NEXT_PUBLIC_ENABLE_PLAYBOOK_COMPARISON` (default `false`, Phase 2).

**Description**: A side-by-side comparison of exactly 2 playbooks.

**Selection**: From the playbook list view, each card has a comparison checkbox. When exactly 2 are checked, a "Compare" button appears in a floating action bar. Selecting more than 2 shows: "Select exactly 2 playbooks to compare."

**Layout**: Two equal-width columns. Playbook A on the left, Playbook B on the right.

**Sections Compared**:

1. **Key Metrics Table**: Rows for each metric (Win Rate, Expectancy, Profit Factor, Avg R, Total P&L, Total Trades, Avg Duration, Max Drawdown). Three columns: Metric Name, Playbook A Value, Playbook B Value. The "better" value in each row has a subtle green background highlight. "Better" logic: higher win rate = better, higher expectancy = better, lower max drawdown = better, etc.

2. **Equity Curves**: Both playbooks' equity curves overlaid on the same chart. Playbook A: `--primary` blue line (`#3B82F6`). Playbook B: purple line (`#8B5CF6`). Legend at top.

3. **Win Rate Over Time**: Rolling 10-trade window win rate, overlaid line charts, same color coding.

4. **R-Multiple Distributions**: Overlapping histograms (Playbook A bars with 70% opacity, Playbook B bars with 70% opacity, different colors).

**Summary Text**: Auto-generated summary at the top of the page. Example: "Playbook A has a higher win rate (72% vs 58%) but Playbook B has a better expectancy ($145 vs $98 per trade)."

**States**:

| State | Display |
|---|---|
| Loading | Side-by-side skeleton columns |
| Success | Full comparison layout |
| One playbook not found | "One of the selected playbooks was not found." with "Back to Playbooks" link |
| Insufficient data | "Not enough trades to compare. Each playbook needs at least 5 closed trades." |

---

## 4. Data Specifications

### 4.1 Playbook

```typescript
interface Playbook {
  id: string;                    // UUID
  user_id: string;               // UUID
  name: string;                  // 2-50 chars
  description: string | null;    // Max 500 chars
  is_system: boolean;            // True for default playbooks
  auto_classify_rules: ClassifyRules | null;
  target_rr: number | null;      // 1.0-10.0
  max_risk_percent: number | null; // 0.1-10.0
  metrics: PlaybookMetrics;
  created_at: string;            // ISO 8601
  updated_at: string;            // ISO 8601
}

interface ClassifyRules {
  trendline_grade: "A+" | "A" | "B" | "any";
  direction: "long" | "short" | "both";
  min_touch_count: number;       // 2-10
  setup_type: "break" | "bounce" | "any";
}

interface PlaybookMetrics {
  win_rate: number;
  loss_rate: number;
  expectancy: number;
  profit_factor: number;
  trade_count: number;
  total_pnl: number;
  avg_r_multiple: number;
}
```

### 4.2 Analytics Response Types

```typescript
interface AnalyticsResponse {
  metrics: MetricCard[];
  equity_curve: EquityCurvePoint[];
  calendar: CalendarDay[];
  r_distribution: RBucket[];
  time_analysis: TimeAnalysis;
  mae_mfe: MaeMfePoint[];
  drawdown: DrawdownPoint[];
}

interface MetricCard {
  id: string;                    // M01-M27
  label: string;
  value: number | null;
  formatted_value: string;       // Pre-formatted for display
  trend_percent: number | null;  // Percentage change vs prior period
  trend_direction: "up" | "down" | "neutral" | null;
  improvement: "higher" | "lower" | "neutral";
  sparkline_data: number[] | null;
}

interface EquityCurvePoint {
  date: string;                  // ISO 8601
  cumulative_pnl: number;
  trade_count: number;
  drawdown_percent: number;
  trade_id: string;              // For click navigation
}

interface CalendarDay {
  date: string;                  // ISO 8601 date
  pnl: number;
  trade_count: number;
  wins: number;
  losses: number;
}

interface RBucket {
  range_start: number;           // e.g., -1.0
  range_end: number;             // e.g., -0.5
  label: string;                 // e.g., "-1.0R to -0.5R"
  count: number;
}

interface TimeAnalysis {
  by_day_of_week: TimeSlice[];   // 5 items (Mon-Fri)
  by_hour: TimeSlice[];          // RTH hours
  by_month: TimeSlice[];         // Calendar months in range
  by_session: SessionSlice[];    // RTH vs Overnight
}

interface TimeSlice {
  label: string;                 // e.g., "Monday", "9:30 AM", "January"
  pnl: number;
  trade_count: number;
  win_rate: number;
}

interface SessionSlice {
  session: "rth" | "overnight";
  pnl: number;
  trade_count: number;
  win_rate: number;
}

interface MaeMfePoint {
  trade_id: string;              // For click navigation
  instrument: string;
  date: string;
  pnl: number;
  r_multiple: number;
  mae_ticks: number;
  mfe_ticks: number;
  is_winner: boolean;
}

interface DrawdownPoint {
  date: string;                  // ISO 8601
  drawdown_percent: number;
  drawdown_dollars: number;
  days_in_drawdown: number;
}
```

### 4.3 Trade (Analytics-Relevant Fields)

```typescript
// Subset of the full Trade interface relevant to analytics and playbook views
interface Trade {
  id: string;
  instrument: string;
  direction: "long" | "short";
  entry_time: string;
  exit_time: string | null;
  pnl_dollars: number | null;
  r_multiple: number | null;
  mae_ticks: number | null;
  mfe_ticks: number | null;
  slippage_entry: number | null;
  slippage_exit: number | null;
  playbook_id: string | null;
  session: "rth" | "overnight";
  status: "open" | "closed" | "cancelled";
  mode: "paper" | "live";
  conviction: number | null;
  mistakes: string[];
  rule_compliance: Record<string, boolean>;
}
```

### 4.4 Data Validation Rules

| Entity | Field | Rule |
|---|---|---|
| Playbook | name | Required, 2-50 chars, unique per user |
| Playbook | description | Optional, max 500 chars |
| Playbook | target_rr | Optional, 1.0-10.0 |
| Playbook | max_risk_percent | Optional, 0.1-10.0 |
| Analytics filters | date_from | Required, ISO date, <= date_to |
| Analytics filters | date_to | Required, ISO date, >= date_from |
| Analytics filters | instruments | Optional, array of valid instrument symbols |
| Analytics filters | playbooks | Optional, array of valid playbook UUIDs |
| Analytics filters | mode | Optional, "paper" | "live" | "both" |

---

## 5. API Specifications

### 5.1 Playbook Endpoints

| Method | BFF Route | Backend Route | Description |
|---|---|---|---|
| GET | `/api/playbooks` | `/v1/playbooks` | List all playbooks with metrics |
| GET | `/api/playbooks/{id}` | `/v1/playbooks/{id}` | Playbook detail with full metrics |
| POST | `/api/playbooks` | `/v1/playbooks` | Create playbook |
| PUT | `/api/playbooks/{id}` | `/v1/playbooks/{id}` | Update playbook |
| DELETE | `/api/playbooks/{id}` | `/v1/playbooks/{id}` | Delete playbook |

#### GET /api/playbooks

**Response**: `ApiResponse<Playbook[]>`

```json
{
  "data": [
    {
      "id": "uuid",
      "name": "A+ Trendline Break",
      "description": "High-quality trendline breakout trades",
      "is_system": true,
      "auto_classify_rules": {
        "trendline_grade": "A+",
        "direction": "both",
        "min_touch_count": 3,
        "setup_type": "break"
      },
      "target_rr": 2.0,
      "max_risk_percent": 2.0,
      "metrics": {
        "win_rate": 0.682,
        "loss_rate": 0.318,
        "expectancy": 87.0,
        "profit_factor": 2.14,
        "trade_count": 47,
        "total_pnl": 4230.0,
        "avg_r_multiple": 0.72
      },
      "created_at": "2026-01-01T00:00:00Z",
      "updated_at": "2026-02-10T12:00:00Z"
    }
  ]
}
```

#### POST /api/playbooks

**Request Body**:
```json
{
  "name": "Trendline Bounce Long",
  "description": "Bounce trades from support trendlines",
  "auto_classify_rules": {
    "trendline_grade": "A",
    "direction": "long",
    "min_touch_count": 3,
    "setup_type": "bounce"
  },
  "target_rr": 2.5,
  "max_risk_percent": 1.5
}
```

**Success Response** (201): `ApiResponse<Playbook>`

**Error Responses**:
- 400: Validation errors (name too short, etc.)
- 409: "A playbook with this name already exists."

#### PUT /api/playbooks/{id}

**Request Body**: Same as POST (all fields optional for partial update).

**Success Response** (200): `ApiResponse<Playbook>`

**Error Responses**:
- 400: Validation errors
- 403: Attempted to modify classification rules on system playbook
- 404: Playbook not found
- 409: Name conflict

#### DELETE /api/playbooks/{id}

**Success Response** (200): `{ "data": { "deleted": true } }`

**Error Responses**:
- 403: "System playbooks cannot be deleted."
- 404: Playbook not found

### 5.2 Analytics Endpoints

| Method | BFF Route | Backend Route | Description |
|---|---|---|---|
| GET | `/api/analytics` | `/v1/analytics?...` | Full analytics data with filter params |
| GET | `/api/analytics/equity-curve` | `/v1/analytics/equity-curve?...` | Equity curve data points |
| GET | `/api/analytics/calendar` | `/v1/analytics/calendar?...` | P&L calendar heatmap data |
| GET | `/api/analytics/r-distribution` | `/v1/analytics/r-distribution?...` | R-multiple histogram data |
| GET | `/api/analytics/time-analysis` | `/v1/analytics/time-analysis?...` | Time-based analysis data |
| GET | `/api/analytics/mae-mfe` | `/v1/analytics/mae-mfe?...` | MAE/MFE scatter plot data |
| GET | `/api/analytics/drawdown` | `/v1/analytics/drawdown?...` | Drawdown chart data |

All analytics endpoints accept the same query parameters:

| Parameter | Type | Required | Description |
|---|---|---|---|
| `date_from` | ISO date | Yes | Start of date range |
| `date_to` | ISO date | Yes | End of date range |
| `instruments` | comma-separated strings | No | Filter by instruments |
| `playbooks` | comma-separated UUIDs | No | Filter by playbooks |
| `mode` | "paper" / "live" / "both" | No | Filter by trading mode (default: "both") |

#### GET /api/analytics

**Response**: `ApiResponse<AnalyticsResponse>` (full analytics payload including all metrics, chart data).

This is the primary endpoint. The individual chart endpoints (`/equity-curve`, `/calendar`, etc.) exist for lazy-loading or refreshing individual charts without re-fetching everything.

**Error Responses**:
- 400: Invalid filter parameters
- 422: Date range exceeds maximum (365 days)

### 5.3 Error Response Format

All API errors follow the standard envelope:

```json
{
  "error": {
    "code": "validation_error",
    "message": "Invalid filter parameters.",
    "details": {
      "date_from": ["date_from must be before date_to."]
    }
  }
}
```

| HTTP Status | Error Code | User-Facing Message |
|---|---|---|
| 400 | `validation_error` | Field-specific messages from `details` object |
| 401 | `unauthorized` | "Session expired. Please log in again." |
| 403 | `forbidden` | "You do not have permission to perform this action." |
| 404 | `not_found` | "The requested resource was not found." |
| 409 | `conflict` | Context-specific (e.g., "A playbook with this name already exists.") |
| 422 | `unprocessable_entity` | Context-specific |
| 429 | `rate_limited` | "Too many requests. Please wait a moment and try again." |
| 500 | `internal_error` | "Something went wrong. Please try again." |

### 5.4 Authentication and Authorization

- All BFF API routes require a valid JWT auth token stored in an `httpOnly`, `Secure`, `SameSite=Strict` cookie.
- The BFF reads the cookie server-side and injects `Authorization: Bearer [token]` into backend requests.
- All API responses only return data belonging to the authenticated user. There is no cross-user data access.
- Analytics endpoints compute metrics only from the authenticated user's trades.
- Playbook CRUD operations are scoped to the authenticated user only.

### 5.5 Caching Strategy (TanStack Query)

| Data Type | Stale Time | Cache Time | Refetch On |
|---|---|---|---|
| Analytics data | 5 minutes | 30 minutes | Filter change, window focus |
| Playbook data | 5 minutes | 30 minutes | Mutation, window focus |
| Playbook list | 5 minutes | 30 minutes | Mutation (create/update/delete), window focus |

**Cache Invalidation**:
- Creating, updating, or deleting a playbook invalidates the playbook list cache.
- Changing analytics filters invalidates and re-fetches analytics data.
- Window focus triggers refetch for stale data.
- Manual "Retry" button invalidates and refetches the specific query.

---

## 6. UI/UX Specifications

### 6.1 Screen/Component Inventory

| Page | Route | Primary Components |
|---|---|---|
| Analytics | `/analytics` | Filter Bar, Metric Cards Grid (27 cards, 5 groups), Equity Curve, Calendar Heatmap, R-Distribution Histogram, Time Charts (4), MAE/MFE Scatter (2), Drawdown Chart |
| Playbooks | `/playbooks` | Playbook Card Grid, Sort Dropdown, Create Form Modal, Compare Checkbox + Floating Bar |
| Playbook Detail | `/playbooks/[id]` | Header (inline edit), Metrics Cards, Equity Curve, Trade Table, Time Analysis Bar Chart |
| Playbook Compare | `/playbooks/compare` | Side-by-side Metrics Table, Overlaid Equity Curves, Win Rate Line Charts, R-Distribution Histograms, Summary Text |

### 6.2 Chart Rendering (D3.js)

All analytics charts are rendered using D3.js (tree-shaken, target < 30KB gzipped). Charts are dynamically imported and only loaded on the analytics page.

**Common Chart Behaviors**:
- Responsive: Charts resize on window resize using ResizeObserver.
- Loading: Each chart shows its own skeleton placeholder while data loads.
- Empty: Charts display a centered message when no data is available.
- Error: Each chart handles its own error state with a "Retry" button.
- Animation: Initial render uses a 500ms ease-out draw animation. Respects `prefers-reduced-motion`.
- Tooltip: All tooltips use a shared tooltip component with consistent styling.

**Chart Color Conventions** (from design system):

| Data Type | Color | Hex |
|---|---|---|
| Profit / Positive | Green | `#22C55E` |
| Loss / Negative | Red | `#EF4444` |
| Breakeven / Neutral | Gray | `#7B8BA5` |
| Equity Curve (primary) | Blue | `#3B82F6` |
| Equity Curve (comparison) | Purple | `#8B5CF6` |
| Drawdown Area | Red at 30% opacity | `#EF4444` at 0.3 alpha |

### 6.3 Responsive Layout

| Breakpoint | Analytics Layout | Playbook List Layout |
|---|---|---|
| Desktop (>1280px) | 4-column metric grid, full-width charts, 2-column scatter plots | 2-column card grid |
| Tablet (768-1280px) | 3-column metric grid, stacked charts, stacked scatter plots | 2-column card grid |
| Mobile (<768px) | 2-column metric grid, stacked charts, stacked scatter plots | 1-column card grid |

### 6.4 Accessibility

- All charts provide an `aria-label` summarizing the data (e.g., "Equity curve showing cumulative P&L of $4,230 over 47 trades").
- Metric cards use semantic `<dl>` / `<dt>` / `<dd>` markup.
- Color-coded values also use text labels (e.g., profit values show "+" prefix, loss values show "-" prefix) for color-blind users.
- All interactive chart elements (clickable dots, bars) are keyboard-focusable with Enter/Space activation.
- Filter bar controls are fully keyboard-navigable.
- Screen reader announces filter changes and data refresh status.

---

## 7. Performance Specifications

### 7.1 Response Time Targets

| Operation | Target | Notes |
|---|---|---|
| Analytics dashboard render (1000 trades) | < 3 seconds | All charts and metrics combined |
| Individual chart render | < 500ms | After data is available |
| Filter change to data refresh | < 2 seconds | Debounce (100ms) + API call + render |
| Playbook list load | < 1 second | Card grid with sparklines |
| Playbook detail load | < 2 seconds | Metrics + chart + trade table |
| Playbook comparison load | < 2 seconds | Dual-column layout with overlaid charts |

### 7.2 Bundle Size

| Bundle | Target (gzipped) | Strategy |
|---|---|---|
| D3.js (tree-shaken) | < 30 KB | Dynamic import, analytics page only |
| Analytics page chunk | < 50 KB | Dynamic import per route |
| Playbook page chunk | < 50 KB | Dynamic import per route |

### 7.3 Data Volume Handling

| Data | Volume Limit | Strategy |
|---|---|---|
| Analytics computation | Up to 5,000 trades | Server-side computation, client renders results |
| Equity curve data points | Up to 5,000 | D3.js line chart with path optimization |
| Calendar heatmap cells | Up to 365 | Direct DOM rendering |
| R-distribution buckets | Up to 20 | Direct bar rendering |
| MAE/MFE scatter dots | Up to 5,000 | SVG with viewport culling for large datasets |
| Trade table (playbook detail) | Up to 10,000 | Virtualized rendering (`@tanstack/react-virtual`) |

---

## 8. Testing Specifications

### 8.1 Unit Tests (Jest + React Testing Library)

| Component / Feature | Test Cases |
|---|---|
| Metric Card | Renders value in correct format. Shows green arrow for improvement. Shows red arrow for deterioration. Shows "--" for null values. Sparkline renders when data provided. |
| Metric Cards Grid | Renders all 27 cards. Groups are labeled. Responsive column count at each breakpoint (mock ResizeObserver). |
| Filter Bar | Date range picker opens and selects dates. Instrument multi-select filters correctly. Mode toggle switches between Paper/Live/Both. Filter chips render and remove on X click. "Clear all" resets to defaults. |
| Equity Curve | Renders SVG with correct number of data points. Green area above $0, red area below. Tooltip shows on hover. "Show Drawdown" toggle works. Paper/Live dual lines render when mode is "Both". |
| Calendar Heatmap | Renders correct number of cells per month. Cell color intensity scales with P&L magnitude. Tooltip shows date, P&L, trade count. Navigation arrows change month. |
| R-Distribution | Correct number of bars. Red for negative, green for positive, gray for zero. Mean R reference line positioned correctly. Tooltip shows range and count. |
| Time Analysis | All 4 sub-charts render. Insight text generated from data. Bar colors match P&L sign. |
| MAE/MFE Scatter | Dots colored by winner/loser. Reference lines positioned correctly. Tooltip shows trade details. Click navigates to trade detail. |
| Drawdown Chart | Area fill opacity scales with drawdown depth. Max DD annotation renders at correct position. Recovery spans marked. |
| Playbook Card | Renders name, metrics row, sparkline. System badge shown for is_system=true. Actions menu opens. Delete hidden for system playbooks. |
| Playbook CRUD Form | Name validation (2-50 chars, uniqueness). Description max 500 chars. Rule builder dropdowns work. Target R:R and Max Risk validation. Create/Edit/Delete flows execute correctly. |
| Playbook Detail | Metrics scoped to playbook. Equity curve renders playbook trades only. Trade table pre-filtered. Inline name editing works. |
| Playbook Comparison | Exactly 2 playbooks required. Side-by-side metrics with "better" highlighting. Overlaid equity curves. Minimum 5 trades per playbook enforced. |

### 8.2 End-to-End Tests (Playwright)

| # | Journey | Key Assertions |
|---|---|---|
| 1 | Analytics Filtering | Navigate to `/analytics` > change date range > change instrument filter > verify all charts update with filtered data > URL params reflect filters |
| 2 | Playbook CRUD | Create playbook > verify in list > edit name > view detail page with metrics > delete > confirm removal from list |
| 3 | Playbook Comparison | Select 2 playbooks > Compare button appears > click > comparison page renders with both playbook data > metrics highlight "better" values |
| 4 | Analytics Deep Interaction | Hover equity curve > tooltip shows > click data point > navigates to trade detail > back to analytics > click calendar cell > navigates to journal filtered by date |
| 5 | Empty States | New user with 0 trades > analytics shows empty state message > playbooks shows empty state > "Go to Execution" CTA works |

### 8.3 Visual Regression Screenshots

- Analytics metrics grid (populated, dark and light themes)
- P&L calendar heatmap (with data)
- Equity curve chart (with drawdown toggle on/off)
- R-multiple distribution histogram
- MAE/MFE scatter plots
- Playbook list (with cards and sparklines)
- Playbook detail page
- Playbook comparison view

### 8.4 Performance Tests

- Analytics dashboard renders within 3 seconds with 1,000 trades of data.
- D3.js bundle remains under 30KB gzipped (checked in CI).
- No frame drops during chart animations with `prefers-reduced-motion: no-preference`.

---

## 9. Cross-References

| FSD | What This Sub-FSD Uses From It |
|---|---|
| FSD-011a | App shell layout, sidebar navigation, design system tokens (colors, typography, spacing, animations), theme system |
| FSD-011b | Shared charting patterns (tooltip component, loading skeletons) |
| FSD-011c | Trade table component (reused in playbook detail view), trade detail page (click navigation from charts) |
| FSD-011e | Settings page (appearance/theme affects chart rendering) |
| FSD-005 | Playbook system backend: auto-classification engine, playbook API contracts |
| FSD-006 | Analytics backend: metric computation formulas, aggregation logic, data pipeline |
| FSD-003 | Trade execution: trade data model, position data |

---

## Changelog

- 2026-02-12: Initial sub-FSD extracted from FSD-011 -- Generated by Claude

---

*End of FSD-011d: Analytics & Playbook Views*
