# FSD-005: Playbook System

**TrendEdge — AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-005 |
| Source PRD | PRD-005 |
| Title | Playbook System |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-11 |

---

## 1. Introduction

### 1.1 Purpose

This Functional Specification Document translates the requirements defined in PRD-005 (Playbook System) into precise, implementable specifications. It documents every user-facing behavior, state transition, error message, edge case, and processing rule so that a developer can implement the complete Playbook System without referencing the PRD.

### 1.2 Scope

**This document covers:**

- Default playbook seeding on user registration
- Custom playbook CRUD lifecycle (create, read, update, delete, archive, unarchive)
- Auto-classification rules engine: schema, evaluation, priority ordering, fallback behavior
- Manual trade-to-playbook assignment and re-classification (single and bulk)
- Per-playbook metrics calculation, caching, and recalculation triggers
- Playbook comparison views with statistical analysis
- Playbook-specific risk parameter overrides
- Rule compliance tracking and compliance-vs-outcome correlation
- Playbook templates (Pro/Team tiers)
- Playbook sharing within teams (Team tier)
- Tier-based feature gating and enforcement
- All API endpoints, data models, security policies, and performance targets

**This document does NOT cover:**

- Trendline detection logic (see PRD-002 / FSD-002)
- Trade execution mechanics (see PRD-003 / FSD-003)
- Journal entry creation and enrichment UI (see PRD-004 / FSD-004)
- Aggregate cross-playbook analytics dashboards (see PRD-006 / FSD-006)
- Public playbook marketplace (Phase 4, not yet specified)

### 1.3 Relationship to Source PRD

This FSD implements all functional requirements PB-FR-001 through PB-FR-049, all non-functional requirements PB-NFR-001 through PB-NFR-015, and all security requirements PB-SEC-001 through PB-SEC-011 from PRD-005.

### 1.4 Cross-References

| FSD | Dependency | Nature |
|---|---|---|
| FSD-002 | Trendline Detection Engine | Upstream: provides trendline metadata fields consumed by auto-classification |
| FSD-003 | Trade Execution Pipeline | Upstream: emits `trade.created` event; Downstream: consumes `risk_overrides` |
| FSD-004 | Trade Journaling | Upstream: provides journal UI for manual assignment and compliance checklists |
| FSD-006 | Performance Analytics | Downstream: consumes per-playbook metrics and equity curves |
| FSD-010 | Billing and Subscription Management | Upstream: provides tier information for feature gating |

---

## 2. System Context

### 2.1 Position in TrendEdge Architecture

The Playbook System is a mid-tier module that sits between the trade creation pipeline (upstream) and the analytics/reporting layer (downstream). It does not create or modify trades; it classifies them, tracks per-strategy performance, and feeds risk parameters back to execution.

### 2.2 External Systems and Integrations

| System | Direction | Integration Point |
|---|---|---|
| Trendline Detection Engine (PRD-002) | Inbound data | Reads trendline metadata (`touch_count`, `slope_angle`, etc.) from trade signals |
| Trade Execution Pipeline (PRD-003) | Inbound event / Outbound data | Receives `trade.created` event; provides `risk_overrides` for position sizing |
| Trade Journaling (PRD-004) | UI integration | Playbook selection dropdown in journal entry form; compliance checklist rendering |
| Performance Analytics (PRD-006) | Outbound data | Exposes `playbook_metrics` and `playbook_equity_curve` tables for aggregation |
| User/Auth/Billing (Core) | Infrastructure | Tier enforcement, user isolation, organization membership |
| PostgreSQL / Supabase | Database | All persistent storage with Row-Level Security |

### 2.3 Context Diagram Description

```
[Trendline Engine] --metadata--> [Trade Execution Pipeline] --trade.created-->
  [PLAYBOOK SYSTEM] --risk_overrides--> [Trade Execution Pipeline]
  [PLAYBOOK SYSTEM] --metrics/curves--> [Performance Analytics]
  [PLAYBOOK SYSTEM] <--manual assignment-- [Trade Journaling UI]
  [PLAYBOOK SYSTEM] <--tier info-- [Billing System]
  [PLAYBOOK SYSTEM] <--auth/RLS-- [Supabase Auth]
```

---

## 3. Functional Specifications

### 3.1 Default Playbook Seeding

**Source:** PB-FR-001, PB-FR-002, PB-FR-003, PB-FR-004

#### 3.1.1 Description

When a new user account is created (registration completes successfully), the system seeds four playbooks into the user's account before they see any UI. These playbooks provide immediate auto-classification capability.

#### 3.1.2 Inputs

- `user.created` event containing `user_id` and `tier` (subscription tier at registration time).

#### 3.1.3 Processing Logic

**Step 1:** On receipt of `user.created` event, create four playbook records in a single database transaction:

| Playbook | Slug | `is_default` | `priority` | `status` | Deletable | Archivable |
|---|---|---|---|---|---|---|
| A+ Trendline Break | `aplus-trendline-break` | true | 200 | `active` | No | Yes |
| Standard Trendline Break | `standard-trendline-break` | true | 300 | `active` | No | Yes |
| Trendline Bounce | `trendline-bounce` | true | 400 | `active` | No | Yes |
| Custom / Manual | `custom-manual` | true | 9999 | `active` | No | No |

**Step 2:** Attach immutable auto-classification rules to the first three playbooks (see section 3.4.2 for exact rule definitions).

**Step 3:** Set the `criteria_description` for each default playbook:

- **A+ Trendline Break:** "3+ touches, slope under 45 degrees, minimum 6 candles between touches, trendline duration at least 3 weeks, break setup."
- **Standard Trendline Break:** "Exactly 2 touches, break setup."
- **Trendline Bounce:** "2+ touches, bounce setup."
- **Custom / Manual:** "Catch-all for trades that do not match any auto-classification rule, or trades manually entered without trendline metadata."

**Step 4 (Free tier only):** If the user's tier is `free`, set the `status` of "Standard Trendline Break" and "Trendline Bounce" to `active` but mark them as `tier_locked: true` in the response. These playbooks exist in the database but their metrics, detail views, and auto-classification are gated behind an upgrade prompt in the UI.

#### 3.1.4 Outputs

- Four playbook records created in the `playbooks` table.
- No user-facing output (background operation during registration).

#### 3.1.5 Business Rules

- Default playbooks do NOT count toward the user's custom playbook limit.
- Default playbook classification criteria (the `auto_classify_rules` JSON) are immutable. Users cannot modify them via any API endpoint.
- Default playbook names and slugs are immutable.
- Users MAY modify `risk_overrides` on default playbooks.
- The "Custom / Manual" playbook cannot be archived or deleted under any circumstance.

#### 3.1.6 Error Handling

| Error Condition | Behavior | Error Message |
|---|---|---|
| Database transaction fails during seeding | Retry up to 3 times with 1-second backoff. If all retries fail, log critical error and mark user account for manual remediation. User sees their dashboard but with a banner. | Banner: "Your playbooks are being set up. Please refresh in a moment. If this persists, contact support." |
| Duplicate key violation (re-seeding attempt) | Skip creation for existing playbooks. This handles idempotent retries. | None (silent success) |
| User ID does not exist in users table | Abort seeding, log error with correlation ID. | Internal log only: "Playbook seeding failed: user_id {id} not found." |

#### 3.1.7 Edge Cases

- **User created via team invitation:** Same seeding occurs. Team shared playbooks are added separately via sharing mechanism.
- **User upgrades from Free to Trader:** The previously tier-locked default playbooks ("Standard Trendline Break", "Trendline Bounce") become unlocked. No new records are created; the UI simply removes the lock overlay. Auto-classification begins including these playbooks for new trades.
- **Re-registration after account deletion:** Fresh seeding occurs. Historical data from the deleted account is not restored.

---

### 3.2 Custom Playbook Creation

**Source:** PB-FR-005, PB-FR-009, PB-FR-010

#### 3.2.1 Description

Users on Trader tier and above can create custom playbooks to track non-default strategies. Each custom playbook can optionally include auto-classification rules, risk overrides, and compliance checklists.

#### 3.2.2 Inputs

| Field | Type | Required | Constraints | Default |
|---|---|---|---|---|
| `name` | string | Yes | 1-100 characters. Unique per user (case-insensitive: "My Setup" and "my setup" are duplicates). No leading/trailing whitespace (trimmed on save). Must not be empty after trimming. | — |
| `description` | text | No | Max 2,000 characters. HTML tags stripped on save. | `null` |
| `criteria_description` | text | Yes | 1-5,000 characters. Plain text description of setup rules. HTML tags stripped on save. | — |
| `auto_classify_rules` | JSON | No | Must conform to rule schema v1.0 (see section 3.4). `null` means manual-only playbook. | `null` |
| `color` | hex string | No | 7-character hex string matching pattern `^#[0-9A-Fa-f]{6}$`. | Auto-assigned from palette: `#6366F1`, `#10B981`, `#F59E0B`, `#EF4444`, `#8B5CF6`, `#EC4899`, `#14B8A6`, `#F97316` (cycles based on existing playbook count) |
| `icon` | string | No | Must be one of 20 predefined values: `chart-line`, `chart-bar`, `trending-up`, `trending-down`, `target`, `zap`, `shield`, `star`, `flame`, `rocket`, `diamond`, `crown`, `bolt`, `wave`, `crosshair`, `compass`, `anchor`, `flag`, `trophy`, `skull`. | `chart-line` |
| `risk_overrides` | JSON | No | Must conform to risk override schema (see section 3.9). | `null` |
| `tags` | string[] | No | Max 10 tags. Each tag: 1-30 characters, trimmed, lowercased. Duplicate tags within the array are removed. | `[]` |
| `priority` | integer | No | 1-100 inclusive. Lower numbers evaluated first in auto-classification. | `50` |
| `compliance_checklist` | JSON | No | Must conform to compliance checklist schema (see section 3.10). | `null` |

#### 3.2.3 Processing Logic

**Step 1: Authorization check.**
- Verify user's tier is Trader or above. If Free tier, reject.
- Count user's current active custom playbooks (where `is_default = false` AND `status = 'active'`).
- Compare against tier limit: Trader = 5, Pro = unlimited (cap 50), Team = unlimited (cap 50).
- If at or above limit, reject with upgrade prompt.

**Step 2: Validation.**
- Trim `name`. Check uniqueness against all user's playbooks (active + archived, case-insensitive).
- Validate `criteria_description` is non-empty after trimming.
- If `auto_classify_rules` is provided, validate against rule schema (section 3.4.5).
- If `risk_overrides` is provided, validate against risk schema (section 3.9.3).
- If `compliance_checklist` is provided, validate against compliance schema (section 3.10.3).
- Strip HTML tags from `name`, `description`, `criteria_description`.

**Step 3: Slug generation.**
- Generate slug from `name`: lowercase, replace spaces and special characters with hyphens, remove consecutive hyphens, trim hyphens from ends.
- If slug collides with existing slug for user, append `-2`, `-3`, etc.

**Step 4: Insert record.**
- Insert into `playbooks` table with `is_default = false`, `status = 'active'`, `is_shared = false`.
- Set `created_at` and `updated_at` to current timestamp.

**Step 5: Initialize metrics.**
- Create a `playbook_metrics` record with `period_type = 'all_time'`, all metric values at 0 or null.

#### 3.2.4 Outputs

**Success (201 Created):**
```json
{
  "id": "b7a3f1e2-4d5c-6e7f-8a9b-0c1d2e3f4a5b",
  "user_id": "u1234-...",
  "name": "High-Volume Breakouts",
  "slug": "high-volume-breakouts",
  "description": "Trendline breaks with above-average volume",
  "criteria_description": "A+ criteria met plus volume > 1.5x average...",
  "auto_classify_rules": { "version": "1.0", "match_mode": "all", "conditions": [...] },
  "risk_overrides": { "max_risk_per_trade_pct": 1.5 },
  "compliance_checklist": null,
  "color": "#10B981",
  "icon": "chart-line",
  "tags": ["volume", "breakout"],
  "priority": 10,
  "is_default": false,
  "is_shared": false,
  "status": "active",
  "trade_count": 0,
  "created_at": "2026-02-11T14:30:00Z",
  "updated_at": "2026-02-11T14:30:00Z"
}
```

#### 3.2.5 Error Handling

| HTTP Status | Condition | Response Body |
|---|---|---|
| 400 | `name` is empty or only whitespace after trimming | `{ "error": "validation_error", "field": "name", "message": "Playbook name is required." }` |
| 400 | `name` exceeds 100 characters | `{ "error": "validation_error", "field": "name", "message": "Playbook name must be 100 characters or fewer." }` |
| 400 | `criteria_description` is empty after trimming | `{ "error": "validation_error", "field": "criteria_description", "message": "Criteria description is required." }` |
| 400 | `criteria_description` exceeds 5,000 characters | `{ "error": "validation_error", "field": "criteria_description", "message": "Criteria description must be 5,000 characters or fewer." }` |
| 400 | `priority` outside 1-100 range | `{ "error": "validation_error", "field": "priority", "message": "Priority must be between 1 and 100." }` |
| 400 | `tags` array exceeds 10 items | `{ "error": "validation_error", "field": "tags", "message": "Maximum 10 tags allowed." }` |
| 400 | Individual tag exceeds 30 characters | `{ "error": "validation_error", "field": "tags", "message": "Each tag must be 30 characters or fewer." }` |
| 400 | `color` does not match hex pattern | `{ "error": "validation_error", "field": "color", "message": "Color must be a valid hex color code (e.g., #10B981)." }` |
| 400 | `icon` not in predefined set | `{ "error": "validation_error", "field": "icon", "message": "Icon must be one of the predefined icons." }` |
| 403 | User is on Free tier | `{ "error": "tier_restricted", "message": "Custom playbooks require the Trader plan or above.", "upgrade_url": "/settings/billing" }` |
| 403 | User has reached custom playbook limit | `{ "error": "limit_reached", "message": "You have reached your plan's limit of {limit} custom playbooks. Upgrade to create more.", "current_count": 5, "limit": 5, "upgrade_url": "/settings/billing" }` |
| 409 | Duplicate playbook name (case-insensitive) | `{ "error": "duplicate_name", "field": "name", "message": "A playbook named \"{name}\" already exists. Please choose a different name." }` |
| 422 | Invalid `auto_classify_rules` JSON | `{ "error": "validation_error", "field": "auto_classify_rules", "message": "Invalid classification rules: {specific_reason}", "details": [...] }` |
| 422 | Invalid `risk_overrides` JSON | `{ "error": "validation_error", "field": "risk_overrides", "message": "Invalid risk overrides: {specific_reason}", "details": [...] }` |

#### 3.2.6 Edge Cases

- **User creates playbook, then downgrades tier:** Existing playbooks become read-only. The user cannot create new playbooks or modify existing ones until they are within the new tier's limit. All existing data and metrics remain accessible.
- **Archived playbooks and limits:** Archived custom playbooks do NOT count toward the active limit. A user at 5/5 active custom playbooks can archive one and create a new one.
- **Concurrent creation with same name:** The database UNIQUE constraint (`unique_playbook_name_per_user`) ensures only one succeeds. The second request receives a 409 Conflict.

---

### 3.3 Custom Playbook Read (List and Detail)

**Source:** PB-FR-006

#### 3.3.1 List Playbooks

**Endpoint:** `GET /api/v1/playbooks`

**Query Parameters:**

| Parameter | Type | Default | Description |
|---|---|---|---|
| `status` | string | `all` | Filter by status: `active`, `archived`, or `all` |
| `include_metrics` | boolean | `true` | Include summary metrics in list response |
| `sort` | string | `priority` | Sort by: `priority`, `name`, `created_at`, `trade_count` |
| `sort_dir` | string | `asc` | Sort direction: `asc` or `desc` |

**Processing Logic:**

1. Query all playbooks for the authenticated user (via RLS).
2. If user is a team member, also include shared playbooks from their organization where `is_shared = true`.
3. Apply status filter.
4. For each playbook, include `trade_count` (from `playbook_metrics` where `period_type = 'all_time'`).
5. For Free-tier users, mark "Standard Trendline Break" and "Trendline Bounce" with `tier_locked: true`.
6. Sort by the specified field.

**Success Response (200 OK):**
```json
{
  "playbooks": [
    {
      "id": "...",
      "name": "A+ Trendline Break",
      "slug": "aplus-trendline-break",
      "color": "#6366F1",
      "icon": "chart-line",
      "is_default": true,
      "status": "active",
      "tier_locked": false,
      "trade_count": 24,
      "closed_trade_count": 22,
      "win_rate": 0.6364,
      "total_pnl": 4250.00,
      "priority": 200,
      "has_auto_rules": true,
      "created_at": "2026-01-15T10:00:00Z"
    }
  ],
  "counts": {
    "total": 6,
    "active": 5,
    "archived": 1,
    "custom_active": 2,
    "custom_limit": 5
  }
}
```

**UI States:**

| State | Condition | Display |
|---|---|---|
| Empty (new user) | Only default playbooks exist, all have 0 trades | Show all four default playbooks with "No trades yet" badge. Show a prompt: "Create your first trade to see auto-classification in action." |
| Loading | API request in progress | Skeleton cards (4 placeholder cards with animated pulse). |
| Success | Playbooks returned | List of playbook cards with metrics summary. |
| Error | API request fails | "Unable to load your playbooks. Please try again." with a "Retry" button. |
| Tier-locked item | Free-tier user viewing locked defaults | Card shown with semi-transparent overlay and lock icon. Clicking shows: "Upgrade to Trader to unlock this playbook and track Standard Trendline Breaks independently." with "Upgrade" button. |

#### 3.3.2 Get Playbook Detail

**Endpoint:** `GET /api/v1/playbooks/{id}`

Returns the full playbook record including configuration, all-time metrics, and recent trades summary.

**Error Handling:**

| HTTP Status | Condition | Response |
|---|---|---|
| 404 | Playbook ID does not exist or does not belong to user | `{ "error": "not_found", "message": "Playbook not found." }` |
| 403 | Free-tier user requesting a locked default playbook | `{ "error": "tier_restricted", "message": "Upgrade to Trader to access this playbook.", "upgrade_url": "/settings/billing" }` |

---

### 3.4 Auto-Classification Rules Engine

**Source:** PB-FR-015 through PB-FR-022

#### 3.4.1 Rule Schema (v1.0)

```json
{
  "version": "1.0",
  "match_mode": "all | any",
  "conditions": [
    {
      "field": "<supported_field>",
      "operator": "<supported_operator>",
      "value": "<threshold_value>"
    }
  ]
}
```

- `version`: Must be `"1.0"`. Future versions will be backward compatible.
- `match_mode`: `"all"` = all conditions must match (AND logic). `"any"` = at least one condition must match (OR logic).
- `conditions`: Array of 1 or more condition objects. Empty array is invalid.

#### 3.4.2 Supported Fields

| Field | Type | Source | Description |
|---|---|---|---|
| `touch_count` | integer | PRD-002 trendline metadata | Number of confirmed touches on the trendline (minimum 2) |
| `slope_angle` | float | PRD-002 trendline metadata | Absolute slope angle in degrees (0-90) |
| `candle_spacing_min` | integer | PRD-002 trendline metadata | Minimum candles between any two consecutive touches |
| `trendline_duration_weeks` | float | PRD-002 trendline metadata | Duration from first touch to signal in weeks |
| `trendline_grade` | enum | PRD-002 trendline metadata | Values: `"A+"`, `"A"`, `"B"`, `"C"` |
| `setup_type` | enum | PRD-002 trendline metadata | Values: `"break"`, `"bounce"` |
| `direction` | enum | Trade metadata | Values: `"long"`, `"short"` |
| `instrument` | string | Trade metadata | Futures symbol, e.g., `"CL"`, `"GC"`, `"PL"` |
| `signal_source` | enum | Trade metadata | Values: `"trendline_engine"`, `"tradingview_webhook"`, `"manual"` |
| `session` | enum | Trade metadata | Values: `"rth"`, `"overnight"` |
| `timeframe` | enum | Trade metadata | Values: `"1H"`, `"4H"`, `"D"`, `"W"` |

#### 3.4.3 Supported Operators

| Operator | Description | Valid For Types | Example |
|---|---|---|---|
| `eq` | Equal to | All types | `{ "field": "setup_type", "operator": "eq", "value": "break" }` |
| `neq` | Not equal to | All types | `{ "field": "direction", "operator": "neq", "value": "short" }` |
| `gt` | Greater than | integer, float | `{ "field": "touch_count", "operator": "gt", "value": 2 }` |
| `gte` | Greater than or equal | integer, float | `{ "field": "touch_count", "operator": "gte", "value": 3 }` |
| `lt` | Less than | integer, float | `{ "field": "slope_angle", "operator": "lt", "value": 45 }` |
| `lte` | Less than or equal | integer, float | `{ "field": "slope_angle", "operator": "lte", "value": 30 }` |
| `in` | Value in list | enum, string | `{ "field": "instrument", "operator": "in", "value": ["CL", "GC"] }` |
| `not_in` | Value not in list | enum, string | `{ "field": "session", "operator": "not_in", "value": ["overnight"] }` |

#### 3.4.4 Default Playbook Rules (Immutable)

**A+ Trendline Break (priority 200):**
```json
{
  "version": "1.0",
  "match_mode": "all",
  "conditions": [
    { "field": "touch_count", "operator": "gte", "value": 3 },
    { "field": "slope_angle", "operator": "lt", "value": 45 },
    { "field": "candle_spacing_min", "operator": "gte", "value": 6 },
    { "field": "trendline_duration_weeks", "operator": "gte", "value": 3 },
    { "field": "setup_type", "operator": "eq", "value": "break" }
  ]
}
```

**Standard Trendline Break (priority 300):**
```json
{
  "version": "1.0",
  "match_mode": "all",
  "conditions": [
    { "field": "touch_count", "operator": "eq", "value": 2 },
    { "field": "setup_type", "operator": "eq", "value": "break" }
  ]
}
```

**Trendline Bounce (priority 400):**
```json
{
  "version": "1.0",
  "match_mode": "all",
  "conditions": [
    { "field": "touch_count", "operator": "gte", "value": 2 },
    { "field": "setup_type", "operator": "eq", "value": "bounce" }
  ]
}
```

#### 3.4.5 Rule Validation

When `auto_classify_rules` is provided on playbook create or update, validate:

1. **`version`** must equal `"1.0"`. Error: `"Unsupported rule schema version '{value}'. Supported versions: 1.0."`
2. **`match_mode`** must be `"all"` or `"any"`. Error: `"match_mode must be 'all' or 'any'."`
3. **`conditions`** must be a non-empty array. Error: `"At least one condition is required."`
4. Each condition's **`field`** must be in the supported fields list. Error: `"Unknown field '{value}'. Supported fields: touch_count, slope_angle, ..."`
5. Each condition's **`operator`** must be valid for the field's type. Error: `"Operator '{operator}' is not valid for field '{field}' (type: {type}). Valid operators: eq, neq, gt, gte, lt, lte."`
6. Each condition's **`value`** must match the field's type. Error: `"Value for field '{field}' must be a {expected_type}, got {actual_type}."`
7. For `in` and `not_in` operators, `value` must be a non-empty array. Error: `"Value for 'in'/'not_in' operator must be a non-empty array."`
8. Maximum 20 conditions per rule set. Error: `"Maximum 20 conditions allowed per rule set."`

#### 3.4.6 Classification Evaluation Process

**Trigger:** `trade.created` event from the execution pipeline (PRD-003) or manual journal entry (PRD-004).

**Step 1: Extract metadata.**
- Read trendline metadata from the trade's associated signal/trendline record.
- If no trendline metadata exists (manual trade, non-trendline webhook where `signal_source = "manual"` or `signal_source = "tradingview_webhook"` without trendline data), skip to Step 4.

**Step 2: Build evaluation list.**
- Query all of the user's active playbooks (`status = 'active'`) that have non-null `auto_classify_rules`.
- For Free-tier users, exclude tier-locked playbooks from evaluation.
- Order by `priority` ASC, then `created_at` ASC (deterministic tiebreaker for same-priority playbooks).
- The resulting order is: custom playbooks (priority 1-100), then A+ Trendline Break (200), Standard Trendline Break (300), Trendline Bounce (400).

**Step 3: Evaluate rules.**
- For each playbook in priority order:
  - For each condition in the playbook's rule set:
    - Look up the condition's `field` in the trade metadata.
    - If the field is not present in the trade metadata, the condition evaluates to `false`.
    - Otherwise, apply the operator comparison.
  - If `match_mode = "all"`: all conditions must be true for a match.
  - If `match_mode = "any"`: at least one condition must be true for a match.
  - On first match: assign trade to this playbook. Stop evaluation. Go to Step 5.
  - If no match: continue to next playbook.

**Step 4: Fallback.**
- If no playbook matched (or metadata was unavailable), assign to "Custom / Manual" playbook.
- If metadata was unavailable, set `classification_note = "trendline_metadata_unavailable"`.

**Step 5: Record assignment.**
- Insert into `trade_playbook_assignments`:
  - `trade_id`: the trade's ID
  - `playbook_id`: the matched playbook's ID
  - `classification_method`: `"auto"` if matched by rules, `"manual"` if fallback due to no metadata
  - `matched_rule_snapshot`: a frozen JSON copy of the matched playbook's `auto_classify_rules` at the time of classification (null if fallback)
  - `compliance_checks`: null (populated later via journal)
  - `compliance_score`: null
- Insert into `classification_audit_log`:
  - `from_playbook_id`: null (initial classification)
  - `to_playbook_id`: the matched playbook's ID
  - `to_method`: `"auto"` or `"manual"`
  - `changed_by`: system user ID for auto, user ID for manual

**Performance requirement:** The entire classification process (Steps 1-5) must complete within 2 seconds at p95 latency, including database reads and writes. For up to 50 active playbooks with rules, rule evaluation alone must complete within 500ms.

#### 3.4.7 Test Classification Endpoint

**Endpoint:** `POST /api/v1/playbooks/test-classify`

**Purpose:** Allows users to test which playbook a hypothetical trade would be classified into, without creating any records. Supports rule authoring and debugging.

**Request Body:**
```json
{
  "metadata": {
    "touch_count": 3,
    "slope_angle": 38.5,
    "candle_spacing_min": 8,
    "trendline_duration_weeks": 4.2,
    "trendline_grade": "A+",
    "setup_type": "break",
    "direction": "long",
    "instrument": "CL",
    "signal_source": "trendline_engine",
    "session": "rth",
    "timeframe": "4H"
  }
}
```

**Success Response (200 OK):**
```json
{
  "matched_playbook": {
    "id": "...",
    "name": "A+ Trendline Break",
    "slug": "aplus-trendline-break",
    "is_default": true,
    "priority": 200
  },
  "matched_rule": {
    "version": "1.0",
    "match_mode": "all",
    "conditions": [...]
  },
  "evaluation_trace": [
    {
      "playbook_id": "...",
      "playbook_name": "High-Volume Breakouts",
      "priority": 10,
      "result": "no_match",
      "failed_conditions": [
        { "field": "session", "operator": "eq", "value": "rth", "actual": "rth", "result": "pass" },
        { "field": "touch_count", "operator": "gte", "value": 4, "actual": 3, "result": "fail" }
      ]
    },
    {
      "playbook_id": "...",
      "playbook_name": "A+ Trendline Break",
      "priority": 200,
      "result": "match",
      "matched_conditions": [...]
    }
  ]
}
```

**Error Handling:**

| HTTP Status | Condition | Response |
|---|---|---|
| 400 | Empty metadata object | `{ "error": "validation_error", "message": "At least one metadata field is required." }` |
| 400 | Unknown metadata field | `{ "error": "validation_error", "message": "Unknown metadata field: '{field}'." }` |
| 403 | Free-tier user | `{ "error": "tier_restricted", "message": "Test classification requires the Trader plan or above.", "upgrade_url": "/settings/billing" }` |

#### 3.4.8 Edge Cases

- **Trade matches multiple custom rules with same priority:** First rule by `created_at` ASC wins (deterministic ordering).
- **All playbooks archived except "Custom / Manual":** All new trades go to "Custom / Manual".
- **Rule references a field not present in trade metadata:** That condition evaluates to `false`. With `match_mode: "all"`, the entire rule fails. With `match_mode: "any"`, other conditions may still match.
- **Trade with `match_mode: "any"` and 3 conditions, 1 matches:** Trade is classified into that playbook.
- **Trendline engine is down at trade creation time:** Trade metadata is unavailable. Trade is assigned to "Custom / Manual" with `classification_note = "trendline_metadata_unavailable"`. The trade can be manually reclassified later when metadata becomes available.

---

### 3.5 Custom Playbook Update

**Source:** PB-FR-007

#### 3.5.1 Description

Users can update their custom playbooks. Default playbooks have limited editability (risk overrides only).

#### 3.5.2 Endpoint

`PATCH /api/v1/playbooks/{id}`

#### 3.5.3 Processing Logic

**Step 1: Authorization.**
- Verify user owns the playbook.
- If the playbook is a default playbook (`is_default = true`), only `risk_overrides` may be modified. Reject changes to any other field with: `{ "error": "immutable_field", "message": "Default playbook {field_name} cannot be modified." }`
- If the user's tier does not permit editing (Free tier for defaults, downgraded tier for customs), reject with 403.

**Step 2: Validate changed fields.**
- Apply same validation rules as creation (section 3.2.2).
- For `name` changes, re-check uniqueness.
- For `auto_classify_rules` changes, re-validate rule schema.

**Step 3: Confirmation for rule changes.**
- If `auto_classify_rules` is being changed, the API response includes a `warning` field: `"Changes to classification rules do not retroactively reclassify existing trades. Only new trades will be evaluated against the updated rules."`
- The frontend must display a confirmation dialog with this warning before submitting the PATCH request. The request must include `"confirm_rule_change": true` in the body if rules are being changed.

**Step 4: Update record.**
- Update the `playbooks` table.
- Set `updated_at` to current timestamp.
- If `name` changed, regenerate `slug`.

#### 3.5.4 Error Handling

| HTTP Status | Condition | Response |
|---|---|---|
| 400 | Missing `confirm_rule_change: true` when rules are changed | `{ "error": "confirmation_required", "message": "Changing classification rules requires confirmation. Existing trades will not be reclassified." }` |
| 403 | Attempting to edit default playbook criteria | `{ "error": "immutable_field", "message": "Default playbook classification rules cannot be modified." }` |
| 403 | Tier does not permit editing | `{ "error": "tier_restricted", "message": "Your current plan does not allow playbook modifications. Upgrade or archive excess playbooks.", "upgrade_url": "/settings/billing" }` |
| 404 | Playbook not found or not owned by user | `{ "error": "not_found", "message": "Playbook not found." }` |
| 409 | Updated name conflicts with existing playbook | `{ "error": "duplicate_name", "message": "A playbook named \"{name}\" already exists." }` |

---

### 3.6 Custom Playbook Deletion

**Source:** PB-FR-008, PB-FR-014

#### 3.6.1 Description

Custom playbooks can be permanently deleted only if they contain zero trades. Default playbooks cannot be deleted.

#### 3.6.2 Endpoint

`DELETE /api/v1/playbooks/{id}`

#### 3.6.3 Processing Logic

**Step 1:** Verify user owns the playbook.
**Step 2:** Verify `is_default = false`. Default playbooks cannot be deleted.
**Step 3:** Count trades assigned to this playbook via `trade_playbook_assignments`.
**Step 4:** If trade count > 0, reject with 409 and provide guidance.
**Step 5:** If trade count = 0, delete the playbook record, associated `playbook_metrics` records, and any `playbook_equity_curve` records (should be none since no trades).

#### 3.6.4 Error Handling

| HTTP Status | Condition | Response |
|---|---|---|
| 403 | Attempting to delete a default playbook | `{ "error": "cannot_delete", "message": "Default playbooks cannot be deleted. You may archive them instead." }` |
| 403 | Attempting to delete "Custom / Manual" | `{ "error": "cannot_delete", "message": "The Custom / Manual playbook cannot be deleted or archived." }` |
| 409 | Playbook has trades assigned | `{ "error": "has_trades", "message": "This playbook has {count} trade(s) assigned. Reassign all trades to another playbook first, or archive the playbook instead.", "trade_count": 15, "actions": ["reassign_trades", "archive"] }` |
| 404 | Playbook not found | `{ "error": "not_found", "message": "Playbook not found." }` |

---

### 3.7 Playbook Archiving and Unarchiving

**Source:** PB-FR-011, PB-FR-012, PB-FR-013, PB-FR-014

#### 3.7.1 Archive

**Endpoint:** `POST /api/v1/playbooks/{id}/archive`

**Behavior on archive:**

1. Set `status = 'archived'` and `archived_at = NOW()`.
2. Remove the playbook from the active playbook list (filtered out by default in `GET /api/v1/playbooks` when `status=active`).
3. Remove the playbook from auto-classification evaluation. New trades will no longer be classified into this playbook.
4. Remove the playbook from the default comparison view (but it can be manually included via toggle).
5. Preserve all historical trades, metrics, equity curve data. Nothing is deleted.
6. The archived playbook does NOT count toward the user's active custom playbook limit.

**What the user sees after archiving:**
- Playbook disappears from the active playbook list.
- If viewing "All" playbooks, the archived playbook appears with a badge: "Archived on {date}".
- Clicking the archived playbook shows its full metrics and trade history with a banner: "This playbook is archived. New trades will not be classified here. You can unarchive it to resume tracking."

**Error Handling:**

| HTTP Status | Condition | Response |
|---|---|---|
| 403 | Attempting to archive "Custom / Manual" | `{ "error": "cannot_archive", "message": "The Custom / Manual playbook cannot be archived. It serves as the fallback for unclassified trades." }` |
| 409 | Playbook is already archived | `{ "error": "already_archived", "message": "This playbook is already archived." }` |
| 404 | Playbook not found | `{ "error": "not_found", "message": "Playbook not found." }` |

#### 3.7.2 Unarchive

**Endpoint:** `POST /api/v1/playbooks/{id}/unarchive`

**Processing Logic:**

1. Verify the playbook is currently archived (`status = 'archived'`).
2. If the playbook is a custom playbook, check whether unarchiving would exceed the user's tier limit for active custom playbooks. If so, reject.
3. Set `status = 'active'`, clear `archived_at`.
4. The playbook resumes participation in auto-classification (if it has rules).
5. The playbook reappears in the active list and comparison views.

**Error Handling:**

| HTTP Status | Condition | Response |
|---|---|---|
| 403 | Unarchiving would exceed tier limit | `{ "error": "limit_reached", "message": "Unarchiving this playbook would exceed your plan's limit of {limit} active custom playbooks. Archive another playbook first or upgrade.", "current_count": 5, "limit": 5, "upgrade_url": "/settings/billing" }` |
| 409 | Playbook is not archived | `{ "error": "not_archived", "message": "This playbook is not archived." }` |
| 404 | Playbook not found | `{ "error": "not_found", "message": "Playbook not found." }` |

---

### 3.8 Manual Trade-to-Playbook Assignment

**Source:** PB-FR-023, PB-FR-024

#### 3.8.1 Description

Users can manually assign or reassign a single trade to any active playbook, overriding any prior auto-classification.

#### 3.8.2 Endpoint

`POST /api/v1/trades/{trade_id}/assign-playbook`

**Request Body:**
```json
{
  "playbook_id": "target-playbook-uuid",
  "reason": "Optional: why I'm reassigning this trade"
}
```

#### 3.8.3 Processing Logic

**Step 1:** Verify user owns the trade.
**Step 2:** Verify target playbook exists, belongs to user (or is a shared team playbook with "Use" permission), and is not archived.
**Step 3:** Read current assignment from `trade_playbook_assignments`.
**Step 4:** If the trade is already assigned to the target playbook, return 200 with no changes (idempotent).
**Step 5:** Update `trade_playbook_assignments`:
- Set `playbook_id = target_playbook_id`.
- Set `classification_method = "manual"`.
- If this is the first reclassification (no prior reclassification), store current values in `original_playbook_id` and `original_classification_method`.
- Set `reclassified_at = NOW()`.
**Step 6:** Insert into `classification_audit_log`:
- `from_playbook_id`: previous playbook ID.
- `to_playbook_id`: new playbook ID.
- `from_method`: previous classification method.
- `to_method`: `"manual"`.
- `changed_by`: authenticated user ID.
- `reason`: from request body (nullable).
**Step 7:** Trigger metrics recalculation for BOTH the source (old) and destination (new) playbooks.

#### 3.8.4 Playbook Selection Dropdown (UI Specification)

During manual trade entry via the journal UI [Cross-reference: see FSD-004 for journal entry details], the playbook selection dropdown behaves as follows:

1. **Dropdown contents:** All active (non-archived) playbooks, ordered by most recently used (most recent trade assignment first), then alphabetically for playbooks with no trades.
2. **Pre-selection logic:**
   - If the trade has trendline metadata and auto-classification produced a match: pre-select the auto-classified playbook. Show a label: "Auto-classified" next to the pre-selected option.
   - If no auto-classification was performed: pre-select "Custom / Manual".
3. **Visual indicators in dropdown:** Each option shows the playbook's color dot, name, and trade count in parentheses (e.g., "A+ Trendline Break (24)").
4. **Search:** The dropdown supports type-ahead search/filtering when there are more than 5 playbooks.

#### 3.8.5 Error Handling

| HTTP Status | Condition | Response |
|---|---|---|
| 400 | `playbook_id` is missing | `{ "error": "validation_error", "message": "playbook_id is required." }` |
| 403 | User does not own the trade | `{ "error": "forbidden", "message": "You do not have access to this trade." }` |
| 404 | Trade not found | `{ "error": "not_found", "message": "Trade not found." }` |
| 404 | Target playbook not found | `{ "error": "not_found", "message": "Playbook not found." }` |
| 409 | Target playbook is archived | `{ "error": "playbook_archived", "message": "Cannot assign trades to an archived playbook. Unarchive the playbook first." }` |

---

### 3.9 Trade Re-Classification (Single and Bulk)

**Source:** PB-FR-025, PB-FR-026, PB-FR-027

#### 3.9.1 Single Re-Classification

Identical to manual assignment (section 3.8). The endpoint and behavior are the same regardless of whether this is the first assignment or a subsequent reassignment.

#### 3.9.2 Bulk Re-Classification

**Endpoint:** `POST /api/v1/trades/bulk-assign-playbook`

**Request Body:**
```json
{
  "trade_ids": ["uuid1", "uuid2", "...up to 500"],
  "target_playbook_id": "target-playbook-uuid",
  "reason": "Optional reason for bulk move"
}
```

**Processing Logic:**

1. Validate `trade_ids` array: minimum 1, maximum 500.
2. Verify user owns all listed trades. If any trade is not owned, reject the entire operation.
3. Verify target playbook is active and owned by user (or shared with "Use" permission).
4. Execute in a single database transaction:
   a. For each trade, update `trade_playbook_assignments` (same logic as single reassignment).
   b. Insert audit log entries for each trade.
5. After transaction commits, trigger metrics recalculation for ALL affected playbooks (all distinct source playbooks plus the destination playbook).
6. Return summary of results.

**Success Response (200 OK):**
```json
{
  "reassigned": 500,
  "target_playbook": {
    "id": "...",
    "name": "High-Volume Breakouts"
  },
  "source_playbooks_affected": [
    { "id": "...", "name": "A+ Trendline Break", "trades_moved": 300 },
    { "id": "...", "name": "Custom / Manual", "trades_moved": 200 }
  ],
  "metrics_recalculation": "in_progress"
}
```

**Error Handling:**

| HTTP Status | Condition | Response |
|---|---|---|
| 400 | Empty `trade_ids` array | `{ "error": "validation_error", "message": "At least one trade ID is required." }` |
| 400 | More than 500 trade IDs | `{ "error": "validation_error", "message": "Maximum 500 trades can be reassigned in a single operation. You submitted {count}." }` |
| 403 | User does not own one or more trades | `{ "error": "forbidden", "message": "You do not have access to {count} of the specified trades.", "inaccessible_trade_ids": ["uuid1", "uuid2"] }` |
| 409 | Target playbook is archived | `{ "error": "playbook_archived", "message": "Cannot assign trades to an archived playbook." }` |
| 409 | Concurrent modification conflict | `{ "error": "conflict", "message": "One or more trades were modified by another operation. Please retry." }` |

**Performance requirement:** Bulk reclassification of 500 trades must complete within 30 seconds at p95, including all database writes and subsequent metrics recalculation for affected playbooks.

**Atomicity:** The bulk operation is atomic. If any individual reassignment fails (e.g., due to a concurrent modification), the entire operation rolls back. No partial reclassification occurs.

---

### 3.10 Per-Playbook Metrics Calculation

**Source:** PB-FR-028, PB-FR-029, PB-FR-030, PB-FR-031, PB-FR-032

#### 3.10.1 Metrics Definitions

**Core Performance Metrics:**

| Metric | ID | Formula | Min Trades | Display When Insufficient |
|---|---|---|---|---|
| Win Rate | `win_rate` | `winning_trades / total_closed_trades` | 1 closed | "Insufficient data (0/{min} closed trades)" |
| Average R-Multiple | `avg_r_multiple` | `sum(r_multiples) / total_closed_trades` | 1 closed | "Insufficient data (0/1 closed trades)" |
| Profit Factor | `profit_factor` | `sum(winning_pnl) / abs(sum(losing_pnl))` | 1 win + 1 loss | "Insufficient data (need at least 1 winning and 1 losing trade)" |
| Expectancy ($) | `expectancy` | `(win_rate * avg_win) - (loss_rate * avg_loss)` | 1 win + 1 loss | Same as profit factor |
| Expectancy (R) | `expectancy_r` | `(win_rate * avg_win_r) - (loss_rate * avg_loss_r)` | 1 win + 1 loss | Same as profit factor |
| Average Winner | `avg_winner` | `sum(winning_pnl) / winning_trades` | 1 win | "No winning trades yet" |
| Average Loser | `avg_loser` | `sum(losing_pnl) / losing_trades` | 1 loss | "No losing trades yet" |
| Largest Win | `largest_win` | `max(pnl) where pnl > 0` | 1 win | "No winning trades yet" |
| Largest Loss | `largest_loss` | `min(pnl) where pnl < 0` | 1 loss | "No losing trades yet" |
| Total P&L | `total_pnl` | `sum(pnl)` | 1 closed | "No closed trades yet" |
| Total R | `total_r` | `sum(r_multiples)` | 1 closed | "No closed trades yet" |

**Risk-Adjusted Metrics:**

| Metric | ID | Formula | Min Trades | Display When Insufficient |
|---|---|---|---|---|
| Sharpe Ratio | `sharpe_ratio` | `mean(daily_returns) / std(daily_returns) * sqrt(252)` | 10 closed | "Insufficient data ({count}/10 closed trades required)" |
| Sortino Ratio | `sortino_ratio` | `mean(daily_returns) / downside_std(daily_returns) * sqrt(252)` | 10 closed | "Insufficient data ({count}/10 closed trades required)" |
| Max Drawdown ($) | `max_drawdown_dollar` | Maximum peak-to-trough decline in cumulative P&L | 2 closed | "Insufficient data ({count}/2 closed trades required)" |
| Max Drawdown (%) | `max_drawdown_pct` | `max_drawdown_dollar / equity_peak * 100` | 2 closed | Same as above |

**Behavioral Metrics:**

| Metric | ID | Formula | Min Trades | Display When Insufficient |
|---|---|---|---|---|
| Average Hold Time | `avg_hold_time` | `avg(exit_time - entry_time)` in minutes | 1 closed | "No closed trades yet" |
| Max Consecutive Wins | `max_consec_wins` | Longest streak of consecutive winning trades (ordered by exit time) | 1 closed | "No closed trades yet" |
| Max Consecutive Losses | `max_consec_losses` | Longest streak of consecutive losing trades (ordered by exit time) | 1 closed | "No closed trades yet" |
| Trade Count | `trade_count` | Total trades (open + closed) | 0 | Display "0" |
| Closed Trade Count | `closed_trade_count` | Trades with an exit recorded | 0 | Display "0" |

#### 3.10.2 Special Cases in Metric Calculation

- **Breakeven trades** (P&L = 0): Counted as neither a win nor a loss. They contribute to `trade_count` and `closed_trade_count` but not to `winning_trades` or `losing_trades`. They are included in `total_pnl` (adding 0).
- **Profit factor with only wins (no losses):** Display as "Infinity" in the UI, stored as `null` in the database with a flag `profit_factor_infinite: true`. In comparison views, this ranks as the best possible value.
- **Profit factor with only losses (no wins):** Display as "0.00".
- **Sharpe/Sortino with zero standard deviation (all returns identical):** Display as "N/A" (undefined). Stored as `null`.
- **Max drawdown with monotonically increasing equity:** Display as "$0.00 (0.00%)".
- **Average hold time display format:** Less than 60 minutes: show minutes (e.g., "45 min"). 1-48 hours: show hours and minutes (e.g., "4h 30m"). Over 48 hours: show days and hours (e.g., "3d 12h").

#### 3.10.3 Equity Curve Generation

For each closed trade assigned to a playbook, generate an equity curve data point:

1. Order all closed trades in the playbook by `exit_time` ASC.
2. For each trade:
   - `trade_pnl`: the trade's realized P&L.
   - `trade_r`: the trade's R-multiple.
   - `cumulative_pnl`: running sum of all prior trade P&Ls plus this trade.
   - `cumulative_r`: running sum of all prior R-multiples plus this trade.
   - `equity_peak`: `max(equity_peak_prev, cumulative_pnl)`.
   - `drawdown_dollar`: `cumulative_pnl - equity_peak` (0 or negative).
   - `drawdown_pct`: `drawdown_dollar / equity_peak * 100` (0 or negative). If `equity_peak <= 0`, set to 0.

Both dollar-denominated and R-multiple-denominated curves are generated. The curve starts at 0 (relative P&L, not absolute account equity).

#### 3.10.4 Recalculation Triggers

Metrics are recalculated when ANY of these events occur:

| Event | Affected Playbooks | Expected Latency |
|---|---|---|
| Trade closed (exit recorded) | The trade's assigned playbook | < 5 seconds (< 1 second for playbooks with < 1,000 trades) |
| Trade reclassified (single) | Both source and destination playbooks | < 5 seconds |
| Trade bulk-reclassified | All affected source playbooks + destination playbook | < 30 seconds for 500 trades |
| Trade P&L corrected (fill adjustment, commission update) | The trade's assigned playbook | < 5 seconds |

**Recalculation is idempotent.** Running the calculation multiple times for the same set of trades produces identical results. The system uses a `trade_hash` (SHA-256 hash of sorted trade IDs concatenated with their P&L values) to detect whether recalculation is necessary. If the hash matches the stored value, recalculation is skipped.

**During recalculation, the API serves stale cached metrics** with a response header `X-Metrics-Stale: true` and a body field `"stale": true`. The UI displays a subtle indicator: a small spinning icon next to the metrics with tooltip "Metrics are being updated."

#### 3.10.5 Date-Range Filtering

Users can view playbook metrics for specific periods:

| Period | `period_type` | Description |
|---|---|---|
| All time | `all_time` | All trades ever assigned to this playbook (default) |
| Last 30 days | `30d` | Trades closed in the last 30 calendar days |
| Last 90 days | `90d` | Trades closed in the last 90 calendar days |
| Last 180 days | `180d` | Trades closed in the last 180 calendar days |
| Year-to-date | `ytd` | Trades closed since January 1 of the current year |
| Custom range | `custom` | Trades closed between `start_date` and `end_date` (inclusive) |
| Rolling window | `rolling` | Last N closed trades (specified by `trade_count` parameter) |

**Pre-computed periods** (`all_time`, `30d`, `90d`, `180d`, `ytd`) are stored in the `playbook_metrics` table and refreshed on recalculation triggers. Custom and rolling periods are calculated on-the-fly from trade data.

**Endpoint:** `GET /api/v1/playbooks/{id}/metrics?period=90d`

**For custom range:** `GET /api/v1/playbooks/{id}/metrics?period=custom&start_date=2025-11-01&end_date=2026-01-31`

**For rolling window:** `GET /api/v1/playbooks/{id}/metrics?period=rolling&trade_count=20`

**Error Handling:**

| HTTP Status | Condition | Response |
|---|---|---|
| 400 | Invalid period type | `{ "error": "validation_error", "message": "Invalid period. Valid values: all_time, 30d, 90d, 180d, ytd, custom, rolling." }` |
| 400 | Custom period without dates | `{ "error": "validation_error", "message": "Custom period requires start_date and end_date parameters." }` |
| 400 | `start_date` > `end_date` | `{ "error": "validation_error", "message": "start_date must be before end_date." }` |
| 400 | Rolling window without `trade_count` | `{ "error": "validation_error", "message": "Rolling period requires trade_count parameter (1-10000)." }` |

---

### 3.11 Playbook Comparison View

**Source:** PB-FR-033, PB-FR-034

#### 3.11.1 Description

Users can compare metrics side-by-side for 2 or more playbooks. The comparison view renders as a table with metrics as rows and playbooks as columns, plus overlaid equity curves and distribution charts.

#### 3.11.2 Endpoint

`GET /api/v1/playbooks/compare?ids=pb1,pb2,pb3&period=90d`

#### 3.11.3 Tier Restrictions

| Tier | Max Playbooks in Comparison | Export |
|---|---|---|
| Free | Not available | No |
| Trader | 2 | No |
| Pro | Unlimited (up to 50) | No |
| Team | Unlimited (up to 50) | Yes (CSV, PDF) |

#### 3.11.4 Processing Logic

1. Parse comma-separated playbook IDs from `ids` parameter.
2. Verify user has access to all specified playbooks.
3. Verify the count does not exceed tier limit.
4. Fetch metrics for each playbook for the specified period.
5. For each metric row, determine best and worst values:
   - **Higher is better:** `win_rate`, `avg_r_multiple`, `profit_factor`, `expectancy`, `expectancy_r`, `avg_winner`, `largest_win`, `total_pnl`, `total_r`, `sharpe_ratio`, `sortino_ratio`, `max_consec_wins`, `avg_compliance_score`.
   - **Lower is better (less negative):** `avg_loser`, `largest_loss`, `max_drawdown_dollar`, `max_drawdown_pct`, `max_consec_losses`.
   - **Neutral (not highlighted):** `trade_count`, `closed_trade_count`, `avg_hold_time`.
6. Best value per row: highlighted with green background (`#ECFDF5`).
7. Worst value per row: highlighted with red background (`#FEF2F2`).
8. If only 2 playbooks are compared and both have >= 30 closed trades, calculate a statistical significance indicator for win rate difference using chi-squared test. Display: "Statistically significant at 95% confidence" or "Not statistically significant (need more data)".

#### 3.11.5 Comparison View Components

**Component 1: Metrics Table**
- Rows: All metrics from section 3.10.1.
- Columns: Selected playbooks, each with its color header.
- Cells: Metric value with best/worst highlighting.
- Insufficient data cells show "—" with tooltip explaining the minimum requirement.

**Component 2: Overlaid Equity Curves**
- Single chart with all selected playbooks' equity curves overlaid.
- Each curve uses the playbook's assigned `color`.
- X-axis: time (trade close dates). Y-axis: cumulative P&L.
- Toggle between dollar-denominated and R-multiple-denominated views.
- Legend showing playbook names with color indicators.

**Component 3: R-Multiple Distribution**
- Histogram per playbook showing R-multiple distribution.
- Bins: ..., -3R to -2R, -2R to -1R, -1R to 0R, 0R to 1R, 1R to 2R, 2R to 3R, ...
- Overlaid or side-by-side layout (user toggleable).

**Component 4: Win Rate Trend**
- Line chart showing rolling 20-trade win rate over time for each playbook.
- X-axis: trade number (sequential). Y-axis: win rate (0-100%).
- Requires minimum 20 closed trades per playbook to display. Otherwise: "Need at least 20 closed trades to show win rate trend."

#### 3.11.6 Error Handling

| HTTP Status | Condition | Response |
|---|---|---|
| 400 | Fewer than 2 playbook IDs | `{ "error": "validation_error", "message": "At least 2 playbooks are required for comparison." }` |
| 400 | Duplicate playbook IDs | `{ "error": "validation_error", "message": "Duplicate playbook IDs are not allowed." }` |
| 403 | Exceeds tier comparison limit | `{ "error": "tier_restricted", "message": "Your plan allows comparing up to {limit} playbooks. Upgrade to compare more.", "limit": 2, "requested": 3, "upgrade_url": "/settings/billing" }` |
| 403 | Free-tier user | `{ "error": "tier_restricted", "message": "Playbook comparison requires the Trader plan or above.", "upgrade_url": "/settings/billing" }` |
| 404 | One or more playbook IDs not found | `{ "error": "not_found", "message": "Playbook(s) not found: {ids}." }` |

**Performance requirement:** Comparison view response within 3 seconds at p95 for up to 5 playbooks with up to 1,000 trades each.

---

### 3.12 Playbook-Specific Risk Parameters

**Source:** PB-FR-035, PB-FR-036, PB-FR-037

#### 3.12.1 Risk Override Schema

```json
{
  "max_position_size": null,
  "max_risk_per_trade_pct": null,
  "max_risk_per_trade_dollar": null,
  "max_concurrent_positions": null,
  "min_rr_ratio": null,
  "max_daily_loss_dollar": null,
  "max_weekly_trades": null
}
```

| Field | Type | Description | Validation |
|---|---|---|---|
| `max_position_size` | integer or null | Maximum contracts per trade | 1-1000 or null |
| `max_risk_per_trade_pct` | float or null | Max risk as % of account | 0.01-100.0 or null |
| `max_risk_per_trade_dollar` | float or null | Max risk in dollars per trade | 1.00-1000000.00 or null |
| `max_concurrent_positions` | integer or null | Max open positions for this playbook | 1-100 or null |
| `min_rr_ratio` | float or null | Minimum reward-to-risk ratio | 0.1-100.0 or null |
| `max_daily_loss_dollar` | float or null | Daily loss limit for this playbook | 1.00-1000000.00 or null |
| `max_weekly_trades` | integer or null | Max trades per week for this playbook | 1-1000 or null |

- `null` means "use the user's global risk setting" [Cross-reference: see FSD-003 for global risk settings].
- Non-null values override the global setting for trades classified into this playbook.

#### 3.12.2 Risk Override Validation

On save, for each non-null override:
1. Validate the value is within the allowed range (see table above).
2. Compare against the user's global risk setting for the same parameter.
3. If the playbook override is LESS restrictive than the global setting (e.g., global `max_risk_per_trade_pct = 1.0%` and playbook override is `2.0%`), return a warning (not an error): `{ "warnings": [{ "field": "max_risk_per_trade_pct", "message": "This override (2.0%) is less restrictive than your global setting (1.0%). The playbook override will still be applied." }] }`
4. The warning does NOT block the save. The user is informed but the override is accepted.

#### 3.12.3 Risk Override Consumption

When the trade execution pipeline [Cross-reference: see FSD-003] processes a trade signal:

1. After auto-classification determines the target playbook, read the playbook's `risk_overrides`.
2. For each non-null field in `risk_overrides`, use the playbook's value instead of the user's global value.
3. For null fields, use the user's global value.
4. Apply the merged risk parameters to position sizing and risk checks.

---

### 3.13 Rule Compliance Tracking

**Source:** PB-FR-038, PB-FR-039, PB-FR-040, PB-FR-041

#### 3.13.1 Compliance Checklist Schema

```json
{
  "checklist": [
    {
      "id": "c1",
      "label": "Waited for 4H candle close past trendline",
      "auto_check": true,
      "field": "setup_type",
      "operator": "eq",
      "value": "break"
    },
    {
      "id": "c2",
      "label": "Stop placed at safety line (4th candle)",
      "auto_check": false
    },
    {
      "id": "c3",
      "label": "Target at first S/R >= 2R",
      "auto_check": true,
      "field": "planned_rr",
      "operator": "gte",
      "value": 2.0
    }
  ]
}
```

#### 3.13.2 Checklist Validation

- `checklist` must be a non-empty array. Error: `"Compliance checklist must contain at least one item."`
- Maximum 20 items. Error: `"Maximum 20 compliance checklist items allowed."`
- Each item must have a unique `id` (string, 1-20 characters). Error: `"Duplicate checklist item IDs found: {ids}."`
- Each item must have a `label` (string, 1-200 characters). Error: `"Checklist item {id} must have a label."`
- Each item must have `auto_check` (boolean).
- If `auto_check: true`, the item must have `field`, `operator`, and `value` matching the same validation rules as auto-classification conditions (section 3.4.5). Additionally, `field` can reference trade metadata fields beyond the trendline classification fields (e.g., `planned_rr`, `risk_pct`). Error: `"Auto-check item {id} must specify field, operator, and value."`
- If `auto_check: false`, the `field`, `operator`, and `value` fields are ignored if present.

#### 3.13.3 Compliance Score Calculation

For each trade assigned to a playbook with a compliance checklist:

1. **Auto-check items:** Evaluate automatically from trade metadata. If the condition is met, the item is "checked" (true). If the metadata field is missing, the item is "unchecked" (false) with a note "metadata unavailable."
2. **Manual-check items:** Presented to the user in the journal entry form [Cross-reference: see FSD-004]. The user checks or unchecks each item. Until the user interacts, manual items default to "unchecked."
3. **Compliance score:** `checked_items / total_items * 100`, rounded to 2 decimal places.
4. Store the individual check results in `trade_playbook_assignments.compliance_checks` as `{ "c1": true, "c2": false, "c3": true }`.
5. Store the score in `trade_playbook_assignments.compliance_score`.

#### 3.13.4 Rolling Compliance Rate

Per playbook, calculate: `avg(compliance_scores)` across all trades in the playbook within the selected date range. Stored in `playbook_metrics.avg_compliance_score`.

#### 3.13.5 Compliance-vs-Outcome Correlation

For each playbook with a compliance checklist:

- **High-compliance trades:** trades with `compliance_score >= 80.0`.
- **Low-compliance trades:** trades with `compliance_score < 80.0`.
- Calculate and display:
  - Average P&L for high-compliance trades vs. low-compliance trades.
  - Average R-multiple for high-compliance trades vs. low-compliance trades.
  - Win rate for high-compliance trades vs. low-compliance trades.
- Display format: A comparison card showing the two groups side-by-side with the difference highlighted.
- Minimum 5 trades in each group to display. Otherwise: "Need at least 5 trades in each compliance group (high >= 80% and low < 80%) to show this analysis."

---

### 3.14 Playbook Templates

**Source:** PB-FR-042, PB-FR-043, PB-FR-044, PB-FR-045

#### 3.14.1 Save as Template

**Endpoint:** `POST /api/v1/playbook-templates`

**Request Body:**
```json
{
  "source_playbook_id": "uuid-of-playbook-to-template",
  "name": "My A+ Strategy Template",
  "description": "Template for high-conviction trendline breaks"
}
```

**Processing Logic:**

1. Verify user tier is Pro or Team.
2. Verify user owns the source playbook.
3. Copy from the source playbook: `name` (or use provided override), `description`, `criteria_description`, `auto_classify_rules`, `compliance_checklist`, `risk_overrides`.
4. Do NOT copy: trade data, metrics, equity curves, trade assignments, color, icon, tags.
5. Set `created_by = authenticated_user_id`, `version = 1`, `usage_count = 0`.
6. For Team-tier users, set `org_id` to the user's organization and `is_shared = true` if requested.

**Success Response (201 Created):**
```json
{
  "id": "template-uuid",
  "name": "My A+ Strategy Template",
  "description": "Template for high-conviction trendline breaks",
  "criteria_description": "...",
  "auto_classify_rules": { ... },
  "compliance_checklist": { ... },
  "risk_overrides": { ... },
  "created_by": { "id": "user-uuid", "display_name": "Jane Trader" },
  "version": 1,
  "usage_count": 0,
  "is_shared": false,
  "created_at": "2026-02-11T14:30:00Z"
}
```

#### 3.14.2 Instantiate from Template

**Endpoint:** `POST /api/v1/playbook-templates/{template_id}/instantiate`

**Request Body:**
```json
{
  "name": "My Copy of A+ Strategy",
  "color": "#10B981"
}
```

**Processing Logic:**

1. Verify user tier is Pro or Team.
2. Verify user has access to the template (own template or shared team template).
3. Check user's custom playbook limit.
4. Create a new playbook pre-populated with the template's `criteria_description`, `auto_classify_rules`, `compliance_checklist`, and `risk_overrides`.
5. Use the provided `name` (required) and optional overrides for other fields.
6. Increment the template's `usage_count`.

**Error Handling:**

| HTTP Status | Condition | Response |
|---|---|---|
| 403 | Tier is below Pro | `{ "error": "tier_restricted", "message": "Playbook templates require the Pro plan or above.", "upgrade_url": "/settings/billing" }` |
| 403 | Playbook limit reached | Same as section 3.2.5 |
| 404 | Template not found or not accessible | `{ "error": "not_found", "message": "Template not found." }` |
| 409 | Playbook name conflict | Same as section 3.2.5 |

#### 3.14.3 Template Sharing (Team Tier)

- Team-tier users with `admin` or `owner` role can mark templates as shared (`is_shared = true`).
- Shared templates appear in a "Team Templates" tab in the template browser.
- Team members with `member` role can instantiate shared templates but cannot create or delete them.

---

### 3.15 Playbook Sharing (Team Tier)

**Source:** PB-FR-046, PB-FR-047, PB-FR-048, PB-FR-049

#### 3.15.1 Sharing Permissions

| Permission Level | View Config | View Own Metrics | Assign Own Trades | View Team Metrics | View Member Details |
|---|---|---|---|---|---|
| View | Yes | No | No | Yes (aggregate only) | No |
| Use | Yes | Yes | Yes | Yes (aggregate only) | No (unless admin enables) |

#### 3.15.2 Creating a Shared Playbook

Only users with `admin` or `owner` role in the organization can create shared playbooks. The process:

1. Create a playbook with `is_shared = true` and `org_id` set.
2. Set `share_permission` to `"view"` or `"use"`.
3. The playbook appears in all team members' playbook lists with a "Shared" badge.

#### 3.15.3 Shared Playbook Metrics Views

| View | Description | Who Can See |
|---|---|---|
| Individual | Metrics for only the viewing user's trades assigned to this shared playbook | Users with "Use" permission |
| Team Aggregate | Combined metrics across all team members' trades | All team members |
| Member Breakdown | Per-member metrics within the shared playbook | Admin/Owner only (or if admin enables visibility) |

#### 3.15.4 Team Member Departure

When a user leaves an organization:
1. Their trades remain tagged to the shared playbook for historical accuracy.
2. Their data continues to contribute to team aggregate metrics.
3. They lose access to team aggregate views and member breakdown.
4. Their copy of the shared playbook becomes a personal (unshared) playbook with `is_shared = false` and `org_id = null`.
5. They retain access to their own individual metrics on the now-personal copy.

---

## 4. Data Specifications

### 4.1 Data Models

#### 4.1.1 `playbooks` Table

| Column | Type | Constraints | Default | Description |
|---|---|---|---|---|
| `id` | UUID | PK | `gen_random_uuid()` | Unique playbook identifier |
| `user_id` | UUID | NOT NULL, FK -> users(id) | — | Owning user |
| `org_id` | UUID | FK -> organizations(id), nullable | `null` | Organization for team sharing |
| `name` | VARCHAR(100) | NOT NULL | — | Display name |
| `slug` | VARCHAR(120) | NOT NULL | — | URL-safe identifier |
| `description` | TEXT | nullable | `null` | Optional description |
| `criteria_description` | TEXT | NOT NULL | — | Human-readable setup rules |
| `auto_classify_rules` | JSONB | nullable | `null` | Rule engine JSON (null = manual-only) |
| `risk_overrides` | JSONB | nullable | `null` | Risk parameter overrides |
| `compliance_checklist` | JSONB | nullable | `null` | Compliance items |
| `color` | VARCHAR(7) | — | `'#6366F1'` | Hex color for charts |
| `icon` | VARCHAR(50) | — | `'chart-line'` | Icon identifier |
| `tags` | TEXT[] | — | `'{}'` | Array of tag strings |
| `priority` | INTEGER | CHECK (1-9999) | `50` | Auto-classification priority |
| `is_default` | BOOLEAN | — | `false` | System-seeded playbook flag |
| `is_shared` | BOOLEAN | — | `false` | Shared with team |
| `share_permission` | VARCHAR(10) | — | `'view'` | `'view'` or `'use'` |
| `status` | VARCHAR(20) | CHECK ('active','archived') | `'active'` | Lifecycle status |
| `archived_at` | TIMESTAMPTZ | nullable | `null` | When archived |
| `created_at` | TIMESTAMPTZ | — | `NOW()` | Creation timestamp |
| `updated_at` | TIMESTAMPTZ | — | `NOW()` | Last update timestamp |

**Constraints:**
- `UNIQUE (user_id, name)` — case-insensitive uniqueness enforced at application layer
- `UNIQUE (user_id, slug)` — slug uniqueness

**Indexes:**
- `idx_playbooks_classification ON playbooks (user_id, status, priority) WHERE status = 'active' AND auto_classify_rules IS NOT NULL` — optimizes classification query

#### 4.1.2 `trade_playbook_assignments` Table

| Column | Type | Constraints | Default | Description |
|---|---|---|---|---|
| `id` | UUID | PK | `gen_random_uuid()` | Assignment record ID |
| `trade_id` | UUID | NOT NULL, FK -> trades(id), UNIQUE | — | One assignment per trade |
| `playbook_id` | UUID | NOT NULL, FK -> playbooks(id) | — | Assigned playbook |
| `classification_method` | VARCHAR(10) | NOT NULL | — | `'auto'` or `'manual'` |
| `matched_rule_snapshot` | JSONB | nullable | `null` | Frozen copy of matched rule |
| `original_playbook_id` | UUID | FK -> playbooks(id), nullable | `null` | Pre-reclassification playbook |
| `original_classification_method` | VARCHAR(10) | nullable | `null` | Pre-reclassification method |
| `reclassified_at` | TIMESTAMPTZ | nullable | `null` | When last reclassified |
| `compliance_checks` | JSONB | nullable | `null` | `{ "c1": true, "c2": false }` |
| `compliance_score` | DECIMAL(5,2) | nullable | `null` | 0.00 - 100.00 |
| `created_at` | TIMESTAMPTZ | — | `NOW()` | — |
| `updated_at` | TIMESTAMPTZ | — | `NOW()` | — |

**Constraint:** `UNIQUE (trade_id)` — ensures every trade has exactly one playbook assignment.

#### 4.1.3 `playbook_metrics` Table

See PRD section 5.1 for full column list. Key constraint: `UNIQUE (playbook_id, period_type)` — one metrics record per playbook per period.

#### 4.1.4 `playbook_equity_curve` Table

See PRD section 5.1. Key constraint: `UNIQUE (playbook_id, trade_id)` — one curve point per trade per playbook.

#### 4.1.5 `classification_audit_log` Table

Append-only. No UPDATE or DELETE operations permitted. See PRD section 5.1.

#### 4.1.6 `playbook_templates` Table

See PRD section 5.1.

### 4.2 Data Validation Rules Summary

| Entity | Field | Rule |
|---|---|---|
| Playbook | `name` | 1-100 chars, unique per user (case-insensitive), no HTML |
| Playbook | `description` | 0-2000 chars, no HTML |
| Playbook | `criteria_description` | 1-5000 chars, no HTML |
| Playbook | `priority` | Integer 1-100 (custom), 200/300/400 (defaults), 9999 (fallback) |
| Playbook | `tags` | Array max 10 items, each 1-30 chars |
| Playbook | `color` | Regex `^#[0-9A-Fa-f]{6}$` |
| Playbook | `icon` | Must be in predefined set of 20 |
| Rule | `conditions` | Array 1-20 items |
| Compliance | `checklist` | Array 1-20 items, unique IDs |
| Risk Override | All numeric fields | Within specified ranges, or null |

### 4.3 Row-Level Security Policies

All tables use PostgreSQL RLS. Users can only access their own data, with the exception of shared team playbooks accessible to organization members.

---

## 5. API Specifications

### 5.1 Endpoint Summary

| Method | Path | Description | Auth | Min Tier |
|---|---|---|---|---|
| `POST` | `/api/v1/playbooks` | Create custom playbook | Required | Trader |
| `GET` | `/api/v1/playbooks` | List playbooks | Required | Free |
| `GET` | `/api/v1/playbooks/{id}` | Get playbook detail | Required | Free |
| `PATCH` | `/api/v1/playbooks/{id}` | Update playbook | Required | Trader |
| `DELETE` | `/api/v1/playbooks/{id}` | Delete playbook (0 trades) | Required | Trader |
| `POST` | `/api/v1/playbooks/{id}/archive` | Archive playbook | Required | Free |
| `POST` | `/api/v1/playbooks/{id}/unarchive` | Unarchive playbook | Required | Free |
| `POST` | `/api/v1/playbooks/classify` | Auto-classify trade (internal) | Service auth | N/A |
| `POST` | `/api/v1/playbooks/test-classify` | Test classification | Required | Trader |
| `POST` | `/api/v1/trades/{id}/assign-playbook` | Manual assign | Required | Free |
| `POST` | `/api/v1/trades/bulk-assign-playbook` | Bulk reassign | Required | Trader |
| `GET` | `/api/v1/playbooks/{id}/metrics` | Get metrics | Required | Free |
| `GET` | `/api/v1/playbooks/{id}/equity-curve` | Get equity curve | Required | Free |
| `GET` | `/api/v1/playbooks/compare` | Compare playbooks | Required | Trader |
| `POST` | `/api/v1/playbook-templates` | Save template | Required | Pro |
| `GET` | `/api/v1/playbook-templates` | List templates | Required | Pro |
| `POST` | `/api/v1/playbook-templates/{id}/instantiate` | Create from template | Required | Pro |
| `DELETE` | `/api/v1/playbook-templates/{id}` | Delete template | Required | Pro |

### 5.2 Authentication

All endpoints require a valid JWT token in the `Authorization: Bearer <token>` header. The `classify` internal endpoint requires a service-to-service API key or JWT with `service` role.

### 5.3 Rate Limiting

| Endpoint Category | Rate Limit |
|---|---|
| Read endpoints (GET) | 100 requests/minute per user |
| Write endpoints (POST, PATCH, DELETE) | 30 requests/minute per user |
| Bulk operations | 5 requests/minute per user |
| Test classification | 20 requests/minute per user |
| Internal classify | 1000 requests/minute per service |

### 5.4 Error Response Format

All error responses follow this structure:

```json
{
  "error": "error_code",
  "message": "Human-readable error message.",
  "field": "field_name (if applicable)",
  "details": [],
  "upgrade_url": "/settings/billing (if tier-restricted)"
}
```

---

## 6. UI/UX Specifications

### 6.1 Screen Inventory

| Screen | Route | Description |
|---|---|---|
| Playbook List | `/playbooks` | Grid/list of all playbooks with summary metrics |
| Playbook Detail | `/playbooks/{slug}` | Full metrics, equity curve, trade list, compliance |
| Playbook Create | `/playbooks/new` | Form for creating custom playbook |
| Playbook Edit | `/playbooks/{slug}/edit` | Form for editing custom playbook |
| Playbook Compare | `/playbooks/compare` | Side-by-side comparison view |
| Rule Builder | Component within Create/Edit | Visual builder for auto-classification rules |
| Template Browser | `/playbooks/templates` | Browse and instantiate templates |

### 6.2 Playbook List States

| State | Condition | Display |
|---|---|---|
| Empty (new user) | 4 default playbooks, 0 trades | Playbook cards with "No trades yet" badges. Prompt: "Create your first trade to see auto-classification in action. Your trades will be automatically sorted into the right playbook." |
| Loading | API in progress | 4 skeleton cards with pulse animation |
| Populated | Playbooks with trades | Cards showing name, color dot, trade count, win rate, total P&L. Sorted by priority. |
| Error | API failure | "Unable to load playbooks. Please try again." + Retry button |
| Tier-locked items | Free-tier user | Locked defaults shown with overlay: lock icon, "Upgrade to unlock" text |
| Mixed active/archived | Some archived | Only active shown by default. Toggle: "Show archived (N)" to include archived items with "Archived" badge |

### 6.3 Playbook Creation Flow

1. User clicks "New Playbook" button (visible only to Trader+ tier).
2. **Free-tier user:** Button disabled with tooltip: "Upgrade to Trader to create custom playbooks."
3. **At limit:** Button shows: "Playbook limit reached ({count}/{limit}). Upgrade or archive an existing playbook."
4. Form loads with required fields highlighted.
5. User fills `name` (validated inline: duplicate check on blur, length check on input).
6. User fills `criteria_description` (character counter shown).
7. User optionally adds auto-classification rules via visual rule builder or JSON editor (toggleable).
8. User optionally configures risk overrides, compliance checklist, color, icon, tags.
9. User clicks "Create Playbook".
10. **Success:** Redirect to new playbook detail page. Toast: "Playbook '{name}' created successfully."
11. **Validation error:** Inline errors on relevant fields. Form does not submit.
12. **Server error:** Toast: "Failed to create playbook. Please try again."

### 6.4 Visual Rule Builder

The rule builder provides a GUI for constructing auto-classification rules without writing JSON.

**Layout:**
- Match mode selector: Radio buttons for "All conditions must match (AND)" / "Any condition can match (OR)".
- Condition rows: Each row has three dropdowns/inputs:
  - Field selector (dropdown of supported fields with descriptions).
  - Operator selector (filtered to valid operators for the selected field type).
  - Value input (text input for numbers, dropdown for enums, multi-select for `in`/`not_in`).
- "Add Condition" button (disabled at 20 conditions).
- "Remove" button per condition row.
- Live JSON preview panel (collapsible).
- "Test Rules" button that opens a test classification panel.

**Bidirectional sync:** Changes in the visual builder update the JSON preview. Editing the JSON directly updates the visual builder. Invalid JSON shows an error: "Invalid JSON. Please fix the syntax or use the visual builder."

### 6.5 Accessibility Requirements

- All form fields have associated labels.
- Error messages are announced to screen readers via `aria-live="polite"`.
- Color-coded elements (playbook colors, best/worst highlighting) also have text or icon indicators for color-blind users.
- Keyboard navigation works for all interactive elements.
- Charts provide text alternatives accessible via screen reader.

---

## 7. Integration Specifications

### 7.1 Upstream: Trendline Detection Engine (PRD-002)

[Cross-reference: see FSD-002 for trendline detection details]

**Data consumed:** Trendline metadata fields (`touch_count`, `slope_angle`, `candle_spacing_min`, `trendline_duration_weeks`, `trendline_grade`, `setup_type`) attached to trade signals.

**Fallback when unavailable:** If trendline metadata is missing or the trendline engine is down, the trade is assigned to "Custom / Manual" with `classification_note = "trendline_metadata_unavailable"`. No error is surfaced to the user during trade creation; the classification fallback is silent. The user can later reclassify the trade manually.

### 7.2 Upstream: Trade Execution Pipeline (PRD-003)

[Cross-reference: see FSD-003 for trade execution details]

**Event consumed:** `trade.created` — triggers auto-classification.

**Data provided back:** `risk_overrides` from the matched playbook are read by the execution pipeline during position sizing.

**Retry strategy:** If the `trade.created` event processing fails (e.g., database write failure during classification), the event is retried up to 3 times with exponential backoff (1s, 3s, 9s). If all retries fail, the trade is assigned to "Custom / Manual" and a system alert is generated for investigation.

### 7.3 Upstream: Trade Journaling (PRD-004)

[Cross-reference: see FSD-004 for journal entry details]

**UI integration:** Playbook selection dropdown and compliance checklist rendering within the journal entry form.

**Fallback when unavailable:** If the journal system is unavailable, auto-classification still occurs independently. Manual assignment and compliance checks are deferred until a journal entry is created.

### 7.4 Downstream: Performance Analytics (PRD-006)

[Cross-reference: see FSD-006 for analytics details]

**Data exposed:** `playbook_metrics` table and `playbook_equity_curve` table are queried by the analytics engine for aggregate cross-playbook views.

### 7.5 Event Contracts

| Event | Publisher | Consumer | Payload |
|---|---|---|---|
| `trade.created` | Execution Pipeline (PRD-003) | Playbook Classification Engine | `{ trade_id, user_id, trendline_metadata, signal_source }` |
| `trade.closed` | Execution Pipeline (PRD-003) | Playbook Metrics Calculator | `{ trade_id, playbook_id, pnl, r_multiple, exit_time }` |
| `trade.updated` | Execution Pipeline (PRD-003) | Playbook Metrics Calculator | `{ trade_id, playbook_id, updated_fields }` |
| `playbook.metrics_updated` | Playbook Metrics Calculator | Performance Analytics (PRD-006) | `{ playbook_id, period_type, updated_at }` |

---

## 8. Security Specifications

### 8.1 Authentication Requirements

All playbook API endpoints require a valid JWT token. The internal `classify` endpoint requires service-to-service authentication (API key or service JWT).

### 8.2 Authorization Matrix

| Role | Create Custom | Edit Custom | Delete Custom | Edit Default Risk | Archive | Compare | Templates | Share |
|---|---|---|---|---|---|---|---|---|
| Free | No | No | No | No | Yes (defaults only) | No | No | No |
| Trader | Yes (up to 5) | Yes | Yes (0 trades) | Yes | Yes | Yes (2 max) | No | No |
| Pro | Yes (up to 50) | Yes | Yes (0 trades) | Yes | Yes | Yes (unlimited) | Yes (use) | No |
| Team Admin | Yes (up to 50) | Yes | Yes (0 trades) | Yes | Yes | Yes (unlimited) | Yes (create+share) | Yes |
| Team Member | Yes (up to 50) | Yes (own only) | Yes (own, 0 trades) | Yes | Yes | Yes (unlimited) | Yes (use shared) | No |

### 8.3 Data Isolation

- All playbook data is isolated per user via PostgreSQL Row-Level Security (RLS).
- A user can NEVER read, write, or enumerate another user's playbooks, trades, or metrics.
- Exception: Team tier shared playbooks are accessible to organization members, subject to share permission level.

### 8.4 Input Sanitization

- All string fields (`name`, `description`, `criteria_description`, tag values) have HTML tags stripped on save.
- All JSON fields (`auto_classify_rules`, `risk_overrides`, `compliance_checklist`) are validated against their schemas. Unknown keys are rejected with 422.
- SQL injection is prevented by parameterized queries (ORM layer).

### 8.5 Audit Logging

- The `classification_audit_log` table is append-only. No API endpoint allows deletion or modification.
- All classification events (initial assignment, reclassification) are logged with timestamp, acting user, source and destination playbook, and method.

---

## 9. Performance Specifications

| Operation | Target Latency (p95) | Conditions |
|---|---|---|
| Auto-classification (full pipeline) | < 2 seconds | Up to 50 active playbooks with rules |
| Rule evaluation only | < 500ms | Up to 50 rule sets |
| Metrics recalculation | < 5 seconds | Playbook with up to 10,000 trades |
| Metrics recalculation (< 1,000 trades) | < 1 second | — |
| Playbook list API | < 200ms | Up to 50 active playbooks |
| Comparison view API | < 3 seconds | Up to 5 playbooks, up to 1,000 trades each |
| Bulk reclassification (500 trades) | < 30 seconds | Including metrics recalculation |
| Equity curve API | < 1 second | Up to 10,000 data points |

### 9.1 Caching Strategy

- Pre-computed metrics for standard periods (`all_time`, `30d`, `90d`, `180d`, `ytd`) are stored in `playbook_metrics` table and served directly.
- Cache invalidation: on any recalculation trigger (section 3.10.4), the affected playbook's cached metrics are recalculated and the `last_calculated_at` timestamp is updated.
- During recalculation, stale cached values are served with `stale: true` flag.
- Custom date range and rolling window metrics are computed on-the-fly (not cached).

### 9.2 Concurrency

- Concurrent reclassification of the same trade by two sessions: the database UNIQUE constraint on `trade_playbook_assignments.trade_id` and transaction isolation ensure only one succeeds. The second request receives 409 Conflict.
- Concurrent playbook creation with the same name: the database UNIQUE constraint ensures only one succeeds. The second request receives 409 Conflict.

---

## 10. Testing Specifications

### 10.1 Unit Test Scenarios

**Auto-Classification Engine:**

| Test ID | Input | Expected Output |
|---|---|---|
| UT-001 | Trade: touch_count=3, slope_angle=40, candle_spacing_min=8, trendline_duration_weeks=4, setup_type=break | Classified as "A+ Trendline Break" |
| UT-002 | Trade: touch_count=2, setup_type=break | Classified as "Standard Trendline Break" |
| UT-003 | Trade: touch_count=3, setup_type=bounce | Classified as "Trendline Bounce" |
| UT-004 | Trade: touch_count=2, setup_type=bounce | Classified as "Trendline Bounce" |
| UT-005 | Trade: no trendline metadata | Classified as "Custom / Manual" |
| UT-006 | Custom rule (priority 10) matches; A+ default also matches | Custom playbook wins (lower priority number) |
| UT-007 | No rules match | "Custom / Manual" |
| UT-008 | Trade: touch_count=5, slope_angle=50, setup_type=break | "Standard Trendline Break" (slope > 45 fails A+) |
| UT-009 | Trade: touch_count=3, slope_angle=30, candle_spacing_min=4, setup_type=break | "Standard Trendline Break" (spacing < 6 fails A+, but touch_count > 2 fails Standard, so actually Trendline Bounce? No -- setup_type=break, not bounce. Falls to Standard since touch_count=eq=2 fails. Falls through to Custom/Manual since no remaining rules match break with 3 touches and insufficient spacing.) |
| UT-010 | match_mode="any", 3 conditions, 1 matches | Classified into that playbook |

Note for UT-009: A trade with touch_count=3, slope_angle=30, candle_spacing_min=4, duration_weeks<3, setup_type=break fails A+ (spacing<6), fails Standard (touch_count != 2), is not a bounce. Result: "Custom / Manual".

**Metrics Calculation:**

| Test ID | Input Trades | Expected Metrics |
|---|---|---|
| UT-011 | 3 wins (+2R, +1R, +3R), 2 losses (-1R, -1R) | win_rate=0.6000, avg_r=0.8000, profit_factor=3.00, expectancy_r=0.8000, total_r=4.0000 |
| UT-012 | Only wins: +1R, +2R | profit_factor=null (infinite), win_rate=1.0000 |
| UT-013 | Only losses: -1R, -2R | profit_factor=0.0000, win_rate=0.0000 |
| UT-014 | 0 closed trades | All metrics null, displays "Insufficient data" |
| UT-015 | 5 trades (below Sharpe threshold) | sharpe_ratio=null, sortino_ratio=null, other metrics calculated |
| UT-016 | Equity curve: +100, -50, +200, -75, +150 | Cumulative: 100, 50, 250, 175, 325. Max drawdown_dollar=-75 (from peak 250 to trough 175) |
| UT-017 | W, W, L, W, W, W, L, L | max_consec_wins=3, max_consec_losses=2 |
| UT-018 | Recalculate same data twice | Identical results (idempotent) |

**Compliance Score:**

| Test ID | Checklist | Checks | Expected Score |
|---|---|---|---|
| UT-019 | 5 items | 4 checked, 1 unchecked | 80.00 |
| UT-020 | 3 items | 0 checked | 0.00 |
| UT-021 | 1 item | 1 checked | 100.00 |

### 10.2 Integration Test Scenarios

| Test ID | Systems | Scenario | Expected Result |
|---|---|---|---|
| IT-001 | PRD-002 + Playbook | Trendline engine detects A+ break, trade created | Trade auto-classified to "A+ Trendline Break" with correct metadata snapshot |
| IT-002 | PRD-003 + Playbook | Trade signal matches playbook with risk overrides | Execution pipeline uses playbook risk limits |
| IT-003 | PRD-004 + Playbook | User creates manual journal entry | Journal UI shows playbook dropdown, defaults to "Custom / Manual" |
| IT-004 | Playbook + PRD-006 | Playbook metrics updated | Analytics reflects updated data within 10 seconds |

### 10.3 Performance Test Criteria

| Test | Target | Method |
|---|---|---|
| Classification latency | < 2s at p95 | Load test with 50 active playbooks, 1000 concurrent classifications |
| Metrics recalculation | < 5s at p95 | Playbook with 10,000 trades, trigger recalculation |
| Playbook list API | < 200ms at p95 | User with 50 playbooks, 100 concurrent requests |
| Bulk reclassification | < 30s | 500 trades, 5 source playbooks, 1 destination |

### 10.4 Security Test Requirements

| Test | Description | Expected Result |
|---|---|---|
| ST-001 | User A requests User B's playbook by ID | 404 Not Found (not 403, to prevent enumeration) |
| ST-002 | Free-tier user attempts POST /api/v1/playbooks | 403 with upgrade message |
| ST-003 | User sends HTML in playbook name | HTML stripped on save, rendered as plain text |
| ST-004 | User sends invalid JSON in auto_classify_rules | 422 with specific validation error |
| ST-005 | External client calls internal classify endpoint | 401 Unauthorized |
| ST-006 | Team member accesses shared playbook after leaving org | 404 Not Found |

---

## 11. Migration & Deployment

### 11.1 Database Migration Steps

**Phase 1 (Weeks 9-10):**
1. Create `playbooks` table with all columns.
2. Create `trade_playbook_assignments` table.
3. Create `playbook_metrics` table.
4. Create `playbook_equity_curve` table.
5. Create `classification_audit_log` table.
6. Create `playbook_templates` table (empty, used in Phase 2-3).
7. Enable RLS on all tables with policies.
8. Create all indexes.
9. Run seeding migration for existing users: seed 4 default playbooks per user.
10. Backfill: classify existing trades into appropriate playbooks based on their trendline metadata.

**Phase 2 (Weeks 11-14):**
1. No schema changes (all columns already exist).
2. Enable custom playbook CRUD endpoints.
3. Enable comparison, compliance, and risk override features.

**Phase 3 (Weeks 15-22):**
1. Enable tier limit enforcement (soft launch: warn only for 1 week, then enforce).
2. Enable template and sharing features.

### 11.2 Feature Flags

| Flag | Description | Default |
|---|---|---|
| `playbook_system_enabled` | Master toggle for entire playbook system | `true` in Phase 1+ |
| `custom_playbooks_enabled` | Allow custom playbook creation | `false` in Phase 1, `true` in Phase 2+ |
| `playbook_comparison_enabled` | Enable comparison view | `false` in Phase 1, `true` in Phase 2+ |
| `playbook_compliance_enabled` | Enable compliance tracking | `false` in Phase 1, `true` in Phase 2+ |
| `playbook_templates_enabled` | Enable templates | `false` in Phase 1-2, `true` in Phase 3+ |
| `playbook_sharing_enabled` | Enable team sharing | `false` in Phase 1-2, `true` in Phase 3+ |
| `tier_limits_enforced` | Enforce tier-based limits | `false` in Phase 1-2, `true` in Phase 3+ |

### 11.3 Rollback Procedures

- **Phase 1 rollback:** Disable `playbook_system_enabled` flag. Trades continue to be created without playbook assignment. Re-enable and backfill when issues are resolved.
- **Data rollback:** The playbook system only reads trades; it does not modify them. Dropping playbook tables has no impact on trade data. Metrics and equity curves can be fully regenerated from trade data.

### 11.4 Deployment Dependencies

- PostgreSQL/Supabase must be available with RLS support.
- User authentication system must be operational.
- Trade execution pipeline (PRD-003) must emit `trade.created` events.
- Billing system must expose tier information via API or JWT claims.

---

## 12. Open Questions & Assumptions

### 12.1 Assumptions

| # | Assumption |
|---|---|
| A1 | The `trades` table (PRD-003) exists and contains `user_id`, `pnl`, `r_multiple`, `entry_time`, `exit_time`, and trendline metadata fields. |
| A2 | The `users` table has a `tier` field or the tier is derivable from JWT claims. |
| A3 | The `organizations` and `org_members` tables exist for team sharing features (PRD-001). |
| A4 | Supabase RLS is the primary data isolation mechanism, supplemented by application-layer checks. |
| A5 | The trendline engine (PRD-002) attaches metadata directly to the trade record or a linked signal record. |
| A6 | The billing system (PRD-010) handles tier upgrade/downgrade events and the playbook system reads tier status reactively. |
| A7 | "Breakeven" trades (P&L exactly 0) are counted as neither wins nor losses. |

### 12.2 Items Requiring Clarification

| # | Question | Impact |
|---|---|---|
| Q1 | Should compliance checklist items support `value_ref` (referencing a playbook's risk override field, e.g., `max_risk_per_trade_pct`) or only literal values? The PRD example shows `value_ref` but the schema section does not define it. | Affects compliance auto-check implementation. Currently assuming literal values only. |
| Q2 | When a user downgrades from Pro to Trader (limit: 5 custom playbooks) and has 10 active custom playbooks, should the system auto-archive the excess or require user action? | Currently assuming: read-only access to all, user must manually archive excess to regain edit/create capability. |
| Q3 | Should the `test-classify` endpoint be available to Free-tier users for the default playbook rules, or strictly Trader+ only? | Currently specified as Trader+ only. |
| Q4 | For the statistical significance indicator in comparison view (chi-squared test), should p-value thresholds other than 95% be offered (e.g., 90%, 99%)? | Currently specified as 95% only. |
| Q5 | Should the bulk reclassification endpoint support a "dry run" mode that previews the changes without committing? | Not currently specified. Could reduce user errors on large bulk operations. |

### 12.3 Deferred Decisions

| # | Decision | Deferred To |
|---|---|---|
| D1 | Public playbook marketplace and cross-user discovery | Phase 4 |
| D2 | AI-suggested classification rule improvements | Phase 4 |
| D3 | Cross-user anonymized playbook benchmarking | Phase 4 |
| D4 | Playbook decay detection and alerting | Phase 4 |

---

## 13. Appendices

### 13.1 Glossary

| Term | Definition |
|---|---|
| **Playbook** | A named strategy container that groups trades by shared entry criteria for independent performance tracking. |
| **Auto-classification** | Rule-based assignment of a trade to a playbook using trendline engine metadata, without user intervention. |
| **R-multiple** | Trade P&L expressed as a multiple of initial risk. A +2R trade earned twice the amount risked. A -1R trade lost the full amount risked. |
| **Expectancy** | The average dollar amount (or R-multiple) expected to be won or lost per trade over a large sample. Positive expectancy indicates a profitable strategy. |
| **Profit Factor** | Ratio of gross profits to gross losses. Values above 1.0 indicate a profitable strategy. A value of 2.0 means the strategy earns $2 for every $1 lost. |
| **Sharpe Ratio** | Risk-adjusted return metric: excess return per unit of total volatility. Annualized by multiplying by sqrt(252 trading days). Values above 1.0 are generally considered good. |
| **Sortino Ratio** | Like Sharpe but penalizes only downside volatility, making it more suitable for asymmetric return distributions common in trading. |
| **Max Drawdown** | The largest peak-to-trough decline in a playbook's equity curve. Measured in both dollars and percentage. |
| **Compliance Score** | Percentage of checklist items satisfied for a trade within its assigned playbook (0-100%). Measures trader discipline. |
| **Safety Line** | The opposing trendline projected forward by 4 candles, used as stop-loss placement in the Tori Trades methodology. |
| **First-match-wins** | Classification semantics where the first playbook whose rules match a trade gets the assignment. No multi-playbook assignment. |
| **Tier-locked** | A playbook that exists in the user's account but is inaccessible due to subscription tier restrictions. Visible with an upgrade prompt. |

### 13.2 Related FSDs

| FSD | Title | Relationship |
|---|---|---|
| FSD-001 | System Architecture and Infrastructure | Foundation: database, auth, API framework |
| FSD-002 | Trendline Detection Engine | Upstream: provides metadata for auto-classification |
| FSD-003 | Trade Execution Pipeline | Upstream: creates trades; Downstream: consumes risk overrides |
| FSD-004 | Trade Journaling | Upstream: provides journal UI for manual assignment and compliance |
| FSD-006 | Performance Analytics | Downstream: consumes per-playbook metrics and equity curves |
| FSD-010 | Billing and Subscription Management | Upstream: tier limits for playbook features |

### 13.3 Default Color Palette

The following 8 colors are assigned sequentially to new custom playbooks (cycling back to the first after all 8 are used):

1. `#6366F1` (Indigo)
2. `#10B981` (Emerald)
3. `#F59E0B` (Amber)
4. `#EF4444` (Red)
5. `#8B5CF6` (Violet)
6. `#EC4899` (Pink)
7. `#14B8A6` (Teal)
8. `#F97316` (Orange)

### 13.4 Changelog

- 2026-02-11: Initial FSD created from PRD-005 v1.0 — Generated by Claude
