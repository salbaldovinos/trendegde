# FSD-009b: Feature Gating & Usage Tracking

**TrendEdge — AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-009b |
| Source | FSD-009 (Billing & Subscriptions) |
| Title | Feature Gating & Usage Tracking |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-12 |

**Sibling Sub-FSDs:**
- [FSD-009a: Stripe Integration & Subscription Lifecycle](/docs/fsd/FSD-009a-stripe-integration.md) — Stripe products/prices, checkout, portal, webhooks, subscription state machine, upgrade/downgrade/cancel/pause flows, dunning
- **FSD-009b: Feature Gating & Usage Tracking** (this document)
- [FSD-009c: Billing Admin & Revenue](/docs/fsd/FSD-009c-billing-admin.md) — Admin revenue dashboard, refund processing, coupon/promotion management, AI cost reporting

---

## 1. Introduction

### 1.1 Purpose

This document specifies the complete feature gating engine, feature flag registry, usage tracking system, AI cost metering, trial management, and graceful degradation behaviors for the TrendEdge platform. It defines exactly how subscription tier limits are enforced at every application boundary, how usage is counted and reset, and how users experience limits through clear, non-blocking messaging. A developer should be able to implement the entire feature gating and usage tracking system using only this document.

### 1.2 Scope

This FSD covers:

- Real-time tier checking middleware (FastAPI middleware, Redis-cached, PostgreSQL fallback)
- Feature flag registry: complete mapping of every gated feature to tier requirements
- Graceful degradation behaviors and exact user-facing messages for every limit
- Usage tracking system: counters, periods, resets, caching
- AI cost tracking and fair-use enforcement (Claude API metering)
- 14-day Pro trial: eligibility, lifecycle, notification schedule
- Tier hierarchy and comparison logic
- Frontend feature gate UI patterns (lock icons, usage counters, upgrade prompts)
- Cache invalidation strategy

This FSD does NOT cover:

- Stripe integration, checkout, webhooks, payment processing (see FSD-009a)
- Admin revenue dashboard, refund processing, coupon management (see FSD-009c)
- User authentication and JWT validation (see FSD-008)
- Individual feature implementations (see respective feature FSDs)

### 1.3 Architecture Context

| Layer | Technology | Role |
|---|---|---|
| Middleware | FastAPI (Python 3.12+) | Intercepts every protected request to check tier |
| Cache | Redis (Upstash) | Sub-50ms tier data lookups, usage counter caching |
| Database | PostgreSQL 16 (Supabase) | Source of truth for subscriptions, usage tracking |
| Configuration | YAML file | Feature flag registry (loaded into Redis on startup) |
| Task Queue | Celery | Monthly usage resets, async cache warming |
| Frontend | Next.js 14+ + TypeScript | Feature gate UI patterns, upgrade prompts |

### 1.4 Dependencies

| System | Reference | What This FSD Needs |
|---|---|---|
| Subscription State | FSD-009a | `subscriptions.tier`, `subscriptions.status`, `subscriptions.payment_status` — the current tier and status for each user |
| Authentication | FSD-008 | Authenticated `user_id` from JWT on every request |
| Redis Cache | FSD-009a | Cache invalidation events when tier changes (webhook-triggered) |
| Claude AI | FSD-006c, FSD-004 | AI feature invocations that need metering |

---

## 2. Tier Hierarchy & Structure

### 2.1 Tier Levels

| Tier | Level (Integer) | Monthly Price | Annual Price |
|---|---|---|---|
| Free | 0 | $0 | -- |
| Trader | 1 | $49 | $399/yr |
| Pro | 2 | $99 | $799/yr |
| Team | 3 | $199 | $1,899/yr |

The integer `tier_level` enables programmatic comparison: `user.tier_level >= required_tier_level`.

### 2.2 Capability Matrix

| Capability | Free | Trader ($49/mo) | Pro ($99/mo) | Team ($199/mo) |
|---|---|---|---|---|
| Trendline Detection | 3 instruments, delayed | 10 instruments, real-time | Unlimited, real-time | Unlimited + custom |
| Trade Execution | Paper only | 1 broker, 1 account | 3 brokers, 5 accounts | Unlimited accounts |
| Journaling | 10 trades/month | Unlimited | Unlimited + AI review | Unlimited + sharing |
| Playbooks | 1 default | 5 custom | Unlimited | Unlimited + templates |
| Analytics | 5 basic metrics | 25+ full dashboard | Advanced + Monte Carlo | Everything + team |
| Notifications | Email only | Telegram + Email | All channels | All + custom hooks |
| Support | Community | Email (48h) | Priority (24h) | Dedicated (4h) |

---

## 3. Real-Time Tier Checking Middleware (BL-FR-012)

### 3.1 Overview

FastAPI middleware executes on every request to a protected endpoint. It attaches the user's tier and feature limits to the request context so individual endpoints can make access decisions without redundant lookups.

### 3.2 Processing Flow

```
Incoming Request
    |
    v
Extract user_id from JWT (authenticated session)
    |
    v
Redis lookup: user:{user_id}:tier_features (TTL: 60s)
    |
    +-- Cache HIT --> Parse cached tier data
    |
    +-- Cache MISS --> Query PostgreSQL subscriptions table
    |                    |
    |                    v
    |                  Query feature flag registry for tier's limits
    |                    |
    |                    v
    |                  Cache in Redis with 60s TTL
    |
    +-- Redis UNAVAILABLE --> PostgreSQL direct query (~100ms)
    |
    v
Attach to request:
  - request.state.tier (string: "free"|"trader"|"pro"|"team")
  - request.state.tier_level (integer: 0|1|2|3)
  - request.state.tier_limits (dict of feature limits)
  - request.state.payment_status (string: "current"|"past_due"|"unpaid")
    |
    v
Continue to endpoint handler
```

### 3.3 Cached Tier Data Structure

Redis key: `user:{user_id}:tier_features`

```json
{
  "tier": "pro",
  "tier_level": 2,
  "status": "active",
  "payment_status": "current",
  "limits": {
    "trendline.detection": true,
    "trendline.realtime": true,
    "trendline.custom_params": false,
    "execution.live": true,
    "execution.paper": true,
    "execution.broker_count": 3,
    "execution.account_count": 5,
    "journal.monthly_limit": null,
    "journal.ai_review": true,
    "journal.sharing": false,
    "playbook.custom_count": null,
    "playbook.templates": false,
    "analytics.basic": true,
    "analytics.full_dashboard": true,
    "analytics.advanced": true,
    "analytics.monte_carlo": true,
    "analytics.team": false,
    "notifications.email": true,
    "notifications.telegram": true,
    "notifications.all_channels": true,
    "notifications.custom_hooks": false,
    "ai.conversational": true,
    "ai.trade_review": true,
    "support.priority": true,
    "support.dedicated": false
  }
}
```

TTL: 60 seconds.

### 3.4 Endpoint Decorators

**`@requires_tier(minimum="trader")`**
- Blocks the endpoint if the user's `tier_level` is below the specified minimum.
- Returns `403 Forbidden`.

**`@check_limit("instruments_count")`**
- Checks if the user has reached their tier limit for the specified metric.
- Reads current usage from the usage tracking system.
- Returns `429 Too Many Requests` if at or over the limit.

### 3.5 Access Denial Responses

**Tier Denial (403 Forbidden):**
```json
{
  "error": "tier_limit_exceeded",
  "message": "This feature requires the Pro plan or higher.",
  "current_tier": "trader",
  "required_tier": "pro",
  "upgrade_url": "/pricing?highlight=pro",
  "limit_detail": null
}
```

**Usage Limit Denial (429 Too Many Requests):**
```json
{
  "error": "usage_limit_exceeded",
  "message": "You're monitoring 10 of 10 instruments. Upgrade to Pro for unlimited.",
  "current_tier": "trader",
  "current_usage": 10,
  "tier_limit": 10,
  "upgrade_url": "/pricing?highlight=pro",
  "limit_detail": "instruments_count"
}
```

### 3.6 Cache Invalidation

- On any tier change (via webhook handler in FSD-009a), the Redis key `user:{user_id}:tier_features` is deleted immediately using `redis.delete()`.
- The next request from that user triggers a cache miss, reads fresh data from PostgreSQL, and re-caches.
- Cache is also warmed proactively on user login.

### 3.7 Failure Handling

| Scenario | Behavior |
|---|---|
| Redis available, cache hit | Serve from cache. <5ms p50. |
| Redis available, cache miss | Query PostgreSQL, cache result. <50ms p99. |
| Redis unavailable | Fall back to PostgreSQL directly. ~100ms. System continues functioning. |
| Both Redis and PostgreSQL unavailable | Log CRITICAL error. Return `503 Service Unavailable`: "Service temporarily unavailable. Please try again shortly." Do NOT default to granting or denying access. |

### 3.8 Performance Requirements

| Metric | Target |
|---|---|
| p50 latency (cache hit) | < 5ms |
| p95 latency (cache hit) | < 20ms |
| p99 latency (including cache miss + PG fallback) | < 50ms |
| Fallback p99 (Redis unavailable) | < 100ms |

**Constraints:**
- Feature gate checks MUST NOT make external API calls (e.g., to Stripe).
- Redis connection pooling with minimum 10 connections.
- No external service calls during gate evaluation.

---

## 4. Feature Flag Registry (BL-FR-013)

### 4.1 Complete Registry

The feature flag registry is the single source of truth for all feature access decisions. No endpoint should hardcode tier checks.

| Feature Key | Free | Trader | Pro | Team | Limit Type |
|---|---|---|---|---|---|
| `trendline.detection` | yes | yes | yes | yes | instrument_count |
| `trendline.realtime` | no | yes | yes | yes | boolean |
| `trendline.custom_params` | no | no | no | yes | boolean |
| `execution.live` | no | yes | yes | yes | boolean |
| `execution.paper` | yes | yes | yes | yes | boolean |
| `execution.broker_count` | 0 | 1 | 3 | unlimited | numeric |
| `execution.account_count` | 0 | 1 | 5 | unlimited | numeric |
| `journal.monthly_limit` | 10 | unlimited | unlimited | unlimited | numeric |
| `journal.ai_review` | no | no | yes | yes | boolean |
| `journal.sharing` | no | no | no | yes | boolean |
| `playbook.custom_count` | 0 | 5 | unlimited | unlimited | numeric |
| `playbook.templates` | no | no | no | yes | boolean |
| `analytics.basic` | yes | yes | yes | yes | boolean |
| `analytics.full_dashboard` | no | yes | yes | yes | boolean |
| `analytics.advanced` | no | no | yes | yes | boolean |
| `analytics.monte_carlo` | no | no | yes | yes | boolean |
| `analytics.team` | no | no | no | yes | boolean |
| `notifications.email` | yes | yes | yes | yes | boolean |
| `notifications.telegram` | no | yes | yes | yes | boolean |
| `notifications.all_channels` | no | no | yes | yes | boolean |
| `notifications.custom_hooks` | no | no | no | yes | boolean |
| `ai.conversational` | no | no | yes | yes | boolean |
| `ai.trade_review` | no | no | yes | yes | boolean |
| `support.priority` | no | no | yes | yes | boolean |
| `support.dedicated` | no | no | no | yes | boolean |

### 4.2 Storage & Loading

- Stored as a YAML configuration file in the application repository.
- Loaded into Redis on application startup.
- NOT runtime-editable. Changes require a deployment.
- This prevents accidental tier permission changes in production.

### 4.3 Lookup Functions

**`has_feature(user_id: str, feature_key: str) -> bool`**
- Returns `true` if the user's tier grants access to the boolean feature.
- For numeric features, returns `true` if the limit is greater than 0 or unlimited (`None`).

**`get_limit(user_id: str, feature_key: str) -> int | None`**
- Returns the numeric limit for the user's tier.
- Returns `None` for unlimited.
- Returns `0` for features the tier does not have access to.

### 4.4 Business Rules

- `"unlimited"` is represented internally as `None` (null) and means no enforcement.
- The registry is the single source of truth. No endpoint should hardcode tier checks.
- Configuration changes require a deployment to prevent accidental tier changes.

---

## 5. Graceful Degradation (BL-FR-014)

### 5.1 Design Principles

1. **NEVER interrupt an active trade** due to a tier limit. If a trade is in progress, it completes regardless of tier status.
2. **NEVER silently fail.** Every limit-reached scenario shows a clear, specific message.
3. **Upgrade CTAs** link to `/pricing?highlight={recommended_tier}` with the recommended tier pre-highlighted.
4. **Usage counters** are visible in the UI wherever limits apply: "3/10 instruments used", "8/10 journal entries this month".

### 5.2 Degradation Behaviors by Feature

| Feature | At-Limit Behavior | Exact User Message |
|---|---|---|
| Instruments (Free: 3) | Cannot add new instrument. Existing instruments continue monitoring. Inline upgrade prompt. | "You're monitoring 3 of 3 instruments. Upgrade to Trader for up to 10." |
| Instruments (Trader: 10) | Same pattern. | "You're monitoring 10 of 10 instruments. Upgrade to Pro for unlimited." |
| Journal trades (Free: 10/mo) | Trade still executes (paper mode). Journal entry is created but marked as `"over_limit": true`. Entry is visible but read-only until upgrade or next month. | "You've reached 10 journal entries this month. Upgrade to Trader for unlimited journaling, or wait until {first_day_next_month}." |
| Playbooks (Trader: 5) | Cannot create new playbook. Existing playbooks continue to function. | "You have 5 of 5 custom playbooks. Upgrade to Pro for unlimited playbooks." |
| Broker connections (Trader: 1) | Cannot add new broker. Existing connection continues working. | "You're using 1 of 1 broker connection. Upgrade to Pro to connect up to 3 brokers." |
| Accounts (Trader: 1) | Cannot add new account. Existing account continues working. | "You're using 1 of 1 trading account. Upgrade to Pro for up to 5 accounts." |
| AI features (Free/Trader) | Feature button/section visible but disabled with lock icon and upgrade CTA. | "AI Trade Review is available on Pro and above. Upgrade to unlock AI-powered insights." |
| AI budget exhausted (Pro/Team) | AI features disabled for remainder of month. | "You've used your AI budget for this month. Resets on {first_day_next_month}." |
| Analytics (Free: basic only) | Advanced widgets locked with blur + overlay. | "Upgrade to Trader to unlock [widget name]." |
| Analytics (Trader: no Monte Carlo) | Monte Carlo locked with blur + overlay. | "Monte Carlo simulation is available on Pro and above." |
| Dashboard customization (Free) | Drag-and-drop and presets disabled. | "Dashboard customization is available on Trader and above." |
| Dashboard presets (Trader: max 5) | Cannot save beyond 5. | "Maximum 5 layout presets reached. Delete an existing preset to save a new one." |
| PDF export (Free: locked) | Button disabled with lock. | "PDF export is available on Trader and above." |
| PDF export (Trader: 2/month) | After 2 exports, button disabled. | "You've used 2 of 2 PDF exports this month. Upgrade to Pro for unlimited exports. Your limit resets on {billing_cycle_date}." |
| Notifications (Free: email only) | Telegram setup section shows lock. | "Telegram notifications are available on Trader and above." |
| Team features (non-Team) | Team dashboard section locked. | "Team analytics requires the Team plan." |

### 5.3 Downgrade Data Handling

When a user downgrades, existing data is preserved but creation of new resources may be blocked:

| Data Type | Behavior |
|---|---|
| Historical trade data | Never deleted. Fully accessible read-only. |
| Journal entries | Never deleted. Existing entries remain readable. New entries subject to new tier limits. |
| Analytics history | Never deleted. Historical analytics viewable. New analytics limited to new tier capabilities. |
| Excess playbooks (e.g., user has 8, new limit is 5) | All 8 remain visible and functional. User cannot create new playbooks until count is at or below 5. |
| Excess broker connections (e.g., user has 3, new limit is 1) | All 3 connections preserved. User cannot add new connections. Orders from connections beyond the limit are rejected: "This broker connection exceeds your Trader plan limit. Upgrade to Pro to use additional broker connections." |
| Excess instruments (e.g., unlimited -> 10) | The 10 most recently active instruments continue monitoring. Others paused: "Instrument monitoring paused — you are at your plan limit of 10 instruments." |
| AI-generated trade reviews | Previously generated reviews remain accessible in the journal. New requests gated: "AI Trade Review is available on Pro and above." |

### 5.4 Past-Due Payment Impact

When `payment_status = "past_due"` for 7+ days:

- User's features are restricted to Free tier limits.
- The `tier` field in the subscription is NOT changed (preserved for restoration on payment recovery).
- The middleware uses `payment_status` to override tier limits when `dunning_step >= 4`.
- Message: "Your account has been restricted to Free tier access due to a payment issue. Update your payment method to restore full access."

---

## 6. Usage Tracking System (BL-FR-015)

### 6.1 Database Schema

**`usage_tracking` Table:**

| Column | Type | Constraints | Description |
|---|---|---|---|
| id | bigint | PK, AUTO_INCREMENT | Primary key |
| user_id | uuid | FK to users, NOT NULL | User identifier |
| metric_key | varchar(50) | NOT NULL | e.g., `journal_entries`, `ai_invocations` |
| period_start | date | NOT NULL | First day of the tracking period |
| period_end | date | NOT NULL | Last day of the tracking period |
| current_value | integer | NOT NULL, DEFAULT 0 | Current count for this period |
| limit_value | integer | NULLABLE | Tier limit (null = unlimited) |
| created_at | timestamptz | NOT NULL, DEFAULT now() | Record creation |
| updated_at | timestamptz | NOT NULL, DEFAULT now() | Last update |

**Unique constraint:** `(user_id, metric_key, period_start)`

**Indexes:**
- Primary key on `id`
- Unique on `(user_id, metric_key, period_start)`
- Index on `user_id` for user-level queries

### 6.2 Tracked Metrics

| Metric Key | Tracked Per | Reset Cycle | Notes |
|---|---|---|---|
| `journal_entries` | user, month | Monthly (calendar month) | Count of journal entries created |
| `active_instruments` | user | None (running count) | Currently monitored instruments |
| `active_broker_connections` | user | None (running count) | Currently connected brokers |
| `active_accounts` | user, broker | None (running count) | Accounts per broker connection |
| `custom_playbooks` | user | None (running count) | Custom playbooks created |
| `ai_invocations` | user, month | Monthly | AI feature calls (all types combined) |
| `ai_tokens_consumed` | user, month | Monthly | Claude API tokens used |
| `pdf_exports` | user, billing cycle | Billing cycle | PDF exports generated |

### 6.3 Processing Logic

**Increment:**
```sql
UPDATE usage_tracking
SET current_value = current_value + 1, updated_at = now()
WHERE user_id = :uid
  AND metric_key = :key
  AND period_start = :period;
```
- Atomic SQL operation to prevent race conditions.

**Check Before Action:**
1. Read current usage from Redis cache key `user:{user_id}:usage:{metric_key}:{period}` (TTL: 60s).
2. On cache miss, read from PostgreSQL and populate cache.
3. If `current_value >= limit_value` (and `limit_value` is not null), deny the action with the appropriate degradation message (Section 5.2).

**Cache Invalidation:**
- On every usage increment, delete the Redis cache key for that metric.
- Next check triggers a fresh read from PostgreSQL.

### 6.4 Monthly Reset

- A scheduled Celery job runs on the 1st of each month at 00:00 UTC.
- Creates new `usage_tracking` records for the new period for all active users.
- Previous period records are retained for analytics.
- Retry: 3 times at 5-minute intervals on failure. Alert on persistent failure.

### 6.5 Data Retention

- Usage records retained for 12 months for analytics.
- After 12 months, records are aggregated into monthly summaries and raw records are deleted.
- Archival runs monthly on the 1st at 01:00 UTC.

### 6.6 Usage API Endpoint

**`GET /api/billing/usage`**

Authentication: Required.
Rate Limit: 60/min/user.

**Response (200 OK):**
```json
{
  "period": "2026-03",
  "metrics": {
    "journal_entries": { "used": 42, "limit": null, "display": "42 (unlimited)" },
    "active_instruments": { "used": 8, "limit": null, "display": "8 (unlimited)" },
    "active_broker_connections": { "used": 2, "limit": 3, "display": "2 / 3" },
    "active_accounts": { "used": 3, "limit": 5, "display": "3 / 5" },
    "custom_playbooks": { "used": 4, "limit": null, "display": "4 (unlimited)" },
    "ai_invocations": { "used": 67, "limit": 100, "display": "67 / 100" },
    "ai_tokens_consumed": { "used": 312000, "limit": 500000, "display": "312K / 500K" },
    "pdf_exports": { "used": 1, "limit": null, "display": "1 (unlimited)" }
  }
}
```

---

## 7. AI Cost Tracking (BL-FR-022)

### 7.1 Database Schema

**`ai_usage_log` Table:**

| Column | Type | Constraints | Description |
|---|---|---|---|
| id | bigint | PK, AUTO_INCREMENT | Primary key |
| user_id | uuid | FK to users, NOT NULL | User identifier |
| feature_key | varchar(50) | NOT NULL | `conversational_analytics`, `trade_review`, `journal_review` |
| model | varchar(50) | NOT NULL | e.g., `claude-sonnet-4-20250514` |
| input_tokens | integer | NOT NULL | Tokens in the prompt |
| output_tokens | integer | NOT NULL | Tokens in the response |
| estimated_cost_usd | decimal(10,6) | NOT NULL | Estimated cost |
| created_at | timestamptz | NOT NULL, DEFAULT now() | Timestamp |

**Indexes:**
- Primary key on `id`
- Index on `(user_id, created_at)` for per-user queries
- Index on `(feature_key, created_at)` for per-feature reports

### 7.2 Fair Use Limits (Soft Caps)

| Tier | Monthly AI Calls | Monthly Token Budget |
|---|---|---|
| Free | 0 | 0 |
| Trader | 0 | 0 |
| Pro | 100 | 500,000 |
| Team | 500 | 2,500,000 |

### 7.3 Enforcement Flow

1. **Before every Claude API call:** Check the user's monthly AI usage (calls and tokens) against their tier limit.
2. **At 80% of budget:** Show UI warning (non-blocking): "You've used 80% of your AI budget for this month ({used}/{limit} calls). Resets on {first_day_next_month}."
3. **At 100% of budget:** Block the AI call with message: "You've used your AI budget for this month. Resets on {first_day_next_month}." No overage charges at launch.
4. **After every Claude API call:** Log the usage in `ai_usage_log`.
5. **Increment** the `ai_invocations` and `ai_tokens_consumed` metrics in `usage_tracking`.

### 7.4 Cost Estimation

Estimated cost is calculated per call using the model's pricing:
- Input tokens: price per 1K tokens (varies by model)
- Output tokens: price per 1K tokens (varies by model)
- `estimated_cost_usd = (input_tokens * input_price_per_1k / 1000) + (output_tokens * output_price_per_1k / 1000)`

Model pricing is stored in environment configuration, not hardcoded.

### 7.5 Admin Visibility

AI usage cost data is exposed to admins via FSD-009c. Key metrics:
- Total Claude API costs (monthly, cumulative)
- Cost per user (average, outliers)
- Cost by feature (conversational analytics vs. trade review vs. journal review)
- Margin impact analysis

---

## 8. 14-Day Pro Trial (BL-FR-023)

### 8.1 Eligibility

- User's `has_used_trial` must be `false`.
- User must not have ever had a paid subscription.
- One trial per account, enforced by the `has_used_trial` boolean on the `subscriptions` table.

### 8.2 Trial Flow

1. User selects "Start Free Trial" on the Pro plan (pricing page or feature gate prompt).
2. System checks `has_used_trial`. If `true`: return `400 Bad Request` with message: "You've already used your free trial. Subscribe to Pro for $99/month."
3. System creates a Stripe Checkout Session with `subscription_data.trial_period_days: 14` (handled by FSD-009a checkout flow).
4. User enters payment method on Stripe Checkout (required for trial).
5. On `checkout.session.completed` webhook (FSD-009a):
   - Set `status = "trialing"`, `tier = "pro"`.
   - Set `trial_start` and `trial_end` dates.
   - Set `has_used_trial = true`.
   - Send `welcome_trial` email.
6. During trial: full Pro tier access (same as paid Pro, including AI features with Pro-level limits).

### 8.3 Trial Conversion

**Day 14 — trial ends:**
- If payment method valid: Stripe charges $99.00. `customer.subscription.updated` webhook fires with status `active`. Send `trial_converted` email.
- If payment fails: subscription enters dunning flow (FSD-009a BL-FR-020).

**If user cancels during trial:**
- Access remains Pro until trial end date.
- No charge is made.
- After trial end: `customer.subscription.deleted` webhook fires. User reverts to Free. Send `trial_expired` email.

### 8.4 Trial Notification Schedule

| Timing | Email Template | Key Content |
|---|---|---|
| Trial start | `welcome_trial` | "Welcome to your 14-day Pro trial! Here's what you can do: [feature list]. Your trial ends on {trial_end_date}." |
| Day 7 | `trial_midpoint` | "You're halfway through your Pro trial. Here's what you've accomplished: {usage_summary}." |
| Day 11 (3 days before end) | `trial_ending` | "Your Pro trial ends in 3 days on {trial_end_date}. Your card ending in {last4} will be charged $99/mo. Cancel anytime before {trial_end_date}." |
| Trial auto-converts | `trial_converted` | "Your trial has ended. Welcome to TrendEdge Pro! You've been charged $99.00." |
| Trial cancelled/expired | `trial_expired` | "Your Pro trial has ended. You're now on the Free plan. Upgrade anytime to get Pro features back." |

### 8.5 Trial Edge Cases

| Scenario | Behavior |
|---|---|
| User cancels trial on day 1 | Retains Pro access for remaining 13 days. No charge. Reverts to Free at trial end. |
| User upgrades from trial Pro to Team | Trial ends immediately. User is charged for Team. `has_used_trial` remains `true`. |
| Previously cancelled paid user starts trial | Not eligible. `has_used_trial` check prevents trial if they ever had paid subscription. |
| Second account with same email | Each account is independent. Trial eligibility is per `user_id`, not per email. |

---

## 9. Frontend Feature Gate UI Patterns

### 9.1 Lock Icon Pattern

For features the user does not have access to:
- Feature is visible in the UI navigation/menu.
- A small lock icon appears next to the feature name.
- Clicking the feature shows a modal: "{Feature Name} is available on {required_tier} and above. [View Plans]"
- "View Plans" links to `/pricing?highlight={required_tier}`.

### 9.2 Blurred Widget Pattern

For analytics and dashboard widgets on Free tier:
- Widget shows a blurred screenshot (CSS `filter: blur(8px)`) of what the widget looks like with data.
- Centered overlay with lock icon and button: "Upgrade to Trader to unlock [widget name]".
- Button links to `/pricing?highlight=trader`.

### 9.3 Usage Counter Pattern

For features with numeric limits:
- Progress bar showing usage: "3/10 instruments used" with bar at 30%.
- At 80%+ usage: bar turns yellow/warning color.
- At 100% usage: bar turns red, "Upgrade" link appears inline.

### 9.4 Inline Upgrade Prompt Pattern

When a user hits a limit during a workflow:
- Non-blocking toast/banner at the top of the relevant section.
- Message includes the specific limit, what the user needs, and a CTA.
- Example: "You've reached your instrument limit. [Upgrade to Pro] for unlimited instruments."
- Toast auto-dismisses after 10 seconds or on user action.

### 9.5 Disabled Button Pattern

For specific actions beyond the user's tier:
- Button is rendered but visually disabled (gray, reduced opacity).
- Hover tooltip: "Available on {required_tier} plan. Upgrade to unlock."
- Click shows the lock icon modal (9.1).

---

## 10. Redis Cache Schema

| Key Pattern | Value | TTL | Invalidation |
|---|---|---|---|
| `user:{user_id}:tier_features` | JSON: `{ "tier": "pro", "status": "active", "payment_status": "current", "limits": { ... } }` | 60 seconds | On webhook tier change; on user login (warmed) |
| `user:{user_id}:usage:{metric_key}:{period}` | Integer: current usage count | 60 seconds | On every usage increment |
| `feature_registry:v{version}` | JSON: complete feature flag registry | Until deployment | On application startup |

---

## 11. API Endpoints

### 11.1 Feature Gating Middleware

Not an explicit endpoint — the middleware runs on all protected endpoints automatically.

### 11.2 Usage Endpoints

| Method | Path | Auth | Rate Limit | Description |
|---|---|---|---|---|
| GET | `/api/billing/usage` | Required | 60/min/user | Get current usage metrics |
| GET | `/api/billing/subscription` | Required | 60/min/user | Get current subscription details (includes tier) |

### 11.3 Trial Endpoint

| Method | Path | Auth | Rate Limit | Description |
|---|---|---|---|---|
| POST | `/api/billing/checkout` | Required | 10/min/user | Create checkout session (with trial if eligible) — see FSD-009a |

Trial eligibility is checked within the checkout flow (FSD-009a). The `has_used_trial` flag determines whether the checkout session includes `trial_period_days`.

### 11.4 Common Error Responses

| Status | Error Code | Message Pattern |
|---|---|---|
| 403 | `tier_limit_exceeded` | "This feature requires the {tier} plan or higher." |
| 429 | `usage_limit_exceeded` | "You're using {used} of {limit} {resource}. Upgrade to {next_tier} for {benefit}." |
| 400 | `trial_already_used` | "You've already used your free trial. Subscribe to Pro for $99/month." |
| 503 | `service_unavailable` | "Service temporarily unavailable. Please try again shortly." |

---

## 12. Scheduled Jobs

| Job | Schedule | Purpose | Failure Behavior |
|---|---|---|---|
| Monthly usage reset | 1st of month, 00:00 UTC | Create new `usage_tracking` records for new period | Retry 3x at 5-min intervals. Alert on failure. |
| Usage data archival | Monthly, 1st at 01:00 UTC | Aggregate and archive usage records older than 12 months | Retry next month. Non-critical. |
| Cache warming (login) | On user login | Proactively populate `user:{user_id}:tier_features` in Redis | Non-critical — cache populates on first request if warming fails. |
| Feature registry reload | On deployment | Reload YAML registry into Redis | CRITICAL — application should not start if registry fails to load. |

---

## 13. Test Scenarios

### 13.1 Feature Gating Tests (BL-TEST-004)

For each of the 25+ feature keys in the registry, verify correct access for every tier.

**Parameterized test matrix:** For each `(feature_key, tier)` combination:
1. Set user's subscription tier to the test tier.
2. Call `has_feature(user_id, feature_key)`.
3. Assert the result matches the expected value from the registry.
4. For numeric limits: call `get_limit(user_id, feature_key)` and assert the correct limit value.

**Total test cases:** approximately 100 (25 features x 4 tiers).

### 13.2 Feature Gate Timing Tests

| Test ID | Scenario | Expected Result |
|---|---|---|
| FG-001 | Feature access changes on upgrade | Access granted within 5 seconds of webhook processing |
| FG-002 | Feature access changes at period end on downgrade | NOT before period end |
| FG-003 | Redis cache invalidation on tier change | Feature access updates within 60 seconds |
| FG-004 | Redis unavailable fallback | Correct access via PostgreSQL with acceptable latency increase |
| FG-005 | Both Redis and PG unavailable | 503 error, no default grant or deny |

### 13.3 Graceful Degradation Tests

| Test ID | Scenario | Expected Result |
|---|---|---|
| GD-001 | Free user adds 4th instrument | Blocked with message: "You're monitoring 3 of 3 instruments. Upgrade to Trader for up to 10." |
| GD-002 | Trader user adds 11th instrument | Blocked with correct message for Trader limit |
| GD-003 | Free user creates 11th journal entry | Entry created with `over_limit: true`, read-only, message shown |
| GD-004 | Trader user creates 6th playbook | Blocked with upgrade message |
| GD-005 | Free user clicks AI feature | Lock modal shown with upgrade CTA |
| GD-006 | Pro user at 100% AI budget | AI call blocked with reset date message |
| GD-007 | Pro user at 80% AI budget | Warning shown, call still allowed |
| GD-008 | Active trade during downgrade | Trade completes successfully regardless of tier change |
| GD-009 | Downgrade with excess playbooks | All existing playbooks accessible, new creation blocked |
| GD-010 | Downgrade with excess instruments | 10 most recent continue, others paused with message |

### 13.4 Usage Tracking Tests

| Test ID | Scenario | Expected Result |
|---|---|---|
| UT-001 | Concurrent usage increments | All increments recorded correctly (no lost updates) |
| UT-002 | Monthly reset | New period records created for all active users |
| UT-003 | Usage at exactly limit value | Action denied (at limit = at capacity) |
| UT-004 | Usage with unlimited limit (null) | Action always allowed regardless of count |
| UT-005 | Cache invalidation on increment | Next check reads fresh value from PostgreSQL |
| UT-006 | Usage API response accuracy | Matches actual database values |

### 13.5 Trial Tests

| Test ID | Scenario | Expected Result |
|---|---|---|
| TR-001 | Eligible user starts trial | `status="trialing"`, `tier="pro"`, `has_used_trial=true` |
| TR-002 | User with `has_used_trial=true` attempts trial | 400: "You've already used your free trial." |
| TR-003 | Trial user has full Pro features | All Pro features accessible during trial |
| TR-004 | Trial auto-converts on day 14 | Status changes to `active`, charge of $99.00 |
| TR-005 | Trial cancelled before day 14 | Pro access until trial end, then Free, no charge |
| TR-006 | Trial midpoint email (day 7) | Email sent with usage summary |
| TR-007 | Trial ending email (day 11) | Email sent with charge warning and last4 |
| TR-008 | Trial payment fails on conversion | Dunning flow initiated |

### 13.6 AI Cost Tracking Tests

| Test ID | Scenario | Expected Result |
|---|---|---|
| AI-001 | AI call logged correctly | `ai_usage_log` entry with correct tokens, cost, model |
| AI-002 | Usage counter incremented | `ai_invocations` and `ai_tokens_consumed` updated |
| AI-003 | Budget enforcement at limit | 100th call (Pro) succeeds, 101st blocked |
| AI-004 | Token budget enforcement | Call exceeding token budget blocked |
| AI-005 | 80% warning trigger | Warning shown at 80 of 100 calls |
| AI-006 | Monthly reset | AI counters reset to 0 on new month |

### 13.7 Load Tests (BL-TEST-008 subset)

| Test ID | Scenario | Target | Pass Criteria |
|---|---|---|---|
| LT-001 | Feature gate checks under load | 1,000 concurrent users | p99 < 50ms, zero errors |
| LT-002 | Usage tracking under contention | 100 concurrent increments | All recorded correctly, p99 < 10ms |

---

## 14. Open Questions

| # | Question | Impact | Status |
|---|---|---|---|
| OQ-001 | For Team plan downgrades, should we allow the user to choose which broker connections to keep, or automatically keep the most recently used ones? | Affects downgrade UX. | Assumed: automatically keep most recently active. Open for UX review. |
| OQ-002 | What is the exact behavior when a user in dunning (access restricted) attempts to upgrade? Should they be required to resolve the failed payment first? | Edge case in upgrade flow. | Assumed: user must resolve payment before plan changes. |
| OQ-003 | What happens to a Trader user's 6+ saved layout presets if they were on Pro and downgraded? | Options: delete excess, keep but prevent new saves, lock access to presets 6+. | Open — also tracked in FSD-006b. |

---

## 15. Assumptions

| # | Assumption | Rationale |
|---|---|---|
| A-001 | The feature flag registry is static (requires deployment to change). Not runtime-editable. | Prevents accidental tier permission changes in production. |
| A-002 | One subscription per user. Users cannot have multiple active subscriptions simultaneously. | Simplifies data model and feature gating logic. |
| A-003 | The Supabase Auth JWT includes the user's subscription tier as a claim (`user_metadata.subscription_tier`). | Allows client-side tier gating without additional database lookups. However, the middleware always validates against the authoritative Redis/PostgreSQL source. |
| A-004 | AI overage charges are not implemented at launch. Users are hard-blocked at their AI budget limit. | Simplifies billing. Overage billing can be added in a future phase. |
| A-005 | `"unlimited"` is represented as `None` (null) in both the feature registry and usage tracking `limit_value` column. | Consistent representation across the system. |
| A-006 | The middleware attaches tier data to `request.state` so all downstream code can access it without additional lookups. | Standard FastAPI pattern for per-request context. |
| A-007 | Free tier users who hit limits are never blocked from accessing existing data — only from creating new resources beyond limits. | Core UX principle: never punish users for having data. |
