# FSD-011c: Execution & Journal Views

**TrendEdge -- AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-011c |
| Source | FSD-011 (Frontend Dashboard & UI/UX) |
| Title | Execution & Journal Views |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-11 |

---

## 1. Introduction

### 1.1 Purpose

This sub-FSD specifies the frontend views and interactions for trade execution and trade journaling within the TrendEdge dashboard. It covers the Execution page (active positions table, pending signals queue, manual trade entry form, broker connection status, Paper/Live mode toggle) and the Journal page (trade table, trade detail view, journal enrichment form, screenshot upload, search and filters).

### 1.2 Scope

This document covers:

- **Execution Page** (`/execution`): Active positions table with real-time updates, pending signals queue with execute/reject/modify actions, manual trade entry form with inline validation and calculated fields, broker connection status indicator, and Paper/Live mode toggle dialog.
- **Journal Page** (`/journal`): Sortable/filterable/paginated trade table, trade detail view with mini chart and auto-captured data, journal enrichment form with auto-save, screenshot upload via drag-and-drop and clipboard paste, and full-text search with advanced filters.
- **Client-Side Data Models**: TypeScript interfaces for Trade, Position, Signal, and Screenshot.
- **API Endpoints**: BFF routes consumed by these views.
- **Real-Time Integration**: WebSocket channels for position updates, fill events, and signal notifications.
- **Testing Specifications**: Unit tests, E2E journeys, and visual regression for these views.

### 1.3 Out of Scope

- Application shell, sidebar navigation, header bar, breadcrumbs [see FSD-011a]
- Dashboard home page widgets, trendline detection page [see FSD-011b]
- Analytics dashboard, playbook management [see FSD-011d]
- Settings pages, onboarding wizard, AI chat, landing page [see FSD-011e]
- Trade execution engine internals, broker adapter logic [see FSD-003c, FSD-003d]
- Trade journaling backend logic, auto-capture [see FSD-006]
- Design system tokens (colors, typography, spacing, motion) [see FSD-011a]

### 1.4 Tech Stack (Relevant Subset)

| Layer | Technology | Version |
|---|---|---|
| Framework | Next.js (App Router) | 14+ |
| Language | TypeScript | 5.3+ |
| Styling | Tailwind CSS | 3.4+ |
| Component Library | shadcn/ui | Latest |
| Charting (Mini Chart) | TradingView Lightweight Charts | 4.x |
| State Management | Zustand | 4.x |
| Data Fetching | TanStack Query (React Query) | 5.x |
| Forms | React Hook Form + Zod | Latest |
| Real-time | WebSocket (native) + Supabase Realtime | N/A |
| File Upload | react-dropzone | Latest |
| Icons | Lucide React | Latest |

---

## 2. Functional Specifications: Execution Page

**Route**: `/execution`

### 2.1 Active Positions Table (FE-FR-019)

**Description**: A full data table of all currently open positions with real-time price and P&L updates.

**Columns**:

| Column | Description | Sortable | Format |
|---|---|---|---|
| Instrument | Contract symbol | Yes | "MES Mar 26" |
| Direction | Long/Short | Yes | Green chip "Long" / Red chip "Short" |
| Contracts | Position size | Yes | Integer, `font-mono` |
| Entry Price | Fill price | Yes | Decimal, `font-mono` |
| Current Price | Live price | No | Decimal, `font-mono`, WebSocket updated |
| Stop Loss | Stop price | No | Decimal, `font-mono` |
| Take Profit | Target price | No | Decimal, `font-mono` |
| Unrealized P&L | Dollar amount | Yes | `font-mono`, `--profit` or `--loss` color |
| R-Multiple | Current R | Yes | "1.5R" or "-0.3R", `font-mono` |
| Duration | Time since entry | Yes | "2h 15m" or "1d 4h" |
| MAE/MFE | Max adverse/favorable excursion | No | "MAE: 8t / MFE: 24t" (`font-mono`) |

**Default Sort**: By entry time, newest first.

**Real-Time Updates**: Current Price, Unrealized P&L, R-Multiple, and MAE/MFE update via WebSocket on the `positions` channel at 1 Hz during market hours. Value change animation: 300ms background flash (green for favorable change, red for adverse change).

**Row Expand**: Clicking a row expands an inline detail view below the row showing:
- Entry signal source (e.g., "Trendline Engine", "Manual")
- Trendline reference link (if applicable, clickable to `/trendlines?trendline=[id]`)
- Bracket order details: stop order ID, target order ID, order statuses
- Slippage: entry slippage in ticks

**Row Context Menu** (right-click or three-dot icon button at row end):

- **"Close Position"**: Opens a confirmation dialog: "Close [Contracts] [Instrument] [Direction] at market?" with "Close" (destructive variant) and "Cancel" buttons. On confirm: sends `POST /api/positions/{id}/close`. Toast on success: "Position closed. P&L: [amount]". Toast on error: "Failed to close position. [error message]".
- **"Modify Stop"**: Opens an inline edit for the Stop Loss field. Validation: new stop must be valid (below entry for long, above for short). On save: `PATCH /api/positions/{id}` with new stop. Toast on success: "Stop updated to [price]". Toast on error: "Failed to update stop."
- **"Modify Target"**: Same pattern as Modify Stop for the Take Profit field.
- **"Flatten All"**: Closes all open positions. Confirmation dialog: "Close ALL [n] open positions at market? This cannot be undone." On confirm: sends close requests for all positions. Toast: "All positions closed."

**Footer Row**: Sticky bottom row showing totals: Total Unrealized P&L (sum), Total Contracts (sum), Total Open Risk (sum of stop distances in dollars).

**States**:

| State | Display |
|---|---|
| Loading | 3-row skeleton table with shimmer |
| Success | Populated table |
| Empty | "No open positions" centered in table area |
| Error | "Unable to fetch positions. Check broker connection." with "Retry" button |

**Edge Cases**:
- If WebSocket is disconnected, current prices show the last known value with a "stale" indicator (yellow clock icon) and the timestamp of the last update.
- All positions fit without pagination (expected max 5-10 concurrent positions).

---

### 2.2 Pending Signals Queue (FE-FR-020)

**Description**: A section below the positions table showing trade signals awaiting user action.

**Layout**: Card-based layout. Each signal is a distinct card. Cards stack vertically.

**Each Signal Card**:

| Element | Format |
|---|---|
| Source badge | "Trendline Engine" (blue), "TradingView" (purple), "Manual" (gray) |
| Instrument + Direction | Bold text + colored chip |
| Entry Price | `font-mono` decimal |
| Stop Price | `font-mono` decimal, with stop distance in ticks |
| Target Price | `font-mono` decimal, with target distance in ticks |
| Planned R:R | "R:R 2.5:1" |
| Signal Strength / Grade | Grade badge (A+/A/B) if trendline-sourced |
| Age | Relative time since generation: "30s ago", "2m ago" |

**Action Buttons Per Signal**:

1. **"Execute"** (primary button):
   - Click opens a confirmation dialog with full order summary:
     - Instrument, Direction, Contracts, Entry Price, Stop, Target, R:R, Total Risk ($), % of Equity at Risk.
     - If Live mode: bold red warning text: "This will execute a LIVE order with real funds."
     - If Paper mode: blue info text: "This is a paper trade."
   - "Confirm Execute" button (primary in paper mode, destructive variant in live mode).
   - "Cancel" button.
   - On confirm: `POST /api/orders/execute` with signal data. Toast on success: "Order placed. [Instrument] [Direction] [Contracts] contracts." Toast on error: "Order failed: [error message]."

2. **"Reject"** (secondary button):
   - Click opens a small popover with reason dropdown: "Not my setup", "Risk too high", "Already positioned", "Market conditions changed", "Other".
   - "Confirm Reject" button. On confirm: `PATCH /api/signals/{id}` with `status: "rejected"`, `reason: [selected]`. Signal card fades out (200ms). Toast: "Signal rejected."

3. **"Modify"** (icon button, Pencil icon):
   - Opens an inline form within the card allowing the user to adjust entry price, stop price, and target price before execution.
   - Calculated fields (R:R, risk amount) update in real-time as values change.
   - "Save & Execute" button replaces the normal Execute flow.

**Auto-Execution Indicator**: If auto-execution is enabled for this signal type (user setting), the card displays:
- "Auto" badge (green, top-right corner).
- Countdown timer: "Auto-executing in [seconds]s" counting down from the configured delay (default 60s).
- "Cancel Auto" button to prevent auto-execution and keep the signal in pending state.

**States**:

| State | Display |
|---|---|
| Loading | 2 card skeletons |
| Success | Signal cards |
| Empty | "No pending signals. Signals from trendline detection and TradingView webhooks will appear here." |
| Error | "Unable to load signals. Retry." |

---

### 2.3 Manual Trade Entry Form (FE-FR-021)

**Description**: A form for manually entering trades, accessible via "Add Trade" button in the execution page header or from the pending signals section.

**Form Fields**:

| Field | Type | Required | Default | Validation |
|---|---|---|---|---|
| Instrument | Searchable dropdown | Yes | User's default | Must be a supported instrument |
| Direction | Toggle: Long / Short | Yes | Long | -- |
| Entry Price | Number input | Yes | -- | Positive number, validated to instrument tick size |
| Contracts | Number input | Yes | 1 | Integer, range 1-100 |
| Stop Loss | Number input | Yes | -- | Positive. Long: must be < entry. Short: must be > entry. |
| Take Profit | Number input | No | -- | Positive. Long: must be > entry. Short: must be < entry. |
| Order Type | Dropdown | Yes | Market | Options: Market, Limit |
| Signal Source | Dropdown | Yes | Manual | Options: Manual, TradingView, Other |
| Playbook | Dropdown | No | None | User's playbooks list |
| Notes | Textarea | No | Empty | Max 500 characters, character count shown |

**Validation Error Messages**:

| Condition | Error Message |
|---|---|
| Instrument not selected | "Please select an instrument." |
| Entry Price empty | "Entry price is required." |
| Entry Price non-numeric | "Entry price must be a valid number." |
| Entry Price negative/zero | "Entry price must be greater than zero." |
| Contracts empty | "Number of contracts is required." |
| Contracts not integer | "Contracts must be a whole number." |
| Contracts < 1 or > 100 | "Contracts must be between 1 and 100." |
| Stop Loss empty | "Stop loss is required." |
| Stop Loss invalid for Long | "Stop loss must be below entry price for a long position." |
| Stop Loss invalid for Short | "Stop loss must be above entry price for a short position." |
| Take Profit invalid for Long | "Take profit must be above entry price for a long position." |
| Take Profit invalid for Short | "Take profit must be below entry price for a short position." |
| Notes > 500 chars | "Notes must be 500 characters or fewer." |

**Calculated Fields** (display-only, auto-computed as user fills the form):

| Field | Formula | Format |
|---|---|---|
| Risk per Contract | `|entry - stop| x tick_value` | Dollar, `font-mono` |
| Total Risk | `risk_per_contract x contracts` | Dollar, `font-mono` |
| R:R Ratio | `|entry - target| / |entry - stop|` (if target provided) | "2.5:1" |
| % of Equity at Risk | `total_risk / account_equity x 100` | "1.2%" |

**Risk Rule Violations**: If the entered values violate any configured risk management rule, a yellow warning banner appears below the calculated fields listing each violation. Example: "Warning: Total risk ($600) exceeds your max daily loss limit ($500)." The "Place Order" button remains enabled but the confirmation dialog will prominently display the violation.

**Submit Behavior**:
- "Place Order" button. Disabled until all required fields pass validation.
- **Paper mode**: Direct submission. No confirmation dialog. Toast on success: "Paper trade placed. [Instrument] [Direction] [Contracts] contracts at [price]."
- **Live mode**: Confirmation dialog opens. Content: Full order summary table + bold warning: "This will execute a LIVE order. Real funds will be used." + "Place Live Order" button (destructive variant) + "Cancel" button.
- On successful submission: Toast (success). Position appears in the Active Positions table. Form resets to defaults.
- On failure: Toast (error): "Order failed: [error message from API]." Form retains entered values for correction.

---

### 2.4 Broker Connection Status (FE-FR-022)

**Description**: A persistent status indicator in the Execution page header area.

**States**:

| State | Visual | Text | Action |
|---|---|---|---|
| Connected | Green dot (8px, filled) | "Connected to [Broker Name]" + last heartbeat (e.g., "Last ping: 5s ago") | None |
| Disconnected | Red dot (8px, filled) | "Disconnected from [Broker Name]" | "Reconnect" button |
| Connecting | Yellow dot (8px) with pulse animation | "Connecting..." | None (auto-connecting) |
| Error | Red dot (8px, filled) | Error message (e.g., "Authentication expired") | "Fix" button linking to `/settings/brokers` |
| No Broker | Gray dot (8px, filled) | "No broker connected" | "Connect Broker" button linking to `/settings/brokers` |

**Multiple Brokers**: If multiple brokers are configured, a dropdown lists each broker with its individual status.

**Auto-Reconnect**: When disconnected, the system attempts reconnection every 30 seconds. A countdown is displayed: "Reconnecting in [seconds]s..."

**WebSocket Dependency**: Broker status is received via WebSocket on the `account` channel. If the WebSocket itself is disconnected, the broker status shows "Unknown -- WebSocket disconnected" in yellow.

---

### 2.5 Paper/Live Mode Toggle (FE-FR-058)

**Description**: The dialog for switching between Paper and Live trading modes. Accessible via clicking the header mode indicator or a toggle on the Execution page.

**Toggle UI**: A switch control with "Paper" label on the left and "Live" label on the right. Current mode is visually highlighted.

**Paper to Live Transition** (high-friction by design):

1. User clicks the toggle or the header badge.
2. Confirmation dialog opens: Title: "Switch to Live Trading?"
3. Warning text (red background card): "Orders will be routed to your broker and executed with real funds. You are solely responsible for all trading decisions and outcomes."
4. Checkbox (unchecked by default): "I understand that live orders involve real financial risk."
5. "Switch to Live" button (destructive/red variant). **Disabled** until the checkbox is checked.
6. **60-day paper warning**: If the user has fewer than 60 days of paper trading, an additional yellow warning appears: "You have [X] days of paper trading. We recommend at least 60 days before going live." This is a recommendation, not a blocker.
7. On confirm: API call `POST /api/settings/trading-mode` with `mode: "live"`. On success: toast (warning type): "Switched to Live Trading. All orders will be executed with real funds." The header badge, top border, and all mode-dependent UI elements update. On failure: toast (error): "Failed to switch mode. Please try again."

**Live to Paper Transition** (low-friction):
1. User clicks the toggle or the header badge.
2. No confirmation dialog. The switch happens immediately.
3. API call `POST /api/settings/trading-mode` with `mode: "paper"`.
4. Toast (info): "Switched to Paper Trading."
5. All mode-dependent UI elements update.

**Safety Rules**:
- The mode must NEVER switch without the user explicitly triggering it.
- In Live mode, no action should auto-execute unless the user has both enabled auto-execution AND acknowledged the live mode confirmation.

---

## 3. Functional Specifications: Journal Page

**Route**: `/journal`

### 3.1 Trade Table (FE-FR-023)

**Description**: The primary view of the journal, a full-featured sortable, filterable, paginated data table of closed trades.

**Columns**:

| Column | Sortable | Filterable | Format |
|---|---|---|---|
| Date | Yes | Date range picker | "Jan 15, 2026 09:30" (`text-sm`) |
| Instrument | Yes | Multi-select dropdown | "MES" |
| Direction | Yes | Toggle filter (Long/Short/All) | Green "Long" / Red "Short" chip |
| Entry Price | Yes | -- | Decimal, `font-mono` |
| Exit Price | Yes | -- | Decimal, `font-mono` |
| P&L ($) | Yes | Range slider | Dollar, `font-mono`, colored |
| P&L (%) | Yes | -- | Percentage, `font-mono`, colored |
| R-Multiple | Yes | Range slider | "2.1R", `font-mono` |
| Playbook | Yes | Multi-select dropdown | Playbook name or "--" |
| Duration | Yes | -- | "2h 15m" |
| Grade | Yes | Multi-select (A+/A/B) | Grade badge |
| Conviction | Yes | Min star filter | Star rating (1-5 filled stars) |
| Tags | No | Tag multi-select | Comma-separated tag badges |

**Default Sort**: Date descending (newest first).

**Pagination**:
- Default: 25 rows per page.
- Page size selector: 10, 25, 50, 100.
- Navigation: First, Previous, page numbers (with ellipsis for large sets), Next, Last.
- Display: "Showing 1-25 of 147 trades" in `text-sm text-muted-foreground`.

**Row Styling**:
- Winning trades (P&L > 0): 2px left border in `--profit` green.
- Losing trades (P&L < 0): 2px left border in `--loss` red.
- Breakeven (within 0.1R of zero): 2px left border in `--breakeven` gray.
- Rows alternate between `--background` and `--card` background for readability.

**Row Click**: Clicking a row navigates to the trade detail view (`/journal/trade/[id]`).

**Bulk Actions**: Checkbox column on the far left. Selecting one or more rows reveals a floating action bar at the bottom:
- **"Add to Playbook"** (dropdown of playbooks): Assigns selected trades to the chosen playbook.
- **"Export Selected (CSV)"**: Downloads a CSV file of selected trade data.
- **"Delete"** (destructive): Confirmation dialog: "Delete [n] selected trades? This cannot be undone." On confirm: `DELETE /api/trades/bulk` with trade IDs. Toast: "[n] trades deleted."

**Column Visibility**: A "Columns" dropdown button (top-right of table) allows toggling individual columns on/off. Preference is persisted in `localStorage` under key `journal_visible_columns`.

**States**:

| State | Display |
|---|---|
| Loading | 5-row skeleton table |
| Success | Populated table |
| Empty | Icon: BookOpen (48px, muted). "No trades recorded yet. Add your first trade or connect a broker to start auto-journaling." CTA: "Add Trade" button |
| Error | "Unable to load trades. Retry." |

**Performance**: Tables with up to 10,000 rows use virtualized rendering via `@tanstack/react-virtual` for smooth scrolling.

---

### 3.2 Trade Detail View (FE-FR-024)

**Route**: `/journal/trade/[id]`

**Description**: A full detail view for a single trade, accessed by clicking a trade row.

**Navigation**: Back button ("< Back to Journal") at top-left. Previous/Next trade navigation arrows at top-right (based on current sort order). Keyboard: `[` for previous, `]` for next.

**Layout**: Two columns on desktop (55% left / 45% right). Single column stacked on mobile.

**Left Column (55%)**:

**Mini Chart**: TradingView Lightweight Charts showing the instrument around the trade period.
- Entry point: Green vertical dashed line at entry time.
- Exit point: Purple vertical dashed line at exit time.
- Stop loss: Red horizontal dashed line at stop price.
- Take profit: Green horizontal dashed line at target price.
- Trendline(s): Overlaid if the trade was trendline-sourced (same rendering as trendline overlays in FSD-011b).
- Time range: Shows candles from 2 hours before entry to 2 hours after exit (for intraday), or 5 days before/after (for swing trades).

**Screenshot Gallery**: Below the chart. If screenshots are attached:
- Displayed as a horizontal scrollable thumbnail strip (120x80px per thumbnail).
- Click a thumbnail to open a full-screen lightbox with left/right navigation arrows.
- Lightbox closes on backdrop click, X button, or Escape key.
- If no screenshots: Area not rendered (no empty state needed).

**Right Column (45%)**:

**Auto-Captured Data Section** (read-only, rendered as a label-value grid):

| Section | Fields |
|---|---|
| Entry | Date, Time, Price, Order Type, Slippage (ticks) |
| Exit | Date, Time, Price, Order Type, Slippage (ticks) |
| P&L | Dollar (colored), Percentage (colored), R-Multiple |
| Risk | Stop distance (ticks), Risk amount ($), Planned R:R |
| Execution | MAE (ticks + $), MFE (ticks + $), Fill quality score (%) |
| Context | Session (RTH/Overnight), Day of week, Margin type |
| Signal | Source, Trendline grade (if applicable), Touch count, Slope |
| Playbook | Name (clickable link to `/playbooks/[id]`) or "Unassigned" |

**Journal Enrichment Section**: See Section 3.3.

---

### 3.3 Journal Enrichment Form (FE-FR-025)

**Description**: An inline editable form within the trade detail view for user-provided trade review data.

**Fields**:

| Field | Type | Options / Validation |
|---|---|---|
| Conviction (Pre-Trade) | Star rating 1-5 | Clickable stars. Hover preview: stars highlight up to the hovered position. Click sets value. Click the current value to clear it. |
| Emotional State | Multi-select tag picker | Options: Confident, Anxious, FOMO, Revenge, Patient, Disciplined, Frustrated, Excited, Fearful, Neutral. Max 3 selections. Attempting to select a 4th shows inline error: "Maximum 3 emotional states allowed." |
| Pre-Trade Notes | Rich textarea | Markdown supported. Placeholder: "What was your thesis before entering?" Max 2000 chars. Character counter shows "[current]/2000". |
| Post-Trade Review | Rich textarea | Markdown supported. Placeholder: "What did you learn from this trade?" Max 2000 chars. |
| Mistakes | Multi-select tag picker | Options: Moved Stop, Entered Early, Oversized, Held Too Long, Exited Too Early, Ignored Setup Criteria, FOMO Entry, Revenge Trade, No Stop Loss. No max. |
| Rule Compliance | Checklist | Dynamically generated from the trade's associated playbook rules. Each rule is a checkbox. If no playbook assigned: "Assign a playbook to see rule compliance checklist." |
| Screenshots | File upload | See Section 3.4 |

**Auto-Save Behavior**:
1. Changes are saved automatically 1 second after the user stops typing/clicking (debounced).
2. A save indicator appears near the form header:
   - "Saving..." (muted text with a small spinner icon) during the API call.
   - "Saved" (green text with a checkmark icon) for 2 seconds after successful save.
   - "Save failed. Retrying..." (red text) if the API call fails. Auto-retry after 3 seconds, up to 3 attempts.
   - "Unable to save. Please check your connection." (red text) after 3 failed retry attempts.
3. All fields are optional. Partial saves are valid.
4. API call: `PATCH /api/trades/{id}` with changed fields only.

---

### 3.4 Screenshot Upload (FE-FR-026)

**Description**: A drag-and-drop file upload component within the journal enrichment form.

**Drop Zone**:
- Visual: Dashed border rectangle, `--border` color, `rounded-lg`.
- Content: Upload icon (Lucide `Upload`, 32px) + "Drag screenshots here or click to upload" text.
- On drag-over: Border changes to `--primary` color, background becomes `--primary` at 5% opacity.

**File Constraints**:
- Accepted formats: PNG, JPG, JPEG, WebP.
- Max file size: 5MB per file.
- Max files per trade: 10.

**Upload Flow**:
1. User drops files or clicks to select via file picker.
2. Client-side validation:
   - Wrong format: Toast (error): "Unsupported format. Please use PNG, JPG, or WebP."
   - File too large: Toast (error): "File exceeds 5MB limit. Please reduce the image size."
   - Too many files: Toast (error): "Maximum 10 screenshots per trade. Remove some before adding more."
3. For each valid file:
   a. Request presigned upload URL from `POST /api/uploads/presign` with `{ filename, content_type, trade_id }`.
   b. Upload directly to Cloudflare R2 via the presigned URL (PUT request).
   c. On upload success: Register the file with the trade via `POST /api/trades/{id}/screenshots` with `{ url, filename }`.
4. Progress bar per file (0-100%) shown on the thumbnail during upload.

**Thumbnail Display**: Uploaded images display as a grid of 120x80px thumbnails. Each thumbnail has:
- A delete button (X icon, 16px) in the top-right corner.
- Click delete: Tooltip confirmation "Remove this screenshot?" with "Remove" and "Cancel" buttons. On confirm: `DELETE /api/trades/{id}/screenshots/{screenshot_id}`. Thumbnail fades out.

**Clipboard Paste**: `Cmd+V` / `Ctrl+V` when the upload zone is focused (or anywhere in the trade detail view) pastes a screenshot from the clipboard. The pasted image is treated as a new file upload and follows the same upload flow.

**Error Handling**:
- Presigned URL generation fails: Toast (error): "Unable to prepare upload. Please try again."
- Upload to R2 fails: Toast (error): "Upload failed. Please try again." Retry once automatically.
- Upload succeeds but registration fails: Toast (warning): "File uploaded but not linked to trade. Please try again."

---

### 3.5 Trade Search and Filters (FE-FR-027)

**Description**: A search bar and filter bar at the top of the trade journal page.

**Full-Text Search**:
- Text input with search icon (Lucide `Search`). Placeholder: "Search trades..."
- Debounce: 300ms. Minimum 2 characters to trigger search.
- Searches across: trade notes, post-trade reviews, instrument names, playbook names, emotional state tags, mistake tags.
- Backend: PostgreSQL `tsvector` full-text search.

**Filter Bar** (horizontal, below search input):

| Filter | Type | Options |
|---|---|---|
| Date Range | Calendar date range picker | Presets: Today, This Week, This Month, Last 30 Days, Last 90 Days, YTD, All Time, Custom |
| Instrument | Multi-select dropdown | All user-traded instruments |
| Playbook | Multi-select dropdown | All user playbooks + "Unassigned" |
| Outcome | Toggle buttons | All, Winners, Losers, Breakeven |
| Direction | Toggle buttons | All, Long, Short |
| Conviction | Star rating filter | Minimum conviction level (1-5) |

**Active Filters Display**: Applied filters appear as removable chips/badges below the filter bar. Each chip shows the filter name and value, with an X button to remove it. "Clear all filters" link appears when any filter is active.

**Results Count**: "Found [n] trades matching your search." displayed above the table when filters or search are active.

**URL Sync**: All filter and search state is reflected in URL query parameters. Examples:
- `/journal?search=crude+oil&instrument=CL&outcome=winners`
- `/journal?date_from=2026-01-01&date_to=2026-01-31&playbook=a-plus-break`
This enables bookmarking and sharing filtered views.

**Edge Cases**:
- No results: Table shows "No trades match your filters." with a "Clear Filters" button.
- Search with < 2 characters: No search is triggered; previous results remain.
- Invalid date range (end before start): Inline error: "End date must be after start date."

---

## 4. Data Specifications

### 4.1 Client-Side Data Models

All TypeScript types are generated from the FastAPI backend's OpenAPI spec using `openapi-typescript`.

#### 4.1.1 Trade

```typescript
interface Trade {
  id: string;                    // UUID
  user_id: string;               // UUID
  instrument: string;            // e.g., "MES"
  direction: "long" | "short";
  entry_price: number;           // Decimal
  exit_price: number | null;     // Null if still open
  contracts: number;             // Integer, 1-100
  stop_loss: number;
  take_profit: number | null;
  entry_time: string;            // ISO 8601
  exit_time: string | null;
  pnl_dollars: number | null;    // Null if open
  pnl_percent: number | null;
  r_multiple: number | null;
  mae_ticks: number | null;      // Max adverse excursion
  mfe_ticks: number | null;      // Max favorable excursion
  slippage_entry: number | null; // Ticks
  slippage_exit: number | null;
  signal_source: "trendline_engine" | "tradingview" | "manual" | "other";
  trendline_id: string | null;   // UUID reference
  playbook_id: string | null;    // UUID reference
  order_type: "market" | "limit";
  session: "rth" | "overnight";
  status: "open" | "closed" | "cancelled";
  mode: "paper" | "live";
  // Journal enrichment fields
  conviction: number | null;      // 1-5
  emotional_states: string[];     // Max 3
  pre_trade_notes: string | null; // Max 2000 chars
  post_trade_review: string | null;
  mistakes: string[];
  rule_compliance: Record<string, boolean>; // Rule name -> checked
  screenshots: Screenshot[];
  created_at: string;
  updated_at: string;
}
```

#### 4.1.2 Position

```typescript
interface Position {
  id: string;
  instrument: string;
  direction: "long" | "short";
  contracts: number;
  entry_price: number;
  current_price: number;         // Updated via WebSocket
  stop_loss: number;
  take_profit: number | null;
  unrealized_pnl: number;       // Updated via WebSocket
  r_multiple: number;
  mae_ticks: number;
  mfe_ticks: number;
  entry_time: string;
  signal_source: string;
  trendline_id: string | null;
  mode: "paper" | "live";
}
```

#### 4.1.3 Signal

```typescript
interface Signal {
  id: string;
  source: "trendline_engine" | "tradingview" | "manual";
  instrument: string;
  direction: "long" | "short";
  entry_price: number;
  stop_price: number;
  target_price: number;
  planned_rr: number;
  trendline_grade: string | null;
  status: "pending" | "executed" | "rejected" | "expired";
  rejection_reason: string | null;
  auto_execute: boolean;
  auto_execute_at: string | null; // ISO 8601 timestamp
  created_at: string;
}
```

#### 4.1.4 Screenshot

```typescript
interface Screenshot {
  id: string;
  trade_id: string;
  url: string;                   // Cloudflare R2 URL
  filename: string;
  uploaded_at: string;
}
```

### 4.2 Client-Side State (Zustand)

| Store | Relevant State | Persisted |
|---|---|---|
| `useAuthStore` | `mode` (paper/live) | Cookie (server-side) |
| `usePositionsStore` | `positions[]`, `lastUpdate` | No (WebSocket-driven) |

### 4.3 Data Validation Rules

| Entity | Field | Rule |
|---|---|---|
| Trade (manual entry) | instrument | Required, must be in supported list |
| Trade | entry_price | Required, positive number, tick-size validated |
| Trade | contracts | Required, integer, 1-100 |
| Trade | stop_loss | Required, positive, directionally valid |
| Trade | take_profit | Optional, positive, directionally valid |
| Trade | notes | Optional, max 500 chars |
| Journal Enrichment | conviction | Optional, integer 1-5 |
| Journal Enrichment | emotional_states | Optional, max 3 selections |
| Journal Enrichment | pre_trade_notes | Optional, max 2000 chars |
| Journal Enrichment | post_trade_review | Optional, max 2000 chars |
| Screenshot | file_type | PNG, JPG, JPEG, WebP only |
| Screenshot | file_size | Max 5MB |
| Screenshot | count_per_trade | Max 10 |

---

## 5. API Specifications

### 5.1 Trade Execution Endpoints

| Method | BFF Route | Description |
|---|---|---|
| GET | `/api/positions?status=open` | Active positions |
| POST | `/api/positions/{id}/close` | Close a position at market |
| PATCH | `/api/positions/{id}` | Modify stop/target on open position |
| GET | `/api/signals?status=pending` | Pending signals queue |
| POST | `/api/orders/execute` | Execute a trade (from signal or manual entry) |
| PATCH | `/api/signals/{id}` | Reject or modify a signal |
| POST | `/api/settings/trading-mode` | Switch between paper/live mode |

### 5.2 Trade Journal Endpoints

| Method | BFF Route | Description |
|---|---|---|
| GET | `/api/trades` | Trade list with filters, search, pagination |
| GET | `/api/trades/{id}` | Trade detail (auto-captured + enrichment data) |
| PATCH | `/api/trades/{id}` | Update journal enrichment fields (auto-save) |
| DELETE | `/api/trades/bulk` | Bulk delete trades |
| POST | `/api/uploads/presign` | Get presigned URL for screenshot upload to R2 |
| POST | `/api/trades/{id}/screenshots` | Register uploaded screenshot with trade |
| DELETE | `/api/trades/{id}/screenshots/{sid}` | Delete a screenshot |

### 5.3 Caching Strategy (TanStack Query)

| Data Type | Stale Time | Cache Time | Refetch On |
|---|---|---|---|
| Position data | 30 seconds | 5 minutes | WebSocket event, window focus |
| Trade list | 2 minutes | 10 minutes | Window focus, mutation |
| Signal data | 30 seconds | 5 minutes | WebSocket event |

### 5.4 Error Responses

All API errors follow the standard envelope format:

| HTTP Status | Error Code | User-Facing Message |
|---|---|---|
| 400 | `validation_error` | Field-specific messages from `details` object |
| 401 | `unauthorized` | "Session expired. Please log in again." |
| 403 | `forbidden` | "You do not have permission to perform this action." |
| 404 | `not_found` | "The requested resource was not found." |
| 422 | `unprocessable_entity` | Context-specific (e.g., "Stop loss must be below entry price for a long position.") |
| 429 | `rate_limited` | "Too many requests. Please wait a moment and try again." |
| 500 | `internal_error` | "Something went wrong. Please try again." |

---

## 6. Real-Time Integration

### 6.1 WebSocket Channels (Execution & Journal)

The execution and journal views subscribe to the following WebSocket channels:

| Channel | Event | UI Update |
|---|---|---|
| `positions` | Position opened/closed/updated | Active positions table (execution page), dashboard positions widget |
| `fills` | Order filled | Toast notification, position update, journal entry auto-created |
| `signals` | New signal generated | Pending signals queue, notification badge on sidebar |
| `account` | Balance/margin update | Broker connection status, account info |

### 6.2 Stale Data Handling

- If the WebSocket disconnects for > 60 seconds, on reconnection the client performs a full data refresh by invalidating all TanStack Query caches for positions, signals, and trades.
- During disconnection, position data shows a "stale" indicator (yellow clock icon) with the timestamp of the last update.
- Real-time P&L updates freeze at the last known value until reconnection.

### 6.3 Optimistic Updates

- When the user closes a position via the context menu, the position row is immediately marked as "Closing..." with a dimmed appearance (optimistic update).
- If the API call fails, the optimistic update is rolled back and the position row returns to its previous state.
- Journal enrichment auto-save uses optimistic updates: the UI reflects the change immediately while the API call proceeds in the background.

---

## 7. Performance Specifications

### 7.1 Response Time Targets

| Operation | Target | Notes |
|---|---|---|
| Position P&L real-time update | 1 Hz (1 update/second) | Without dropped frames |
| WebSocket message to UI update | < 200ms | From message receipt to rendered DOM change |
| Trade table render (10,000 rows) | Smooth scrolling | Virtualized via `@tanstack/react-virtual` |
| Search result rendering | < 300ms after debounce | Full-text trade search |
| Form auto-save round-trip | < 2 seconds | Debounce (1s) + API call (< 1s) |
| Screenshot upload | Progress bar during upload | Presign + direct R2 upload |
| Chart render (mini chart, 300 candles) | < 16ms per frame | No frame drops |

### 7.2 Data Volume Handling

| Data | Volume Limit | Strategy |
|---|---|---|
| Trade table rows | Up to 10,000 | Virtualized rendering (`@tanstack/react-virtual`) |
| Concurrent open positions | Up to 10 | Direct rendering (no virtualization needed) |
| Pending signals | Up to 50 | Direct rendering |
| Screenshots per trade | Up to 10 | Direct rendering as thumbnail grid |

---

## 8. Testing Specifications

### 8.1 Unit Tests (Jest + React Testing Library)

| Component / Feature | Test Cases |
|---|---|
| Manual Trade Entry Form | All validation rules fire with correct error messages. Calculated fields (R:R, total risk) update in real-time. Stop loss validation is direction-aware (below for long, above for short). Submit disabled until all required fields valid. Paper mode submits without dialog; live mode shows confirmation dialog. Form resets on successful submission. |
| Journal Enrichment | Max 3 emotional states enforced with inline error message. Character count displayed for notes fields. Auto-save debounce fires correctly at 1 second. Save indicator transitions through Saving/Saved/Failed states. |
| Screenshot Upload | Rejects files > 5MB with correct toast message. Rejects unsupported formats (non PNG/JPG/WebP). Limits to 10 files per trade. Progress bar renders during upload. Delete confirmation works. Clipboard paste triggers upload flow. |
| Trade Table | Sorts correctly ascending/descending for all sortable columns. Pagination renders correct ranges ("Showing 1-25 of 147"). Winning trades have green left border, losing have red. Column visibility toggle persists in localStorage. Bulk action bar appears on row selection. |
| Paper/Live Toggle | Paper-to-live requires checkbox acknowledgment before "Switch to Live" is enabled. Live-to-paper is single-click (no confirmation). 60-day warning displays when applicable. Mode change propagates globally via Zustand store. |
| Active Positions Table | Renders correct column data. Shows empty state "No open positions" when no positions. Shows stale indicator when WebSocket disconnected. Footer row shows correct totals. Context menu actions trigger correct API calls. |
| Pending Signals Queue | Signal cards render all fields. Execute opens confirmation dialog with correct summary. Reject opens reason popover. Modify enables inline edit. Auto-execution countdown displays when enabled. |
| Broker Status | Green dot for connected, red for disconnected. Auto-reconnect countdown displays. "No broker" state links to settings. |

### 8.2 End-to-End Tests (Playwright)

**Critical User Journeys**:

| # | Journey | Key Assertions |
|---|---|---|
| 1 | Trade Entry | Open form > fill all fields > verify calculated R:R updates > submit > toast appears > position in active table > trade appears in journal |
| 2 | Journal Workflow | View trade table > sort by P&L > filter by instrument > click trade row > add conviction (3 stars) > add emotional states > write post-trade notes > upload screenshot > verify auto-save indicator shows "Saved" |
| 3 | Paper/Live Toggle | Click header badge > dialog opens > verify checkbox unchecked > verify button disabled > check checkbox > click switch > verify green "LIVE TRADING" badge > click badge again > switch back to paper > verify blue "PAPER TRADING" badge |
| 4 | Signal Execution | Pending signal appears > click Execute > confirmation dialog shows summary > confirm > toast shows success > signal removed from queue > position appears in table |
| 5 | Signal Rejection | Pending signal appears > click Reject > select reason "Risk too high" > confirm > signal card fades out > toast "Signal rejected." |
| 6 | Position Close | Right-click position row > click "Close Position" > confirmation dialog shows details > confirm > toast "Position closed. P&L: [amount]" > position removed from table |
| 7 | Journal Search | Type "crude oil" in search > verify filtered results > add instrument filter CL > verify further narrowed results > clear all filters > verify full results restored |
| 8 | Screenshot Upload | Navigate to trade detail > drag image file onto drop zone > verify progress bar > verify thumbnail appears > click thumbnail > verify lightbox opens > close lightbox > click delete > confirm > verify thumbnail removed |
| 9 | Responsive Layout | Run journeys 1 and 2 at 375px viewport width > verify mobile layout > stacked columns on trade detail > card-based layout for trade table |

### 8.3 Visual Regression (Playwright Screenshots)

**Critical Screenshots** (both dark and light themes):
- Execution page: positions table with data, empty state
- Execution page: pending signal cards
- Manual trade entry form (filled, with validation errors)
- Journal trade table (with data, with empty state)
- Trade detail view (with screenshots, without screenshots)
- Journal enrichment form (partially filled)
- Paper mode header vs. Live mode header
- Paper-to-live confirmation dialog

Pixel difference tolerance: 0.1%.

### 8.4 Accessibility Tests

- Every page: zero "critical" and "serious" axe-core violations.
- Trade entry form: all inputs have `<label>` elements, error messages linked via `aria-describedby`, required fields marked with `aria-required="true"`.
- Trade table: uses `<th>` with `scope`, sortable columns indicate sort direction via `aria-sort`.
- Screenshot gallery lightbox: focus trapped, Escape closes, arrow keys navigate.
- Confirmation dialogs: focus trapped, Escape closes, destructive button is NOT auto-focused.

---

## 9. Cross-References

| Document | Relationship |
|---|---|
| FSD-011a (App Shell & Navigation) | Parent shell: sidebar, header, breadcrumbs, global loading/error/toast patterns, design system tokens. |
| FSD-011b (Dashboard Home & Trendline Views) | Sibling: dashboard active positions widget links to execution page; recent trades widget links to journal. |
| FSD-011d (Analytics & Playbook Views) | Sibling: journal trades can be assigned to playbooks; analytics consume journal data. |
| FSD-011e (Settings, Onboarding & AI Chat) | Sibling: trading preferences, broker connection management, risk rules all feed into execution behavior. |
| FSD-003c (Broker Adapters) | Backend: broker connection status, order routing, paper/live mode. |
| FSD-003d (Order Construction & Lifecycle) | Backend: order state machine, bracket orders, OCO management, position lifecycle. |
| FSD-006 (Trade Journaling) | Backend: auto-capture logic, enrichment storage, screenshot storage. |

---

## Changelog

- 2026-02-11: Initial sub-FSD extracted from FSD-011 v1.0 -- Generated by Claude

---

*FSD-011c v1.0 -- Execution & Journal Views*
*TrendEdge -- February 2026*
