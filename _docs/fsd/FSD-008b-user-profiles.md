# FSD-008b: User Profiles & Settings

**TrendEdge -- AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-008b |
| Source | FSD-008 (Authentication & User Management) |
| Title | User Profiles & Settings |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-11 |

---

## 1. Introduction

### 1.1 Purpose

This sub-FSD specifies the user profile management, trading preferences, notification preferences, display preferences, and onboarding wizard subsystems of TrendEdge. It covers the complete lifecycle of a user's profile from initial creation (via database trigger on registration) through ongoing preference management, avatar handling, and the guided onboarding experience for new users.

This document provides every behavioral detail, validation rule, error state, and edge case required for a developer to implement the profile and settings system without ambiguity.

### 1.2 Scope

This document covers:

- **Profile CRUD**: Viewing and editing display name, timezone, avatar, and email change flow.
- **Trading Preferences**: Default instruments, timeframe, risk parameters, and the paper trading mode toggle with its confirmation and safety logic.
- **Notification Preferences**: Telegram setup flow, Discord webhook configuration, email digest settings, and per-event alert toggles.
- **Display Preferences**: Theme, currency display, date format, and compact mode.
- **Onboarding Wizard (Phase 3)**: 4-step guided setup for new users including profile, trading preferences, broker connection, and first playbook.
- **Data Export (Phase 3)**: User-initiated export of all personal data as a ZIP file.
- **Account Deletion (Phase 3)**: Soft-delete with 30-day grace period and hard-delete lifecycle.

### 1.3 Out of Scope

- User registration, login, and authentication flows [see FSD-008a]
- JWT token handling, session management, and refresh token rotation [see FSD-008a]
- Broker connection CRUD, credential encryption, and health monitoring [see FSD-008c]
- Row Level Security, RBAC, team/organization support, and admin overrides [see FSD-008d]
- API key management and webhook URL generation [see FSD-008a]
- Subscription tier enforcement and billing [see FSD-009a]
- Notification delivery engine and channel integrations [see FSD-010a, FSD-010b]

### 1.4 Sibling Sub-FSDs

| Sub-FSD | Title | Relationship |
|---------|-------|-------------|
| FSD-008a | Authentication | Handles registration (which triggers profile creation), login, session management, JWT lifecycle, password reset, and API key management |
| FSD-008c | Broker Connection Management | Handles broker CRUD, credential encryption, connection health monitoring; broker connection step in onboarding wizard references this |
| FSD-008d | Authorization & Multi-Tenancy | Handles RLS policies on the users table, RBAC permission matrix, team creation/invitation, and admin access controls |

### 1.5 Phased Delivery

| Phase | Timeline | Profile & Settings Scope |
|-------|----------|-------------------------|
| Phase 1 | Weeks 1-2 | Profile basics (display name, timezone), trading preferences (all 6 fields including paper trading toggle), default settings JSONB creation via DB trigger |
| Phase 2 | Weeks 9-14 | Avatar upload (Cloudflare R2), email change flow with re-verification, notification preferences (Telegram, Discord, email digest), display preferences |
| Phase 3 | Weeks 15-22 | Onboarding wizard (4 steps), data export (ZIP via R2), account deletion (soft-delete + 30-day hard-delete) |

---

## 2. Functional Specifications

### 2.1 FR-020: Profile CRUD

**Source:** PRD AU-FR-020 | **Phase:** 1 (basic) / 2 (full) | **Priority:** P1/P0

#### Description

The system provides profile viewing and editing capabilities for user display name, timezone, avatar, and email. The profile is created automatically with default values when a user registers (via the `on_auth_user_created` database trigger defined in section 4.3). Users manage their profile at `/settings/profile`.

#### Profile Fields

| Field | Type | Validation | Default | Phase |
|-------|------|-----------|---------|-------|
| display_name | string | 2-50 characters; letters, spaces, hyphens only; regex: `^[a-zA-Z\s\-]{2,50}$` | null | 1 |
| timezone | string | Valid IANA timezone identifier (validated against `pytz.all_timezones` on backend) | "America/New_York" | 1 |
| avatar | file or URL | JPG or PNG format; max 2MB file size; minimum 200x200 pixels | null | 2 |
| email | string | RFC 5322 (change handled through separate verification flow) | from auth | 2 |

#### Processing Logic -- Profile View

1. User navigates to `/settings/profile`.
2. Frontend sends `GET /api/profile` with Bearer JWT.
3. Backend validates JWT, extracts `user_id` from `sub` claim.
4. Backend queries `SELECT * FROM public.users WHERE id = auth.uid()` (RLS-enforced).
5. Returns the full profile object (see API Specifications section 5.1).
6. Frontend renders the profile form pre-filled with current values. Empty optional fields show placeholder text.

#### Processing Logic -- Profile Update

1. User edits one or more fields on the `/settings/profile` page.
2. On change, client-side validation runs immediately (debounced 300ms).
3. On submit, frontend sends `PATCH /api/profile` with changed fields only.
4. Backend validates all fields server-side (same rules as client-side).
5. Backend updates the `public.users` row where `id = auth.uid()`.
6. `updated_at` is set to `NOW()` on every update.
7. Success response returns the updated profile object.
8. Frontend displays toast: "Profile updated successfully."

#### Processing Logic -- Email Change

1. User enters a new email on the profile page and clicks "Change email."
2. Frontend calls `supabase.auth.updateUser({ email: newEmail })`.
3. Supabase sends a verification link to the NEW email address.
4. The old email remains active until the new email is verified.
5. On verification of the new email, Supabase sends a notification to the OLD email: "Your TrendEdge email was changed to [new-email]. If this wasn't you, contact support immediately."
6. The `public.users.email` field is updated by a database trigger listening to `auth.users` changes.
7. The email change is logged in the audit log with event type `email_changed`, capturing `old_email` (hashed) and `new_email` (hashed).

#### Processing Logic -- Avatar Upload

1. User clicks "Upload avatar" or drags an image onto the avatar area.
2. Client validates: file type (JPG/PNG only), file size (max 2MB).
3. On submit, frontend sends `POST /api/profile/avatar` with the file as multipart form data.
4. Backend validates file type via magic bytes (not just extension), validates file size.
5. Backend resizes the image to 200x200 pixels using Pillow (Python Imaging Library), maintaining aspect ratio and center-cropping.
6. Backend uploads to Cloudflare R2 at path: `avatars/{user_id}.{ext}`.
7. Backend updates `users.avatar_url` with the R2 URL.
8. If a previous avatar exists, the old file is deleted from R2.
9. Frontend displays the new avatar immediately.

#### Error Handling

| Error Condition | User-Facing Message |
|----------------|---------------------|
| Display name < 2 chars | "Name must be at least 2 characters." |
| Display name > 50 chars | "Name must not exceed 50 characters." |
| Display name contains invalid chars | "Name can only contain letters, spaces, and hyphens." |
| Avatar file > 2MB | "Image must be under 2MB." |
| Avatar wrong format | "Please upload a JPG or PNG image." |
| Avatar file corrupted (magic bytes mismatch) | "The uploaded file appears to be corrupted. Please try a different image." |
| Avatar dimensions < 200x200 | "Image must be at least 200x200 pixels." |
| Timezone not in IANA list | "Please select a valid timezone." |
| Email change -- new email already in use | "This email is already associated with another account." |
| R2 upload failure | "Avatar upload failed. Please try again." (retry up to 2 times, then show error) |

#### Edge Cases

- **XSS in display name:** React JSX escaping prevents script execution. Server-side `bleach` sanitization strips HTML tags on any stored text.
- **Avatar with embedded EXIF data:** Pillow's resize operation strips EXIF data. No location or camera metadata is stored.
- **Concurrent profile updates from multiple tabs:** Last write wins. `updated_at` prevents silent overwrites if optimistic locking is added later.
- **Email change when new email belongs to OAuth account:** Supabase returns a conflict error. Display: "This email is already associated with another account."

---

### 2.2 FR-021: Trading Preferences

**Source:** PRD AU-FR-021 | **Phase:** 1 | **Priority:** P0

#### Description

Users can configure default trading parameters that are used throughout the platform for trade execution, risk management, and dashboard display. These settings are stored in the `settings.trading_preferences` JSONB field of the `public.users` table.

#### Inputs

| Preference | Type | Validation | Default | Range |
|-----------|------|-----------|---------|-------|
| default_instruments | string[] | 0-20 items; each must be a valid CME futures symbol | `[]` | Valid symbols: ES, NQ, YM, CL, GC, PL, SI, HG, NG, ZB, ZN, 6E, and others |
| default_timeframe | enum | Must be one of: 1H, 4H, D, W | "4H" | N/A |
| risk_per_trade_percent | decimal | 0.1 to 5.0, step 0.1 | 1.0 | 0.1 - 5.0 |
| max_daily_loss | decimal | 50.00 to 50,000.00, step 1.00 | 500.00 | $50 - $50,000 |
| max_concurrent_positions | integer | 1 to 20 | 3 | 1 - 20 |
| paper_trading_mode | boolean | N/A | true | true/false |

#### Processing Logic -- Preference Update

1. User navigates to `/settings/trading`.
2. Form pre-fills with current values from `settings.trading_preferences`.
3. Instruments are displayed as a multi-select card grid. Each card shows: symbol, full name, tick size, tick value, margin requirement.
4. Timeframe is presented as radio buttons: 1H, 4H, D, W.
5. Risk per trade % is a slider with numeric input (0.1 - 5.0, step 0.1).
6. Max daily loss is a numeric input with dollar formatting ($50 - $50,000).
7. Max concurrent positions is a numeric input (1 - 20).
8. On submit, frontend sends `PATCH /api/profile` with the updated `settings.trading_preferences` object.
9. Backend validates each field against the specified ranges.
10. Backend merges the updated preferences into the existing JSONB (deep merge, not replace).
11. Success toast: "Trading preferences updated."

#### Processing Logic -- Paper Trading Mode Toggle

1. User navigates to `/settings/trading` and toggles "Paper Trading Mode" from ON to OFF.
2. **First confirmation modal:** "You are switching to LIVE trading. Real money will be at risk. Are you sure? [Stay in paper] [Switch to live]"
3. **Conditional second warning:** If the user has been in paper mode for fewer than 60 days since account creation, an additional warning is displayed: "We recommend at least 60 days of paper trading before going live. You have completed [X] days. [Continue anyway] [Stay in paper]"
   - `X` is calculated as: `floor((NOW() - users.created_at) / interval '1 day')`.
   - This warning is displayed only on the first switch from paper to live. If the user has previously been in live mode, this warning is not shown again.
4. **Broker connection check:** Before completing the toggle, the backend verifies at least one active broker connection exists with `is_paper = false`.
   - If no live broker connection exists: "You need an active live broker connection to trade live. [Connect broker] [Stay in paper]"
   - "Connect broker" navigates to `/settings/brokers` [see FSD-008c].
5. On confirmation, `settings.trading_preferences.paper_trading_mode` is set to `false`.
6. The toggle state change is logged in the audit log with event type `paper_mode_changed`, capturing `old_value`, `new_value`, and `days_in_paper`.
7. The dashboard banner changes from "PAPER TRADING MODE" (orange) to no banner (live mode).

**Toggling back to paper mode (live -> paper):**

1. User toggles "Paper Trading Mode" from OFF to ON.
2. Single confirmation: "Switch back to paper trading mode? Live trades will no longer be executed. [Stay live] [Switch to paper]"
3. On confirmation, `paper_trading_mode` is set to `true`.
4. Dashboard banner reappears: "PAPER TRADING MODE."
5. No broker connection check is required for switching to paper mode.

#### Business Rules

- BR-030: Paper trading mode defaults to `true` for ALL new users regardless of subscription tier.
- BR-031: Switching from paper to live requires at least one active broker connection with `is_paper = false`.
- BR-032: If no live broker connection exists when toggling to live, display the "Connect broker" prompt (see Processing Logic step 4).
- BR-033: Paper trades are always flagged with `trade.is_paper = true` and are never mixed with live trade data in analytics unless the user explicitly enables "Show paper trades" toggle.
- BR-034: The `days_in_paper` calculation uses floor division, so a user who registered 59.9 days ago sees "59 days."

#### Error Handling

| Error Condition | User-Facing Message |
|----------------|---------------------|
| default_instruments exceeds 20 items | "You can select up to 20 default instruments." |
| Invalid instrument symbol | "Invalid instrument: [symbol]. Please select from the available instruments." |
| risk_per_trade_percent out of range | "Risk per trade must be between 0.1% and 5.0%." |
| max_daily_loss out of range | "Maximum daily loss must be between $50 and $50,000." |
| max_concurrent_positions out of range | "Maximum concurrent positions must be between 1 and 20." |
| Paper-to-live without live broker | "You need an active live broker connection to trade live. [Connect broker] [Stay in paper]" |
| default_timeframe invalid value | "Please select a valid timeframe." |

---

### 2.3 FR-022: Notification Preferences

**Source:** PRD AU-FR-022 | **Phase:** 2 | **Priority:** P0

#### Description

Users can configure notification channels (Telegram, Discord, email) and select which events trigger notifications. These settings are stored in the `settings.notification_preferences` JSONB field. Notification delivery itself is handled by [FSD-010a and FSD-010b]; this section covers only the preference configuration and channel setup flows.

#### Inputs

| Setting | Type | Default | Validation |
|---------|------|---------|-----------|
| telegram_enabled | boolean | false | N/A |
| telegram_chat_id | string | null | Required when telegram_enabled is true; numeric string |
| discord_webhook_url | string | null | Must match `https://discord.com/api/webhooks/...` pattern |
| email_digest | enum | "daily" | One of: "none", "daily", "weekly" |
| alert_on_fill | boolean | true | N/A |
| alert_on_trendline | boolean | true | N/A |
| alert_on_risk_breach | boolean | true | N/A |

#### Processing Logic -- General Preference Update

1. User navigates to `/settings/notifications`.
2. Form displays current notification preferences.
3. Event alert toggles (fill, trendline, risk breach) are simple switches.
4. Email digest is a dropdown: None, Daily, Weekly.
5. On change and submit, frontend sends `PATCH /api/profile` with updated `settings.notification_preferences`.
6. Backend validates and merges into existing JSONB.
7. Success toast: "Notification preferences updated."

#### Processing Logic -- Telegram Setup

1. User clicks "Connect Telegram" on the notification settings page.
2. System displays step-by-step instructions:
   - "1. Open Telegram on your phone or desktop."
   - "2. Search for @TrendEdgeBot."
   - "3. Send the command /start to the bot."
   - "4. The bot will reply with your Chat ID. Copy it and paste it below."
3. User pastes the chat ID into the input field.
4. User clicks "Test Connection."
5. Backend sends a test message via the Telegram Bot API to the provided chat ID: "TrendEdge connected successfully! You will receive trading alerts here."
6. **Success:** Display green checkmark and "Telegram connected!" message. Save `telegram_chat_id` and set `telegram_enabled = true`.
7. **Failure:** Display "Could not reach your Telegram. Please verify the chat ID and ensure you've started the bot."

**Telegram disconnection:**

1. User clicks "Disconnect Telegram."
2. System sets `telegram_enabled = false` but retains `telegram_chat_id` for easy re-enablement.
3. Toast: "Telegram disconnected. Your chat ID has been saved for easy reconnection."

**Telegram re-enablement:**

1. If `telegram_chat_id` is already stored, user sees a "Re-enable Telegram" button instead of the full setup flow.
2. Clicking it sends a test message to the stored chat ID.
3. On success, `telegram_enabled = true`. On failure, show the full setup flow.

#### Processing Logic -- Discord Setup

1. User clicks "Connect Discord" on the notification settings page.
2. System displays instructions:
   - "1. Open Discord and go to the channel where you want alerts."
   - "2. Click the gear icon (Edit Channel) > Integrations > Webhooks > New Webhook."
   - "3. Copy the Webhook URL and paste it below."
3. User pastes the webhook URL.
4. Client-side validation: URL must match `https://discord.com/api/webhooks/...` pattern.
5. User clicks "Test Connection."
6. Backend sends a test message via the Discord webhook: "TrendEdge connected successfully! Trading alerts will appear here."
7. **Success:** Display green checkmark and "Discord connected!" message.
8. **Failure:** Display "Could not reach your Discord webhook. Please verify the URL."

#### Business Rules

- BR-035: Disabling Telegram (`telegram_enabled = false`) retains the `telegram_chat_id` for easy re-enablement.
- BR-036: `alert_on_risk_breach` cannot be disabled if the user has live trading enabled (`paper_trading_mode = false`). Attempting to disable it shows: "Risk breach alerts are required for live trading accounts."
- BR-037: Discord webhook URL is validated both client-side (regex) and server-side (regex + test POST).
- BR-038: The Telegram Bot API key is stored server-side only (`TELEGRAM_BOT_TOKEN` environment variable). It is never sent to the frontend.

#### Error Handling

| Error Condition | User-Facing Message |
|----------------|---------------------|
| Telegram chat ID not numeric | "Chat ID must be a numeric value." |
| Telegram test message fails | "Could not reach your Telegram. Please verify the chat ID and ensure you've started the bot." |
| Discord URL format invalid | "Please enter a valid Discord webhook URL." |
| Discord test message fails | "Could not reach your Discord webhook. Please verify the URL." |
| Disable risk_breach alert while live | "Risk breach alerts are required for live trading accounts." |
| email_digest invalid value | "Please select a valid email digest frequency." |

---

### 2.4 FR-023: Display Preferences

**Source:** FSD-008 | **Phase:** 2 | **Priority:** P2

#### Description

Users can configure visual and formatting preferences that affect the dashboard and all data display throughout the platform. These settings are stored in the `settings.display_preferences` JSONB field.

#### Inputs

| Setting | Type | Default | Validation |
|---------|------|---------|-----------|
| theme | enum | "system" | One of: "light", "dark", "system" |
| currency_display | string | "USD" | Valid ISO 4217 currency code |
| date_format | enum | "MM/DD/YYYY" | One of: "MM/DD/YYYY", "DD/MM/YYYY", "YYYY-MM-DD" |
| compact_mode | boolean | false | N/A |

#### Processing Logic

1. User navigates to `/settings/display` (or a "Display" section within `/settings/profile`).
2. Theme is a radio button group: Light, Dark, System (follows OS setting).
3. Currency display is a dropdown of supported currencies (USD, EUR, GBP, JPY, etc.).
4. Date format is a dropdown with preview: "02/11/2026", "11/02/2026", "2026-02-11".
5. Compact mode is a toggle: reduces card spacing and font sizes across the dashboard.
6. Changes apply immediately (optimistic update) and are persisted via `PATCH /api/profile`.
7. Theme changes trigger a CSS class swap on the `<html>` element (`data-theme="light"`, `data-theme="dark"`).

#### Business Rules

- BR-039: "System" theme follows the user's OS preference via `prefers-color-scheme` media query. Changes to the OS setting are detected in real-time via `matchMedia` listener.
- BR-040: Currency display affects P&L, balance, and cost figures throughout the platform. Conversion rates are not applied -- this is a display format setting only (all values are in the original currency).

---

### 2.5 FR-080: Onboarding Wizard (Phase 3)

**Source:** PRD AU-FR-080, AU-FR-081 | **Phase:** 3 | **Priority:** P0

#### Description

New users are guided through a 4-step onboarding wizard on first login. The wizard is designed to configure essential profile and trading settings, optionally connect a broker, and create a first playbook. All new users default to paper trading mode.

#### Trigger Conditions

- The wizard is shown when `onboarding_completed = false` AND the user navigates to `/dashboard`.
- New user (Phase 3 behavior): After registration and email verification, redirect to `/onboarding` instead of `/dashboard`.
- Users who skip or partially complete onboarding see a persistent, dismissible banner on the dashboard (see section 6.2).

#### Wizard Steps

**Step 1: Welcome & Profile**

- Header: "Welcome to TrendEdge! Let's set up your trading system."
- Collect: display name (text input, same validation as FR-020), timezone (dropdown, auto-detected from browser's `Intl.DateTimeFormat().resolvedOptions().timeZone`, editable).
- "Skip" link available. Skipping applies no changes (defaults remain).

**Step 2: Trading Preferences**

- Header: "What do you trade?"
- Collect: default instruments (multi-select card grid: ES, NQ, YM, CL, GC, PL, SI, HG, NG, ZB, ZN, 6E), default timeframe (radio buttons: 1H, 4H, D, W), risk per trade % (slider with numeric input: 0.1-5.0).
- Each instrument card shows: symbol, full name, tick size, tick value, margin requirement.
- "Skip" link applies defaults (empty instruments, 4H timeframe, 1.0% risk).

**Step 3: Broker Connection**

- Header: "Connect your broker to start trading."
- Options displayed as cards:
  - "Connect Interactive Brokers"
  - "Connect Tradovate"
  - "Connect Webull"
  - "Start with paper trading only" (highlighted as recommended for new users)
- Selecting "Paper trading only" skips to Step 4.
- Selecting a broker opens the connection flow [see FSD-008c] inline within the wizard. On successful connection, automatically proceed to Step 4.
- Users on the Free tier see only the "Paper trading only" option with a note: "Broker connections require the Trader plan ($49/mo) or higher."

**Step 4: First Playbook**

- Header: "Set up your first trading playbook."
- Options:
  - "Use A+ Trendline Break (recommended)" -- pre-configured playbook with strict entry criteria.
  - "Use Standard Trendline Break" -- pre-configured playbook with standard criteria.
  - "Create custom playbook" -- navigates to the playbook creation flow [see FSD-005].
  - "Skip for now."
- If a preset is selected, the system creates the playbook with default criteria.
- Final message: "You're all set! Your paper trading account is active. We recommend at least 60 days of paper trading before going live."

#### Progress Tracking

- Progress bar at top: "Step 1 of 4", "Step 2 of 4", etc. Four segments -- completed steps are filled with primary color, current step is highlighted.
- "Back" button available on steps 2-4 to return to the previous step.
- "Skip setup" link is available on every step. Clicking it sets `onboarding_completed = true` and `onboarding_step` to the current step number.
- Completed wizard sets `onboarding_completed = true` and `onboarding_step = 4`.
- Users who skip or do not complete onboarding see a persistent, dismissible banner on the dashboard: "Complete your setup to get the most out of TrendEdge. [Continue setup]"
- Clicking "Continue setup" resumes the wizard at `onboarding_step + 1`.

#### Business Rules

- BR-041: All new users start with `paper_trading_mode = true` regardless of the wizard outcome.
- BR-042: Skipping a step does not prevent completing subsequent steps. Each step is independent.
- BR-043: The onboarding banner is dismissible (stored in `sessionStorage`). It reappears on the next session until the wizard is completed.
- BR-044: Wizard data is saved to the profile after each step, not only at the end. If the user abandons mid-wizard, partial data is preserved.

#### Error Handling

| Error Condition | User-Facing Message |
|----------------|---------------------|
| Broker connection fails in step 3 | Inline error from the broker connection flow. "Skip this step" link remains available. |
| Playbook creation fails in step 4 | "Could not create the playbook. You can set this up later in Settings." |
| Network error during any step | "Connection lost. Your progress has been saved. Refresh to continue." |

---

### 2.6 FR-090: Data Export (Phase 3)

**Source:** PRD AU-FR-090 | **Phase:** 3 | **Priority:** P0

#### Description

Users can export all their data in machine-readable format (JSON and CSV) as a ZIP file. This supports GDPR data portability requirements.

#### Processing Logic

1. User navigates to `/settings/account` and clicks "Export my data."
2. System displays: "We'll prepare a download of all your TrendEdge data. This may take a few minutes for large accounts."
3. Frontend sends `POST /api/account/export`.
4. Backend returns HTTP 202 Accepted immediately.
5. Backend enqueues a Celery task to collect all user data.
6. The Celery task collects (using service role to bypass RLS for the target user):
   - Profile information (JSON)
   - All trades with journal entries (CSV + JSON)
   - All playbooks with criteria (JSON)
   - All trendline detections (JSON)
   - All signals (JSON)
   - Settings and preferences (JSON)
   - API key metadata -- name, prefix, permissions, creation date -- but NO secrets (JSON)
7. Data is packaged into a ZIP file named `trendedge-export-{user_id}-{YYYY-MM-DD}.zip`.
8. ZIP is uploaded to Cloudflare R2 at `exports/{user_id}/{filename}` with a 24-hour TTL.
9. User receives an email: "Your TrendEdge data export is ready. [Download] This link expires in 24 hours."
10. The download link is a signed R2 URL valid for 24 hours.
11. After 24 hours, the file is automatically deleted from R2.

#### Business Rules

- BR-045: Rate limit: 1 export request per 24 hours per user.
- BR-046: Broker credentials are NEVER included in the export.
- BR-047: The export task runs on a Celery worker with service role access.

#### Error Handling

| Error Condition | User-Facing Message |
|----------------|---------------------|
| Export already requested within 24 hours | "You've already requested a data export today. Please try again tomorrow." |
| Export task fails | Email: "Your data export could not be completed. Please try again or contact support." |
| R2 upload fails | Retry up to 3 times. On final failure, notify user via email. |

---

### 2.7 FR-091: Account Deletion (Phase 3)

**Source:** PRD AU-FR-091 | **Phase:** 3 | **Priority:** P0

#### Description

Users can permanently delete their account and all associated data, with a 30-day grace period for recovery.

#### Processing Logic

1. User navigates to `/settings/account` and clicks "Delete my account."
2. System displays a confirmation screen with:
   - "This action is permanent and cannot be undone."
   - "All your data will be deleted, including: trades, journal entries, playbooks, trendlines, broker connections, API keys, and settings."
   - "Active broker connections will be disconnected."
   - "If you have an active subscription, it will be cancelled immediately with no refund for the current billing period."
3. User must type the word "DELETE" (case-sensitive) in a text input to confirm.
4. User must re-authenticate: enter password, or confirm via OAuth re-consent.
5. On confirmation, the system executes the following in order:
   a. Cancel any active subscription via Stripe API [see FSD-009a].
   b. Disconnect all broker connections (revoke OAuth tokens where possible) [see FSD-008c].
   c. Revoke all API keys (`is_active = false`).
   d. Soft-delete the `public.users` row: set `deleted_at = NOW()`.
   e. Sign out all active sessions.
6. Send confirmation email: "Your TrendEdge account has been deleted. If this was a mistake, contact support within 30 days to restore your account."
7. **Grace period (30 days):** All data is retained with `deleted_at` timestamps. The user cannot log in. Support can restore the account by clearing `deleted_at` and re-enabling the `auth.users` row.
8. **After 30 days:** A scheduled Celery task runs daily and hard-deletes all data for accounts where `deleted_at < NOW() - INTERVAL '30 days'`:
   - Hard delete from all tables: trades, journal_entries, playbooks, trendlines, signals, broker_connections, api_keys, audit_logs.
   - Delete avatar from R2 storage.
   - Delete the `public.users` row.
   - Delete the `auth.users` row via Supabase admin API.

#### Business Rules

- BR-048: The word "DELETE" must be typed exactly (case-sensitive, no extra whitespace) to proceed.
- BR-049: Re-authentication is required regardless of how recently the user logged in.
- BR-050: Soft-deleted accounts cannot log in. The login endpoint returns the generic "Invalid email or password" message (no indication of deletion).
- BR-051: Support restoration within the 30-day window re-enables all data and sessions. The user must set a new password.

#### Error Handling

| Error Condition | User-Facing Message |
|----------------|---------------------|
| Confirmation text does not match "DELETE" | "Please type DELETE to confirm." (Submit button disabled) |
| Re-authentication fails | "Incorrect password. Please try again." |
| Stripe cancellation fails | Deletion proceeds anyway. Log error. Manual Stripe cancellation queued for admin. |
| Hard-delete task encounters locked rows | Retry after 1 hour. Alert admin after 3 failures. |

---

## 3. Data Specifications

### 3.1 Users Table

**Table:** `public.users`

| Column | Type | Constraints | Default | Description |
|--------|------|------------|---------|-------------|
| id | UUID | PK, FK -> auth.users(id) ON DELETE CASCADE | N/A | Matches Supabase auth user ID |
| email | TEXT | NOT NULL | from auth | User's email address |
| display_name | TEXT | nullable, 2-50 chars | null | Display name |
| avatar_url | TEXT | nullable | null | R2 URL for avatar image |
| timezone | TEXT | NOT NULL, valid IANA | 'America/New_York' | User's timezone |
| subscription_tier | TEXT | NOT NULL, CHECK IN ('free','trader','pro','team') | 'free' | Current subscription tier |
| settings | JSONB | NOT NULL | See below | User preferences blob |
| role | TEXT | NOT NULL, CHECK IN ('user','admin') | 'user' | Platform role |
| team_id | UUID | nullable, FK -> teams(id) ON DELETE SET NULL | null | Team membership (Phase 3) |
| team_role | TEXT | nullable, CHECK IN ('team_admin','team_member') | null | Role within team (Phase 3) |
| onboarding_completed | BOOLEAN | NOT NULL | false | Whether wizard is complete |
| onboarding_step | INTEGER | NOT NULL | 0 | Last completed wizard step |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | Account creation timestamp |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | Last profile update |
| last_login_at | TIMESTAMPTZ | nullable | null | Most recent login |
| deleted_at | TIMESTAMPTZ | nullable | null | Soft delete timestamp |

### 3.2 Default Settings JSONB

The `settings` column is initialized with the following defaults when a new user is created. Each top-level key corresponds to a preference category managed by this sub-FSD.

```json
{
  "trading_preferences": {
    "default_instruments": [],
    "default_timeframe": "4H",
    "risk_per_trade_percent": 1.0,
    "max_daily_loss": 500.00,
    "max_concurrent_positions": 3,
    "paper_trading_mode": true
  },
  "notification_preferences": {
    "telegram_enabled": false,
    "email_digest": "daily",
    "alert_on_fill": true,
    "alert_on_trendline": true,
    "alert_on_risk_breach": true
  },
  "display_preferences": {
    "theme": "system",
    "currency_display": "USD",
    "date_format": "MM/DD/YYYY",
    "compact_mode": false
  }
}
```

**JSONB Update Semantics:** Profile updates use deep merge via `jsonb_set` or `||` operator. Updating `settings.trading_preferences.risk_per_trade_percent = 2.0` does NOT overwrite `settings.notification_preferences`. Each preference category can be updated independently.

### 3.3 Database Trigger: New User Setup

This trigger fires on new user registration [see FSD-008a for registration flows] and creates the `public.users` row with all default settings.

```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.users (id, email, subscription_tier, settings, role, created_at, updated_at)
  VALUES (
    NEW.id,
    NEW.email,
    'free',
    '{
      "trading_preferences": {
        "default_instruments": [],
        "default_timeframe": "4H",
        "risk_per_trade_percent": 1.0,
        "max_daily_loss": 500.00,
        "max_concurrent_positions": 3,
        "paper_trading_mode": true
      },
      "notification_preferences": {
        "telegram_enabled": false,
        "email_digest": "daily",
        "alert_on_fill": true,
        "alert_on_trendline": true,
        "alert_on_risk_breach": true
      },
      "display_preferences": {
        "theme": "system",
        "currency_display": "USD",
        "date_format": "MM/DD/YYYY",
        "compact_mode": false
      }
    }'::jsonb,
    'user',
    NOW(),
    NOW()
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

**Important:** This trigger runs as `SECURITY DEFINER` to ensure it can insert into the `public.users` table regardless of the calling context. If the trigger fails, the auth user is created but the profile row is missing -- a backend health check detects orphaned auth users and retries the trigger logic within 5 minutes.

### 3.4 Audit Log Events (Profile-Related)

The following audit log event types are generated by the profile and settings subsystem. The `audit_logs` table schema is defined in [FSD-008d].

| Event Type | Trigger | Data Captured |
|-----------|---------|-------------|
| `email_changed` | Email change via FR-020 | user_id, old_email (hashed), new_email (hashed), timestamp |
| `paper_mode_changed` | Paper trading toggle via FR-021 | user_id, old_value, new_value, days_in_paper, timestamp |
| `account_deleted` | Account deletion via FR-091 | user_id, timestamp |

### 3.5 Database Indexes (Profile-Related)

```sql
CREATE INDEX idx_users_deleted_at ON public.users(deleted_at);
CREATE INDEX idx_users_team_id ON public.users(team_id);
```

The `deleted_at` index supports the daily Celery cleanup task that queries for accounts past the 30-day grace period.

---

## 4. API Specifications

### 4.1 GET /api/profile

**Phase:** 1 | **Auth:** Bearer JWT

**Response 200:**
```json
{
  "id": "uuid",
  "email": "user@example.com",
  "display_name": "John Doe",
  "avatar_url": "https://r2.trendedge.io/avatars/uuid.jpg",
  "timezone": "America/New_York",
  "subscription_tier": "free",
  "settings": {
    "trading_preferences": {
      "default_instruments": ["ES", "NQ"],
      "default_timeframe": "4H",
      "risk_per_trade_percent": 1.0,
      "max_daily_loss": 500.00,
      "max_concurrent_positions": 3,
      "paper_trading_mode": true
    },
    "notification_preferences": {
      "telegram_enabled": false,
      "email_digest": "daily",
      "alert_on_fill": true,
      "alert_on_trendline": true,
      "alert_on_risk_breach": true
    },
    "display_preferences": {
      "theme": "system",
      "currency_display": "USD",
      "date_format": "MM/DD/YYYY",
      "compact_mode": false
    }
  },
  "role": "user",
  "onboarding_completed": false,
  "onboarding_step": 0,
  "created_at": "2026-02-11T12:00:00Z",
  "last_login_at": "2026-02-11T12:00:00Z"
}
```

Note: `team_id`, `team_role`, `deleted_at` are omitted from the response if null.

**Response 401:** `{"error": "authentication_required", "message": "Authentication required."}` [see FSD-008a for JWT validation]

---

### 4.2 PATCH /api/profile

**Phase:** 1 | **Auth:** Bearer JWT

**Request (partial update -- any combination of fields):**
```json
{
  "display_name": "Jane Trader",
  "timezone": "America/Chicago",
  "settings": {
    "trading_preferences": {
      "default_instruments": ["ES", "NQ", "CL"],
      "risk_per_trade_percent": 1.5
    }
  }
}
```

**Merge behavior:** The `settings` field uses deep merge. Providing `settings.trading_preferences.risk_per_trade_percent` updates only that field; all other trading preferences and all notification/display preferences are untouched.

**Response 200:** Updated profile object (same schema as GET).

**Response 422 (Validation Error):**
```json
{
  "error": "validation_error",
  "details": [
    {"field": "display_name", "message": "Name must be at least 2 characters."},
    {"field": "settings.trading_preferences.risk_per_trade_percent", "message": "Risk per trade must be between 0.1% and 5.0%."}
  ]
}
```

---

### 4.3 POST /api/profile/avatar

**Phase:** 2 | **Auth:** Bearer JWT | **Content-Type:** multipart/form-data

**Request:** Form data with `file` field containing JPG or PNG image.

**Response 200:**
```json
{
  "avatar_url": "https://r2.trendedge.io/avatars/uuid.jpg"
}
```

**Response 413:** `{"error": "file_too_large", "message": "Image must be under 2MB."}`

**Response 415:** `{"error": "unsupported_media", "message": "Please upload a JPG or PNG image."}`

---

### 4.4 POST /api/profile/test-telegram

**Phase:** 2 | **Auth:** Bearer JWT

**Request:**
```json
{
  "chat_id": "123456789"
}
```

**Response 200:**
```json
{
  "success": true,
  "message": "Test message sent successfully."
}
```

**Response 200 (failure):**
```json
{
  "success": false,
  "message": "Could not reach your Telegram. Please verify the chat ID and ensure you've started the bot."
}
```

---

### 4.5 POST /api/profile/test-discord

**Phase:** 2 | **Auth:** Bearer JWT

**Request:**
```json
{
  "webhook_url": "https://discord.com/api/webhooks/123/abc"
}
```

**Response 200:**
```json
{
  "success": true,
  "message": "Test message sent successfully."
}
```

**Response 200 (failure):**
```json
{
  "success": false,
  "message": "Could not reach your Discord webhook. Please verify the URL."
}
```

---

### 4.6 POST /api/account/export

**Phase:** 3 | **Auth:** Bearer JWT

**Response 202:**
```json
{
  "message": "Your data export is being prepared. You will receive an email when it is ready.",
  "estimated_time": "5-15 minutes"
}
```

**Response 429:**
```json
{
  "error": "rate_limit_exceeded",
  "message": "You've already requested a data export today. Please try again tomorrow.",
  "retry_after": 86400
}
```

---

### 4.7 DELETE /api/account

**Phase:** 3 | **Auth:** Bearer JWT + re-authentication

**Request:**
```json
{
  "confirmation": "DELETE",
  "password": "current-password"
}
```

**Response 200:**
```json
{
  "message": "Your account has been deleted. You have 30 days to contact support if you change your mind."
}
```

**Response 400:** `{"error": "invalid_confirmation", "message": "Please type DELETE to confirm."}`

**Response 401:** `{"error": "invalid_credentials", "message": "Incorrect password. Please try again."}`

---

## 5. UI/UX Specifications

### 5.1 Profile Settings Page (`/settings/profile`)

**Layout:** Settings page with left sidebar navigation (Profile, Trading, Notifications, Display, Brokers, API Keys, Account). Content area on the right.

**Profile section:**
1. Avatar area (top): Circular 200x200 preview with "Upload" button and drag-drop zone. Current avatar or default placeholder icon.
2. Display name input -- placeholder: "Enter your name"
3. Email display (read-only) with "Change email" link (Phase 2). Shows verification badge if verified.
4. Timezone dropdown -- searchable list of IANA timezones, grouped by region. Auto-detected value pre-selected for new users.
5. "Save changes" button -- disabled until a field is modified.

### 5.2 Trading Settings Page (`/settings/trading`)

**Layout:** Same settings shell.

**Trading section:**
1. **Default Instruments** -- Multi-select card grid. Cards show symbol (large), full name (small), exchange. Selected cards have a primary-color border and checkmark.
2. **Default Timeframe** -- Horizontal radio button group: 1H | 4H | D | W. Active option filled with primary color.
3. **Risk Per Trade** -- Slider (0.1% - 5.0%) with numeric input to the right. Slider thumb shows current value.
4. **Max Daily Loss** -- Numeric input with $ prefix. Spinner buttons for $1 increments.
5. **Max Concurrent Positions** -- Numeric input (1-20) with spinner buttons.
6. **Paper Trading Mode** -- Prominent toggle switch with label. When ON: "Paper Trading Mode: Active" in green. When OFF: "Live Trading Mode" in red. Toggle triggers the confirmation flow described in FR-021.
7. "Save changes" button.

### 5.3 Notification Settings Page (`/settings/notifications`)

**Layout:** Same settings shell.

**Channels section:**
1. **Telegram** -- Connection status card showing: connected (green checkmark + chat ID + "Disconnect" button + "Send test" button) or disconnected (setup instructions + "Connect" button).
2. **Discord** -- Connection status card showing: connected (green checkmark + "Disconnect" + "Send test") or disconnected (setup instructions + "Connect" button).
3. **Email Digest** -- Dropdown: None, Daily Summary, Weekly Summary.

**Alert events section:**
4. **Order Fill Alerts** -- Toggle switch. Description: "Get notified when your orders are filled."
5. **Trendline Break Alerts** -- Toggle switch. Description: "Get notified when a monitored trendline breaks."
6. **Risk Breach Alerts** -- Toggle switch (conditionally locked). Description: "Get notified when daily loss limits or position limits are approached." Lock icon + tooltip when live: "Required for live trading."

### 5.4 Paper Trading Mode Banner

**Location:** Top of dashboard, below navigation (and below email verification banner if both apply).

**Color:** Orange background (`#F59E0B`), dark text.

**Content:** "PAPER TRADING MODE -- Trades are simulated. Switch to live in [Settings]."

**Visible when:** `settings.trading_preferences.paper_trading_mode = true`.

**Behavior:** The "[Settings]" link navigates to `/settings/trading`. Banner is full-width, non-dismissible (always visible while in paper mode).

### 5.5 Onboarding Wizard (Phase 3)

**Layout:** Full-screen overlay with progress bar at top. One step visible at a time. Centered content card (max-width 640px).

**Navigation:**
- "Continue" button at bottom right (primary color, full width on mobile).
- "Skip" link at bottom left (subtle, text-only).
- "Back" button on steps 2-4 (top left or bottom left, secondary style).

**Progress bar:** 4 segments, horizontal. Completed steps are filled with primary color. Current step is highlighted. Upcoming steps are gray.

### 5.6 Onboarding Reminder Banner

**Location:** Top of dashboard, below navigation.

**Color:** Blue background, white text.

**Content:** "Complete your setup to get the most out of TrendEdge. [Continue setup]"

**Visible when:** `onboarding_completed = false` AND user has dismissed the wizard.

**Behavior:** Dismissible via an X button. Dismissal stored in `sessionStorage` (reappears next session). "[Continue setup]" navigates to `/onboarding` at `onboarding_step + 1`.

### 5.7 Account Settings Page (`/settings/account`)

**Layout:** Same settings shell.

**Data Export section (Phase 3):**
1. "Export my data" button.
2. Description: "Download all your TrendEdge data as a ZIP file (trades, playbooks, settings, and more)."
3. After clicking: Button changes to "Export in progress..." (disabled) with a spinner.

**Danger Zone (Phase 3):**
1. Red-bordered section at the bottom of the page.
2. "Delete my account" button (red, outline style).
3. Description: "Permanently delete your account and all associated data. This action cannot be undone after 30 days."

---

## 6. Integration Specifications

### 6.1 Cloudflare R2 Integration (Avatars & Exports)

**Provider:** Cloudflare R2
**Environment:** `R2_BUCKET_URL`, `R2_ACCESS_KEY_ID`, `R2_SECRET_ACCESS_KEY`

| Operation | Path | TTL | Content Type |
|-----------|------|-----|-------------|
| Avatar upload | `avatars/{user_id}.{ext}` | Permanent | image/jpeg, image/png |
| Avatar delete | `avatars/{user_id}.{ext}` | N/A | N/A |
| Export upload | `exports/{user_id}/{filename}.zip` | 24 hours | application/zip |

**Error Handling:**

| Error | Response |
|-------|---------|
| Upload failure | Retry up to 3 times with 2-second delay. On final failure: "Upload failed. Please try again." |
| Download link expired | "This download link has expired. Request a new export." |
| R2 service unavailable | Queue upload for retry. Show user: "Your file is being processed. You'll receive an email when it's ready." |

### 6.2 Telegram Bot API Integration

**Purpose:** Test connection for notification setup. Actual notification delivery is handled by [FSD-010b].

**Environment:** `TELEGRAM_BOT_TOKEN`

**Test message endpoint:** `POST https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage`

**Payload:**
```json
{
  "chat_id": "{user_provided_chat_id}",
  "text": "TrendEdge connected successfully! You will receive trading alerts here.",
  "parse_mode": "HTML"
}
```

**Error handling:**
- HTTP 400 (bad request, invalid chat_id): Report as "Could not reach your Telegram."
- HTTP 401 (invalid bot token): Log CRITICAL. Report generic error to user.
- Timeout (>5s): Report as connection failure.

### 6.3 Discord Webhook Integration

**Purpose:** Test connection for notification setup. Actual notification delivery is handled by [FSD-010b].

**Test message endpoint:** `POST {user_provided_webhook_url}`

**Payload:**
```json
{
  "content": "TrendEdge connected successfully! Trading alerts will appear here."
}
```

**Validation:** URL must match regex: `^https://discord\.com/api/webhooks/\d+/.+$`

**Error handling:**
- HTTP 404 (webhook deleted): "Could not reach your Discord webhook."
- HTTP 401 (invalid webhook): "Could not reach your Discord webhook."
- Timeout (>5s): Report as connection failure.

---

## 7. Testing Specifications

### 7.1 Profile CRUD Tests

| Test ID | Test Case | Input | Expected Outcome | Type |
|---------|-----------|-------|-----------------|------|
| T-200 | Get profile | Valid JWT | 200, complete profile with default settings | Automated |
| T-201 | Update display name | `"display_name": "Jane"` | 200, name updated, `updated_at` changed | Automated |
| T-202 | Display name too short | `"display_name": "J"` | 422, "Name must be at least 2 characters" | Automated |
| T-203 | Display name too long | 51-char string | 422, "Name must not exceed 50 characters" | Automated |
| T-204 | Display name invalid chars | `"display_name": "Jane123"` | 422, "Name can only contain letters, spaces, and hyphens" | Automated |
| T-205 | XSS in display name | `"<script>alert('xss')</script>"` | Input sanitized, script not stored/executed | Automated |
| T-206 | Update timezone | `"timezone": "America/Chicago"` | 200, timezone updated | Automated |
| T-207 | Invalid timezone | `"timezone": "Mars/Olympus"` | 422, "Please select a valid timezone" | Automated |
| T-208 | Upload valid avatar | 500x500 JPG, 1MB | 200, avatar resized to 200x200, URL returned | Automated |
| T-209 | Avatar too large | 3MB PNG | 413, "Image must be under 2MB" | Automated |
| T-210 | Avatar wrong format | GIF file | 415, "Please upload a JPG or PNG" | Automated |
| T-211 | Avatar fake extension | .jpg file with PNG magic bytes | Accepted (magic bytes override extension) | Automated |
| T-212 | Avatar corrupt file | Truncated JPEG | 422, "File appears to be corrupted" | Automated |
| T-213 | Default settings on new user | Register user, GET profile | All defaults match section 3.2 | Automated |
| T-214 | Partial settings update | Update only `risk_per_trade_percent` | Only that field changes; all others preserved | Automated |

### 7.2 Trading Preferences Tests

| Test ID | Test Case | Input | Expected Outcome | Type |
|---------|-----------|-------|-----------------|------|
| T-220 | Set default instruments | `["ES", "NQ", "CL"]` | 200, instruments updated | Automated |
| T-221 | Exceed 20 instruments | 21 symbols | 422, "You can select up to 20 default instruments" | Automated |
| T-222 | Invalid instrument symbol | `["INVALID"]` | 422, "Invalid instrument: INVALID" | Automated |
| T-223 | Risk per trade too low | 0.0 | 422, "between 0.1% and 5.0%" | Automated |
| T-224 | Risk per trade too high | 6.0 | 422, "between 0.1% and 5.0%" | Automated |
| T-225 | Max daily loss too low | 10.00 | 422, "between $50 and $50,000" | Automated |
| T-226 | Paper to live -- with live broker | Toggle off, has live broker | 200, `paper_trading_mode = false`, audit logged | Automated |
| T-227 | Paper to live -- no live broker | Toggle off, no live broker | 403, "You need an active live broker connection" | Automated |
| T-228 | Paper to live -- days check | Toggle off, account < 60 days old | Second warning modal displayed with days count | E2E |
| T-229 | Live to paper | Toggle on from live | 200, `paper_trading_mode = true`, no broker check | Automated |
| T-230 | Paper mode audit log | Toggle paper mode | Audit log entry with `paper_mode_changed`, old/new/days | Automated |
| T-231 | Default timeframe update | `"default_timeframe": "D"` | 200, timeframe updated | Automated |
| T-232 | Invalid timeframe | `"default_timeframe": "5M"` | 422, "Please select a valid timeframe" | Automated |

### 7.3 Notification Preferences Tests

| Test ID | Test Case | Input | Expected Outcome | Type |
|---------|-----------|-------|-----------------|------|
| T-240 | Telegram test -- valid chat ID | Numeric chat ID, bot started | 200, `success: true`, test message sent | Automated |
| T-241 | Telegram test -- invalid chat ID | Non-numeric string | 422, "Chat ID must be a numeric value" | Automated |
| T-242 | Telegram test -- bot not started | Valid numeric ID, bot not started | 200, `success: false`, error message | Automated |
| T-243 | Telegram disconnect | Disable telegram | `telegram_enabled = false`, `chat_id` retained | Automated |
| T-244 | Discord test -- valid URL | Valid webhook URL | 200, `success: true`, test message sent | Automated |
| T-245 | Discord test -- invalid URL | Non-Discord URL | 422, "Please enter a valid Discord webhook URL" | Automated |
| T-246 | Disable risk_breach while live | `alert_on_risk_breach: false`, `paper_trading_mode: false` | 422, "Risk breach alerts are required for live trading" | Automated |
| T-247 | Email digest update | `"email_digest": "weekly"` | 200, digest updated | Automated |
| T-248 | Email digest invalid | `"email_digest": "hourly"` | 422, "Please select a valid email digest frequency" | Automated |

### 7.4 Onboarding Wizard Tests (Phase 3)

| Test ID | Test Case | Setup | Expected Outcome | Type |
|---------|-----------|-------|-----------------|------|
| T-260 | Wizard shown for new user | New user, first login | Redirect to `/onboarding` | E2E |
| T-261 | Skip entire wizard | Click "Skip setup" on step 1 | `onboarding_completed = true`, `onboarding_step = 1` | E2E |
| T-262 | Complete step 1 | Enter name + timezone | Data saved, proceed to step 2 | E2E |
| T-263 | Resume wizard | Complete steps 1-2, abandon, return | Resume at step 3 | E2E |
| T-264 | Onboarding banner | Skip wizard, go to dashboard | Banner shown: "Complete your setup" | E2E |
| T-265 | Banner dismissal | Click X on banner | Banner hidden until next session | E2E |
| T-266 | Step 3 paper only | Select "Paper trading only" | Skip to step 4, no broker connection | E2E |
| T-267 | Step 4 preset playbook | Select "A+ Trendline Break" | Playbook created with default criteria | Automated |

### 7.5 Account Lifecycle Tests (Phase 3)

| Test ID | Test Case | Input | Expected Outcome | Type |
|---------|-----------|-------|-----------------|------|
| T-280 | Data export -- success | Click export | 202, Celery task enqueued, email sent with download link | Automated |
| T-281 | Data export -- rate limit | 2nd request in 24h | 429, "already requested today" | Automated |
| T-282 | Export excludes credentials | Download and inspect ZIP | No broker credentials in any file | Automated |
| T-283 | Account deletion -- valid | Type "DELETE", correct password | Soft delete, all sessions ended, confirmation email | Automated |
| T-284 | Account deletion -- wrong text | Type "delete" (lowercase) | 400, "Please type DELETE to confirm" | Automated |
| T-285 | Account deletion -- wrong password | Type "DELETE", wrong password | 401, "Incorrect password" | Automated |
| T-286 | Soft-deleted user login | Attempt login after deletion | 401, "Invalid email or password" (no leak) | Automated |
| T-287 | 30-day hard delete | Soft-deleted 31 days ago | All data hard-deleted, auth.users row removed | Automated |
| T-288 | Restore within 30 days | Support clears `deleted_at` | Account active, user must set new password | Manual |

---

## 8. Performance Specifications

| Operation | Target (p95) | Notes |
|-----------|-------------|-------|
| GET /api/profile | < 50ms | Single row query with RLS |
| PATCH /api/profile | < 100ms | Single row update with JSONB merge |
| POST /api/profile/avatar | < 3s | Includes image resize + R2 upload |
| Telegram test message | < 5s | Depends on Telegram API latency |
| Discord test message | < 5s | Depends on Discord API latency |
| Data export (Celery task) | < 15 min | For accounts with up to 50,000 trades |
| Onboarding wizard step load | < 200ms | Each step is a client-side route change |

---

## 9. Open Questions

| ID | Question | Impact | Decision Needed By |
|----|---------|--------|-------------------|
| Q-001 | Should display preferences support additional date formats (e.g., locale-based)? | Low -- 3 formats cover most users | Phase 2 planning |
| Q-002 | Should the onboarding wizard support re-running from scratch? | Medium -- currently can only resume | Phase 3 planning |
| Q-003 | Should notification preferences include push notifications (browser)? | Medium -- requires service worker setup | Phase 2 planning |
| Q-004 | Should data export support selective export (e.g., trades only)? | Low -- full export covers GDPR requirements | Phase 3 planning |
| Q-005 | Should soft-deleted users' data be anonymized rather than fully hard-deleted? | Medium -- anonymized data useful for aggregate analytics | Phase 3 planning |
