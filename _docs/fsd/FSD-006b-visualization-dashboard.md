# FSD-006b: Visualization & Dashboard

**TrendEdge — AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-006b |
| Source | FSD-006 (Performance Analytics) |
| Title | Visualization & Dashboard |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-12 |

**Sibling Sub-FSDs:**
- [FSD-006a: Metrics Engine](/docs/fsd/FSD-006a-metrics-engine.md) — Core metrics calculation, risk-adjusted ratios, R-multiples, time-based, execution quality, behavioral, trendline metrics
- **FSD-006b: Visualization & Dashboard** (this document)
- [FSD-006c: Advanced Analytics (Pro Tier)](/docs/fsd/FSD-006c-advanced-analytics.md) — Monte Carlo, strategy correlation, walk-forward, advanced drawdown, AI insights, comparative analytics

---

## 1. Introduction

### 1.1 Purpose

This document specifies the complete frontend visualization layer for the TrendEdge Performance Analytics Dashboard. It defines the dashboard layout, responsive grid system, widget behavior and states, all chart visualizations, the interactive filtering system, real-time WebSocket updates, and the CSV/PDF export system. A developer should be able to implement the entire dashboard UI using only this document (plus the API contracts from FSD-006a for data shapes).

### 1.2 Scope

This FSD covers:

- Dashboard page shell, routing, and responsive grid layout (desktop, tablet, mobile)
- Widget system: states (loading, loaded, empty, error, locked), interactions (expand/collapse, full-screen, tooltips)
- Dashboard customization: drag-and-drop reordering, hide/show widgets, layout presets
- All chart visualizations: equity curve, P&L calendar heatmap, R-distribution histogram, win rate by dimension, MAE/MFE scatter plots, drawdown chart, time analysis, session analysis, execution quality dashboard, behavioral metrics dashboard, trendline analytics dashboard
- Interactive filtering system with URL persistence (date range, instrument, playbook)
- Real-time WebSocket updates for live dashboard refresh
- CSV and PDF export system
- Tier-based feature gating (frontend enforcement, locked widget UI)
- Accessibility and dark mode

This FSD does NOT cover:

- Metrics calculation logic, formulas, or edge cases (see FSD-006a)
- Advanced analytics computations: Monte Carlo, correlation matrix, walk-forward, AI insights (see FSD-006c)
- Trade execution pipeline (see FSD-003)
- Trade journaling workflows (see FSD-004)
- Playbook creation/management (see FSD-005)

### 1.3 Architecture Context

| Layer | Technology | Role |
|---|---|---|
| Frontend | Next.js 14+ (App Router) + TypeScript + Tailwind + shadcn/ui | Dashboard shell, layout, filters, responsive design |
| Charting | Recharts (standard charts) + D3.js (custom visualizations) | Equity curves, histograms, scatter plots, heatmaps, calendar |
| State Management | React Query (TanStack Query) | Server state, caching, refetch on filter change |
| Real-time | WebSocket client | Live metric updates on trade close |
| Export | Server-side PDF (WeasyPrint/Playwright), client/server CSV | Report generation and data export |
| Hosting | Vercel (frontend) | Production deployment |

### 1.4 Data Dependencies

All visualizations consume data from the API endpoints defined in FSD-006a. This document specifies how data is presented, not how it is calculated.

| Data Source | API Endpoint | Consumed By |
|---|---|---|
| Summary metrics | `GET /api/v1/analytics/summary` | Summary stat cards |
| Equity curve series | `GET /api/v1/analytics/equity-curve` | Equity curve chart |
| Calendar heatmap data | `GET /api/v1/analytics/calendar` | P&L calendar heatmap |
| Calendar drill-down | `GET /api/v1/analytics/calendar/{date}` | Calendar day detail panel |
| R-distribution bins | `GET /api/v1/analytics/r-distribution` | R-multiple histogram |
| Win rate segments | `GET /api/v1/analytics/win-rate/{dimension}` | Win rate by dimension chart |
| MAE/MFE scatter data | `GET /api/v1/analytics/mae-mfe` | MAE/MFE scatter plots |
| Drawdown series | `GET /api/v1/analytics/drawdown` | Drawdown chart |
| Time analysis data | `GET /api/v1/analytics/time-analysis` | Time analysis charts |
| Session comparison | `GET /api/v1/analytics/session` | Session analysis |
| Execution quality | `GET /api/v1/analytics/execution-quality` | Execution quality dashboard |
| Behavioral metrics | `GET /api/v1/analytics/behavioral` | Behavioral metrics dashboard |
| Trendline analytics | `GET /api/v1/analytics/trendline` | Trendline analytics dashboard |
| WebSocket updates | `wss://{api_domain}/ws/analytics` | Real-time dashboard refresh |
| PDF export | `POST /api/v1/analytics/export/pdf` | PDF report generation |
| CSV export | `GET /api/v1/analytics/export/csv` | CSV data download |

---

## 2. Page Shell & Routing

### 2.1 Route Configuration

- URL: `/dashboard/analytics`
- Page title: `"Performance Analytics | TrendEdge"`
- Breadcrumb: Dashboard > Analytics
- Next.js App Router: `app/dashboard/analytics/page.tsx`

### 2.2 Visual Design System

- Design system: shadcn/ui with TrendEdge color palette
- Body font: Inter
- Metric value font: JetBrains Mono (monospace for numbers)
- Dark mode: supported. All colors have dark mode variants.

**Metric Card Design:**
- Background: white (dark: `gray-900`)
- Border: 1px `border-gray-200` (dark: `border-gray-700`)
- Corners: `rounded-lg`
- Shadow: `shadow-sm`
- Label: `text-gray-500`, `text-sm`
- Value: `text-gray-900` (dark: `text-gray-50`), large bold font
- Delta indicator: green up arrow for positive change, red down arrow for negative

**Chart Design:**
- Background: white (dark: `gray-900`)
- Grid lines: `gray-100` (dark: `gray-700`)
- Axis labels: `text-gray-500`, `text-xs`

---

## 3. Dashboard Layout

### 3.1 Desktop Layout (1280px+)

The dashboard uses a 12-column CSS grid.

| Row | Content | Grid Columns | Priority |
|---|---|---|---|
| Row 0 | Filter Bar | Full width (12 cols) | Critical — loads first |
| Row 1 | Summary Stat Cards: Total Net P&L, Win Rate, Profit Factor, Average R, Max Drawdown, Tiltmeter Score | 6 equal columns (~200px min each) | Critical — loads first |
| Row 2 | Equity Curve Chart | Full width (12 cols) | Critical — loads first |
| Row 3 | P&L Calendar Heatmap (8 cols) + R-Multiple Histogram (4 cols) | 2:1 ratio | Above-the-fold |
| Row 4 | Win Rate by Dimension (6 cols) + Time Analysis (6 cols) | 1:1 ratio | Lazy-loaded |
| Row 5 | MAE/MFE Scatter (6 cols) + Drawdown Chart (6 cols) | 1:1 ratio | Lazy-loaded |
| Row 6 | Execution Quality (4 cols) + Behavioral Metrics (4 cols) + Trendline Analytics (4 cols) | 1:1:1 ratio | Lazy-loaded |

### 3.2 Tablet Layout (768px-1279px)

- Two-column grid
- Summary cards wrap to 3 columns x 2 rows
- All 2-column chart rows stack to full-width single column
- Row 6 widgets stack vertically

### 3.3 Mobile Layout (<768px)

- Single-column stack
- Summary cards: horizontally scrollable carousel with snap scrolling. Each card 280px wide with 12px gap.
- Charts render at full viewport width with height reduced by 30%
- Interactive elements use tap instead of hover
- Touch targets: minimum 44x44px
- No horizontal scrolling on the page body (data tables scroll horizontally within their container)

### 3.4 Loading Strategy

- **Priority fetch:** Above-the-fold widgets (rows 0-2: filter bar, summary cards, equity curve) loaded with initial page render.
- **Lazy loading:** Below-the-fold widgets loaded when scrolled into view using `IntersectionObserver` with 200px root margin.
- **Page-level loading:** Show filter bar skeleton + 6 summary card skeletons + equity curve skeleton on initial load.
- **Widget-level loading:** On filter changes, individual skeleton per widget. Already-loaded widgets remain visible until new data arrives, then transition with a 200ms fade.

---

## 4. Widget System

### 4.1 Widget States

Every widget MUST implement all five states:

| State | Visual | Trigger |
|---|---|---|
| Loading | Skeleton loader (animated pulse placeholder matching widget dimensions) | Initial load, filter change |
| Loaded | Full data rendering | API response received |
| Empty | Centered icon + message (see Section 4.2) | API returns 0 results |
| Error | Red-tinted background, error icon, message text, "Retry" button | API error or timeout |
| Locked (Free tier) | Blurred screenshot of widget with centered overlay: lock icon + "Upgrade to Trader to unlock [widget name]" button | User is on Free tier and widget requires Trader+ |

### 4.2 Empty State Messages

| Context | Message | Icon |
|---|---|---|
| No trades at all | "Complete your first trade to see your analytics. Your performance dashboard will populate automatically as you close trades." | Empty chart with sparkle icon |
| No trades match filters | "No trades match the selected filters. Try adjusting the date range or removing instrument filters." | Filter icon with X mark |
| No journal data | "No journal data available. Complete journal entries for your trades to enable behavioral analytics." | Journal icon with plus sign |
| No trendline data | "No trendline data available. Trades must be auto-classified from the trendline engine to enable this analysis." | Trendline icon with question mark |
| Insufficient data for metric | "[Metric name] requires at least [N] [data points]. You currently have [M]." | Information icon |

### 4.3 Error State Messages

| Context | Message | Action |
|---|---|---|
| API error (500) | "Something went wrong loading your analytics. Our team has been notified." | "Try Again" button |
| Network error | "Unable to connect to the analytics service. Check your internet connection." | "Retry" button |
| Timeout | "Loading is taking longer than expected. This may be due to a large dataset." | "Retry" button + "Try narrower filters" suggestion |
| WebSocket disconnect | "Connection lost — reconnecting..." | Auto-reconnect with countdown |

### 4.4 Widget Interactions

**Expand/Collapse:**
- Click the chevron icon in the widget header to toggle between compact (shows key metric only) and expanded (shows full chart/table) view.
- Default: expanded for above-the-fold widgets (rows 1-3), collapsed for below-the-fold on mobile.

**Full-Screen Mode:**
- Click the expand icon (arrows pointing outward) in the widget header.
- Opens the chart in a modal overlay at full viewport dimensions.
- Press Escape or click the X button to close.
- Full-screen mode adds enhanced detail: additional axis labels, gridlines, and a data table below the chart.

**Tooltips:**
- Desktop: hover over any data point to see detail values in a floating tooltip positioned above the cursor. Tooltip appears after 200ms hover delay and hides 100ms after mouse leaves.
- Mobile: tap a data point to show tooltip as a fixed popover. Tap elsewhere to dismiss.
- Tooltip display latency: <50ms from hover event to tooltip render.

---

## 5. Dashboard Customization (Trader Tier+)

### 5.1 Drag-and-Drop Reordering

- User clicks and holds the drag handle (6-dot grid icon) in the widget header, then drags to a new position.
- Drop zones highlighted with blue dashed border during drag.
- Reorder persists to layout storage.

### 5.2 Hide/Show Widgets

- Settings gear icon in widget header opens a dropdown with "Hide this widget" option.
- Hidden widgets are accessible from a "Hidden Widgets" tray at the bottom of the dashboard.
- Clicking a widget in the tray restores it to its last position.

### 5.3 Layout Presets

**Save Layout:**
- "Save Layout" button in the dashboard header.
- Modal: text input for preset name (1-50 characters, alphanumeric + spaces), "Save" and "Cancel" buttons.
- Preset limit: 5 for Trader tier, unlimited for Pro/Team.
- Exceeding limit: "Maximum 5 layout presets reached. Delete an existing preset to save a new one."

**Load Layout:**
- Dropdown in dashboard header listing saved presets.
- Selecting a preset immediately applies the layout.

**Reset to Default:**
- "Reset Layout" button confirms with dialog: "Reset dashboard to default layout? This does not delete your saved presets."
- Buttons: "Reset" (primary) and "Cancel".

### 5.4 Layout Storage

Stored in `dashboard_layouts` table (PostgreSQL via Supabase):

| Column | Type | Description |
|---|---|---|
| id | UUID | PK, generated |
| user_id | UUID | FK to `users.id` |
| name | VARCHAR(50) | Preset name |
| layout_json | JSONB | Widget positions and visibility |
| is_active | BOOLEAN (default false) | Currently active preset |
| created_at | TIMESTAMPTZ | Creation timestamp |
| updated_at | TIMESTAMPTZ | Last update timestamp |

- Unique constraint: `(user_id, name)`
- RLS: `auth.uid() = user_id`

Layout JSON schema:

```json
{
  "presets": [
    {
      "name": "My Layout",
      "layout": [
        { "widget_id": "equity_curve", "row": 2, "col_start": 0, "col_span": 12, "visible": true },
        { "widget_id": "calendar_heatmap", "row": 3, "col_start": 0, "col_span": 8, "visible": true }
      ],
      "created_at": "2026-02-01T10:00:00Z"
    }
  ],
  "active_preset": "My Layout"
}
```

---

## 6. Filtering System

### 6.1 Date Range Filter (AN-FR-011)

**Source:** PRD-006 Section 3.3

| Preset | URL Parameter | Date Calculation |
|---|---|---|
| Today | `?range=today` | `start = today 00:00:00, end = today 23:59:59` |
| 7 Days | `?range=7d` | `start = today - 6 days, end = today` |
| 30 Days (default) | `?range=30d` | `start = today - 29 days, end = today` |
| 90 Days | `?range=90d` | `start = today - 89 days, end = today` |
| YTD | `?range=ytd` | `start = Jan 1 of current year, end = today` |
| All Time | `?range=all` | `start = first trade date, end = today` |
| Custom | `?start=YYYY-MM-DD&end=YYYY-MM-DD` | User-selected via date picker |

- Default on first load (no URL params): 30 Days.
- Date picker: shadcn/ui Calendar component. Click to select start date, click to select end date. Visual highlight on the selected range.
- Validation: start date must be <= end date. Start date must not be before user's first trade date. End date must not be in the future (clamp to today).
- Display: Selected range shown in the filter bar as text, e.g., "Jan 12 - Feb 11, 2026" for custom, or "Last 30 Days" for presets.

### 6.2 Instrument Filter (AN-FR-012)

- Multi-select dropdown with search/filter capability.
- Dynamically populated from user's distinct instruments (e.g., `"CL - Crude Oil"`, `"GC - Gold"`, `"MES - Micro E-mini S&P 500"`).
- Default: all instruments selected.
- "Select All" and "Clear All" buttons.
- Active filters shown as dismissible chips below the filter bar. Click X on a chip to deselect.
- URL parameter: `?instruments=CL,GC,MES` (comma-separated).

### 6.3 Playbook Filter (AN-FR-013)

- Multi-select dropdown.
- Populated from user's playbooks with trade counts: `"A+ Trendline Break (47)"`, `"Standard Break (32)"`, `"Bounce (28)"`.
- Includes `"Untagged (14)"` option for trades not assigned to any playbook.
- Default: all playbooks selected (including Untagged).
- URL parameter: `?playbooks=uuid1,uuid2,untagged` (comma-separated UUIDs, `"untagged"` literal for untagged trades).

### 6.4 Combined Filter Logic (AN-FR-014)

- All filters apply simultaneously with AND logic: date range AND instrument AND playbook.
- Trade count indicator in filter bar: "Showing 23 of 156 trades".
- If 0 trades match: all widgets enter EMPTY state.
- "Clear All Filters" button resets to: `range=30d`, all instruments, all playbooks.
- Filter changes debounced by 300ms before triggering API call.
- Filter state persists across page refreshes via URL query parameters.
- Changing filters cancels any in-flight API requests (AbortController) before sending the new request.

---

## 7. Chart Visualizations

### 7.1 Equity Curve (AN-FR-015)

**Chart library:** Recharts `<LineChart>`

**Axes:**
- X-axis: trade exit dates
- Y-axis: cumulative P&L in dollars

**Styling:**
- Line color: segment-based. Green (`#22C55E`) when cumulative P&L > 0, red (`#EF4444`) when < 0. Color transition at the $0 crossing point.
- Gradient fill below line: green gradient (0.3 opacity at line, 0 at zero line) for positive area, red gradient for negative area.
- Benchmark line: dashed gray horizontal line at $0 (breakeven), labeled "Breakeven".

**Tooltip:**
```json
{
  "date": "Feb 11, 2026",
  "cumulative_pnl": "$15,420.50",
  "daily_pnl": "+$320.00",
  "trade_count": 3
}
```

**Annotations:**
- Clickable diamond markers at max drawdown start (red diamond) and end (green diamond).
- Largest single-day P&L marked with gold star.
- Click opens a detail panel with the relevant trades.

**Zoom:**
- Click-and-drag on chart area to select a date range. Selected area highlighted in blue (0.1 opacity).
- Release to zoom.
- Double-click anywhere to reset zoom to full range.

**Real-time update:**
- When a WebSocket `trade_closed` event arrives, append a new data point with smooth animation (300ms ease-out transition).

**States:**
- Empty: "Complete your first trade to see your equity curve" with placeholder illustration.
- Single data point: render as a single dot with tooltip. No line drawn.

### 7.2 P&L Calendar Heatmap (AN-FR-016)

**Layout:** GitHub-style grid. Weeks as columns, days (Mon-Sun) as rows.

**Color Scale (5-step diverging):**

| Percentile | Color | Hex |
|---|---|---|
| Worst 10% of days | Dark red | `#991B1B` |
| 10th-40th percentile (losses) | Light red | `#FCA5A5` |
| No trades that day | White/light gray | `#F3F4F6` |
| 60th-90th percentile (winners) | Light green | `#86EFAC` |
| Top 10% of days | Dark green | `#166534` |

**Cell size:** 14x14px desktop, 12x12px mobile.

**Tooltip (hover/tap):**
```json
{
  "date": "Mon, Jan 15 2026",
  "net_pnl": "+$850.00",
  "trade_count": 4,
  "win_rate": "75.0%"
}
```

**Click Drill-Down:**
- Opens a slide-over panel listing trades for that day.
- Columns: instrument, direction (Long/Short), playbook name, P&L (green/red colored), R-multiple.
- Each trade row links to its journal entry. [Cross-reference: FSD-004]

**Navigation:**
- Left/right arrows to scroll months.
- Default view: current month + previous 11 months.

**Summary Row:**
- Monthly totals below the calendar grid: net P&L, trade count, win rate per month.

### 7.3 R-Multiple Distribution Histogram (AN-FR-017)

**Chart library:** Recharts `<BarChart>`

**Axes:**
- X-axis: R-multiple bins. Default bin width: 0.5R. Configurable: 0.25R, 0.5R, 1.0R via dropdown.
- Y-axis: trade count.

**Styling:**
- Bar color: red (`#EF4444`) for bins with negative R center, green (`#22C55E`) for positive.
- Overlay lines: vertical dashed line at average R (blue `#3B82F6`, labeled), vertical dashed line at median R (purple `#8B5CF6`, labeled).

**Tooltip:**
```json
{
  "r_range": "1.0R to 1.5R",
  "trade_count": 18,
  "pct_of_total": "11.5%"
}
```

**Click Interaction:**
- Click on a bin filters a trade list panel below the histogram showing only trades in that R range.

**Summary Stats (above chart):**
- Average R, Median R, Std Dev, Skewness (all 2 decimal places).
- Note: "N trades excluded (no stop loss defined)" when applicable.

### 7.4 Win Rate by Dimension (AN-FR-018)

**Sub-views:** Six views selectable via tab strip:
- By Instrument
- By Day of Week
- By Hour
- By Playbook
- By Month
- By Setup Type

**Metric toggle:** "Win Rate" (default), "Average R", "Net P&L" — switches the Y-axis metric.

**Bar labels:** Each bar shows the metric value and trade count, e.g., `"62.5% (n=32)"`.

**Low sample size:** Bars with fewer than 5 trades rendered with hatched pattern overlay and tooltip: "Low sample size — interpret with caution."

**Sorting:**
- By Instrument and By Playbook: sorted by trade count descending.
- By Day/Hour/Month: natural chronological order.

### 7.5 MAE/MFE Scatter Plots (AN-FR-019)

**Layout:** Two scatter plots side by side (desktop) or stacked (mobile).

**Dot styling:**
- Size: 8px
- Green (`#22C55E`) for winners, red (`#EF4444`) for losers

**Toggle:** Switch X/Y axes between R-multiples and ticks/dollars.

**MAE Scatter:**
- X-axis: MAE. Y-axis: trade outcome.
- Vertical reference line at 1R (current stop distance).
- Insight box below chart (from API `mae_mfe_insights`).

**MFE Scatter:**
- X-axis: MFE. Y-axis: trade outcome.
- Diagonal reference line from origin (MFE = outcome, i.e., 100% capture).
- Insight box below chart.

**Combined Table:**
- Sortable columns: date, instrument, playbook, entry, exit, MAE ticks, MAE $, MFE ticks, MFE $, outcome R, outcome $.
- Toggle to show winners only / losers only / all.
- Data flagging: values where `mae_source = 'bar'` display with "estimated" badge and tooltip: "This value is estimated from bar data. Tick-level data was unavailable for this trade."

### 7.6 Drawdown Chart (AN-FR-020)

**Chart library:** Recharts `<AreaChart>`

**Axes:**
- X-axis: date
- Y-axis: drawdown from peak (displayed as positive numbers, e.g., "5%" not "-5%")

**Styling:**
- Fill: red gradient, darker for deeper drawdowns.

**Tooltip:**
```json
{
  "date": "2026-01-12",
  "drawdown_dollars": "$2,400.00",
  "drawdown_pct": "8.3%",
  "days_since_peak": 7,
  "current_equity": "$26,600.00",
  "peak_equity": "$29,000.00"
}
```

**Annotations:**
- Marker at each trough showing drawdown depth and recovery time (or "Ongoing").

**Table Below Chart:**
- Columns: #, Start Date, Trough Date, Recovery Date, Depth ($), Depth (%), Duration (days), Recovery (days).
- Lists all drawdown periods.

### 7.7 Time Analysis Charts (AN-FR-021)

**Sub-views via tab strip:** By Hour, By Day of Week, By Month.

**Dual axis:**
- Bar height = net P&L (left Y-axis)
- Overlaid line = trade count or win rate (right Y-axis)

**Bar colors:** Green for net positive, red for net negative.

**Month view toggle:** "Calendar Year" (all Januaries combined) vs. "Chronological" (Jan 2025, Feb 2025, ...).

### 7.8 Session Analysis (AN-FR-022)

**Side-by-side metric table:** RTH vs. Overnight
- Metrics: Trade Count, Win Rate, Net P&L, Average R, Profit Factor, Average Slippage

**Equity Curve Overlay:**
- Below table: overlaid equity curves.
- RTH = blue (`#3B82F6`), Overnight = orange (`#F97316`).

**Insight Callout:**
- Auto-generated when one session outperforms (>5% win rate difference or >25% P&L difference).
- Example: "Your RTH trades outperform overnight by $9,579.50 (8.6% higher win rate)."

### 7.9 Execution Quality Dashboard (AN-FR-023)

**Components:**

1. **Slippage Distribution Histogram:** Bar chart of slippage in ticks. Red bars for unfavorable, green for favorable.

2. **Slippage Over Time:** Rolling 20-trade window line chart. Red shading when trend is increasing (linear regression slope > 0 over last 40 trades).

3. **Fill Quality Score Gauge:** Circular gauge 0-100 with color zones:
   - 80-100: "Excellent" (green)
   - 60-79: "Good" (blue)
   - 40-59: "Fair" (yellow)
   - 0-39: "Poor" (red)

4. **Slippage by Instrument Table:** Sortable columns: instrument, avg slippage (ticks), avg slippage ($), trade count.

5. **Slippage by Order Type:** Market vs. limit comparison.

### 7.10 Behavioral Metrics Dashboard (AN-FR-024)

**Components:**

1. **Tiltmeter Gauge:** Circular gauge with 4 color zones, current score as large centered number, zone label below.
   - Color zones: 0-25 green (`#22C55E`, "Disciplined"), 26-50 yellow (`#F59E0B`, "Caution"), 51-75 orange (`#F97316`, "Elevated Risk"), 76-100 red (`#EF4444`, "Tilt").

2. **Rule Compliance Trend:** Line chart, rolling 20-trade windows.

3. **Cost of Mistakes Waterfall:** Horizontal bars sorted by absolute cost descending. Each bar labeled with mistake type and dollar amount.

4. **Mistake Frequency Donut Chart:** Proportional segments per mistake type.

5. **Conviction vs. Outcome Scatter:** X = conviction (1-5), Y = R-multiple. Pearson r value displayed.

6. **Emotional State P&L:** Bar chart per emotional state. Green/red bars for positive/negative net P&L.

### 7.11 Trendline Analytics Dashboard (AN-FR-025)

**Components:**

1. **Win Rate by Touch Count:** Bar chart. Segments: 2, 3, 4, 5+ touches.

2. **Edge by Slope Angle:** Bar chart. Segments: 0-15, 15-30, 30-45, 45+ degrees.

3. **Performance by Duration:** Bar chart. Segments: <7 days, 7-21 days, 21-56 days, 56+ days.

4. **Performance by Candle Spacing:** Bar chart. Segments: <6, 6-10, 10-20, 20+ candles.

5. **Grade Comparison:** Side-by-side metric cards for A+, A, B grades showing win rate, avg R, profit factor.

6. **Setup Type Comparison:** Side-by-side metric cards for Break vs. Bounce.

**Statistical Significance Badges:** Displayed on each segment bar.
- >= 30 trades: "High Confidence (n=N)" — full opacity
- 10-29 trades: "Moderate Confidence (n=N)" — full opacity
- < 10 trades: "Low Confidence (n=N)" — semi-transparent or hatched bar with tooltip: "Small sample size — interpret with caution."

---

## 8. Chart Rendering Performance

### 8.1 Rendering Targets

- All charts render within 500ms after data is received by the frontend.
- Chart animations (transitions, tooltips): 60fps target. Use `requestAnimationFrame`. No layout thrashing during animations.
- Tooltip display latency: <50ms from hover event to tooltip render.

### 8.2 Large Dataset Optimization

- Datasets exceeding 5,000 data points: apply Largest Triangle Three Buckets (LTTB) downsampling algorithm to reduce to 1,000 points while preserving visual shape.
- Datasets exceeding 1,000 points: use canvas rendering (Recharts canvas mode or D3 canvas) instead of SVG.

### 8.3 Bundle Size

- Recharts and D3.js should be loaded via dynamic imports (`next/dynamic`) to avoid blocking initial page load.
- Chart components for below-the-fold widgets should be code-split and lazy-loaded.

---

## 9. Real-Time WebSocket Updates (AN-FR-035)

### 9.1 Connection

- Endpoint: `wss://{api_domain}/ws/analytics`
- Authentication: JWT token sent as query parameter: `wss://{api_domain}/ws/analytics?token={jwt}`

### 9.2 Message Types

**Server -> Client:**

| Type | Payload | Trigger |
|---|---|---|
| `trade_closed` | Updated metrics + new equity curve point | New trade closes |
| `tier_changed` | `{ "new_tier": "pro" }` | User upgrades/downgrades subscription |
| `ping` | `{}` | Every 30 seconds (heartbeat) |

**Client -> Server:**

| Type | Payload | Trigger |
|---|---|---|
| `pong` | `{}` | Response to server ping |
| `token_refresh` | `{ "token": "{new_jwt}" }` | JWT about to expire |

### 9.3 Trade Closed Update Payload

```json
{
  "type": "trade_closed",
  "trade_id": "uuid",
  "timestamp": "2026-02-11T14:30:00Z",
  "updates": {
    "net_pnl": 15420.50,
    "win_rate": 63.2,
    "total_trades": 156,
    "profit_factor": 1.87,
    "equity_curve_point": { "date": "2026-02-11", "cumulative_pnl": 15420.50 },
    "tiltmeter": 22
  }
}
```

### 9.4 Frontend Update Animations

- Number fields use count-up animation (400ms duration).
- Equity curve extends with smooth line animation (300ms ease-out transition).
- "Last Updated" timestamp in dashboard header, e.g., "Last updated: 2:30 PM ET".

### 9.5 Reconnection Strategy

- On disconnect: show banner "Connection lost — reconnecting..." (yellow background).
- Exponential backoff: 1s, 2s, 4s, 8s, 16s, max 30s between attempts.
- On reconnection: fetch full state via REST API to ensure consistency, then dismiss banner.

### 9.6 Heartbeat

- Server sends `{ "type": "ping" }` every 30 seconds.
- Client responds with `{ "type": "pong" }`.
- If no ping received for 60 seconds, client initiates reconnection.

### 9.7 Token Expiry During Session

- If JWT expires during active WebSocket session and no refresh is received within 60 seconds, server closes connection with code 4401 and reason "Token expired".
- Client should proactively send `token_refresh` before expiry.

### 9.8 Tier Change Handling

- When `tier_changed` event received, frontend immediately unlocks/locks features without page reload.
- Newly available widgets transition from locked (blurred) to loaded state.
- Downgraded features immediately show locked state.

---

## 10. Export System

### 10.1 PDF Export (AN-FR-033)

**Trigger:** "Export PDF" button in dashboard header.

**User Confirmation Dialog:**
- Message: "Generate PDF report for [date range] with current filters applied?"
- Buttons: "Generate Report" and "Cancel"

**Progress Indicator (determinate progress bar):**
1. "Preparing data..." (20%)
2. "Rendering charts..." (50%)
3. "Generating PDF..." (80%)
4. "Finalizing..." (95%)

**Server-Side Generation:**
- Engine: WeasyPrint or Playwright PDF
- Maximum generation time: 30 seconds

**Report Sections:**
1. Cover Page (logo, user name, date range, generation timestamp)
2. Executive Summary (key metrics)
3. Equity Curve
4. P&L Calendar
5. Performance Breakdown tables
6. Charts (R-histogram, MAE/MFE, drawdown, time analysis)
7. Trendline Analytics (if applicable)
8. Advanced Analytics (Pro tier, if applicable) [Cross-reference: FSD-006c]

**File Naming:** `TrendEdge_Performance_Report_2026-02-11_30d.pdf`

**Download:** Link available for 24 hours. Stored in Cloudflare R2 with signed URL.

**Tier Limits:**
- Free: locked
- Trader: 2 PDF exports per billing cycle
- Pro/Team: unlimited
- Exceeding Trader limit: "You've used 2 of 2 PDF exports this month. Upgrade to Pro for unlimited exports. Your limit resets on [billing cycle date]."

**Error:** Generation timeout shows toast: "PDF generation failed. Please try again or use CSV export as an alternative."

**Target File Size:** <5MB for standard report, <10MB for report with all Pro-tier sections.

### 10.2 CSV Export (AN-FR-034)

**Three export types via dropdown:**
1. "Complete Trade List" — all filtered trades with full column set
2. "Daily P&L Summary" — daily aggregated P&L
3. "Metric Summary" — computed metrics snapshot

**Encoding:** UTF-8 with BOM for Excel compatibility.

**Maximum rows:** 50,000. If exceeded: "Export limited to 50,000 rows. Apply filters to reduce the dataset."

**Respects current filter selections.**

**Generation:**
- Client-side for small datasets (<1,000 rows)
- Server-side for larger datasets

**Tier:** Trader+ (locked for Free tier)

### 10.3 Export Storage

| Column | Type | Description |
|---|---|---|
| id | UUID | PK, generated |
| user_id | UUID | FK to `users.id` |
| file_type | VARCHAR(4) | `'pdf'` or `'csv'` |
| file_name | VARCHAR(255) | Generated file name |
| storage_url | TEXT | Cloudflare R2 signed URL |
| filters_applied | JSONB | Filter state used for export |
| file_size_bytes | INTEGER | File size |
| expires_at | TIMESTAMPTZ | 24 hours after creation |
| created_at | TIMESTAMPTZ | Generation timestamp |

- RLS: `auth.uid() = user_id`
- Cleanup: scheduled job deletes expired files from R2 and removes DB rows.

### 10.4 Export Security

- Export download URLs are signed with a time-limited token (24-hour expiry).
- Signature format: `https://r2.trendedge.com/exports/{uuid}.pdf?token={hmac_signature}&expires={unix_timestamp}`
- Signature computation: `HMAC-SHA256(secret_key, "{export_id}:{user_id}:{expires_timestamp}")`
- Export URLs use UUID-based keys (non-sequential, non-enumerable).
- Expired URL: HTTP 403 with "This download link has expired. Generate a new export from your dashboard."
- Invalid signature: HTTP 403 with "Invalid download link." Attempt logged with IP address.

---

## 11. Tier-Based Feature Gating

### 11.1 Feature Access Matrix

| Feature | Free | Trader ($49/mo) | Pro ($99/mo) | Team ($199/mo) |
|---|---|---|---|---|
| 5 basic metrics (Net P&L, Win Rate, Total Trades, Avg Winner, Avg Loser) | Yes | Yes | Yes | Yes |
| Basic equity curve (no annotations/zoom) | Yes | Yes | Yes | Yes |
| Full 25+ metrics | Locked | Yes | Yes | Yes |
| All chart visualizations | Locked | Yes | Yes | Yes |
| Date/instrument/playbook filters | Locked | Yes | Yes | Yes |
| Calendar heatmap with drill-down | Locked | Yes | Yes | Yes |
| Dashboard customization | Locked | Yes (5 presets) | Yes (unlimited) | Yes (unlimited + shared) |
| CSV export | Locked | Yes | Yes | Yes |
| PDF export | Locked | 2/month | Unlimited | Unlimited |

**Note:** Advanced analytics features (Monte Carlo, AI insights, etc.) are gated separately in FSD-006c.

### 11.2 Frontend Enforcement

- Locked widgets: CSS `filter: blur(8px)` with centered overlay containing lock icon and "Upgrade to [required tier] to unlock [feature name]" CTA button.
- CTA button navigates to `/settings/billing`.

### 11.3 Backend Enforcement

- API endpoints check `user.subscription_tier` before processing.
- Insufficient tier returns HTTP 403:
```json
{
  "error": "forbidden",
  "message": "This feature requires the [tier] plan.",
  "required_tier": "[tier]",
  "upgrade_url": "/settings/billing"
}
```

### 11.4 Usage Counters

**PDF Export Counter:**
- Stored in `user_usage.pdf_exports_this_cycle`.
- Incremented on successful PDF generation.
- Reset on billing cycle date.
- Checked before generation starts.

**Layout Preset Counter:**
- Trader: max 5 presets. Attempting 6th: "Maximum 5 layout presets reached. Delete an existing preset to save a new one."
- Pro/Team: unlimited.

### 11.5 Mid-Session Tier Changes

- **Upgrade:** WebSocket `tier_changed` event triggers frontend to unlock newly available features without page reload.
- **Downgrade:** Features lock immediately. Cached data from higher-tier features becomes inaccessible. No data deletion; features re-unlock on re-upgrade.

---

## 12. Accessibility

### 12.1 Data Tables for Charts

- All charts have a "View as Table" toggle button that renders the same data in an accessible `<table>` element with proper `<th>`, `<td>`, and `<caption>` elements.

### 12.2 Color Independence

- Color is never the sole means of conveying information.
- Chart bars use patterns (hatched for low-confidence segments).
- Icons supplement color in metric cards (up/down arrows alongside green/red).

### 12.3 Contrast

- WCAG 2.1 AA contrast ratios: 4.5:1 minimum for body text, 3:1 for large text and UI components.

### 12.4 Keyboard Navigation

- All interactive elements keyboard navigable.
- Focus ring visible on tab navigation.
- Full-screen modal closeable via Escape key.

### 12.5 Screen Reader Support

- Metric cards announce values fully: "Total Net P&L: fifteen thousand four hundred twenty dollars and fifty cents, up three hundred twenty dollars from previous period."
- Skip navigation link: "Skip to analytics content" at page top.

---

## 13. API Endpoints (Visualization-Relevant)

All endpoints require JWT authentication via `Authorization: Bearer {token}` header. All accept filter query parameters: `start_date`, `end_date`, `instruments`, `playbooks`.

### 13.1 Chart Data Endpoints

| Endpoint | Method | Tier | Rate Limit | Description |
|---|---|---|---|---|
| `/api/v1/analytics/summary` | GET | Free+ | 60/min | Summary metrics for stat cards |
| `/api/v1/analytics/equity-curve` | GET | Free+ | 30/min | Equity curve data series + annotations |
| `/api/v1/analytics/calendar` | GET | Trader+ | 30/min | Calendar heatmap data |
| `/api/v1/analytics/calendar/{date}` | GET | Trader+ | 30/min | Trades for a specific date |
| `/api/v1/analytics/r-distribution` | GET | Trader+ | 30/min | R-multiple histogram bins |
| `/api/v1/analytics/win-rate/{dimension}` | GET | Trader+ | 30/min | Win rate by dimension |
| `/api/v1/analytics/mae-mfe` | GET | Trader+ | 30/min | MAE/MFE scatter data |
| `/api/v1/analytics/drawdown` | GET | Trader+ | 30/min | Drawdown chart + periods table |
| `/api/v1/analytics/time-analysis` | GET | Trader+ | 30/min | Time-segmented analysis |
| `/api/v1/analytics/session` | GET | Trader+ | 30/min | RTH vs. overnight comparison |
| `/api/v1/analytics/execution-quality` | GET | Trader+ | 30/min | Slippage and fill quality |
| `/api/v1/analytics/behavioral` | GET | Trader+ | 30/min | Behavioral metrics |
| `/api/v1/analytics/trendline` | GET | Trader+ | 30/min | Trendline analytics |

### 13.2 Export Endpoints

| Endpoint | Method | Tier | Rate Limit | Description |
|---|---|---|---|---|
| `/api/v1/analytics/export/pdf` | POST | Trader+ | 5/hour | Initiate PDF generation |
| `/api/v1/analytics/export/{export_id}` | GET | Trader+ | 30/min | Poll export status / get download URL |
| `/api/v1/analytics/export/csv` | GET | Trader+ | 30/min | CSV file download |

**CSV Query Parameter:** `type` = `trades` | `daily_summary` | `metrics`

### 13.3 WebSocket

| Endpoint | Auth | Max Concurrent |
|---|---|---|
| `wss://{api_domain}/ws/analytics` | JWT in query param | 3 per user |

### 13.4 Common Error Responses

| Status | Body | Trigger |
|---|---|---|
| 400 | `{ "error": "bad_request", "message": "..." }` | Invalid parameters |
| 401 | `{ "error": "unauthorized", "message": "Authentication required." }` | Missing/invalid/expired JWT |
| 403 | `{ "error": "forbidden", "message": "This feature requires the [tier] plan.", "required_tier": "...", "upgrade_url": "/settings/billing" }` | Insufficient subscription tier |
| 429 | `{ "error": "rate_limited", "message": "...", "retry_after": N }` | Rate limit exceeded |
| 503 | `{ "error": "service_unavailable", "message": "Analytics service temporarily unavailable." }` | Backend down |

---

## 14. Performance Specifications

### 14.1 Dashboard Load Targets

| Scenario | Dataset Size | Target Load Time | Cache State |
|---|---|---|---|
| Small account | 50 trades | < 1 second | Cold or warm |
| Medium account | 500 trades | < 2 seconds | Cold or warm |
| Standard account | 2,000 trades | < 3 seconds | Cold cache |
| Standard account | 2,000 trades | < 1 second | Warm cache |
| Large account | 10,000 trades | < 5 seconds | Cold cache |
| Large account | 10,000 trades | < 2 seconds | Warm cache |
| Very large account | 50,000 trades | < 8 seconds | Cold cache |

Load time measured from navigation start to Largest Contentful Paint (summary cards + equity curve rendered with data).

### 14.2 Chart Rendering Targets

- All charts: <500ms after data received
- Tooltip latency: <50ms from hover to render
- Animations: 60fps target
- LTTB downsampling for >5,000 points
- Canvas rendering for >1,000 points

### 14.3 WebSocket Targets

- Message delivery: <500ms from trade close event to client receipt
- Maximum concurrent connections: 10,000 total, 3 per user
- Heartbeat interval: 30s (ping), 10s (pong timeout)

### 14.4 Export Targets

- PDF generation: <30 seconds for complete report
- PDF file size: <5MB standard, <10MB with Pro sections
- CSV: instant for <1,000 rows (client-side), server-side for larger

---

## 15. Test Scenarios

### 15.1 Visual Regression Tests (AN-TEST-004)

Implement with Playwright screenshot comparison at 1% pixel difference threshold:

| Test | Description |
|---|---|
| VR-001 | Equity curve with 100-trade reference dataset at 1280px width |
| VR-002 | Equity curve at 375px width (mobile) |
| VR-003 | P&L calendar heatmap with known daily P&L values |
| VR-004 | R-multiple histogram with known distribution |
| VR-005 | MAE/MFE scatter plot with known data points |
| VR-006 | Drawdown chart with known drawdown periods |
| VR-007 | All charts in empty state (0 trades) |
| VR-008 | All charts with single data point |
| VR-009 | Tiltmeter gauge at score 0, 25, 50, 75, 100 |
| VR-010 | Locked widget (blurred preview with upgrade CTA) |

### 15.2 Chart Interactivity Tests (AN-TEST-005)

| Test ID | Chart | Interaction | Expected Result |
|---|---|---|---|
| CI-001 | Equity curve | Hover on data point | Tooltip with date, cumulative P&L, daily P&L, trade count |
| CI-002 | Equity curve | Click-and-drag zoom | Chart zooms to selected date range |
| CI-003 | Equity curve | Double-click | Zoom resets to full range |
| CI-004 | Calendar | Click on date with trades | Slide-over panel with trade list for that date |
| CI-005 | Calendar | Click on date with no trades | No action (cell is not clickable) |
| CI-006 | R-histogram | Click on bin | Trade list filters to show only trades in that R range |
| CI-007 | Widget | Click full-screen button | Widget expands to full viewport modal |
| CI-008 | Widget | Press Escape in full-screen | Modal closes, returns to dashboard |
| CI-009 | Widget | Click expand/collapse chevron | Widget toggles between compact and expanded |
| CI-010 | MAE scatter | Toggle R-multiples / ticks | Axis units switch, data points reposition |

### 15.3 Filter Tests (AN-TEST-003)

| Test ID | Filter State | Validation |
|---|---|---|
| FC-001 | 7 Days, all instruments, all playbooks | Metrics match manual computation for last 7 days |
| FC-002 | 30 Days, CL only | Metrics match CL trades in last 30 days |
| FC-003 | 90 Days, CL + GC | Metrics match CL and GC trades in last 90 days |
| FC-004 | YTD, A+ Trendline Break only | Metrics match A+ playbook trades since Jan 1 |
| FC-005 | Custom range, multiple playbooks | Correct intersection of all filters |
| FC-006 | Filters resulting in 0 trades | All widgets show empty state. Trade count = "Showing 0 of N trades". |
| FC-007 | Filters resulting in 1 trade | All metrics computed for single trade. Charts show single data point. |
| FC-008 | Rapid filter changes (< 300ms between) | Debounce prevents intermediate API calls. Only final filter state triggers request. Previous in-flight request cancelled. |
| FC-009 | Filter state after page refresh | URL parameters restore exact filter state. Metrics match pre-refresh state. |
| FC-010 | "Clear All Filters" button | Resets to 30d, all instruments, all playbooks. URL parameters cleared to `?range=30d`. |

### 15.4 Export Tests (AN-TEST-008, AN-TEST-009)

| Test ID | Export Type | Validation |
|---|---|---|
| EX-001 | PDF content | All sections from AN-FR-033 present |
| EX-002 | PDF charts | Visual match with on-screen charts |
| EX-003 | PDF compatibility | Renders correctly in Adobe Reader, Chrome PDF viewer, macOS Preview |
| EX-004 | PDF file size | < 10MB for full report |
| EX-005 | PDF generation time | < 30 seconds |
| EX-006 | PDF filter respect | Filtered data matches on-screen data |
| EX-007 | PDF cover page | Correct user name, date range, generation timestamp |
| EX-008 | CSV headers | Match documented field names |
| EX-009 | CSV values | Match on-screen metric values |
| EX-010 | CSV Excel compatibility | Opens correctly in Excel (UTF-8 BOM) |
| EX-011 | CSV special characters | Commas, quotes, newlines properly escaped |
| EX-012 | CSV row count | Matches filtered trade count |

### 15.5 Tier Restriction Tests (AN-TEST-010)

| Test ID | Scenario | Expected Result |
|---|---|---|
| TR-001 | Free user views dashboard | Only 5 basic metrics visible. All other widgets blurred with upgrade CTA. |
| TR-002 | Free user calls locked API | HTTP 403 with tier upgrade message |
| TR-003 | Trader user attempts 3rd PDF export | HTTP 429 with limit message |
| TR-004 | User upgrades Trader -> Pro mid-session | WebSocket pushes tier_changed. Pro features unlock without reload. |
| TR-005 | User downgrades Pro -> Trader | Pro features immediately locked. |
| TR-006 | PDF counter resets on billing cycle | Counter resets to 0. User can generate new PDFs. |
| TR-007 | Trader user saves 6th layout preset | Error: "Maximum 5 layout presets reached." |

### 15.6 WebSocket Tests (AN-TEST-WS)

| Test ID | Scenario | Expected Result |
|---|---|---|
| WS-001 | New trade closed | Dashboard updates within 5 seconds. Metrics animate to new values. |
| WS-002 | Connection lost | Banner appears: "Connection lost — reconnecting..." |
| WS-003 | Reconnection successful | Banner dismissed. Full state fetched via REST. Data consistency verified. |
| WS-004 | Exponential backoff | Reconnection attempts at 1s, 2s, 4s, 8s, 16s, 30s (max). |
| WS-005 | Heartbeat timeout | If no ping for 60s, client initiates reconnection. |
| WS-006 | Tier change event | Frontend unlocks/locks features immediately. |
| WS-007 | 4th concurrent connection | Connection rejected with code 4429. |

### 15.7 Performance Benchmark Tests (AN-TEST-006)

| Test ID | Scenario | Metric | Target |
|---|---|---|---|
| PB-001 | 50-trade cold load | Time to LCP | < 1 second |
| PB-002 | 500-trade cold load | Time to LCP | < 2 seconds |
| PB-003 | 2,000-trade cold load | Time to LCP | < 3 seconds |
| PB-004 | 10,000-trade cold load | Time to LCP | < 5 seconds |
| PB-005 | 50,000-trade cold load | Time to LCP | < 8 seconds |
| PB-006 | Filter change (2,000 trades) | All widgets updated | < 2 seconds |
| PB-007 | Chart render (1,000 points) | Render time | < 500ms |
| PB-008 | Chart render (5,000 points, downsampled) | Render time | < 500ms |

### 15.8 Accessibility Tests

| Test ID | Scenario | Expected Result |
|---|---|---|
| A11Y-001 | Tab through all widgets | All interactive elements reachable and focusable |
| A11Y-002 | Screen reader on metric cards | Values announced with full context |
| A11Y-003 | "View as Table" toggle | Chart data rendered as accessible table |
| A11Y-004 | Color-only information | Patterns/icons supplement all color-conveyed meaning |
| A11Y-005 | Contrast check | All text meets WCAG 2.1 AA ratios |
| A11Y-006 | Full-screen modal | Escape key closes, focus trapped inside modal |

---

## 16. Open Questions

| # | Question | Impact | Status |
|---|---|---|---|
| OQ-001 | Should the P&L calendar heatmap use the user's local timezone or the exchange timezone for date boundaries? | Affects which trades appear on which calendar day. | Assumed: exchange timezone |
| OQ-002 | What happens to a Trader user's 6+ saved layout presets if they were on Pro and downgraded? | Options: delete excess, keep but prevent new saves, lock access to presets 6+. | Open |

---

## 17. Assumptions

| # | Assumption | Rationale |
|---|---|---|
| A-001 | All chart data is served by the API endpoints defined in FSD-006a. The frontend does not perform metric calculations. | Clean separation of concerns: backend computes, frontend renders. |
| A-002 | The frontend build system (Next.js 14+) supports dynamic imports and code splitting for chart libraries. | Required for lazy loading of below-the-fold chart widgets. |
| A-003 | Exchange timezones are mapped to IANA timezone identifiers (e.g., "America/New_York" for CME products). | Required for accurate time-based displays. |
| A-004 | The Supabase Auth JWT includes the user's subscription tier as a claim (`user_metadata.subscription_tier`). | Required for client-side tier gating without additional database lookups. |
| A-005 | shadcn/ui components support dark mode via Tailwind `dark:` variants. | Required for dark mode chart and widget styling. |
