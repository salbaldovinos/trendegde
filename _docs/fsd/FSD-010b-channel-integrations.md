# FSD-010b: Channel Integrations

**TrendEdge -- AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-010b |
| Source | FSD-010 (Notifications & Integrations) |
| Title | Channel Integrations |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-12 |

---

## 1. Introduction

### 1.1 Purpose

This sub-FSD specifies all outbound notification delivery channels for TrendEdge: Telegram Bot, Discord Webhooks, Email (SendGrid/Resend), and In-App Notifications (Supabase Realtime WebSocket). It covers the complete lifecycle for each channel -- configuration, authentication, message formatting, delivery, error handling, and user-facing behavior.

This document is the delivery layer of the notification system. The Notification Engine (FSD-010a) dispatches rendered messages to channel adapters specified here. Each adapter handles the protocol-specific concerns of its external service.

Related sub-FSDs:

- **FSD-010a (Notification Engine & Preferences)**: Central dispatch, channel routing, tier gating, quiet hours, rate limiting, retry logic, circuit breaker, preference management UI, and the `notification_log` / `notification_preferences` data models.
- **FSD-010c (Market Data & TradingView)**: TradingView webhook receiver (inbound signals), yfinance/Databento historical data, real-time broker data, caching strategy, contract calendar, and symbol resolution.

### 1.2 Scope

This document covers:

- **Telegram Bot**: Bot registration, webhook security, user linking/unlinking flow, alert message formatting (Markdown V2), interactive commands (`/start`, `/help`, `/status`, `/positions`, `/pnl`, `/pause`, `/resume`, `/alerts`, `/trade`, `/unlink`), manual trade entry, inline keyboards.
- **Discord Webhooks**: Webhook URL configuration, test embed on save, rich embed formatting, color coding, privacy controls (`include_pnl`), daily/weekly summary posts, multiple webhook support.
- **Email (SendGrid/Resend)**: 8 transactional email types, daily and weekly digest emails, unsubscribe handling (RFC 8058), SendGrid suppression webhook, provider failover logic.
- **In-App Notifications**: WebSocket delivery via Supabase Realtime, notification panel UI, badge count, deep linking, toast notifications, disconnection recovery, `notifications` table schema.

### 1.3 Out of Scope

- Notification dispatch engine, event subscription, channel routing, tier gating, quiet hours, rate limiting, retry logic, circuit breaker, notification preferences matrix UI, delivery status tracking [see FSD-010a]
- TradingView webhook receiver (inbound signal ingestion), payload validation, symbol mapping, webhook activity log [see FSD-010c]
- Market data integration (yfinance, Databento, broker real-time data), caching strategy, contract calendar [see FSD-010c]
- Custom webhooks (Team tier) -- deferred to Phase 3 [see FSD-010a for placeholder specification]
- Push notifications for native mobile apps (Phase 4)
- SMS notifications (not planned)
- Slack integration (potential future addition)

### 1.4 Glossary

| Term | Definition |
|---|---|
| Channel | A delivery mechanism for notifications (Telegram, Discord, Email, In-App, Custom Webhook). |
| Channel Adapter | A module that formats and sends notifications for a specific channel. |
| Embed | A Discord rich content block with structured fields, colors, and footer. |
| Inline Keyboard | Telegram UI element presenting buttons beneath a message for interactive responses. |
| Markdown V2 | Telegram's message formatting syntax requiring specific character escaping. |
| Toast Notification | A transient UI popup appearing in the browser for in-app notification arrival. |
| RFC 8058 | Standard for one-click email unsubscribe via `List-Unsubscribe-Post` header. |
| CAN-SPAM | US law requiring commercial emails to include a physical address and unsubscribe mechanism. |
| RLS | Row-Level Security -- PostgreSQL feature ensuring users can only access their own data. |
| Supabase Realtime | WebSocket service built on PostgreSQL `LISTEN/NOTIFY` for live data delivery. |

### 1.5 External Dependencies

| Dependency | Type | Description |
|---|---|---|
| Telegram Bot API | Hard | Outbound message delivery and inbound command processing. |
| Discord Webhook API | Hard | Outbound rich embed delivery to Discord channels. |
| SendGrid API | Hard | Primary transactional and digest email delivery. |
| Resend API | Soft | Fallback email provider when SendGrid fails. |
| Supabase Realtime | Hard | WebSocket transport for in-app notification delivery. |
| Redis | Hard | Telegram link codes, rate limiting state, circuit breaker state. [see FSD-010a] |
| PostgreSQL | Hard | `user_integrations`, `notifications`, `notification_log` tables. |
| Celery | Hard | Async dispatch workers for all channel adapters. [see FSD-010a] |

---

## 2. Telegram Bot Integration

### 2.1 Bot Registration and Setup

**Bot Configuration:**

| Parameter | Value |
|---|---|
| Bot name | `TrendEdgeBot` (fallback: `TrendEdge_Bot`) |
| Bot description | `"AI-powered futures trading alerts, fill confirmations, and account management."` |
| Mode | Webhook mode in production |
| Webhook endpoint | `POST /api/integrations/telegram/webhook` |
| Bot token | Environment variable `TELEGRAM_BOT_TOKEN` (never in source control) |
| Tier requirement | Trader plan or higher |

**Webhook Security:**

- Every incoming request to `/api/integrations/telegram/webhook` MUST include the `X-Telegram-Bot-Api-Secret-Token` header.
- The secret token is set when registering the webhook with Telegram (`setWebhook` API call with `secret_token` parameter).
- Stored in environment variable `TELEGRAM_WEBHOOK_SECRET`.
- Validation: Compare request header value with stored secret using constant-time comparison.
- If the header is missing or does not match: Return HTTP 200 (to avoid leaking information to attackers) but do NOT process the update. Log at warning level: `"Telegram webhook request rejected: invalid secret token, source_ip: {ip}"`.

**Startup Behavior:**

- On application startup, the bot SHALL register its webhook URL with Telegram via `setWebhook` API.
- If webhook registration fails, log critical error and alert operations. The bot will not receive updates until this is resolved.

### 2.2 User Linking Flow

**Linking Flow (step-by-step):**

| Step | Actor | Action | System Response |
|---|---|---|---|
| 1 | User | Navigates to Settings > Integrations > Telegram in the dashboard | Dashboard displays linking UI with a "Generate Link Code" button |
| 2 | User | Clicks "Generate Link Code" | System generates a 6-character alphanumeric code |
| 3 | System | -- | Code stored in Redis: key=`telegram_link:{code}`, value=`{user_id}`, TTL=600 seconds (10 minutes) |
| 4 | System | -- | Dashboard displays: `"Send this code to @TrendEdgeBot on Telegram: {code}"` with a copy button |
| 5 | User | Opens Telegram, starts conversation with @TrendEdgeBot, sends the code | -- |
| 6 | Bot | Receives the message | Bot looks up `telegram_link:{code}` in Redis |
| 7a | System | Code found and valid | Store mapping in `user_integrations` table: `user_id`, `channel='telegram'`, `external_id={telegram_chat_id}`, `metadata={"username": "{telegram_username}"}`. Delete the Redis key. |
| 7b | Bot | -- | Replies: `"Your Telegram account has been linked to TrendEdge. You will now receive trade alerts here. Type /help to see available commands."` |
| 8 | Dashboard | -- | Updates to show `"Telegram: Connected"` with username and a "Disconnect" button |

**Code Generation Rules:**

- 6 characters, uppercase alphanumeric.
- Excluded characters: `I`, `O`, `0`, `1` (ambiguous).
- Character set: `ABCDEFGHJKLMNPQRSTUVWXYZ23456789` (32 characters).
- Generated using `secrets.choice()` for cryptographic randomness.
- Collision check: Before storing, verify the code does not already exist in Redis. If it does, regenerate (up to 3 attempts; if all collide, return error to user: `"Unable to generate link code. Please try again."`).

**API Endpoint:**

```
POST /api/integrations/telegram/generate-code
Auth: Bearer token (Trader+ tier)
Response 200: {"code": "ABC234", "expires_at": "2026-02-11T20:10:00Z"}
Response 403: {"error": "tier_restricted", "message": "Telegram requires Trader plan or higher."}
```

**Error States:**

| Condition | Bot Response |
|---|---|
| Code is expired (>10 minutes) | `"Invalid or expired code. Please generate a new code from your TrendEdge dashboard."` |
| Code is invalid (not found in Redis) | `"Invalid or expired code. Please generate a new code from your TrendEdge dashboard."` |
| Code is valid but user account is suspended | `"Your TrendEdge account is currently suspended. Please contact support."` |
| Database error during linking | `"An error occurred while linking your account. Please try again in a few minutes."` |
| User sends a non-code message before linking | `"Please link your TrendEdge account first. Visit Settings > Integrations > Telegram in your TrendEdge dashboard to generate a linking code."` |

**Re-Linking Behavior:**

- Each TrendEdge account links to exactly one Telegram chat.
- If a user links a new Telegram chat, the previous chat receives: `"Your Telegram account has been unlinked from TrendEdge. Another Telegram account has been linked."`
- The old mapping is deleted and replaced with the new one.

**Unlinking:**

- **From dashboard:** Click "Disconnect" button. System deletes the `user_integrations` record. Bot sends to the previously linked chat: `"Your Telegram account has been unlinked from TrendEdge."`
- **From Telegram:** User sends `/unlink`. Bot prompts with inline keyboard: `"Are you sure you want to unlink your Telegram account from TrendEdge? [Yes, Unlink] [Cancel]"`. On confirmation, system deletes the mapping and bot replies: `"Your Telegram account has been unlinked from TrendEdge."`
- Dashboard updates to show "Telegram: Not Connected" with a "Link Account" button.

**API Endpoint (Unlinking):**

```
DELETE /api/integrations/telegram
Auth: Bearer token
Response 200: {"success": true}
Response 404: {"error": "not_found", "message": "No Telegram integration found."}
```

### 2.3 Alert Message Formatting

**Formatting Rules:**

- All Telegram messages use Markdown V2 formatting.
- Special characters in Markdown V2 that must be escaped: `_`, `*`, `[`, `]`, `(`, `)`, `~`, `` ` ``, `>`, `#`, `+`, `-`, `=`, `|`, `{`, `}`, `.`, `!`.
- All monetary values: comma-separated with 2 decimal places (e.g., `$1,250.50`).
- Tick values: instrument's tick-size precision (e.g., ES ticks are 0.25, so display `5,205.25`; CL ticks are 0.01, so display `72.50`).

**Template Storage:** Python format strings in `templates/notifications/telegram/`.

**Event-Specific Formatting:**

| Event | Emoji | Title Format | Content Fields |
|---|---|---|---|
| Trade Fill (Entry) | Direction arrow (up/down) | `{direction} {qty} {symbol} @ {price}` | Stop, target, risk $, R:R, source |
| Trade Fill (Exit) | Close icon | `CLOSED {qty} {symbol} @ {price}` | Entry price, P&L ($, R), duration, slippage, daily P&L |
| Trendline Alert | Alert triangle | `{alert_type}: {symbol}` | Grade, touch count, slope, duration |
| Daily P&L Summary | Calendar | `Daily Summary: {date}` | Net P&L, trade count (W/L), win rate, best/worst trade |
| Risk Warning | Warning sign | `Risk Warning: {limit_type}` | Current vs. max, percent used, recommended action |
| Risk Breach | Red alert | `RISK BREACH: {limit_type}` | Auto-action taken (e.g., "Execution paused") |
| Connection Lost | Red circle | `Connection Lost: {broker}` | Timestamp, "Attempting reconnect..." |
| Connection Restored | Green circle | `Connection Restored: {broker}` | Downtime duration |

**`trade.fill` Template (exact format):**

```
FILL: {direction} {quantity} {symbol} @ {entry_price}
Stop: {stop_loss} | Target: {take_profit}
Risk: ${risk_amount} | R:R 1:{rr_ratio}
Source: {signal_source_display}
Time: {timestamp_user_tz}
```

Example rendered output:
```
FILL: BUY 2 MES @ 5,205.25
Stop: 5,190.00 | Target: 5,225.50
Risk: $305.00 | R:R 1:2.03
Source: TradingView Webhook
Time: 2026-02-11 14:32:05 ET
```

**`trade.closed` Template (exact format):**

```
CLOSED: {exit_direction} {quantity} {symbol} @ {exit_price}
Entry: {entry_price} | P&L: {pnl_sign}${pnl_dollars} ({pnl_sign}{r_multiple}R)
Duration: {duration_display} | Slippage: {slippage_ticks} ticks
Daily P&L: {daily_pnl_sign}${daily_pnl} ({wins}W / {losses}L)
```

Example rendered output:
```
CLOSED: SELL 2 MES @ 5,223.75
Entry: 5,205.25 | P&L: +$370.00 (+1.82R)
Duration: 4h 23m | Slippage: 0.5 ticks
Daily P&L: +$425.00 (3W / 1L)
```

**Signal Source Display Mapping:**

| `signal_source` Value | Display Text |
|---|---|
| `tradingview_webhook` | `TradingView Webhook` |
| `trendline_engine` | `Trendline Engine` |
| `manual_telegram` | `Manual (Telegram)` |
| `manual_dashboard` | `Manual (Dashboard)` |
| (unknown/null) | `Unknown Source` |

**Inline Keyboard Buttons:**

- Every trade fill and close notification includes a button: `[View Trade Details]` linking to `https://app.trendedge.com/trades/{trade_id}`.
- Phase 3 only: Fill notifications additionally include `[Move Stop to BE]` and `[Close Position]` buttons.

**Fallback Behavior:**

- Every template MUST have a plain-text fallback version.
- If a template variable is missing from the event payload, the template SHALL use a dash (`---`) as placeholder rather than raising an error.
- If a template file is not found, log error `"Template not found: {event_type}/telegram"` and skip dispatch. Do NOT crash the worker.

### 2.4 Interactive Commands

**Command Catalog:**

| Command | Description | Auth Required | Response Time Target |
|---|---|---|---|
| `/start` | Initial greeting | No (pre-link) | < 1s |
| `/help` | List commands | Yes (linked) | < 1s |
| `/status` | Account overview | Yes | < 3s |
| `/positions` | Open positions table | Yes | < 3s |
| `/pnl` | Today's P&L | Yes | < 3s |
| `/pnl week` | Weekly P&L | Yes | < 3s |
| `/pnl month` | Monthly P&L | Yes | < 3s |
| `/pause` | Pause execution | Yes | < 2s |
| `/resume` | Resume execution | Yes | < 2s |
| `/alerts` | Active trendline alerts | Yes | < 3s |
| `/trade` | Manual trade entry | Yes | < 2s (parsing) |
| `/unlink` | Disconnect Telegram | Yes | < 2s |

**Authentication Check:** For all commands except `/start`, the bot SHALL verify the sender's `chat_id` has a linked TrendEdge account. If not linked, reply: `"Your Telegram account is not linked to TrendEdge. Visit Settings > Integrations > Telegram in your dashboard to link your account."`

**`/start` Response:**

```
Welcome to TrendEdge Bot!

I can send you real-time trade alerts, fill confirmations, and P&L summaries.

To get started, link your TrendEdge account:
1. Go to Settings > Integrations > Telegram in your TrendEdge dashboard
2. Click "Generate Link Code"
3. Send the code here

Already linked? Type /help to see available commands.
```

**`/help` Response:**

```
Available Commands:

/status    - Account overview (positions, P&L, margin)
/positions - Detailed open positions table
/pnl       - Today's P&L breakdown
/pnl week  - This week's P&L summary
/pnl month - This month's P&L summary
/pause     - Pause automated execution
/resume    - Resume automated execution
/alerts    - Active trendline alerts
/trade     - Manual trade entry
/unlink    - Disconnect Telegram account
```

**`/status` Response Format:**

```
Account Status

Execution: ACTIVE (or PAUSED)
Open Positions: {count}
Unrealized P&L: {sign}${amount}
Daily P&L: {sign}${amount} ({wins}W/{losses}L)
Available Margin: ${amount}
Daily Loss Remaining: ${amount}

Active Alerts: {count} trendline setups
```

If broker data is unavailable: Show cached data with disclaimer: `"Data as of {cached_timestamp}. Live data unavailable --- broker connection may be down."`

**`/pause` Behavior:**

1. Bot sends confirmation prompt with inline keyboard: `"Are you sure you want to pause automated execution? Active positions will NOT be affected. New signals will be logged but NOT executed.\n[Yes, Pause] [Cancel]"`
2. User taps "Yes, Pause":
   - System sets `user.execution_paused = true` in the database.
   - Bot replies: `"Automated execution has been PAUSED. Existing positions are unaffected. New signals will be logged but not executed. Use /resume to re-enable."`
   - If the user has other active channels, a notification is sent to all: `"Automated execution has been PAUSED via Telegram."`
3. User taps "Cancel": Bot replies: `"Pause cancelled. Execution remains active."`

**`/pause` When Already Paused:** Bot replies: `"Execution is already PAUSED. Use /resume to re-enable."`

**`/resume` Behavior:**

1. System sets `user.execution_paused = false`.
2. Bot replies: `"Automated execution has been RESUMED. New signals will be processed normally. Note: {count} signals were received while paused and have been discarded (stale data)."`
3. Notify all active channels: `"Automated execution has been RESUMED via Telegram."`

**`/resume` When Not Paused:** Bot replies: `"Execution is already ACTIVE. No action needed."`

**Signal Handling During Pause:** When execution is paused and a signal is received (from TradingView webhook or trendline engine):

1. Log the signal in `signal_log` with status `paused_skipped`.
2. Send Telegram notification: `"Signal received but execution is PAUSED: {direction} {symbol} @ {price}. Use /resume to re-enable."`
3. Do NOT route to the execution engine.

### 2.5 Manual Trade Entry via Telegram

**Command Syntax:**

```
/trade <ACTION> <SYMBOL> <PRICE> SL:<STOP_LOSS> TP:<TAKE_PROFIT> [QTY:<QUANTITY>]
```

**Parsing Rules:**

| Parameter | Required | Format | Default | Validation |
|---|---|---|---|---|
| ACTION | Yes | `BUY` or `SELL` (case-insensitive) | -- | Must be `BUY` or `SELL` |
| SYMBOL | Yes | Alphanumeric, 1-10 chars | -- | Must resolve via SymbolResolver [see FSD-010c] |
| PRICE | Yes | Numeric, positive | -- | Must be a valid price for the instrument |
| SL | Yes | `SL:` prefix + numeric | -- | For BUY: must be < PRICE. For SELL: must be > PRICE. |
| TP | Yes | `TP:` prefix + numeric | -- | For BUY: must be > PRICE. For SELL: must be < PRICE. |
| QTY | No | `QTY:` prefix + positive integer | `1` | Must be >= 1 and <= user's max position size |

**Processing Steps:**

1. **Parse command:** Extract all parameters. If parsing fails, reply with usage help:
   ```
   Invalid command format. Usage:
   /trade BUY MES 5200 SL:5190 TP:5220
   /trade SELL CL 72.50 SL:73.25 TP:71.00 QTY:2
   ```

2. **Validate symbol:** Resolve via SymbolResolver. If unresolved:
   `"Unknown symbol: {symbol}. Supported symbols: ES, MES, NQ, MNQ, YM, CL, GC, PL, SI"`

3. **Validate prices:** Check stop/target on correct side.
   - BUY with SL >= PRICE: `"Stop loss must be below entry price for a BUY order. Entry: {price}, Stop: {sl}"`
   - SELL with SL <= PRICE: `"Stop loss must be above entry price for a SELL order. Entry: {price}, Stop: {sl}"`
   - BUY with TP <= PRICE: `"Take profit must be above entry price for a BUY order. Entry: {price}, Target: {tp}"`
   - SELL with TP >= PRICE: `"Take profit must be below entry price for a SELL order. Entry: {price}, Target: {tp}"`

4. **Calculate risk metrics:**
   - Risk per contract = |PRICE - SL| * tick_value / tick_size
   - Total risk = Risk per contract * QTY
   - Reward = |TP - PRICE| * tick_value / tick_size * QTY
   - R:R ratio = Reward / Total risk

5. **Run risk checks:** [Cross-reference: see FSD-003b for risk management rules]
   - Daily loss limit check
   - Max positions check
   - Position size limit check
   - If any fail: `"Cannot execute: {reason}. {details}"`
   - Example: `"Cannot execute: Daily loss limit would be exceeded. Remaining risk budget: $200.00. This trade risks $500.00."`

6. **Display confirmation:**
   ```
   Manual Trade Confirmation

   {ACTION} {QTY} {SYMBOL} @ {PRICE}
   Stop: {SL} | Target: {TP}
   Risk: ${risk} | Reward: ${reward} | R:R 1:{rr}

   [Confirm & Execute] [Cancel]
   ```

7. **On "Confirm & Execute":** Route to execution pipeline as `signal_source = "manual_telegram"`. Reply with fill confirmation template when filled.

8. **On "Cancel":** Reply: `"Trade cancelled."` Remove the inline keyboard.

**Timeout:** If user does not respond to the confirmation within 5 minutes, the inline keyboard is removed and the bot sends: `"Trade confirmation expired. Please submit a new /trade command if you still want to execute."`

### 2.6 Telegram Bot API Specifications

| Action | Method | Endpoint | Rate Limit (Telegram) |
|---|---|---|---|
| Send message | POST | `https://api.telegram.org/bot{token}/sendMessage` | 30 msg/s to different chats; 1 msg/s per chat |
| Set webhook | POST | `https://api.telegram.org/bot{token}/setWebhook` | -- |
| Edit message (for inline keyboard updates) | POST | `https://api.telegram.org/bot{token}/editMessageReplyMarkup` | Same as sendMessage |

**Telegram Webhook Endpoint:**

```
POST /api/integrations/telegram/webhook
Auth: X-Telegram-Bot-Api-Secret-Token header
Body: Telegram Update JSON
Response: always 200 (Telegram requirement)
```

**Error Handling:**

| Telegram Error | Our Response |
|---|---|
| 400 Bad Request | Log error with payload, mark notification failed, do NOT retry (payload issue). |
| 401 Unauthorized | CRITICAL: Bot token invalid. Alert operations immediately. |
| 403 Forbidden (user blocked bot) | Mark user's Telegram as disconnected. Send email: `"You appear to have blocked the TrendEdge bot on Telegram. Your Telegram notifications have been paused."` |
| 429 Too Many Requests | Respect `retry_after` from response, re-queue with that delay. |
| 500+ Server Error | Retry with backoff per retry schedule [see FSD-010a section on retry logic]. |

### 2.7 Telegram Command Quick Reference

```
/start     - Welcome and linking instructions
/help      - Show all available commands
/status    - Account overview (positions, P&L, margin)
/positions - Detailed open positions table
/pnl       - Today's P&L breakdown
/pnl week  - This week's P&L summary
/pnl month - This month's P&L summary
/pause     - Pause automated execution
/resume    - Resume automated execution
/alerts    - Active trendline alerts
/trade     - Manual trade entry
/unlink    - Disconnect Telegram account
```

---

## 3. Discord Webhook Integration

### 3.1 Webhook Configuration

**Tier Requirement:** Pro plan or higher.

**Configuration UI (Settings > Integrations > Discord):**

| Field | Type | Validation | Required |
|---|---|---|---|
| `webhook_url` | URL input | Must match: `https://discord.com/api/webhooks/{id}/{token}` | Yes |
| `channel_name` | Text input | Max 100 chars, auto-populated from Discord if possible | No |
| `enabled_events` | Multi-select checkboxes | At least one event type | Yes |
| `include_pnl` | Toggle | Boolean | No (default: `false`) |

**Available Event Types for Discord:**

- `trade.fill` (default: ON)
- `trade.closed` (default: ON)
- `trendline.alert` (default: ON)
- `risk.warning`
- `digest.daily`
- `digest.weekly`

**Multiple Webhooks:** Users can configure up to 3 Discord webhook URLs. Each webhook has independent event type filtering.

**Test Embed on Save:**

When a user saves a webhook URL, the system sends a test embed:

```json
{
  "embeds": [{
    "title": "TrendEdge Integration Active",
    "description": "Trade alerts will appear in this channel.",
    "color": 3447003,
    "footer": { "text": "TrendEdge | Test message" },
    "timestamp": "<current ISO timestamp>"
  }]
}
```

**Test Embed Error Handling:**

| Discord API Response | UI Message |
|---|---|
| 2xx success | Toast: `"Test message sent to Discord. Check your channel."` |
| 404 Not Found | `"Could not send to Discord. The webhook URL appears to be invalid or the channel has been deleted."` |
| 401/403 Unauthorized | `"Could not send to Discord. The webhook token is invalid. Please regenerate the webhook in Discord."` |
| 429 Rate Limited | `"Discord is rate limiting requests. Please try again in a few seconds."` |
| Timeout (>5s) | `"Could not reach Discord. Please check your internet connection and try again."` |
| Any other error | `"Could not send to Discord. Please verify the webhook URL is correct and the channel exists."` |

**API Endpoints:**

```
POST /api/integrations/discord/webhook
Auth: Bearer token (Pro+ tier)
Body: {"webhook_url": "...", "channel_name": "...", "enabled_events": [...], "include_pnl": false}
Response 200: {"id": "...", "test_result": "success"}
Response 400: {"error": "invalid_webhook_url", "message": "Invalid Discord webhook URL format."}
Response 422: {"error": "test_failed", "message": "Could not send to Discord. Please verify the webhook URL."}
```

```
DELETE /api/integrations/discord/{id}
Auth: Bearer token
Response 200: {"success": true}
```

### 3.2 Rich Embed Formatting

**Embed Color Codes:**

| Scenario | Hex | Decimal | Usage |
|---|---|---|---|
| Long entries, winning closes | `#2ECC71` | `3066993` | Green |
| Short entries, losing closes | `#E74C3C` | `15158332` | Red |
| Trendline alerts | `#F1C40F` | `15844367` | Gold |
| Informational (summaries, status) | `#3498DB` | `3447003` | Blue |
| Warnings | `#E67E22` | `15105570` | Orange |

**Template Storage:** Python format strings producing JSON embed structures in `templates/notifications/discord/`.

**Trade Fill Embed Structure:**

```json
{
  "embeds": [{
    "title": "Trade Fill: {direction} {symbol}",
    "color": "<color based on direction>",
    "fields": [
      { "name": "Direction", "value": "{LONG|SHORT}", "inline": true },
      { "name": "Entry", "value": "{entry_price}", "inline": true },
      { "name": "Quantity", "value": "{quantity}", "inline": true },
      { "name": "Stop Loss", "value": "{stop_loss}", "inline": true },
      { "name": "Target", "value": "{take_profit}", "inline": true },
      { "name": "R:R", "value": "1:{rr_ratio}", "inline": true },
      { "name": "Source", "value": "{signal_source_display}", "inline": true },
      { "name": "Grade", "value": "{trendline_grade}", "inline": true }
    ],
    "footer": { "text": "TrendEdge | {date} {time} ET" },
    "timestamp": "{iso_timestamp}"
  }]
}
```

**Privacy Control (`include_pnl`):**

- When `include_pnl` is `false`: Replace all dollar P&L amounts with R-multiple values only.
  - Instead of `"+$370.00 (+1.82R)"` show `"+1.82R"`
  - Instead of `"Risk: $305.00"` show `"Risk: 0.61R"` (relative to daily risk budget)
- When `include_pnl` is `true`: Show both dollar amounts and R-multiples.

**Discord API Limits to Respect:**

| Limit | Value |
|---|---|
| Max embeds per message | 10 |
| Max fields per embed | 25 |
| Max characters for embed title | 256 |
| Max characters for embed description | 4096 |
| Max characters per field value | 1024 |
| Rate limit | 5 requests per 2 seconds per webhook |

### 3.3 Daily/Weekly Summary Posts

**Daily Summary (posted at 17:30 ET):**

```json
{
  "embeds": [{
    "title": "Daily Summary -- {date}",
    "color": 3447003,
    "fields": [
      { "name": "Net P&L", "value": "{pnl_display}", "inline": true },
      { "name": "Trades", "value": "{wins}W / {losses}L / {be}BE", "inline": true },
      { "name": "Win Rate", "value": "{win_rate}%", "inline": true },
      { "name": "Best Trade", "value": "{symbol} {pnl_display}", "inline": true },
      { "name": "Worst Trade", "value": "{symbol} {pnl_display}", "inline": true },
      { "name": "Active Alerts", "value": "{count} setups", "inline": true }
    ],
    "footer": { "text": "TrendEdge | Daily Summary" },
    "timestamp": "{iso_timestamp}"
  }]
}
```

If no trades occurred: Post a lighter summary: `"No trades executed today. {count} active trendline setups being monitored."` This message is suppressible via user preferences [see FSD-010a].

**Weekly Summary (posted Saturday at 10:00 ET):**

```json
{
  "embeds": [{
    "title": "Weekly Summary -- {start_date} to {end_date}",
    "color": 3447003,
    "fields": [
      { "name": "Net P&L", "value": "{pnl_display}", "inline": true },
      { "name": "Total Trades", "value": "{count} ({win_rate}% win rate)", "inline": true },
      { "name": "Avg R-Multiple", "value": "{avg_r}", "inline": true },
      { "name": "Top Playbooks", "value": "{playbook_summary}", "inline": false },
      { "name": "Top Trendline Setups", "value": "{trendline_summary}", "inline": false }
    ],
    "footer": { "text": "TrendEdge | Weekly Summary" },
    "timestamp": "{iso_timestamp}"
  }]
}
```

### 3.4 Discord Webhook API Error Handling

| Discord Error | Our Response |
|---|---|
| 400 Bad Request | Log error, check embed field limits, mark notification failed. |
| 401/403 Unauthorized | Webhook token invalid. Mark integration as needs reconfiguration. Notify user via email/in-app: `"Your Discord webhook token is invalid. Please reconfigure in Settings > Integrations > Discord."` |
| 404 Not Found | Webhook deleted. Mark integration inactive. Notify user: `"Your Discord webhook appears to have been deleted. Please reconfigure in Settings."` |
| 429 Rate Limited | Respect `retry_after` header value, re-queue with that delay. |
| 500+ Server Error | Retry with backoff per retry schedule [see FSD-010a]. |

---

## 4. Email Notifications (SendGrid/Resend)

### 4.1 Transactional Emails

**Email Catalog:**

| Email | Trigger | From Address | Subject Template | Delivery Target |
|---|---|---|---|---|
| Welcome | User registration | `noreply@trendedge.com` | `"Welcome to TrendEdge -- Let's get your first trendline detected"` | < 30s |
| Email Verification | Registration / email change | `noreply@trendedge.com` | `"Verify your email address"` | < 10s |
| Password Reset | Password reset request | `security@trendedge.com` | `"Reset your TrendEdge password"` | < 10s |
| Broker Connected | Broker API connected | `noreply@trendedge.com` | `"Your {broker_name} account is connected"` | < 30s |
| Trade Fill | `trade.fill` event | `alerts@trendedge.com` | `"{direction} {symbol} filled @ {price}"` | < 30s |
| Trade Closed | `trade.closed` event | `alerts@trendedge.com` | `"Trade closed: {symbol} {pnl_direction}{pnl_amount}"` | < 30s |
| Risk Breach | `risk.limit_breach` | `alerts@trendedge.com` | `"URGENT: {limit_type} limit reached -- execution paused"` | < 30s |
| Subscription Change | Tier change | `billing@trendedge.com` | `"Your TrendEdge plan has been updated to {tier}"` | < 30s |

**Email Security Rule:** Subject lines SHALL NOT contain dollar amounts or account balances (these can be previewed on lock screens). Body content may include P&L values.

**Required Email Components:**

- TrendEdge logo (header)
- Link to dashboard
- Unsubscribe link (for non-security emails)
- Footer with company address (CAN-SPAM compliance)
- Social links in footer

**Template Storage:** Jinja2 templates in `templates/notifications/email/`.

### 4.2 Provider Configuration and Failover

**Primary Provider: SendGrid**

- Endpoint: `POST https://api.sendgrid.com/v3/mail/send`
- Auth: `Authorization: Bearer {SENDGRID_API_KEY}`
- Sandbox mode for testing: `"mail_settings": {"sandbox_mode": {"enable": true}}`

**Fallback Provider: Resend**

- Endpoint: `POST https://api.resend.com/emails`
- Auth: `Authorization: Bearer {RESEND_API_KEY}`

**Failover Logic:**

1. Attempt delivery via SendGrid.
2. If SendGrid API returns 5xx or times out (>10s), retry once with SendGrid.
3. If still failing, switch to Resend for this email. Log the failover event.
4. Failover is per-email, not a global switch. Each email independently tries SendGrid first.

**Retry and Fallback Summary:**

| Provider | Retry Strategy | Fallback |
|---|---|---|
| SendGrid | 1 retry with SendGrid, then switch to Resend | Resend API |
| Resend | 3 retries with backoff | In-App notification for critical events |

### 4.3 Digest Emails

**Daily Digest (sent at 18:00 user timezone):**

| Section | Content | Notes |
|---|---|---|
| Header | Date, account name, tier badge | -- |
| P&L Summary | Net P&L ($, R), trade count, win rate | -- |
| Trade Table | Per trade: symbol, direction, entry/exit, P&L, R, duration, playbook | Max 20 trades; if more, show top 10 + bottom 10 |
| Equity Curve | Inline chart image (last 30 days) | Generated via matplotlib, hosted as CID attachment or URL |
| Trendline Activity | New setups detected, alerts fired, invalidated | -- |
| Risk Status | Daily loss usage, max drawdown distance | -- |
| Footer | Dashboard link, preferences link, unsubscribe link | -- |

**Weekly Digest (sent Sunday at 09:00 user timezone):**

| Section | Content | Notes |
|---|---|---|
| Week Summary | Date range, net P&L, total trades, win rate, annualized Sharpe | -- |
| Playbook Breakdown | Per playbook: count, win rate, avg R, total P&L | -- |
| Best/Worst Trades | Top 3 winners, top 3 losers | -- |
| Equity Curve | 90-day curve with current week highlighted | -- |
| Behavioral Metrics | Rule compliance, mistake cost, consistency score | -- |
| Trendline Report | Active setups, new A+ detections, accuracy | -- |
| AI Insight | One-paragraph AI observation | Pro tier only; omit for other tiers |

**No-Activity Behavior:**

- If zero trades occurred on a day/week, send a lighter email: `"No trades were executed on {date}. You have {count} active trendline setups being monitored."`
- This email is suppressible via preferences (checkbox: "Skip digest on days with no trades") [see FSD-010a].

### 4.4 Unsubscribe Handling

**One-Click Unsubscribe (RFC 8058):**

- Every non-security email includes `List-Unsubscribe` and `List-Unsubscribe-Post` headers.
- Clicking the unsubscribe link:
  1. Immediately unsubscribes from that email category.
  2. Displays confirmation page: `"You have been unsubscribed from {category} emails. You can re-enable this in your notification preferences."` with a link to preferences and an "Undo" button (valid for 7 days).
  3. Does NOT unsubscribe from security emails (password reset, email verification, risk limit breaches).

**Non-Unsubscribable Emails:**

- Password reset
- Email verification
- Risk limit breach alerts
- Account security notifications

**SendGrid Suppression Integration:**

- Webhook endpoint: `POST /api/integrations/sendgrid/webhook`
- Events handled: `bounce`, `spam_report`, `unsubscribe`

| SendGrid Event | System Action |
|---|---|
| `bounce` | Mark user's email as bounced in `user_integrations`. Stop sending until email is re-verified. |
| `spam_report` | Mark user's email preferences to stop all marketing/digest emails. Log the event. Alert operations if spam report rate exceeds 0.1%. |
| `unsubscribe` | Update `notification_preferences` to disable that email category [see FSD-010a]. |

---

## 5. In-App Notification Center

### 5.1 Real-Time Delivery via WebSocket

**WebSocket Channel:** `notifications:{user_id}` via Supabase Realtime (PostgreSQL `LISTEN/NOTIFY`).

**Subscription Lifecycle:**

1. On dashboard mount, frontend subscribes to `notifications:{user_id}`.
2. RLS policies ensure users only receive their own notifications.
3. On dashboard unmount (page close/navigate away), subscription is cleaned up.

**New Notification Arrival Behavior:**

1. Notification bell badge count increments by 1.
2. Toast notification appears in bottom-right corner:
   - Icon: event-type-specific icon
   - Title: notification title (max 50 chars, truncated with `...`)
   - Body: first line of message (max 100 chars, truncated with `...`)
   - Auto-dismiss: 5 seconds
   - Click: navigates to relevant detail page (if deep link available) or opens notification panel
3. If notification panel is open: new notification prepends to the list with a 1-second highlight animation (subtle background color pulse).

**WebSocket Disconnection Recovery:**

1. Display a subtle indicator near the notification bell: small orange dot with tooltip `"Reconnecting..."`.
2. Reconnect with exponential backoff: 1s, 2s, 4s, 8s, 16s, max 30s.
3. On successful reconnection: remove the indicator, fetch missed notifications via `GET /api/notifications?since={last_received_timestamp}`.
4. If reconnection fails after 5 minutes: show persistent banner: `"Live notifications unavailable. Refresh the page to reconnect."` with a "Refresh" button.

### 5.2 Notification Panel UI

**`notifications` Table Schema:**

| Field | Type | Constraints | Default | Description |
|---|---|---|---|---|
| `id` | UUID | PK | `gen_random_uuid()` | Primary key |
| `user_id` | UUID | FK -> users.id, NOT NULL, INDEX | -- | Target user |
| `event_type` | VARCHAR(50) | NOT NULL, INDEX | -- | Event type |
| `title` | VARCHAR(200) | NOT NULL | -- | Notification title |
| `body` | TEXT | NOT NULL | -- | Body (Markdown) |
| `data` | JSONB | NULLABLE | `NULL` | Deep link data |
| `read` | BOOLEAN | NOT NULL, INDEX | `false` | Read status |
| `created_at` | TIMESTAMPTZ | NOT NULL, INDEX | `NOW()` | Creation timestamp |
| `expires_at` | TIMESTAMPTZ | NULLABLE | `NULL` | Expiration (null = uses default retention) |

**Template Storage:** Jinja2 templates (Markdown output) in `templates/notifications/in_app/`.

**Panel Features:**

| Feature | Behavior |
|---|---|
| Pagination | Infinite scroll, 20 notifications per page. Load more on scroll to bottom. |
| Filter | Dropdown: All, Trades, Trendlines, Risk, System. Default: All. |
| Mark all as read | Button in panel header. Sets `read = true` for all user's unread notifications. Badge count resets to 0. |
| Mark individual as read | Click on a notification marks it as read. Visual change: bold text becomes normal weight. |
| Swipe to dismiss (mobile) | Marks as read, does NOT delete. Slide animation. |
| Clear all read | Button (secondary style). Deletes all notifications where `read = true` from the panel view (soft delete or hide; actual deletion via retention policy). |
| Empty state | Panel shows: `"No notifications yet. Your trade alerts, trendline signals, and system updates will appear here."` |

### 5.3 Deep Linking

| Notification Data | Navigation Target |
|---|---|
| `data.trade_id` present | `/trades/{trade_id}` |
| `data.trendline_id` present | `/trendlines/{trendline_id}` |
| No deep link data | Opens notification panel (if not already open) or marks as read |

### 5.4 Badge Count

- Fetched on page load: `GET /api/notifications/unread-count` returns `{"count": N}`.
- Updated in real time via WebSocket.
- Max display: `99+` (if count > 99, display `"99+"`).
- Badge hidden when count is 0.
- Accessibility: `aria-label="{count} unread notifications"`.

### 5.5 Retention Policy

| Category | Retention Period | Cleanup |
|---|---|---|
| Standard notifications | 30 days auto-deleted | Daily Celery Beat task at 05:00 UTC |
| Critical notifications (`trade.fill`, `risk.limit_breach`) | 90 days | Same task |
| Max per user | 10,000 | Retention policy prevents exceeding |

### 5.6 In-App Notification API Endpoints

```
GET /api/notifications/unread-count
Auth: Bearer token (all tiers)
Response 200: {"count": 5}
Response 401: {"error": "unauthorized", "message": "Authentication required"}
```

```
GET /api/notifications?since={timestamp}&event_type={type}&limit={n}
Auth: Bearer token
Params: since (ISO 8601, optional), event_type (optional), limit (default 20, max 100)
Response 200: {"notifications": [...], "has_more": true}
Response 401: {"error": "unauthorized"}
```

```
PATCH /api/notifications/{id}/read
Auth: Bearer token
Response 200: {"success": true}
Response 404: {"error": "not_found", "message": "Notification not found"}
```

```
POST /api/notifications/mark-all-read
Auth: Bearer token
Response 200: {"updated_count": 12}
```

```
GET /api/notifications/history?event_type={type}&channel={ch}&status={s}&date_from={d}&date_to={d}&page={n}
Auth: Bearer token
Response 200: {"entries": [...], "total": 150, "page": 1, "pages": 8}
```

---

## 6. Data Specifications

### 6.1 `user_integrations` Table

| Field | Type | Constraints | Description |
|---|---|---|---|
| `id` | UUID | PK | Primary key |
| `user_id` | UUID | FK -> users.id, NOT NULL | Owner |
| `channel` | VARCHAR(20) | NOT NULL | `telegram`, `discord`, `custom_webhook` |
| `external_id` | VARCHAR(255) | NULLABLE | Channel-specific ID (e.g., Telegram chat_id) |
| `config` | JSONB | NOT NULL, DEFAULT '{}' | Channel-specific configuration |
| `is_active` | BOOLEAN | NOT NULL, DEFAULT true | Whether integration is active |
| `created_at` | TIMESTAMPTZ | NOT NULL | Creation timestamp |
| `updated_at` | TIMESTAMPTZ | NOT NULL | Last update |

**Unique Constraints:**
- `(user_id, channel)` for single-instance channels (telegram).
- Discord allows multiple per user (up to 3, enforced at application layer).

**Channel-Specific `config` JSONB Schemas:**

Telegram:
```json
{
  "username": "johndoe",
  "chat_id": "123456789"
}
```

Discord:
```json
{
  "webhook_url": "https://discord.com/api/webhooks/...",
  "channel_name": "trade-alerts",
  "enabled_events": ["trade.fill", "trade.closed", "trendline.alert"],
  "include_pnl": false
}
```

### 6.2 `notifications` Table

See section 5.2 for full schema.

### 6.3 Data Validation Rules

| Field | Rule | Error Message |
|---|---|---|
| Discord `webhook_url` | Must match `https://discord.com/api/webhooks/\d+/.+` | `"Invalid Discord webhook URL format."` |
| Telegram link code | 6 chars from set `ABCDEFGHJKLMNPQRSTUVWXYZ23456789` | `"Invalid or expired code."` |
| Email address (for delivery) | Must be verified in user account | Delivery skipped; channel connectivity check fails |

---

## 7. UI/UX Specifications

### 7.1 Component Inventory

| Component | Location | States |
|---|---|---|
| Notification Bell Icon | Dashboard header (always visible) | No notifications (no badge), has unread (badge with count), 99+ (max badge), reconnecting (orange dot) |
| Notification Panel | Slide-out panel from right side of screen | Empty, loading, populated, filtered, error |
| Toast Notification | Bottom-right overlay | Appear (slide in), visible (5s), dismiss (fade out) |
| Settings > Integrations > Telegram | Card in integrations page | Not connected, generating code, code displayed, connected |
| Settings > Integrations > Discord | Card in integrations page | Not configured, configuring, testing, configured, test failed |

### 7.2 Notification Bell Interaction Flow

1. **Initial page load:** Fetch `GET /api/notifications/unread-count`. Display badge if count > 0.
2. **Click bell:** Open notification panel. Fetch `GET /api/notifications?limit=20`.
3. **Panel loading state:** Show skeleton loaders (3 placeholder rows).
4. **Panel loaded:** Show notifications list.
5. **Scroll to bottom:** Fetch next page. Show spinner at bottom while loading.
6. **No more notifications:** Show subtle text: `"You've seen all your notifications."`
7. **Click notification:** Mark as read (via API), navigate to deep link if available.
8. **Click "Mark all as read":** Batch update via API, reset badge to 0.
9. **Click outside panel:** Close panel.

### 7.3 Responsive Behavior

| Viewport | Notification Panel |
|---|---|
| Desktop (>1024px) | Right side panel, 400px wide |
| Tablet (768-1024px) | Right side panel, 350px wide |
| Mobile (<768px) | Full-screen overlay |

### 7.4 Accessibility Requirements

- Toast notifications are announced via `aria-live="polite"` region.
- Notification bell badge count is announced: `aria-label="{count} unread notifications"`.
- Color is not the only indicator of status (icons + text accompany color-coded badges).
- All interactive elements are keyboard-navigable (Tab, Enter, Escape to close panel).
- Focus is trapped within the notification panel when open.

---

## 8. Security Specifications

### 8.1 Authentication per Channel

| Channel Endpoint | Auth Method |
|---|---|
| Telegram webhook | `X-Telegram-Bot-Api-Secret-Token` header (constant-time comparison) |
| Discord webhook (config API) | Bearer token (JWT via Supabase Auth) |
| SendGrid suppression webhook | Signature verification |
| In-App WebSocket (Supabase Realtime) | JWT token on connection |
| User notification APIs | Bearer token (JWT via Supabase Auth) |

### 8.2 Authorization Matrix (Channel-Specific)

| Role | Telegram | Discord | Email | In-App | Custom Webhook |
|---|---|---|---|---|---|
| Free user | No | No | Yes | Yes | No |
| Trader user | Yes | No | Yes | Yes | No |
| Pro user | Yes | Yes | Yes | Yes | No |
| Team user | Yes | Yes | Yes | Yes | Yes |

### 8.3 Data Encryption

| Data | At Rest | In Transit |
|---|---|---|
| Telegram bot token | Environment variable (not in DB) | HTTPS to Telegram API |
| Discord webhook URLs | PostgreSQL encryption at rest (Supabase default) | HTTPS to Discord API |
| Notification content | PostgreSQL encryption at rest | HTTPS (API), WSS (WebSocket) |
| Email content | Not stored after send (only in notification_log as rendered content) | TLS to SendGrid/Resend |

### 8.4 Input Sanitization

| Input | Sanitization Rule |
|---|---|
| Discord webhook URL | Strict regex match; reject if not matching expected pattern |
| Telegram message text (from user commands) | Escape Markdown V2 special characters |
| Notification preference values | Must be boolean; reject non-boolean |

### 8.5 Audit Logging

| Event | Logged Data | Retention |
|---|---|---|
| Telegram link/unlink | user_id, action, chat_id (hashed), timestamp | 1 year |
| Discord webhook add/remove | user_id, action, webhook_url (last 8 chars), timestamp | 1 year |
| Notification preference change | user_id, event_type, channel, old_value, new_value, timestamp | 1 year |
| Circuit breaker activation | channel, timestamp, failure_count | 90 days |

---

## 9. Performance Specifications

### 9.1 Response Time Requirements

| Operation | Target (p95) | Target (p99) | Measurement |
|---|---|---|---|
| Telegram message delivery | < 5s from event emission | < 8s | Event timestamp to Telegram API 200 response |
| Discord webhook delivery | < 5s from event emission | < 8s | Event timestamp to Discord API 204 response |
| Email delivery (to SendGrid) | < 30s from event emission | < 45s | Event timestamp to SendGrid API 202 response |
| In-app notification delivery | < 2s from event emission | < 3s | Event timestamp to WebSocket message received by browser |
| `/status` Telegram command | < 3s | < 5s | Message received to reply sent |
| Unread count fetch | < 200ms | < 500ms | API request to response |

### 9.2 Resource Limits

| Resource | Limit | Action on Exceed |
|---|---|---|
| In-app notifications per user | 10,000 | Retention policy prevents exceeding |
| Discord webhooks per user | 3 | UI prevents adding more; API returns 400 |
| Deferred notification queue per user | 100 | If exceeded, oldest deferred notifications are dropped with a log warning |

---

## 10. Testing Specifications

### 10.1 Telegram Test Scenarios

| Test | Setup | Expected Behavior |
|---|---|---|
| Linking with valid code | Generate code, send to bot within 10 min | Account linked, bot confirms, dashboard updates |
| Linking with expired code | Generate code, wait >10 min, send to bot | Bot replies with expired code error |
| Re-linking | Link account, generate new code, link from different chat | Old chat notified of unlink, new chat linked |
| Unlinking via bot | Send `/unlink`, confirm | Mapping deleted, bot confirms, dashboard updates |
| Unlinking via dashboard | Click "Disconnect" | Mapping deleted, bot notifies old chat |
| `/start` before linking | Send `/start` to bot | Welcome message with linking instructions |
| `/help` when linked | Send `/help` | Full command list displayed |
| `/status` response | Send `/status` with active broker | Account overview with positions, P&L, margin |
| `/status` without broker | Send `/status` with no broker connected | Cached data with disclaimer shown |
| `/pause` confirmation flow | Send `/pause`, tap "Yes, Pause" | Execution paused, bot confirms, other channels notified |
| `/pause` when already paused | Send `/pause` | Bot replies already paused |
| `/resume` after pause | Send `/resume` | Execution resumed, stale signal count shown |
| `/trade` valid command | Send `/trade BUY MES 5200 SL:5190 TP:5220` | Confirmation prompt with risk metrics displayed |
| `/trade` invalid symbol | Send `/trade BUY INVALID 100 SL:90 TP:110` | Unknown symbol error with supported list |
| `/trade` SL on wrong side | Send `/trade BUY MES 5200 SL:5210 TP:5220` | Validation error about SL placement |
| `/trade` confirmation timeout | Send `/trade`, wait 5 min without responding | Inline keyboard removed, expiration message |
| Command when not linked | Send `/status` from unlinked chat | Link instructions displayed |
| User blocks bot | Block @TrendEdgeBot | Telegram marked disconnected, email sent to user |
| Markdown V2 escaping | Send notification with special chars in symbol | Characters properly escaped, message renders correctly |

### 10.2 Discord Test Scenarios

| Test | Setup | Expected Behavior |
|---|---|---|
| Save valid webhook URL | Enter valid Discord webhook URL, save | Test embed sent, success toast shown |
| Save invalid webhook URL | Enter malformed URL, save | Validation error before API call |
| Webhook returns 404 | Save URL for deleted channel | Error message about deleted channel |
| Webhook returns 401/403 | Save URL with invalid token | Error about invalid webhook token |
| Webhook returns 429 | Trigger rate limit | Rate limit error message |
| Trade fill embed | Emit `trade.fill` event for Pro user | Correctly colored embed with all fields |
| Privacy mode (include_pnl=false) | Configure webhook with include_pnl off | Dollar amounts replaced with R-multiples only |
| Privacy mode (include_pnl=true) | Configure webhook with include_pnl on | Both dollar amounts and R-multiples shown |
| Daily summary post | Trigger at 17:30 ET | Summary embed with day's stats |
| Weekly summary post | Trigger Saturday 10:00 ET | Weekly summary embed with full stats |
| No-trade day summary | Day with zero trades | Lighter summary or suppressed per preference |
| Multiple webhooks | Configure 3 webhooks with different events | Each webhook receives only its configured events |
| 4th webhook attempt | Try to add 4th webhook | API returns 400, UI prevents adding |
| Webhook deleted externally | Discord channel deleted after config | 404 on next dispatch, integration marked inactive, user notified |

### 10.3 Email Test Scenarios

| Test | Setup | Expected Behavior |
|---|---|---|
| Welcome email | New user registration | Email sent within 30s, correct template, unsubscribe link present |
| Trade fill email | `trade.fill` event | Email with fill details, no dollar amounts in subject |
| Risk breach email | `risk.limit_breach` event | URGENT subject, sent within 30s |
| Daily digest | Trigger at 18:00 user timezone | All sections populated, equity curve image attached |
| Weekly digest (Pro tier) | Trigger Sunday 09:00 | AI insight section present |
| Weekly digest (Trader tier) | Trigger Sunday 09:00 | AI insight section omitted |
| No-trade day digest | Zero trades, "skip if no trades" unchecked | Lighter email sent |
| No-trade day with skip | Zero trades, "skip if no trades" checked | No email sent |
| Unsubscribe click | Click unsubscribe link in digest | Category disabled, confirmation page shown, "Undo" button present |
| Unsubscribe security email | Attempt to unsubscribe from risk breach | Not allowed; security emails are non-unsubscribable |
| SendGrid failover | SendGrid returns 500 twice | Resend used for this email, failover logged |
| SendGrid bounce | SendGrid webhook reports bounce | User email marked bounced, sending stopped |
| SendGrid spam report | SendGrid webhook reports spam | All marketing/digest emails stopped, ops alerted if >0.1% |
| CAN-SPAM compliance | Any non-security email | Physical address in footer, unsubscribe link present |

### 10.4 In-App Notification Test Scenarios

| Test | Setup | Expected Behavior |
|---|---|---|
| Real-time delivery | Emit event while dashboard is open | Badge increments, toast appears within 2s |
| Toast auto-dismiss | Wait 5 seconds after toast appears | Toast fades out |
| Toast click with deep link | Click toast for trade.fill notification | Navigates to `/trades/{trade_id}` |
| Panel open and load | Click notification bell | Panel opens, skeleton loaders shown, then notifications list |
| Infinite scroll | Scroll to bottom of panel with >20 notifications | Next page loads with spinner |
| Mark individual as read | Click a notification | Bold becomes normal, badge decrements |
| Mark all as read | Click "Mark all as read" | All notifications read, badge resets to 0 |
| Badge count 99+ | User has 100+ unread | Badge displays `"99+"` |
| Badge hidden at 0 | All notifications read | Badge not visible |
| WebSocket disconnect | Kill WebSocket connection | Orange dot appears with "Reconnecting..." tooltip |
| WebSocket reconnect | Connection restored after disconnect | Orange dot removed, missed notifications fetched |
| WebSocket 5-min failure | Connection down for 5+ minutes | Persistent banner with "Refresh" button shown |
| Filter by type | Select "Trades" filter | Only trade-related notifications shown |
| Empty state | New user with no notifications | Empty state message displayed |
| Deep link: trade | Click notification with `data.trade_id` | Navigates to `/trades/{trade_id}` |
| Deep link: trendline | Click notification with `data.trendline_id` | Navigates to `/trendlines/{trendline_id}` |
| Swipe to dismiss (mobile) | Swipe notification on mobile | Marked as read with slide animation, NOT deleted |
| RLS isolation | Attempt to access another user's notifications | 404 or empty result |
| Retention cleanup | Notification older than 30 days | Auto-deleted by cleanup task |

### 10.5 Integration Test Scenarios

| Test | Setup | Verification |
|---|---|---|
| End-to-end Telegram delivery | Emit `trade.fill` event | Test bot receives correctly formatted message |
| End-to-end Discord delivery | Emit `trade.closed` event | Test webhook receives correct embed |
| End-to-end email delivery | Emit `trade.fill` event | SendGrid sandbox confirms email structure |
| End-to-end in-app delivery | Emit `trendline.alert` event | WebSocket test client receives notification within 2s |
| Tier gating (Telegram) | Free user attempts Telegram config | 403 returned, no configuration saved |
| Tier gating (Discord) | Trader user attempts Discord config | 403 returned, no configuration saved |
| Provider failover | SendGrid returns 500 | Resend receives the email |
| Telegram blocked user recovery | 403 from Telegram API | Email sent, Telegram marked disconnected |
| Discord webhook invalidation | 404 from Discord API | Integration marked inactive, user notified |

### 10.6 Security Test Requirements

| Test | Method | Pass Criteria |
|---|---|---|
| Telegram webhook without secret | Send request without `X-Telegram-Bot-Api-Secret-Token` | Returns 200 but does NOT process (no information leakage) |
| Telegram webhook with wrong secret | Send request with incorrect header value | Returns 200 but does NOT process |
| Discord webhook URL injection | Submit non-Discord URL | Validation rejects at regex check |
| XSS in notification content | Inject script tags in notification body | Content sanitized in all channels |
| RLS isolation | Attempt to read other user's notifications via API | 404 or empty result, never other user's data |

---

## 11. Feature Flags

| Flag | Purpose | Default | Phase |
|---|---|---|---|
| `notifications.telegram.enabled` | Enable/disable Telegram bot | `true` | 1 |
| `notifications.telegram.manual_trade` | Enable/disable `/trade` command | `false` | 2 |
| `notifications.telegram.inline_keyboards` | Enable/disable interactive buttons on fills | `false` | 3 |
| `notifications.discord.enabled` | Enable/disable Discord integration | `false` | 2 |
| `notifications.email.digests.enabled` | Enable/disable digest emails | `false` | 2 |
| `notifications.inapp.enabled` | Enable/disable in-app notifications | `false` | 2 |

---

## 12. Deployment Dependencies

| Dependency | Must Be Ready Before | Relevant Channel |
|---|---|---|
| Telegram bot registered with BotFather | Phase 1 start | Telegram |
| `TELEGRAM_BOT_TOKEN` in environment | Phase 1 start | Telegram |
| `TELEGRAM_WEBHOOK_SECRET` in environment | Phase 1 start | Telegram |
| SendGrid account + API key | Phase 2 start | Email |
| `RESEND_API_KEY` in environment | Phase 2 start | Email (fallback) |
| Supabase Realtime configured | Phase 2 start | In-App |
| Redis instance | Phase 1 start | All (link codes, rate limiting) |
| Celery workers configured | Phase 1 start | All (async dispatch) |

---

## 13. Cross-References

| FSD | Relationship |
|---|---|
| FSD-010a | Notification Engine & Preferences: dispatch engine, channel routing, tier gating, quiet hours, rate limiting, retry/circuit breaker, preference management, `notification_log` schema |
| FSD-010c | Market Data & TradingView: TradingView webhook receiver, symbol resolution (used by `/trade` command), market data for `/status` and `/pnl` commands |
| FSD-003b | Risk Management Engine: risk checks for `/trade` manual trade entry |
| FSD-003d | Order Construction & Lifecycle: trade execution pipeline for manual trade entry |
| FSD-008 | Authentication & Authorization: JWT tokens, user identity, tier resolution |
| FSD-009 | Billing & Subscriptions: tier for channel gating |

---

## 14. Appendices

### 14.1 Event Payload Examples

**`trade.fill` event (consumed by all channel adapters):**

```json
{
  "event_type": "trade.fill",
  "user_id": "usr_abc123",
  "timestamp": "2026-02-11T19:32:05Z",
  "correlation_id": "cor_def456",
  "payload": {
    "trade_id": "trd_ghi789",
    "signal_id": "sig_jkl012",
    "symbol": "MES",
    "contract": "MESH26",
    "direction": "BUY",
    "quantity": 2,
    "fill_price": 5205.25,
    "stop_loss": 5190.00,
    "take_profit": 5225.50,
    "risk_amount": 305.00,
    "rr_ratio": 2.03,
    "slippage_ticks": 0.5,
    "signal_source": "tradingview_webhook",
    "playbook": "A+ Trendline Break",
    "trendline_grade": "A+",
    "trendline_touches": 4
  }
}
```

**`risk.limit_breach` event:**

```json
{
  "event_type": "risk.limit_breach",
  "user_id": "usr_abc123",
  "timestamp": "2026-02-11T20:15:30Z",
  "correlation_id": "cor_xyz789",
  "payload": {
    "limit_type": "daily_loss",
    "current_value": 1050.00,
    "limit_value": 1000.00,
    "percent_used": 105,
    "auto_action": "execution_paused",
    "open_positions": 2
  }
}
```

**`digest.daily` event:**

```json
{
  "event_type": "digest.daily",
  "user_id": "usr_abc123",
  "timestamp": "2026-02-11T23:00:00Z",
  "correlation_id": "cor_mno345",
  "payload": {
    "date": "2026-02-11",
    "net_pnl": 425.00,
    "net_r": 3.42,
    "trades_count": 4,
    "wins": 3,
    "losses": 1,
    "win_rate": 0.75,
    "best_trade": { "symbol": "MES", "pnl": 370.00, "r": 1.82 },
    "worst_trade": { "symbol": "CL", "pnl": -125.00, "r": -0.65 },
    "active_alerts": 7,
    "daily_loss_used_pct": 0.32
  }
}
```

### 14.2 Template Variable Categories

| Category | Variables | Formatting Rules |
|---|---|---|
| Trade | `symbol`, `direction`, `quantity`, `entry_price`, `exit_price`, `stop_loss`, `take_profit`, `pnl_dollars`, `pnl_ticks`, `r_multiple`, `slippage_ticks` | Monetary: `$X,XXX.XX` with comma separators and 2 decimal places. Ticks: instrument tick-size precision. R-multiple: 2 decimal places with sign. |
| Trendline | `instrument`, `touch_count`, `slope_degrees`, `duration_days`, `grade`, `alert_type` | Grade: letter grade (e.g., `A+`). Slope: 1 decimal. Duration: integer days. |
| Account | `daily_pnl`, `weekly_pnl`, `open_positions_count`, `unrealized_pnl`, `daily_loss_remaining` | All monetary values with sign prefix (`+$425.00` or `-$125.00`). |
| Risk | `limit_type`, `current_value`, `limit_value`, `percent_used` | Percent: integer with `%` suffix. Values: monetary format. |
| Meta | `timestamp_utc`, `timestamp_user_tz`, `platform_url`, `trade_id`, `signal_source` | Timestamps: `YYYY-MM-DD HH:MM:SS TZ` (e.g., `2026-02-11 14:32:05 ET`). |
