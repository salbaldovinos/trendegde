# FSD-011a: App Shell & Navigation

**TrendEdge -- AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-011a |
| Source FSD | FSD-011 (Frontend Dashboard & UI/UX) |
| Title | App Shell & Navigation |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-12 |

---

## 1. Introduction

### 1.1 Purpose

This sub-FSD specifies the application shell, navigation framework, design system, and cross-cutting UI concerns for TrendEdge. It covers every structural element that persists across all pages: the sidebar, header bar, breadcrumbs, Paper/Live mode indicator, command palette, theme system, toast notifications, loading/error/empty states, keyboard shortcuts, responsive breakpoints, and accessibility requirements.

A developer should be able to implement the entire app shell, navigation layer, and design system from this document alone.

### 1.2 Scope

**This document covers:**

- Sidebar navigation (expanded, collapsed, mobile drawer)
- Header bar (breadcrumbs, Paper/Live indicator, notification bell, user menu)
- Command palette (Cmd+K)
- Global loading, error, and empty state patterns
- Toast notification system
- Theme system (dark/light/system, design tokens)
- Color palette, typography, spacing, motion, and icon tokens
- Responsive design breakpoints and mobile adaptations
- Keyboard shortcuts (global and contextual)
- Accessibility (WCAG 2.1 AA)
- Real-time WebSocket connection and status indicators
- Client-side state management (UI store, auth store)
- Security headers, CSP, and authentication cookie handling
- Performance targets (Core Web Vitals, bundle size)

**This document does NOT cover:**

- Dashboard home page widgets (see FSD-011b)
- Trendline detection page and chart (see FSD-011b)
- Trade execution page and journal views (see FSD-011c)
- Analytics dashboard and playbook management (see FSD-011d)
- Settings pages, onboarding wizard, AI chat, and landing page (see FSD-011e)

### 1.3 Sibling Sub-FSDs

| Sub-FSD | Title | Relationship |
|---|---|---|
| FSD-011b | Dashboard Home & Trendline Views | Consumes the app shell layout, sidebar nav, header, theme tokens, loading/error patterns |
| FSD-011c | Execution & Journal Views | Consumes the app shell layout, Paper/Live indicator, toast system, keyboard shortcuts |
| FSD-011d | Analytics & Playbook Views | Consumes the app shell layout, responsive breakpoints, design tokens, loading patterns |
| FSD-011e | Settings, Onboarding & AI Chat | Consumes the app shell layout, theme toggle integration, toast system, accessibility framework |

### 1.4 Cross-References to Backend FSDs

| Referenced FSD | What This Sub-FSD Consumes |
|---|---|
| FSD-001 | Vercel hosting config, CI/CD pipeline, environment variables |
| FSD-003 | Login/signup flows, session management, protected routes |
| FSD-009 | Notification delivery for bell dropdown, real-time alert channels |

### 1.5 Tech Stack

| Layer | Technology | Version |
|---|---|---|
| Framework | Next.js (App Router) | 14+ |
| Language | TypeScript | 5.3+ |
| Styling | Tailwind CSS | 3.4+ |
| Component Library | shadcn/ui | Latest |
| State Management | Zustand | 4.x |
| Data Fetching | TanStack Query (React Query) | 5.x |
| Real-time | WebSocket (native) + Supabase Realtime | N/A |
| Icons | Lucide React | Latest |

---

## 2. Architecture Position

### 2.1 Communication Flow

```
Browser (React) --> Next.js API Routes (BFF) --> FastAPI Backend --> PostgreSQL / Redis / S3 (R2)
Browser (React) <-- WebSocket <-- Supabase Realtime <-- FastAPI Backend
```

The frontend is a Next.js 14+ application deployed on Vercel. It is the sole user-facing layer. Every backend service is consumed through Next.js API routes acting as a Backend-for-Frontend (BFF) proxy. The browser never communicates directly with the FastAPI backend.

### 2.2 Client-Side State Management (Zustand Stores)

The following stores are relevant to the app shell:

| Store | State | Persisted |
|---|---|---|
| `useAuthStore` | `user`, `isAuthenticated`, `mode` (paper/live) | Cookie (server-side) |
| `useUIStore` | `sidebarCollapsed`, `theme`, `dashboardStatsPeriod` | localStorage |
| `useNotificationStore` | `notifications[]`, `unreadCount` | No (API-driven) |

### 2.3 API Response Envelope

All REST API responses follow this format:

```typescript
interface ApiResponse<T> {
  data: T;
  meta?: {
    page?: number;
    page_size?: number;
    total?: number;
    total_pages?: number;
    cursor?: string;
  };
  error?: {
    code: string;
    message: string;
    details?: Record<string, string[]>;
  };
}
```

---

## 3. Functional Specifications

### 3.1 Sidebar Navigation (Collapsible)

**Source**: FE-FR-001

**Description**: A persistent left sidebar providing primary navigation across all application pages. The sidebar has two visual states (collapsed and expanded) and a distinct mobile behavior.

#### 3.1.1 States and Dimensions

| State | Width | Content Displayed | Trigger |
|---|---|---|---|
| Expanded | 240px | Icon + text label for each item | Default on desktop; toggle button |
| Collapsed | 64px | Icon only (centered in 64px) | Toggle button click |
| Mobile Overlay | 280px | Full expanded layout as overlay drawer | Hamburger icon tap in header |

#### 3.1.2 State Transitions

| From | Event | To | Side Effect |
|---|---|---|---|
| Expanded | Click chevron toggle button | Collapsed | Save `sidebar_collapsed=true` to `localStorage` |
| Collapsed | Click chevron toggle button | Expanded | Save `sidebar_collapsed=false` to `localStorage` |
| Mobile Closed | Click hamburger icon in header | Mobile Open (overlay) | Overlay backdrop appears (semi-transparent black) |
| Mobile Open | Click any nav item | Mobile Closed | Navigate to route, close drawer |
| Mobile Open | Click backdrop | Mobile Closed | Drawer closes, no navigation |
| Mobile Open | Press Escape key | Mobile Closed | Drawer closes, no navigation |

#### 3.1.3 Initial State on Page Load

1. Read `sidebar_collapsed` from `localStorage`.
2. If `"true"`, render sidebar in collapsed state.
3. If `"false"` or key does not exist, render sidebar in expanded state.
4. If viewport width < 768px, sidebar is hidden (mobile mode); hamburger icon appears in header.

#### 3.1.4 Navigation Items

Rendered top-to-bottom in this order:

| Order | Icon (Lucide) | Label | Route | Badge Content | Badge Condition |
|---|---|---|---|---|---|
| 1 | LayoutDashboard | Dashboard | `/dashboard` | None | N/A |
| 2 | TrendingUp | Trendlines | `/trendlines` | Number (e.g., "12") | Count of active trendlines > 0 |
| 3 | ArrowRightLeft | Execution | `/execution` | Number (e.g., "3") | Count of pending signals > 0 |
| 4 | BookOpen | Journal | `/journal` | None | N/A |
| 5 | Target | Playbooks | `/playbooks` | None | N/A |
| 6 | BarChart3 | Analytics | `/analytics` | None | N/A |
| 7 | MessageSquare | AI Chat | `/chat` | None | N/A |
| 8 | Settings | Settings | `/settings` | None | N/A |

**Badge Behavior**:
- Badge is a small rounded pill positioned to the top-right of the icon (collapsed) or to the right of the label (expanded).
- Badge background: `hsl(217, 91%, 60%)` (primary blue). Badge text: white, `text-xs` (12px).
- When badge count is 0, the badge is hidden entirely (not shown as "0").
- Badge counts are fetched on app mount and updated via WebSocket events on the `trendlines` and `signals` channels.

**Active State**:
- The nav item matching the current route displays: left border accent (4px solid, `--primary` color), background highlight (`--muted` color).
- Active state uses exact route prefix matching: `/settings/brokers` matches the Settings nav item.

**Hover State**:
- Background changes to foreground color at 8% opacity (e.g., `rgba(241, 245, 249, 0.08)` in dark mode).
- Transition duration: 150ms ease.

#### 3.1.5 Bottom Section

Positioned at the bottom of the sidebar, separated by a `1px` border in `--border` color.

Contains:
- User avatar (32px circle, initials fallback if no avatar)
- Display name (truncated at 16 characters with ellipsis in expanded mode, hidden in collapsed mode)
- Subscription plan badge (Free | Trader | Pro)
- Logout button (LogOut icon)

Clicking the avatar/name opens the same dropdown as the header avatar dropdown.

#### 3.1.6 Accessibility

- Sidebar uses `<nav>` element with `aria-label="Main navigation"`.
- Each nav item is a `<a>` element with proper `href`.
- Active item has `aria-current="page"`.
- Toggle button has `aria-label="Collapse sidebar"` or `"Expand sidebar"` depending on current state.
- Mobile drawer has `role="dialog"`, `aria-modal="true"`, and focus is trapped within the drawer when open.

#### 3.1.7 Error Handling

- If `localStorage` is unavailable (e.g., private browsing in some browsers), default to expanded state. No error shown to the user.
- If badge count API fails, badges are hidden. No error shown to the user; the failure is logged to Sentry.

---

### 3.2 Header Bar

**Source**: FE-FR-002

**Description**: A fixed top header bar spanning the full width of the content area (to the right of the sidebar on desktop, full width on mobile).

#### 3.2.1 Dimensions and Style

- Height: 56px
- Full available width
- Position: fixed to top of content area
- z-index: 40 (below modals at z-50, above content)
- Background: `--background` color with a 1px bottom border in `--border` color

#### 3.2.2 Layout (left to right)

| Position | Component | Details |
|---|---|---|
| Left | Breadcrumb trail | See 3.3 |
| Center | Paper/Live mode indicator | See 3.4 |
| Right | Command palette trigger | Magnifying glass icon + "Cmd+K" hint text (muted, `text-xs`). On click: opens command palette. |
| Right | Notification bell | Bell icon (Lucide `Bell`). Red dot badge if unread count > 0. On click: opens dropdown. |
| Right | User avatar dropdown | 32px circle avatar. On click: opens dropdown menu. |

#### 3.2.3 Notification Bell Dropdown

- Opens on click as a popover panel, 360px wide, max-height 480px with scroll.
- Header: "Notifications" in `text-sm font-semibold`.
- Lists the 10 most recent notifications, each showing: icon (by type), title (bold), description (muted, truncated at 80 chars), relative timestamp (e.g., "5m ago").
- Unread notifications have a subtle left border in `--primary` color.
- "Mark all as read" link in header (right side). Clicking marks all as read and removes the red badge.
- "View all" link at the bottom navigating to `/settings/notifications`.

**States**:

| State | Display |
|---|---|
| Loading | Skeleton list with shimmer |
| Success (with data) | Notification list as described |
| Empty | "No notifications yet." in muted text |
| Error | "Unable to load notifications." with a "Retry" link |

**Data Source**: Notifications fetched from `GET /api/notifications?limit=10`. Unread count updated via WebSocket on the `alerts` channel.

#### 3.2.4 User Avatar Dropdown

- Opens on click as a dropdown menu, 200px wide.
- Items:
  - "Profile" (links to `/settings/profile`)
  - "Settings" (links to `/settings`)
  - Separator
  - "Theme" (sub-menu or toggle with Sun/Moon icons and "Light | Dark | System" options)
  - Separator
  - "Log out" (triggers logout flow)

**Logout**: Clears auth cookies, invalidates session via API call, redirects to `/login`.

#### 3.2.5 Mobile Header (< 768px)

- Left: Hamburger icon (Menu) to open sidebar drawer.
- Center: Paper/Live mode indicator (compact: icon only, no text).
- Right: Notification bell and avatar (no command palette trigger on mobile; command palette is still accessible via keyboard shortcut).

---

### 3.3 Breadcrumb Navigation

**Source**: FE-FR-003

**Description**: Breadcrumbs appear in the header for all routes deeper than the top-level navigation items.

#### 3.3.1 Rendering Rules

- Top-level routes (`/dashboard`, `/trendlines`, `/execution`, `/journal`, `/playbooks`, `/analytics`, `/chat`, `/settings`) show NO breadcrumbs; the page title is sufficient.
- Routes with 2+ segments show breadcrumbs.
- Each segment except the last is a clickable `<a>` link styled in `--muted-foreground` color with underline on hover.
- The last segment is plain text in `--foreground` color (not clickable).
- Separator character: `/` in `--muted-foreground` color with `mx-2` spacing.

#### 3.3.2 Dynamic Segment Formatting

| Route Pattern | Breadcrumb Rendering | Example |
|---|---|---|
| `/journal/trade/[id]` | `Journal / Trade #[id]` | `Journal / Trade #47` |
| `/playbooks/[id]` | `Playbooks / [Playbook Name]` | `Playbooks / A+ Trendline Break` |
| `/playbooks/[id]/analytics` | `Playbooks / [Playbook Name] / Analytics` | `Playbooks / A+ Break / Analytics` |
| `/settings/[section]` | `Settings / [Section Label]` | `Settings / Broker Connections` |
| `/playbooks/compare` | `Playbooks / Compare` | `Playbooks / Compare` |

**Truncation**: Playbook names exceeding 24 characters are truncated with an ellipsis. Full name appears in a tooltip on hover.

#### 3.3.3 Edge Cases

- If a trade ID does not exist (404 from API), the breadcrumb still renders as `Trade #[id]` but the page content shows the error state.
- If a playbook is deleted while the user is viewing it, the breadcrumb renders the last known name.

#### 3.3.4 Accessibility

Breadcrumbs are wrapped in a `<nav>` element with `aria-label="Breadcrumb"`. The ordered list uses `<ol>` with `<li>` elements. The current page item has `aria-current="page"`.

---

### 3.4 Paper/Live Mode Indicator

**Source**: FE-FR-004

**Description**: A persistent, always-visible badge in the center of the header indicating whether the user is in Paper Trading or Live Trading mode.

#### 3.4.1 Visual States

| Mode | Icon (Lucide) | Text | Background | Text Color | Border |
|---|---|---|---|---|---|
| Paper | TestTube | "PAPER TRADING" | `bg-blue-500/10` | `text-blue-500` | `border-blue-500/20` |
| Live | Zap | "LIVE TRADING" | `bg-green-500/10` | `text-green-500` | `border-green-500/20` |

**Additional Visual Cue**: In Paper mode, a 2px blue (`--mode-paper`) top border spans the full width of the application viewport above the header. In Live mode, no additional border.

#### 3.4.2 Behavior

- **Click**: Clicking the badge opens the Paper/Live toggle dialog (specified in FSD-011c, section for Paper/Live Mode Toggle).
- **Data Source**: The current mode is stored in the Zustand `useAuthStore`, sourced from the user's profile settings API on app mount.
- **Mobile (< 768px)**: The badge displays only the icon (TestTube or Zap) without text, to save horizontal space. The icon retains its color coding.

---

### 3.5 Command Palette

**Source**: FE-FR-005

**Description**: A modal command palette for rapid navigation and search, triggered by keyboard shortcut or button click.

#### 3.5.1 Trigger

- Keyboard: `Cmd+K` (macOS) or `Ctrl+K` (Windows/Linux).
- Click: Command palette trigger button in the header.
- The keyboard shortcut is suppressed when focus is inside a `<input>`, `<textarea>`, or `[contenteditable]` element.

#### 3.5.2 Appearance

- Modal dialog centered on screen, 560px wide, max-height 480px.
- Semi-transparent backdrop (`bg-black/50`).
- Rounded corners (`rounded-lg`), shadow (`shadow-2xl`), background `--popover`.

#### 3.5.3 Search Input

- Auto-focused on open.
- Placeholder: `"Search pages, instruments, trades..."`.
- Full width, no border, large text (`text-lg`).
- Debounce: Local results (pages, actions) filter instantly (< 16ms). API-backed results (instruments, trades, playbooks) debounce at 200ms.

#### 3.5.4 Result Categories

Displayed as grouped sections with headers:

| Category | Source | Max Items | Item Format |
|---|---|---|---|
| Pages | Static list | 8 | Icon + Page name |
| Instruments | Static list (8 MVP instruments) | 8 | Instrument symbol + name + current price + daily change % |
| Recent Trades | API: last 10 trades | 10 | Instrument + direction + P&L (colored) + date |
| Playbooks | API: user playbooks | All | Playbook name + trade count |
| Actions | Static list | 5 | Icon + Action name |

**Actions list**: "New Trade Entry" (navigates to `/execution` and opens trade form), "New Playbook" (navigates to `/playbooks` and opens create form), "Toggle Theme" (switches theme), "Open Settings" (navigates to `/settings`).

#### 3.5.5 Fuzzy Matching

As the user types, results filter across all categories. Matching characters in result labels are rendered in bold (`font-semibold`). Matching algorithm: substring match (case-insensitive) for MVP.

#### 3.5.6 Keyboard Navigation

- Arrow Up/Down: Move highlight between results.
- Enter: Select highlighted result (navigate or execute action).
- Escape: Close the palette.
- The first result is highlighted by default.

#### 3.5.7 Performance

- Local results render within 100ms of keystroke.
- API results render within 300ms total (200ms debounce + 100ms render).

#### 3.5.8 States

| State | Display |
|---|---|
| Initial (no query) | All Pages and Actions shown. No API results. |
| Typing (results found) | Filtered results across categories |
| No results | "No results found for '[query]'" in muted text |
| API error | Categories with failed API calls are omitted silently. Pages and Actions (static) always display. |

---

### 3.6 Global Loading States

**Source**: FE-FR-006

**Description**: Consistent loading patterns applied across all pages and widgets.

#### 3.6.1 Page-Level Loading

- Display a full-page skeleton layout matching the shape of the page's content areas (card outlines, table row placeholders, chart area rectangles).
- No spinner is used.
- Skeleton elements use a shimmer animation: a left-to-right gradient sweep cycling every 1.5s (`linear`, infinite loop).
- The skeleton must be visible for a minimum of 200ms even if data arrives faster, to prevent a perceptive "flash" of skeleton.
- When `prefers-reduced-motion` is active, skeletons render as static gray blocks without the shimmer animation.

#### 3.6.2 Widget-Level Loading

- Individual widgets within a page load independently via React Suspense boundaries.
- Each widget displays its own skeleton matching its content shape (e.g., 3-row table skeleton for a positions widget, a rectangular area for a chart).

#### 3.6.3 Background Refetch Loading

- When data is being refetched while stale content is already displayed, a thin (2px) progress bar appears at the top of the content area.
- The progress bar uses `--primary` color and animates from left to right (indeterminate style).
- Existing content remains visible and interactive during the refetch.

#### 3.6.4 Error Boundary Behavior

Every page-level component and every widget-level component is wrapped in a React Error Boundary.

When an error boundary catches an error:

1. **Display**: A card with a red-tinted warning icon, heading "Something went wrong", and a collapsible "Details" section showing the error message (not the stack trace in production).
2. **Action**: A "Retry" button that re-renders the component (resetting the error boundary state).
3. **Logging**: The error is automatically reported to Sentry with component name, route, user ID, and timestamp.

One widget failing does NOT crash adjacent widgets or the page shell.

#### 3.6.5 Empty State Pattern

Each empty state includes:
- An icon or illustration (from Lucide, 48px)
- A descriptive heading (`text-lg font-semibold`)
- A description sentence (`text-sm text-muted-foreground`)
- An action CTA button (primary variant)

Specific empty state content is defined per-widget in sibling sub-FSDs (FSD-011b through FSD-011e).

---

### 3.7 Toast Notifications

**Source**: FE-FR-007

**Description**: A global toast notification system for transient user feedback.

#### 3.7.1 Position and Layout

- Position: Bottom-right corner of the viewport.
- 16px margin from screen edges.
- Toasts stack vertically with an 8px gap between them.

#### 3.7.2 Toast Types and Styling

| Type | Left Border Color | Icon (Lucide) | Auto-Dismiss |
|---|---|---|---|
| `success` | `--profit` (#22C55E) | CheckCircle | 5 seconds |
| `error` | `--loss` (#EF4444) | XCircle | 8 seconds |
| `warning` | `--alert-near` (#EAB308) | AlertTriangle | 5 seconds |
| `info` | `--primary` (#3B82F6) | Info | 5 seconds |

#### 3.7.3 Toast Content

Icon (20px) + Title (`font-semibold text-sm`) + optional Description (`text-sm text-muted-foreground`). Maximum 2 lines of text total. If content exceeds 2 lines, it is truncated with an ellipsis.

#### 3.7.4 Behavior

- Auto-dismiss timer starts when the toast appears.
- Hovering over a toast pauses the dismiss timer. Timer resumes on mouse leave.
- Swiping right (touch) or clicking the X button (top-right corner, 16px) dismisses the toast immediately.
- Dismiss animation: toast slides out to the right over 200ms.
- Enter animation: toast slides in from the right over 300ms with spring easing.

#### 3.7.5 Queue

Maximum 3 toasts visible simultaneously. If a 4th toast is triggered, it queues and appears when the oldest visible toast dismisses.

#### 3.7.6 Accessibility

Toasts are rendered in a `<div>` with `role="status"` and `aria-live="polite"`. Error toasts use `aria-live="assertive"`.

---

### 3.8 WebSocket Integration

**Source**: FE-FR-050

#### 3.8.1 Connection Lifecycle

1. WebSocket connection established on app mount (after authentication).
2. Auth token passed as a query parameter: `wss://api.trendedge.com/ws?token=[jwt]`.
3. Server validates the token before accepting the connection.
4. On disconnect: automatic reconnection with exponential backoff: 1s, 2s, 4s, 8s, 16s, max 30s.

#### 3.8.2 Connection Status Indicator

Small dot in the header, visible only on hover or when NOT connected.

| Status | Dot Color | Animation |
|---|---|---|
| Connected | Green | None |
| Reconnecting | Yellow | Pulse |
| Disconnected | Red | None |

#### 3.8.3 Subscribed Channels

| Channel | Event | UI Update |
|---|---|---|
| `positions` | Position opened/closed/updated | Active positions table (dashboard + execution), P&L card |
| `fills` | Order filled | Toast notification, position update, journal entry auto-created |
| `trendlines` | New trendline detected / alert triggered | Trendline list, dashboard widget, chart overlay, sidebar badge |
| `signals` | New signal generated | Pending signals queue, sidebar badge |
| `account` | Balance/margin update | Dashboard equity stat, account info |
| `alerts` | Notification dispatched | Notification bell badge increment, toast |

#### 3.8.4 Stale Data Detection

If the WebSocket disconnects for > 60 seconds, on reconnection the client performs a full data refresh for all currently visible widgets by invalidating all TanStack Query caches.

#### 3.8.5 Fallback

If WebSocket fails to connect after 5 reconnection attempts (total ~2 minutes), display a persistent banner: "Real-time updates are unavailable. Data may be outdated. Refresh the page to get the latest data." All data continues to display from the last successful fetch.

---

## 4. Design System Tokens

### 4.1 Color Palette (Dark Theme -- Default)

```
Background:
  --background:          hsl(222, 47%, 6%)    #0B0F19
  --card:                hsl(222, 41%, 9%)    #0E1424
  --popover:             hsl(222, 41%, 9%)    #0E1424
  --muted:               hsl(222, 30%, 15%)   #1A2035

Foreground:
  --foreground:          hsl(210, 40%, 96%)   #F1F5F9
  --card-foreground:     hsl(210, 40%, 96%)   #F1F5F9
  --muted-foreground:    hsl(215, 20%, 55%)   #7B8BA5

Border:
  --border:              hsl(222, 25%, 18%)   #232D42
  --input:               hsl(222, 25%, 22%)   #2A3550
  --ring:                hsl(217, 91%, 60%)   #3B82F6

Accent:
  --primary:             hsl(217, 91%, 60%)   #3B82F6
  --primary-foreground:  hsl(0, 0%, 100%)     #FFFFFF
  --secondary:           hsl(222, 30%, 15%)   #1A2035
  --destructive:         hsl(0, 84%, 60%)     #EF4444

Trading:
  --profit:              #22C55E
  --loss:                #EF4444
  --breakeven:           #7B8BA5
  --grade-aplus:         #F59E0B
  --grade-a:             #3B82F6
  --grade-b:             #6B7280
  --mode-paper:          #3B82F6
  --mode-live:           #22C55E
  --alert-watching:      #7B8BA5
  --alert-near:          #EAB308
  --alert-triggered:     #22C55E
```

### 4.2 Color Palette (Light Theme)

```
Background:
  --background:          hsl(0, 0%, 100%)     #FFFFFF
  --card:                hsl(0, 0%, 98%)      #FAFAFA
  --muted:               hsl(210, 40%, 96%)   #F1F5F9

Foreground:
  --foreground:          hsl(222, 47%, 11%)   #0F172A
  --muted-foreground:    hsl(215, 16%, 47%)   #64748B

Border:
  --border:              hsl(214, 32%, 91%)   #E2E8F0

(Trading colors remain the same as dark theme.)
```

### 4.3 Typography

```
Font Families:
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif
  --font-mono: 'JetBrains Mono', 'Fira Code', monospace

Scale:
  text-xs:     12px / 16px   (labels, captions, timestamps)
  text-sm:     14px / 20px   (body text, table cells, form labels)
  text-base:   16px / 24px   (default body, descriptions)
  text-lg:     18px / 28px   (section headings, card titles)
  text-xl:     20px / 28px   (page subtitles)
  text-2xl:    24px / 32px   (page titles)
  text-3xl:    30px / 36px   (hero numbers, P&L)
  text-4xl:    36px / 40px   (landing page headings)

Weights:
  font-normal:   400   (body text)
  font-medium:   500   (labels, table headers)
  font-semibold: 600   (headings, metric values)
  font-bold:     700   (emphasis, P&L amounts)

Monospace Usage:
  All prices, dollar amounts, percentages, R-multiples, and numeric metrics
  use --font-mono for tabular number alignment.
```

### 4.4 Spacing

Base unit: 4px (Tailwind default).

| Token | Size | Usage |
|---|---|---|
| `p-1` / `gap-1` | 4px | Badge internal padding |
| `p-2` / `gap-2` | 8px | Table cells, between related items |
| `p-3` | 12px | Input padding |
| `p-4` / `gap-4` | 16px | Card padding (standard), between cards |
| `p-6` / `gap-6` | 24px | Section spacing |
| `p-8` / `gap-8` | 32px | Between major page areas |
| `p-10` | 40px | Page padding |

### 4.5 Motion and Animation

| Animation | Duration | Easing | Usage | Reduced Motion |
|---|---|---|---|---|
| Theme transition | 200ms | ease-in-out | Background/text color change | Instant |
| Sidebar collapse | 200ms | ease-in-out | Width change | Instant |
| Modal enter | 200ms | ease-out | Dialog/Sheet open | Instant |
| Modal exit | 150ms | ease-in | Dialog/Sheet close | Instant |
| Toast enter | 300ms | spring | Slide in from right | Instant |
| Toast exit | 200ms | ease-in | Slide out right | Instant |
| Skeleton shimmer | 1.5s | linear, infinite | Loading placeholder | Static gray |
| Alert pulse | 2s | ease-in-out, infinite | Near-alert indicator | Static color |
| Chart draw | 500ms | ease-out | Initial chart render | Instant |
| Data transition | 300ms | ease-in-out | Metric value changes | Instant |
| Hover state | 150ms | ease | Button/card hover | Instant |

### 4.6 Chart Color Conventions

| Data Type | Color | Hex |
|---|---|---|
| Profit / Positive | Green | `#22C55E` |
| Loss / Negative | Red | `#EF4444` |
| Breakeven / Neutral | Gray | `#7B8BA5` |
| Equity Curve (primary) | Blue | `#3B82F6` |
| Equity Curve (comparison) | Purple | `#8B5CF6` |
| Drawdown Area | Red at 30% opacity | `#EF4444` at 0.3 alpha |
| Stop Loss Level | Red dashed | `#EF4444` |
| Take Profit Level | Green dashed | `#22C55E` |
| Entry Marker | Blue dashed vertical | `#3B82F6` |
| Exit Marker | Purple dashed vertical | `#8B5CF6` |

### 4.7 Icon Sizes

| Context | Size |
|---|---|
| Navigation icons | 20px |
| Inline/button icons | 16px |
| Status dots | 8px |
| Card header / empty state | 24px |
| Landing page feature icons | 32px |

---

## 5. Theme System

**Source**: FE-FR-052

### 5.1 Dark/Light Mode

**Default**: Dark mode.

**Three-State Toggle**: Light | Dark | System. Available in header user dropdown and Settings > Appearance (FSD-011e).

### 5.2 Resolution Order (on initial page load)

1. Check cookie `theme` (set during SSR to prevent flash).
2. Check `localStorage` key `theme`.
3. Check `prefers-color-scheme` OS media query.
4. Default to `dark`.

### 5.3 Transition

200ms CSS transition on `background-color` and `color` properties on theme switch.

### 5.4 SSR Flash Prevention

Theme cookie is read server-side so Next.js renders the correct theme class on the `<html>` element during SSR. No white flash on dark-mode clients.

### 5.5 Theme Behavior

- **Dark Theme Colors**: See Section 4.1.
- **Light Theme Colors**: See Section 4.2. Inverted background/foreground. Trading semantic colors (green profit, red loss) remain the same in both themes.

### 5.6 Feature Flag

Light mode is gated behind `NEXT_PUBLIC_ENABLE_LIGHT_MODE` (default `false`, Phase 3). When disabled, only dark mode is available and the theme toggle is hidden.

---

## 6. Responsive Design

**Source**: FE-FR-051

### 6.1 Breakpoints

| Breakpoint | Width | Name | Layout Notes |
|---|---|---|---|
| Mobile | < 768px | `sm` | Single column, drawer nav, stacked cards, bottom tab bar |
| Tablet | 768-1279px | `md` | Two columns, collapsible sidebar, responsive charts |
| Desktop | 1280-1535px | `lg` | Three columns where applicable, expanded sidebar |
| Wide | >= 1536px | `xl` | Full layout, maximum chart area |

### 6.2 Mobile Navigation

Bottom tab bar replacing sidebar. Tabs: Dashboard, Trendlines, Journal, More (dropdown with: Execution, Playbooks, Analytics, Chat, Settings).

### 6.3 Tables on Mobile

Horizontal scroll with fixed first column (instrument name). Alternatively, card-based layout replacing table rows (trade table renders as trade cards on mobile).

### 6.4 Charts on Mobile

Full width. Touch interactions (pinch-zoom, pan). Detail panels stack below charts.

### 6.5 Touch Targets

All interactive elements have minimum 44px touch target size on mobile.

---

## 7. Keyboard Shortcuts

**Source**: FE-FR-053

### 7.1 Global Shortcuts

| Shortcut | Action | Context |
|---|---|---|
| `Cmd+K` / `Ctrl+K` | Open command palette | Global |
| `Cmd+/` / `Ctrl+/` | Show keyboard shortcuts help dialog | Global |
| `G` then `D` | Navigate to Dashboard | Global (vim-style sequence, 500ms timeout between keys) |
| `G` then `T` | Navigate to Trendlines | Global |
| `G` then `E` | Navigate to Execution | Global |
| `G` then `J` | Navigate to Journal | Global |
| `G` then `P` | Navigate to Playbooks | Global |
| `G` then `A` | Navigate to Analytics | Global |
| `G` then `C` | Navigate to AI Chat | Global |
| `G` then `S` | Navigate to Settings | Global |
| `N` | New trade entry (opens form) | Journal, Execution pages only |
| `Escape` | Close modal/panel/palette | Global |
| `[` / `]` | Previous / Next item | Trade detail view |
| `F` | Toggle favorite instrument | Trendlines page |
| `?` | Show contextual help | Global |

### 7.2 Suppression

All shortcuts are suppressed when focus is in a `<input>`, `<textarea>`, or `[contenteditable]` element. This prevents interference with typing.

### 7.3 Help Dialog

`Cmd+/` opens a modal listing all shortcuts grouped by context (Global, Navigation, Trade Detail, Trendlines). The modal has sections with shortcut key badges and descriptions.

---

## 8. Accessibility

**Source**: FE-FR-054

### 8.1 WCAG 2.1 AA Compliance

**Color Contrast**: All text meets 4.5:1 ratio (normal text) and 3:1 (large text) in both themes. Green/red chart colors are supplemented with patterns or shapes (filled vs. hollow circles, solid vs. dashed lines) for color-blind users.

**Keyboard Navigation**: All interactive elements reachable via Tab. Focus order matches visual order. Visible focus indicators: 2px ring in `--primary` color.

**Screen Reader Support**: All images have `alt` text. Charts have `aria-label` describing data trends. Tables use `<th>` with `scope`. Dynamic content updates use `aria-live` regions.

**Reduced Motion**: When `prefers-reduced-motion` is set, all animations are disabled (skeleton shimmer, chart draw, alert pulse, toast slide, modal transitions all render instantly).

**Form Accessibility**: All inputs have `<label>` elements. Error messages linked via `aria-describedby`. Required fields marked with `aria-required="true"`.

**Skip Navigation**: "Skip to main content" link as the first focusable element on every page.

**Semantic HTML**: `<nav>`, `<main>`, `<aside>`, `<section>`, `<article>`, proper heading hierarchy (`h1` through `h6`).

### 8.2 Accessibility in Shell Components

| Component | Accessibility Details |
|---|---|
| Sidebar | `<nav aria-label="Main navigation">`, active item `aria-current="page"`, toggle `aria-label` |
| Mobile drawer | `role="dialog"`, `aria-modal="true"`, focus trap |
| Breadcrumbs | `<nav aria-label="Breadcrumb">`, `<ol>/<li>`, current item `aria-current="page"` |
| Command palette | `role="dialog"`, `aria-modal="true"`, `aria-label="Command palette"`, result list uses `role="listbox"` with `role="option"` items |
| Toast notifications | `role="status"`, `aria-live="polite"` (errors: `aria-live="assertive"`) |
| Notification bell | `aria-label="Notifications, [n] unread"` (dynamic count) |

---

## 9. Security Specifications

### 9.1 Authentication

- Auth tokens (JWT) stored in `httpOnly`, `Secure`, `SameSite=Strict` cookies.
- Tokens NEVER stored in `localStorage` or `sessionStorage`.
- Tokens NEVER exposed to client-side JavaScript.
- Token refresh handled transparently by the BFF on 401 responses.
- Logout clears all auth cookies and invalidates the server-side session.

### 9.2 Content Security Policy

```
Content-Security-Policy:
  default-src 'self';
  script-src 'self' 'unsafe-eval' 'unsafe-inline' https://vercel.live;
  style-src 'self' 'unsafe-inline';
  img-src 'self' blob: data: https://*.r2.cloudflarestorage.com;
  font-src 'self';
  connect-src 'self' wss://*.trendedge.com https://*.trendedge.com https://*.supabase.co;
  frame-src 'none';
  object-src 'none';
  base-uri 'self';
```

### 9.3 Additional Security Headers

```
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: camera=(), microphone=(), geolocation=()
Strict-Transport-Security: max-age=63072000; includeSubDomains; preload
```

### 9.4 Input Sanitization

- All form inputs validated client-side using Zod schemas before submission.
- Text fields sanitized with DOMPurify before rendering.
- Search queries parameterized; no raw SQL construction on the frontend.
- `dangerouslySetInnerHTML` is NEVER used except for markdown content processed through `react-markdown` with `rehype-sanitize`.
- URL parameters validated against allowlists before use in API calls.

### 9.5 Error Response Handling

| HTTP Status | Error Code | Frontend Behavior |
|---|---|---|
| 400 | `validation_error` | Display field-specific messages from `details` object |
| 401 | `unauthorized` | Attempt token refresh. If fails: redirect to `/login`, toast "Session expired. Please log in again." |
| 403 | `forbidden` | Toast (error): "You do not have permission to perform this action." |
| 404 | `not_found` | Show component-specific "not found" state |
| 409 | `conflict` | Toast (error) with conflict message from API |
| 422 | `unprocessable_entity` | Display specific validation error from API |
| 429 | `rate_limited` | Toast (warning): "Too many requests. Please wait a moment." Retry with backoff. |
| 500 | `internal_error` | Toast (error): "Something went wrong." Log to Sentry. Show retry button. |
| Timeout (>10s) | N/A | Toast (error): "Request timed out. Please try again." |
| Network error | N/A | Toast (error): "Network error. Please check your connection." |

### 9.6 Retry Strategy

Failed GET requests retry up to 3 times with exponential backoff (1s, 2s, 4s). Configured via TanStack Query's `retry` option. Mutations (POST/PUT/DELETE) do NOT auto-retry to prevent duplicate actions.

---

## 10. Performance Specifications

### 10.1 Core Web Vitals Targets

| Metric | Target | Measurement |
|---|---|---|
| First Contentful Paint (FCP) | < 1.5 seconds (4G connection) | Vercel Analytics, Lighthouse CI |
| Largest Contentful Paint (LCP) | < 2.5 seconds | Lighthouse CI |
| Time to Interactive (TTI) | < 3 seconds (4G connection) | Lighthouse CI |
| Cumulative Layout Shift (CLS) | < 0.1 | Lighthouse CI |
| First Input Delay (FID) | < 100ms | Vercel Analytics |
| Lighthouse Performance Score | >= 90 | Lighthouse CI on every PR |
| Lighthouse Accessibility Score | >= 90 | Lighthouse CI on every PR |

### 10.2 Response Time Requirements

| Operation | Target | Notes |
|---|---|---|
| Client-side page navigation | < 500ms | Next.js client-side transitions |
| Command palette result rendering | < 100ms (local), < 300ms (API) | Local = pages/actions; API = trades/playbooks |
| WebSocket message to UI update | < 200ms | From message receipt to rendered DOM change |

### 10.3 Bundle Size Targets

| Bundle | Target (gzipped) | Enforcement |
|---|---|---|
| Initial JS (first load) | < 150 KB | `next build` output |
| Per-route JS chunk | < 50 KB | `next build` output |
| Total CSS | < 30 KB | Tailwind purge output |

Bundle analyzer (`@next/bundle-analyzer`) runs in CI. Alert if any chunk exceeds target by > 10%.

### 10.4 Caching Strategy (TanStack Query)

| Data Type | Stale Time | Cache Time | Refetch On |
|---|---|---|---|
| Settings data | 1 hour | 24 hours | Mutation |
| Notification data | 30 seconds | 5 minutes | WebSocket event, window focus |

Stale-While-Revalidate: stale cached data is served immediately while a background refetch occurs. Cache invalidation triggers: WebSocket events, mutations, window focus, and manual retry.

### 10.5 Offline Resilience

When network connectivity is lost:

1. Banner at top of page: "You are offline. Some features may be unavailable." (yellow background, dismissible).
2. Cached data remains visible and readable.
3. Write operations are queued in an IndexedDB-backed queue and synced when connectivity returns.
4. Real-time data shows "stale" indicator (yellow clock icon) with the timestamp of the last update.
5. On reconnection: queued writes are replayed in order. If a write conflicts with newer server data, the server data wins and the user is notified via toast.

---

## 11. Feature Flags

Feature flags are implemented via environment variables and a simple `featureFlags` utility:

| Flag | Default | Purpose |
|---|---|---|
| `NEXT_PUBLIC_ENABLE_AI_CHAT` | `false` | Gates the AI Chat page and nav item (Phase 2) |
| `NEXT_PUBLIC_ENABLE_LIGHT_MODE` | `false` | Gates the light mode theme toggle (Phase 3) |

When a feature flag is `false`:
- The corresponding navigation item is hidden from the sidebar.
- The route returns a 404 page.
- Related API calls are not made.

---

## 12. Deployment & Environment

### 12.1 Environment Variables (Shell-Relevant)

| Variable | Required | Description |
|---|---|---|
| `BACKEND_URL` | Yes | FastAPI backend base URL (server-side only) |
| `NEXT_PUBLIC_WS_URL` | Yes | WebSocket URL for Supabase Realtime |
| `NEXT_PUBLIC_SENTRY_DSN` | Yes | Sentry error reporting DSN |
| `NEXT_PUBLIC_ENABLE_*` | No | Feature flags (see Section 11) |

### 12.2 Sentry Integration

- Sentry SDK initialized on app mount.
- Captured: Unhandled JavaScript errors (via Error Boundaries and global handler), API errors (4xx/5xx with URL and status, NOT request bodies), WebSocket disconnection events > 60 seconds, performance transactions.
- NOT captured: User credentials, API keys, trade data, P&L values, full request/response bodies.

---

## 13. Testing Specifications

### 13.1 Unit Testing

**Framework**: Jest + React Testing Library

**Coverage Targets**: Component coverage > 80%, branch coverage > 70%, execution time < 60 seconds.

**Key Test Scenarios for App Shell**:

| Component / Feature | Test Cases |
|---|---|
| Sidebar Navigation | Renders all 8 nav items. Active item highlights correctly by route prefix. Collapsed state persists via localStorage. Mobile drawer opens/closes. Badge counts update. |
| Header Bar | Renders breadcrumbs, mode indicator, notification bell, avatar. Correct layout on mobile. |
| Breadcrumbs | Renders for nested routes, hidden for top-level. Dynamic segment formatting. Truncation with tooltip at 24 chars. |
| Paper/Live Indicator | Paper: blue badge with TestTube icon. Live: green badge with Zap icon. Mobile: icon only. |
| Command Palette | `Cmd+K` opens. Filters results by substring. Highlights matches. Arrow keys navigate. Enter selects. Escape closes. Suppressed in text inputs. |
| Toast System | Auto-dismiss at correct intervals (5s success, 8s error). Max 3 visible. Queue works. Hover pauses timer. |
| Theme Toggle | Reads from localStorage/cookie. Falls back to system preference. Falls back to dark. Transition animates (or instant with reduced-motion). |
| Keyboard Shortcuts | `Cmd+K` opens palette. `G` then `D` navigates to Dashboard. Suppressed in text inputs. |
| Loading States | Skeleton shimmer animates. Minimum 200ms display. Reduced-motion: static gray. Error boundary renders retry button. |
| WebSocket Status | Green dot when connected. Yellow pulse when reconnecting. Red when disconnected. Banner after 5 failed attempts. |
| Zustand Stores | Sidebar state persists. Theme state propagates. Mode changes propagate globally. |

### 13.2 End-to-End Testing

**Framework**: Playwright

**App Shell E2E Journeys**:

| # | Journey | Key Assertions |
|---|---|---|
| 1 | Navigation | Sidebar renders. Click each nav item verifies correct route. Active state highlight matches current page. |
| 2 | Sidebar Collapse | Click toggle collapses to 64px. Refresh preserves collapsed state. Click toggle expands to 240px. |
| 3 | Mobile Navigation | At 375px viewport: sidebar hidden, hamburger icon visible. Tap hamburger opens drawer. Tap nav item closes drawer and navigates. |
| 4 | Command Palette | `Cmd+K` opens. Type "journal" > see Journal in results > press Enter > verify navigation. Escape closes. |
| 5 | Theme Toggle | Open user menu > change theme to light > verify background color change. Change to system > verify respects OS setting. |
| 6 | Paper/Live Badge | Verify badge shows "PAPER TRADING" in blue. Click opens toggle dialog. |
| 7 | Notification Bell | Click bell > dropdown opens > shows notifications or empty state. "Mark all as read" clears badge. |
| 8 | Responsive Layout | Run at 375px, 768px, 1280px, 1536px. Verify layout adapts: single column, sidebar, expanded sidebar. |
| 9 | Keyboard Shortcuts | `G` then `D` navigates to Dashboard. `Cmd+/` opens help dialog. Shortcuts suppressed in text inputs. |
| 10 | Error Recovery | Trigger API error > verify error boundary shows retry button > click retry > verify recovery. |

### 13.3 Visual Regression Testing

**Framework**: Playwright screenshot comparison or Chromatic (Storybook)

**Critical Screenshots for App Shell**:
- Sidebar expanded (dark theme)
- Sidebar collapsed (dark theme)
- Sidebar expanded (light theme)
- Mobile drawer open (375px)
- Header with Paper mode badge
- Header with Live mode badge
- Command palette open with results
- Toast notification stack (all 4 types)
- Keyboard shortcuts help dialog
- Notification bell dropdown (populated and empty)

Pixel difference tolerance: 0.1%.

### 13.4 Accessibility Testing

**Framework**: axe-core (`@axe-core/playwright` for E2E, `jest-axe` for unit)

- Every page: zero "critical" and "serious" axe-core violations.
- Manual testing: keyboard-only navigation through all shell components.
- Screen reader testing: VoiceOver (macOS) for sidebar, header, command palette, and toast notifications.

### 13.5 Performance Testing

**Framework**: Lighthouse CI (`@lhci/cli`)

- Runs on every PR against Vercel preview deployment.
- Assertions: Performance >= 90, Accessibility >= 90, FCP <= 1500ms, LCP <= 2500ms, TTI <= 3000ms, CLS <= 0.1.
- Performance budget file (`budget.json`) enforces bundle size limits.

### 13.6 Cross-Browser Testing

| Browser | Version | Priority | Testing Level |
|---|---|---|---|
| Chrome | Latest 2 | P0 | Full E2E + visual regression |
| Firefox | Latest 2 | P0 | Full E2E |
| Safari | Latest 2 | P0 | Full E2E |
| Edge | Latest 2 | P1 | Smoke test (critical journeys) |
| Mobile Safari (iOS) | Latest | P1 | Responsive smoke test |
| Chrome (Android) | Latest | P1 | Responsive smoke test |

Responsive breakpoint testing: 375px (iPhone SE), 390px (iPhone 14), 768px (iPad), 1024px (iPad Pro landscape). Verified: no horizontal overflow, 44px minimum touch targets.

---

## 14. Phase Summary

| Phase | Shell Deliverables |
|---|---|
| Phase 1 (Weeks 7-8) | App shell, sidebar nav, header, breadcrumbs, Paper/Live indicator, skeleton loading, error boundaries, dark mode, WebSocket connection |
| Phase 2 (Weeks 9-14) | Command palette, toast system, keyboard shortcuts, notification bell dropdown |
| Phase 3 (Weeks 17-18) | Light mode, full accessibility audit, onboarding integration, help dialogs |

---

## 15. Glossary

| Term | Definition |
|---|---|
| BFF | Backend for Frontend. A server-side proxy layer (Next.js API routes) that mediates between the browser and the backend API. |
| CLS | Cumulative Layout Shift. A Core Web Vital measuring visual stability. |
| CSP | Content Security Policy. HTTP header controlling which resources the browser may load. |
| FCP | First Contentful Paint. A Core Web Vital measuring perceived load speed. |
| LCP | Largest Contentful Paint. A Core Web Vital measuring loading performance. |
| TTI | Time to Interactive. A Core Web Vital measuring when the page becomes fully interactive. |
| WCAG | Web Content Accessibility Guidelines. International standard for web accessibility. |

---

*End of FSD-011a: App Shell & Navigation*
