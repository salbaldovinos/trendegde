# FSD-006a: Metrics Engine

**TrendEdge — AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-006a |
| Source | FSD-006 (Performance Analytics) |
| Title | Metrics Engine |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-12 |

**Sibling Sub-FSDs:**
- FSD-006b: Visualization & Dashboard (layout, widgets, charts, filtering, interactivity)
- FSD-006c: Advanced Analytics — Pro Tier (Monte Carlo, walk-forward, AI insights, comparative)

---

## 1. Introduction

### 1.1 Purpose

This sub-FSD defines the complete behavioral specification for the TrendEdge Metrics Engine: the computation layer that transforms raw closed-trade records into 30+ individual performance metrics across 7 categories. It covers exact formulas, precision, edge-case handling, caching/invalidation logic, minimum data thresholds, recalculation triggers, and the API endpoints that serve computed metrics. A developer should be able to implement the entire metrics computation pipeline using only this document.

### 1.2 Scope

**In scope:**
- 7 metric categories: Trade Performance, Risk-Adjusted, R-Multiple, Time-Based, Execution Quality, Behavioral, Trendline-Specific
- 30+ individual metric formulas with exact precision and edge-case behavior
- Materialized views and cache tables for metric storage
- Redis cache layer with TTL and invalidation rules
- API endpoints for metrics retrieval (REST)
- Incremental recalculation on trade close
- Minimum data thresholds and insufficient-data responses
- Tier-based metric availability
- Performance targets for computation latency

**Out of scope (covered by sibling sub-FSDs):**
- Dashboard layout, responsive grid, widget states, drag-and-drop (FSD-006b)
- Chart visualizations (equity curve, heatmap, scatter plots, etc.) (FSD-006b)
- Filtering UI, URL state management, date/instrument/playbook pickers (FSD-006b)
- Export system (PDF, CSV) (FSD-006b)
- WebSocket real-time push protocol (FSD-006b)
- Monte Carlo simulation, correlation matrix, walk-forward analysis (FSD-006c)
- AI-powered insights, comparative analytics (FSD-006c)
- Team-tier aggregated analytics and leaderboards (FSD-006c)

### 1.3 Architecture Context

| Layer | Technology | Role in Metrics Engine |
|---|---|---|
| Database | PostgreSQL 16 (Supabase) | Source trade data, materialized views, metric cache table, RLS enforcement |
| Compute | FastAPI (Python 3.12+) | Metric computation logic, API endpoints |
| Cache | Redis (Upstash) | Computed metrics cache (5-min TTL), rate limit counters |
| Data Source | `trades` table (RLS-filtered) | Raw trade records with P&L, timestamps, trendline metadata |
| Data Source | `journal_entries` table | Conviction, emotional state, mistakes, rule compliance |
| Data Source | `playbooks` table | Playbook assignments per trade |
| Data Source | `instruments` table | Contract multiplier, tick size, tick value, exchange timezone |

### 1.4 Dependencies

| System | FSD Reference | Data Required | Impact if Unavailable |
|---|---|---|---|
| Trade Execution Pipeline | FSD-003 | Closed trade records with `realized_pnl`, `entry/exit_price`, `entry/exit_timestamp`, `stop_loss_price`, `signal_price`, `mae_ticks`, `mfe_ticks`, trendline metadata | No metrics computable; engine returns empty state |
| Trade Journaling | FSD-004 | `conviction`, `emotional_state`, `mistake_tags`, `rules_followed` | Behavioral metrics (Section 3.6) return `null` |
| Playbook System | FSD-005 | `playbook_id` per trade, playbook definitions | Playbook-segmented metrics unavailable; trades appear as "Untagged" |

---

## 2. Business Rules (Global)

These business rules apply across all metric categories:

| ID | Rule |
|---|---|
| BR-001 | Breakeven trades (`realized_pnl = $0.00` after commissions) SHALL be classified as losses for win rate calculation. |
| BR-002 | All P&L calculations SHALL include commissions and fees. `realized_pnl = (exit_price - entry_price) * contract_multiplier * quantity * direction_sign - commission - fees`. |
| BR-003 | Only trades with `status = 'closed'` are included. Open, pending, or cancelled trades are excluded. |
| BR-004 | Metrics recalculate when ANY filter changes (date range, instrument, playbook). |
| BR-005 | Default filter on first load: date range = 30 Days, instruments = all, playbooks = all. |
| BR-006 | Filter logic: `WHERE exit_timestamp BETWEEN :start AND :end AND instrument IN (:instruments) AND (playbook_id IN (:playbooks) OR (playbook_id IS NULL AND 'untagged' IN (:playbooks)))`. |

---

## 3. Metric Specifications

### 3.1 Category 1: Trade Performance Metrics (AN-FR-001)

**Source:** PRD-006 Section 3.1, AN-FR-001

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| Closed trade records | `trades` table (RLS-filtered) | Array of trade objects | Yes |
| Active filters | URL query parameters / filter state | `{ start_date, end_date, instruments[], playbooks[] }` | Yes (defaults apply) |
| Trade P&L | `trades.realized_pnl` (includes commissions and fees) | DECIMAL(12,2) | Yes |
| Entry/exit timestamps | `trades.entry_timestamp`, `trades.exit_timestamp` | TIMESTAMPTZ | Yes |
| Commission/fees | `trades.commission` + `trades.fees` | DECIMAL(8,2) | Yes |

**Metric Formulas:**

| # | Metric | Formula | Precision | Notes |
|---|---|---|---|---|
| M-01 | Total Trades | `COUNT(*)` where `status = 'closed'` | Integer | Only closed trades; open/pending excluded |
| M-02 | Win Rate | `(COUNT(WHERE realized_pnl > 0) / COUNT(*)) * 100` | 1 decimal, e.g., `62.5%` | Breakeven trades (realized_pnl = 0) classified as losses (BR-001) |
| M-03 | Average Winner | `SUM(realized_pnl WHERE realized_pnl > 0) / COUNT(WHERE realized_pnl > 0)` | 2 decimals, currency, e.g., `$342.50` | Returns `null` if zero winners |
| M-04 | Average Loser | `SUM(realized_pnl WHERE realized_pnl <= 0) / COUNT(WHERE realized_pnl <= 0)` | 2 decimals, currency, e.g., `-$215.75` | Includes breakeven trades; returns `null` if zero losers |
| M-05 | Profit Factor | `ABS(SUM(realized_pnl WHERE realized_pnl > 0)) / ABS(SUM(realized_pnl WHERE realized_pnl <= 0))` | 2 decimals, e.g., `1.87` | Division by zero: see edge cases |
| M-06 | Expectancy | `(win_rate/100 * avg_winner) + ((1 - win_rate/100) * avg_loser)` | 2 decimals, currency, e.g., `$47.25` | Uses absolute values of avg_loser in computation |
| M-07 | Largest Win | `MAX(realized_pnl WHERE realized_pnl > 0)` | 2 decimals, currency | Returns `null` if zero winners |
| M-08 | Largest Loss | `MIN(realized_pnl WHERE realized_pnl <= 0)` | 2 decimals, currency | Returns `null` if zero losers |
| M-09 | Total Net P&L | `SUM(realized_pnl)` | 2 decimals, currency, e.g., `$15,420.50` | Includes all commissions and fees |
| M-10 | Average Trade Duration | `AVG(exit_timestamp - entry_timestamp)` | Hours and minutes | If < 1 hour: minutes only (e.g., `45m`). If < 1 minute: `< 1m`. |

**Output Schema:**

```json
{
  "total_trades": 156,
  "win_rate": 62.5,
  "average_winner": 342.50,
  "average_loser": -215.75,
  "profit_factor": 1.87,
  "expectancy": 47.25,
  "largest_win": 2850.00,
  "largest_loss": -1425.00,
  "total_net_pnl": 15420.50,
  "average_trade_duration_seconds": 9300,
  "average_trade_duration_display": "2h 35m",
  "winning_trades": 97,
  "losing_trades": 59,
  "breakeven_trades": 3,
  "filter_applied": {
    "start_date": "2026-01-12",
    "end_date": "2026-02-11",
    "instruments": ["CL", "GC"],
    "playbooks": ["all"]
  },
  "computed_at": "2026-02-11T14:30:05Z"
}
```

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| 0 trades match filters | All metrics return `null`. Display message: "No trades match the selected filters. Try adjusting the date range or removing instrument filters." |
| 1 trade (winner) | Win rate = 100.0%. Profit factor = `null`, display as `">99.99"`. Average loser = `null`, displayed as "--". Expectancy = average_winner value. |
| 1 trade (loser) | Win rate = 0.0%. Profit factor = 0.00. Average winner = `null`, displayed as "--". Expectancy = average_loser value. |
| All trades are winners | Profit factor returned as `null` with display hint `">99.99"`. Expectancy = average_winner. |
| All trades are losers | Profit factor = 0.00. Win rate = 0.0%. Expectancy = average_loser (negative). |
| Single breakeven trade ($0 P&L) | Win rate = 0.0% (classified as loss). Profit factor = 0.00. Average loser = $0.00. |
| Extremely large P&L (> $100,000 single trade) | No overflow. Display uses abbreviation: $100K, $1.2M. Charts auto-scale Y-axis. |
| Trade duration < 1 second | Display as "< 1m". Store actual duration_seconds for computation. |
| Trade spanning multiple calendar days | Duration computed from exact timestamps. Attributed to exit date for daily P&L aggregation. |

**Error Handling:**

| Error Condition | HTTP Status | Error Message |
|---|---|---|
| Database query timeout (> 10s) | 504 | "Metrics calculation timed out. Please try a narrower date range or fewer filters." |
| Database connection failure | 503 | "Analytics service temporarily unavailable. Please try again in a few minutes." |
| Invalid date range (start > end) | 400 | "Invalid date range: start date must be before end date." |
| Future end date | 400 | API clamps `end_date` to current date if future date submitted. |
| Invalid instrument code | 400 | "Unknown instrument: '{code}'. Available instruments: {list}." |

---

### 3.2 Category 2: Risk-Adjusted Metrics (AN-FR-002)

**Source:** PRD-006 Section 3.1, AN-FR-002

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| Daily P&L series | `mv_daily_pnl` materialized view | Array of `{ date, net_pnl }` | Yes |
| Risk-free rate | `user_settings.risk_free_rate`, default 5.0% annual | DECIMAL(4,2) | No (default 5.0%) |
| Equity curve data points | Derived from cumulative daily P&L | Array of `{ date, equity }` | Yes |

**Metric Formulas:**

**M-11: Daily Returns**
- Group closed trades by exit date (exchange timezone).
- Sum `realized_pnl` per day to get daily P&L.
- Days with no closed trades are EXCLUDED (trading days only).
- `daily_return = daily_pnl / account_equity_at_start_of_day`. If account equity tracking unavailable, use cumulative P&L as proxy.

**M-12: Sharpe Ratio**
- `daily_risk_free = (1 + annual_risk_free_rate)^(1/252) - 1`
- `excess_returns = daily_returns - daily_risk_free` for each trading day
- `sharpe = mean(excess_returns) / stdev(excess_returns) * sqrt(252)` (annualized)
- Precision: 2 decimal places.
- Minimum 20 trading days with trades required. Below 20: return `null` with `"Insufficient data (minimum 20 trading days required)"`.

**M-13: Sortino Ratio**
- Same as Sharpe but denominator uses only downside deviation.
- `downside_returns = [r for r in excess_returns if r < 0]`
- `downside_deviation = sqrt(mean(downside_returns^2))`
- `sortino = mean(excess_returns) / downside_deviation * sqrt(252)`
- Precision: 2 decimal places.
- If no negative returns exist: return `null` with `"N/A (no negative return days)"`.
- Minimum 20 trading days required.

**M-14: Calmar Ratio**
- `annualized_return = total_return * (252 / trading_days_count)`
- `calmar = annualized_return / abs(max_drawdown_pct)`
- Uses rolling 36-month window, or full available history if less than 36 months.
- Precision: 2 decimal places.
- If max drawdown = 0: return `null` with `"N/A (no drawdown period)"`.

**M-15 through M-20: Drawdown Calculations**
- Build equity curve as cumulative P&L series.
- At each point: `drawdown = equity - running_max(equity)`. Drawdown is always <= 0.

| # | Metric | Formula | Precision |
|---|---|---|---|
| M-15 | Max Drawdown ($) | `min(drawdown_series)` (most negative value) | 2 decimals, currency |
| M-16 | Max Drawdown (%) | `max_drawdown_dollars / equity_at_peak * 100` | 1 decimal, percentage |
| M-17 | Max Drawdown Peak Date | Date when equity was at peak before max drawdown | DATE |
| M-18 | Max Drawdown Trough Date | Date when equity was at lowest point in max drawdown | DATE |
| M-19 | Max Drawdown Recovery Date | Date when equity recovered to new peak (or `null` if ongoing) | DATE or null |
| M-20 | Recovery Time (days) | Trading days from trough to new peak. If not recovered: `null`, display "Ongoing". | Integer or null |

Additional drawdown aggregates:
- `average_drawdown = mean(all drawdown period depths)`
- `drawdown_count = number of distinct drawdown periods`

A drawdown period starts when equity drops below the previous peak and ends when equity reaches a new peak. A new drawdown starts only after the previous drawdown has fully recovered.

**Business Rules:**

| ID | Rule |
|---|---|
| BR-006 | Risk-free rate is configurable per user in settings. Default: 5.0% annual. Valid range: 0.0% to 20.0%. Stored in `user_settings.risk_free_rate`. |
| BR-007 | Days with no closed trades are excluded from Sharpe/Sortino computation (trading days only, not calendar days). |
| BR-008 | Sharpe and Sortino require minimum 20 trading days with trades. This threshold is not configurable. |
| BR-009 | Drawdown periods are delineated by equity peaks. A new drawdown starts only after the previous drawdown has fully recovered (equity reaches a new high). |

**Output Schema:**

```json
{
  "sharpe_ratio": 1.45,
  "sortino_ratio": 2.12,
  "calmar_ratio": 3.85,
  "max_drawdown_dollars": -2400.00,
  "max_drawdown_pct": -8.3,
  "max_drawdown_peak_date": "2026-01-05",
  "max_drawdown_trough_date": "2026-01-12",
  "max_drawdown_recovery_date": "2026-01-20",
  "recovery_time_days": 8,
  "average_drawdown_dollars": -1200.00,
  "drawdown_count": 4,
  "trading_days_count": 45,
  "risk_free_rate_used": 5.0,
  "insufficient_data": false
}
```

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| Only 1 trading day | All ratios return `null` with insufficient data message. Drawdown = 0 if profitable, or drawdown = that day's loss if negative. |
| All days negative | Sharpe will be negative. Sortino denominator = stdev of all returns. Max drawdown = total loss. |
| Single massive winning day skewing returns | Sharpe may be high; trade count warning displayed: "Metrics based on only N trading days -- interpret with caution." for N < 30. |
| Ongoing drawdown (equity has not recovered) | `recovery_time_days: null`, display "Ongoing". `max_drawdown_recovery_date: null`. |
| Standard deviation of returns = 0 | Return `sharpe_ratio: null` with "All daily returns are identical. Sharpe ratio undefined." |
| No drawdown periods (equity never declined) | `max_drawdown_dollars: 0, max_drawdown_pct: 0, calmar_ratio: null` with "No drawdown periods recorded." |
| Risk-free rate outside valid range | Clamp to 0.0-20.0 range. Log warning. |

---

### 3.3 Category 3: R-Multiple Analysis (AN-FR-003)

**Source:** PRD-006 Section 3.1, AN-FR-003

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| Trade realized P&L | `trades.realized_pnl` | DECIMAL(12,2) | Yes |
| Initial stop loss price | `trades.stop_loss_price` | DECIMAL(12,4) | Required for R-multiple |
| Entry price | `trades.entry_price` | DECIMAL(12,4) | Yes |
| Contract multiplier | `instruments.contract_multiplier` | DECIMAL(10,2) | Yes |
| Quantity | `trades.quantity` | INTEGER | Yes |
| Trade direction | `trades.direction` (`'long'` or `'short'`) | VARCHAR(5) | Yes |

**Metric Formulas:**

**M-21: Per-Trade R-Multiple**
- `initial_risk_per_contract = abs(entry_price - stop_loss_price) * contract_multiplier`
- `total_initial_risk = initial_risk_per_contract * quantity`
- `r_multiple = realized_pnl / total_initial_risk`
- Precision: 2 decimal places.
- If `stop_loss_price IS NULL`: R-multiple = `null`, displayed as "N/A".
- If `initial_risk = 0` (stop at entry price): R-multiple = `null`, note "Stop at entry -- R-multiple undefined."

**M-22 through M-28: Aggregate R Metrics**

Only include trades where R-multiple is not null.

| # | Metric | Formula | Precision |
|---|---|---|---|
| M-22 | Average R | `mean(all r_multiples)` | 2 decimals |
| M-23 | Median R | `median(all r_multiples)` | 2 decimals |
| M-24 | R Expectancy | `mean(all r_multiples)` (same as Average R) | 2 decimals |
| M-25 | Best R | `max(all r_multiples)` | 2 decimals |
| M-26 | Worst R | `min(all r_multiples)` | 2 decimals |
| M-27 | R Standard Deviation | `standard_deviation(all r_multiples)` | 2 decimals |
| M-28 | R Skewness | `skewness(all r_multiples)` using Fisher's definition | 2 decimals |

**M-29: Cumulative R Series**
- Running sum of `r_multiples` ordered by `exit_timestamp`.
- Used by equity curve visualization in FSD-006b.

**Business Rules:**

| ID | Rule |
|---|---|
| BR-010 | Trades without a defined stop loss (`stop_loss_price IS NULL`) are excluded from ALL R-based aggregate metrics and display "N/A" for their individual R-multiple. |
| BR-011 | The count of excluded trades MUST be reported: "N trades excluded from R-multiple analysis (no stop loss defined)." |
| BR-012 | R-multiple is directional. For long trades: R > 0 means profit. The formula handles direction automatically since `realized_pnl` already accounts for direction. |
| BR-013 | If `initial_risk = 0` (stop loss at entry price), R-multiple = `null` for that trade with note "Stop at entry -- R-multiple undefined." |

**Output Schema:**

```json
{
  "average_r": 0.85,
  "median_r": 0.42,
  "r_expectancy": 0.85,
  "best_r": 5.20,
  "worst_r": -2.80,
  "r_std_dev": 1.45,
  "r_skewness": 0.72,
  "trades_with_r": 142,
  "trades_without_r": 14,
  "cumulative_r_series": [
    { "trade_number": 1, "date": "2025-11-15", "r_multiple": 1.20, "cumulative_r": 1.20 },
    { "trade_number": 2, "date": "2025-11-16", "r_multiple": -0.80, "cumulative_r": 0.40 }
  ]
}
```

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| All trades missing stop loss | All R metrics return `null`. Display: "R-multiple analysis requires trades with defined stop losses. Set stop loss when entering trades to enable this analysis." |
| Only 1 trade with R-multiple | Average R = that trade's R. Median R = same. Std dev = 0. Skewness = `null` (requires 3+ data points). |
| R-multiple > 10 | Valid. Display normally. No cap applied. |
| R-multiple < -5 | Valid. Display normally. Indicates stop was likely moved or not honored. |
| Initial risk = $0 (stop at entry) | R-multiple = `null`. Trade excluded from R aggregates. |

---

### 3.4 Category 4: Time-Based Analysis Metrics (AN-FR-004)

**Source:** PRD-006 Section 3.1, AN-FR-004

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| Trade entry timestamp | `trades.entry_timestamp` | TIMESTAMPTZ | Yes |
| Trade exit timestamp | `trades.exit_timestamp` | TIMESTAMPTZ | Yes |
| Trade realized P&L | `trades.realized_pnl` | DECIMAL(12,2) | Yes |
| Trade R-multiple | Computed per Section 3.3 | DECIMAL(6,2) or null | No |
| Instrument | `trades.instrument` | VARCHAR(10) | Yes |
| RTH session config | `instrument_settings.rth_start`, `instrument_settings.rth_end` | TIME | Yes (defaults apply) |
| Exchange timezone | `instruments.exchange_timezone` | VARCHAR(50) | Yes |

**Metric Formulas:**

**M-30: Hour of Day Analysis**
- Convert `entry_timestamp` to exchange local timezone for the trade's instrument.
- Group trades by hour (0-23).
- Per hour: `net_pnl = SUM(realized_pnl)`, `trade_count = COUNT(*)`, `win_rate = (winners / total) * 100`, `avg_r = AVG(r_multiple) WHERE r_multiple IS NOT NULL`.

**M-31: Day of Week Analysis**
- Extract day of week from `entry_timestamp` (exchange timezone).
- Group by Monday through Friday (0=Monday, 4=Friday).
- Per day: `net_pnl`, `trade_count`, `win_rate`, `avg_r`.

**M-32: Month Analysis (Calendar Year Aggregate)**
- Group by month number (1=January through 12=December) across all years.
- Per month: `net_pnl`, `trade_count`, `win_rate`, `avg_r`.

**M-33: Month Analysis (Chronological)**
- Group by specific year-month (e.g., "2026-01", "2026-02").
- Per year-month: `net_pnl`, `trade_count`, `win_rate`, `avg_r`.

**M-34: Session Analysis (RTH vs. Overnight)**

Default RTH hours by instrument:

| Instrument(s) | RTH Start | RTH End | Timezone |
|---|---|---|---|
| ES, NQ, YM, MES, MNQ, MYM | 09:30 | 16:00 | America/New_York |
| CL, MCL | 09:00 | 14:30 | America/New_York |
| GC, MGC | 08:20 | 13:30 | America/New_York |
| PL | 08:20 | 13:05 | America/New_York |

Classification: if `entry_timestamp` (in exchange timezone) falls within RTH hours, classify as "RTH". Otherwise, classify as "Overnight". RTH start is inclusive, RTH end is exclusive.

RTH hours are configurable per instrument in user settings. User overrides stored in `user_instrument_settings.rth_start` and `user_instrument_settings.rth_end`.

Per session: `net_pnl`, `trade_count`, `win_rate`, `avg_r`, `profit_factor`, `avg_slippage_ticks`.

**M-35: Session Insight Callout**
- Auto-generated when one session's win rate exceeds the other by 5+ percentage points or net P&L differs by more than 25%.
- Format: "Your RTH trades outperform overnight by $X (Y% higher win rate)."

**Business Rules:**

| ID | Rule |
|---|---|
| BR-014 | A trade's time classification (hour, day, session) is based on the ENTRY timestamp, not exit. |
| BR-015 | Hour-of-day analysis uses the exchange's local timezone, not the user's local timezone. |
| BR-016 | RTH session times are configurable per instrument. Defaults documented above. |
| BR-017 | Session insight callout generated when one session's win rate exceeds the other by 5+ percentage points or net P&L differs by more than 25%. |

**Output Schema:**

```json
{
  "by_hour": [
    { "hour": 9, "net_pnl": 3250.00, "trade_count": 28, "win_rate": 67.9, "avg_r": 1.15 }
  ],
  "by_day_of_week": [
    { "day": "Monday", "day_index": 0, "net_pnl": 2100.00, "trade_count": 32, "win_rate": 65.6, "avg_r": 0.95 }
  ],
  "by_month_aggregate": [
    { "month": "January", "month_index": 1, "net_pnl": 4500.00, "trade_count": 45, "win_rate": 62.2, "avg_r": 0.88 }
  ],
  "by_month_chronological": [
    { "year_month": "2026-01", "net_pnl": 4500.00, "trade_count": 45, "win_rate": 62.2, "avg_r": 0.88 }
  ],
  "by_session": {
    "rth": { "net_pnl": 12500.00, "trade_count": 120, "win_rate": 64.2, "avg_r": 0.92, "profit_factor": 1.95, "avg_slippage_ticks": 0.8 },
    "overnight": { "net_pnl": 2920.50, "trade_count": 36, "win_rate": 55.6, "avg_r": 0.65, "profit_factor": 1.42, "avg_slippage_ticks": 1.2 }
  },
  "session_insight": "Your RTH trades outperform overnight by $9,579.50 (8.6% higher win rate)."
}
```

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| No trades in a particular hour/day/month | That segment returns `{ net_pnl: 0, trade_count: 0, win_rate: null, avg_r: null }`. |
| Invalid RTH configuration (start >= end) | Reject with error: "Invalid RTH configuration: start time must be before end time." Revert to default. |
| Exchange timezone not configured for instrument | Default to "America/New_York" and log warning. |
| Trade entered at exactly RTH start time (e.g., 09:30:00) | Classified as RTH (inclusive start boundary). |
| Trade entered at exactly RTH end time (e.g., 16:00:00) | Classified as Overnight (exclusive end boundary). |
| Trade entered on weekend (Saturday/Sunday) | Classified under the day it occurs. Display normally if trades exist. |
| All trades in single hour | Only one bucket in hour-of-day. Other hours return empty. |

---

### 3.5 Category 5: Execution Quality Metrics (AN-FR-005)

**Source:** PRD-006 Section 3.1, AN-FR-005

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| Fill price | `trades.entry_fill_price`, `trades.exit_fill_price` | DECIMAL(12,4) | Yes |
| Signal price | `trades.signal_price` | DECIMAL(12,4) | Required for slippage |
| Order type | `trades.order_type` (`'market'`, `'limit'`, `'stop'`, `'stop_limit'`) | VARCHAR(20) | Yes |
| Broker ID | `trades.broker_connection_id` | UUID | Yes |
| Instrument | `trades.instrument` | VARCHAR(10) | Yes |
| Tick size | `instruments.tick_size` | DECIMAL(8,6) | Yes |
| Tick value | `instruments.tick_value` | DECIMAL(8,2) | Yes |
| MAE ticks | `trades.mae_ticks` | INTEGER | No |
| MFE ticks | `trades.mfe_ticks` | INTEGER | No |
| MAE data source flag | `trades.mae_source` (`'tick'`, `'bar'`, `null`) | VARCHAR(4) | No |
| Orders submitted count | From execution pipeline | INTEGER | For fill rate |
| Orders filled count | From execution pipeline | INTEGER | For fill rate |

**Metric Formulas:**

**M-36: Slippage Calculation**
- Entry slippage (ticks): `(entry_fill_price - signal_price) / tick_size` for long trades; `(signal_price - entry_fill_price) / tick_size` for short trades.
- Positive slippage = unfavorable (bought higher, sold lower than signal). Negative = favorable.
- Entry slippage (dollars): `slippage_ticks * tick_value * quantity`.
- Average slippage: `mean(all entry slippage ticks)`.
- Slippage by instrument: group by instrument, calculate mean slippage ticks and dollars.
- Slippage by broker: group by `broker_connection_id`, calculate mean slippage ticks.
- Slippage by order type: group by `order_type`, calculate mean slippage ticks.
- If `signal_price IS NULL`: that trade is excluded from slippage calculations.

**M-37: MAE/MFE Calculation**
- MAE (dollars) = `mae_ticks * tick_value * quantity`.
- MFE (dollars) = `mfe_ticks * tick_value * quantity`.
- MAE in R-multiples = `mae_dollars / total_initial_risk` (from Section 3.3).
- MFE in R-multiples = `mfe_dollars / total_initial_risk`.
- If `mae_source = 'bar'`: flag the value as "estimated" in the output.
- If `mae_ticks IS NULL`: that trade excluded from MAE/MFE analysis.

**M-38: Edge Ratio**
- `edge_ratio = avg(mfe_ticks) / avg(mae_ticks)`
- Higher is better (favorable moves exceed adverse moves on average).

**M-39: Fill Quality Score (0-100)**
- `normalized_slippage = min(avg_slippage_ticks / max_acceptable_slippage, 1.0)` where `max_acceptable_slippage = 3.0 ticks`.
- `fill_quality = (1 - normalized_slippage) * fill_rate * 100`.
- Clamped to 0-100 range.
- Color coding: 80-100 = "Excellent" (green #22C55E), 60-79 = "Good" (blue #3B82F6), 40-59 = "Fair" (yellow #F59E0B), 0-39 = "Poor" (red #EF4444).

**M-40: MAE/MFE Insights**
- `pct_winners_mae_above_half_r`: percentage of winning trades where MAE exceeded 0.5R.
- `avg_mfe_capture_pct`: average percentage of MFE captured in the final outcome. Formula: `mean(realized_pnl / (mfe_ticks * tick_value * quantity) * 100)` for winning trades.
- Auto-generated insight text based on these values.

**Business Rules:**

| ID | Rule |
|---|---|
| BR-018 | Slippage is signed. Positive = unfavorable. Negative = favorable. |
| BR-019 | Trades without `signal_price` are excluded from slippage metrics. Count of excluded trades is reported. |
| BR-020 | MAE/MFE values from bar data (not tick) MUST be flagged as "estimated" with tooltip: "This value is estimated from bar data. Tick-level data was unavailable for this trade." |
| BR-021 | Fill Quality Score color coding: 80-100 = Excellent (green), 60-79 = Good (blue), 40-59 = Fair (yellow), 0-39 = Poor (red). |

**Output Schema:**

```json
{
  "average_slippage_ticks": 0.85,
  "average_slippage_dollars": 8.50,
  "slippage_by_instrument": [
    { "instrument": "CL", "avg_slippage_ticks": 1.2, "avg_slippage_dollars": 12.00, "trade_count": 85 }
  ],
  "slippage_by_broker": [
    { "broker_id": "uuid-1", "broker_name": "Rithmic", "avg_slippage_ticks": 0.7, "trade_count": 100 }
  ],
  "slippage_by_order_type": [
    { "order_type": "market", "avg_slippage_ticks": 1.4, "trade_count": 90 },
    { "order_type": "limit", "avg_slippage_ticks": -0.2, "trade_count": 66 }
  ],
  "fill_rate": 97.5,
  "fill_quality_score": 82,
  "fill_quality_label": "Excellent",
  "edge_ratio": 1.65,
  "mae_mfe_data": [
    {
      "trade_id": "uuid",
      "date": "2026-01-15",
      "instrument": "CL",
      "playbook": "A+ Break",
      "entry_price": 72.50,
      "exit_price": 73.10,
      "mae_ticks": 8,
      "mae_dollars": 80.00,
      "mae_r": 0.40,
      "mfe_ticks": 22,
      "mfe_dollars": 220.00,
      "mfe_r": 1.10,
      "outcome_r": 0.85,
      "outcome_dollars": 170.00,
      "mae_source": "tick",
      "is_winner": true
    }
  ],
  "mae_mfe_insights": {
    "pct_winners_mae_above_half_r": 35.0,
    "avg_mfe_capture_pct": 68.5,
    "insight_mae": "35.0% of your winners had MAE > 0.5R, suggesting your stops may be optimally placed.",
    "insight_mfe": "On average, you capture 68.5% of the maximum favorable move."
  },
  "trades_without_signal_price": 8,
  "trades_without_mae_mfe": 22,
  "trades_with_estimated_mae": 15
}
```

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| No trades have signal_price | Slippage metrics return `null`. Display: "Slippage data unavailable. Signal prices are required for slippage calculation." |
| No trades have MAE/MFE data | MAE/MFE section returns `null`. Display: "MAE/MFE data unavailable. Price data during trade holding period is required." |
| Zero fill rate | fill_quality_score = 0. |
| Negative average slippage (favorable) | Display in green: "Average slippage: -0.3 ticks (favorable)". fill_quality_score treats negative slippage as 0 for normalized_slippage (maximum quality). |
| Edge ratio with avg MAE = 0 | Edge ratio = `null`. Display "N/A (no adverse excursion recorded)". |

---

### 3.6 Category 6: Behavioral Metrics (AN-FR-006)

**Source:** PRD-006 Section 3.1, AN-FR-006

**Dependency:** Requires journal entry data from FSD-004.

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| Rule compliance flag | `journal_entries.rules_followed` | BOOLEAN | No |
| Mistake tags | `journal_entries.mistake_tags` | TEXT[] (array) | No |
| Emotional state tags | `journal_entries.emotional_state` | TEXT[] (array) | No |
| Conviction level | `journal_entries.conviction` | INTEGER (1-5) | No |
| Trade realized P&L | `trades.realized_pnl` | DECIMAL(12,2) | Yes |
| Trade R-multiple | Computed per Section 3.3 | DECIMAL(6,2) | No |
| Planned position size | `trades.planned_quantity` | INTEGER | No |
| Actual position size | `trades.quantity` | INTEGER | Yes |
| Trade entry timestamp | `trades.entry_timestamp` | TIMESTAMPTZ | Yes |

**Metric Formulas:**

**M-41: Rule Compliance Rate**
- `rule_compliance_rate = (COUNT(WHERE rules_followed = true) / COUNT(WHERE rules_followed IS NOT NULL)) * 100`
- Only trades with journal entries that include the `rules_followed` field are counted.
- Trades without journal entries are excluded (not counted as violations).
- Precision: 1 decimal place.

**M-42: Cost of Mistakes**
- `cost_of_mistakes = SUM(realized_pnl WHERE mistake_tags IS NOT NULL AND array_length(mistake_tags) > 0)`
- Breakdown by mistake type: group by each unique mistake tag, sum P&L per tag.
- Valid mistake types: `'moved_stop'`, `'entered_early'`, `'oversized'`, `'held_too_long'`, `'exited_too_early'`, `'revenge_trade'`, `'fomo_entry'`, `'ignored_rules'`, `'wrong_instrument'`, `'other'`.
- A trade can have multiple mistake tags. It is counted once in each relevant category. The total `cost_of_mistakes` counts the trade's P&L only once.

**M-43: Mistake Frequency**
- `mistake_frequency = (COUNT(WHERE mistake_tags IS NOT NULL AND array_length(mistake_tags) > 0) / COUNT(*)) * 100`
- Precision: 1 decimal place.

**M-44: Tiltmeter Score (0-100)**

Rolling computation over the LAST 10 trades (most recent by `exit_timestamp`).

| Component | Weight | Calculation |
|---|---|---|
| Emotional State | 25% | For each of the last 10 trades: score = 0 if tags include `confident`, `patient`, or `disciplined`; score = 50 if tags include `anxious` or `uncertain`; score = 100 if tags include `fomo`, `revenge`, `frustrated`, or `fearful`. If multiple tags, use highest score. Average the 10 scores. |
| Mistake Rate | 30% | `(trades_with_mistakes_in_last_10 / 10) * 100` |
| Position Size Deviation | 25% | For each of last 10 trades: `abs(quantity - planned_quantity) / planned_quantity * 100`, capped at 100. Average available values. If `planned_quantity` is NULL, exclude that trade. If no trades have `planned_quantity`: component = 0. |
| Trade Frequency Anomaly | 20% | `baseline = avg trades per week over trailing 30 calendar days`. `current = trades in last 7 calendar days * (30/7)` normalized to 30-day rate. `anomaly = max(0, (current / baseline - 1) * 100)`, capped at 100. If baseline = 0: anomaly = 0. |

`tiltmeter = emotional_state_score * 0.25 + mistake_rate_score * 0.30 + position_deviation_score * 0.25 + frequency_anomaly_score * 0.20`

Round to nearest integer.

**Tiltmeter Color Zones:**

| Score Range | Zone | Color (Hex) | Label |
|---|---|---|---|
| 0-25 | Green | #22C55E | Disciplined |
| 26-50 | Yellow | #F59E0B | Caution |
| 51-75 | Orange | #F97316 | Elevated Risk |
| 76-100 | Red | #EF4444 | Tilt |

**M-45: Conviction vs. Outcome Correlation**
- Pearson correlation coefficient between conviction level (1-5) and R-multiple.
- Only include trades with both conviction AND R-multiple values.
- Minimum 10 trades required. Below 10: return `null` with "Insufficient data for correlation analysis (minimum 10 trades with both conviction and R-multiple required)."

**M-46: Emotional State P&L**
- Group trades by each emotional state tag.
- Per state: `net_pnl = SUM(realized_pnl)`, `trade_count = COUNT(*)`, `win_rate`, `avg_r`.
- A trade with multiple emotional tags contributes to each relevant group.

**Business Rules:**

| ID | Rule |
|---|---|
| BR-022 | Tiltmeter color zones as defined above. |
| BR-023 | Tiltmeter computed over the last 10 trades. If fewer than 10 trades exist, compute over all available trades and display "(based on N trades)" note. |
| BR-024 | Baseline trade frequency uses trailing 30 calendar days. If user has been trading for fewer than 30 days, use all available history. |
| BR-025 | A trade can have multiple mistake tags. Its P&L is counted in each mistake category independently. The total cost_of_mistakes counts the trade's P&L only once. |
| BR-026 | Trades without journal entries are excluded from behavioral metrics (not treated as compliant or non-compliant). |

**Output Schema:**

```json
{
  "rule_compliance_rate": 78.5,
  "trades_with_compliance_data": 121,
  "cost_of_mistakes_total": -4250.00,
  "mistake_breakdown": [
    { "type": "moved_stop", "count": 12, "total_pnl": -2100.00, "avg_pnl": -175.00 },
    { "type": "oversized", "count": 8, "total_pnl": -1350.00, "avg_pnl": -168.75 },
    { "type": "entered_early", "count": 6, "total_pnl": -800.00, "avg_pnl": -133.33 }
  ],
  "mistake_frequency": 16.7,
  "tiltmeter_score": 34,
  "tiltmeter_zone": "caution",
  "tiltmeter_components": {
    "emotional_state": 20.0,
    "mistake_rate": 30.0,
    "position_deviation": 45.0,
    "frequency_anomaly": 50.0
  },
  "tiltmeter_color": "#F59E0B",
  "conviction_correlation": 0.32,
  "conviction_correlation_significance": "weak_positive",
  "conviction_data_points": 98,
  "average_conviction": 3.4,
  "emotional_state_pnl": [
    { "state": "confident", "net_pnl": 8500.00, "trade_count": 45, "win_rate": 71.1, "avg_r": 1.20 },
    { "state": "anxious", "net_pnl": -1200.00, "trade_count": 18, "win_rate": 44.4, "avg_r": -0.35 },
    { "state": "fomo", "net_pnl": -2800.00, "trade_count": 12, "win_rate": 33.3, "avg_r": -0.95 }
  ]
}
```

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| No journal entries linked to any trade | All behavioral metrics return `null`. Display: "No journal data available. Complete journal entries for your trades to enable behavioral analytics." |
| All trades followed rules | Rule compliance = 100.0%. Cost of mistakes = $0.00. |
| Tiltmeter with fewer than 10 trades | Compute over available trades. Display: "Tiltmeter score based on N trades (10 recommended for accuracy)." |
| Planned quantity = 0 or NULL | Exclude that trade from position size deviation component. |
| Conviction all same value (e.g., all 3) | Correlation = `null` (no variance). Display: "Insufficient variance in conviction levels for correlation analysis." |
| No emotional state tags on any trade | Emotional state P&L returns empty array. Tiltmeter emotional component = 0 (assumes disciplined). |

---

### 3.7 Category 7: Trendline-Specific Analytics (AN-FR-007)

**Source:** PRD-006 Section 3.1, AN-FR-007

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| Trendline touch count | `trades.trendline_touch_count` | INTEGER | Required for trendline analytics |
| Trendline slope angle | `trades.trendline_slope_degrees` | DECIMAL(5,2) | Required for slope analysis |
| Trendline duration | `trades.trendline_duration_days` | INTEGER | Required for duration analysis |
| Trendline grade | `trades.trendline_grade` (`'A+'`, `'A'`, `'B'`) | VARCHAR(2) | Required for grade analysis |
| Setup type | `trades.setup_type` (`'break'`, `'bounce'`) | VARCHAR(10) | Required for setup comparison |
| Candle spacing | `trades.trendline_candle_spacing` | INTEGER | Required for spacing analysis |
| Trade realized P&L | `trades.realized_pnl` | DECIMAL(12,2) | Yes |
| Trade R-multiple | Computed per Section 3.3 | DECIMAL(6,2) | No |

**Processing Logic:**

1. **Filter:** Only include trades where trendline metadata is present (`trendline_touch_count IS NOT NULL`). Count and report excluded trades.

2. **Per segment:** Calculate `win_rate`, `avg_r`, `profit_factor`, `trade_count`.

**Segmentation Definitions:**

| Dimension | Segments | Boundaries |
|---|---|---|
| Touch Count | 2, 3, 4, 5+ | Exact count; 5+ aggregates all >= 5 |
| Slope Angle | 0-15, 15-30, 30-45, 45+ degrees | Inclusive lower, exclusive upper, except last bucket (inclusive) |
| Duration | <7 days, 7-21 days, 21-56 days, 56+ days | Standard range boundaries |
| Grade | A+, A, B | Exact match |
| Setup Type | Break, Bounce | Exact match |
| Candle Spacing | <6, 6-10, 10-20, 20+ candles | Standard range boundaries |

**Statistical Significance Indicator:**

| Trade Count | Confidence Level | Display |
|---|---|---|
| >= 30 | High Confidence | "High Confidence (n=N)" |
| 10-29 | Moderate Confidence | "Moderate Confidence (n=N)" |
| < 10 | Low Confidence | "Low Confidence (n=N)" -- visually de-emphasized |

**Business Rules:**

| ID | Rule |
|---|---|
| BR-027 | Only trades with trendline metadata participate in trendline analytics. Manual/custom playbook trades without trendline metadata are excluded. |
| BR-028 | The count of excluded trades MUST be displayed: "N trades excluded from trendline analytics (no trendline metadata attached)." |
| BR-029 | Statistical significance thresholds: >=30 = High Confidence, 10-29 = Moderate Confidence, <10 = Low Confidence. |
| BR-030 | Segments with Low Confidence (<10 trades) are visually de-emphasized with tooltip: "Small sample size -- interpret with caution." |

**Output Schema:**

```json
{
  "trades_included": 128,
  "trades_excluded": 28,
  "excluded_reason": "28 trades excluded from trendline analytics (no trendline metadata attached).",
  "by_touch_count": [
    { "segment": "2", "win_rate": 52.0, "avg_r": 0.35, "profit_factor": 1.22, "trade_count": 25, "confidence": "Low Confidence (n=25)" },
    { "segment": "3", "win_rate": 64.0, "avg_r": 0.92, "profit_factor": 1.85, "trade_count": 50, "confidence": "High Confidence (n=50)" },
    { "segment": "4", "win_rate": 68.0, "avg_r": 1.15, "profit_factor": 2.10, "trade_count": 38, "confidence": "High Confidence (n=38)" },
    { "segment": "5+", "win_rate": 73.3, "avg_r": 1.42, "profit_factor": 2.55, "trade_count": 15, "confidence": "Low Confidence (n=15)" }
  ],
  "by_slope_angle": [],
  "by_duration": [],
  "by_grade": [],
  "by_setup_type": [],
  "by_candle_spacing": []
}
```

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| No trades have trendline metadata | All trendline metrics return `null`. Display: "No trendline data available. Trades must be auto-classified from the trendline engine to enable this analysis." |
| All trades in one segment | Only that segment has data. Others: `{ trade_count: 0, win_rate: null, avg_r: null, profit_factor: null }`. |
| Slope angle exactly 45.0 degrees | Falls into "45+" bucket. |
| Trendline duration = 0 days | Falls into "<7 days" bucket. |

---

## 4. Data Specifications

### 4.1 Materialized View: `mv_daily_pnl`

| Column | Type | Nullable | Description |
|---|---|---|---|
| user_id | UUID | NOT NULL | FK to `users.id`. RLS policy: `auth.uid() = user_id` |
| trade_date | DATE | NOT NULL | Date of trade exit (exchange timezone) |
| net_pnl | DECIMAL(12,2) | NOT NULL | Net P&L for the day |
| trade_count | INTEGER | NOT NULL | Number of trades closed that day |
| winning_trades | INTEGER | NOT NULL | Count of trades with realized_pnl > 0 |
| losing_trades | INTEGER | NOT NULL | Count of trades with realized_pnl <= 0 |
| gross_profit | DECIMAL(12,2) | NOT NULL | Sum of positive realized_pnl |
| gross_loss | DECIMAL(12,2) | NOT NULL | Sum of negative realized_pnl (stored as negative) |
| total_r | DECIMAL(8,2) | NULL | Sum of R-multiples (null if no trades have R) |
| avg_slippage_ticks | DECIMAL(6,2) | NULL | Average slippage in ticks |

**Primary key:** `(user_id, trade_date)`.

**Refresh strategy:**
- Incremental update on trade close: upsert for the trade's exit date.
- Full nightly refresh at 00:00 UTC.

### 4.2 Metrics Cache Table: `mv_metrics_cache`

| Column | Type | Nullable | Description |
|---|---|---|---|
| user_id | UUID | NOT NULL | FK to `users.id` |
| filter_hash | VARCHAR(64) | NOT NULL | SHA-256 hash of `{start_date}:{end_date}:{sorted_instruments}:{sorted_playbooks}` |
| metrics_json | JSONB | NOT NULL | Complete computed metrics as JSON |
| computed_at | TIMESTAMPTZ | NOT NULL | Computation timestamp |
| trade_count | INTEGER | NOT NULL | Trades included in computation |

**Primary key:** `(user_id, filter_hash)`.

**Cache invalidation:**
- On new trade close: delete all entries for user.
- On data correction: delete all entries for user.
- TTL: 5 minutes (enforced by checking `computed_at` before serving cached results).

### 4.3 Database Indexes

```sql
-- Core trade queries (may already exist from FSD-003)
CREATE INDEX idx_trades_user_exit ON trades(user_id, exit_timestamp);
CREATE INDEX idx_trades_user_instrument ON trades(user_id, instrument);
CREATE INDEX idx_trades_user_playbook ON trades(user_id, playbook_id);
CREATE INDEX idx_trades_user_exit_instrument ON trades(user_id, exit_timestamp, instrument);
CREATE INDEX idx_trades_user_exit_playbook ON trades(user_id, exit_timestamp, playbook_id);
CREATE INDEX idx_trades_user_exit_instrument_playbook ON trades(user_id, exit_timestamp, instrument, playbook_id);

-- Journal entries
CREATE INDEX idx_journal_entries_trade ON journal_entries(trade_id);

-- Materialized views
CREATE INDEX idx_mv_daily_pnl_user_date ON mv_daily_pnl(user_id, trade_date);
CREATE INDEX idx_mv_metrics_cache_user_hash ON mv_metrics_cache(user_id, filter_hash);
```

### 4.4 Redis Cache Schema

| Key Pattern | Value | TTL | Purpose |
|---|---|---|---|
| `metrics:{user_id}:{filter_hash}` | JSON metrics blob | 5 minutes | Computed metrics cache |
| `equity_curve:{user_id}:{filter_hash}` | JSON array of data points | 5 minutes | Equity curve data |

### 4.5 RLS Policies

```sql
-- mv_daily_pnl
ALTER TABLE mv_daily_pnl ENABLE ROW LEVEL SECURITY;
CREATE POLICY mv_daily_pnl_user_isolation ON mv_daily_pnl
  FOR SELECT
  USING (auth.uid() = user_id);

-- mv_metrics_cache
ALTER TABLE mv_metrics_cache ENABLE ROW LEVEL SECURITY;
CREATE POLICY mv_metrics_cache_user_isolation ON mv_metrics_cache
  FOR ALL
  USING (auth.uid() = user_id);
```

Note: RLS on the `trades` table itself is defined in FSD-003. The metrics engine relies on those policies being in place.

---

## 5. API Specifications

All endpoints require JWT authentication via `Authorization: Bearer {token}` header. All endpoints return JSON. All endpoints accept filter query parameters: `start_date` (YYYY-MM-DD), `end_date` (YYYY-MM-DD), `instruments` (comma-separated), `playbooks` (comma-separated UUIDs or "untagged").

### 5.1 GET /api/v1/analytics/summary

**Tier:** Free+ (Free tier receives 5 basic metrics only)
**Rate Limit:** 60 requests/minute
**Description:** Returns all core metrics from categories 1-6 in a single response.

**Response 200 (Trader+ tier):**

```json
{
  "data": {
    "total_trades": 156,
    "win_rate": 62.5,
    "average_winner": 342.50,
    "average_loser": -215.75,
    "profit_factor": 1.87,
    "expectancy": 47.25,
    "largest_win": 2850.00,
    "largest_loss": -1425.00,
    "total_net_pnl": 15420.50,
    "average_trade_duration_seconds": 9300,
    "average_trade_duration_display": "2h 35m",
    "winning_trades": 97,
    "losing_trades": 59,
    "breakeven_trades": 3,
    "sharpe_ratio": 1.45,
    "sortino_ratio": 2.12,
    "calmar_ratio": 3.85,
    "max_drawdown_dollars": -2400.00,
    "max_drawdown_pct": -8.3,
    "average_r": 0.85,
    "median_r": 0.42,
    "tiltmeter_score": 34,
    "tiltmeter_zone": "caution",
    "rule_compliance_rate": 78.5,
    "fill_quality_score": 82
  },
  "filter_applied": { "start_date": "2026-01-12", "end_date": "2026-02-11", "instruments": ["CL", "GC"], "playbooks": ["all"] },
  "total_trades_unfiltered": 256,
  "computed_at": "2026-02-11T14:30:05Z",
  "cached": true
}
```

**Response 200 (Free tier):** Same structure but only `total_trades`, `win_rate`, `total_net_pnl`, `average_winner`, `average_loser` populated. All other fields: `null` with `"restricted": true`.

**Error Responses:**
- 400: `{ "error": "bad_request", "message": "Invalid date range: start date must be before end date." }`
- 401: `{ "error": "unauthorized", "message": "Authentication required." }`
- 429: `{ "error": "rate_limited", "message": "Too many requests. Please try again later.", "retry_after": 30 }`
- 503: `{ "error": "service_unavailable", "message": "Analytics service temporarily unavailable." }`

### 5.2 GET /api/v1/analytics/r-distribution

**Tier:** Trader+
**Rate Limit:** 30 requests/minute
**Query Parameter:** `bin_width` (0.25, 0.5, or 1.0; default 0.5)
**Response 200:** Array of `{ r_range_start, r_range_end, trade_count, pct_of_total }` + summary stats (average_r, median_r, r_std_dev, r_skewness).

### 5.3 GET /api/v1/analytics/time-analysis

**Tier:** Trader+
**Rate Limit:** 30 requests/minute
**Response 200:** `by_hour`, `by_day_of_week`, `by_month_aggregate`, `by_month_chronological` arrays as specified in Section 3.4.

### 5.4 GET /api/v1/analytics/session

**Tier:** Trader+
**Rate Limit:** 30 requests/minute
**Response 200:** RTH and overnight metric objects + session insight string as specified in Section 3.4.

### 5.5 GET /api/v1/analytics/execution-quality

**Tier:** Trader+
**Rate Limit:** 30 requests/minute
**Response 200:** Slippage metrics, fill quality, slippage distributions, MAE/MFE data as specified in Section 3.5.

### 5.6 GET /api/v1/analytics/behavioral

**Tier:** Trader+
**Rate Limit:** 30 requests/minute
**Response 200:** Rule compliance, tiltmeter, mistake breakdown, conviction correlation, emotional state P&L as specified in Section 3.6.

### 5.7 GET /api/v1/analytics/trendline

**Tier:** Trader+
**Rate Limit:** 30 requests/minute
**Response 200:** Segmented trendline analytics by all dimensions as specified in Section 3.7.

### 5.8 GET /api/v1/analytics/win-rate/{dimension}

**Tier:** Trader+
**Rate Limit:** 30 requests/minute
**Path Parameter:** `dimension` = `instrument` | `day_of_week` | `hour` | `playbook` | `month` | `setup_type`
**Response 200:** Array of `{ segment, win_rate, avg_r, net_pnl, trade_count }`.

### 5.9 GET /api/v1/analytics/drawdown

**Tier:** Trader+
**Rate Limit:** 30 requests/minute
**Response 200:** Drawdown chart data series + drawdown periods table as specified in Section 3.2.

### 5.10 GET /api/v1/analytics/mae-mfe

**Tier:** Trader+
**Rate Limit:** 30 requests/minute
**Response 200:** MAE/MFE scatter data + insights as specified in Section 3.5.

### 5.11 GET /api/v1/analytics/equity-curve

**Tier:** Free+ (basic curve; Pro+ for comparative overlays)
**Rate Limit:** 30 requests/minute

**Response 200:**

```json
{
  "data": [
    { "date": "2025-11-15", "cumulative_pnl": 320.00, "daily_pnl": 320.00, "trade_count": 2 },
    { "date": "2025-11-16", "cumulative_pnl": 185.00, "daily_pnl": -135.00, "trade_count": 1 }
  ],
  "annotations": {
    "max_drawdown_start": { "date": "2026-01-05", "equity": 12500.00 },
    "max_drawdown_trough": { "date": "2026-01-12", "equity": 10100.00 },
    "best_day": { "date": "2026-01-28", "daily_pnl": 1850.00 }
  }
}
```

### 5.12 GET /api/v1/analytics/calendar

**Tier:** Trader+
**Rate Limit:** 30 requests/minute
**Response 200:** Array of `{ date, net_pnl, trade_count, win_rate }` objects. Monthly summary array.

### 5.13 GET /api/v1/analytics/calendar/{date}

**Tier:** Trader+
**Path Parameter:** `date` in YYYY-MM-DD format.
**Response 200:** Array of trade objects for that date: `{ trade_id, instrument, direction, playbook_name, realized_pnl, r_multiple, journal_entry_id }`.
**Response 404:** `{ "error": "not_found", "message": "No trades found for {date}." }`

---

## 6. Computation Pipeline

### 6.1 Calculation Triggers

| Trigger | Action | Scope |
|---|---|---|
| Filter change (user action) | Full recomputation for the new filter combination | All 7 metric categories for the active filters |
| New trade closed | Incremental update: update running sums/counts, refresh `mv_daily_pnl`, invalidate Redis cache and `mv_metrics_cache` for the user | Affected metrics only |
| Data correction | Full recomputation + cache invalidation for the user | All cached entries deleted |
| Nightly refresh (00:00 UTC) | Full refresh of `mv_daily_pnl` materialized view | All users |

### 6.2 Caching Strategy

1. **Redis (first check):** Key = `metrics:{user_id}:{filter_hash}`. TTL = 5 minutes. If hit and not expired, return immediately.
2. **PostgreSQL cache table (second check):** Query `mv_metrics_cache` for `(user_id, filter_hash)` where `computed_at` is within 5 minutes. If hit, return and populate Redis.
3. **Full computation (cache miss):** Compute all metrics from `trades` table and `mv_daily_pnl`. Store result in both Redis and `mv_metrics_cache`.

**Cache invalidation on trade close:**
- Delete Redis key: `metrics:{user_id}:*` (all filter combinations for the user).
- Delete Redis key: `equity_curve:{user_id}:*`.
- Delete `mv_metrics_cache` rows for the user.
- Upsert `mv_daily_pnl` for the trade's exit date.

**Redis fallback:** If Redis is unavailable, skip cache (compute on every request with degraded performance). Use `mv_metrics_cache` PostgreSQL table as fallback cache.

### 6.3 Incremental Computation

On new trade close, update running aggregates rather than full recomputation:
- Update `total_trades` (+1)
- Update `winning_trades` or `losing_trades` based on P&L
- Update `total_net_pnl` (+= new P&L)
- Recompute `win_rate`, `profit_factor`, `expectancy` from updated sums
- Append new point to equity curve
- Recompute tiltmeter (last 10 trades window)

Full recomputation only on filter change or data correction.

---

## 7. Tier-Based Metric Availability

| Metric Set | Free | Trader ($49/mo) | Pro ($99/mo) | Team ($199/mo) |
|---|---|---|---|---|
| Basic 5: Net P&L, Win Rate, Total Trades, Avg Winner, Avg Loser | Yes | Yes | Yes | Yes |
| Basic equity curve (no annotations/zoom) | Yes | Yes | Yes | Yes |
| Full 25+ metrics (all categories) | Locked | Yes | Yes | Yes |
| R-multiple analysis | Locked | Yes | Yes | Yes |
| Time-based analysis | Locked | Yes | Yes | Yes |
| Execution quality | Locked | Yes | Yes | Yes |
| Behavioral metrics | Locked | Yes | Yes | Yes |
| Trendline analytics | Locked | Yes | Yes | Yes |

**Backend enforcement:** API endpoints check `user.subscription_tier` before processing. Insufficient tier returns HTTP 403:
```json
{
  "error": "forbidden",
  "message": "This feature requires the {tier} plan.",
  "required_tier": "{tier}",
  "upgrade_url": "/settings/billing"
}
```

---

## 8. Performance Specifications

### 8.1 Computation Latency Targets

| Scenario | Dataset Size | Target | Cache State |
|---|---|---|---|
| Small account | 50 trades | < 1 second | Cold or warm |
| Medium account | 500 trades | < 2 seconds | Cold or warm |
| Standard account (target user) | 2,000 trades | < 3 seconds | Cold cache |
| Standard account (cached) | 2,000 trades | < 1 second | Warm cache |
| Large account | 10,000 trades | < 5 seconds | Cold cache |
| Large account (cached) | 10,000 trades | < 2 seconds | Warm cache |
| Very large account | 50,000 trades | < 8 seconds | Cold cache |

Measured from API request received to response sent.

### 8.2 Recalculation Performance

- New trade closed -> affected metrics recalculated: < 5 seconds.
- Filter change -> full recomputation: < 10 seconds for 10,000 trades.
- If recomputation exceeds 10 seconds: return partial results (summary metrics first, detailed breakdowns via subsequent requests).

### 8.3 Optimization Strategy

1. **Materialized Views:** Pre-compute `mv_daily_pnl` for daily aggregations. Avoids scanning full trades table on every request.
2. **Redis Caching:** Cache computed metric results with 5-minute TTL. Cache key includes filter hash for per-filter-combination caching.
3. **Incremental Computation:** On new trade close, update running sums/counts rather than full recomputation.
4. **Query Optimization:** Compound indexes on common filter patterns. EXPLAIN ANALYZE all analytics queries during development to ensure index usage.
5. **Concurrent User Support:** 10 simultaneous dashboard loads within target times; 50 simultaneous at 95th percentile within 2x target; 100 simultaneous at 3x target with degraded mode acceptable (stale cache served).

---

## 9. Test Specifications

### 9.1 Reference Dataset (AN-TEST-001)

Create a reference dataset of 100 trades with manually pre-calculated expected values for every metric. The dataset MUST include:

- 55 winning trades, 42 losing trades, 3 breakeven trades (P&L = $0.00 after commissions)
- Trades across 5 instruments: CL (30), GC (25), PL (15), YM (20), MES (10)
- Trades across 3 playbooks: A+ Trendline Break (47), Standard Break (32), Bounce (21)
- R-multiples ranging from -3.00R to +5.20R
- 86 trades with defined stop losses (R-multiple calculable), 14 without
- Trades on all 5 weekdays, spread across hours 8-16
- 75 trades in RTH, 25 in overnight session
- 60 trades with journal entries (conviction 1-5, emotional states, mistakes), 40 without
- 10 trades with mistake tags: 3 moved_stop, 3 oversized, 2 entered_early, 1 held_too_long, 1 exited_too_early
- Emotional states: 25 confident, 12 patient, 8 disciplined, 6 anxious, 5 fomo, 2 revenge, 2 uncertain
- 12 trades with MAE/MFE tick data
- 4 drawdown periods with known depths ($800, $1,200, $2,400, $650) and recovery times (3, 5, 8, ongoing)
- Date range spanning 90 calendar days with 45 trading days

### 9.2 Assertion Tolerances

| Metric Category | Metric | Tolerance |
|---|---|---|
| Trade Performance | Win Rate | Exact match to 1 decimal |
| Trade Performance | Average Winner/Loser | Within $0.01 |
| Trade Performance | Profit Factor | Within 0.01 |
| Trade Performance | Expectancy | Within $0.01 |
| Trade Performance | Total Net P&L | Exact match |
| Trade Performance | Total Trades | Exact match |
| Risk-Adjusted | Sharpe Ratio | Within 0.01 |
| Risk-Adjusted | Sortino Ratio | Within 0.01 |
| Risk-Adjusted | Calmar Ratio | Within 0.01 |
| Risk-Adjusted | Max Drawdown ($) | Exact match |
| Risk-Adjusted | Max Drawdown (%) | Within 0.01% |
| R-Multiple | R-Multiple per trade | Within 0.01R |
| R-Multiple | Average R | Within 0.01R |
| R-Multiple | Median R | Within 0.01R |
| Behavioral | Tiltmeter Score | Within 1 point |
| Behavioral | Rule Compliance Rate | Exact match to 1 decimal |
| Behavioral | Cost of Mistakes | Within $0.01 |
| Execution | Average Slippage | Within 0.1 ticks |
| Execution | Fill Quality Score | Within 1 point |

### 9.3 Edge Case Tests (AN-TEST-002)

| Test ID | Scenario | Input | Expected Output |
|---|---|---|---|
| EC-001 | Zero trades | Empty trades array | All metrics `null`. API returns `{ total_trades: 0 }`. |
| EC-002 | Single winning trade | 1 trade, realized_pnl = $500 | Win rate = 100.0%. Profit factor = "N/A". Avg loser = "--". Sharpe = "Insufficient data". |
| EC-003 | Single losing trade | 1 trade, realized_pnl = -$300 | Win rate = 0.0%. Profit factor = 0.00. Avg winner = "--". Sharpe = "Insufficient data". |
| EC-004 | All winners (50 trades) | 50 trades, all realized_pnl > 0 | Win rate = 100.0%. Profit factor = ">99.99". Sortino = "N/A". Max drawdown = $0.00. |
| EC-005 | All losers (50 trades) | 50 trades, all realized_pnl < 0 | Win rate = 0.0%. Profit factor = 0.00. Expectancy = avg_loser. |
| EC-006 | Breakeven trade | 1 trade, realized_pnl = $0.00 | Classified as loss. Win rate = 0.0%. |
| EC-007 | No stop loss on any trade | 100 trades, all stop_loss_price = NULL | All R metrics = `null`. Message: "R-multiple analysis requires trades with defined stop losses." |
| EC-008 | Extremely large P&L | 1 trade, realized_pnl = $150,000 | No overflow. Display: "$150.0K". |
| EC-009 | Sub-second trade duration | Entry and exit 0.5s apart | Duration display: "< 1m". |
| EC-010 | Overnight trade spanning midnight | Entry 23:45, exit 00:30 next day | Duration correct. Attributed to exit date. Session: overnight. |
| EC-011 | Simultaneous same-instrument trades | 2 CL trades open at same time | Tracked independently. Both appear in analytics. |
| EC-012 | Stop at entry price | stop_loss_price = entry_price | R-multiple = `null`. Trade excluded from R aggregates. |
| EC-013 | Conviction all same value | All conviction = 3 | Correlation = `null`. "Insufficient variance." |

### 9.4 Filter Combination Tests (AN-TEST-003)

| Test ID | Filter State | Validation |
|---|---|---|
| FC-001 | 7 Days, all instruments, all playbooks | Metrics match manual computation for last 7 days |
| FC-002 | 30 Days, CL only | Metrics match CL trades in last 30 days |
| FC-003 | 90 Days, CL + GC | Metrics match CL and GC trades in last 90 days |
| FC-004 | YTD, A+ Trendline Break only | Metrics match A+ playbook trades since Jan 1 |
| FC-005 | Custom range, multiple playbooks | Correct intersection of all filters |
| FC-006 | Filters resulting in 0 trades | All metrics return `null` with empty state message |
| FC-007 | Filters resulting in 1 trade | All metrics computed for single trade |

### 9.5 Performance Benchmark Tests (AN-TEST-006)

| Test ID | Scenario | Metric | Target |
|---|---|---|---|
| PB-001 | 50-trade cold load | API response time | < 1 second |
| PB-002 | 500-trade cold load | API response time | < 2 seconds |
| PB-003 | 2,000-trade cold load | API response time | < 3 seconds |
| PB-004 | 10,000-trade cold load | API response time | < 5 seconds |
| PB-005 | 50,000-trade cold load | API response time | < 8 seconds |
| PB-006 | Filter change (2,000 trades) | Full recomputation time | < 2 seconds |

### 9.6 Cache Tests

| Test ID | Scenario | Expected Result |
|---|---|---|
| CA-001 | First request (cold cache) | Compute metrics, store in Redis + mv_metrics_cache, return |
| CA-002 | Second identical request (warm cache) | Return from Redis, no recomputation |
| CA-003 | New trade closed | Redis and mv_metrics_cache invalidated for user; mv_daily_pnl upserted |
| CA-004 | Redis unavailable | Fall back to mv_metrics_cache, then full computation if also missed |
| CA-005 | Cache TTL expired (>5 min) | Recompute on next request |

---

## 10. Open Questions & Assumptions

### 10.1 Open Questions

| # | Question | Impact |
|---|---|---|
| OQ-001 | Should the risk-free rate be editable per analytics session or only in global user settings? | Affects Sharpe/Sortino/Calmar. Current assumption: global setting only. |
| OQ-002 | What is the exact contract multiplier and tick size for each supported instrument? | Affects R-multiple, slippage, MAE/MFE dollar calculations. Awaiting instrument config from FSD-003. |
| OQ-003 | Should the P&L calendar heatmap use user's local timezone or exchange timezone for date boundaries? | Assumed: exchange timezone. |

### 10.2 Assumptions

| # | Assumption | Rationale |
|---|---|---|
| A-001 | All trade P&L values in `trades.realized_pnl` already include commissions and fees. | Simplifies analytics calculations. |
| A-002 | The `trades` table schema and RLS policies are established by FSD-003 before analytics development begins. | Analytics is a read-only consumer. |
| A-003 | Journal entries linked via `journal_entries.trade_id` FK. | Required for behavioral metrics. |
| A-004 | Playbook assignments stored as `trades.playbook_id` referencing `playbooks` table. | Required for playbook-segmented metrics. |
| A-005 | Trendline metadata stored directly on the trade record. | Avoids complex JOINs for trendline analytics. |
| A-006 | Supabase Auth JWT includes `user_metadata.subscription_tier`. | Required for tier gating without additional DB lookup. |
| A-007 | Exchange timezones mapped to IANA identifiers. | Required for time-based analysis. |

---

*Document version: 1.0 | Last updated: February 12, 2026*
*This document is part of the TrendEdge FSD suite (FSD-006a, split from FSD-006)*
