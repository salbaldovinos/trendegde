# FSD-008d: Authorization & Multi-Tenancy

**TrendEdge â€” AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-008d |
| Source FSD | FSD-008 |
| Title | Authorization & Multi-Tenancy |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-12 |

---

## 1. Introduction

### 1.1 Purpose

This sub-FSD specifies every authorization, data isolation, team management, account lifecycle, and API key management behavior for TrendEdge. It covers the full RBAC permission model, PostgreSQL Row Level Security (RLS) policies for all user-owned tables, admin override and service role access, team creation and member invitation flows, shared playbook access, data export, account deletion with 30-day grace period, and API key generation/validation.

This document is self-contained. A developer implementing authorization, multi-tenancy, or account lifecycle features should need no other document beyond the cross-references noted below.

### 1.2 Scope

- **Role-Based Access Control (RBAC)** -- Four roles (`user`, `admin`, `team_admin`, `team_member`) with a full permission matrix
- **Row Level Security (RLS)** -- PostgreSQL-enforced data isolation on all user-owned tables
- **Admin Override Policies** -- Controlled, read-only admin access to user data
- **Service Role Access** -- Background task access via Supabase service role key
- **Team/Organization Support** -- Team creation, member invitations, role management, shared playbooks, team analytics
- **API Key Management** -- Key generation, validation, tier limits, webhook URL provisioning
- **Data Export** -- Full user data export as ZIP (JSON + CSV)
- **Account Deletion** -- Soft delete with 30-day grace period, hard delete cleanup

### 1.3 Phased Delivery

| Phase | Timeline | Authorization Scope |
|-------|----------|---------------------|
| Phase 1 | Weeks 1-2 | RLS on all tables from day one. Single `user` role. Service role for Celery workers. |
| Phase 2 | Weeks 9-14 | `admin` role with read-only data access and user management. API key management with RBAC-gated permissions. |
| Phase 3 | Weeks 15-22 | `team_admin` and `team_member` roles. Team creation, invitations, shared playbooks, team analytics. Data export. Account deletion with 30-day grace period. |

### 1.4 Sibling Sub-FSDs

| Sub-FSD | Scope |
|---------|-------|
| FSD-008a | Authentication -- registration, login, OAuth, magic link, JWT lifecycle, session management |
| FSD-008b | User Profiles & Settings -- profile CRUD, trading preferences, notification preferences, onboarding wizard |
| FSD-008c | Broker Connection Management -- credential storage (AES-256-GCM), connection flows, health monitoring, token refresh |
| **FSD-008d** | **This document** -- Authorization, RLS, teams, API keys, data export, account deletion |

### 1.5 Downstream Dependencies

| Dependent FSD | What It Needs From FSD-008d |
|---------------|---------------------------|
| FSD-002 (Trendline Detection) | RLS enforcement for per-user trendline storage |
| FSD-003 (Execution Pipeline) | User identity for order routing; RLS on trades/signals |
| FSD-004 (Journaling) | RLS on journal_entries; user ownership validation |
| FSD-005 (Playbook System) | RLS on playbooks; team sharing policies |
| FSD-006 (Analytics) | RLS data scoping; team analytics aggregation |
| FSD-010 (Integrations) | API key validation for webhook authentication |
| FSD-011 (Billing) | Subscription tier used for permission gating |

---

## 2. Role-Based Access Control (RBAC)

**Source:** PRD AU-FR-060, AU-FR-061, AU-FR-062 | **Phase:** 1 (basic) / 2 (admin) / 3 (team) | **Priority:** P0

### 2.1 Role Definitions

| Role | Scope | Phase |
|------|-------|-------|
| `user` | Own data only. Can manage own profile, trades, playbooks, broker connections, journal entries, API keys. | 1 |
| `admin` | All data (read-only) + user management. Can manage roles, subscription tiers, suspend accounts. | 2 |
| `team_admin` | Own data + team management. Can manage team members, shared playbooks, view team analytics. | 3 |
| `team_member` | Own data + shared resources. Read access to shared team playbooks, aggregated team analytics. | 3 |

### 2.2 Permission Matrix

| Resource | user | admin | team_admin | team_member |
|----------|------|-------|-----------|-------------|
| Own profile (CRUD) | Yes | Yes | Yes | Yes |
| Own trades (CRUD) | Yes | Read-only | Yes | Yes |
| Own playbooks (CRUD) | Yes | Read-only | Yes | Yes |
| Own broker connections (CRUD) | Yes | Read-only | Yes | Yes |
| Own journal entries (CRUD) | Yes | Read-only | Yes | Yes |
| Own API keys (CRUD) | Yes | Read-only | Yes | Yes |
| Other users' data | **No** | Read-only | **No** | **No** |
| User role management | **No** | Yes | **No** | **No** |
| Subscription tier management | **No** | Yes | **No** | **No** |
| Account suspension | **No** | Yes | **No** | **No** |
| Team creation | **No** | Yes | Yes | **No** |
| Team member management | **No** | Yes | Yes (own team) | **No** |
| Shared playbooks (read) | **No** | Yes | Yes (own team) | Yes (own team) |
| Shared playbooks (write) | **No** | **No** | Yes (own team) | **No** |
| Team analytics (read) | **No** | Yes | Yes (own team) | Aggregated only |
| System configuration | **No** | Yes | **No** | **No** |

### 2.3 Role Assignment Rules

1. **New users:** `role = 'user'` (set by the `handle_new_user()` database trigger -- see [FSD-008a]).
2. **Admin role:** Assigned ONLY by another admin or via direct database `UPDATE` (bootstrap for first admin).
3. **team_admin role:** Assigned automatically when a user creates a team (Phase 3).
4. **team_member role:** Assigned when a user accepts a team invitation (Phase 3).
5. A user can have at most ONE role. `team_admin` and `team_member` are mutually exclusive.
6. All role changes are logged in the `audit_logs` table.

### 2.4 Role Verification

**Business Rule BR-023:** Roles are verified from the database, NEVER from JWT claims alone. This prevents privilege escalation via JWT manipulation.

**Implementation:**
1. On each authenticated request, the FastAPI middleware validates the JWT signature and extracts the `sub` claim (user UUID).
2. The user's role is fetched from the `public.users` table (or from the Redis permission cache with 5-minute TTL).
3. Redis key format: `perms:{user_id}` -- stores role and computed permissions.
4. If the cached role does not match the required role for the endpoint, the request is rejected with HTTP 403.

### 2.5 Error Handling for Unauthorized Access

| Scenario | HTTP Status | Response |
|----------|-------------|---------|
| User accesses admin endpoint | 403 | `{"error": "forbidden", "message": "You do not have permission to perform this action."}` |
| User accesses another user's resource via RLS | 200 (empty) | RLS returns zero rows. No error -- the resource appears to not exist. |
| Team member attempts to edit shared playbook | 403 | `{"error": "forbidden", "message": "Only team admins can modify shared playbooks."}` |
| Non-team user accesses team endpoints | 403 | `{"error": "forbidden", "message": "You are not a member of any team."}` |

---

## 3. Row Level Security (RLS)

**Source:** PRD AU-FR-050, AU-FR-051 | **Phase:** 1 | **Priority:** P0

### 3.1 Design Principle

RLS is the last line of defense. Even if application code has a bug, RLS prevents cross-user data leakage. RLS MUST be enabled from Phase 1, even when there is only a single user.

### 3.2 RLS Context Injection

On every authenticated request, the FastAPI backend sets the PostgreSQL session variable for RLS enforcement:

```sql
SET request.jwt.claim.sub = '<user_id>';
```

All subsequent database queries in that request automatically apply RLS policies filtering by `auth.uid()`.

### 3.3 Tables and Policies

Every table listed below MUST have RLS enabled AND forced (preventing bypass by table owners):

| Table | SELECT Policy | INSERT Policy | UPDATE Policy | DELETE Policy | Phase |
|-------|--------------|--------------|--------------|--------------|-------|
| `users` | `id = auth.uid()` | N/A (trigger) | `id = auth.uid()` AND `id = auth.uid()` (WITH CHECK) | N/A (soft delete) | 1 |
| `broker_connections` | `user_id = auth.uid()` | `user_id = auth.uid()` | `user_id = auth.uid()` both USING and WITH CHECK | `user_id = auth.uid()` | 1 |
| `trades` | `user_id = auth.uid()` | `user_id = auth.uid()` | `user_id = auth.uid()` both | `user_id = auth.uid()` | 1 |
| `signals` | `user_id = auth.uid()` | `user_id = auth.uid()` | `user_id = auth.uid()` both | `user_id = auth.uid()` | 1 |
| `trendlines` | `user_id = auth.uid()` | `user_id = auth.uid()` | `user_id = auth.uid()` both | `user_id = auth.uid()` | 1 |
| `playbooks` | `user_id = auth.uid()` | `user_id = auth.uid()` | `user_id = auth.uid()` both | `user_id = auth.uid()` | 1 |
| `journal_entries` | `user_id = auth.uid()` | `user_id = auth.uid()` | `user_id = auth.uid()` both | `user_id = auth.uid()` | 1 |
| `api_keys` | `user_id = auth.uid()` | `user_id = auth.uid()` | `user_id = auth.uid()` both | `user_id = auth.uid()` | 2 |
| `audit_logs` | `user_id = auth.uid()` (SELECT only) | `true` (service role inserts) | N/A (append-only) | N/A (append-only) | 1 |
| `teams` | `id IN (SELECT team_id FROM users WHERE id = auth.uid())` | Team tier check | `owner_id = auth.uid()` OR team_admin | N/A | 3 |
| `team_members` | `team_id IN (SELECT team_id FROM users WHERE id = auth.uid())` | Team admin check | Team admin check | Team admin check | 3 |

### 3.4 SQL Implementation Pattern

For each user-owned table, the following SQL pattern is applied:

```sql
-- Enable and force RLS
ALTER TABLE public.{table_name} ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.{table_name} FORCE ROW LEVEL SECURITY;

-- SELECT: own rows only
CREATE POLICY "Users can view own {table_name}"
  ON public.{table_name} FOR SELECT
  USING (user_id = auth.uid());

-- INSERT: own user_id only
CREATE POLICY "Users can insert own {table_name}"
  ON public.{table_name} FOR INSERT
  WITH CHECK (user_id = auth.uid());

-- UPDATE: own rows only, cannot change user_id
CREATE POLICY "Users can update own {table_name}"
  ON public.{table_name} FOR UPDATE
  USING (user_id = auth.uid())
  WITH CHECK (user_id = auth.uid());

-- DELETE: own rows only
CREATE POLICY "Users can delete own {table_name}"
  ON public.{table_name} FOR DELETE
  USING (user_id = auth.uid());
```

### 3.5 Business Rules

- **BR-040:** RLS MUST be enabled from Phase 1, even when there is only a single user. This ensures RLS is tested and operational before multi-user access.
- **BR-041:** `FORCE ROW LEVEL SECURITY` MUST be applied to prevent the table owner role from bypassing policies.
- **BR-042:** Direct SQL queries without an authenticated JWT context (i.e., without `auth.uid()` set) MUST return zero rows.
- **BR-043:** The INSERT WITH CHECK on `user_id = auth.uid()` prevents a user from inserting a row with another user's `user_id`.

---

## 4. Admin Override Policies

**Source:** PRD AU-FR-052 | **Phase:** 3 | **Priority:** P0

### 4.1 Admin SELECT Policy

Admin users have controlled, read-only access to all user data for support purposes. Admin SELECT policies extend the base RLS policies by adding an OR clause:

```sql
USING (
  user_id = auth.uid()
  OR EXISTS (
    SELECT 1 FROM users WHERE users.id = auth.uid() AND users.role = 'admin'
  )
)
```

### 4.2 Admin Write Restrictions

Admin UPDATE/DELETE policies remain restricted to the user's own data. Admins CANNOT modify other users' trades, journal entries, or playbooks. Admin write access is limited to specific admin endpoints:

- `PATCH /api/admin/users/:id/role` -- Change user role.
- `PATCH /api/admin/users/:id/tier` -- Change subscription tier.
- `POST /api/admin/users/:id/suspend` -- Suspend user account.

### 4.3 Admin Audit Requirements

1. All admin access to user data is logged in `audit_logs` with: `admin_user_id`, `target_user_id`, `action`, `timestamp`, `ip_address`.
2. Admin actions require re-authentication (password confirmation) if the admin's session is older than 15 minutes.

---

## 5. Service Role Access

**Source:** PRD AU-FR-053 | **Phase:** 1 | **Priority:** P0

### 5.1 Purpose

Background tasks (Celery workers) that need cross-user access use the Supabase service role key, which bypasses RLS entirely.

### 5.2 Business Rules

- **BR-044:** The `SUPABASE_SERVICE_ROLE_KEY` is ONLY used in backend Celery workers -- NEVER exposed to the frontend, NEVER used in API endpoints that handle user requests.
- **BR-045:** Service role operations are logged separately with the task name and execution context.
- **BR-046:** Service role usage is restricted to:
  - Broker health checks across all connections
  - Data export generation
  - Soft-delete cleanup (30-day)
  - Encryption key rotation
  - Audit log maintenance

---

## 6. Team / Organization Support (Phase 3)

**Source:** PRD AU-FR-070 through AU-FR-074 | **Phase:** 3 | **Priority:** P0

### 6.1 Team Creation Flow (FR-071)

1. User with `subscription_tier = 'team'` navigates to `/settings/team` and clicks "Create Team."
2. User enters team name (3-100 characters, alphanumeric + spaces + hyphens).
3. System generates a URL-safe slug: lowercase, spaces replaced with hyphens, special characters removed, truncated to 100 chars.
4. System creates the `teams` row with `owner_id = auth.uid()`.
5. System sets the user's `team_id` and `team_role = 'team_admin'`.
6. System creates a `team_members` row with `role = 'team_admin'`, `invitation_status = 'accepted'`, `joined_at = NOW()`.

**Error handling:**
- Slug collision: "A team with a similar name already exists. Please choose a different name."
- User already in a team: "You are already a member of [team_name]. Leave that team before creating a new one."
- Not on Team tier: "Team creation requires the Team plan ($199/mo). [Upgrade]"

### 6.2 Member Invitation Flow (FR-072)

1. Team admin navigates to `/settings/team/members` and clicks "Invite Member."
2. Admin enters the invitee's email address.
3. System validates:
   - Email format is valid.
   - Team has not reached `max_members` limit. Error: "Your team has reached its maximum of [N] members."
   - Email does not already have a pending or accepted invitation. Error: "This email already has a pending invitation." or "This user is already a team member."
4. System creates a `team_members` row: `invitation_status = 'pending'`, generates unique `invitation_token`, sets `invitation_expires_at = NOW() + 7 days`.
5. System sends invitation email: "You've been invited to join [team_name] on TrendEdge by [admin_name]. [Accept Invitation]"
6. Invitation link: `https://app.trendedge.io/teams/join?token=[invitation_token]`

**Invitee flow (existing TrendEdge user):**
1. Clicks link, logs in if not already authenticated.
2. Sees: "You've been invited to join [team_name] by [admin_name]. [Accept] [Decline]"
3. On Accept: `invitation_status` -> `accepted`, user's `team_id` and `team_role = 'team_member'` are set, `joined_at = NOW()`.
4. On Decline: `invitation_status` -> `declined`.

**Invitee flow (new user):**
1. Clicks link, directed to `/register` with `?invitation_token=[token]` preserved.
2. After registration and email verification, the invitation acceptance flow triggers automatically.

**Admin actions:**
- Revoke pending invitation: `invitation_status` -> `revoked`, link becomes invalid.
- Invitation expires after 7 days: link shows "This invitation has expired. Please ask your team admin to send a new one."

### 6.3 Team Role Management (FR-073)

1. Team admin can promote a member to `team_admin` (co-admin).
2. Team admin can demote a `team_admin` to `team_member` (except the team owner).
3. Team admin can remove members from the team. On removal: member's `team_id` and `team_role` are set to null; member retains all their own data.
4. The team owner CANNOT be removed or demoted. The owner CAN transfer ownership to another team admin.

### 6.4 Shared Playbooks and Team Analytics (FR-074)

**Shared Playbooks:**
1. Team admin marks a personal playbook as "shared with team" via a toggle on the playbook detail page.
2. Shared playbooks appear in all team members' playbook lists with a "Shared" badge.
3. Team members can view and use shared playbooks for trade classification but CANNOT edit, duplicate-and-modify, or delete them.
4. Team members can create their own private playbooks.

**Team Analytics:**
1. Team admin views: total team P&L, win rate, average R-multiple, per-member performance summary (name, trade count, P&L, win rate), playbook performance across the team.
2. Team members view: own analytics + aggregated team benchmarks (no individual member data visible).
3. All aggregations are computed server-side; raw data never leaves the RLS boundary.

---

## 7. API Key Management

**Source:** PRD AU-FR-100 | **Phase:** 2 | **Priority:** P0

### 7.1 API Key Generation (FR-100)

1. User navigates to `/settings/api-keys` and clicks "Create API Key."
2. User fills in:
   - **Name** (required): 3-50 characters. E.g., "TradingView Alerts".
   - **Expiration** (optional): 30 days, 60 days, 90 days, or "Never expires."
   - **Permissions** (multi-select): `webhook:write`, `trades:read`.
3. Backend generates a cryptographically random 32-byte key using `secrets.token_hex(32)`.
4. Key is prefixed: `te_live_` (if user is in live mode) or `te_test_` (if user is in paper mode).
5. Full key format example: `te_live_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6` (40 characters total: 8-char prefix + 32-char hex).
6. Backend stores ONLY the SHA-256 hash of the full key in `api_keys.key_hash`. The plaintext key is NEVER stored.
7. The first 8 characters after the prefix are stored as `key_prefix` for display: `a1b2c3d4`.
8. The plaintext key is displayed to the user ONCE in a copyable field.
9. Display: "Your API key has been created. Copy it now -- you won't be able to see it again."
10. A "Copy" button copies the key to clipboard with confirmation toast: "API key copied to clipboard."
11. After the user closes the dialog, the plaintext key is no longer accessible. The key list shows only name, prefix, permissions, and usage stats.

### 7.2 API Key Validation (on webhook receipt)

1. Incoming request includes the API key in `X-API-Key` header (preferred) or `api_key` query parameter.
2. Backend computes SHA-256 hash of the provided key.
3. Backend looks up the hash in `api_keys.key_hash`.
4. Validation checks (in order):
   - Key exists: if not, return HTTP 401 `{"error": "invalid_api_key", "message": "Invalid API key."}`.
   - Key is active (`is_active = true`): if not, return HTTP 401 `{"error": "revoked_api_key", "message": "API key has been revoked."}`.
   - Key is not expired (`expires_at IS NULL OR expires_at > NOW()`): if expired, return HTTP 401 `{"error": "expired_api_key", "message": "API key has expired."}`.
   - Key has required permission for the endpoint: if not, return HTTP 403 `{"error": "insufficient_permissions", "message": "Insufficient permissions."}`.
5. On valid key: update `last_used_at = NOW()` and increment `request_count`. Set the RLS context to the key's `user_id`. Proceed with request processing.

### 7.3 Key Management Actions

- **Revoke:** User clicks "Revoke" on an active key. Confirmation modal: "Revoke API key '[name]'? Any integrations using this key will stop working. [Cancel] [Revoke]". Sets `is_active = false`.
- **Delete:** User clicks "Delete" on a revoked key. Removes the record entirely.
- **View usage:** Displays `request_count`, `last_used_at`, and a 30-day usage chart (requests per day).

### 7.4 Tier Limits

| Tier | Max API Keys |
|------|-------------|
| Free | 1 |
| Trader | 5 |
| Pro | 20 |
| Team | 50 |

Exceeding the limit: "Your [tier] plan supports up to [N] API keys. Upgrade to [next tier] for more. [Upgrade]"

### 7.5 Webhook URL Generation (FR-101)

1. After API key creation, the system displays the webhook URL: `https://api.trendedge.io/v1/webhooks/tradingview?api_key=te_live_...`
2. An alternative method (preferred for security) is to send the API key in the `X-API-Key` header and use the base URL: `https://api.trendedge.io/v1/webhooks/tradingview`.
3. The webhook endpoint accepts POST requests with JSON payload.
4. **Optional HMAC validation:** If the user configures a webhook secret (stored encrypted alongside the API key), the system validates the `X-Signature` header using HMAC-SHA256 of the request body.
5. Payload processing: [Cross-reference: see FSD-010 for TradingView webhook payload format and processing]

### 7.6 Webhook Rate Limiting

| Endpoint | Rate Limit | Window | Lockout Action |
|----------|-----------|--------|----------------|
| `POST /v1/webhooks/*` | 60 requests | per API key per minute | 1-minute block; key auto-disabled after 1,000/hour |

Redis key format: `ratelimit:apikey:{key_hash}:{minute}` with 60-second TTL.

---

## 8. Data Export (Phase 3)

**Source:** PRD AU-FR-090 | **Phase:** 3 | **Priority:** P0

### 8.1 Processing Logic

1. User navigates to `/settings/account` and clicks "Export my data."
2. System displays: "We'll prepare a download of all your TrendEdge data. This may take a few minutes for large accounts."
3. Frontend sends `POST /api/account/export`.
4. Backend enqueues a Celery task to collect all user data.
5. The Celery task collects:
   - Profile information (JSON)
   - All trades with journal entries (CSV + JSON)
   - All playbooks with criteria (JSON)
   - All trendline detections (JSON)
   - All signals (JSON)
   - Settings and preferences (JSON)
   - API key metadata -- name, prefix, permissions, creation date -- but NO secrets (JSON)
6. Data is packaged into a ZIP file named `trendedge-export-{user_id}-{YYYY-MM-DD}.zip`.
7. ZIP is uploaded to Cloudflare R2 at `exports/{user_id}/{filename}` with a 24-hour TTL.
8. User receives an email: "Your TrendEdge data export is ready. [Download] This link expires in 24 hours."
9. The download link is a signed R2 URL valid for 24 hours.
10. After 24 hours, the file is automatically deleted from R2.

### 8.2 Business Rules

- **BR-047:** Rate limit: 1 export request per 24 hours per user.
- **BR-048:** Broker credentials are NEVER included in the export.
- **BR-049:** The export task runs on a Celery worker with service role access to read all user data.

### 8.3 Error Handling

| Error Condition | User-Facing Message |
|----------------|---------------------|
| Export already requested within 24 hours | "You've already requested a data export today. Please try again tomorrow." |
| Export task fails | Email: "Your data export could not be completed. Please try again or contact support." |
| R2 upload fails | Retry up to 3 times. On final failure, notify user via email. |

---

## 9. Account Deletion (Phase 3)

**Source:** PRD AU-FR-091 | **Phase:** 3 | **Priority:** P0

### 9.1 Processing Logic

1. User navigates to `/settings/account` and clicks "Delete my account."
2. System displays a confirmation screen with:
   - "This action is permanent and cannot be undone."
   - "All your data will be deleted, including: trades, journal entries, playbooks, trendlines, broker connections, API keys, and settings."
   - "Active broker connections will be disconnected."
   - "If you have an active subscription, it will be cancelled immediately with no refund for the current billing period."
3. User must type the word "DELETE" (case-sensitive) in a text input to confirm.
4. User must re-authenticate: enter password, or confirm via OAuth re-consent.
5. On confirmation, the system executes the following in order:
   a. Cancel any active subscription via Stripe API. [Cross-reference: see FSD-011 for billing details]
   b. Disconnect all broker connections (revoke OAuth tokens where possible, e.g., Tradovate, Webull).
   c. Revoke all API keys (`is_active = false`).
   d. Soft-delete the `public.users` row: set `deleted_at = NOW()`.
   e. Sign out all active sessions.
6. Send confirmation email: "Your TrendEdge account has been deleted. If this was a mistake, contact support within 30 days to restore your account."
7. **Grace period (30 days):** All data is retained with `deleted_at` timestamps. The user cannot log in. Support can restore the account by clearing `deleted_at` and re-enabling the `auth.users` row.
8. **After 30 days:** A scheduled Celery task runs daily and hard-deletes all data for accounts where `deleted_at < NOW() - INTERVAL '30 days'`:
   - Hard delete from all tables: trades, journal_entries, playbooks, trendlines, signals, broker_connections, api_keys, audit_logs.
   - Delete avatar from R2 storage.
   - Delete the `public.users` row.
   - Delete the `auth.users` row via Supabase admin API.

### 9.2 Business Rules

- **BR-050:** The word "DELETE" must be typed exactly (case-sensitive, no extra whitespace) to proceed.
- **BR-051:** Re-authentication is required regardless of how recently the user logged in.
- **BR-052:** Soft-deleted accounts cannot log in. The login endpoint returns the generic "Invalid email or password" message (no indication of deletion).
- **BR-053:** Support restoration within the 30-day window re-enables all data and sessions. The user must set a new password.

---

## 10. Data Specifications

### 10.1 Users Table (Authorization-Relevant Columns)

**Table:** `public.users`

The full table schema is in [FSD-008b]. The columns relevant to authorization and multi-tenancy are:

| Column | Type | Constraints | Default | Description |
|--------|------|------------|---------|-------------|
| id | UUID | PK, FK -> auth.users(id) ON DELETE CASCADE | N/A | Matches Supabase auth user ID |
| role | TEXT | NOT NULL, CHECK IN ('user','admin') | 'user' | Platform role |
| subscription_tier | TEXT | NOT NULL, CHECK IN ('free','trader','pro','team') | 'free' | Current subscription tier (gates feature access) |
| team_id | UUID | nullable, FK -> teams(id) ON DELETE SET NULL | null | Team membership (Phase 3) |
| team_role | TEXT | nullable, CHECK IN ('team_admin','team_member') | null | Role within team (Phase 3) |
| deleted_at | TIMESTAMPTZ | nullable | null | Soft delete timestamp |

### 10.2 API Keys Table

**Table:** `public.api_keys`

| Column | Type | Constraints | Default | Description |
|--------|------|------------|---------|-------------|
| id | UUID | PK | gen_random_uuid() | Key identifier |
| user_id | UUID | NOT NULL, FK -> users(id) ON DELETE CASCADE, INDEX | N/A | Owner |
| name | TEXT | NOT NULL, 3-50 chars | N/A | User-defined key name |
| key_prefix | TEXT | NOT NULL, 8 chars | N/A | Visible portion of key |
| key_hash | TEXT | NOT NULL, UNIQUE, INDEX | N/A | SHA-256 hash of full key |
| permissions | TEXT[] | NOT NULL | '{}' | Array of permission strings |
| last_used_at | TIMESTAMPTZ | nullable | null | Last API call using this key |
| expires_at | TIMESTAMPTZ | nullable | null | Expiration (null = never) |
| is_active | BOOLEAN | NOT NULL | true | Whether key is active |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | Creation timestamp |
| request_count | BIGINT | NOT NULL | 0 | Total requests processed |

### 10.3 Teams Table (Phase 3)

**Table:** `public.teams`

| Column | Type | Constraints | Default | Description |
|--------|------|------------|---------|-------------|
| id | UUID | PK | gen_random_uuid() | Team identifier |
| name | TEXT | NOT NULL, 3-100 chars | N/A | Team display name |
| slug | TEXT | NOT NULL, UNIQUE | N/A | URL-safe slug |
| owner_id | UUID | NOT NULL, FK -> users(id) | N/A | Team creator/owner |
| max_members | INTEGER | NOT NULL | 5 | Maximum allowed members |
| settings | JSONB | NOT NULL | '{}' | Team configuration |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | Creation timestamp |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | Last update timestamp |

### 10.4 Team Members Table (Phase 3)

**Table:** `public.team_members`

| Column | Type | Constraints | Default | Description |
|--------|------|------------|---------|-------------|
| id | UUID | PK | gen_random_uuid() | Record identifier |
| team_id | UUID | NOT NULL, FK -> teams(id) ON DELETE CASCADE, INDEX | N/A | Team reference |
| user_id | UUID | nullable, FK -> users(id) ON DELETE CASCADE, INDEX | null | User reference (null for pending invitations to non-users) |
| role | TEXT | NOT NULL, CHECK IN ('team_admin','team_member') | 'team_member' | Role within team |
| joined_at | TIMESTAMPTZ | nullable | null | When user accepted invitation |
| invited_by | UUID | FK -> users(id) | N/A | Who sent the invitation |
| invitation_status | TEXT | NOT NULL, CHECK IN ('pending','accepted','declined','revoked') | 'pending' | Invitation state |
| invitation_email | TEXT | NOT NULL | N/A | Invitee email address |
| invitation_token | TEXT | UNIQUE, INDEX | N/A | Unique token for invitation link |
| invitation_expires_at | TIMESTAMPTZ | nullable | null | When invitation expires |

### 10.5 Audit Logs Table

**Table:** `public.audit_logs`

| Column | Type | Constraints | Default | Description |
|--------|------|------------|---------|-------------|
| id | UUID | PK | gen_random_uuid() | Log entry identifier |
| user_id | UUID | FK -> users(id) ON DELETE SET NULL, INDEX | null | Acting user (null for system events) |
| event_type | TEXT | NOT NULL, INDEX | N/A | Event type identifier |
| event_data | JSONB | NOT NULL | '{}' | Event-specific data |
| ip_address | INET | nullable | null | Source IP address |
| user_agent | TEXT | nullable | null | Browser/client user agent |
| created_at | TIMESTAMPTZ | NOT NULL, INDEX | NOW() | Event timestamp |

**Authorization-relevant audit event types:**
`role_changed`, `account_deleted`, `admin_data_access`, `api_key_created`, `api_key_revoked`, `team_created`, `team_member_invited`, `team_member_joined`, `team_member_removed`, `rate_limit_triggered`

**Audit log RLS:** Users can read only their own audit entries. Admins can read all entries. The table has NO UPDATE or DELETE policies (insert-only via service role).

**Retention:** 2 years. Logs older than 2 years are archived to cold storage before deletion.

### 10.6 Database Indexes

```sql
CREATE INDEX idx_api_keys_user_id ON public.api_keys(user_id);
CREATE INDEX idx_api_keys_key_hash ON public.api_keys(key_hash);
CREATE INDEX idx_api_keys_is_active ON public.api_keys(is_active);
CREATE INDEX idx_team_members_team_id ON public.team_members(team_id);
CREATE INDEX idx_team_members_user_id ON public.team_members(user_id);
CREATE INDEX idx_team_members_invitation_token ON public.team_members(invitation_token);
CREATE INDEX idx_audit_logs_user_id ON public.audit_logs(user_id);
CREATE INDEX idx_audit_logs_event_type ON public.audit_logs(event_type);
CREATE INDEX idx_audit_logs_created_at ON public.audit_logs(created_at);
CREATE INDEX idx_users_team_id ON public.users(team_id);
CREATE INDEX idx_users_deleted_at ON public.users(deleted_at);
```

---

## 11. API Specifications

### 11.1 API Key Endpoints (Authenticated)

#### GET /api/api-keys

**Phase:** 2 | **Auth:** Bearer JWT

**Response 200:**
```json
{
  "keys": [
    {
      "id": "uuid",
      "name": "TradingView Alerts",
      "key_prefix": "a1b2c3d4",
      "permissions": ["webhook:write", "trades:read"],
      "is_active": true,
      "last_used_at": "2026-02-11T12:00:00Z",
      "expires_at": null,
      "created_at": "2026-02-01T10:00:00Z",
      "request_count": 1542
    }
  ]
}
```

#### POST /api/api-keys

**Phase:** 2 | **Auth:** Bearer JWT

**Request:**
```json
{
  "name": "TradingView Alerts",
  "permissions": ["webhook:write"],
  "expires_in_days": 90
}
```

**Response 201:**
```json
{
  "id": "uuid",
  "name": "TradingView Alerts",
  "key": "te_live_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6",
  "key_prefix": "a1b2c3d4",
  "permissions": ["webhook:write"],
  "expires_at": "2026-05-12T10:00:00Z",
  "webhook_url": "https://api.trendedge.io/v1/webhooks/tradingview",
  "message": "Your API key has been created. Copy it now -- you won't be able to see it again."
}
```

Note: The `key` field is ONLY included in the creation response. Subsequent GET requests do not include it.

#### DELETE /api/api-keys/:id

**Phase:** 2 | **Auth:** Bearer JWT

**Response 200:** `{"message": "API key revoked."}`

### 11.2 Webhook Endpoint (API Key Auth)

#### POST /v1/webhooks/tradingview

**Phase:** 2 | **Auth:** API Key (X-API-Key header or api_key query param) | **Rate Limit:** 60/key/min

**Request:** TradingView alert JSON payload. [Cross-reference: see FSD-010 for payload format]

**Response 200:** `{"status": "received", "signal_id": "uuid"}`
**Response 401:** Invalid, revoked, or expired API key.
**Response 403:** Insufficient permissions.
**Response 429:** Rate limit exceeded.

### 11.3 Team Endpoints (Authenticated, Phase 3)

#### POST /api/teams

Create team. Requires `subscription_tier = 'team'`.

**Request:**
```json
{
  "name": "Alpha Trading Group"
}
```

**Response 201:**
```json
{
  "id": "uuid",
  "name": "Alpha Trading Group",
  "slug": "alpha-trading-group",
  "owner_id": "uuid",
  "max_members": 5,
  "created_at": "2026-02-12T12:00:00Z"
}
```

**Response 403:** `{"error": "forbidden", "message": "Team creation requires the Team plan ($199/mo)."}`

#### GET /api/teams/:id

Get team details. Requires team membership.

#### PATCH /api/teams/:id

Update team settings. Requires `team_admin` role.

#### POST /api/teams/:id/invite

Invite member. Requires `team_admin` role.

**Request:**
```json
{
  "email": "newmember@example.com"
}
```

**Response 201:**
```json
{
  "invitation_id": "uuid",
  "invitation_email": "newmember@example.com",
  "invitation_status": "pending",
  "invitation_expires_at": "2026-02-19T12:00:00Z"
}
```

#### POST /api/teams/join

Accept invitation via token.

**Request:**
```json
{
  "token": "invitation-token-value"
}
```

**Response 200:**
```json
{
  "team_id": "uuid",
  "team_name": "Alpha Trading Group",
  "role": "team_member",
  "joined_at": "2026-02-12T12:00:00Z"
}
```

#### DELETE /api/teams/:id/members/:userId

Remove team member. Requires `team_admin` role.

**Response 200:** `{"message": "Member removed from team."}`
**Response 403:** `{"error": "forbidden", "message": "Cannot remove the team owner."}`

#### GET /api/teams/:id/analytics

Get team analytics. `team_admin` sees full per-member data; `team_member` sees aggregated only.

### 11.4 Account Lifecycle Endpoints (Authenticated, Phase 3)

#### POST /api/account/export

Request data export. Returns 202 Accepted. Email sent when ready.

**Response 202:**
```json
{
  "message": "Your data export is being prepared. You'll receive an email when it's ready.",
  "estimated_time": "5 minutes"
}
```

**Response 429:** `{"error": "rate_limit_exceeded", "message": "You've already requested a data export today. Please try again tomorrow."}`

#### DELETE /api/account

Delete account. Requires re-authentication and "DELETE" confirmation string.

**Request:**
```json
{
  "confirmation": "DELETE",
  "password": "current-password"
}
```

**Response 200:**
```json
{
  "message": "Your account has been deleted. You have 30 days to contact support if you change your mind."
}
```

**Response 422:** `{"error": "validation_error", "message": "Please type DELETE to confirm account deletion."}`

### 11.5 Admin Endpoints (Admin Role, Phase 2-3)

#### PATCH /api/admin/users/:id/role

Change user role. Admin only. Requires re-auth if session > 15 min.

**Request:**
```json
{
  "role": "admin"
}
```

**Response 200:** Updated user object.
**Response 403:** `{"error": "forbidden", "message": "You do not have permission to perform this action."}`

#### PATCH /api/admin/users/:id/tier

Change subscription tier. Admin only.

**Request:**
```json
{
  "subscription_tier": "pro"
}
```

#### POST /api/admin/users/:id/suspend

Suspend user account. Admin only.

**Response 200:** `{"message": "User account suspended."}`

---

## 12. Security Specifications

### 12.1 Audit Logging

All authorization-relevant events are logged in an append-only `audit_logs` table.

| Event Type | Data Captured |
|-----------|-------------|
| `role_changed` | user_id, old_role, new_role, changed_by, timestamp |
| `account_deleted` | user_id, timestamp |
| `admin_data_access` | admin_id, target_user_id, action, timestamp |
| `api_key_created` | user_id, key_prefix, permissions, timestamp |
| `api_key_revoked` | user_id, key_prefix, timestamp |
| `team_created` | user_id, team_id, team_name, timestamp |
| `team_member_invited` | team_id, invitation_email, invited_by, timestamp |
| `team_member_joined` | team_id, user_id, timestamp |
| `team_member_removed` | team_id, user_id, removed_by, timestamp |
| `rate_limit_triggered` | IP, endpoint, count, timestamp |

### 12.2 Permission Caching (Redis)

| Pattern | Key Format | TTL | Purpose |
|---------|-----------|-----|---------|
| Permission cache | `perms:{user_id}` | 5 minutes | Cached role and permissions |
| Rate limit (API key) | `ratelimit:apikey:{key_hash}:{minute}` | 60 seconds | Webhook rate limiting |

**Fallback:** If Redis is unavailable, rate limiting degrades to in-memory counters (per-process, not distributed). A warning is logged every 60 seconds until Redis connectivity is restored.

### 12.3 Session Fixation Prevention

1. Session tokens are regenerated after any privilege change (email verification, role change).
2. This ensures that a role promotion does not carry over a session that was established at a lower privilege level.

---

## 13. Testing Specifications

### 13.1 RLS Cross-User Isolation Tests (CRITICAL -- Run on Every Deployment)

| Test ID | Test Case | Method | Expected Outcome | Type |
|---------|-----------|--------|-----------------|------|
| T-060 | User A reads User B's trades | Auth as A, SELECT with B's trade ID | 0 rows returned | Automated |
| T-061 | User A updates User B's playbook | Auth as A, UPDATE with B's playbook ID | 0 rows affected | Automated |
| T-062 | User A deletes User B's trendline | Auth as A, DELETE with B's trendline ID | 0 rows affected | Automated |
| T-063 | User A inserts trade with B's user_id | Auth as A, INSERT with user_id = B | RLS violation error | Automated |
| T-064 | Query without auth context | Query without setting JWT claim | 0 rows returned | Automated |
| T-065 | Service role access | Use service role key | Full access (intentional) | Automated |
| T-066 | Admin reads User B's trades | Auth as admin, query B's trades | Rows returned (Phase 3 only) | Automated |
| T-067 | Admin updates User B's trades | Auth as admin, UPDATE B's trades | 0 rows affected (admin is read-only) | Automated |
| T-068 | RLS on ALL tables | Run T-060 pattern on every user-owned table | 0 rows on all tables | Automated |

**Automated test implementation (runs in CI/CD):**
```python
def test_rls_cross_user_isolation():
    """Verify User A cannot access User B's data across all tables."""
    tables = ['trades', 'signals', 'trendlines', 'playbooks',
              'journal_entries', 'broker_connections', 'api_keys']

    for table in tables:
        client_a = create_authenticated_client(user_a_token)

        # Attempt to read User B's data
        result = client_a.from_(table).select('*').eq('user_id', user_b_id).execute()
        assert len(result.data) == 0, f"User A accessed User B's {table}"

        # Attempt to read by specific ID belonging to User B
        result = client_a.from_(table).select('*').eq('id', user_b_record_id).execute()
        assert len(result.data) == 0, f"User A accessed User B's {table} by ID"
```

### 13.2 RBAC Permission Tests

| Test ID | Test Case | Input | Expected Outcome | Type |
|---------|-----------|-------|-----------------|------|
| T-070 | User accesses admin endpoint | Auth as `user`, call `PATCH /api/admin/users/:id/role` | 403 Forbidden | Automated |
| T-071 | Admin reads user data | Auth as `admin`, query another user's trades | Rows returned (read-only) | Automated |
| T-072 | Admin attempts to update user data | Auth as `admin`, UPDATE another user's playbook | 0 rows affected / 403 | Automated |
| T-073 | Role from DB not JWT | Modify JWT claims to set `role: admin`, use valid signature | Role fetched from DB, access denied | Automated |
| T-074 | Team member edits shared playbook | Auth as `team_member`, UPDATE shared playbook | 403 "Only team admins can modify shared playbooks" | Automated |
| T-075 | Non-team user accesses team endpoint | Auth as user without team, call `GET /api/teams/:id` | 403 "You are not a member of any team" | Automated |

### 13.3 API Key Tests

| Test ID | Test Case | Input | Expected Outcome | Type |
|---------|-----------|-------|-----------------|------|
| T-090 | Create API key | Valid name + permissions | 201, key returned once | Automated |
| T-091 | Use valid API key | `X-API-Key: te_live_...` on webhook endpoint | 200, signal processed | Automated |
| T-092 | Use revoked API key | Previously revoked key | 401 "API key has been revoked" | Automated |
| T-093 | Use expired API key | Expired key | 401 "API key has expired" | Automated |
| T-094 | Insufficient permissions | Key with `trades:read` on `webhook:write` endpoint | 403 "Insufficient permissions" | Automated |
| T-095 | Tier limit enforcement | Create keys beyond tier limit | 403 with upgrade message | Automated |
| T-096 | Key hash not plaintext | Direct DB query on `api_keys` | `key_hash` is SHA-256 hex, no plaintext stored | Automated |
| T-097 | API key sets RLS context | Use API key for webhook | Resulting data scoped to key owner's user_id | Automated |

### 13.4 Team Management Tests

| Test ID | Test Case | Input | Expected Outcome | Type |
|---------|-----------|-------|-----------------|------|
| T-110 | Create team (Team tier) | User with `subscription_tier = 'team'` | Team created, user becomes team_admin | Automated |
| T-111 | Create team (wrong tier) | User with `subscription_tier = 'pro'` | 403 "Team creation requires the Team plan" | Automated |
| T-112 | Invite member | Team admin invites email | team_members row created, email sent | Automated |
| T-113 | Accept invitation | Invitee clicks link, accepts | user's team_id set, status -> accepted | Automated |
| T-114 | Expired invitation | Click link after 7 days | "This invitation has expired" | Automated |
| T-115 | Max members exceeded | Invite when at max_members | "Your team has reached its maximum" | Automated |
| T-116 | Remove member | Team admin removes member | member's team_id = null, data retained | Automated |
| T-117 | Cannot remove owner | Attempt to remove team owner | 403 "Cannot remove the team owner" | Automated |
| T-118 | Team RLS isolation | Team A member queries Team B data | 0 rows returned | Automated |
| T-119 | Shared playbook visibility | Team admin shares playbook | Visible to all team members | Automated |

### 13.5 Account Lifecycle Tests

| Test ID | Test Case | Input | Expected Outcome | Type |
|---------|-----------|-------|-----------------|------|
| T-130 | Data export request | POST /api/account/export | 202, Celery task enqueued | Automated |
| T-131 | Export rate limit | 2 exports in 24 hours | 2nd returns 429 | Automated |
| T-132 | Export excludes credentials | Download and inspect ZIP | No broker credentials present | Automated |
| T-133 | Account soft delete | DELETE /api/account with "DELETE" + password | deleted_at set, sessions revoked | Automated |
| T-134 | Soft-deleted user login | Attempt login after deletion | 401 generic "Invalid email or password" | Automated |
| T-135 | 30-day hard delete | Simulate 30 days elapsed | All data hard-deleted from all tables | Automated |
| T-136 | Missing DELETE confirmation | Submit without typing "DELETE" | 422 validation error | Automated |
| T-137 | Account restoration | Admin clears deleted_at within 30 days | Account restored, user must set new password | Manual |

### 13.6 Penetration Testing (Authorization-Relevant)

| Test ID | Category | Test | Pass Criteria | Type |
|---------|----------|------|--------------|------|
| T-122 | Privilege Escalation | Change role claim in JWT | Signature fails; role always verified from DB | Automated |
| T-129 | RLS Bypass | Direct queries via Supabase URL | RLS blocks all unauthorized access | Automated |
| T-130p | IDOR | Access resources by guessing/iterating UUIDs | RLS + ownership check prevents access | Automated |

---

## 14. Migration & Deployment

### 14.1 Phase 1 -- Authorization Baseline

**Database migrations:**
1. Enable and force RLS on `users`, `broker_connections`, `trades`, `signals`, `trendlines`, `playbooks`, `journal_entries`, `audit_logs`.
2. Create all RLS policies per section 3.4 pattern.
3. Create audit_logs indexes.

**Verification:**
- RLS tests T-060 through T-068 all pass.
- Direct queries without JWT context return 0 rows.
- Service role access works for Celery workers.

### 14.2 Phase 2 -- Admin & API Keys

**Database migrations:**
1. Create `public.api_keys` table.
2. Enable RLS on `api_keys` with standard user-scoped policies.
3. Create `api_keys` indexes.

**Verification:**
- All Phase 1 RLS tests still pass.
- API keys can be created, used for webhooks, and revoked.
- Tier limits are enforced on API key creation.
- Admin endpoints reject non-admin users with 403.
- Admin read-only access works but write access is blocked on user data.

### 14.3 Phase 3 -- Teams & Account Lifecycle

**Database migrations:**
1. Create `public.teams` table.
2. Create `public.team_members` table.
3. Add `team_id` and `team_role` columns to `public.users` (if not already present).
4. Enable RLS on `teams` and `team_members`.
5. Create team-specific RLS policies.
6. Create indexes on team tables.

**Verification:**
- All Phase 1 and Phase 2 tests still pass.
- Team creation and invitation flow works.
- Team RLS prevents cross-team data access (T-118).
- Shared playbooks are visible to team members.
- Data export generates valid ZIP excluding credentials.
- Account deletion soft-deletes correctly.
- 30-day cleanup task hard-deletes correctly.

### 14.4 Data Integrity Checks Post-Deployment

| Check | Query | Expected |
|-------|-------|----------|
| RLS is enabled on all tables | `SELECT tablename FROM pg_tables WHERE schemaname='public' AND tablename NOT IN (SELECT tablename FROM pg_policies ...)` | 0 unprotected tables |
| No orphaned team members | `SELECT COUNT(*) FROM team_members WHERE team_id NOT IN (SELECT id FROM teams)` | 0 |
| All API key hashes are unique | `SELECT key_hash, COUNT(*) FROM api_keys GROUP BY key_hash HAVING COUNT(*) > 1` | 0 rows |

---

## 15. Open Questions

| ID | Question | Impact | Decision Needed By |
|----|---------|--------|-------------------|
| Q-003 | What is the maximum number of team members for the Team tier? | PRD says 5-20+; need exact limit for enforcement. | Before Phase 3 development |
| Q-004 | Should soft-deleted users' data be anonymized rather than fully deleted? | Anonymized data could be useful for aggregate analytics. | Before Phase 3 development |
| Q-005 | How should we handle the case where a user belongs to multiple teams? | Current design: one team per user. Multi-team may be needed for prop firm managers. | Phase 3 planning |
| Q-008 | Should admin actions require 2FA in addition to re-authentication? | Higher security for admin operations. | Phase 2 planning |
