# FSD-012c: Command Palette

**TrendEdge -- AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-012c |
| Source | PRD-012 (Completion Sweep, CS-3) |
| Title | Command Palette |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-12 |

---

## Table of Contents

1. [Introduction](#1-introduction)
2. [Component Architecture](#2-component-architecture)
3. [Trigger Mechanism](#3-trigger-mechanism)
4. [Modal Behavior](#4-modal-behavior)
5. [Search Input](#5-search-input)
6. [Result Categories](#6-result-categories)
7. [Matching Algorithm](#7-matching-algorithm)
8. [Keyboard Navigation](#8-keyboard-navigation)
9. [State Management](#9-state-management)
10. [UI Specifications](#10-ui-specifications)
11. [Accessibility](#11-accessibility)
12. [Performance](#12-performance)
13. [Mobile Behavior](#13-mobile-behavior)
14. [Edge Cases](#14-edge-cases)
15. [Testing](#15-testing)

---

## 1. Introduction

### 1.1 Purpose

This sub-FSD specifies the command palette (Cmd+K) for the TrendEdge platform. The command palette is a modal search interface that provides rapid navigation, instrument lookup, trade search, and action execution through a keyboard-driven workflow.

A developer should be able to implement the complete command palette component, including all result categories, keyboard navigation, accessibility, and API integration, from this document alone.

### 1.2 Scope

This document covers:

- Command palette React component tree and file layout
- Trigger mechanisms (keyboard shortcut, header button)
- Modal rendering, animations, and close behavior
- Search input with debounced filtering
- Five result categories: Pages, Instruments, Recent Trades, Playbooks, Actions
- Case-insensitive substring matching with character highlighting
- Full keyboard navigation (arrow keys, Enter, Escape, Tab)
- Component state machine (initial, typing, loading, no results, error)
- UI dimensions, typography, colors, and layout
- ARIA roles, focus management, and screen reader announcements
- Performance budgets and bundle size targets
- Mobile viewport adaptations
- Edge case handling

### 1.3 Out of Scope

- Sidebar navigation and header bar layout (see FSD-011a Section 3.1, 3.2)
- Global keyboard shortcut registration framework (see FSD-011a Section 7)
- Toast notification system for error display (see FSD-011a Section 3.7)
- Backend API endpoints for trades and playbooks (see FSD-003d, FSD-005)
- Theme system implementation (see FSD-011a Section 5)
- Instrument data management and market data feeds (see FSD-010, FSD-012d)

### 1.4 Relationship to FSD-011a

FSD-011a (App Shell & Navigation) defines the command palette at a summary level in Sections 3.5.1 through 3.5.8. This document expands those specifications into full implementation detail. Where FSD-011a provides the "what," this document provides the "how."

Specifically, this FSD elaborates on:
- FSD-011a Section 3.5.1 (Trigger) -- expanded with input suppression logic and platform detection
- FSD-011a Section 3.5.2 (Appearance) -- expanded with exact dimensions, animations, and mobile layout
- FSD-011a Section 3.5.3 (Search Input) -- expanded with clear button, debounce strategy, and placeholder
- FSD-011a Section 3.5.4 (Result Categories) -- expanded with exact data sources, fields, icons, and API contracts
- FSD-011a Section 3.5.5 (Fuzzy Matching) -- expanded with rendering algorithm for character highlighting
- FSD-011a Section 3.5.6 (Keyboard Navigation) -- expanded with wrap behavior, category header skipping, and ARIA
- FSD-011a Section 3.5.7 (Performance) -- expanded with bundle size budget and measurement method
- FSD-011a Section 3.5.8 (States) -- expanded with loading skeleton, error handling, and state transitions

### 1.5 External Dependencies

| Dependency | Type | Description |
|---|---|---|
| `cmdk` | Hard | Headless command palette library for React. Provides accessible listbox, keyboard navigation, and filtering primitives. |
| `lucide-react` | Hard | Icon library for result category icons and action icons. Already in the project. |
| Next.js App Router | Hard | `useRouter` for programmatic navigation on result selection. |
| Zustand (ui-store) | Soft | `useUIStore` for theme toggle action. Already defined in FSD-011a. |
| TanStack Query | Soft | Data fetching for API-backed result categories (recent trades, playbooks). |

---

## 2. Component Architecture

### 2.1 File Layout

```
frontend/components/command-palette/
├── command-palette.tsx          # Root component: modal wrapper, keyboard listener, state orchestration
├── command-input.tsx            # Search input with clear button
├── command-list.tsx             # Scrollable result list container
├── command-group.tsx            # Category group (header + items)
├── command-item.tsx             # Individual result item with icon, label, metadata, and highlight
├── command-empty.tsx            # Empty state display ("No results found")
├── command-loading.tsx          # Skeleton placeholders for API-backed categories
├── highlight-match.tsx          # Utility component for rendering highlighted substring matches
├── use-command-palette.ts       # Hook: open/close state, query, keyboard shortcut registration
└── constants.ts                 # Static data: pages list, actions list
```

### 2.2 Component Tree

```
<CommandPalette>                         # Modal wrapper, backdrop, keyboard listener
  <Dialog>                               # Radix Dialog primitive (via cmdk.Dialog)
    <CommandInput />                     # Search input (auto-focus, clear button)
    <CommandList>                        # Scrollable container (max-height constrained)
      <CommandGroup label="Pages">       # Category: Pages
        <CommandItem />                  # Repeated per matching page
      </CommandGroup>
      <CommandGroup label="Instruments"> # Category: Instruments
        <CommandItem />
      </CommandGroup>
      <CommandGroup label="Recent Trades"> # Category: Recent Trades
        <CommandLoading />               # Shown while API is loading
        <CommandItem />
      </CommandGroup>
      <CommandGroup label="Playbooks">   # Category: Playbooks
        <CommandLoading />
        <CommandItem />
      </CommandGroup>
      <CommandGroup label="Actions">     # Category: Actions
        <CommandItem />
      </CommandGroup>
      <CommandEmpty />                   # Shown when all categories are empty
    </CommandList>
  </Dialog>
</CommandPalette>
```

### 2.3 Library Choice: cmdk

**Selected library**: `cmdk` (Command Menu for React) by Paco Coursey.

**Why cmdk:**

1. **Headless architecture** -- provides behavior (keyboard navigation, filtering, accessible roles) without imposing visual styles, allowing full customization with Tailwind CSS and design tokens from FSD-011a.
2. **Built-in accessibility** -- renders correct ARIA roles (`dialog`, `listbox`, `option`), manages `aria-activedescendant`, and announces results to screen readers.
3. **Composable API** -- `<Command.Input>`, `<Command.List>`, `<Command.Group>`, `<Command.Item>`, and `<Command.Empty>` map directly to the component tree defined above.
4. **Small bundle** -- ~3.5KB gzip. Combined with the component code (~8-10KB gzip), stays within the 15KB gzip budget.
5. **Active maintenance** -- widely adopted in production by Vercel, Linear, and Raycast.
6. **shadcn/ui compatibility** -- shadcn/ui provides a `Command` component built on cmdk that can be used as a starting point.

**Alternatives considered and rejected:**

| Library | Reason for Rejection |
|---|---|
| `@headlessui/react` Combobox | Not purpose-built for command palettes; requires significant additional work for grouped results and keyboard shortcuts. |
| `kbar` | Heavier bundle (~8KB gzip); less composable API; built-in styling that conflicts with shadcn/ui design system. |
| Custom implementation | Excessive scope for accessibility compliance (ARIA roles, focus management, screen reader announcements). cmdk already solves these problems correctly. |

### 2.4 shadcn/ui Integration

The project uses shadcn/ui, which ships a `Command` component wrapping cmdk. The implementation should use the shadcn/ui `Command` primitive as the base, extending it with:

- Custom result item rendering (icon + label + metadata + highlight)
- API-backed category groups with loading states
- Global keyboard shortcut registration
- Modal dialog wrapper (shadcn/ui `Dialog` or `CommandDialog`)

---

## 3. Trigger Mechanism

### 3.1 Keyboard Shortcut

| Platform | Shortcut | Key Event |
|---|---|---|
| macOS | `Cmd+K` | `metaKey && key === "k"` |
| Windows / Linux | `Ctrl+K` | `ctrlKey && key === "k"` |

The shortcut listener is registered as a `keydown` event on `document` during component mount and removed on unmount.

### 3.2 Input Suppression

The keyboard shortcut is **suppressed** (the command palette does NOT open) when the currently focused element matches any of the following:

| Element Type | Detection |
|---|---|
| `<input>` | `event.target.tagName === "INPUT"` |
| `<textarea>` | `event.target.tagName === "TEXTAREA"` |
| `[contenteditable]` | `event.target.isContentEditable === true` |

**Implementation:**

```typescript
function handleKeyDown(event: KeyboardEvent) {
  const target = event.target as HTMLElement;

  if (
    target.tagName === "INPUT" ||
    target.tagName === "TEXTAREA" ||
    target.isContentEditable
  ) {
    return; // Do not open palette
  }

  if ((event.metaKey || event.ctrlKey) && event.key === "k") {
    event.preventDefault(); // Prevent browser default (e.g., Chrome address bar focus)
    openPalette();
  }
}
```

### 3.3 Header Button Trigger

The header bar (defined in FSD-011a Section 3.2) contains a command palette trigger button in the right section.

**Button specification:**

| Property | Value |
|---|---|
| Icon | `Search` (Lucide) at 16px |
| Label | `"Search..."` in `text-sm text-muted-foreground` |
| Shortcut hint | `"Cmd+K"` (macOS) or `"Ctrl+K"` (other) in a `kbd` element, `text-xs text-muted-foreground bg-muted rounded px-1.5 py-0.5 font-mono` |
| Layout | Icon + label + shortcut hint, horizontally aligned with `gap-2` |
| Border | `border border-input rounded-md` |
| Padding | `px-3 py-1.5` |
| Width | `w-64` (fixed width for visual consistency) |
| Hover | `bg-muted` background transition |
| Cursor | `pointer` |

**Platform detection for shortcut hint:**

```typescript
const isMac = typeof navigator !== "undefined" && navigator.userAgent.includes("Mac");
const shortcutLabel = isMac ? "\u2318K" : "Ctrl+K";
```

On click, the button calls `openPalette()` -- the same function as the keyboard shortcut.

---

## 4. Modal Behavior

### 4.1 Opening

When the palette opens:

1. Render the backdrop and modal container.
2. Apply enter animation (see 4.3).
3. Set focus to the search input (`<Command.Input>`).
4. Announce the dialog to screen readers via `aria-label="Command palette"`.
5. Trap focus within the modal (Tab cycles through modal elements only).
6. If a previous query was entered before closing, clear it. The palette always opens with an empty search input.

### 4.2 Closing

The palette closes on any of the following events:

| Event | Behavior |
|---|---|
| Press `Escape` | Close the palette, return focus to the previously focused element. |
| Click backdrop | Close the palette, return focus to the previously focused element. |
| Select a result (Enter or click) | Execute the result action (navigate or run), then close the palette. |
| Press `Cmd+K` / `Ctrl+K` while open | Toggle: close the palette. |

On close:

1. Apply exit animation (see 4.3).
2. Remove the modal and backdrop from the DOM (or set hidden).
3. Restore focus to the element that was focused before the palette opened.

### 4.3 Animation

| Animation | Duration | Easing | Reduced Motion |
|---|---|---|---|
| Backdrop fade in | 200ms | ease-out | Instant (no fade) |
| Backdrop fade out | 150ms | ease-in | Instant |
| Modal enter | 200ms | ease-out | Instant (no scale/fade) |
| Modal exit | 150ms | ease-in | Instant |

**Modal enter animation (CSS):**

```css
@keyframes command-palette-enter {
  from {
    opacity: 0;
    transform: scale(0.96) translateY(-8px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}
```

**Modal exit animation (CSS):**

```css
@keyframes command-palette-exit {
  from {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
  to {
    opacity: 0;
    transform: scale(0.96) translateY(-8px);
  }
}
```

When `prefers-reduced-motion` is active, both animations are replaced with instant show/hide (no transition).

---

## 5. Search Input

### 5.1 Layout

| Property | Value |
|---|---|
| Position | Top of the modal, above the result list |
| Width | Full width of the modal |
| Height | 48px |
| Padding | `px-4 py-3` |
| Icon | `Search` (Lucide) at 16px, `text-muted-foreground`, positioned left |
| Font | `text-lg` (18px), `font-normal`, `--foreground` color |
| Placeholder | `"Search pages, instruments, trades..."` in `text-muted-foreground` |
| Background | Transparent (inherits modal `--popover` background) |
| Border | None on the input itself; a `1px solid --border` separator line below the input area |
| Focus ring | None (the modal itself is the visual focus context) |

### 5.2 Auto-Focus

The search input receives focus automatically when the palette opens. This is handled by cmdk's built-in `autoFocus` behavior on `<Command.Input>`.

### 5.3 Clear Button

| Condition | Behavior |
|---|---|
| Input is empty | Clear button is hidden |
| Input has text | Clear button appears: `X` icon (Lucide) at 16px, `text-muted-foreground`, positioned right, `hover:text-foreground` |
| Click clear button | Input value resets to empty string, input retains focus, results reset to initial state |

### 5.4 Debounce Strategy

| Result Source | Debounce | Rationale |
|---|---|---|
| Pages (static) | 0ms | Filtering a static array of 8 items is negligible cost. Instant feedback. |
| Instruments (static) | 0ms | Filtering a static array of up to 20 items is negligible cost. |
| Actions (static) | 0ms | Filtering a static array of 5 items is negligible cost. |
| Recent Trades (API) | 200ms | Prevents excessive API calls during rapid typing. |
| Playbooks (API) | 200ms | Same rationale as Recent Trades. |

**Implementation:** cmdk handles local filtering internally. For API-backed categories, use a `useDebouncedValue` hook (or equivalent) that delays the API query parameter by 200ms after the last keystroke.

---

## 6. Result Categories

Results display as vertically stacked groups, each with a category header and list of items. Groups with zero matching items are hidden entirely.

### 6.1 Pages

**Source:** Static array defined in `constants.ts`.

**Data:**

| Order | Icon (Lucide) | Label | Route | Keywords |
|---|---|---|---|---|
| 1 | `LayoutDashboard` | Dashboard | `/dashboard` | `home, overview` |
| 2 | `TrendingUp` | Trendlines | `/trendlines` | `detection, lines, charts` |
| 3 | `ArrowRightLeft` | Execution | `/execution` | `trade, order, signal` |
| 4 | `BookOpen` | Journal | `/journal` | `diary, notes, log` |
| 5 | `Target` | Playbooks | `/playbooks` | `strategy, rules, plan` |
| 6 | `BarChart3` | Analytics | `/analytics` | `performance, metrics, stats` |
| 7 | `MessageSquare` | AI Chat | `/chat` | `assistant, claude, ai` |
| 8 | `Settings` | Settings | `/settings` | `preferences, config, account` |

**Matching:** The query matches against both the `Label` and `Keywords` fields (case-insensitive substring). For example, typing "trade" matches both "Execution" (via keyword "trade") and any other items containing "trade."

**Max items:** 8 (all pages shown if they match).

**On select:** Navigate to the route via `router.push(route)` and close the palette.

**Item layout:** `[Icon 20px] [gap-3] [Label text-sm font-medium]`

### 6.2 Instruments

**Source:** Static list of user-configured instruments, loaded from the instruments store (Zustand) or fetched once on palette open. The list contains up to 20 instruments based on the user's subscription tier.

**Fields displayed per item:**

| Field | Position | Style |
|---|---|---|
| Symbol | Left | `text-sm font-semibold font-mono` (e.g., "NQ") |
| Full name | Left, after symbol | `text-sm text-muted-foreground` (e.g., "E-mini Nasdaq 100") |
| Current price | Right-aligned | `text-sm font-mono` (e.g., "21,450.25") |
| Daily change % | Right-aligned, after price | `text-xs font-mono`, colored: `text-profit` if positive, `text-loss` if negative (e.g., "+1.24%" or "-0.87%") |

**Price data:** Sourced from the instruments store, which is kept up to date via WebSocket or polling (defined in FSD-010). If price data is unavailable, the price and change fields are omitted and the item shows only symbol + name.

**Max items:** 8 (show first 8 matches).

**Matching:** Query matches against symbol and full name (case-insensitive substring).

**On select:** Navigate to `/trendlines?instrument={symbol}` and close the palette.

**Item layout:** `[TrendingUp icon 20px] [gap-3] [Symbol + Name] [flex-grow] [Price] [gap-2] [Change%]`

### 6.3 Recent Trades

**Source:** API call via TanStack Query.

**API endpoint:** `GET /api/v1/trades?limit=10&sort=-created_at`

This endpoint is proxied through the Next.js BFF layer. The actual FastAPI endpoint returns the 10 most recent trades for the authenticated user.

**Fields displayed per item:**

| Field | Position | Style |
|---|---|---|
| Instrument symbol | Left | `text-sm font-semibold font-mono` |
| Direction | Left, after symbol | `text-xs` -- "LONG" in `text-profit` or "SHORT" in `text-loss` |
| P&L | Right-aligned | `text-sm font-mono font-semibold`, colored: `text-profit` if positive, `text-loss` if negative, `text-muted-foreground` if zero (e.g., "+$1,240", "-$580", "$0") |
| Date | Right-aligned, after P&L | `text-xs text-muted-foreground` (e.g., "Feb 10") |

**Icon per item:** `ArrowUpRight` (Lucide) for LONG, `ArrowDownRight` (Lucide) for SHORT, sized at 20px. LONG icon colored `text-profit`, SHORT icon colored `text-loss`.

**Max items:** 10.

**Matching:** Query matches against instrument symbol (case-insensitive substring).

**On select:** Navigate to `/journal/{trade_id}` and close the palette.

**Zero trades state:** If the user has zero trades, the "Recent Trades" category is hidden entirely (not shown as an empty group).

**Loading state:** While the API call is in-flight, display 3 skeleton placeholder items (shimmer animation, matching the item height and layout). Skeleton is hidden if the query does not match any trade-related terms.

**Error state:** If the API call fails, the "Recent Trades" category is hidden silently. Static categories (Pages, Instruments, Actions) continue to display. If the error persists across multiple palette opens, a toast notification is shown (via the toast system defined in FSD-011a Section 3.7) with message: "Could not load recent trades."

### 6.4 Playbooks

**Source:** API call via TanStack Query.

**API endpoint:** `GET /api/v1/playbooks`

This endpoint is proxied through the Next.js BFF layer. Returns all playbooks for the authenticated user.

**Fields displayed per item:**

| Field | Position | Style |
|---|---|---|
| Playbook name | Left | `text-sm font-medium` |
| Trade count | Right-aligned | `text-xs text-muted-foreground font-mono` (e.g., "24 trades") |

**Icon per item:** `BookOpen` (Lucide) at 20px, `text-muted-foreground`.

**Max items:** All playbooks (up to 20 per subscription tier limits).

**Matching:** Query matches against playbook name (case-insensitive substring).

**On select:** Navigate to `/playbooks/{playbook_id}` and close the palette.

**Zero playbooks state:** If the user has zero playbooks, the "Playbooks" category is hidden entirely.

**Loading state:** 2 skeleton placeholder items while the API call is in-flight.

**Error state:** Same as Recent Trades -- hidden silently on failure.

### 6.5 Actions

**Source:** Static array defined in `constants.ts`.

**Data:**

| Order | Icon (Lucide) | Label | Behavior | Shortcut Hint |
|---|---|---|---|---|
| 1 | `Plus` | New Trade Entry | `router.push("/execution?action=new")` | `N` |
| 2 | `BookPlus` | New Playbook | `router.push("/playbooks?action=new")` | -- |
| 3 | `Sun` / `Moon` | Toggle Theme | Call `useUIStore.getState().toggleTheme()` | -- |
| 4 | `Settings` | Open Settings | `router.push("/settings")` | `G S` |
| 5 | `Keyboard` | View Keyboard Shortcuts | Open keyboard shortcuts help dialog (dispatch `openShortcutsDialog` from UI store) | `Cmd+/` |

**Icon for "Toggle Theme":** Display `Sun` icon when current theme is dark, `Moon` icon when current theme is light.

**Shortcut hints:** Displayed right-aligned in `kbd` elements with `text-xs text-muted-foreground bg-muted rounded px-1.5 py-0.5 font-mono`.

**Max items:** 5.

**Matching:** Query matches against label (case-insensitive substring). For example, "theme" matches "Toggle Theme."

**On select:** Execute the behavior and close the palette.

**Item layout:** `[Icon 20px] [gap-3] [Label text-sm font-medium] [flex-grow] [Shortcut hint kbd]`

---

## 7. Matching Algorithm

### 7.1 Algorithm

Case-insensitive substring match.

**Steps:**

1. Normalize the query to lowercase: `normalizedQuery = query.toLowerCase()`.
2. For each candidate item, normalize its searchable text to lowercase.
3. Check if the normalized searchable text contains the normalized query: `normalizedText.includes(normalizedQuery)`.
4. If yes, the item is a match. If no, the item is filtered out.

**Searchable text per category:**

| Category | Searchable Fields |
|---|---|
| Pages | Label + Keywords (concatenated with space) |
| Instruments | Symbol + Full Name (concatenated with space) |
| Recent Trades | Instrument Symbol |
| Playbooks | Playbook Name |
| Actions | Label |

### 7.2 Character Highlighting

When an item matches, the matched substring within the display label is rendered with visual emphasis.

**Rendering algorithm:**

1. Find the index of the query (case-insensitive) within the display text.
2. Split the display text into three parts: before-match, match, after-match.
3. Render: `<span>{before}</span><span class="font-semibold">{match}</span><span>{after}</span>`.

**Example:** Query = "dash", Label = "Dashboard"

- Before: "" (empty)
- Match: "Dash"
- After: "board"
- Render: `<span class="font-semibold">Dash</span><span>board</span>`

The match preserves the original case of the label text. Only the first occurrence is highlighted.

**Implementation (`highlight-match.tsx`):**

```typescript
interface HighlightMatchProps {
  text: string;
  query: string;
  className?: string;
}

function HighlightMatch({ text, query, className }: HighlightMatchProps) {
  if (!query) return <span className={className}>{text}</span>;

  const lowerText = text.toLowerCase();
  const lowerQuery = query.toLowerCase();
  const index = lowerText.indexOf(lowerQuery);

  if (index === -1) return <span className={className}>{text}</span>;

  const before = text.slice(0, index);
  const match = text.slice(index, index + query.length);
  const after = text.slice(index + query.length);

  return (
    <span className={className}>
      {before}
      <span className="font-semibold">{match}</span>
      {after}
    </span>
  );
}
```

---

## 8. Keyboard Navigation

### 8.1 Key Bindings

| Key | Action |
|---|---|
| `ArrowDown` | Move highlight to the next result item. Wraps from last item to first item. |
| `ArrowUp` | Move highlight to the previous result item. Wraps from first item to last item. |
| `Enter` | Select the currently highlighted result item (navigate or execute action). |
| `Escape` | Close the palette. Return focus to the previously focused element. |
| `Tab` | Move highlight to the next result item (same behavior as `ArrowDown`). Does NOT move focus out of the palette (focus is trapped). |
| `Shift+Tab` | Move highlight to the previous result item (same behavior as `ArrowUp`). |

### 8.2 Highlight Behavior

- When the palette opens with no query (initial state), the first item in the first visible category is highlighted.
- When the query changes and new results render, the first matching item is highlighted.
- Category headers are **not** highlightable. Arrow key navigation skips over category headers and moves directly between result items.
- The highlighted item scrolls into view automatically if it is outside the visible area of the scroll container.

### 8.3 ARIA Active Descendant

The result list uses `aria-activedescendant` to indicate the currently highlighted item to screen readers. Each `<CommandItem>` has a unique `id` attribute. When the highlight moves, the `<Command.List>` element's `aria-activedescendant` is updated to the `id` of the highlighted item.

cmdk manages this automatically.

### 8.4 Selection

When the user presses Enter or clicks a result item:

1. Execute the item's action (navigate to route, toggle theme, open dialog).
2. Close the palette.
3. Return focus to the previously focused element (unless navigation changed the page, in which case focus moves to the new page's main content).

---

## 9. State Management

### 9.1 Approach: Local Component State (Recommended)

The command palette uses **local component state** rather than a global Zustand store. The palette is a self-contained modal with no state that needs to be shared with other components.

**Exception:** The open/close state is exposed via a minimal Zustand slice in `useUIStore` so that the header button trigger and the keyboard shortcut can both control visibility.

```typescript
// In useUIStore (existing store from FSD-011a)
interface UIState {
  // ... existing fields ...
  commandPaletteOpen: boolean;
  openCommandPalette: () => void;
  closeCommandPalette: () => void;
  toggleCommandPalette: () => void;
}
```

All other state (query string, active index, loading flags) remains local to the `<CommandPalette>` component.

### 9.2 State Machine

| State | Condition | Display |
|---|---|---|
| **Initial** | Palette is open, query is empty | All Pages and Actions are displayed. Instruments are displayed (no price filtering). Recent Trades and Playbooks are NOT fetched (no API calls on empty query). |
| **Typing (results found)** | Query is non-empty, at least one category has matches | Filtered results across all categories. Static categories filter instantly. API categories show loading skeletons, then resolve with results. |
| **Typing (loading API)** | Query is non-empty, API requests are in-flight | Static categories display filtered results immediately. API-backed categories show skeleton placeholders (3 skeletons for Recent Trades, 2 for Playbooks). |
| **No results** | Query is non-empty, all categories have zero matches | Display: `"No results found for '{query}'"` in `text-sm text-muted-foreground`, centered vertically in the result area. |
| **API error** | One or more API calls fail | Failed API categories are hidden silently (omitted from results). Static categories continue to display. If ALL categories (including static) are empty, show the "No results" state. A toast notification is shown for persistent API errors (3+ consecutive failures). |

### 9.3 State Transitions

```
[Closed] ---(Cmd+K / button click)---> [Initial]
[Initial] ---(user types)---> [Typing (results found)] or [Typing (loading API)]
[Typing (loading API)] ---(API resolves)---> [Typing (results found)] or [No results]
[Typing (results found)] ---(query changes)---> [Typing (results found)] or [No results]
[Any open state] ---(Escape / backdrop / selection)---> [Closed]
```

### 9.4 API Data Fetching

**When to fetch:** API-backed categories (Recent Trades, Playbooks) are fetched:

- On initial palette open: **NO** (to keep open-to-render under 100ms).
- When the user starts typing (query length >= 1): **YES**, with 200ms debounce.
- On subsequent palette opens within a session: TanStack Query cache is used. Default `staleTime` is 30 seconds, so repeated opens within 30 seconds do not trigger new API calls.

**TanStack Query configuration:**

```typescript
// Recent Trades
useQuery({
  queryKey: ["command-palette", "trades", debouncedQuery],
  queryFn: () => fetchRecentTrades(debouncedQuery),
  enabled: debouncedQuery.length > 0,
  staleTime: 30_000,
  gcTime: 60_000,
});

// Playbooks
useQuery({
  queryKey: ["command-palette", "playbooks"],
  queryFn: () => fetchPlaybooks(),
  enabled: debouncedQuery.length > 0,
  staleTime: 30_000,
  gcTime: 60_000,
});
```

Playbooks are fetched once (not filtered server-side); client-side filtering is applied to the cached result.

---

## 10. UI Specifications

### 10.1 Modal Dimensions

| Property | Desktop | Mobile (< 768px) |
|---|---|---|
| Width | `560px` (fixed) | `calc(100vw - 32px)` (full width minus 16px margin each side) |
| Max height | `480px` | `60vh` |
| Position | Centered horizontally and vertically | Centered horizontally, positioned 20% from top |
| Border radius | `rounded-lg` (8px) | `rounded-lg` (8px) |
| Shadow | `shadow-2xl` | `shadow-2xl` |
| z-index | `z-50` (consistent with other modals) | `z-50` |

### 10.2 Backdrop

| Property | Value |
|---|---|
| Background | `bg-black/50` (black at 50% opacity) |
| z-index | `z-50` (same layer as modal, rendered behind it) |
| Behavior | Click closes the palette |
| Animation | Fade in 200ms / fade out 150ms |

### 10.3 Modal Background

| Property | Value |
|---|---|
| Background color | `bg-popover` (`--popover` token: `#0E1424` dark, `#FAFAFA` light) |
| Border | `border border-border` (1px, `--border` token) |
| Overflow | Hidden on the modal container; scroll on the result list |

### 10.4 Search Input Area

| Property | Value |
|---|---|
| Height | `48px` |
| Padding | `px-4` |
| Border bottom | `1px solid` `--border` |
| Icon | `Search` (Lucide), 16px, `text-muted-foreground`, left-aligned |
| Input | `text-lg`, `font-normal`, `text-foreground`, no border, no outline, transparent background |
| Clear button | `X` (Lucide), 16px, `text-muted-foreground`, `hover:text-foreground`, right-aligned, hidden when input is empty |
| Gap between icon and input | `gap-3` (12px) |

### 10.5 Result List

| Property | Value |
|---|---|
| Max height | Modal max-height minus input height: `432px` desktop, `calc(60vh - 48px)` mobile |
| Overflow | `overflow-y: auto` (vertical scroll) |
| Padding | `py-2` (8px top and bottom) |
| Scrollbar | Styled thin scrollbar: `scrollbar-thin scrollbar-thumb-muted scrollbar-track-transparent` |

### 10.6 Category Headers

| Property | Value |
|---|---|
| Text | Category name in UPPERCASE (e.g., "PAGES", "INSTRUMENTS") |
| Font | `text-xs`, `font-medium`, `text-muted-foreground` |
| Padding | `px-4 py-2` |
| Sticky | `position: sticky; top: 0; background: --popover; z-index: 1` (stays visible while scrolling within the category) |
| Not selectable | Category headers are skipped during keyboard navigation |

### 10.7 Result Items

| Property | Value |
|---|---|
| Height | `40px` (minimum, auto-expands for wrapped content) |
| Padding | `px-4 py-2` |
| Layout | `flex items-center gap-3` |
| Icon | 20px, `text-muted-foreground` (or colored per category -- see Section 6) |
| Label | `text-sm`, `text-foreground` |
| Metadata | Right-aligned, `text-sm` or `text-xs` depending on field (see Section 6) |
| Cursor | `cursor-default` (keyboard-driven; no pointer cursor needed) |

**Highlighted (active) item:**

| Property | Value |
|---|---|
| Background | `bg-muted` (`--muted` token) |
| Border radius | `rounded-md` (6px) within the item's `mx-2` (2px horizontal margin from the list edge) |
| Transition | `transition-colors duration-75` (fast highlight movement) |

**Hover state:** Same as highlighted state (`bg-muted`). Hovering an item also moves the keyboard highlight to that item.

### 10.8 Empty State

| Property | Value |
|---|---|
| Text | `"No results found for '{query}'"` |
| Font | `text-sm`, `text-muted-foreground` |
| Layout | Centered horizontally and vertically within the result list area |
| Padding | `py-12` (48px vertical padding for visual centering) |

### 10.9 Loading Skeletons

| Property | Value |
|---|---|
| Height per skeleton | `40px` (matches result item height) |
| Layout | `flex items-center gap-3 px-4 py-2` |
| Icon placeholder | `w-5 h-5 rounded bg-muted` |
| Text placeholder | `h-4 rounded bg-muted`, widths vary: 120px, 160px, 100px for visual variety |
| Animation | Shimmer (left-to-right gradient sweep, 1.5s cycle, `linear`, infinite). Disabled when `prefers-reduced-motion` is active (static gray). |
| Count | 3 skeletons for Recent Trades, 2 skeletons for Playbooks |

---

## 11. Accessibility

### 11.1 ARIA Roles

| Element | Role / Attribute |
|---|---|
| Modal container | `role="dialog"`, `aria-modal="true"`, `aria-label="Command palette"` |
| Search input | `role="combobox"`, `aria-expanded="true"`, `aria-controls="{listbox-id}"`, `aria-autocomplete="list"` |
| Result list | `role="listbox"`, `id="{listbox-id}"`, `aria-label="Search results"` |
| Category header | `role="presentation"` (not a selectable item) |
| Result item | `role="option"`, `id="{unique-item-id}"`, `aria-selected="{true/false}"` |

### 11.2 Focus Management

| Behavior | Implementation |
|---|---|
| Focus on open | Search input receives focus immediately on palette open |
| Focus trap | Focus is trapped within the modal. Tab and Shift+Tab cycle between the search input and result items (via `aria-activedescendant` -- physical focus stays on the input, virtual focus moves through the list) |
| Focus on close | Focus returns to the element that was focused before the palette opened. Stored via `document.activeElement` before opening. |

### 11.3 Screen Reader Announcements

| Event | Announcement | Method |
|---|---|---|
| Palette opens | "Command palette" (dialog label) | `aria-label` on dialog |
| Results update | "{n} results available" | `aria-live="polite"` region, updated on each filter change |
| Highlight moves | Active item text announced | `aria-activedescendant` pointing to the highlighted `role="option"` element |
| No results | "No results found for '{query}'" | `aria-live="polite"` region |
| Palette closes | Focus returns to previous element, no explicit announcement | Native focus management |

### 11.4 Reduced Motion

When `prefers-reduced-motion: reduce` is active:

- Modal enter/exit animations are disabled (instant show/hide).
- Backdrop fade is disabled (instant show/hide).
- Loading skeleton shimmer is disabled (static gray blocks).
- Highlight transition (`transition-colors`) is disabled (instant color change).

Detection via CSS media query: `@media (prefers-reduced-motion: reduce)`.

---

## 12. Performance

### 12.1 Targets

| Metric | Target | Measurement Method |
|---|---|---|
| Open-to-render | < 100ms | From `Cmd+K` keypress to first paint of modal with static results (Pages, Actions). Measured via `performance.mark()` / `performance.measure()`. |
| Local filtering | < 16ms per keystroke | Filtering static arrays (Pages, Instruments, Actions) completes within one animation frame. No frame drops during typing. Measured via Chrome DevTools Performance panel. |
| API results total | < 300ms | From last keystroke to rendered API results. Breakdown: 200ms debounce + ~50ms API round trip (BFF proxy) + ~50ms render. Measured via TanStack Query `onSuccess` timestamp minus keystroke timestamp. |
| Bundle size | < 15KB gzip | `cmdk` (~3.5KB) + command palette components (~8-10KB) + highlight utility (~0.5KB). Measured via `next build` bundle analysis. |

### 12.2 Optimization Techniques

| Technique | Applied To |
|---|---|
| **Lazy loading** | The command palette component is imported via `next/dynamic` with `ssr: false`. It is not included in the initial page bundle. Loaded on first `Cmd+K` press or header button click. |
| **Static data precomputation** | Pages and Actions arrays are defined as module-level constants, not computed on each render. |
| **Virtualization** | Not required. Maximum result count across all categories is ~51 items (8 pages + 8 instruments + 10 trades + 20 playbooks + 5 actions). This is within comfortable DOM rendering limits. |
| **Memoization** | `useMemo` for filtered static results. `React.memo` on `CommandItem` to prevent re-renders of unchanged items. |
| **Debounced API calls** | 200ms debounce on query changes for API-backed categories, preventing request storms during rapid typing. |
| **TanStack Query caching** | 30-second stale time prevents redundant API calls on repeated palette opens. |

---

## 13. Mobile Behavior

### 13.1 Viewport Threshold

Mobile behavior activates at viewports below `768px` width (matching the `md` breakpoint from FSD-011a Section 6.1).

### 13.2 Header Trigger Button

On mobile viewports (< 768px), the command palette trigger button in the header is **hidden**. This saves horizontal space in the header. The palette is still accessible via:

- `Cmd+K` / `Ctrl+K` if a hardware keyboard is connected (e.g., iPad with keyboard, laptop in responsive testing).
- The palette is not accessible via touch-only on mobile. This is intentional -- the command palette is a power-user feature designed for keyboard-driven workflows. Mobile navigation uses the bottom tab bar and sidebar drawer (FSD-011a Section 6.2).

### 13.3 Modal Layout on Mobile

| Property | Mobile Value |
|---|---|
| Width | `calc(100vw - 32px)` (16px margin on each side) |
| Max height | `60vh` |
| Position | Centered horizontally, 20% from top of viewport |
| Result list max height | `calc(60vh - 48px)` |
| All other properties | Same as desktop |

### 13.4 Touch Interaction

- Result items respond to tap (same as click on desktop).
- Scroll is native touch scroll within the result list.
- No swipe gestures are defined for the palette.

---

## 14. Edge Cases

### 14.1 Empty Search Results

When the query matches zero items across all categories, display the empty state (Section 10.8). The search input remains focused and editable. The user can refine their query or press Escape to close.

### 14.2 Very Long Result Labels

If a result label exceeds the available width (after accounting for icon, gap, and right-aligned metadata), the label is truncated with `text-ellipsis overflow-hidden whitespace-nowrap`. Truncated text is accessible via a `title` attribute on the label element.

Maximum label width: approximately 300px on desktop (560px modal - 16px left padding - 20px icon - 12px gap - 16px right padding - remaining space for metadata).

### 14.3 API Timeout

If an API request (Recent Trades or Playbooks) takes longer than 5 seconds:

1. TanStack Query cancels the request.
2. The loading skeleton for that category is removed.
3. The category is hidden (same as API error behavior).
4. A warning is logged to the browser console: `"Command palette: trades API timed out after 5000ms"`.

No toast is shown for a single timeout. Toasts are reserved for persistent failures (3+ consecutive).

### 14.4 Simultaneous Open/Close

If `Cmd+K` is pressed rapidly (toggling the palette open and closed in quick succession):

- The palette state toggles on each keypress.
- Animations are interrupted and the palette snaps to the target state.
- Any in-flight API requests from a previous open are cancelled via TanStack Query's `AbortController`.

### 14.5 Rapid Typing

During rapid typing (e.g., 10+ characters per second):

- Static filtering runs on every keystroke (< 16ms, no perceptible lag).
- API calls are debounced at 200ms, so only the final query (after the user pauses) triggers an API call.
- Previously in-flight API calls are cancelled when a new debounced query fires.

### 14.6 Navigation While Loading

If the user selects a static result (Page or Action) while an API request is in-flight:

1. The palette closes.
2. Navigation or action executes.
3. The in-flight API request is cancelled (query invalidated by palette close).

### 14.7 Palette Open During Route Change

If a route change occurs while the palette is open (e.g., from a browser back/forward button):

1. The palette closes automatically.
2. The `useUIStore.closeCommandPalette()` is called from a `usePathname()` effect that watches for route changes.

### 14.8 Palette and Other Modals

If another modal is open (e.g., keyboard shortcuts dialog, trade form), pressing `Cmd+K`:

- Does NOT open the command palette. The existing modal takes precedence.
- The keyboard shortcut is consumed by the existing modal's Escape handler or has no effect.

Implementation: The `handleKeyDown` listener checks `useUIStore.getState().hasOpenModal` before opening the palette. `hasOpenModal` is set to `true` by any modal component on open and cleared on close.

---

## 15. Testing

### 15.1 Unit Tests

**File:** `frontend/__tests__/components/command-palette/command-palette.test.tsx`

| Test | Input | Expected Outcome |
|---|---|---|
| Renders without crashing | Mount `<CommandPalette open={true} />` | Component renders, search input is present |
| Shows Pages and Actions on initial open | Open palette with empty query | Pages category (8 items) and Actions category (5 items) visible |
| Filters pages by label | Type "dash" | "Dashboard" visible, other non-matching pages hidden |
| Filters pages by keyword | Type "trade" | "Execution" visible (keyword: "trade") |
| Highlights matched characters | Type "trend" in palette | "Trendlines" label renders "Trend" in `font-semibold` and "lines" in normal weight |
| Hides empty categories | Type "xyznonexistent" | All categories hidden, "No results found" message displayed |
| Shows clear button when input has text | Type any character | Clear button (X) appears |
| Clears input on clear button click | Type "test", click clear | Input becomes empty, results reset to initial state |
| Toggles theme action | Select "Toggle Theme" | `useUIStore.toggleTheme` called |
| Handles API error gracefully | Mock API 500 response for trades | Recent Trades category hidden, static categories still visible |

### 15.2 E2E Tests (Playwright)

**File:** `frontend/e2e/command-palette.spec.ts`

Reference: CS-TEST-020, CS-TEST-021 from PRD-012.

| Test | Steps | Expected Outcome |
|---|---|---|
| Open via Cmd+K (macOS) | Press `Meta+k` | Palette modal visible, search input focused |
| Open via Ctrl+K | Press `Control+k` | Palette modal visible, search input focused |
| Open via header button | Click header search button | Palette modal visible, search input focused |
| Suppressed in text input | Focus a text input on the page, press `Meta+k` | Palette does NOT open |
| Close via Escape | Open palette, press `Escape` | Palette hidden |
| Close via backdrop click | Open palette, click outside modal | Palette hidden |
| Navigate to page | Open palette, type "dash", press `Enter` | URL changes to `/dashboard` |
| Filter across categories | Type "journal" | Only matching results displayed (Journal page, matching trades if any) |
| No results message | Type "xyznonexistent" | Text "No results found for 'xyznonexistent'" visible |
| Arrow key navigation | Open palette, press `ArrowDown` 3 times, press `Enter` | Third result item's action executed |
| Toggle theme action | Open palette, type "theme", press `Enter` | Theme class on `<html>` changes |
| Mobile viewport | Set viewport to 375px width, open palette via keyboard | Palette renders at full width minus margins, max-height 60vh |
| Mobile trigger hidden | Set viewport to 375px width | Header search button not visible |

### 15.3 Accessibility Tests

**File:** `frontend/__tests__/components/command-palette/command-palette.a11y.test.tsx`

Reference: CS-TEST-021 from PRD-012.

| Test | Method | Expected Outcome |
|---|---|---|
| axe-core scan (palette open) | Render open palette, run `axe.run()` | Zero critical and serious violations |
| Dialog role | Inspect rendered DOM | Modal container has `role="dialog"` and `aria-modal="true"` |
| Listbox semantics | Inspect rendered DOM | Result list has `role="listbox"`, items have `role="option"` |
| Focus trap | Open palette, press Tab repeatedly | Focus cycles within palette, never escapes to background |
| aria-activedescendant | Open palette, press `ArrowDown` | `aria-activedescendant` on input updates to the highlighted item's `id` |
| Screen reader result count | Type a query with 3 matching results | `aria-live` region announces "3 results available" |
| Reduced motion | Set `prefers-reduced-motion: reduce`, open palette | No animations, instant show/hide |

---

*This document is FSD-012c of the TrendEdge platform. It specifies the command palette component in full implementation detail, expanding on FSD-011a Sections 3.5.1 through 3.5.8 and satisfying CS-FR-030 through CS-FR-036 from PRD-012.*
