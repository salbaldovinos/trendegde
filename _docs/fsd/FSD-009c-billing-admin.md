# FSD-009c: Billing Admin & Revenue

**TrendEdge -- AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-009c |
| Source FSD | FSD-009 (Billing & Subscriptions) |
| Title | Billing Admin & Revenue |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-11 |

---

## 1. Introduction

### 1.1 Purpose

This sub-FSD specifies all admin-facing billing operations and user-facing invoice access for TrendEdge: the revenue analytics dashboard, refund processing, coupon and promotion code management, invoice and receipt access, and AI cost tracking. It provides all behavioral detail necessary for implementation.

### 1.2 Scope

- **Invoice Access**: User-facing invoice listing, PDF downloads, receipt emails.
- **Refund Processing**: Admin-only refund workflow with Stripe integration, validation, and audit logging.
- **Coupon & Promotion Codes**: System-generated and admin-created discount codes, redemption tracking, admin management panel.
- **Revenue Analytics Dashboard**: Admin-only metrics dashboard with MRR/ARR, subscription counts, churn analysis, trial funnels, payment stats, AI cost tracking, and pre-computed metrics.
- **AI Cost Tracking**: Per-user Claude API usage metering, fair-use soft caps, and cost reporting for admin.
- **Cancellation Analytics**: Cancellation reason tracking and retention offer effectiveness.
- **Billing Audit Trail**: Comprehensive logging of all billing-related admin and system actions.

### 1.3 Out of Scope

- Stripe product/price configuration and checkout session creation [see FSD-009a]
- Subscription lifecycle (upgrade, downgrade, cancel, pause, reactivate) [see FSD-009a]
- Feature gating engine and usage tracking enforcement [see FSD-009b]
- Webhook receiver and event processing [see FSD-009a]
- Dunning management and failed payment handling [see FSD-009a]
- Payment method management [see FSD-009a]

### 1.4 Glossary

| Term | Definition |
|---|---|
| MRR | Monthly Recurring Revenue. Sum of all active subscription monthly-equivalent fees. Annual subscriptions divided by 12. |
| ARR | Annual Recurring Revenue. MRR multiplied by 12. |
| Churn Rate | Percentage of subscribers who cancel in a given month, relative to total subscribers at the start of that month. |
| ARPU | Average Revenue Per User. Total monthly revenue divided by total active paid subscribers. |
| LTV | Lifetime Value. Total revenue expected from a customer over their entire relationship with TrendEdge. |
| Expansion MRR | MRR gained from upgrades within existing subscribers. |
| Contraction MRR | MRR lost from downgrades within existing subscribers. |
| Churned MRR | MRR lost from cancelled subscriptions. |
| Net New MRR | New MRR + Expansion MRR - Contraction MRR - Churned MRR. |

---

## 2. Functional Specifications

### 2.1 BL-FR-021: Invoice Access

**Source**: PRD-009 Section 3.5, BL-FR-021

**Description**: Users can view and download their billing history, invoices, and receipts. Invoices are synced from Stripe via webhooks and stored locally for fast access.

**API Endpoint**: `GET /api/billing/invoices`

**Authentication**: Required. User must be authenticated. [Cross-reference: FSD-008 for auth]

#### 2.1.1 Invoice Storage

**`invoices` Table Schema**:

```sql
CREATE TABLE invoices (
    id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    stripe_invoice_id VARCHAR(255) UNIQUE NOT NULL,
    amount_paid INTEGER NOT NULL,
    currency VARCHAR(3) NOT NULL DEFAULT 'usd',
    status VARCHAR(20) NOT NULL,
    invoice_pdf_url TEXT,
    period_start TIMESTAMPTZ NOT NULL,
    period_end TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_invoices_user_id ON invoices(user_id);
CREATE INDEX idx_invoices_created_at ON invoices(created_at);
```

**Column Notes**:
- `amount_paid`: stored in cents (e.g., 9900 = $99.00).
- `status`: one of `paid`, `open`, `void`, `uncollectible`, `refunded`.
- `invoice_pdf_url`: Stripe-hosted PDF URL, populated from the `invoice.finalized` webhook.

#### 2.1.2 Invoice Sync from Stripe

Invoices are populated via two webhook events [Cross-reference: FSD-009a for webhook processing]:

1. **`invoice.finalized`**: Creates or updates the invoice record with `stripe_invoice_id`, `amount_paid`, `period_start`, `period_end`, and `invoice_pdf_url`.
2. **`invoice.payment_succeeded`**: Updates the invoice `status` to `paid`. Triggers the `invoice_receipt` email to the user.

#### 2.1.3 API Response

**Processing Logic**:
1. Query the `invoices` table for the authenticated user, ordered by `created_at` descending.
2. Return paginated results.

**Response (200 OK)**:
```json
{
  "invoices": [
    {
      "id": "inv_xxx",
      "date": "2026-03-01",
      "description": "TrendEdge Pro - Monthly",
      "amount": "$99.00",
      "amount_cents": 9900,
      "status": "paid",
      "pdf_url": "https://pay.stripe.com/invoice/xxx/pdf",
      "period": "Mar 1 - Mar 31, 2026"
    }
  ],
  "total_count": 12
}
```

**Business Rules**:
- Users can only access their own invoices. The `user_id` is extracted from the JWT, not from request parameters.
- The `pdf_url` links to Stripe-hosted PDFs. These URLs are long-lived but may expire after 30 days. If a user requests a PDF for an old invoice, the system fetches a fresh URL from Stripe via `stripe.Invoice.retrieve()`.
- Invoices with `status = 'void'` are included in the listing but marked visually as voided.

**Error Handling**:

| Condition | HTTP Status | Response |
|---|---|---|
| User not authenticated | 401 | `{"error": "authentication_required", "message": "You must be logged in to view invoices."}` |
| No invoices found | 200 | `{"invoices": [], "total_count": 0}` (empty list, not an error) |
| Stripe PDF URL expired | 200 | Return invoice without `pdf_url`. Frontend shows "PDF temporarily unavailable" with a "Refresh" button that calls Stripe to get a fresh URL. |

---

### 2.2 BL-FR-026: Refund Processing

**Source**: PRD-009 Section 3.10, BL-FR-026

**Description**: Admin-only refund processing through the admin interface. All refunds require admin approval and are processed via Stripe.

#### 2.2.1 Refund Policy

- Full refund within 7 days of initial subscription purchase (no questions asked).
- Pro-rated refund at admin discretion for annual subscribers within 30 days.
- No automatic refunds; all require admin approval.
- Refunds for current billing period only; past periods not refundable.

#### 2.2.2 Admin Refund Flow

**API Endpoint**: `POST /api/admin/billing/refund`

**Authentication**: Required. Must have `admin` role. [Cross-reference: FSD-008 for RBAC]

**Request Body**:
```json
{
  "user_id": "uuid",
  "stripe_invoice_id": "inv_xxx",
  "amount_cents": 9900,
  "refund_type": "full",
  "reason": "Customer requested refund within 7-day window"
}
```

| Field | Type | Required | Validation |
|---|---|---|---|
| `user_id` | UUID | Yes | Must be a valid user |
| `stripe_invoice_id` | string | Yes | Must match an invoice for the user |
| `amount_cents` | integer | Yes (for partial) | Must be > 0 and <= invoice `amount_paid` |
| `refund_type` | string | Yes | `"full"` or `"partial"` |
| `reason` | string | Yes | Minimum 10 characters |

**Processing Logic**:

1. Authenticate the admin user. Verify `admin` role.
2. Look up the invoice by `stripe_invoice_id` and verify it belongs to the specified `user_id`.
3. Verify the invoice `status` is `paid` (cannot refund void, open, or already-refunded invoices).
4. If `refund_type` is `"full"`: set `amount_cents` to the invoice's `amount_paid`.
5. If `refund_type` is `"partial"`: validate that `amount_cents <= invoice.amount_paid`.
6. Validate the `reason` field is at least 10 characters.
7. Call Stripe API: `stripe.Refund.create(charge=charge_id, amount=amount_cents)`.
   - The `charge_id` is retrieved from the Stripe invoice object (`invoice.charge`).
8. On Stripe success:
   a. Create a record in the `refunds` table.
   b. Update the local invoice `status` to `"refunded"`.
   c. Send `refund_issued` email to the user: "You've been issued a refund of ${amount}. It may take 5-10 business days to appear on your statement."
   d. Log to billing audit trail: `action = "refund_issued"`, `actor_id = admin_user_id`, details include invoice ID, amount, reason.
9. Return success response.

**Response (200 OK)**:
```json
{
  "refund_id": "re_xxx",
  "stripe_refund_id": "re_xxx",
  "amount": "$99.00",
  "amount_cents": 9900,
  "status": "succeeded",
  "message": "Refund processed successfully. User will be notified via email."
}
```

**Business Rules**:
- Refund does NOT automatically cancel the subscription. The admin must separately cancel if needed. This is intentional -- a refund may be issued as a goodwill gesture while keeping the subscription active.
- Partial refunds are supported. The refund amount can be any value between $0.01 and the invoice total.
- Only one refund per invoice. If an invoice has already been refunded (fully or partially), subsequent refund attempts are rejected.
- The admin who processed the refund is recorded in the `processed_by` field for accountability.

#### 2.2.3 Refunds Table

```sql
CREATE TABLE refunds (
    id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    stripe_refund_id VARCHAR(255) UNIQUE NOT NULL,
    stripe_invoice_id VARCHAR(255) NOT NULL,
    amount INTEGER NOT NULL,
    reason TEXT NOT NULL,
    processed_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_refunds_user_id ON refunds(user_id);
CREATE INDEX idx_refunds_stripe_invoice_id ON refunds(stripe_invoice_id);
CREATE INDEX idx_refunds_processed_by ON refunds(processed_by);
```

**Column Notes**:
- `amount`: refund amount in cents.
- `processed_by`: the admin user's ID who approved the refund.

#### 2.2.4 Error Handling

| Condition | HTTP Status | Response |
|---|---|---|
| Non-admin user attempts refund | 403 | `{"error": "forbidden"}` |
| Invoice not found | 404 | `{"error": "invoice_not_found", "message": "Invoice not found for the specified user."}` |
| Invoice not in `paid` status | 400 | `{"error": "invalid_invoice_status", "message": "Only paid invoices can be refunded. Current status: {status}"}` |
| Refund amount exceeds invoice amount | 400 | `{"error": "amount_exceeds_invoice", "message": "Refund amount cannot exceed the original invoice amount of ${invoice_amount}."}` |
| Invoice already refunded | 409 | `{"error": "already_refunded", "message": "This invoice has already been refunded."}` |
| Reason too short | 400 | `{"error": "reason_required", "message": "Please provide a refund reason (minimum 10 characters)."}` |
| Stripe refund API fails | 502 | `{"error": "stripe_error", "message": "Refund could not be processed by our payment provider. Please try again."}` |

#### 2.2.5 Admin User Billing Detail View

**API Endpoint**: `GET /api/admin/billing/user/{user_id}`

**Authentication**: Admin role required.

**Response (200 OK)**:
```json
{
  "user_id": "uuid",
  "email": "user@example.com",
  "subscription": {
    "tier": "pro",
    "status": "active",
    "billing_interval": "monthly",
    "current_period_end": "2026-04-01T00:00:00Z",
    "payment_status": "current",
    "stripe_customer_id": "cus_xxx",
    "stripe_subscription_id": "sub_xxx"
  },
  "invoices": [
    {
      "id": "inv_xxx",
      "date": "2026-03-01",
      "amount_cents": 9900,
      "status": "paid",
      "pdf_url": "https://pay.stripe.com/invoice/xxx/pdf"
    }
  ],
  "refunds": [
    {
      "id": "re_xxx",
      "amount_cents": 9900,
      "reason": "Goodwill refund",
      "processed_by_email": "admin@trendedge.com",
      "created_at": "2026-03-15T10:00:00Z"
    }
  ],
  "usage": {
    "journal_entries": {"used": 42, "limit": null},
    "ai_invocations": {"used": 67, "limit": 100}
  }
}
```

---

### 2.3 BL-FR-024: Coupon & Promotion Code Support

**Source**: PRD-009 Section 3.8, BL-FR-024

**Description**: The system supports Stripe coupons and promotion codes for discounts during checkout and post-checkout. Coupons are managed via the admin dashboard and Stripe Dashboard.

#### 2.3.1 Coupon Types

| Type | Example | Stripe Configuration |
|---|---|---|
| Percentage off (duration) | 25% off for 3 months | `percent_off: 25`, `duration: "repeating"`, `duration_in_months: 3` |
| Fixed amount off (once) | $20 off first month | `amount_off: 2000`, `currency: "usd"`, `duration: "once"` |
| Percentage off (forever) | 15% off forever | `percent_off: 15`, `duration: "forever"` |

#### 2.3.2 System-Generated Coupons

These coupons are created during the Stripe setup phase (seed script) and used by the application programmatically:

| Coupon ID | Discount | Duration | Usage |
|---|---|---|---|
| `retention_25pct_3mo` | 25% off | 3 months (repeating) | Applied during cancellation retention flow when user selects "too expensive" [Cross-reference: FSD-009a BL-FR-008] |
| `annual_switch_10pct` | 10% off first year | Once | Incentivizes monthly-to-annual billing interval switch |
| `referral_1mo_free` | 100% off | Once (1 month) | Reserved for future referral program |

**Retention Coupon Calculations** (25% off for 3 months):
- Trader: $49 * 0.75 = $36.75/mo for 3 months
- Pro: $99 * 0.75 = $74.25/mo for 3 months
- Team: $199 * 0.75 = $149.25/mo for 3 months

**Business Rules**:
- The `retention_25pct_3mo` coupon can only be applied once per user. If a user has previously received this retention discount and attempts to cancel again, the "too expensive" offer is shown but with a note: "This discount can only be applied once per account." The user can only proceed to cancel or choose a different option.
- System-generated coupons are created by the seed script and must not be created dynamically at runtime.

#### 2.3.3 Promotion Codes

Promotion codes are human-readable strings (e.g., `LAUNCH25`, `TRADERLIFE`) that map to underlying Stripe coupons.

**Features**:
- Applied during Stripe Checkout via `allow_promotion_codes: true` on the Checkout Session [Cross-reference: FSD-009a BL-FR-002].
- Can also be applied post-checkout via the Stripe Customer Portal.
- Configurable restrictions per code:
  - Minimum tier requirement
  - Maximum total redemptions
  - Expiration date
  - First-time customers only flag

#### 2.3.4 Admin Promotions Management

**Location**: `/admin/promotions`

**API Endpoints**:

##### `GET /api/admin/promotions`

**Authentication**: Admin role required.

**Response (200 OK)**:
```json
{
  "promotions": [
    {
      "id": "promo_xxx",
      "code": "LAUNCH25",
      "coupon": {
        "id": "coupon_xxx",
        "percent_off": 25,
        "amount_off": null,
        "duration": "repeating",
        "duration_in_months": 3
      },
      "active": true,
      "times_redeemed": 42,
      "max_redemptions": 100,
      "expires_at": "2026-06-30T23:59:59Z",
      "first_time_only": true,
      "created_at": "2026-02-15T00:00:00Z"
    }
  ],
  "total_count": 5
}
```

##### `POST /api/admin/promotions`

**Authentication**: Admin role required.

**Request Body**:
```json
{
  "code": "SUMMER2026",
  "coupon_type": "percent_off",
  "discount_value": 20,
  "duration": "repeating",
  "duration_in_months": 2,
  "max_redemptions": 500,
  "expires_at": "2026-09-01T00:00:00Z",
  "first_time_only": false
}
```

| Field | Type | Required | Validation |
|---|---|---|---|
| `code` | string | Yes | 3-30 characters, alphanumeric + hyphens, uppercase |
| `coupon_type` | string | Yes | `"percent_off"` or `"amount_off"` |
| `discount_value` | number | Yes | For percent_off: 1-100. For amount_off: 1-100000 (cents). |
| `duration` | string | Yes | `"once"`, `"repeating"`, `"forever"` |
| `duration_in_months` | integer | Conditional | Required if duration is `"repeating"`. Range: 1-24. |
| `max_redemptions` | integer | No | If provided, must be >= 1. Null = unlimited. |
| `expires_at` | ISO 8601 | No | Must be in the future if provided. |
| `first_time_only` | boolean | No | Default: false |

**Processing Logic**:

1. Validate all input fields.
2. Create a Stripe Coupon via `stripe.Coupon.create()`.
3. Create a Stripe Promotion Code via `stripe.PromotionCode.create()` linked to the coupon.
4. Log to audit trail: `action = "promotion_created"`, `actor_id = admin_user_id`.
5. Return the created promotion code details.

**Response (201 Created)**:
```json
{
  "id": "promo_xxx",
  "code": "SUMMER2026",
  "coupon_id": "coupon_xxx",
  "active": true,
  "message": "Promotion code SUMMER2026 created successfully."
}
```

##### `PATCH /api/admin/promotions/{id}`

**Authentication**: Admin role required.

Supports updating: `active` (deactivate a code), `max_redemptions`, `expires_at`.

**Request Body** (all fields optional):
```json
{
  "active": false
}
```

**Processing Logic**:
1. Look up the promotion code in Stripe.
2. Update via `stripe.PromotionCode.modify()`.
3. Log to audit trail: `action = "promotion_updated"`.

**Response (200 OK)**:
```json
{
  "id": "promo_xxx",
  "code": "SUMMER2026",
  "active": false,
  "message": "Promotion code updated."
}
```

##### Redemption History

Each promotion code's detail view (accessed via the admin panel) shows:
- Total redemptions vs. maximum
- List of users who redeemed the code (user email, date, subscription tier at time of redemption)
- Total discount amount given

**Error Handling**:

| Condition | HTTP Status | Response |
|---|---|---|
| Non-admin user | 403 | `{"error": "forbidden"}` |
| Code already exists | 409 | `{"error": "code_exists", "message": "Promotion code 'SUMMER2026' already exists."}` |
| Invalid discount value | 400 | `{"error": "invalid_discount", "message": "Percentage discount must be between 1 and 100."}` |
| Stripe API error | 502 | `{"error": "stripe_error", "message": "Could not create promotion code. Please try again."}` |

---

### 2.4 BL-FR-025: Revenue Analytics Dashboard

**Source**: PRD-009 Section 3.9, BL-FR-025

**Description**: Admin-only dashboard at `/admin/revenue` displaying key revenue, subscription, churn, and cost metrics.

**Access Control**: Requires `admin` role. [Cross-reference: FSD-008 for RBAC] Non-admin users receive `403 Forbidden`.

#### 2.4.1 Metrics Categories

| Category | Specific Metrics |
|---|---|
| **Revenue** | MRR, ARR, total revenue (MTD, QTD, YTD), revenue by tier, revenue by billing interval |
| **Subscriptions** | Total active, count by tier, new this period, churned this period |
| **Churn** | Monthly churn rate (%), churn by tier, churn by cancellation reason, net revenue churn |
| **Growth** | Net new MRR, expansion MRR (upgrades), contraction MRR (downgrades), churned MRR |
| **Trials** | Active trials, trial-to-paid conversion rate, trial cancellation rate |
| **Payments** | Successful count/$, failed count/$, recovery rate, ARPU |
| **AI Costs** | Total Claude API costs, cost per user, cost by feature, margin impact |
| **Coupons** | Active promotions, total discount given, redemption counts |

#### 2.4.2 Metric Calculations

**MRR (Monthly Recurring Revenue)**:
- Sum of all active subscriptions' monthly-equivalent fees.
- Monthly subscriptions: face value (e.g., $99 for Pro Monthly).
- Annual subscriptions: annual price / 12 (e.g., $799 / 12 = $66.58 for Pro Annual).
- Formula: `SUM(monthly_subscriptions.price) + SUM(annual_subscriptions.price / 12)`.
- Only includes subscriptions with `status IN ('active', 'trialing', 'past_due')` and `tier != 'free'`.

**ARR (Annual Recurring Revenue)**: `MRR * 12`.

**Monthly Churn Rate**: `churned_subscriptions_this_month / total_active_at_start_of_month * 100`.

**Net Revenue Churn**: `(churned_MRR - expansion_MRR) / starting_MRR * 100`. Negative net revenue churn indicates growth outpacing churn.

**ARPU (Average Revenue Per User)**: `MRR / total_active_paid_subscriptions`.

**Trial-to-Paid Conversion Rate**: `trials_converted / trials_ended_this_period * 100` (excludes currently active trials).

#### 2.4.3 Visualizations

| Chart | Type | Data |
|---|---|---|
| MRR Trend | Line chart | 12-month rolling MRR with monthly data points |
| Subscription Distribution | Stacked bar chart | Count by tier (Free, Trader, Pro, Team) over time |
| Churn Cohort Analysis | Heatmap | Retention rates by signup month cohort |
| Revenue Waterfall | Waterfall chart | New MRR + Expansion - Contraction - Churn = Net New MRR |
| Trial Funnel | Funnel chart | Started -> Active -> Converted / Cancelled |
| AI Cost Trend | Line chart | Monthly AI costs with per-user average |
| Cancellation Reasons | Pie/donut chart | Distribution of cancellation reasons |

#### 2.4.4 Pre-Computed Metrics Table

**`revenue_metrics_daily` Table Schema**:

```sql
CREATE TABLE revenue_metrics_daily (
    id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    date DATE NOT NULL UNIQUE,
    mrr INTEGER NOT NULL,
    arr INTEGER NOT NULL,
    total_active_subscriptions INTEGER NOT NULL,
    free_count INTEGER NOT NULL,
    trader_count INTEGER NOT NULL,
    pro_count INTEGER NOT NULL,
    team_count INTEGER NOT NULL,
    new_subscriptions INTEGER NOT NULL,
    churned_subscriptions INTEGER NOT NULL,
    monthly_churn_rate DECIMAL(5,2) NOT NULL,
    expansion_mrr INTEGER NOT NULL,
    contraction_mrr INTEGER NOT NULL,
    churned_mrr INTEGER NOT NULL,
    trial_active INTEGER NOT NULL,
    trial_converted INTEGER NOT NULL,
    total_ai_cost_usd DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_revenue_metrics_date ON revenue_metrics_daily(date);
```

**Column Notes**:
- All monetary values in cents (mrr, arr, expansion_mrr, contraction_mrr, churned_mrr) except `total_ai_cost_usd` which is in dollars.
- `monthly_churn_rate` is a percentage value (e.g., 5.25 means 5.25%).

**Refresh**: A background Celery job computes these metrics every 15 minutes by querying the `subscriptions`, `invoices`, `cancellation_events`, and `ai_usage_log` tables. The job inserts or updates the row for the current date.

#### 2.4.5 API Endpoints

##### `GET /api/admin/revenue/metrics`

**Authentication**: Admin role required.

**Query Parameters**:

| Parameter | Type | Default | Description |
|---|---|---|---|
| `from_date` | date | 30 days ago | Start of date range |
| `to_date` | date | today | End of date range |
| `granularity` | string | `"daily"` | `"daily"` or `"monthly"` |

**Response (200 OK)**:
```json
{
  "summary": {
    "mrr": 45000,
    "mrr_display": "$450.00",
    "arr": 540000,
    "arr_display": "$5,400.00",
    "total_active": 150,
    "paid_active": 42,
    "monthly_churn_rate": 3.5,
    "arpu": 1071,
    "arpu_display": "$10.71",
    "trial_conversion_rate": 62.5,
    "total_ai_cost_mtd": 125.50
  },
  "by_tier": {
    "free": 108,
    "trader": 22,
    "pro": 15,
    "team": 5
  },
  "timeseries": [
    {
      "date": "2026-03-01",
      "mrr": 42000,
      "new_subscriptions": 5,
      "churned_subscriptions": 2,
      "expansion_mrr": 5000,
      "contraction_mrr": 1000,
      "churned_mrr": 3000,
      "trial_active": 8,
      "trial_converted": 3,
      "total_ai_cost_usd": 4.25
    }
  ]
}
```

##### `GET /api/admin/revenue/subscriptions`

**Authentication**: Admin role required.

Returns a filterable, paginated list of all subscriptions for admin review.

**Query Parameters**:

| Parameter | Type | Default | Description |
|---|---|---|---|
| `tier` | string | all | Filter by tier |
| `status` | string | all | Filter by status |
| `payment_status` | string | all | Filter by payment_status |
| `search` | string | none | Search by user email |
| `page` | integer | 1 | Page number |
| `per_page` | integer | 50 | Results per page (max 200) |

**Response (200 OK)**:
```json
{
  "subscriptions": [
    {
      "user_id": "uuid",
      "email": "user@example.com",
      "tier": "pro",
      "status": "active",
      "billing_interval": "monthly",
      "payment_status": "current",
      "current_period_end": "2026-04-01T00:00:00Z",
      "created_at": "2026-01-15T00:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "per_page": 50,
    "total": 150,
    "total_pages": 3
  }
}
```

---

### 2.5 BL-FR-022: Claude API Cost Tracking

**Source**: PRD-009 Section 3.6, BL-FR-022

**Description**: The system tracks and meters Claude API usage per user to manage costs and enforce fair use soft caps. Admin can view aggregate cost data.

#### 2.5.1 AI Usage Log Table

```sql
CREATE TABLE ai_usage_log (
    id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    feature_key VARCHAR(50) NOT NULL,
    model VARCHAR(50) NOT NULL,
    input_tokens INTEGER NOT NULL,
    output_tokens INTEGER NOT NULL,
    estimated_cost_usd DECIMAL(10,6) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_ai_usage_user_id ON ai_usage_log(user_id);
CREATE INDEX idx_ai_usage_feature_key ON ai_usage_log(feature_key);
CREATE INDEX idx_ai_usage_created_at ON ai_usage_log(created_at);
```

**Feature Key Values**:
- `conversational_analytics`: AI-powered conversational analytics queries
- `trade_review`: AI-generated trade review summaries
- `journal_review`: AI journal entry review and suggestions

#### 2.5.2 Fair Use Limits (Soft Caps)

| Tier | Monthly AI Calls | Monthly Token Budget |
|---|---|---|
| Free | 0 | 0 |
| Trader | 0 | 0 |
| Pro | 100 | 500,000 |
| Team | 500 | 2,500,000 |

**Enforcement** [Cross-reference: FSD-009b for feature gating]:
- At 80% of budget: show UI warning (non-blocking): "You've used 80% of your AI budget for this month ({used}/{limit} calls). Resets on {first_day_next_month}."
- At 100% of budget: block the AI call with message: "You've used your AI budget for this month. Resets on {first_day_next_month}." No overage charges at launch.

**Logging**:
After every Claude API call, log the usage in `ai_usage_log` with:
- `feature_key`: which AI feature was used
- `model`: the Claude model used (e.g., `claude-sonnet-4-5-20250929`)
- `input_tokens` and `output_tokens`: from the API response
- `estimated_cost_usd`: calculated from the model's pricing

#### 2.5.3 Admin AI Usage Report

**API Endpoint**: `GET /api/admin/ai-usage`

**Authentication**: Admin role required.

**Query Parameters**:

| Parameter | Type | Default | Description |
|---|---|---|---|
| `from_date` | date | 30 days ago | Start date |
| `to_date` | date | today | End date |
| `group_by` | string | `"daily"` | `"daily"`, `"weekly"`, `"monthly"` |

**Response (200 OK)**:
```json
{
  "summary": {
    "total_cost_usd": 125.50,
    "total_calls": 1250,
    "total_input_tokens": 3750000,
    "total_output_tokens": 625000,
    "unique_users": 18,
    "avg_cost_per_user": 6.97,
    "avg_cost_per_call": 0.10
  },
  "by_feature": {
    "conversational_analytics": {"calls": 500, "cost_usd": 62.50},
    "trade_review": {"calls": 450, "cost_usd": 45.00},
    "journal_review": {"calls": 300, "cost_usd": 18.00}
  },
  "timeseries": [
    {
      "date": "2026-03-01",
      "cost_usd": 4.25,
      "calls": 42,
      "unique_users": 8
    }
  ],
  "top_users": [
    {
      "user_id": "uuid",
      "email": "user@example.com",
      "tier": "pro",
      "calls": 85,
      "cost_usd": 8.50
    }
  ]
}
```

---

### 2.6 Cancellation Analytics

**Source**: PRD-009 Section 3.2, BL-FR-008 (analytics portion)

**Description**: The system tracks cancellation reasons and retention offer effectiveness for admin analysis.

#### 2.6.1 Cancellation Events Table

```sql
CREATE TABLE cancellation_events (
    id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    reason VARCHAR(50) NOT NULL,
    reason_text TEXT,
    retention_offer_shown BOOLEAN NOT NULL DEFAULT FALSE,
    retention_offer_type VARCHAR(50),
    retention_offer_accepted BOOLEAN NOT NULL DEFAULT FALSE,
    cancellation_completed BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_cancellation_events_user_id ON cancellation_events(user_id);
CREATE INDEX idx_cancellation_events_reason ON cancellation_events(reason);
CREATE INDEX idx_cancellation_events_created_at ON cancellation_events(created_at);
```

**Valid Reason Values**:
- `too_expensive`
- `not_using`
- `missing_features`
- `competitor`
- `technical_issues`
- `temporary_pause`
- `other`

#### 2.6.2 Tracked Metrics

Every cancellation attempt logs:
- `user_id`: who attempted to cancel
- `reason`: selected reason code
- `reason_text`: free-text detail (if reason is `other` or additional context provided)
- `retention_offer_shown`: whether a retention offer was displayed
- `retention_offer_type`: which offer was shown (e.g., `discount_25pct_3mo`, `downgrade_suggestion`, `pause_suggestion`)
- `retention_offer_accepted`: whether the user accepted the offer (true = cancellation avoided)
- `cancellation_completed`: whether the user completed the full cancellation flow

**Analytics derivable from this data**:
- Cancellation reason distribution (pie chart on admin dashboard)
- Retention offer acceptance rate by reason
- Save rate: `(attempts where cancellation_completed = false) / total_attempts * 100`
- Most effective retention strategy per reason

---

## 3. Billing Audit Trail

### 3.1 Audit Log Structure

All billing-related admin and system actions are logged for compliance and investigation.

```sql
CREATE TABLE billing_audit_log (
    id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    action VARCHAR(50) NOT NULL,
    actor_id UUID NOT NULL REFERENCES users(id),
    details JSONB NOT NULL,
    ip_address INET,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_billing_audit_user_id ON billing_audit_log(user_id);
CREATE INDEX idx_billing_audit_action ON billing_audit_log(action);
CREATE INDEX idx_billing_audit_actor_id ON billing_audit_log(actor_id);
CREATE INDEX idx_billing_audit_created_at ON billing_audit_log(created_at);
```

### 3.2 Audited Events

| Action | Trigger | Key Details Logged |
|---|---|---|
| `refund_issued` | Admin processes refund | invoice_id, amount, reason, admin_id |
| `promotion_created` | Admin creates promotion code | code, discount details, restrictions |
| `promotion_updated` | Admin modifies/deactivates code | code, changes made |
| `promotion_applied` | Stripe webhook: coupon applied | code, user_id, discount_amount |
| `admin_dashboard_accessed` | Admin visits revenue dashboard | admin_id, timestamp |
| `admin_user_lookup` | Admin views user billing details | admin_id, target_user_id |
| `subscription_created` | Webhook processing | tier, stripe_ids |
| `subscription_updated` | Webhook processing | previous_tier, new_tier, change_type |
| `subscription_cancelled` | Webhook processing | reason, effective_date |
| `payment_succeeded` | Webhook processing | amount, invoice_id |
| `payment_failed` | Webhook processing | amount, failure_reason, dunning_step |

**Retention**: Audit logs are retained for 7 years (consistent with financial record retention requirements). Records are never deleted by application code. Archival to cold storage after 1 year is managed by the infrastructure layer.

---

## 4. UI/UX Specifications

### 4.1 User Invoice History Page

**Location**: `/settings/billing/history` (linked from Billing Settings page)

**Layout**:
- Table with columns: Date, Description, Amount, Status, Action
- Status indicators: green badge for "Paid", gray for "Void", red for "Refunded"
- Action column: "Download PDF" link for each paid invoice
- Pagination at bottom (20 invoices per page)

### 4.2 Admin Revenue Dashboard

**Location**: `/admin/revenue`

**Access**: Requires admin role. Non-admin users see 404 (not 403, to avoid revealing the endpoint exists).

**Layout**:

**Top Row (Key Metrics Cards)**:
- MRR (with month-over-month change percentage and up/down arrow)
- ARR
- Total Active Subscribers (with breakdown tooltip: X free, Y trader, Z pro, W team)
- Monthly Churn Rate (with indicator: green < 5%, yellow 5-10%, red > 10%)
- ARPU
- Trial Conversion Rate

**Second Row (Charts)**:
- Left: MRR Trend (line chart, 12 months, with toggle for weekly/monthly)
- Right: Subscription Distribution (stacked bar, by tier, 12 months)

**Third Row (Charts)**:
- Left: Revenue Waterfall (current month: new + expansion - contraction - churn)
- Right: Trial Funnel (started -> converting -> converted / cancelled)

**Fourth Row (Tables/Charts)**:
- Left: Cancellation Reasons (donut chart with legend showing counts and percentages)
- Right: AI Cost Trend (line chart with total cost and per-user average)

**Fifth Row (Active Coupons)**:
- Table: Code, Discount, Redemptions/Max, Expires, Status, Actions (Deactivate)

**Sixth Row (Recent Activity)**:
- Live feed of: new subscriptions, upgrades, downgrades, cancellations, refunds (last 24 hours)

**Date Range Selector**: Top-right corner, applies to all charts. Presets: Last 7 days, Last 30 days, This Quarter, This Year, Custom range.

### 4.3 Admin Refund Panel

**Location**: Accessed from Admin User Billing Detail view (`/admin/users/{user_id}/billing`)

**Layout**:
1. User's subscription details at top
2. Invoice list below
3. Each invoice row has a "Refund" button (only for `paid` invoices)
4. Clicking "Refund" opens a modal:
   - Radio buttons: "Full Refund" / "Partial Refund"
   - If partial: amount input field (pre-filled with invoice amount)
   - Reason textarea (required, shows character count, minimum 10)
   - "Process Refund" button (red, with confirmation: "This will refund ${amount} to the customer. Continue?")
   - "Cancel" button

### 4.4 Admin Promotions Panel

**Location**: `/admin/promotions`

**Layout**:
1. "Create Promotion" button at top right
2. Table columns: Code, Type (% off / $ off), Value, Duration, Redemptions, Max, Expires, Status, Actions
3. Status: green "Active", gray "Expired", red "Deactivated"
4. Actions: "Deactivate" button, "View Details" link
5. Create/Edit form: modal with fields matching the POST API specification

---

## 5. Performance Specifications

### 5.1 Revenue Dashboard

| Metric | Target |
|---|---|
| Page load time | < 3 seconds for up to 10,000 subscriptions |
| Data freshness | Metrics no more than 15 minutes old |
| Background metrics computation | < 60 seconds per refresh cycle |
| Concurrent admin users | 10 simultaneous without degradation |

### 5.2 Invoice Access

| Metric | Target |
|---|---|
| Invoice list query (p99) | < 5ms (PostgreSQL indexed query) |
| Invoice PDF URL refresh | < 2 seconds (Stripe API call) |

### 5.3 Refund Processing

| Metric | Target |
|---|---|
| Refund API response (p99) | < 3 seconds (includes Stripe API call) |
| Refund email delivery | < 60 seconds after processing |

### 5.4 AI Cost Report

| Metric | Target |
|---|---|
| Report generation (30-day range) | < 2 seconds |
| Report generation (12-month range) | < 5 seconds |

---

## 6. Testing Specifications

### 6.1 Invoice Access Tests

| Test ID | Test Case | Expected |
|---|---|---|
| BL-TEST-INV-001 | User views invoices with 3 paid invoices | Returns 3 invoices ordered by date descending, all with valid PDF URLs |
| BL-TEST-INV-002 | User with no invoices | Returns empty array, HTTP 200, `total_count: 0` |
| BL-TEST-INV-003 | User accesses another user's invoices | HTTP 401/404 -- only own invoices returned |
| BL-TEST-INV-004 | Invoice with void status | Included in listing with `status: "void"` |
| BL-TEST-INV-005 | Invoice PDF URL expired | Invoice returned without pdf_url, frontend handles gracefully |
| BL-TEST-INV-006 | `invoice.finalized` webhook creates invoice record | Record created with correct amount, period, and PDF URL |
| BL-TEST-INV-007 | `invoice.payment_succeeded` updates status to paid | Invoice status updated, receipt email sent |

### 6.2 Refund Processing Tests

| Test ID | Test Case | Expected |
|---|---|---|
| BL-TEST-REF-001 | Full refund of paid invoice | Stripe refund created, local record created, invoice status updated to "refunded", email sent, audit log entry |
| BL-TEST-REF-002 | Partial refund | Stripe refund for partial amount, local record with partial amount |
| BL-TEST-REF-003 | Refund exceeds invoice amount | HTTP 400: "Refund amount cannot exceed..." |
| BL-TEST-REF-004 | Refund already-refunded invoice | HTTP 409: "This invoice has already been refunded." |
| BL-TEST-REF-005 | Non-admin attempts refund | HTTP 403 |
| BL-TEST-REF-006 | Reason too short (5 chars) | HTTP 400: "Please provide a refund reason..." |
| BL-TEST-REF-007 | Stripe API fails during refund | HTTP 502, no local record created, no email sent |
| BL-TEST-REF-008 | Refund of void invoice | HTTP 400: "Only paid invoices can be refunded." |
| BL-TEST-REF-009 | Audit trail recorded | `billing_audit_log` contains refund_issued entry with admin_id, amount, reason |

### 6.3 Promotion Code Tests

| Test ID | Test Case | Expected |
|---|---|---|
| BL-TEST-PROMO-001 | Admin creates percent-off promotion | Stripe coupon + promotion code created, returned in list |
| BL-TEST-PROMO-002 | Admin creates amount-off promotion | Stripe coupon with amount_off, promotion code linked |
| BL-TEST-PROMO-003 | Admin deactivates promotion | Code marked inactive in Stripe, no longer redeemable |
| BL-TEST-PROMO-004 | Duplicate code creation | HTTP 409: "Promotion code already exists." |
| BL-TEST-PROMO-005 | Invalid discount value (percent_off = 150) | HTTP 400: "Percentage discount must be between 1 and 100." |
| BL-TEST-PROMO-006 | Non-admin attempts promotion creation | HTTP 403 |
| BL-TEST-PROMO-007 | Promotion with max_redemptions reached | Code no longer accepted during checkout |
| BL-TEST-PROMO-008 | Promotion with past expiry date | HTTP 400: expiration must be in the future |
| BL-TEST-PROMO-009 | Redemption history shows correct users | Admin detail view lists all users who redeemed the code |

### 6.4 Revenue Dashboard Tests

| Test ID | Test Case | Expected |
|---|---|---|
| BL-TEST-REV-001 | Dashboard loads with 100 subscriptions | All metrics computed correctly, page loads < 3s |
| BL-TEST-REV-002 | MRR calculation with mixed monthly/annual | Monthly at face value, annual / 12, sum matches expected |
| BL-TEST-REV-003 | Churn rate calculation | (churned / start_of_month_total) * 100, correct to 2 decimal places |
| BL-TEST-REV-004 | Non-admin accesses /admin/revenue | HTTP 404 (not 403) |
| BL-TEST-REV-005 | Date range filter (last 7 days) | Only returns metrics within the specified range |
| BL-TEST-REV-006 | Subscription list with tier filter | Returns only subscriptions matching the filter |
| BL-TEST-REV-007 | Metrics refresh job runs | `revenue_metrics_daily` table updated with fresh data |
| BL-TEST-REV-008 | Empty database (no subscriptions) | Dashboard renders with all zeros, no errors |
| BL-TEST-REV-009 | Revenue waterfall: new + expansion - contraction - churn | Net MRR change matches sum of components |

### 6.5 AI Cost Tracking Tests

| Test ID | Test Case | Expected |
|---|---|---|
| BL-TEST-AI-001 | AI call logged correctly | `ai_usage_log` record with correct tokens, cost, feature_key |
| BL-TEST-AI-002 | Admin views AI usage report | Correct aggregation by feature, date, and user |
| BL-TEST-AI-003 | Top users list | Sorted by cost descending, limited to top 10 |
| BL-TEST-AI-004 | Monthly cost in revenue metrics | `total_ai_cost_usd` in `revenue_metrics_daily` matches sum of `ai_usage_log` |
| BL-TEST-AI-005 | Cost per user calculation | Total cost / unique users for the period |

### 6.6 Cancellation Analytics Tests

| Test ID | Test Case | Expected |
|---|---|---|
| BL-TEST-CAN-001 | Cancellation event logged | Record in `cancellation_events` with correct reason, offer shown/accepted |
| BL-TEST-CAN-002 | Retention offer accepted (too_expensive) | `retention_offer_accepted = true`, `cancellation_completed = false` |
| BL-TEST-CAN-003 | Retention offer declined, cancellation completed | `retention_offer_accepted = false`, `cancellation_completed = true` |
| BL-TEST-CAN-004 | Cancellation reasons distribution | Admin dashboard shows correct percentages per reason |
| BL-TEST-CAN-005 | Repeat cancellation with already-used retention coupon | Note shown: "discount can only be applied once per account" |

### 6.7 Load Tests

| Scenario | Target | Pass Criteria |
|---|---|---|
| Revenue dashboard with 10,000 subscriptions | 10 concurrent admin users | Page load < 3s for all users |
| Invoice list with 1,000 invoices per user | 100 concurrent users | API response < 200ms (p99) |
| Metrics refresh job with 10,000 subscriptions | Single execution | Completes in < 60 seconds |

---

## 7. Scheduled Jobs

| Job | Schedule | Purpose | Failure Behavior |
|---|---|---|---|
| Revenue metrics computation | Every 15 minutes | Update `revenue_metrics_daily` table with fresh calculations | Retry on next cycle. Dashboard shows stale data (acceptable). |
| Daily reconciliation | Daily at 03:00 UTC | Compare local subscription state with Stripe API | CRITICAL alert on any discrepancy. Auto-correct local state to match Stripe. |
| Stripe events cleanup | Weekly, Sunday 02:00 UTC | Delete processed webhook events older than 90 days | Retry next week. Non-critical. |
| Usage data archival | Monthly, 1st at 01:00 UTC | Aggregate and archive usage records older than 12 months | Retry next month. Non-critical. |

---

## 8. Cross-References

| Topic | Sub-FSD | Key Specifications |
|---|---|---|
| Stripe integration, checkout, subscription lifecycle, webhooks, dunning | FSD-009a | BL-FR-001 through BL-FR-020, BL-FR-023, BL-FR-027, BL-FR-028 |
| Feature gating engine, usage tracking, tier middleware | FSD-009b | BL-FR-012 through BL-FR-015 |
| Authentication and role-based access control (admin role) | FSD-008 | JWT auth, admin role enforcement |
| Notification service (email delivery) | FSD-010 | SendGrid integration for refund/invoice emails |

---

## Changelog

- 2026-02-11: Initial sub-FSD extracted from FSD-009 v1.0

---

*FSD-009c v1.0 -- Billing Admin & Revenue*
*TrendEdge -- February 2026*
