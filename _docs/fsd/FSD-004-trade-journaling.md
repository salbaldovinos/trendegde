# FSD-004: Trade Journaling

**TrendEdge — AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-004 |
| Source PRD | PRD-004 |
| Title | Trade Journaling |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-11 |

---

## Table of Contents

1. [Introduction](#1-introduction)
2. [System Context](#2-system-context)
3. [Functional Specifications](#3-functional-specifications)
4. [Data Specifications](#4-data-specifications)
5. [API Specifications](#5-api-specifications)
6. [UI/UX Specifications](#6-uiux-specifications)
7. [Integration Specifications](#7-integration-specifications)
8. [Security Specifications](#8-security-specifications)
9. [Performance Specifications](#9-performance-specifications)
10. [Testing Specifications](#10-testing-specifications)
11. [Migration & Deployment](#11-migration--deployment)
12. [Open Questions](#12-open-questions)
13. [Appendices](#13-appendices)

---

## 1. Introduction

### 1.1 Purpose

This FSD specifies the complete behavior of the Trade Journaling system. It documents every state transition, error message, validation rule, and edge case so that developers or AI agents can implement the feature without asking clarifying questions. The PRD (PRD-004) defines *what* the system does; this FSD defines *how it behaves* in every scenario.

### 1.2 Scope

**In scope:**
- Automatic journal entry creation triggered by trade fill events
- Manual enrichment: conviction, emotions, notes, screenshots, mistakes, compliance
- MAE/MFE tick-by-tick tracking and persistence
- Trade search, filtering, sorting, and export (CSV/PDF)
- Trade linking for scale-in/out, re-entries, and related trades
- Screenshot upload, storage, thumbnailing, and annotation

**Out of scope:**
- Trade execution pipeline mechanics [Cross-reference: see FSD-003 for trade execution details]
- Trendline detection and scoring [Cross-reference: see FSD-002 for trendline detection details]
- Playbook definition and auto-classification [Cross-reference: see FSD-005 for playbook system details]
- Performance analytics dashboards [Cross-reference: see FSD-006 for performance analytics details]
- AI-powered trade review [Cross-reference: see FSD-007 for AI features details]

### 1.3 Design Principles

| Principle | Behavioral Implication |
|---|---|
| Zero-input default | A trader who never opens the journal has a complete record. No field requires manual entry for the record to exist. |
| Enrichment, not data entry | Manual inputs add only what automation cannot capture (emotions, conviction, screenshots). The system never asks a trader to type a fill price. |
| Full lineage preservation | Every journal entry links to its originating signal and trendline. Trendline metadata is snapshotted at signal time and never retroactively updated. |
| Query-first schema | Indexes, computed fields, and denormalized data exist to serve the filter/search queries traders actually run. |

---

## 2. System Context

### 2.1 Upstream Event Sources

| Source | Event | Data Provided | FSD Reference |
|---|---|---|---|
| Execution Pipeline | `trade.fill.confirmed` | Fill price, timestamp, quantity, order IDs, signal reference | FSD-003 |
| Execution Pipeline | `trade.closed` | Exit price, exit timestamp, exit type, final P&L | FSD-003 |
| Trendline Engine | Trendline metadata snapshot | Touch count, slope, grade, duration, touch points, candle spacing | FSD-002 |
| Playbook System | Playbook assignment | Playbook ID, compliance checklist template | FSD-005 |
| Broker Connection | Real-time price feed | Tick-by-tick or 1-second bar prices for open positions | FSD-003 |

### 2.2 Downstream Consumers

| Consumer | Data Consumed | FSD Reference |
|---|---|---|
| Performance Analytics | P&L, R-multiples, MAE/MFE, emotional tags, mistake tags, compliance scores | FSD-006 |
| AI Trade Review | Full journal entry data for personalized reviews | FSD-007 |
| Playbook Analytics | Trades grouped by playbook with outcome data | FSD-005 |

### 2.3 Journal Entry Lifecycle States

| From State | Event | To State | System Action |
|---|---|---|---|
| *(none)* | `trade.fill.confirmed` received | `draft` | Create journal entry, populate auto fields, subscribe to price feed for MAE/MFE |
| `draft` | `trade.closed` received | `complete` | Finalize P&L, R-multiple, MAE/MFE; write exit data; push WebSocket update |
| `draft` | Trade cancelled before exit | `complete` | Mark trade as cancelled, set P&L to 0, record cancellation reason |
| `complete` | User edits enrichment fields | `complete` | Update editable fields, append to `edit_history`, update `updated_at` |

A journal entry is never deleted by users. Deletion occurs only via cascade when a trade record is deleted (admin action).

---

## 3. Functional Specifications

### 3.1 Auto-Journal Creation (JR-FR-001)

#### 3.1.1 Trigger and Entry Creation

**Trigger:** The system listens for `trade.fill.confirmed` events published by the execution pipeline.

**Behavior on event receipt:**

1. Extract `trade_id` from the event payload.
2. Check if a `journal_entries` record already exists for this `trade_id` (idempotency guard).
   - If yes: log a warning `"Duplicate journal creation attempt for trade_id={trade_id}, skipping"` and exit. No second entry is created.
   - If no: proceed to step 3.
3. Create a new `journal_entries` record with `status = 'draft'` and `trade_id` linked.
4. Populate all auto-calculated fields (see 3.2).
5. If the trade has a `signal_id`, look up the `Signal` record and attach signal metadata.
6. If the signal has a `trendline_id`, snapshot the trendline metadata (see 3.3).
7. Subscribe to the real-time price feed for MAE/MFE tracking (see 3.4).
8. Push a WebSocket event `journal.entry.created` to the user's dashboard.

**Partial fill consolidation:**
- Multiple partial fills for the same order (same `signal_id` or same `manual_trade_group_id`) are consolidated into a single journal entry.
- The entry's `entry_price` is the volume-weighted average price (VWAP) across all partial fills.
- The entry's `quantity` is the sum of all partial fill quantities.
- The entry is created on the first partial fill and updated on subsequent fills.

**Manual trades (no signal):**
- When a trade has `signal_source = 'manual'`, the journal entry is created with trendline fields set to `NULL`.
- The entry is otherwise identical in structure; no fields are omitted.

#### 3.1.2 Retry and Error Handling

| Failure Scenario | System Response | Error Message (Internal Log) |
|---|---|---|
| Database write fails | Retry up to 3 times with exponential backoff: 1s, 4s, 16s | `"Journal creation failed for trade_id={trade_id}, attempt {n}/3: {error}"` |
| All 3 retries exhausted | Log error, send Telegram alert to admin channel | `"CRITICAL: Journal creation permanently failed for trade_id={trade_id} after 3 retries"` |
| Signal record not found | Create entry without signal metadata, log warning | `"Signal {signal_id} not found for trade_id={trade_id}. Journal created without signal context."` |
| Trendline record not found | Create entry without trendline metadata, log warning | `"Trendline {trendline_id} not found for signal {signal_id}. Journal created without trendline context."` |
| Price feed subscription fails | Create entry, use 1-minute bar fallback for MAE/MFE | `"Price feed subscription failed for trade_id={trade_id}. Falling back to 1m bar data."` |

**Critical invariant:** The trade execution is NEVER blocked or rolled back due to a journaling failure. Journaling is a post-trade side effect.

#### 3.1.3 Daily Reconciliation Job

A scheduled job runs daily at 00:30 UTC:

1. Query all `trades` records with `status IN ('open', 'closed')` that have no corresponding `journal_entries` record.
2. For each orphaned trade, create a journal entry and populate all available fields.
3. Log the reconciliation result: `"Reconciliation complete: {n} missing entries created out of {total} trades checked."`.
4. If any entries were created, send a Telegram alert: `"Journal reconciliation created {n} missing entries. Review recommended."`.

### 3.2 Auto-Population Fields (JR-FR-002)

All fields below are populated without user input. Calculated fields use the formulas specified.

| Field | Formula / Source | When Populated | Null If |
|---|---|---|---|
| `entry_timestamp` | Broker fill event UTC timestamp | On fill | Never (required) |
| `exit_timestamp` | Broker fill event UTC timestamp | On trade close | Trade still open |
| `entry_price` | Broker fill price (VWAP if partial fills) | On fill | Never (required) |
| `exit_price` | Broker fill price | On trade close | Trade still open |
| `signal_price` | `signals.entry_price` | On fill | `signal_source = 'manual'` |
| `slippage_ticks` | `(entry_price - signal_price) / tick_size` for LONG; `(signal_price - entry_price) / tick_size` for SHORT | On fill | No signal price |
| `slippage_dollars` | `slippage_ticks * tick_value * quantity` | On fill | No signal price |
| `instrument` | Trade/signal record | On fill | Never |
| `contract_month` | Trade/signal record | On fill | Never |
| `tick_size` | Contract specifications lookup | On fill | Never |
| `tick_value` | Contract specifications lookup | On fill | Never |
| `quantity` | Sum of fill quantities | On fill (updated on partials) | Never |
| `direction` | Signal or manual entry | On fill | Never |
| `signal_source` | `'trendline_engine'`, `'tradingview_webhook'`, or `'manual'` | On fill | Never |
| `setup_type` | Signal record: `'break'` or `'bounce'` | On fill | `signal_source = 'manual'` |
| `stop_price` | Signal record | On fill | No signal / no stop defined |
| `target_price` | Signal record | On fill | No signal / no target defined |
| `stop_distance_ticks` | `abs(entry_price - stop_price) / tick_size` | On fill | No stop price |
| `target_distance_ticks` | `abs(target_price - entry_price) / tick_size` | On fill | No target price |
| `planned_rr` | `target_distance_ticks / stop_distance_ticks` | On fill | Missing stop or target |
| `actual_r_multiple` | `pnl_ticks / stop_distance_ticks` (positive = winner, negative = loser) | On trade close | Missing stop distance |
| `gross_pnl` | `(exit_price - entry_price) * multiplier * quantity * direction_sign` where `direction_sign` is +1 for LONG, -1 for SHORT | On trade close | Trade still open |
| `commission` | Per-contract commission from broker config * quantity | On trade close | Never |
| `net_pnl` | `gross_pnl - commission` | On trade close | Trade still open |
| `exit_type` | Execution pipeline classification | On trade close | Trade still open |
| `hold_duration` | `exit_timestamp - entry_timestamp` | On trade close | Trade still open |
| `session_type` | Time-based: `'rth'` if entry is within RTH hours, else `'overnight'` | On fill | Never |
| `day_of_week` | Derived from `entry_timestamp` in ET timezone | On fill | Never |
| `time_of_day_bucket` | See bucket definitions below | On fill | Never |
| `margin_type` | `'day_trade'` or `'overnight'` from position config | On fill | Never |
| `notional_exposure` | `entry_price * multiplier * quantity` | On fill | Never |

**Time-of-day bucket definitions (Eastern Time):**

| Bucket | Time Range |
|---|---|
| `pre_market` | 04:00 - 09:29 ET |
| `morning` | 09:30 - 11:59 ET |
| `midday` | 12:00 - 13:59 ET |
| `afternoon` | 14:00 - 15:29 ET |
| `close` | 15:30 - 16:00 ET |
| `overnight` | 16:01 - 03:59 ET |

**RTH determination:** A trade is `rth` if `entry_timestamp` falls within 09:30-16:00 ET on a weekday. All other times are `overnight`.

### 3.3 Trendline Metadata Attachment (JR-FR-003)

When `signal_source = 'trendline_engine'`, the system snapshots the following fields from the `Trendline` record at signal-generation time and stores them in `trades.trendline_metadata` as JSONB:

| Field | Type | Description |
|---|---|---|
| `trendline_id` | UUID | FK to originating trendline |
| `touch_count` | integer | Confirmed touchpoints at signal time |
| `slope_degrees` | decimal | Slope angle in degrees |
| `trendline_duration_days` | integer | Calendar days from first touch to signal |
| `candle_spacing_avg` | decimal | Average candle count between touches |
| `candle_spacing_min` | integer | Minimum candle spacing |
| `trendline_grade` | string | `A+`, `A`, or `B` |
| `touch_points` | JSON array | `[[timestamp, price], ...]` for each touch |
| `break_candle_volume` | integer | Volume of the break/bounce candle |
| `distance_from_line_ticks` | decimal | Entry distance from trendline in ticks |

**Immutability rule:** This snapshot is never updated if the trendline is later recalculated. It preserves the exact conditions under which the trading decision was made.

### 3.4 MAE/MFE Tracking (JR-FR-004)

#### 3.4.1 Real-Time Tracking Behavior

While a trade is open:

1. The system subscribes to real-time price updates from the broker connection for the trade's instrument.
2. On each price tick (or 1-second bar if tick data unavailable):
   - Compute current unrealized P&L in ticks: `(current_price - entry_price) / tick_size * direction_sign`
   - If unrealized loss > stored `mae_ticks`: update `mae_ticks`, `mae_dollars`, `mae_r`, `mae_timestamp`
   - If unrealized profit > stored `mfe_ticks`: update `mfe_ticks`, `mfe_dollars`, `mfe_r`, `mfe_timestamp`
3. MAE/MFE updates are held in memory (Redis) during the trade and flushed to PostgreSQL every 10 seconds and on trade close.

#### 3.4.2 MAE/MFE Calculation Formulas

For a LONG trade:
- `mae_ticks = abs(min(lowest_price - entry_price) / tick_size)` (always positive)
- `mfe_ticks = (highest_price - entry_price) / tick_size` (always positive)

For a SHORT trade:
- `mae_ticks = abs(max(highest_price - entry_price) / tick_size)` (always positive)
- `mfe_ticks = (entry_price - lowest_price) / tick_size` (always positive)

Dollar and R conversions:
- `mae_dollars = mae_ticks * tick_value * quantity`
- `mae_r = mae_ticks / stop_distance_ticks` (NULL if no stop distance)
- Same formulas for MFE equivalents.

#### 3.4.3 Fallback Behavior

| Data Source Available | `mae_mfe_source` Value | Behavior |
|---|---|---|
| Tick-by-tick from broker | `tick` | Exact MAE/MFE from every price change |
| 1-second bars available | `tick` | Treated as equivalent to tick data |
| Only 1-minute OHLC bars | `1m_bar` | MAE from bar lows (longs) / highs (shorts); MFE from bar highs (longs) / lows (shorts) |
| No real-time data | `estimated` | MAE/MFE estimated from post-trade historical data after trade closes |

#### 3.4.4 Paper Trading

Paper trades use the same MAE/MFE calculation at the same granularity. The simulated price feed is the data source. There is no behavioral difference between live and paper trade MAE/MFE tracking.

### 3.5 Manual Enrichment

#### 3.5.1 Conviction Level (JR-FR-005)

**Input specification:**
- Type: Integer, range 1-5
- Labels: 1 = Low Conviction, 2 = Below Average, 3 = Average, 4 = High Conviction, 5 = Maximum Conviction
- Default: `NULL` (not pre-filled; the system never assumes a conviction)
- Input UI: Clickable star rating or numbered button group

**Behavior:**
- Can be set pre-trade (on signal confirmation screen) or post-trade (in journal detail view).
- `conviction_set_at` timestamp records when the value was set, enabling analysis of pre-trade vs. post-trade conviction.
- Changing the conviction level overwrites the previous value and updates `conviction_set_at`.
- The previous value is recorded in `edit_history`.

**Validation:**
- Value outside 1-5: reject with `"Conviction must be between 1 and 5."`.
- Non-integer value: reject with `"Conviction must be a whole number."`.

#### 3.5.2 Emotional State Tagging (JR-FR-006)

**Predefined tags (10):** `confident`, `anxious`, `fomo`, `revenge`, `patient`, `disciplined`, `frustrated`, `overconfident`, `bored`, `fatigued`

**Custom tags:**
- Users may create up to 20 custom emotional tags.
- Tag value: 1-50 characters, alphanumeric and spaces only, case-insensitive (stored lowercase).
- Attempt to create 21st tag: `"Maximum of 20 custom emotional tags reached. Delete an existing tag to add a new one."`.
- Duplicate tag (case-insensitive): `"This emotional tag already exists."`.

**Behavior:**
- Multiple tags can be selected per entry (stored as `TEXT[]`).
- Each tag selection records a timestamp in `emotional_state_timestamps` JSONB.
- Tags can be set pre-trade or post-trade.
- Removing a tag removes it from the array; the timestamp is retained in history.

#### 3.5.3 Free-Text Notes (JR-FR-007)

**Three fields per entry:**

| Field | Max Length | Supports Markdown | Full-Text Indexed |
|---|---|---|---|
| `pre_trade_thesis` | 5,000 characters | Yes | Yes (weight A) |
| `post_trade_review` | 5,000 characters | Yes | Yes (weight A) |
| `general_notes` | 5,000 characters | Yes | Yes (weight B) |

**Auto-save behavior:**
- On blur: save immediately.
- On typing pause: debounced save after 3 seconds of inactivity.
- During save: show a subtle "Saving..." indicator. On success: show "Saved" for 2 seconds. On failure: show `"Failed to save. Your changes are preserved locally. Retrying..."` and retry once after 5 seconds.

**Version history (Phase 2):**
- Stores the last 10 edits per note field, each with timestamp and previous content.
- Accessible via a "History" link on the note field.

**Validation:**
- Exceeding 5,000 characters: the input field prevents further typing and displays `"Maximum 5,000 characters reached."` below the field.

#### 3.5.4 Mistake Tagging (JR-FR-010)

**Predefined tags (12):** `moved_stop`, `entered_early`, `entered_late`, `oversized`, `undersized`, `held_too_long`, `exited_too_early`, `no_stop`, `averaged_down`, `ignored_signal`, `wrong_instrument`, `wrong_direction`

**Availability:** Mistake tags are only available after the trade closes. If the trade is still open (`status = 'draft'`), the mistake tag UI is disabled with the message: `"Mistake tagging available after trade closes."`.

**Custom mistake tags:** Same rules as custom emotional tags (max 20, 1-50 chars, stored lowercase).

**Cost estimate:**
- Each selected mistake tag has an optional `cost_estimate` field (decimal, USD).
- This is the trader's subjective assessment, not auto-calculated.
- Validation: must be >= 0. Negative values rejected with `"Cost estimate must be zero or positive."`.

#### 3.5.5 Rule Compliance Checklist (JR-FR-011)

**Loading behavior:**
- When a journal entry is opened for a closed trade, the system loads the checklist from the trade's assigned playbook.
- If no playbook is assigned, the compliance section shows: `"No playbook assigned. Assign a playbook to enable the compliance checklist."`.
- If the playbook has no checklist rules defined, the section shows: `"No compliance rules defined for this playbook."`.

**Checklist interaction:**
- Each rule item is a toggle (checked/unchecked) with an optional note field (max 500 characters).
- Compliance score: `(checked_items / total_items) * 100`, displayed as a percentage with one decimal.
- If any item is unchecked, the system shows a prompt: `"Consider adding a note explaining why this rule was not followed."` (non-blocking).

**Persistence:** The entire checklist state (rules, checked status, notes) is stored as JSONB in `journal_entries.compliance_checklist`.

#### 3.5.6 Screenshot Upload (JR-FR-008)

**Constraints:**

| Constraint | Value | Error Message on Violation |
|---|---|---|
| Accepted formats | PNG, JPEG, WebP | `"Unsupported file format. Please upload PNG, JPEG, or WebP images."` |
| Max file size | 10 MB | `"File exceeds 10 MB limit. Please reduce the image size."` |
| Max per entry | 10 screenshots | `"Maximum 10 screenshots per trade. Delete an existing screenshot to add a new one."` |
| Max per user (storage) | Tier-based: Free=5GB, Trader=25GB, Pro=100GB, Team=500GB | `"Storage quota exceeded. Upgrade your plan or delete existing screenshots."` |

**Upload pipeline:**

1. **Client-side validation:** Check file type and size before upload. Reject immediately if invalid.
2. **Request signed upload URL:** `POST /api/v1/journal/{id}/screenshots/upload-url` returns a signed URL.
3. **Upload to Supabase Storage:** Direct upload using signed URL. Show progress indicator.
4. **Server-side processing (async, Celery task):**
   - Generate 300px-width thumbnail (Pillow or Sharp)
   - Strip EXIF GPS data for privacy
   - Extract and store image dimensions
   - Store metadata in `journal_screenshots` table
5. **Return signed download URLs:** Original and thumbnail, both expire after 1 hour.

**States during upload:**

| State | UI Display |
|---|---|
| Validating | Spinner with `"Validating file..."` |
| Uploading | Progress bar with percentage and `"Uploading..."` |
| Processing | Spinner with `"Generating thumbnail..."` |
| Complete | Thumbnail appears in gallery |
| Failed | Red text: `"Upload failed: {reason}. Please try again."` |

#### 3.5.7 Screenshot Annotation (JR-FR-009)

**Tools available:**

| Tool | Parameters |
|---|---|
| Freehand pen | Color: red, green, blue, yellow, white. Thickness: 1px, 2px, 4px |
| Straight line | Same color/thickness options |
| Rectangle | Same color/thickness options, no fill |
| Arrow | Same color/thickness options |
| Text label | Font size: 12px, 16px, 24px. Same color options |
| Eraser | Click on an annotation object to remove it |

**Data storage:** Annotations stored as JSON array in `journal_screenshots.annotations`, NOT baked into the original image.

**Annotation object schema:**
```json
{
  "id": "uuid",
  "type": "pen|line|rectangle|arrow|text",
  "coordinates": { "points": [[x,y], ...] },
  "style": { "color": "#ff0000", "thickness": 2, "fontSize": 16 },
  "text": "optional label text",
  "timestamp": "ISO 8601"
}
```

**Undo/redo:** Up to 50 actions in the undo stack. Undo clears redo stack on new action.

**Export annotated:** Composites annotations onto original image, renders to PNG, triggers browser download. File name: `annotated_{original_filename}`.

### 3.6 Search, Filtering, and Views

#### 3.6.1 Trade Search and Filtering (JR-FR-012)

**Filter dimensions and behavior:**

| Filter | UI Control | Behavior |
|---|---|---|
| Date range | Date picker with presets | Presets: Today, This Week, This Month, Last 30 Days, This Quarter, YTD, Custom. Custom allows arbitrary start/end. |
| Instrument | Multi-select dropdown | Options populated from user's traded instruments. Empty state: `"No trades yet."` |
| Playbook | Multi-select dropdown | Options from user's playbooks. Includes `"Unassigned"` option. |
| Direction | Toggle group | Long / Short / All (default: All) |
| Outcome | Toggle group | Winner / Loser / Breakeven / All (default: All). Breakeven = `net_pnl` between -$1.00 and +$1.00. |
| Setup type | Toggle group | Break / Bounce / All (default: All) |
| Signal source | Multi-select | Trendline Engine / TradingView Webhook / Manual |
| Trendline grade | Multi-select | A+ / A / B. Only active when signal source includes Trendline Engine. |
| Emotional state | Multi-select chips | All predefined + user's custom tags |
| Mistake tags | Multi-select chips | All predefined + user's custom tags |
| Conviction | Range slider | 1-5. Includes trades with NULL conviction only when slider at full range. |
| R-multiple range | Dual number input | Min R to Max R. Validates min <= max. |
| P&L range | Dual number input | Min $ to Max $. Validates min <= max. |
| Session type | Toggle | RTH / Overnight / All (default: All) |
| Exit type | Multi-select | Stop Loss / Take Profit / Manual / Time Stop / Trailing Stop |
| Has screenshots | Toggle | Yes / No / All (default: All) |
| Has notes | Toggle | Yes / No / All (default: All) |

**Full-text search:**
- Search bar at top of journal view.
- Searches across: `pre_trade_thesis`, `post_trade_review`, `general_notes`, screenshot captions, instrument names.
- Uses PostgreSQL `tsvector`/`tsquery` with English language stemming.
- Search terms highlighted in results with `<mark>` tags.
- Empty search query: returns all results (filter-only mode).

**Saved filters:**
- Up to 20 saved filter presets per user.
- Attempt to save 21st: `"Maximum 20 saved filters reached. Delete an existing filter to save a new one."`.
- Duplicate name: `"A filter with this name already exists. Choose a different name."`.

**Empty result set:** Display `"No trades match your filters."` with a `"Clear all filters"` button.

#### 3.6.2 Trade List View (JR-FR-013)

**Default sort:** `entry_timestamp` descending (newest first).

**Pagination:** 25 rows per page (user-configurable: 10, 25, 50, 100). Page controls at bottom.

**Row behavior:**
- Click anywhere on a row to navigate to trade detail view.
- Winning trades (`net_pnl > 0`): subtle green left border (`#22c55e`).
- Losing trades (`net_pnl < 0`): subtle red left border (`#ef4444`).
- Breakeven trades (`-$1 <= net_pnl <= $1`): neutral/gray left border.

**Summary row:** Pinned at bottom of visible table. Shows for the current filtered set:
- Total P&L (formatted as currency with +/- sign)
- Average R-multiple (2 decimal places)
- Win rate (percentage, 1 decimal)
- Number of trades

**Mobile responsive:** Table collapses to card view showing: instrument, direction arrow (up/down), P&L, and date.

**Column customization (Phase 2):**
- Users can show/hide columns and reorder them.
- Column preferences persist per user in `localStorage` and synced to server.

#### 3.6.3 Trade Detail View (JR-FR-014)

**Layout:** Nine content sections plus a metadata footer, displayed in a single scrollable page.

Sections are specified in detail in Section 6 (UI/UX Specifications).

#### 3.6.4 Trade Editing (JR-FR-015)

**Editable fields (post-trade):**

| Field | Constraint |
|---|---|
| Conviction level | 1-5 integer |
| Emotional state tags | Array of valid tags |
| Mistake tags + cost estimates | Available only when trade is closed |
| Pre-trade thesis | Max 5,000 chars |
| Post-trade review | Max 5,000 chars |
| General notes | Max 5,000 chars |
| Screenshots | Add/remove/reorder/annotate |
| Compliance checklist | Toggle + notes per item |
| Playbook assignment | Re-classify to a different playbook |

**Non-editable fields:** Entry/exit timestamps, prices, slippage, MAE/MFE, R-multiple, P&L, signal source, trendline metadata, session context, contract specs. Attempting to modify these via API returns `403` with `"This field is system-generated and cannot be modified."`.

**Edit tracking:** Every edit appends to `edit_history` JSONB array:
```json
{ "timestamp": "ISO 8601", "field": "conviction", "old_value": 3, "new_value": 5, "source": "web_ui" }
```

**Concurrency:** Last-write-wins. No optimistic locking in Phase 1 (single user).

#### 3.6.5 CSV and PDF Export (JR-FR-016)

**CSV export behavior:**
- Exports all visible columns from the currently filtered table view.
- One row per trade. Timestamps in ISO 8601 with user's timezone.
- Emotional tags: semicolon-delimited within column (e.g., `"fomo;anxious"`).
- Mistake tags: semicolon-delimited within column.
- Special characters (commas, quotes, newlines) escaped per RFC 4180.
- File name: `trendedge_journal_{start_date}_to_{end_date}.csv`
- Max 10,000 trades per export. If exceeded: `"Export limited to 10,000 trades. Apply filters to reduce the result set."`.

**PDF export behavior:**
- **Summary mode:** Table of all filtered trades + header with total P&L, win rate, trade count, avg R-multiple.
- **Detail mode:** Full single-trade view with screenshots embedded at 50% size, rendered Markdown notes, compliance checklist.
- Header: TrendEdge logo. Footer: `"Generated on {date}"`.
- File name: `trendedge_journal_{trade_id_or_date_range}.pdf`
- Generation timeout: 30 seconds. If exceeded: `"PDF generation timed out. Try exporting fewer trades."`.

#### 3.6.6 Trade Linking (JR-FR-017)

**Automatic linking (scale-in/out):**
- When the execution pipeline detects an order adding to or reducing an existing position in the same instrument, it assigns the same `trade_group_id`.
- Group-level metrics are auto-calculated: total P&L, weighted average entry, total quantity, combined R-multiple.

**Manual linking:**
- User clicks "Link Trade" in the detail view, searches for the related trade, selects link type.
- Link types: `scale_in`, `scale_out`, `re_entry`, `related`, `hedge`.
- A trade cannot be linked to itself. Attempt returns: `"A trade cannot be linked to itself."`.
- Duplicate links are rejected: `"These trades are already linked."`.

---

## 4. Data Specifications

### 4.1 Core Tables

#### 4.1.1 `trades` Table (Owned by FSD-003, Referenced Here)

[Cross-reference: see FSD-003 for complete trades table specification. Key columns used by journaling:]

| Column | Type | Constraints | Journal Usage |
|---|---|---|---|
| `id` | UUID | PK | FK from `journal_entries.trade_id` |
| `user_id` | UUID | NOT NULL, FK→users | User isolation |
| `signal_id` | UUID | FK→signals, nullable | Signal lineage |
| `playbook_id` | UUID | FK→playbooks, nullable | Playbook assignment |
| `trade_group_id` | UUID | nullable | Scale-in/out grouping |
| `instrument` | VARCHAR(20) | NOT NULL | Filter/display |
| `direction` | VARCHAR(5) | CHECK IN ('LONG','SHORT') | Filter/display |
| `entry_price` | DECIMAL(12,6) | nullable | Auto-populated on fill |
| `exit_price` | DECIMAL(12,6) | nullable | Auto-populated on close |
| `net_pnl` | DECIMAL(12,2) | nullable | Sort, filter, display |
| `actual_r_multiple` | DECIMAL(8,4) | nullable | Sort, filter, display |
| `mae_ticks` | INTEGER | nullable | Display, analytics |
| `mfe_ticks` | INTEGER | nullable | Display, analytics |
| `mae_mfe_source` | VARCHAR(10) | CHECK IN ('tick','1m_bar','estimated') | Data quality indicator |
| `trendline_metadata` | JSONB | nullable | Trendline context display |
| `status` | VARCHAR(15) | CHECK IN ('open','closed','cancelled') | State management |

#### 4.1.2 `journal_entries` Table

| Column | Type | Constraints | Default |
|---|---|---|---|
| `id` | UUID | PK | `gen_random_uuid()` |
| `trade_id` | UUID | NOT NULL, UNIQUE, FK→trades ON DELETE CASCADE | - |
| `user_id` | UUID | NOT NULL, FK→users | - |
| `conviction` | INTEGER | CHECK BETWEEN 1 AND 5, nullable | NULL |
| `conviction_set_at` | TIMESTAMPTZ | nullable | NULL |
| `emotional_state` | TEXT[] | - | `'{}'` |
| `emotional_state_timestamps` | JSONB | - | `'{}'` |
| `pre_trade_thesis` | TEXT | max 5,000 chars (app-level) | NULL |
| `post_trade_review` | TEXT | max 5,000 chars (app-level) | NULL |
| `general_notes` | TEXT | max 5,000 chars (app-level) | NULL |
| `mistakes` | TEXT[] | - | `'{}'` |
| `mistake_details` | JSONB | - | `'{}'` |
| `compliance_checklist` | JSONB | - | `'[]'` |
| `compliance_score` | DECIMAL(5,2) | 0-100 range | NULL |
| `edit_history` | JSONB | - | `'[]'` |
| `status` | VARCHAR(10) | CHECK IN ('draft','complete'), NOT NULL | `'draft'` |
| `search_vector` | TSVECTOR | - | auto-generated |
| `created_at` | TIMESTAMPTZ | NOT NULL | `now()` |
| `updated_at` | TIMESTAMPTZ | NOT NULL | `now()` |

#### 4.1.3 `journal_screenshots` Table

| Column | Type | Constraints | Default |
|---|---|---|---|
| `id` | UUID | PK | `gen_random_uuid()` |
| `journal_entry_id` | UUID | NOT NULL, FK→journal_entries ON DELETE CASCADE | - |
| `user_id` | UUID | NOT NULL, FK→users | - |
| `storage_path` | TEXT | NOT NULL | - |
| `thumbnail_path` | TEXT | nullable | NULL |
| `original_filename` | VARCHAR(255) | nullable | - |
| `file_size_bytes` | INTEGER | NOT NULL | - |
| `mime_type` | VARCHAR(50) | NOT NULL | - |
| `width` | INTEGER | nullable | NULL |
| `height` | INTEGER | nullable | NULL |
| `caption` | VARCHAR(500) | nullable | NULL |
| `sort_order` | INTEGER | NOT NULL | 0 |
| `annotations` | JSONB | - | `'[]'` |
| `created_at` | TIMESTAMPTZ | NOT NULL | `now()` |
| `updated_at` | TIMESTAMPTZ | NOT NULL | `now()` |

#### 4.1.4 `trade_links` Table

| Column | Type | Constraints | Default |
|---|---|---|---|
| `id` | UUID | PK | `gen_random_uuid()` |
| `trade_id` | UUID | NOT NULL, FK→trades ON DELETE CASCADE | - |
| `linked_trade_id` | UUID | NOT NULL, FK→trades ON DELETE CASCADE | - |
| `link_type` | VARCHAR(15) | CHECK IN ('scale_in','scale_out','re_entry','related','hedge'), NOT NULL | - |
| `user_id` | UUID | NOT NULL, FK→users | - |
| `created_at` | TIMESTAMPTZ | NOT NULL | `now()` |

**Unique constraint:** `(trade_id, linked_trade_id)` — prevents duplicate links.

#### 4.1.5 `journal_saved_filters` Table

| Column | Type | Constraints | Default |
|---|---|---|---|
| `id` | UUID | PK | `gen_random_uuid()` |
| `user_id` | UUID | NOT NULL, FK→users | - |
| `name` | VARCHAR(100) | NOT NULL | - |
| `filter_config` | JSONB | NOT NULL | - |
| `created_at` | TIMESTAMPTZ | NOT NULL | `now()` |
| `updated_at` | TIMESTAMPTZ | NOT NULL | `now()` |

**Unique constraint:** `(user_id, name)` — prevents duplicate filter names per user.

#### 4.1.6 `user_custom_tags` Table

| Column | Type | Constraints | Default |
|---|---|---|---|
| `id` | UUID | PK | `gen_random_uuid()` |
| `user_id` | UUID | NOT NULL, FK→users | - |
| `tag_type` | VARCHAR(20) | CHECK IN ('emotion','mistake'), NOT NULL | - |
| `tag_value` | VARCHAR(50) | NOT NULL | - |
| `created_at` | TIMESTAMPTZ | NOT NULL | `now()` |

**Unique constraint:** `(user_id, tag_type, tag_value)`.

### 4.2 Indexes

| Index | Table | Columns/Expression | Type | Purpose |
|---|---|---|---|---|
| `idx_trades_user_created` | trades | `(user_id, created_at DESC)` | B-tree | Default sort query |
| `idx_trades_user_instrument` | trades | `(user_id, instrument)` | B-tree | Instrument filter |
| `idx_trades_user_playbook` | trades | `(user_id, playbook_id)` | B-tree | Playbook filter |
| `idx_trades_user_status` | trades | `(user_id, status)` | B-tree | Status filter |
| `idx_trades_trade_group` | trades | `(trade_group_id)` WHERE NOT NULL | B-tree | Group lookup |
| `idx_trades_trendline` | trades | `(trendline_id)` WHERE NOT NULL | B-tree | Trendline lookup |
| `idx_journal_user_created` | journal_entries | `(user_id, created_at DESC)` | B-tree | Default sort |
| `idx_journal_trade` | journal_entries | `(trade_id)` | B-tree | Trade→journal lookup |
| `idx_journal_emotions` | journal_entries | `(emotional_state)` | GIN | Emotion tag filter |
| `idx_journal_mistakes` | journal_entries | `(mistakes)` | GIN | Mistake tag filter |
| `idx_journal_search` | journal_entries | `(search_vector)` | GIN | Full-text search |
| `idx_journal_conviction` | journal_entries | `(user_id, conviction)` WHERE NOT NULL | B-tree | Conviction filter |
| `idx_screenshots_journal` | journal_screenshots | `(journal_entry_id)` | B-tree | Screenshot lookup |
| `idx_trade_links_trade` | trade_links | `(trade_id)` | B-tree | Forward link lookup |
| `idx_trade_links_linked` | trade_links | `(linked_trade_id)` | B-tree | Reverse link lookup |

### 4.3 Full-Text Search Trigger

The `search_vector` column on `journal_entries` is auto-updated via a PostgreSQL trigger:

```sql
CREATE OR REPLACE FUNCTION journal_search_vector_update() RETURNS trigger AS $$
BEGIN
    NEW.search_vector :=
        setweight(to_tsvector('english', COALESCE(NEW.pre_trade_thesis, '')), 'A') ||
        setweight(to_tsvector('english', COALESCE(NEW.post_trade_review, '')), 'A') ||
        setweight(to_tsvector('english', COALESCE(NEW.general_notes, '')), 'B');
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER journal_search_vector_trigger
    BEFORE INSERT OR UPDATE OF pre_trade_thesis, post_trade_review, general_notes
    ON journal_entries
    FOR EACH ROW
    EXECUTE FUNCTION journal_search_vector_update();
```

Pre-trade thesis and post-trade review are weighted higher (`A`) than general notes (`B`) so that search results prioritize thesis/review matches.

### 4.4 Data Retention

| Data Type | Active Subscription | After Cancellation |
|---|---|---|
| Journal entries and trade data | Retained indefinitely | Retained indefinitely |
| Screenshots | Retained indefinitely | 12-month grace period, then deleted |
| Annotations (JSON) | Retained in DB indefinitely | Retained with journal entry |
| CSV/PDF exports | Generated on-demand, not stored | N/A |
| Edit history | Retained indefinitely | Retained with journal entry |

---

## 5. API Specifications

### 5.1 Endpoint Summary

All endpoints require authentication via Supabase Auth JWT in the `Authorization: Bearer {token}` header. All request/response bodies are JSON unless otherwise noted.

| Method | Endpoint | Description | Phase | Rate Limit |
|---|---|---|---|---|
| GET | `/api/v1/journal` | List journal entries (paginated, filtered) | 1 | 100/min |
| GET | `/api/v1/journal/{id}` | Get single journal entry with full detail | 1 | 100/min |
| PATCH | `/api/v1/journal/{id}` | Update journal entry (discretionary fields only) | 1 | 30/min |
| POST | `/api/v1/journal/{id}/screenshots` | Upload screenshot | 2 | 30/min |
| DELETE | `/api/v1/journal/{id}/screenshots/{sid}` | Delete screenshot | 2 | 30/min |
| PATCH | `/api/v1/journal/{id}/screenshots/{sid}` | Update screenshot (caption, annotations, order) | 2 | 30/min |
| POST | `/api/v1/journal/{id}/links` | Create trade link | 2 | 30/min |
| DELETE | `/api/v1/journal/{id}/links/{lid}` | Remove trade link | 2 | 30/min |
| GET | `/api/v1/journal/export/csv` | Export filtered journal as CSV | 2 | 10/min |
| GET | `/api/v1/journal/export/pdf` | Export journal as PDF | 2 | 10/min |
| GET | `/api/v1/journal/filters` | List saved filter presets | 2 | 100/min |
| POST | `/api/v1/journal/filters` | Save a filter preset | 2 | 30/min |
| DELETE | `/api/v1/journal/filters/{fid}` | Delete a filter preset | 2 | 30/min |
| POST | `/internal/journal/create` | Internal: create journal entry from fill event | 1 | N/A |

### 5.2 Endpoint Specifications

#### 5.2.1 GET `/api/v1/journal`

**Query parameters:**

| Param | Type | Default | Description |
|---|---|---|---|
| `page` | integer | 1 | Page number (1-indexed) |
| `per_page` | integer | 25 | Results per page. Allowed: 10, 25, 50, 100. |
| `sort_by` | string | `entry_timestamp` | Column to sort by |
| `sort_dir` | string | `desc` | `asc` or `desc` |
| `q` | string | null | Full-text search query |
| `instrument` | string[] | null | Comma-separated instrument codes |
| `playbook_id` | UUID[] | null | Comma-separated playbook IDs |
| `direction` | string | null | `LONG` or `SHORT` |
| `outcome` | string | null | `winner`, `loser`, `breakeven` |
| `setup_type` | string | null | `break` or `bounce` |
| `signal_source` | string[] | null | Comma-separated sources |
| `trendline_grade` | string[] | null | Comma-separated grades |
| `emotional_state` | string[] | null | Comma-separated tags |
| `mistakes` | string[] | null | Comma-separated tags |
| `conviction_min` | integer | null | Min conviction (1-5) |
| `conviction_max` | integer | null | Max conviction (1-5) |
| `r_min` | decimal | null | Min R-multiple |
| `r_max` | decimal | null | Max R-multiple |
| `pnl_min` | decimal | null | Min net P&L |
| `pnl_max` | decimal | null | Max net P&L |
| `session_type` | string | null | `rth` or `overnight` |
| `exit_type` | string[] | null | Comma-separated exit types |
| `date_from` | date | null | Start date (inclusive, ISO 8601) |
| `date_to` | date | null | End date (inclusive, ISO 8601) |
| `has_screenshots` | boolean | null | Filter by screenshot presence |
| `has_notes` | boolean | null | Filter by note presence |

**Response 200:**
```json
{
  "data": [
    {
      "id": "uuid",
      "trade_id": "uuid",
      "instrument": "MNQ",
      "direction": "LONG",
      "entry_price": 4500.00,
      "exit_price": 4510.00,
      "entry_timestamp": "2026-02-10T14:30:00Z",
      "quantity": 2,
      "gross_pnl": 40.00,
      "net_pnl": 35.80,
      "actual_r_multiple": 2.50,
      "mae_ticks": 5,
      "mfe_ticks": 20,
      "hold_duration": "PT45M",
      "conviction": 4,
      "compliance_score": 90.0,
      "mistakes": ["entered_early"],
      "screenshot_count": 2,
      "status": "complete"
    }
  ],
  "meta": {
    "page": 1,
    "per_page": 25,
    "total": 142,
    "total_pages": 6
  },
  "summary": {
    "total_pnl": 1250.40,
    "avg_r_multiple": 1.35,
    "win_rate": 62.5,
    "trade_count": 142
  }
}
```

**Error responses:**

| Status | Condition | Body |
|---|---|---|
| 400 | Invalid `per_page` value | `{"error": "per_page must be one of: 10, 25, 50, 100"}` |
| 400 | `date_from` > `date_to` | `{"error": "Start date must be before or equal to end date."}` |
| 400 | Invalid `conviction_min`/`max` | `{"error": "Conviction must be between 1 and 5."}` |
| 401 | Missing or invalid auth token | `{"error": "Authentication required."}` |
| 429 | Rate limit exceeded | `{"error": "Rate limit exceeded. Try again in {n} seconds."}` |

#### 5.2.2 GET `/api/v1/journal/{id}`

**Response 200:** Full journal entry object including:
- All trade auto-populated fields
- All enrichment fields (conviction, emotions, notes, mistakes, compliance)
- Trendline metadata (if trendline-sourced)
- Screenshots array with signed URLs
- Related trades array
- Edit history

**Error responses:**

| Status | Condition | Body |
|---|---|---|
| 401 | Not authenticated | `{"error": "Authentication required."}` |
| 403 | Entry belongs to another user | `{"error": "You do not have permission to access this journal entry."}` |
| 404 | Entry not found | `{"error": "Journal entry not found."}` |

#### 5.2.3 PATCH `/api/v1/journal/{id}`

**Request body (all fields optional):**
```json
{
  "conviction": 4,
  "emotional_state": ["confident", "patient"],
  "pre_trade_thesis": "Strong 4H break of descending trendline...",
  "post_trade_review": "Entry was clean, held to target...",
  "general_notes": "Volume confirmed the break.",
  "mistakes": ["entered_early"],
  "mistake_details": {
    "entered_early": { "cost_estimate": 25.00, "note": "Entered 2 ticks before close confirmation" }
  },
  "compliance_checklist": [
    { "rule": "3+ touches?", "checked": true, "note": "" },
    { "rule": "Spacing >= 6?", "checked": false, "note": "Only 4 candles" }
  ],
  "playbook_id": "uuid"
}
```

**Validation errors (400):**

| Condition | Error Message |
|---|---|
| `conviction` outside 1-5 | `"Conviction must be between 1 and 5."` |
| `conviction` non-integer | `"Conviction must be a whole number."` |
| Note field > 5,000 chars | `"'{field_name}' exceeds maximum length of 5,000 characters."` |
| Unknown emotional tag | `"Unknown emotional tag: '{tag}'. Create it as a custom tag first."` |
| Unknown mistake tag | `"Unknown mistake tag: '{tag}'. Create it as a custom tag first."` |
| Mistake tags on open trade | `"Mistake tagging is only available after the trade closes."` |
| Attempt to modify system field | `403: "This field is system-generated and cannot be modified."` |
| Cost estimate < 0 | `"Cost estimate must be zero or positive."` |

**Response 200:** Updated journal entry object.

#### 5.2.4 POST `/api/v1/journal/{id}/screenshots`

**Request:** `multipart/form-data` with fields:
- `file` (required): Image file (PNG, JPEG, WebP)
- `caption` (optional): String, max 500 characters

**Validation errors (400/413):**

| Condition | Status | Error Message |
|---|---|---|
| Invalid file type | 400 | `"Unsupported file format. Please upload PNG, JPEG, or WebP images."` |
| File > 10 MB | 413 | `"File exceeds 10 MB limit. Please reduce the image size."` |
| 10 screenshots already exist | 400 | `"Maximum 10 screenshots per trade. Delete an existing screenshot to add a new one."` |
| Storage quota exceeded | 400 | `"Storage quota exceeded. Upgrade your plan or delete existing screenshots."` |
| Caption > 500 chars | 400 | `"Caption exceeds maximum length of 500 characters."` |

**Response 201:**
```json
{
  "id": "uuid",
  "original_url": "https://...signed-url...",
  "thumbnail_url": "https://...signed-url...",
  "caption": "Entry candle close",
  "sort_order": 3
}
```

#### 5.2.5 POST `/internal/journal/create`

**Internal endpoint — not user-facing. Called by Celery worker on `trade.fill.confirmed` event.**

**Request body:**
```json
{
  "trade_id": "uuid",
  "user_id": "uuid",
  "signal_id": "uuid or null",
  "trendline_id": "uuid or null"
}
```

**Behavior:** Creates a `journal_entries` record with `status = 'draft'`, populates auto-fields, and returns success. Idempotent: if a journal entry already exists for the `trade_id`, returns 200 with the existing entry.

**Response 201 (created) / 200 (already exists):**
```json
{ "journal_entry_id": "uuid", "status": "draft", "created": true }
```

### 5.3 WebSocket Events

| Event | Direction | Payload | Description |
|---|---|---|---|
| `journal.entry.created` | Server → Client | `{ journal_entry_id, trade_id, instrument, direction }` | New journal entry created from fill |
| `journal.entry.updated` | Server → Client | `{ journal_entry_id, updated_fields[] }` | Entry updated (status change, enrichment) |
| `journal.entry.completed` | Server → Client | `{ journal_entry_id, trade_id, net_pnl, actual_r_multiple }` | Trade closed, entry finalized |

---

## 6. UI/UX Specifications

### 6.1 Trade Detail View Layout

The trade detail view (`/journal/{id}`) is a single scrollable page with the following sections in order:

#### Section 1: Header Bar

| Element | Display | Behavior |
|---|---|---|
| Instrument + Direction | `"MNQ LONG"` or `"CL SHORT"` | Large bold text, direction colored (green=LONG, red=SHORT) |
| Date | `"Feb 10, 2026 2:30 PM ET"` | Formatted in user's timezone |
| P&L Badge | `"+$35.80"` (green) or `"-$22.50"` (red) | Rounded rectangle, color-coded |
| R-Multiple Badge | `"+2.5R"` or `"-1.0R"` | Adjacent to P&L badge |
| Playbook Name | `"A+ Trendline Break"` | Clickable pill/chip; links to playbook detail |
| Trendline Grade | `"A+"` in gold badge | Only shown if trendline-sourced |

#### Section 2: Execution Summary Card

Two-column layout:

| Left Column | Right Column |
|---|---|
| Entry: `4500.00 @ Feb 10 14:30 ET` | Exit: `4510.00 @ Feb 10 15:15 ET` |
| Signal Price: `4499.75` | Exit Type: `Take Profit` |
| Slippage: `+1 tick ($1.00)` | Duration: `45 min` |
| Quantity: `2 contracts` | Commission: `$4.20` |
| | Gross P&L: `$40.00` / Net P&L: `$35.80` |

#### Section 3: Risk Analysis Card

| Element | Display |
|---|---|
| Planned Stop | `4490.00 (40 ticks)` |
| Planned Target | `4520.00 (80 ticks)` |
| Planned R:R | `2.0:1` |
| Actual R-Multiple | `+2.5R` |
| MAE | `5 ticks / $5.00 / 0.13R` (with timestamp) |
| MFE | `20 ticks / $20.00 / 0.50R` (with timestamp) |
| MAE/MFE Sparkline | Mini line chart of unrealized P&L over trade duration |

The sparkline shows unrealized P&L on the Y axis and time on the X axis. MAE and MFE points are marked with dots.

#### Section 4: Trendline Context Card

Shown only when `signal_source = 'trendline_engine'`. Hidden otherwise with no empty placeholder.

| Element | Display |
|---|---|
| Trendline Grade | `A+` (colored badge: gold=A+, silver=A, bronze=B) |
| Touch Count | `4 touches` |
| Slope | `32.5 degrees` |
| Duration | `28 days` |
| Candle Spacing | `Avg: 8.5 / Min: 6` |
| Break Volume | `1,234 contracts` |
| Distance from Line | `3 ticks` |

#### Section 5: Session Context Card

| Element | Display |
|---|---|
| Session | `RTH` or `Overnight` (colored chip) |
| Day of Week | `Tuesday` |
| Time Bucket | `Morning (9:30-12:00 ET)` |
| Margin Type | `Day Trade` or `Overnight` |

#### Section 6: Discretionary Data Card

| Element | Display | Interaction |
|---|---|---|
| Conviction | Star rating (1-5 filled stars) | Click to change |
| Emotional State | Chip/pill display of selected tags | Click "Edit" to modify |
| Mistakes | Chip display with cost in parentheses, e.g., `"entered_early ($25.00)"` | Click "Edit" to modify |
| Compliance | Checklist with checkmarks/X marks, score percentage | Click "Edit" to modify |

When no discretionary data has been entered, each subsection shows: `"Not yet recorded"` with an "Add" button.

#### Section 7: Notes Section

Three collapsible panels, each with heading and edit button:

| Panel | Heading | Empty State |
|---|---|---|
| Pre-Trade Thesis | `"Pre-Trade Thesis"` | `"No thesis recorded. Add your reasoning for entering this trade."` |
| Post-Trade Review | `"Post-Trade Review"` | `"No review recorded. Reflect on this trade's outcome."` |
| General Notes | `"Notes"` | `"No notes. Add observations or context."` |

Content rendered as Markdown. Edit mode: textarea with Markdown preview toggle.

#### Section 8: Screenshots Gallery

- Thumbnail grid (3 columns desktop, 2 columns tablet, 1 column mobile).
- Click thumbnail to open full-size in a lightbox with annotation overlay.
- "Add Screenshot" button (drag-and-drop zone below thumbnails).
- "Annotate" button on each thumbnail.
- Empty state: `"No screenshots. Upload chart images to document this trade visually."`.

#### Section 9: Related Trades Section

Table of linked trades showing: instrument, direction, entry date, P&L, link type.

- "Link Trade" button opens a search modal to find and link trades.
- Empty state: `"No related trades."`.

#### Metadata Footer

Small text at bottom: Signal Source, Signal ID, Trade ID, Created timestamp, Last Modified timestamp. "Export PDF" and "Edit" action buttons.

### 6.2 UI States

| State | List View Behavior | Detail View Behavior |
|---|---|---|
| Loading | Skeleton table rows (5 rows, pulsing) | Skeleton cards (pulsing) |
| Empty (no trades at all) | `"No trades recorded yet. Trades will appear here automatically when they fill."` | N/A |
| Empty (filters active) | `"No trades match your filters."` + "Clear all filters" button | N/A |
| Error (API failure) | `"Unable to load trades. Please try again."` + "Retry" button | `"Unable to load trade details. Please try again."` + "Retry" button |
| Draft trade (still open) | Shown with italic text and `"Open"` status badge | Grayed-out exit fields, MAE/MFE updating live, mistake tags disabled |

---

## 7. Integration Specifications

### 7.1 Execution Pipeline Integration

**Provider:** Internal (FSD-003)
**Connection:** Async event via Celery task queue (Redis broker)
**Event:** `trade.fill.confirmed`

**Event payload schema:**
```json
{
  "event_type": "trade.fill.confirmed",
  "trade_id": "uuid",
  "user_id": "uuid",
  "signal_id": "uuid or null",
  "instrument": "MNQ",
  "direction": "LONG",
  "fill_price": 4500.00,
  "fill_quantity": 2,
  "fill_timestamp": "2026-02-10T14:30:00Z",
  "broker_order_id": "string",
  "is_partial": false,
  "is_paper": false
}
```

**Error handling:**

| Error | Cause | Response |
|---|---|---|
| Event missing `trade_id` | Malformed event | Log error `"Malformed fill event: missing trade_id"`, discard event |
| Trade record not found in DB | Race condition | Retry with 2-second delay, up to 3 attempts |
| Database unavailable | Infra outage | Queue event for retry, alert via Telegram |

**Fallback:** If journal creation fails after all retries, the daily reconciliation job (Section 3.1.3) catches the gap.

### 7.2 Broker Real-Time Data Integration

**Provider:** Interactive Brokers (via IBKR adapter, FSD-003)
**Connection:** WebSocket price stream
**Purpose:** MAE/MFE tick-by-tick tracking

**Behavior:**
1. On journal entry creation for an open trade, subscribe to `{instrument}` price stream.
2. Process each tick per the MAE/MFE algorithm (Section 3.4).
3. Buffer updates in Redis; flush to PostgreSQL every 10 seconds.
4. On trade close, unsubscribe from price stream.

**Fallback on disconnect:**

| Duration of Disconnect | Action |
|---|---|
| < 30 seconds | Reconnect automatically; gap is minor |
| 30s - 5 minutes | Switch to 1-minute OHLC bar fallback; set `mae_mfe_source = '1m_bar'` |
| > 5 minutes | Set `mae_mfe_source = 'estimated'`; estimate from post-trade historical data on close |

### 7.3 Supabase Storage Integration

**Provider:** Supabase Storage (S3-compatible)
**Purpose:** Screenshot storage and retrieval

**Bucket configuration:**
- Bucket name: `journal-screenshots`
- Access: Private (no public access)
- File path pattern: `{user_id}/{trade_id}/{timestamp}_{original_filename}`

**Signed URL behavior:**
- Upload URLs: 5-minute expiry, single use
- Download URLs: 1-hour expiry, generated on each access request
- URL generation requires authenticated API call with user_id matching the file path

**Quota enforcement:**
- Before upload, query total user storage: `SELECT SUM(file_size_bytes) FROM journal_screenshots WHERE user_id = ?`
- Compare against tier limit. Reject if exceeding with error message specified in Section 3.5.6.

### 7.4 Playbook System Integration

**Provider:** Internal (FSD-005)
**Purpose:** Compliance checklist loading and playbook assignment

**Behavior:**
1. When a journal entry is opened for a closed trade with an assigned `playbook_id`, fetch the playbook's compliance rules.
2. If the `compliance_checklist` field is empty (first view), populate it with the playbook's rules template (all unchecked).
3. If the playbook is later changed (user re-assigns), prompt: `"Changing the playbook will reset the compliance checklist. Continue?"`.
4. On confirmation, clear the existing checklist and load the new playbook's rules.

---

## 8. Security Specifications

### 8.1 Authentication and Authorization

| Requirement | Implementation |
|---|---|
| Authentication | Supabase Auth JWT required on all endpoints. Token validated at middleware layer before handler execution. |
| User isolation (application) | Every query includes `WHERE user_id = {authenticated_user_id}`. No endpoint can return another user's data. |
| User isolation (database) | Phase 3: PostgreSQL RLS policies on all journal tables enforce `user_id = auth.uid()`. |
| Screenshot access | No direct URL access. All access via signed URLs generated after auth + authz check. |
| Signed URL scoping | Each signed URL is scoped to a specific file and expires after 1 hour. |

### 8.2 Rate Limiting

| Operation Type | Limit | Error Response |
|---|---|---|
| Read operations (GET) | 100 requests/minute/user | `429: "Rate limit exceeded. Try again in {n} seconds."` |
| Write operations (PATCH, POST, DELETE) | 30 requests/minute/user | Same as above |
| Export operations (CSV, PDF) | 10 requests/minute/user | Same as above |

### 8.3 Data Protection

| Aspect | Mechanism |
|---|---|
| Data at rest | AES-256 encryption via Supabase managed encryption (PostgreSQL + Storage) |
| Data in transit | TLS 1.2+ for all API and storage communication |
| WebSocket security | WSS (WebSocket Secure) for real-time updates |
| EXIF stripping | GPS and sensitive EXIF metadata stripped from uploaded screenshots during server-side processing |
| Logging safety | Journal notes, trade data never included in application logs or error reports |
| Export safety | CSV/PDF generated and streamed to client; never stored server-side |
| Backup encryption | Database backups encrypted, stored in separate geographic region |

### 8.4 Input Validation

| Field | Validation | Rejection Message |
|---|---|---|
| Note fields | Max 5,000 chars; sanitized for XSS (HTML stripped on server) | `"'{field}' exceeds maximum length of 5,000 characters."` |
| Caption | Max 500 chars; sanitized for XSS | `"Caption exceeds maximum length of 500 characters."` |
| Custom tag value | 1-50 chars, alphanumeric + spaces, stored lowercase | `"Tag must be 1-50 characters, letters, numbers, and spaces only."` |
| Conviction | Integer 1-5 | `"Conviction must be between 1 and 5."` |
| Cost estimate | Decimal >= 0 | `"Cost estimate must be zero or positive."` |
| File uploads | PNG/JPEG/WebP only, max 10 MB | See Section 3.5.6 error messages |
| UUID parameters | Valid UUID v4 format | `"Invalid ID format."` |
| Date parameters | ISO 8601 date format | `"Invalid date format. Use YYYY-MM-DD."` |

---

## 9. Performance Specifications

### 9.1 Latency Targets

| Operation | Target (p95) | Target (p99) | Measurement Point |
|---|---|---|---|
| Journal entry creation | < 5 seconds | < 10 seconds | Event receipt to DB write (`created_at`) |
| Trendline metadata attachment | < 30 seconds | < 60 seconds | Async, after entry creation |
| Thumbnail generation | < 5 seconds | < 10 seconds | Upload completion to thumbnail available |
| Search/filter query | < 500 ms | < 1,000 ms | Server-side query execution + serialization |
| Trade detail view load | < 1,000 ms | < 2,000 ms | Navigation to fully interactive page (excl. full-size screenshots) |
| MAE/MFE update frequency | Every 1 second | N/A | During market hours with real-time data |
| CSV export (1,000 trades) | < 10 seconds | < 15 seconds | Request to download start |
| PDF export (single trade) | < 10 seconds | < 15 seconds | Request to download start |
| PDF export (1,000 trades summary) | < 30 seconds | < 45 seconds | Request to download start |

### 9.2 Throughput Targets

| Metric | Phase 1 | Phase 3 |
|---|---|---|
| Concurrent journal users | 1 | 100+ |
| Max trades in search index | 10,000 per user | 10,000 per user |
| Max total trades in system | 10,000 | 1,000,000 |
| Concurrent MAE/MFE subscriptions | 5 (max open positions) | 500 |

### 9.3 Storage Targets

| Resource | Limit | Enforcement |
|---|---|---|
| Screenshots per entry | 10 | Application-level check before upload |
| Screenshot file size | 10 MB | Client-side + server-side validation |
| User storage (Free) | 5 GB | Pre-upload quota check |
| User storage (Trader) | 25 GB | Pre-upload quota check |
| User storage (Pro) | 100 GB | Pre-upload quota check |
| User storage (Team) | 500 GB | Pre-upload quota check |
| Saved filter presets | 20 per user | Application-level check |
| Custom tags (per type) | 20 per user | Application-level check |
| Note field length | 5,000 chars | Application-level check |
| Edit history entries | Unlimited | No cap; JSONB array grows |

### 9.4 Caching Strategy

| Data | Cache Location | TTL | Invalidation |
|---|---|---|---|
| Search results | Redis (Upstash) | 30 seconds | On any journal write for the user |
| Filter presets | Redis (Upstash) | 5 minutes | On preset create/update/delete |
| Signed download URLs | In-memory (per request) | Not cached (generated fresh, 1-hour expiry) | N/A |
| Column preferences | localStorage (client) | Indefinite | Synced to server on change |
| Contract specifications | Redis (Upstash) | 24 hours | Manual invalidation on spec change |

---

## 10. Testing Specifications

### 10.1 Auto-Journal Creation Tests

#### TC-001: Fill-to-Journal Creation

| ID | Scenario | Input | Expected Result | Priority |
|---|---|---|---|---|
| TC-001a | Trendline engine signal fill | `trade.fill.confirmed` with `signal_source=trendline_engine` | Journal entry created in < 5s with all auto fields populated and trendline metadata attached | P0 |
| TC-001b | TradingView webhook signal fill | `trade.fill.confirmed` with `signal_source=tradingview_webhook` | Journal entry created with `signal_source = 'tradingview_webhook'`, no trendline metadata | P0 |
| TC-001c | Manual trade fill | `trade.fill.confirmed` with `signal_source=manual` | Journal entry created, signal/trendline fields are NULL | P0 |
| TC-001d | Partial fills consolidated | Three partial fills for same `signal_id` (qty 1,1,1) | Single journal entry with `quantity=3`, `entry_price=VWAP` | P0 |
| TC-001e | Simultaneous fills, different instruments | Two `trade.fill.confirmed` events for MNQ and CL | Two separate journal entries, one per instrument | P0 |
| TC-001f | Journal service outage then recovery | Fill event + DB unavailable for 10s | Retry succeeds, entry created within 60s | P0 |
| TC-001g | Duplicate fill event (idempotency) | Same `trade.fill.confirmed` sent twice | Only one journal entry exists; second attempt logged as warning | P0 |
| TC-001h | Fill with missing signal record | `signal_id` references nonexistent signal | Entry created without signal metadata; warning logged | P1 |
| TC-001i | Fill with missing trendline record | `trendline_id` references nonexistent trendline | Entry created without trendline metadata; warning logged | P1 |

#### TC-002: Data Population Accuracy

| ID | Scenario | Input Values | Expected Calculation |
|---|---|---|---|
| TC-002a | Slippage (LONG) | Signal: 4500.00, Fill: 4500.50, Tick size: 0.25 | `slippage_ticks = 2.0` |
| TC-002b | Slippage (SHORT) | Signal: 75.50, Fill: 75.52, Tick size: 0.01 | `slippage_ticks = 2.0` |
| TC-002c | P&L (LONG winner) | Entry: 4500.00, Exit: 4510.00, Qty: 2, Multiplier: $2.00 | `gross_pnl = $40.00` |
| TC-002d | P&L (SHORT winner) | Entry: 75.50, Exit: 74.80, Qty: 1, Multiplier: $10.00 | `gross_pnl = $7.00` |
| TC-002e | P&L (LONG loser) | Entry: 4500.00, Exit: 4490.00, Qty: 1, Multiplier: $2.00 | `gross_pnl = -$20.00` |
| TC-002f | R-multiple (winner) | PNL: +25 ticks, Stop distance: 10 ticks | `actual_r_multiple = +2.5` |
| TC-002g | R-multiple (loser) | PNL: -10 ticks, Stop distance: 10 ticks | `actual_r_multiple = -1.0` |
| TC-002h | Session type RTH | Entry at 10:30 ET Tuesday | `session_type = 'rth'`, `day_of_week = 'Tuesday'`, `time_of_day_bucket = 'morning'` |
| TC-002i | Session type overnight | Entry at 02:00 ET Wednesday | `session_type = 'overnight'`, `day_of_week = 'Wednesday'`, `time_of_day_bucket = 'overnight'` |
| TC-002j | Notional exposure | MNQ at 4500.00, Multiplier: $2.00, Qty: 3 | `notional_exposure = $27,000.00` |
| TC-002k | Net P&L with commission | Gross PNL: $40.00, Commission: $4.20 (2 contracts * $2.10) | `net_pnl = $35.80` |

### 10.2 MAE/MFE Tests

#### TC-003: MAE/MFE Accuracy

| ID | Scenario | Price Sequence (LONG, entry=100) | Expected |
|---|---|---|---|
| TC-003a | Monotonic up | 100, 101, 102, 103 (exit 103) | MAE=0, MFE=3 ticks |
| TC-003b | Dip then rally | 100, 98, 95, 97, 105, 120 (exit 115) | MAE=5 ticks (at 95), MFE=20 ticks (at 120) |
| TC-003c | SHORT spike then drop | Entry=100, prices: 100, 103, 108, 105, 90, 85 (exit 88) | MAE=8 ticks (at 108), MFE=15 ticks (at 85) |
| TC-003d | Multiple excursions | 100, 97, 102, 96, 105, 94, 110 | MAE=6 ticks (at 94), MFE=10 ticks (at 110) |
| TC-003e | MAE timestamp | 100, 98, 95 (at T+2m), 100, 105 | `mae_timestamp` = T+2m |
| TC-003f | 1-minute bar fallback | Bar data: O=100 H=105 L=94 C=102 | MAE=6 (from low), MFE=5 (from high), `mae_mfe_source='1m_bar'` |
| TC-003g | MAE_R calculation | MAE=5 ticks, Stop distance=10 ticks | `mae_r = 0.50` |

### 10.3 Screenshot Tests

#### TC-004: Screenshot Lifecycle

| ID | Scenario | Action | Expected |
|---|---|---|---|
| TC-004a | Valid PNG upload | Upload 5 MB PNG | 201 response, thumbnail generated, both URLs accessible |
| TC-004b | Max size upload | Upload 10 MB JPEG | 201 response (at limit) |
| TC-004c | Oversized file | Upload 11 MB file | 413: `"File exceeds 10 MB limit. Please reduce the image size."` |
| TC-004d | Invalid format | Upload GIF file | 400: `"Unsupported file format. Please upload PNG, JPEG, or WebP images."` |
| TC-004e | 10th screenshot | Upload 10th image to entry | 201 response (at limit) |
| TC-004f | 11th screenshot | Upload 11th image to entry | 400: `"Maximum 10 screenshots per trade. Delete an existing screenshot to add a new one."` |
| TC-004g | Delete screenshot | DELETE endpoint for existing screenshot | 200, file removed from storage, thumbnail removed, DB record deleted |
| TC-004h | Signed URL expiry | Access download URL after 1 hour | URL expired, new URL generated on re-request |
| TC-004i | Annotation persistence | Add annotations, reload page | Annotations render correctly from stored JSON |
| TC-004j | Export annotated | Click "Export Annotated" | Composite PNG downloaded with annotations baked in |
| TC-004k | Storage quota exceeded | Upload when at tier limit | 400: `"Storage quota exceeded. Upgrade your plan or delete existing screenshots."` |

### 10.4 Search and Filter Tests

#### TC-005: Search and Filter Correctness

| ID | Scenario | Filter Config | Expected |
|---|---|---|---|
| TC-005a | Instrument filter | `instrument=MNQ` | Only MNQ trades returned |
| TC-005b | Date range | `date_from=2026-01-01&date_to=2026-01-31` | Only January trades |
| TC-005c | Combined filters | `outcome=winner&instrument=CL` | Only winning CL trades |
| TC-005d | Emotion filter | `emotional_state=fomo` | Trades where `emotional_state` array contains `fomo` |
| TC-005e | Mistake filter | `mistakes=moved_stop` | Trades where `mistakes` array contains `moved_stop` |
| TC-005f | Conviction range | `conviction_min=4&conviction_max=5` | Trades with conviction 4 or 5 only |
| TC-005g | R-multiple range | `r_min=-2.0&r_max=3.0` | Trades with R between -2.0 and 3.0 |
| TC-005h | Full-text search | `q=crude oil thesis` | Entries with matching text highlighted |
| TC-005i | Three+ filters combined | `instrument=MNQ&outcome=loser&session_type=overnight` | Correct intersection |
| TC-005j | No results | Filter that matches zero trades | `"No trades match your filters."` with clear button |
| TC-005k | Performance with 5,000 trades | Any filter on 5,000-trade dataset | Response in < 500ms |

### 10.5 Export Tests

#### TC-006: Export Correctness

| ID | Scenario | Expected |
|---|---|---|
| TC-006a | CSV 100 trades | Valid CSV, all columns present, values match DB |
| TC-006b | CSV special characters | Commas, quotes, newlines properly escaped per RFC 4180 |
| TC-006c | CSV timezone | Timestamps in user's configured timezone with ISO 8601 format |
| TC-006d | PDF summary | Table renders, summary stats match filtered data |
| TC-006e | PDF detail | All sections render, screenshots embedded, Markdown rendered |
| TC-006f | CSV 10,000 trades | Completes within 30 seconds |
| TC-006g | CSV with active filters | Only filtered trades exported, not all |
| TC-006h | CSV > 10,000 trades | `"Export limited to 10,000 trades. Apply filters to reduce the result set."` |

### 10.6 Reconciliation Tests

#### TC-007: Data Integrity

| ID | Scenario | Expected |
|---|---|---|
| TC-007a | Missing journal entry | Trade exists without journal entry | Reconciliation job creates entry within 24 hours |
| TC-007b | All entries present | All trades have journal entries | Job completes with `"0 missing entries created"` |
| TC-007c | Reconciliation logging | Job runs | Log: `"Reconciliation complete: {n} missing entries created out of {total} trades checked."` |

### 10.7 Security Tests

#### TC-008: User Isolation

| ID | Scenario | Expected |
|---|---|---|
| TC-008a | Cross-user journal access | User A requests User B's journal entry by ID | 403: `"You do not have permission to access this journal entry."` |
| TC-008b | Cross-user screenshot access | User A uses User B's signed URL | Access denied (URL scoped to user) |
| TC-008c | RLS enforcement (Phase 3) | Direct SQL query without user_id filter | RLS policy blocks cross-user rows |
| TC-008d | Non-editable field modification | PATCH with `entry_price` in body | 403: `"This field is system-generated and cannot be modified."` |
| TC-008e | Rate limit enforcement | 101 GET requests in 1 minute | 429 on 101st request |

### 10.8 Negative Scenario Tests

| ID | Scenario | Input | Expected |
|---|---|---|---|
| TC-NEG-01 | Invalid conviction value | `conviction: 6` | 400: `"Conviction must be between 1 and 5."` |
| TC-NEG-02 | Conviction non-integer | `conviction: 3.5` | 400: `"Conviction must be a whole number."` |
| TC-NEG-03 | Note too long | 5,001 characters in `pre_trade_thesis` | 400: `"'pre_trade_thesis' exceeds maximum length of 5,000 characters."` |
| TC-NEG-04 | Negative cost estimate | `cost_estimate: -50` | 400: `"Cost estimate must be zero or positive."` |
| TC-NEG-05 | Mistake tag on open trade | Add mistake tag to draft entry | 400: `"Mistake tagging is only available after the trade closes."` |
| TC-NEG-06 | 21st custom tag | Create 21st custom emotional tag | 400: `"Maximum of 20 custom emotional tags reached. Delete an existing tag to add a new one."` |
| TC-NEG-07 | Duplicate custom tag | Create tag that already exists | 400: `"This emotional tag already exists."` |
| TC-NEG-08 | 21st saved filter | Save 21st filter preset | 400: `"Maximum 20 saved filters reached. Delete an existing filter to save a new one."` |
| TC-NEG-09 | Duplicate filter name | Save filter with existing name | 400: `"A filter with this name already exists. Choose a different name."` |
| TC-NEG-10 | Self-link trade | Link trade to itself | 400: `"A trade cannot be linked to itself."` |
| TC-NEG-11 | Duplicate trade link | Link same two trades twice | 400: `"These trades are already linked."` |
| TC-NEG-12 | Invalid date range filter | `date_from=2026-02-28&date_to=2026-02-01` | 400: `"Start date must be before or equal to end date."` |
| TC-NEG-13 | Invalid UUID param | `GET /api/v1/journal/not-a-uuid` | 400: `"Invalid ID format."` |
| TC-NEG-14 | Invalid date format | `date_from=02/10/2026` | 400: `"Invalid date format. Use YYYY-MM-DD."` |
| TC-NEG-15 | Unknown emotional tag | `emotional_state: ["nonexistent_tag"]` | 400: `"Unknown emotional tag: 'nonexistent_tag'. Create it as a custom tag first."` |

---

## 11. Migration & Deployment

### 11.1 Phase Rollout

| Phase | Weeks | Features Deployed | Dependencies Required |
|---|---|---|---|
| Phase 1 | 7-10 | Auto-journal creation, data auto-population, trendline metadata, MAE/MFE, conviction, predefined emotional tags, notes (no version history), basic list/detail views, trade editing, auto trade linking | FSD-003 execution pipeline, FSD-002 trendline engine, broker connection |
| Phase 2 | 9-14 | Screenshots + annotations, mistake tagging, compliance checklist, full search/filtering, CSV/PDF export, manual trade linking, custom tags, note version history, column customization, saved filter presets | FSD-005 playbook system (for compliance), Supabase Storage |
| Phase 3 | 15-18 | RLS policies, signed URL enforcement, storage quotas, rate limiting, reconciliation job, concurrent user support, EXIF stripping | FSD-008 auth system, FSD-009 billing (for tier-based quotas) |

### 11.2 Database Migrations

| Migration | Phase | Description | Rollback Strategy |
|---|---|---|---|
| `001_create_journal_entries` | 1 | Create `journal_entries` table with all columns | DROP TABLE |
| `002_create_journal_indexes` | 1 | Create B-tree and GIN indexes on journal tables | DROP INDEX |
| `003_create_search_trigger` | 1 | Create `search_vector` update trigger | DROP TRIGGER + FUNCTION |
| `004_create_journal_screenshots` | 2 | Create `journal_screenshots` table | DROP TABLE |
| `005_create_trade_links` | 2 | Create `trade_links` table | DROP TABLE |
| `006_create_saved_filters` | 2 | Create `journal_saved_filters` table | DROP TABLE |
| `007_create_custom_tags` | 2 | Create `user_custom_tags` table | DROP TABLE |
| `008_enable_rls` | 3 | Enable RLS and create policies on all journal tables | DROP POLICY + DISABLE RLS |

### 11.3 Feature Flags

| Flag | Default | Purpose |
|---|---|---|
| `journal.auto_create.enabled` | true | Toggle auto-journal creation from fill events |
| `journal.mae_mfe.enabled` | true | Toggle MAE/MFE real-time tracking |
| `journal.screenshots.enabled` | false (Phase 1), true (Phase 2) | Toggle screenshot upload feature |
| `journal.export.enabled` | false (Phase 1), true (Phase 2) | Toggle CSV/PDF export |
| `journal.reconciliation.enabled` | false (Phase 1-2), true (Phase 3) | Toggle daily reconciliation job |
| `journal.rls.enabled` | false (Phase 1-2), true (Phase 3) | Toggle RLS policies |

### 11.4 Monitoring and Alerting

| Metric | Alert Threshold | Channel |
|---|---|---|
| Journal creation latency (p95) | > 10 seconds | Telegram |
| Journal creation failure rate | > 1% of fill events | Telegram (critical) |
| Reconciliation mismatches found | > 0 entries | Telegram |
| Screenshot upload failure rate | > 5% | Telegram |
| Search query latency (p95) | > 1,000 ms | Telegram |
| MAE/MFE price feed disconnects | > 5 minutes | Telegram |
| Storage quota approaching limit | > 80% of tier limit | In-app notification |

---

## 12. Open Questions

| # | Question | Impact | Status |
|---|---|---|---|
| OQ-1 | Should the MAE/MFE sparkline store its data points in the database or compute from historical bars on each view? Storing data points uses more storage but provides instant rendering. | Affects trade detail view load time and storage costs. | Open |
| OQ-2 | Should annotation data be versioned (undo history persisted across sessions), or is session-only undo sufficient? | Affects annotation UX and storage complexity. | Open |
| OQ-3 | How should the system handle journal entries for trades that are modified after close (e.g., broker adjustments, busted trades)? | Affects data integrity policy for non-editable fields. | Open |
| OQ-4 | Should the compliance checklist support weighted rules (some rules more important than others) or treat all rules equally? | Affects compliance score calculation and playbook configuration. | Open |
| OQ-5 | What is the maximum acceptable edit_history array size before performance degrades? Should it be capped or archived? | Affects long-term storage for heavily edited entries. | Open |

---

## 13. Appendices

### Appendix A: Event Flow Diagram

```
Trade Fill Event Flow
=====================

[Broker API] ──fill confirmation──> [Execution Pipeline (FSD-003)]
                                           │
                                           ├──> trade.fill.confirmed event
                                           │
                                           v
                                    [Celery Worker]
                                           │
                                    ┌──────┴──────┐
                                    │             │
                                    v             v
                            [Create Trade    [Subscribe to
                             Record]          Price Feed]
                                    │             │
                                    v             │
                            [Create Journal   │
                             Entry (draft)]   │
                                    │             │
                                    v             v
                            [Attach Trendline  [Track MAE/MFE
                             Metadata]          tick-by-tick]
                                    │             │
                                    v             │
                            [Push WebSocket    │
                             update to UI]     │
                                               │
                                               v
                                    [On Trade Close]
                                           │
                                    ┌──────┴──────┐
                                    │             │
                                    v             v
                            [Finalize        [Write MAE/MFE
                             P&L, R-mult]     to Trade record]
                                    │             │
                                    v             v
                            [Update Journal   [Journal status
                             Entry]            -> complete]
                                    │
                                    v
                            [Push final update
                             to UI via WebSocket]
```

### Appendix B: Glossary

| Term | Definition |
|---|---|
| **MAE** | Maximum Adverse Excursion. The largest unrealized loss during the life of a trade, from entry price. |
| **MFE** | Maximum Favorable Excursion. The largest unrealized profit during the life of a trade, from entry price. |
| **R-Multiple** | Profit or loss as a multiple of initial risk (stop distance). +2.5R means profit = 2.5x the risk. |
| **RTH** | Regular Trading Hours. For CME futures equity index products: 9:30 AM - 4:00 PM ET. |
| **Slippage** | Difference between intended signal price and actual fill price, in ticks. |
| **Safety Line** | In the Tori Trades methodology, an opposing trendline projected forward by 4 candles, used as stop loss. |
| **Tick** | Minimum price increment for a futures contract (e.g., 0.25 for MNQ, 0.01 for CL). |
| **Tick Value** | Dollar value of one tick per contract (e.g., $0.50 for MNQ, $10.00 for CL). |
| **Trade Group** | Collection of related trades (scale-in, scale-out) representing a single trading decision. |
| **Compliance Score** | Percentage of playbook rules followed, from the rule compliance checklist. |
| **VWAP** | Volume-Weighted Average Price. Used to calculate consolidated entry price from partial fills. |

### Appendix C: Cross-Reference Index

| Reference | Document | Section |
|---|---|---|
| Trade execution pipeline | FSD-003 | Trade fill events, order management |
| Trendline detection | FSD-002 | Trendline metadata, grading, touch points |
| Playbook system | FSD-005 | Playbook assignment, compliance rules |
| Performance analytics | FSD-006 | Consumes journal data for dashboards |
| AI trade review | FSD-007 | Consumes journal data for AI analysis |
| Authentication | FSD-008 | JWT auth, user management |
| Billing & subscriptions | FSD-009 | Storage tier limits |
| Frontend dashboard | FSD-011 | Journal UI components |

### Appendix D: Changelog

| Date | Version | Author | Change |
|---|---|---|---|
| 2026-02-11 | 1.0 | Generated by Claude | Initial FSD created from PRD-004 |
