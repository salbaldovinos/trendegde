# FSD-011e: Settings, Onboarding & AI Chat

**TrendEdge -- AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-011e |
| Parent FSD | FSD-011 (Frontend Dashboard & UI/UX) |
| Title | Settings, Onboarding & AI Chat |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-12 |

---

## 1. Introduction

### 1.1 Purpose

This sub-FSD specifies the Settings page (all eight subsections), the Onboarding welcome wizard, the AI conversational chat interface, and the marketing Landing page for the TrendEdge frontend. It provides all UI layouts, interaction flows, validation rules, API contracts, state management, and testing requirements necessary for implementation.

### 1.2 Scope

**In scope:**
- Settings page with tabbed/sidebar navigation and eight subsections: Profile, Trading Preferences, Broker Connections, Notifications, Detection Defaults, Risk Management, Appearance, Data & Privacy
- Onboarding 6-step welcome wizard for new users
- AI Chat conversational analytics interface with streaming responses
- Marketing landing page for unauthenticated users
- Feature flags controlling phased rollout of each feature

**Out of scope:**
- Dashboard widgets and layout (see FSD-011a)
- Trendline chart and detection panel (see FSD-011b)
- Trade journal and execution views (see FSD-011c)
- Analytics and playbooks (see FSD-011d)
- Backend API implementation (see FSD-003, FSD-007, FSD-010)
- Notification engine delivery pipeline (see FSD-010a)

### 1.3 Cross-References

| FSD | Relationship |
|---|---|
| FSD-011a | Dashboard -- shared app shell, sidebar navigation, header |
| FSD-011b | Trendlines -- detection defaults referenced from Settings |
| FSD-011c | Trade execution -- broker connections and risk rules affect execution |
| FSD-011d | Analytics -- AI Chat queries analytics data |
| FSD-003 | Auth -- login/signup, token management, protected routes |
| FSD-005 | Trade execution backend -- broker integration internals |
| FSD-007 | AI features -- Claude API integration, prompt engineering |
| FSD-009 | Billing -- subscription tier gating |
| FSD-010a | Notification engine -- notification preferences drive routing |

---

## 2. System Context

### 2.1 Architecture Position

These features are part of the Next.js 14+ frontend application. All data flows through the BFF (Backend-for-Frontend) pattern:

```
Browser --> Next.js API Route (BFF) --> FastAPI Backend --> PostgreSQL / Redis / External APIs
```

- **Settings** read/write user preferences via REST API calls through the BFF.
- **Onboarding** orchestrates multiple API calls (profile setup, broker connection, playbook creation) in a guided wizard.
- **AI Chat** streams responses from the FastAPI backend, which calls the Claude API with the user's trading data context.
- **Landing Page** is static content rendered via SSG/ISR with no authenticated API calls.

### 2.2 External Dependencies

| Dependency | Used By | Purpose |
|---|---|---|
| FastAPI Backend | Settings, Onboarding, AI Chat | REST API and streaming endpoints |
| Supabase Auth | Settings (profile), Onboarding | User profile and authentication |
| Claude API (via backend) | AI Chat | Natural language analytics queries |
| Cloudflare R2 | Settings (avatar upload) | Avatar image storage |
| Vercel | Landing Page | ISR for dynamic pricing content |

---

## 3. Functional Specifications

### 3.1 Settings Page

**Route**: `/settings`

#### 3.1.1 Settings Navigation

**Source**: FE-FR-040

**Description**: A tabbed or sidebar-within-page layout with multiple settings sections. Each section has its own sub-route.

**Sections**:

| Section | Sub-Route | Icon (Lucide) |
|---|---|---|
| Profile | `/settings/profile` | User |
| Trading Preferences | `/settings/preferences` | SlidersHorizontal |
| Broker Connections | `/settings/brokers` | Link |
| Notifications | `/settings/notifications` | Bell |
| Detection Defaults | `/settings/detection` | TrendingUp |
| Risk Management | `/settings/risk` | Shield |
| Appearance | `/settings/appearance` | Palette |
| Data & Privacy | `/settings/data` | Database |

**Responsive Layout**:
- Desktop (>768px): Vertical sidebar on the left (200px width) with content area on the right. Active section highlighted with `--primary` left border accent (3px) and `--primary` at 10% background.
- Mobile (<768px): Horizontal scrollable tabs at the top. Active tab underlined with `--primary`.

**Default Section**: `/settings/profile` when navigating to `/settings`.

**Keyboard Navigation**: `G` then `S` navigates to settings. Arrow keys move between sidebar items. Enter selects a section.

---

#### 3.1.2 Profile Management

**Source**: FE-FR-041

**Fields**:

| Field | Type | Constraints | Behavior |
|---|---|---|---|
| Display Name | Text input | 2-50 chars, required | Auto-save on blur. Zod validation: `z.string().min(2).max(50)` |
| Email | Text (read-only for OAuth) | Valid email format | Editable with email verification flow if using email auth. Read-only badge "OAuth" if using Google/GitHub login |
| Avatar | Image upload | 2MB max, PNG/JPG only | Circular crop preview (128px). Click to open file picker. Upload via presigned URL to R2 |
| Timezone | Dropdown | 400+ options grouped by region | Auto-detect from browser on first load. Searchable dropdown with region grouping (Americas, Europe, Asia, etc.) |

**Account Info (read-only section)**:
- Subscription tier badge: Free (gray), Trader (blue), Pro (gold). Links to billing page.
- Member since: Date formatted in user's timezone.
- Usage stats: "Trades this month: X", "API calls this month: Y".

**Change Password Action**:
1. Click "Change Password" button.
2. Modal opens with three fields:
   - Current password (password input, required)
   - New password (password input, required)
   - Confirm new password (password input, required)
3. Validation rules:
   - New password >= 8 characters
   - At least 1 uppercase letter
   - At least 1 number
   - Must not match current password
   - Confirm must match new password
4. On submit: `PUT /api/settings/profile` with password fields.
5. Success: Toast "Password updated successfully." Modal closes.
6. Error: Inline error on the modal. "Current password is incorrect." or server validation message.

**Delete Account Action**:
1. Click "Delete Account" button (destructive red text, bottom of profile section).
2. Step 1 dialog: "Are you sure? This will permanently delete all your data."
   - "Would you like to export your data first?" with "Export Data" button.
   - "Cancel" and "Continue" buttons.
3. Step 2 dialog: "Type 'DELETE' to confirm." with text input.
   - Input must exactly match "DELETE" (case-sensitive).
   - "Delete My Account" button disabled until input matches.
4. On confirm: `DELETE /api/account`.
5. Clear all auth cookies and local storage.
6. Redirect to landing page `/`.

**Error Handling**:
- Avatar upload failure: Toast "Unable to upload avatar. Please try again." File picker remains open.
- Profile save failure: Toast "Unable to save profile. Please try again." Fields revert to previous values.

---

#### 3.1.3 Trading Preferences

**Source**: FE-FR-042

| Preference | Type | Default | Options/Validation |
|---|---|---|---|
| Default Instrument | Dropdown | MES | All 8 supported instruments |
| Default Timeframe | Dropdown | 4H | 1H, 4H, D, W |
| Default Order Type | Dropdown | Market | Market, Limit |
| Slippage Assumption (Paper) | Number input (ticks) | 1 | Range 0-10, integer only |
| Auto-Execute Signals | Toggle | Off | On/Off |
| Auto-Execute Delay | Number input (seconds) | 60 | Range 10-300, integer. Only editable when Auto-Execute is On |
| Currency Display | Dropdown | USD | USD (only option for MVP) |

**Save Behavior**: Auto-save on each field change with 1000ms debounce. Toast: "Preference updated." No explicit save button.

**Conditional Logic**: When Auto-Execute is toggled Off, the Auto-Execute Delay field becomes disabled (grayed out, non-editable) and its value is preserved but not sent to the API.

**API**: `PUT /api/settings/preferences` with changed fields only (partial update).

---

#### 3.1.4 Broker Connection Management

**Source**: FE-FR-043

**Connection Card Layout** (for each configured broker):

| Element | Description |
|---|---|
| Broker Logo | 40px square image |
| Broker Name | Text, `text-lg font-semibold` |
| Status Indicator | Green dot = Connected, Red dot = Disconnected, Yellow dot = Error (with message) |
| Account ID | Masked: `****4521` (last 4 digits visible) |
| Last Sync | Relative timestamp ("2 minutes ago") |
| Actions | "Test Connection" button, "Reconnect" button (shown when disconnected), "Remove" button (destructive) |

**Test Connection Flow**:
1. Click "Test Connection" button.
2. Button shows spinner + "Testing..." (disabled during test).
3. API call: `POST /api/brokers/{id}/test`.
4. Success: Green checkmark icon + "Connection successful." (persists for 5 seconds, then reverts to button).
5. Failure: Red X icon + specific error message:
   - "Authentication failed. Please re-enter credentials."
   - "Connection timed out. Check that IB Gateway is running."
   - "Rate limited. Please try again in a few minutes."

**Remove Broker Flow**:
1. Click "Remove" button.
2. Confirmation dialog: "Remove [Broker Name] connection? You will need to re-enter credentials to reconnect."
3. On confirm: `DELETE /api/brokers/{id}`.
4. Toast: "Broker connection removed."
5. Card removed from list with 200ms fade-out animation.

**Add Broker Flow** (4-step wizard):

**Step 1 - Select Broker**:
- Card-based selection: IBKR, Tradovate, Webull.
- Each card shows: broker logo (64px), name, supported features list (checkmarks), commission info.
- Click to select, highlighted with `--primary` border.

**Step 2 - Enter Credentials** (varies by broker):

| Broker | Fields |
|---|---|
| IBKR | Host (text, default "127.0.0.1"), Port (number, default 7497), Client ID (number), Account ID (text). Help link: "How to set up IB Gateway" |
| Tradovate | Username (text), Password (password), App ID (text), App Version (text). Help link: "Tradovate API setup guide" |
| Webull | App Key (text), App Secret (password). Help link: "Webull API setup guide" |

All credential fields use `autocomplete="off"` to prevent browser caching.

**Step 3 - Test Connection**:
- Automatic test on form submission.
- Same success/failure display as Test Connection above.
- On failure: "Edit Credentials" button to return to Step 2. "Try Again" button to re-test.

**Step 4 - Confirm and Save**:
- "Connection successful! Save this broker?" with "Save" button.
- On save: `POST /api/brokers` with broker type and encrypted credentials.
- Connection appears in the list.

**Security Notice**: Displayed prominently at the top of the broker section: "Credentials are encrypted at rest and never stored in plain text." with a Shield icon.

---

#### 3.1.5 Notification Preferences

**Source**: FE-FR-044

**Grid Layout**: Rows = notification types, Columns = channels.

| Notification Type | Dashboard | Telegram | Discord | Email |
|---|---|---|---|---|
| Trendline Break Alert | Toggle | Toggle | Toggle | Toggle |
| Trendline Touch Alert | Toggle | Toggle | Toggle | Toggle |
| New A+ Trendline | Toggle | Toggle | Toggle | Toggle |
| Trade Filled | Toggle | Toggle | Toggle | Toggle |
| Trade Closed | Toggle | Toggle | Toggle | Toggle |
| Daily P&L Summary | Toggle | -- | -- | Toggle |
| Weekly Performance Report | -- | -- | -- | Toggle |
| System Alerts | Toggle | Toggle | -- | Toggle |

**Defaults**: All Dashboard toggles ON. All external channel toggles OFF.

**Channel Setup Cards**:

- **Telegram**: "Configure" button opens an inline card with:
  - Link to TrendEdge Telegram bot (`@TrendEdgeBot`)
  - Text input for Chat ID
  - "Test" button: sends `POST /api/settings/notifications/test` with `channel: "telegram"`
  - Success: "Test message sent! Check your Telegram."
  - Failure: "Unable to send test message. Verify your Chat ID."

- **Discord**: "Configure" button opens an inline card with:
  - Text input for Webhook URL
  - "Test" button: sends same endpoint with `channel: "discord"`
  - Same success/failure pattern.

- **Email**: Pre-configured from user's account email. No setup needed.

**Quiet Hours**:
- Toggle: "Enable Quiet Hours" (default: Off).
- When enabled: Time range picker with start and end time (24h format).
- Default range: 10:00 PM - 7:00 AM (user's timezone).
- When active: All notifications except System Alerts are suppressed during quiet hours. Suppressed notifications are batched and delivered when quiet hours end.
- Supports overnight ranges (e.g., 10 PM - 7 AM crosses midnight).

**Save Behavior**: Auto-save on each toggle change. Toast: "Notification preferences updated."

**API**: `PUT /api/settings/notifications` with full preferences object.

---

#### 3.1.6 Detection Defaults

**Source**: FE-FR-045

| Parameter | Type | Default | Range | Description |
|---|---|---|---|---|
| Minimum Touches | Number | 3 | 2-10 | Minimum touch points to qualify as a trendline |
| Lookback Period | Dropdown | 120 candles | 30, 60, 90, 120, 240 | How far back to scan for trendlines |
| Grade Filter | Multi-select | A+, A | A+, A, B | Which grades to display by default |
| Proximity Alert (ATR) | Number (decimal) | 0.5 | 0.1-2.0 | ATR distance threshold for "near" alerts |

**Save Behavior**: Auto-save on change with 1000ms debounce. Toast: "Detection defaults updated."

**Relationship**: These defaults pre-populate the detection parameters panel on the Trendlines page (FSD-011b). Users can override per-session on the Trendlines page without affecting these saved defaults.

**API**: `PUT /api/settings/detection-defaults`.

---

#### 3.1.7 Risk Management Rules

**Source**: FE-FR-046

| Rule | Type | Default | Range | Description |
|---|---|---|---|---|
| Max Position Size | Number (contracts) | 5 | 1-100 | Maximum contracts per order |
| Max Daily Loss | Dollar amount | $500 | $50-$50,000 | Trading halts when daily loss exceeds this |
| Max Concurrent Positions | Number | 3 | 1-20 | Maximum open positions at once |
| Min R:R Ratio | Number | 2.0 | 0.5-10.0 | Orders below this R:R are rejected |
| Max % Equity at Risk | Percentage | 2% | 0.1%-10% | Max risk per trade as % of equity |
| Correlation Limit | Number | 2 | 1-10 | Max positions in correlated instruments |

**Input Components**: Each rule rendered as a card with:
- Rule name (bold) and description (muted text)
- Numeric input with stepper buttons (+/-)
- Range indicator showing min-max below the input
- Current value highlighted with color coding: green (conservative), yellow (moderate), red (aggressive)

**Enforcement Behavior** (documented here for UI awareness; enforcement is server-side):
1. When a trade would violate a rule, the trade is blocked in the pending signals queue.
2. A yellow warning banner appears on the signal card: "Blocked: [Rule Name] - [specific message]."
   - Example: "Blocked: Max Daily Loss - Daily loss ($480) would exceed $500 limit with this trade."
   - Example: "Blocked: Max Concurrent Positions - You already have 3 open positions."
3. The user can click "Override for this trade" button on the signal card. This logs a warning entry to the audit log and allows the trade to proceed.

**Save Behavior**: Auto-save on change with 1000ms debounce. Toast: "Risk rule updated."

**API**: `PUT /api/settings/risk-rules`.

---

#### 3.1.8 Appearance

**Source**: FE-FR-052

**Theme Toggle**: Three-state selector: Light | Dark | System.
- Default: Dark.
- Visual: Three radio-style cards, each showing a small preview of the theme (miniature dashboard mockup).
- On change: 200ms CSS transition on `background-color` and `color` properties.

**Resolution Order** (on initial page load):
1. Check cookie `theme` (set during SSR to prevent flash).
2. Check `localStorage` key `theme`.
3. Check `prefers-color-scheme` OS media query.
4. Default to `dark`.

**SSR Flash Prevention**: Theme cookie read server-side. Next.js renders the correct theme class on `<html>` element during SSR. No white flash on dark-mode clients.

**Feature Flag**: `NEXT_PUBLIC_ENABLE_LIGHT_MODE` gates the Light mode option. When `false`, only Dark and System options are shown (System falls back to dark if OS preference is light).

**Persistence**: Theme selection saved to both `localStorage` and cookie (for SSR). Auto-save, no explicit save button.

---

#### 3.1.9 Data & Privacy

**Source**: FE-FR-055

**Sections**:

**Data Export**:
- "Export All Data" button: Triggers generation of a ZIP file containing all user data (trades, playbooks, settings, analytics) in JSON format.
- API: `POST /api/settings/export`. Returns a download URL.
- Progress indicator: "Generating export..." spinner. On completion: download starts automatically.
- Estimated time note: "This may take a few minutes for large datasets."

**Data Retention**:
- Read-only informational section listing retention policies:
  - Trade data: Retained indefinitely while account is active
  - Chat history: Session-only (not persisted to database)
  - Notification logs: 90 days
  - Audit logs: 1 year

**Privacy Settings**:
- "Share anonymous usage analytics" toggle (default: On). Controls whether anonymized usage data is sent to Vercel Analytics.

---

### 3.2 AI Chat Interface

**Route**: `/chat`

**Feature Flag**: `NEXT_PUBLIC_ENABLE_AI_CHAT` (default: `false`, Phase 2 feature).

#### 3.2.1 Conversational Analytics Chat

**Source**: FE-FR-049

**Description**: A chat interface for natural language queries against the user's trading data. Read-only analytics -- the chat can never execute trades or modify data.

**Layout**:
- Full page height minus header (56px).
- Chat messages in a scrollable container with auto-scroll to bottom on new messages.
- Input area fixed at the bottom (sticky positioning).
- "New Chat" button in top-right corner to clear conversation history.

**Message Types**:

| Type | Alignment | Styling |
|---|---|---|
| User message | Right-aligned | `--primary` at 20% background, rounded corners (12px), max-width 80%, `text-sm` |
| Assistant message | Left-aligned | `--card` background, rounded corners (12px), max-width 90%, `text-sm` |

**Assistant Message Content Types**:

| Content Type | Rendering |
|---|---|
| Plain text | Rendered with `react-markdown` + `rehype-sanitize`. Supports bold, italic, lists, code blocks. |
| Inline metric cards | Small card components matching analytics metric card design (value, label, delta indicator) |
| Embedded charts | Same chart components as analytics dashboard (equity curves, bar charts). Rendered once data is fully received. |
| Trade lists | Clickable links navigating to `/journal/trade/[id]` trade detail views |
| Tables | Styled data tables using `--card` background, `--border` dividers, `text-xs font-mono` for numbers |

**Input Area**:
- Textarea: Auto-growing from 1 line to max 4 visible lines. Scrollable beyond 4 lines.
- Send button: Arrow icon (Lucide `ArrowUp`), circular (36px), `--primary` background, white icon.
- Send button disabled (grayed out, 50% opacity) when:
  - Input is empty (whitespace-only counts as empty)
  - Awaiting a response (isStreaming === true)
- Keyboard: Enter to send, Shift+Enter for new line.
- Max input length: 500 characters. Character count displayed when > 400 characters.

**Suggested Prompts** (shown on empty chat only):

A 2x3 grid of clickable prompt cards (rounded corners, `--card` background, hover: `--muted` background):

1. "What is my win rate by day of week?"
2. "Show my best and worst trades this month."
3. "Compare my trendline break vs. bounce performance."
4. "How much have my mistakes cost me?"
5. "What is my average R-multiple on A+ setups?"

Clicking a suggested prompt fills the input and immediately sends it.

**Streaming Behavior**:
- API call: `POST /api/chat` with `{ message: string, conversation_id?: string }`.
- Response: Server-Sent Events (SSE) stream.
- Text tokens appear incrementally in the assistant message bubble.
- Charts and metric cards render only after their data is fully received (not token-streamed).
- During streaming: typing indicator (3 bouncing dots) is replaced by the first received token.

**State Machine**:

| State | Display |
|---|---|
| Initial (empty chat) | Suggested prompts grid centered vertically |
| User typed message | Send button enabled (blue) |
| Waiting for response | User message displayed. Below it: 3 bouncing dots animation. Send button disabled. |
| Response streaming | Tokens appearing incrementally in assistant bubble. Send button disabled. |
| Response complete | Full message displayed. Send button re-enabled. |
| Error | Assistant message: "I couldn't find enough data to answer that question. Try being more specific or adjusting the date range." |
| AI Service Unavailable | Assistant message: "AI service unavailable. Please try again in a few minutes." with a "Retry" button. |

**Conversation History**:
- Chat history persists within the current session only (Zustand `useChatStore`).
- `useChatStore` schema: `{ messages: ChatMessage[], isStreaming: boolean, conversationId: string | null }`.
- "New Chat" button clears `messages[]`, resets `conversationId`, shows suggested prompts.
- History is NOT persisted to the database (session-only, per open question Q2).

**Security Constraints** (CRITICAL):
- The chat must NEVER display or reference another user's trading data.
- The chat must NEVER execute trades. It is strictly read-only analytics.
- The chat must NEVER display raw API keys, tokens, or credentials.
- User messages are sanitized before sending to prevent prompt injection.
- The backend enforces data scoping to the authenticated user only.

**Tier Gating**: AI Chat is available to Trader tier and above. Free tier users see a gated state: "Upgrade to Trader to unlock AI Chat" with a CTA button linking to billing.

---

### 3.3 Onboarding Flow

**Route**: `/onboarding`

**Feature Flag**: `NEXT_PUBLIC_ENABLE_ONBOARDING` (default: `false`, Phase 3 feature).

#### 3.3.1 Welcome Wizard

**Source**: FE-FR-047

**Description**: A multi-step guided setup for new users, triggered on first login when `user.onboarding_completed === false`.

**Step Indicator**: Horizontal progress bar at the top of the page.
- Current step: Filled circle with step number, `--primary` color.
- Completed steps: Filled circle with checkmark, `--profit` (green) color.
- Future steps: Outline circle with step number, `--muted` color.
- Labels below each circle: step name in `text-xs`.
- Connecting line between circles: solid for completed, dashed for remaining.

**Layout**: Centered content card (max-width 600px) with step indicator above and navigation buttons below.

---

**Step 1: Welcome**

| Element | Specification |
|---|---|
| Logo | TrendEdge logo, centered, 64px |
| Tagline | "AI-powered futures trading, from detection to journal." `text-lg text-muted-foreground` |
| CTA | "Get Started" button: primary variant, large size (h-12, text-base) |
| Skip | "Skip Setup" text link below button. Navigates to `/dashboard` with empty state guidance banners active |

---

**Step 2: Trading Profile**

| Field | Type | Options | Validation |
|---|---|---|---|
| Experience Level | Radio buttons | Beginner / Intermediate / Advanced | Required. Affects default detection parameter strictness. |
| Primary Instruments | Checkbox grid (2x4) | 8 supported instruments (ES, NQ, MES, MNQ, YM, RTY, CL, GC) | At least 1 required. Error: "Select at least one instrument." |
| Trading Style | Radio buttons | "Trendline Swing" (default), "Systematic/Algo", "Manual Discretionary" | Required |
| Timezone | Dropdown | 400+ timezone options | Auto-detected from browser, editable |

Navigation: "Continue" button (primary), "Back" button (ghost variant).

**Experience Level Effects**:
- Beginner: Stricter detection defaults (min touches: 4, grade filter: A+ only)
- Intermediate: Standard defaults (min touches: 3, grade filter: A+, A)
- Advanced: Relaxed defaults (min touches: 2, grade filter: A+, A, B)

---

**Step 3: Broker Connection (Optional)**

- Reuses the same Add Broker UI from Settings section 3.1.4 but embedded within the wizard card.
- "Skip for now" link with helper text: "You can connect a broker anytime from Settings."
- "Continue" button enabled after successful connection or skip.
- If broker connection fails, error is shown inline with "Try Again" and "Skip" options.

---

**Step 4: First Playbook**

- If "Trendline Swing" was selected in Step 2: Pre-populate with "A+ Trendline Break" playbook fields (name, description, auto-classify rules).
- Explanation card: "Playbooks track the performance of each trading strategy separately." with Lightbulb icon.
- Two action buttons:
  - "Create" (primary): Creates the pre-populated playbook via `POST /api/playbooks`.
  - "Use Default Playbooks" (secondary): Creates all 3 system playbooks (A+ Trendline Break, Trendline Bounce, Manual/Other) via batch API call.
- If not "Trendline Swing" style: Show the playbook creation form with empty fields.

---

**Step 5: Paper Trading Activation**

- Explanation text: "Paper trading lets you test the full system risk-free before going live."
- Recommendation note: "We recommend at least 60 days of paper trading before going live." with info icon.
- "Start Paper Trading" button (primary): Activates paper mode via `POST /api/settings/trading-mode` with `{ mode: "paper" }`.
- Paper mode is activated automatically; no separate confirmation needed.

---

**Step 6: Complete**

- Checkmark icon: green, 64px, centered.
- Heading: "You're all set!" `text-2xl font-bold`.
- Summary card listing:
  - Configured instruments (comma-separated list)
  - Connected broker (name or "None -- you can add one later")
  - Created playbook(s) (names)
  - Mode: "Paper Trading" badge in blue
- "Go to Dashboard" button (primary): Navigates to `/dashboard`. Sets `user.onboarding_completed = true` via API.

**Tracking and Resumption**:
- Onboarding completion status stored in user profile (`onboarding_completed: boolean`, `onboarding_step: number`).
- Users who haven't completed onboarding see a dashboard banner: "Finish your setup" with a "Resume" link.
- Resume navigates to the wizard at the last incomplete step.
- Banner dismissible (sets `onboarding_dismissed: true`) but reappears on next login until completed.

**Skip Behavior**: Skipping any step applies sensible defaults:
- Skip Step 2: Standard defaults (Intermediate, MES, Trendline Swing, auto-detected timezone).
- Skip Step 3: No broker connected.
- Skip Step 4: 3 system playbooks created automatically.
- Skip Step 5: Paper mode activated by default.

All skipped settings are editable later from the Settings page.

---

### 3.4 Landing Page

**Route**: `/` (unauthenticated users only)

**Feature Flag**: `NEXT_PUBLIC_ENABLE_LANDING_PAGE` (default: `false`, Phase 3 feature).

#### 3.4.1 Marketing Landing Page

**Source**: FE-FR-048

**Routing Logic**: Authenticated users hitting `/` are redirected to `/dashboard`. Unauthenticated users see the landing page.

**Sections** (scrolling single page):

| # | Section | Content |
|---|---|---|
| 1 | Hero | Headline + subheadline + "Start Free" CTA button (primary, large) + dashboard screenshot/demo mockup |
| 2 | Problem Statement | "Tired of switching between 3-4 tools?" with icon grid showing fragmented workflow |
| 3 | Feature Sections | 4 sections: Detection, Execution, Journaling, Analytics. Each with screenshot + description. Alternating layout (image-left/image-right). |
| 4 | Comparison Table | TrendEdge vs. competitors (TradingView, Edgewonk, TradeZella). Feature comparison grid with checkmarks/X marks. |
| 5 | Pricing | Tier cards: Free ($0), Trader ($49/mo), Pro ($99/mo), Team ($199/mo). Feature comparison per tier. "Start Free" CTA on each card. |
| 6 | Social Proof | Testimonials/quotes with trader avatars and role descriptions |
| 7 | Footer | Links: Docs, Support, Privacy Policy, Terms of Service. Copyright notice. |

**Header** (landing page specific):
- TrendEdge logo (left)
- Navigation links: Features, Pricing, Docs (scroll to sections or external)
- "Log In" (ghost button) and "Start Free" (primary button) on the right

**Performance Requirements**:
- Lighthouse performance score > 95.
- Static content: No client-side data fetching.
- ISR (Incremental Static Regeneration) for pricing section if pricing data comes from an API.
- Images: Next.js `<Image>` with responsive `sizes`, WebP format, lazy loading below the fold.

**SEO Requirements**:
- Meta tags: title, description, keywords.
- Open Graph tags: og:title, og:description, og:image (dashboard screenshot).
- Structured data: `SoftwareApplication` schema (JSON-LD).
- Target keywords: "futures trading journal", "trendline detection", "automated futures trading".
- Semantic HTML: `<main>`, `<section>`, `<article>`, `<nav>`, `<footer>`.

---

## 4. Data Specifications

### 4.1 TypeScript Interfaces

#### 4.1.1 Settings Data Models

```typescript
interface UserProfile {
  id: string;
  display_name: string;        // 2-50 chars
  email: string;
  avatar_url: string | null;
  timezone: string;            // IANA timezone string
  subscription_tier: "free" | "trader" | "pro" | "team";
  member_since: string;        // ISO 8601
  onboarding_completed: boolean;
  onboarding_step: number;     // 1-6, last completed step
  onboarding_dismissed: boolean;
}

interface TradingPreferences {
  default_instrument: string;  // e.g., "MES"
  default_timeframe: "1H" | "4H" | "D" | "W";
  default_order_type: "market" | "limit";
  slippage_ticks: number;      // 0-10, integer
  auto_execute: boolean;
  auto_execute_delay: number;  // 10-300, seconds
  currency: "USD";
}

interface BrokerConnection {
  id: string;
  broker_type: "ibkr" | "tradovate" | "webull";
  broker_name: string;         // Display name
  status: "connected" | "disconnected" | "error";
  error_message: string | null;
  account_id_masked: string;   // "****4521"
  last_sync: string;           // ISO 8601
  created_at: string;
}

interface NotificationPreferences {
  channels: {
    [notificationType: string]: {
      dashboard: boolean;
      telegram: boolean;
      discord: boolean;
      email: boolean;
    };
  };
  telegram_chat_id: string | null;
  discord_webhook_url: string | null;
  quiet_hours: {
    enabled: boolean;
    start: string;             // "22:00" (24h format)
    end: string;               // "07:00"
  };
}

interface DetectionDefaults {
  min_touches: number;         // 2-10
  lookback_candles: number;    // 30, 60, 90, 120, 240
  grade_filter: ("A+" | "A" | "B")[];
  proximity_alert_atr: number; // 0.1-2.0
}

interface RiskRules {
  max_position_size: number;   // 1-100 contracts
  max_daily_loss: number;      // $50-$50,000
  max_concurrent_positions: number; // 1-20
  min_rr_ratio: number;        // 0.5-10.0
  max_equity_risk_percent: number;  // 0.1-10.0
  correlation_limit: number;   // 1-10
}

interface AppearanceSettings {
  theme: "light" | "dark" | "system";
}

interface PrivacySettings {
  share_analytics: boolean;
}
```

#### 4.1.2 Chat Data Models

```typescript
interface ChatMessage {
  id: string;                  // UUID, generated client-side
  role: "user" | "assistant";
  content: string;             // Plain text or markdown
  content_blocks?: ContentBlock[]; // Rich content (charts, metrics, tables)
  created_at: string;          // ISO 8601
  is_error: boolean;
}

interface ContentBlock {
  type: "metric_card" | "chart" | "trade_list" | "table";
  data: Record<string, unknown>; // Type-specific data payload
}

// Zustand store
interface ChatStore {
  messages: ChatMessage[];
  isStreaming: boolean;
  conversationId: string | null;
  addMessage: (message: ChatMessage) => void;
  appendToLastMessage: (token: string) => void;
  setStreaming: (streaming: boolean) => void;
  clearChat: () => void;
}
```

### 4.2 Data Validation Rules

| Entity | Field | Rule | Error Message |
|---|---|---|---|
| Profile | display_name | 2-50 chars, required | "Display name must be between 2 and 50 characters" |
| Profile | password (change) | Min 8 chars, 1 uppercase, 1 number | "Password must be at least 8 characters with 1 uppercase letter and 1 number" |
| Profile | password (confirm) | Must match new password | "Passwords do not match" |
| Profile | avatar | PNG/JPG, max 2MB | "Please upload a PNG or JPG image under 2MB" |
| Trading Prefs | slippage_ticks | Integer, 0-10 | "Slippage must be between 0 and 10 ticks" |
| Trading Prefs | auto_execute_delay | Integer, 10-300 | "Delay must be between 10 and 300 seconds" |
| Risk Rules | max_position_size | Integer, 1-100 | "Position size must be between 1 and 100 contracts" |
| Risk Rules | max_daily_loss | Number, 50-50000 | "Daily loss limit must be between $50 and $50,000" |
| Risk Rules | max_concurrent_positions | Integer, 1-20 | "Must be between 1 and 20 positions" |
| Risk Rules | min_rr_ratio | Number, 0.5-10.0 | "R:R ratio must be between 0.5 and 10.0" |
| Risk Rules | max_equity_risk_percent | Number, 0.1-10.0 | "Equity risk must be between 0.1% and 10.0%" |
| Detection | min_touches | Integer, 2-10 | "Minimum touches must be between 2 and 10" |
| Detection | proximity_alert_atr | Number, 0.1-2.0 | "Proximity must be between 0.1 and 2.0 ATR" |
| Chat | message input | Max 500 chars | Character count shown at > 400 chars |
| Onboarding | instruments | At least 1 selected | "Select at least one instrument" |
| Account Delete | confirmation | Exact match "DELETE" | "Type DELETE to confirm" |

### 4.3 Client-Side State (Zustand Stores)

| Store | Relevant State | Persisted |
|---|---|---|
| `useAuthStore` | `user.onboarding_completed`, `user.subscription_tier`, `mode` (paper/live) | Cookie (server-side) |
| `useUIStore` | `sidebarCollapsed`, `theme` | localStorage |
| `useChatStore` | `messages[]`, `isStreaming`, `conversationId` | Session only (memory) |

---

## 5. API Specifications

### 5.1 Settings Endpoints

All endpoints require authentication via BFF (httpOnly JWT cookie). All follow the standard response envelope `{ data, meta?, error? }`.

#### 5.1.1 Get All Settings

| Field | Value |
|---|---|
| Method | GET |
| BFF Route | `/api/settings` |
| Backend Route | `/v1/users/me/settings` |
| Auth | Required |
| Description | Returns all user settings in a single response |

**Response** (200):
```json
{
  "data": {
    "profile": { "display_name": "...", "email": "...", ... },
    "preferences": { "default_instrument": "MES", ... },
    "brokers": [ { "id": "...", "broker_type": "ibkr", ... } ],
    "notifications": { "channels": { ... }, "quiet_hours": { ... } },
    "detection_defaults": { "min_touches": 3, ... },
    "risk_rules": { "max_position_size": 5, ... },
    "appearance": { "theme": "dark" },
    "privacy": { "share_analytics": true }
  }
}
```

**Cache**: TanStack Query staleTime: 1 hour, cacheTime: 24 hours.

#### 5.1.2 Update Profile

| Field | Value |
|---|---|
| Method | PUT |
| BFF Route | `/api/settings/profile` |
| Backend Route | `/v1/users/me/profile` |
| Auth | Required |

**Request Body** (partial update):
```json
{
  "display_name": "John Doe",
  "timezone": "America/New_York",
  "avatar_url": "https://r2.example.com/avatars/abc.jpg"
}
```

**Password Change Request**:
```json
{
  "current_password": "...",
  "new_password": "...",
  "confirm_password": "..."
}
```

**Response** (200): Updated profile object.
**Error** (400): `{ "error": { "code": "validation_error", "details": { "display_name": ["Must be 2-50 characters"] } } }`
**Error** (401): `{ "error": { "code": "invalid_password", "message": "Current password is incorrect." } }`

#### 5.1.3 Update Trading Preferences

| Field | Value |
|---|---|
| Method | PUT |
| BFF Route | `/api/settings/preferences` |
| Backend Route | `/v1/users/me/preferences` |
| Auth | Required |

**Request Body** (partial update):
```json
{
  "default_instrument": "ES",
  "auto_execute": true,
  "auto_execute_delay": 30
}
```

#### 5.1.4 Switch Trading Mode

| Field | Value |
|---|---|
| Method | POST |
| BFF Route | `/api/settings/trading-mode` |
| Backend Route | `/v1/users/me/trading-mode` |
| Auth | Required |

**Request Body**:
```json
{
  "mode": "live",
  "acknowledgment": true
}
```

The `acknowledgment` field is required when switching to live mode (user checked the confirmation checkbox). Not required when switching to paper.

**Response** (200): `{ "data": { "mode": "live" } }`
**Side Effect**: Logged to audit log.

#### 5.1.5 Update Detection Defaults

| Field | Value |
|---|---|
| Method | PUT |
| BFF Route | `/api/settings/detection-defaults` |
| Backend Route | `/v1/users/me/detection-defaults` |
| Auth | Required |

**Request Body**:
```json
{
  "min_touches": 3,
  "lookback_candles": 120,
  "grade_filter": ["A+", "A"],
  "proximity_alert_atr": 0.5
}
```

#### 5.1.6 Update Risk Rules

| Field | Value |
|---|---|
| Method | PUT |
| BFF Route | `/api/settings/risk-rules` |
| Backend Route | `/v1/users/me/risk-rules` |
| Auth | Required |

**Request Body**:
```json
{
  "max_position_size": 5,
  "max_daily_loss": 500,
  "max_concurrent_positions": 3,
  "min_rr_ratio": 2.0,
  "max_equity_risk_percent": 2.0,
  "correlation_limit": 2
}
```

#### 5.1.7 Update Notification Preferences

| Field | Value |
|---|---|
| Method | PUT |
| BFF Route | `/api/settings/notifications` |
| Backend Route | `/v1/users/me/notifications` |
| Auth | Required |

**Request Body**:
```json
{
  "channels": {
    "trendline_break": { "dashboard": true, "telegram": true, "discord": false, "email": false },
    "trade_filled": { "dashboard": true, "telegram": false, "discord": false, "email": true }
  },
  "telegram_chat_id": "123456789",
  "discord_webhook_url": null,
  "quiet_hours": {
    "enabled": true,
    "start": "22:00",
    "end": "07:00"
  }
}
```

### 5.2 Broker Endpoints

#### 5.2.1 List Broker Connections

| Field | Value |
|---|---|
| Method | GET |
| BFF Route | `/api/brokers` |
| Backend Route | `/v1/brokers` |
| Auth | Required |

**Response** (200):
```json
{
  "data": [
    {
      "id": "br_abc123",
      "broker_type": "ibkr",
      "broker_name": "Interactive Brokers",
      "status": "connected",
      "account_id_masked": "****4521",
      "last_sync": "2026-02-12T10:30:00Z"
    }
  ]
}
```

#### 5.2.2 Add Broker Connection

| Field | Value |
|---|---|
| Method | POST |
| BFF Route | `/api/brokers` |
| Backend Route | `/v1/brokers` |
| Auth | Required |

**Request Body** (IBKR example):
```json
{
  "broker_type": "ibkr",
  "credentials": {
    "host": "127.0.0.1",
    "port": 7497,
    "client_id": 1,
    "account_id": "DU12345"
  }
}
```

**Response** (201): Created broker connection object.
**Side Effect**: Logged to audit log.

#### 5.2.3 Test Broker Connection

| Field | Value |
|---|---|
| Method | POST |
| BFF Route | `/api/brokers/{id}/test` |
| Backend Route | `/v1/brokers/{id}/test` |
| Auth | Required |

**Response** (200): `{ "data": { "success": true, "latency_ms": 45 } }`
**Error** (422): `{ "error": { "code": "connection_failed", "message": "Authentication failed. Please re-enter credentials." } }`

#### 5.2.4 Remove Broker Connection

| Field | Value |
|---|---|
| Method | DELETE |
| BFF Route | `/api/brokers/{id}` |
| Backend Route | `/v1/brokers/{id}` |
| Auth | Required |

**Response** (204): No content.
**Side Effect**: Logged to audit log.

### 5.3 AI Chat Endpoint

#### 5.3.1 Send Chat Message

| Field | Value |
|---|---|
| Method | POST |
| BFF Route | `/api/chat` |
| Backend Route | `/v1/chat` |
| Auth | Required |
| Response Type | Server-Sent Events (SSE) stream |

**Request Body**:
```json
{
  "message": "What is my win rate by day of week?",
  "conversation_id": "conv_abc123"
}
```

**SSE Stream Events**:

| Event | Data | Description |
|---|---|---|
| `token` | `{ "text": "Your" }` | Single token of text response |
| `content_block` | `{ "type": "chart", "data": { ... } }` | Rich content block (sent as complete JSON) |
| `done` | `{ "conversation_id": "conv_abc123" }` | Stream complete |
| `error` | `{ "code": "insufficient_data", "message": "..." }` | Error during processing |

**Rate Limit**: 20 messages per minute per user. On 429: "You've reached the message limit. Please wait a moment."

**Timeout**: 30 seconds. If no tokens received within 30s, display: "AI service unavailable. Please try again in a few minutes."

### 5.4 Account Deletion Endpoint

| Field | Value |
|---|---|
| Method | DELETE |
| BFF Route | `/api/account` |
| Backend Route | `/v1/users/me` |
| Auth | Required |

**Response** (200): `{ "data": { "deleted": true } }`
**Side Effect**: All user data permanently deleted. Auth cookies cleared. Logged to audit log before deletion.

### 5.5 Data Export Endpoint

| Field | Value |
|---|---|
| Method | POST |
| BFF Route | `/api/settings/export` |
| Backend Route | `/v1/users/me/export` |
| Auth | Required |

**Response** (202): `{ "data": { "export_id": "exp_abc", "status": "processing" } }`

Poll for completion: `GET /api/settings/export/{id}` returns `{ "data": { "status": "ready", "download_url": "https://..." } }` when ready.

---

## 6. UI/UX Specifications

### 6.1 Component Inventory

| Component | Route | Description |
|---|---|---|
| SettingsLayout | `/settings/*` | Sidebar + content area wrapper |
| SettingsSidebar | `/settings/*` | Vertical nav with section links |
| ProfileSection | `/settings/profile` | Profile fields, password change, account deletion |
| TradingPrefsSection | `/settings/preferences` | Trading preference fields with auto-save |
| BrokerSection | `/settings/brokers` | Broker cards + Add Broker wizard |
| BrokerCard | `/settings/brokers` | Individual broker connection card |
| AddBrokerWizard | `/settings/brokers` | 4-step broker setup flow |
| NotificationPrefsSection | `/settings/notifications` | Toggle grid + channel setup + quiet hours |
| DetectionDefaultsSection | `/settings/detection` | Detection parameter fields |
| RiskRulesSection | `/settings/risk` | Risk rule cards with stepper inputs |
| AppearanceSection | `/settings/appearance` | Theme selector cards |
| DataPrivacySection | `/settings/data` | Export button, retention info, privacy toggle |
| ChatPage | `/chat` | Full chat interface |
| ChatMessageList | `/chat` | Scrollable message container |
| ChatMessage | `/chat` | Individual message bubble (user/assistant) |
| ChatInput | `/chat` | Auto-growing textarea + send button |
| SuggestedPrompts | `/chat` | 2x3 grid of prompt cards |
| OnboardingWizard | `/onboarding` | 6-step wizard with progress indicator |
| OnboardingStep | `/onboarding` | Individual step content wrapper |
| LandingPage | `/` | Marketing single-page layout |
| PricingCards | `/` | Tier comparison cards |

### 6.2 Form Patterns

**Auto-Save Pattern** (used across all Settings sections):
1. User modifies a field.
2. 1000ms debounce timer starts.
3. If another change occurs within 1000ms, timer resets.
4. On timer expiry: API call fires.
5. During save: subtle spinner icon next to the field label.
6. On success: Toast "Preference updated." Spinner replaced by checkmark for 2s.
7. On failure: Toast (error) with message. Field reverts to previous value. Spinner replaced by warning icon.

**Wizard Pattern** (used in Add Broker and Onboarding):
1. Step indicator at top showing progress.
2. "Continue" / "Back" buttons at bottom of each step.
3. "Continue" disabled until step validation passes.
4. Step data accumulated in local state, submitted on final step.
5. "Cancel" (Add Broker) or "Skip" (Onboarding) available on each step.

### 6.3 Accessibility Requirements

- All form fields have associated `<label>` elements with `htmlFor` attribute.
- Toggle switches have `role="switch"` and `aria-checked` state.
- Radio button groups wrapped in `<fieldset>` with `<legend>`.
- Chat messages have `role="log"` container and `aria-live="polite"` for streaming responses.
- Keyboard navigation: Tab moves between form fields. Enter activates buttons. Escape closes modals/dialogs.
- All interactive elements have visible focus indicators (2px `--ring` color outline).
- Color is not the only means of conveying status (status dots supplemented with text labels).
- Screen reader: Broker connection status announced as "Connected", "Disconnected", or "Error: [message]".

---

## 7. Integration Specifications

### 7.1 FastAPI Backend (via BFF)

All Settings, Broker, Chat, and Account endpoints are proxied through Next.js API routes. The BFF:
1. Reads the httpOnly JWT cookie.
2. Injects `Authorization: Bearer [token]` into the backend request.
3. On 401 from backend: attempts token refresh. If refresh fails: returns 401 to client, which redirects to `/login`.

**Error Handling**:

| Backend Response | Frontend Behavior |
|---|---|
| 200-299 | Update UI, show success toast |
| 400 | Display inline validation errors |
| 401 | Token refresh attempt; if fails, redirect to `/login` |
| 403 | Toast: "You do not have permission to perform this action." |
| 422 | Display specific validation error |
| 429 | Toast: "Too many requests. Please wait a moment." |
| 500 | Toast: "Something went wrong." Log to Sentry. Show retry. |

### 7.2 Claude API (via Backend, for AI Chat)

The frontend does not call the Claude API directly. The flow:
1. User sends message via `POST /api/chat`.
2. BFF proxies to FastAPI `POST /v1/chat`.
3. FastAPI queries user's trading data, constructs Claude prompt, calls Claude API.
4. FastAPI streams the Claude response back as SSE.
5. BFF streams SSE to the browser.
6. Frontend renders tokens incrementally.

### 7.3 Cloudflare R2 (Avatar Upload)

**Flow**:
1. User clicks avatar upload in Profile settings.
2. Frontend calls `POST /api/uploads/presign` with `{ type: "avatar", content_type: "image/png" }`.
3. BFF returns presigned PUT URL (valid 15 minutes).
4. Frontend uploads directly to R2.
5. Frontend calls `PUT /api/settings/profile` with the new `avatar_url`.

---

## 8. Security Specifications

### 8.1 Authentication

- All settings, chat, and onboarding routes require authentication.
- Landing page is the only publicly accessible route.
- JWT tokens in httpOnly, Secure, SameSite=Strict cookies. Never in localStorage or sessionStorage.

### 8.2 Authorization Matrix

| Role | Action | Resource |
|---|---|---|
| Authenticated User | Read, Update | Own settings only |
| Authenticated User | Create, Read, Delete | Own broker connections only |
| Authenticated User | Create, Read | Own chat conversations only |
| Authenticated User (Trader+) | Access | AI Chat feature |
| Unauthenticated User | Read | Landing page only |
| Any User | N/A | Other users' data (NEVER accessible) |

### 8.3 Sensitive Data Handling

- Broker credentials submitted directly to backend, NEVER stored on frontend.
- Password fields use `type="password"` and `autocomplete="new-password"`.
- Broker credential fields use `autocomplete="off"`.
- Account deletion confirmation ("DELETE") is case-sensitive to prevent accidental triggers.
- AI Chat: user messages sanitized before sending. Backend enforces user data scoping.
- Data export download URLs are time-limited (15 minutes) and scoped to the requesting user.

### 8.4 Audit Logging

The following actions trigger audit log entries (logged by backend):
- Paper/Live mode switches (with timestamp and user confirmation)
- Broker connection add/remove
- Account deletion request
- Risk rule overrides (logged from trade execution, referenced here for awareness)

### 8.5 Input Sanitization

- All form inputs validated client-side using Zod schemas before API submission.
- Chat input sanitized with DOMPurify before rendering in the message list.
- Markdown content in AI responses processed through `react-markdown` with `rehype-sanitize`.
- URL parameters in landing page validated (no raw user input in URLs).

---

## 9. Performance Specifications

### 9.1 Response Time Requirements

| Operation | Target |
|---|---|
| Settings page load (all data) | < 1 second (cached), < 2 seconds (cold) |
| Settings auto-save round-trip | < 2 seconds (1s debounce + 1s API) |
| Broker test connection | < 5 seconds |
| AI Chat first token | < 2 seconds |
| AI Chat full response | < 15 seconds |
| Onboarding step transition | < 500ms (client-side) |
| Landing page LCP | < 2.5 seconds |
| Landing page Lighthouse score | > 95 |

### 9.2 Caching Strategy

| Data | Stale Time | Cache Time |
|---|---|---|
| Settings (all) | 1 hour | 24 hours |
| Broker connections | 5 minutes | 30 minutes |
| Chat messages | N/A (session-only, Zustand) | N/A |

**Cache Invalidation**: Settings cache invalidated on any PUT/POST mutation. Broker list invalidated on add/remove.

### 9.3 Bundle Considerations

| Feature | Loading Strategy |
|---|---|
| Settings page | Standard route chunk (< 50KB) |
| AI Chat page | Dynamic import; only loaded when feature flag enabled |
| Onboarding wizard | Dynamic import; only loaded for users with `onboarding_completed === false` |
| Landing page | Static generation (SSG); no client-side JS for content sections |

---

## 10. Testing Specifications

### 10.1 Unit Tests (Jest + React Testing Library)

| Component | Test Cases |
|---|---|
| ProfileSection | Display name validation (2-50 chars). Password validation rules. Avatar upload rejects > 2MB. Avatar rejects non-image. Delete account requires "DELETE" exact match. |
| TradingPrefsSection | Auto-save fires after 1s debounce. Auto-execute delay disabled when toggle is off. Slippage rejects non-integer. |
| BrokerCard | Correct status indicator colors. Test button shows spinner during test. Remove shows confirmation dialog. |
| AddBrokerWizard | Step progression. Field validation per broker type. Back button preserves data. |
| NotificationPrefsSection | Toggle grid renders correct defaults. Quiet hours picker validates overnight range. Channel test sends correct payload. |
| RiskRulesSection | All range validations. Stepper buttons increment/decrement correctly. Color coding (green/yellow/red) for value ranges. |
| AppearanceSection | Theme toggle changes Zustand store. Light mode hidden when feature flag is false. |
| ChatPage | Suggested prompts shown on empty chat. Prompts hidden after first message. Send disabled during streaming. Enter sends, Shift+Enter inserts newline. |
| ChatMessage | User messages right-aligned. Assistant messages left-aligned. Markdown rendered correctly. Error messages styled differently. |
| OnboardingWizard | Step indicator shows correct progress. Back/Continue navigation. Instruments require at least 1. Skip applies defaults. |
| LandingPage | All 7 sections render. CTA buttons link to signup. Pricing cards show correct tier info. |

### 10.2 End-to-End Tests (Playwright)

| # | Journey | Key Assertions |
|---|---|---|
| E2E-S1 | Settings - Profile | Navigate to settings > update display name > verify toast > change password > verify success toast > avatar upload |
| E2E-S2 | Settings - Notifications | Toggle notification preferences > verify auto-save toast > configure Telegram > test channel > enable quiet hours |
| E2E-S3 | Settings - Brokers | Add IBKR broker > enter credentials > test connection > save > verify in list > test again > remove > confirm removal |
| E2E-S4 | Settings - Risk Rules | Modify max daily loss > verify auto-save > modify R:R ratio > verify range validation |
| E2E-S5 | Settings - Theme | Switch to light mode (if flag enabled) > verify background color change > switch to system > switch back to dark |
| E2E-S6 | AI Chat | Navigate to chat > click suggested prompt > verify streaming response > send custom query > verify response > new chat clears history |
| E2E-S7 | Onboarding | New user login > redirected to onboarding > complete all 6 steps > verify dashboard loads > verify no banner |
| E2E-S8 | Onboarding Skip | New user > skip setup > verify defaults applied > verify dashboard banner "Finish your setup" |
| E2E-S9 | Account Deletion | Navigate to settings > delete account > export data first > type DELETE > confirm > verify redirect to landing |

### 10.3 Visual Regression Tests

**Critical Screenshots** (both dark and light themes):
- Settings page: each of the 8 sections
- AI Chat: empty state with suggested prompts
- AI Chat: conversation with mixed content types
- Onboarding: each of the 6 steps
- Landing page: full page (desktop and mobile viewpoints)

### 10.4 Accessibility Tests

- All settings forms: zero critical/serious axe-core violations.
- Chat: `aria-live="polite"` on message container verified.
- Onboarding: keyboard-only navigation through all 6 steps.
- Landing page: semantic HTML, heading hierarchy, image alt text.

---

## 11. Migration & Deployment

### 11.1 Feature Flags

| Flag | Default | Phase | Controls |
|---|---|---|---|
| `NEXT_PUBLIC_ENABLE_AI_CHAT` | `false` | Phase 2 | AI Chat nav item, `/chat` route, chat API calls |
| `NEXT_PUBLIC_ENABLE_ONBOARDING` | `false` | Phase 3 | Onboarding wizard, dashboard resume banner |
| `NEXT_PUBLIC_ENABLE_LANDING_PAGE` | `false` | Phase 3 | Landing page at `/`, unauthenticated routing |
| `NEXT_PUBLIC_ENABLE_LIGHT_MODE` | `false` | Phase 3 | Light mode option in Appearance settings |

**When a flag is `false`**:
- The corresponding navigation item is hidden from the sidebar.
- The route returns a 404 page.
- Related API calls are not made.
- Related components are not included in the bundle (dynamic import with flag check).

### 11.2 Phased Rollout

| Phase | Timeline | Features from this FSD |
|---|---|---|
| Phase 1 (Weeks 7-8) | Core | Settings page (all 8 sections) with dark mode only |
| Phase 2 (Weeks 9-14) | Analytics & Journaling | AI Chat interface |
| Phase 3 (Weeks 17-18) | Polish & Onboarding | Onboarding wizard, Landing page, Light mode |

### 11.3 Deployment Dependencies

| Dependency | Required Before |
|---|---|
| FastAPI settings endpoints | Settings page (Phase 1) |
| FastAPI broker endpoints | Broker connections (Phase 1) |
| Claude API integration in backend | AI Chat (Phase 2) |
| FastAPI onboarding endpoints | Onboarding wizard (Phase 3) |
| Marketing content and images | Landing page (Phase 3) |

### 11.4 Rollback Procedures

- All features behind feature flags: disable flag to instantly hide the feature without code rollback.
- Vercel instant rollback to previous deployment if needed.
- No database migrations in frontend deployments.
- Settings data is backwards-compatible (new fields have defaults).

---

## 12. Open Questions & Assumptions

### 12.1 Assumptions

| # | Assumption | Impact if Wrong |
|---|---|---|
| A1 | AI Chat conversation history is session-only (not persisted to database). | Would require chat history API, database table, and pagination UI. |
| A2 | Landing page pricing is static at MVP launch. | Would need ISR or API integration for dynamic pricing. |
| A3 | Only 3 broker types are supported at MVP (IBKR, Tradovate, Webull). | Add Broker wizard would need additional credential forms. |
| A4 | Onboarding wizard is only shown to new users (not existing users upgrading). | Would need different entry points for tier upgrades. |
| A5 | Data export produces a single ZIP with JSON files. | Would need additional format options (CSV, PDF) if required. |
| A6 | Detection defaults and risk rules have the same field set for all tiers. | Would need tier-specific field rendering if Pro users have additional options. |

### 12.2 Open Questions

| # | Question | Needed By | Impact |
|---|---|---|---|
| Q1 | Should AI Chat support conversation persistence across sessions? | Phase 2 | Chat history API, database, pagination |
| Q2 | What specific content goes in the Data & Privacy section beyond export and analytics toggle? | Phase 1 | Additional privacy controls |
| Q3 | Should the landing page support A/B testing for headline/CTA variants? | Phase 3 | Vercel Edge Config or similar |
| Q4 | What is the exact list of "correlated instruments" for the Correlation Limit risk rule? | Phase 2 | Risk rule enforcement logic |

---

## 13. Appendices

### 13.1 Related Sub-FSDs

| FSD | Scope |
|---|---|
| FSD-011a | Dashboard layout, widgets, app shell |
| FSD-011b | Trendline chart, detection panel |
| FSD-011c | Trade journal, execution, trade detail |
| FSD-011d | Analytics, playbooks, metrics |
| FSD-011e | **This document** -- Settings, Onboarding, AI Chat, Landing Page |

### 13.2 Keyboard Shortcuts (Settings-Related)

| Shortcut | Action |
|---|---|
| `G` then `S` | Navigate to Settings |
| `G` then `C` | Navigate to AI Chat |

### 13.3 Supported Instruments (MVP)

ES, NQ, MES, MNQ, YM, RTY, CL, GC

---

## Changelog

- 2026-02-12: Initial sub-FSD extracted from FSD-011 -- Generated by Claude

---

*End of FSD-011e: Settings, Onboarding & AI Chat*
