# FSD-010: Notifications & Integrations

**TrendEdge — AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-010 |
| Source PRD | PRD-010 |
| Title | Notifications & Integrations |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-11 |

---

## 1. Introduction

### 1.1 Purpose

This Functional Specification Document (FSD) translates the requirements defined in PRD-010 (Notifications & External Integrations) into precise, implementable specifications. It describes every behavior, state transition, error message, edge case, and data flow that a developer needs to build the TrendEdge notification and integration layer without referencing the PRD.

### 1.2 Scope

**In Scope:**
- Central notification dispatch engine: event subscriptions, channel routing, template rendering, retry logic, rate limiting, quiet hours, circuit breaker, delivery tracking
- Telegram Bot: user linking, alert formatting, interactive commands (`/status`, `/pause`, `/resume`, `/trade`, etc.), manual trade entry
- Discord Webhook: outbound rich embed delivery, daily/weekly summaries, privacy controls
- Email (SendGrid/Resend): transactional emails, daily and weekly digest emails, unsubscribe handling, template management
- TradingView Webhook Receiver: inbound signal ingestion, payload validation, symbol mapping, activity logging
- In-App Notification Center: WebSocket real-time delivery, notification history, read/unread management, badge count
- Market Data Integration: historical OHLCV (yfinance), real-time broker data, caching strategy, continuous contract resolution
- Notification Preferences Management UI: channel configuration, per-event toggles, quiet hours, digest scheduling

**Out of Scope:**
- Push notifications for native mobile apps (Phase 4)
- SMS notifications (not planned)
- Slack integration (potential future addition)
- Pine Script companion indicator development
- Trading strategy logic [Cross-reference: see FSD-002 for trendline detection details]
- Order execution logic [Cross-reference: see FSD-003 for trade execution details]

### 1.3 Relationship to Source PRD

This FSD expands every requirement from PRD-010 (NT-FR-001 through NT-FR-108, NT-NFR-001 through NT-NFR-015, NT-SEC-001 through NT-SEC-015) into fully specified behaviors with exact error messages, state transitions, acceptance criteria, and edge cases.

### 1.4 Cross-References

| FSD | Relationship |
|---|---|
| FSD-001 | Infrastructure: PostgreSQL, Redis, Celery, Supabase Realtime, monitoring |
| FSD-002 | Trendline Detection: domain events `trendline.alert`, `trendline.invalidated` |
| FSD-003 | Trade Execution: domain events `trade.fill`, `trade.rejected`, `trade.closed`; execution pause/resume; signal ingestion for TradingView webhooks |
| FSD-004 | Trade Journaling: trade detail page URLs for notification deep links |
| FSD-005 | Analytics & Performance: P&L data for digest emails |
| FSD-006 | Risk Management: domain events `risk.limit_breach`, `risk.warning` |
| FSD-008 | Authentication & Authorization: user identity, tier resolution, API key management, RLS |
| FSD-009 | Billing & Subscriptions: tier for channel gating, `subscription.changed` event |

---

## 2. System Context

### 2.1 Architecture Position

The Notifications & Integrations module sits as a horizontal layer across TrendEdge. It consumes domain events from every other module (execution engine, risk engine, trendline engine, billing, broker adapters) and fans out to delivery channels. It also accepts inbound signals from TradingView and inbound market data from yfinance, Databento, and broker APIs.

### 2.2 Component Overview

```
                    ┌─────────────────────────────────────────┐
  INBOUND           │         NOTIFICATION ENGINE             │         OUTBOUND
                    │                                         │
  TradingView ──────►  Event Bus (Redis Pub/Sub)              ├──────► Telegram Bot API
  Webhooks          │        │                                │
                    │        ▼                                ├──────► Discord Webhook API
  Broker APIs ──────►  Channel Router                         │
  (IBKR/Tradovate)  │  (tier check, prefs, quiet hours)      ├──────► SendGrid / Resend
                    │        │                                │
  yfinance ─────────►  Template Renderer                      ├──────► In-App (Supabase
  Databento         │  (per-channel formatting)               │         Realtime WebSocket)
                    │        │                                │
                    │        ▼                                ├──────► Custom Webhooks
                    │  Celery Workers                         │         (Team tier)
                    │  (dispatch, retry, rate limit)          │
                    │        │                                │
                    │        ▼                                │
                    │  Notification Log (PostgreSQL)          │
                    └─────────────────────────────────────────┘
```

### 2.3 External Systems

| System | Direction | Protocol | Purpose |
|---|---|---|---|
| Telegram Bot API | Outbound + Inbound | HTTPS REST + Webhook | Send alerts, receive commands |
| Discord Webhook API | Outbound | HTTPS REST | Post embeds to channels |
| SendGrid API | Outbound | HTTPS REST | Send transactional + digest emails |
| Resend API | Outbound | HTTPS REST | Fallback email provider |
| TradingView | Inbound | HTTPS Webhook | Receive trading signals |
| yfinance | Outbound | Python library (HTTP) | Fetch historical OHLCV |
| Databento API | Outbound | HTTPS REST | Fetch intraday data |
| Nasdaq Data Link | Outbound | HTTPS REST | Fetch continuous contract data |
| IBKR TWS API | Bidirectional | TCP/WebSocket | Real-time market data + execution |
| Tradovate API | Bidirectional | WebSocket | Real-time market data + execution |
| Supabase Realtime | Internal | WebSocket (PostgreSQL LISTEN/NOTIFY) | In-app notification delivery |

---

## 3. Functional Specifications

### 3.1 Notification Engine (Central Dispatch)

#### 3.1.1 Event Subscription

**Source:** NT-FR-001, NT-FR-002, NT-FR-003

**Description:** The notification engine subscribes to domain events via Redis Pub/Sub. When a domain event is published, a Celery worker picks it up from the `notifications` queue, resolves the user's preferences and tier, renders templates, and dispatches to the appropriate channels.

**Event Catalog:**

| Event | Source Module | Criticality | Behavior on Receipt |
|---|---|---|---|
| `trade.fill` | Execution engine | Critical | Render fill template, dispatch to all enabled channels. At-least-once delivery required. |
| `trade.rejected` | Execution engine | Critical | Render rejection template with reason. Dispatch immediately. |
| `trade.closed` | Execution engine | Critical | Render close template with P&L. Dispatch immediately. |
| `risk.limit_breach` | Risk engine | Critical | Render breach template. Dispatch immediately. Bypass rate limits and quiet hours (unless user opted out). |
| `risk.warning` | Risk engine | High | Render warning template showing current vs. limit. |
| `trendline.alert` | Trendline engine | High | Render alert template with grade, touch count, slope. |
| `trendline.invalidated` | Trendline engine | Medium | Render invalidation template. |
| `webhook.received` | Webhook receiver | Medium | Render confirmation with mapped symbol. |
| `webhook.error` | Webhook receiver | High | Render error template with failure reason. |
| `account.connection_lost` | Broker adapter | Critical | Render connection lost template. Bypass rate limits and quiet hours. |
| `account.connection_restored` | Broker adapter | High | Render restoration template with downtime duration. |
| `digest.daily` | Celery Beat scheduler | Low | Trigger daily digest generation pipeline. |
| `digest.weekly` | Celery Beat scheduler | Low | Trigger weekly digest generation pipeline. |
| `system.maintenance` | Admin | Medium | Render maintenance window template. |
| `subscription.changed` | Billing | Medium | Update channel availability; render tier change template. |
| `paper.milestone` | Analytics engine | Low | Render milestone template. |

**Event Payload Schema (required fields):**

| Field | Type | Constraints | Description |
|---|---|---|---|
| `event_type` | string | Must match a value from the event catalog above | Identifies the event |
| `user_id` | UUID | Must reference an existing user | Target user |
| `timestamp` | string | ISO 8601 UTC format (e.g., `2026-02-11T19:32:05Z`) | When the event occurred |
| `payload` | object | Event-specific; see Appendix B for examples | Event data |
| `correlation_id` | UUID | Unique per event chain | For distributed tracing |

**Processing Logic:**

1. Celery worker dequeues event from `notifications` queue.
2. Validate event payload schema. If invalid, log error with `correlation_id` and discard. Do NOT retry malformed events.
3. Look up user by `user_id`. If user not found, log warning and discard.
4. Proceed to channel routing (section 3.1.2).

**Error Handling:**
- Redis Pub/Sub connection lost: Celery worker reconnects automatically with exponential backoff (1s, 2s, 4s, 8s, max 30s). Events published during disconnection are lost (Redis Pub/Sub does not persist); producing modules must also write events to a PostgreSQL `event_outbox` table for guaranteed delivery.
- Celery worker crash: Celery acknowledges tasks only after successful processing. Unacknowledged tasks are re-delivered to another worker.
- Unknown `event_type`: Log warning `"Unknown event type: {event_type}, correlation_id: {correlation_id}"`, discard event. Do NOT raise an exception.

**Edge Cases:**
- Duplicate events (same `correlation_id` received twice): The engine SHALL check a Redis set `processed_events` (TTL: 1 hour) before processing. If the `correlation_id` exists, skip processing. This provides idempotency.
- User account deleted between event emission and processing: Discard silently; log at debug level.
- Event payload missing optional fields: Templates must handle missing optional fields gracefully by using default values or omitting the corresponding section.

#### 3.1.2 Channel Routing

**Source:** NT-FR-004, NT-FR-005, NT-FR-006, NT-FR-007

**Description:** After receiving an event, the engine determines which channels to dispatch to based on the user's preferences, subscription tier, and current quiet hours status.

**Processing Logic (executed in order):**

```
Step 1: EVENT DISABLED CHECK
  IF user has explicitly disabled this event_type entirely
  THEN log "Event {event_type} disabled by user {user_id}", STOP.

Step 2: QUIET HOURS CHECK
  IF quiet hours are active for this user (see 3.1.6 for evaluation logic)
  AND event criticality is NOT "Critical"
  THEN set notification status = "deferred", store in deferred queue, STOP.

  IF quiet hours are active
  AND event criticality IS "Critical"
  AND user has bypass_critical = true (default)
  THEN proceed to Step 3.

  IF quiet hours are active
  AND event criticality IS "Critical"
  AND user has bypass_critical = false
  THEN set notification status = "deferred", store in deferred queue, STOP.

Step 3: TIER RESOLUTION
  Resolve user's current subscription tier from the users table.
  Determine available channels for this tier:
    - Free:   [email, in_app]
    - Trader: [email, in_app, telegram]
    - Pro:    [email, in_app, telegram, discord]
    - Team:   [email, in_app, telegram, discord, custom_webhook]

Step 4: PREFERENCE RESOLUTION
  For each available channel:
    IF user has explicitly set a preference for this (event_type, channel) pair
    THEN use that preference (enabled/disabled).
    ELSE use the default preference from the defaults table (see section 3.8.5).

Step 5: CHANNEL CONNECTIVITY CHECK
  For each enabled channel:
    - telegram: verify user has a linked telegram_chat_id
    - discord: verify user has at least one configured webhook_url
    - email: verify user has a verified email address
    - in_app: always available
    - custom_webhook: verify user has at least one configured webhook URL
  Skip channels that are not connected/configured.

Step 6: DISPATCH
  For each resolved channel:
    Create a notification_log entry with status = "queued".
    Render the channel-specific template (see 3.1.3).
    Enqueue a channel-specific Celery dispatch task.
```

**Tier Downgrade Behavior:**

When a `subscription.changed` event indicates a downgrade:

1. Determine which channels are no longer available on the new tier.
2. For each newly unavailable channel, set all preferences for that channel to `disabled`.
3. Send a single email to the user with subject: `"Your TrendEdge notification channels have been updated"` and body listing each disabled channel: `"The following notification channels have been disabled because they are not available on your {new_tier} plan: {channel_list}. Upgrade to re-enable them: {upgrade_url}"`.
4. Log the preference changes in the audit log.

**Tier Upgrade Behavior:**

When a `subscription.changed` event indicates an upgrade:

1. Determine which channels are newly available.
2. Apply default preferences for those channels (do NOT auto-enable; let user configure).
3. Send a notification via email and in-app: `"New notification channels available! Your {new_tier} plan includes {channel_list}. Configure them in Settings > Notifications."`.

**Error Handling:**
- Tier lookup fails (database error): Log error, retry the entire event processing via Celery retry. Do NOT partially dispatch.
- Preference lookup fails: Fall back to default preferences for the user's tier.

**Edge Cases:**
- User has no preferences set at all (new user): Use the complete default preference set (section 3.8.5).
- User's subscription is in a grace period (expired but not yet downgraded): Treat as the previous tier until the billing module explicitly emits `subscription.changed`.
- Event has no template for a specific channel: Skip that channel, log warning `"No template for event {event_type} on channel {channel}"`.

#### 3.1.3 Notification Templates

**Source:** NT-FR-008, NT-FR-009, NT-FR-010, NT-FR-011, NT-FR-012

**Description:** Each event type has a dedicated template per channel. Templates are rendered with event payload data before dispatch.

**Template Storage:**
- Email HTML: Jinja2 templates in `templates/notifications/email/`
- Telegram: Python format strings in `templates/notifications/telegram/`
- Discord: Python format strings producing JSON embed structures in `templates/notifications/discord/`
- In-App: Jinja2 templates (Markdown output) in `templates/notifications/in_app/`

**Template Variable Categories:**

| Category | Variables | Formatting Rules |
|---|---|---|
| Trade | `symbol`, `direction`, `quantity`, `entry_price`, `exit_price`, `stop_loss`, `take_profit`, `pnl_dollars`, `pnl_ticks`, `r_multiple`, `slippage_ticks` | Monetary: `$X,XXX.XX` with comma separators and 2 decimal places. Ticks: instrument tick-size precision. R-multiple: 2 decimal places with sign. |
| Trendline | `instrument`, `touch_count`, `slope_degrees`, `duration_days`, `grade`, `alert_type` | Grade: letter grade (e.g., `A+`). Slope: 1 decimal. Duration: integer days. |
| Account | `daily_pnl`, `weekly_pnl`, `open_positions_count`, `unrealized_pnl`, `daily_loss_remaining` | All monetary values with sign prefix (`+$425.00` or `-$125.00`). |
| Risk | `limit_type`, `current_value`, `limit_value`, `percent_used` | Percent: integer with `%` suffix. Values: monetary format. |
| Meta | `timestamp_utc`, `timestamp_user_tz`, `platform_url`, `trade_id`, `signal_source` | Timestamps: `YYYY-MM-DD HH:MM:SS TZ` (e.g., `2026-02-11 14:32:05 ET`). |

**Telegram `trade.fill` Template (exact format):**

```
FILL: {direction} {quantity} {symbol} @ {entry_price}
Stop: {stop_loss} | Target: {take_profit}
Risk: ${risk_amount} | R:R 1:{rr_ratio}
Source: {signal_source_display}
Time: {timestamp_user_tz}
```

Example rendered output:
```
FILL: BUY 2 MES @ 5,205.25
Stop: 5,190.00 | Target: 5,225.50
Risk: $305.00 | R:R 1:2.03
Source: TradingView Webhook
Time: 2026-02-11 14:32:05 ET
```

**Telegram `trade.closed` Template (exact format):**

```
CLOSED: {exit_direction} {quantity} {symbol} @ {exit_price}
Entry: {entry_price} | P&L: {pnl_sign}${pnl_dollars} ({pnl_sign}{r_multiple}R)
Duration: {duration_display} | Slippage: {slippage_ticks} ticks
Daily P&L: {daily_pnl_sign}${daily_pnl} ({wins}W / {losses}L)
```

Example rendered output:
```
CLOSED: SELL 2 MES @ 5,223.75
Entry: 5,205.25 | P&L: +$370.00 (+1.82R)
Duration: 4h 23m | Slippage: 0.5 ticks
Daily P&L: +$425.00 (3W / 1L)
```

**Fallback Behavior:**
- Every template MUST have a plain-text fallback version.
- If a template variable is missing from the event payload, the template SHALL use a dash (`—`) as placeholder rather than raising an error.
- If a template file is not found, log error `"Template not found: {event_type}/{channel}"` and skip that channel dispatch. Do NOT crash the worker.

**Signal Source Display Mapping:**

| `signal_source` Value | Display Text |
|---|---|
| `tradingview_webhook` | `TradingView Webhook` |
| `trendline_engine` | `Trendline Engine` |
| `manual_telegram` | `Manual (Telegram)` |
| `manual_dashboard` | `Manual (Dashboard)` |
| (unknown/null) | `Unknown Source` |

#### 3.1.4 Delivery Status Tracking

**Source:** NT-FR-013, NT-FR-014, NT-FR-015

**`notification_log` Table Schema:**

| Field | Type | Constraints | Default | Description |
|---|---|---|---|---|
| `id` | UUID | PK | `gen_random_uuid()` | Primary key |
| `user_id` | UUID | FK -> users.id, NOT NULL, INDEX | — | Target user |
| `event_type` | VARCHAR(50) | NOT NULL, INDEX | — | Event that triggered this notification |
| `channel` | VARCHAR(20) | NOT NULL, CHECK IN ('telegram','discord','email','in_app','custom_webhook') | — | Delivery channel |
| `status` | VARCHAR(20) | NOT NULL, CHECK IN ('queued','dispatched','delivered','failed','deferred'), INDEX | `'queued'` | Current delivery status |
| `payload` | JSONB | NOT NULL | — | Rendered notification content |
| `attempt_count` | INTEGER | NOT NULL | `0` | Number of delivery attempts |
| `max_attempts` | INTEGER | NOT NULL | `6` | Maximum attempts (1 initial + 5 retries) |
| `last_error` | TEXT | NULLABLE | `NULL` | Error message from most recent failed attempt |
| `created_at` | TIMESTAMPTZ | NOT NULL, INDEX | `NOW()` | When the notification was created |
| `dispatched_at` | TIMESTAMPTZ | NULLABLE | `NULL` | When sent to the channel adapter |
| `delivered_at` | TIMESTAMPTZ | NULLABLE | `NULL` | When delivery was confirmed |
| `correlation_id` | UUID | NOT NULL, INDEX | — | Links to originating event |

**State Transitions for `notification_log.status`:**

| From State | Event | To State | Action |
|---|---|---|---|
| — | Event received, preferences resolved | `queued` | Create log entry |
| `queued` | Worker picks up dispatch task | `dispatched` | Set `dispatched_at`, increment `attempt_count` |
| `dispatched` | Channel API returns success (2xx) | `delivered` | Set `delivered_at` |
| `dispatched` | Channel API returns error | `queued` | Set `last_error`, schedule retry (if attempts remain) |
| `dispatched` | All retry attempts exhausted | `failed` | Set `last_error`, trigger fallback for Critical events |
| — | Quiet hours active for this notification | `deferred` | Store in deferred queue |
| `deferred` | Quiet hours end | `queued` | Re-enqueue for dispatch |

**Retention Policy:**
- Standard notifications: retained for 90 days, then archived to S3/R2 cold storage.
- Critical event notifications (`trade.fill`, `trade.rejected`, `trade.closed`, `risk.limit_breach`, `account.connection_lost`): retained for 1 year.
- Archival runs daily via Celery Beat task at 03:00 UTC.
- Archived records are removed from PostgreSQL after successful S3/R2 upload confirmation.

**Query API:**
- Admin API: `GET /api/admin/notifications/log` with filters: `user_id`, `event_type`, `channel`, `status`, `date_from`, `date_to`. Paginated (50 per page).
- User API: `GET /api/notifications/history` with filters: `event_type`, `channel`, `status`, `date_from`, `date_to`. Paginated (20 per page). Scoped to authenticated user via RLS.

#### 3.1.5 Retry Logic

**Source:** NT-FR-016, NT-FR-017, NT-FR-018, NT-FR-019

**Retry Schedule:**

| Attempt | Type | Delay After Failure | Cumulative Elapsed |
|---|---|---|---|
| 1 | Initial attempt | — | 0s |
| 2 | 1st retry | 10 seconds | 10s |
| 3 | 2nd retry | 30 seconds | 40s |
| 4 | 3rd retry | 2 minutes | 2m 40s |
| 5 | 4th retry | 10 minutes | 12m 40s |
| 6 | 5th retry (final) | 30 minutes | 42m 40s |

**Implementation:** Celery task with `max_retries=5`, `countdown` parameter set per the schedule above. The countdown values are: `[10, 30, 120, 600, 1800]`.

**After All Retries Exhausted:**

For **Critical** events (`trade.fill`, `trade.rejected`, `trade.closed`, `risk.limit_breach`, `account.connection_lost`):
1. Mark the notification as `failed` in `notification_log`.
2. Attempt fallback delivery through the next available channel in priority order: Telegram > In-App > Email.
3. The fallback notification includes a prefix: `"[DELAYED] "` before the normal message content.
4. If all fallback channels also fail, log a critical alert to the monitoring system (Sentry) with the message: `"CRITICAL: All delivery channels failed for user {user_id}, event {event_type}, correlation_id {correlation_id}"`.

For **non-Critical** events:
1. Mark as `failed` in `notification_log`.
2. No fallback delivery.
3. Log at warning level.

**Circuit Breaker:**

| Parameter | Value |
|---|---|
| Failure threshold | 5 consecutive failures across any user within a 5-minute window per channel |
| Open duration | 2 minutes (all dispatches to that channel are paused) |
| Half-open behavior | After 2 minutes, allow 1 test dispatch. If it succeeds, close the breaker. If it fails, re-open for another 2 minutes. |
| State tracking | Redis key: `circuit_breaker:{channel}` with values `closed`, `open`, `half_open` |
| Monitoring | Every circuit breaker state change emits a metric and triggers an alert |

**Circuit Breaker State Transitions:**

| From | Condition | To | Action |
|---|---|---|---|
| `closed` | 5 failures in 5 min | `open` | Pause all dispatches, log alert, start 2-min timer |
| `open` | 2 minutes elapsed | `half_open` | Allow 1 test dispatch |
| `half_open` | Test dispatch succeeds | `closed` | Resume all dispatches, log recovery |
| `half_open` | Test dispatch fails | `open` | Re-pause, restart 2-min timer |

**Edge Cases:**
- Worker crashes mid-retry: Celery's `acks_late=True` ensures the task is re-delivered.
- Channel returns ambiguous response (e.g., HTTP 200 but body indicates error): Each channel adapter must parse the response body to determine true success/failure.
- Retry task fires during circuit breaker open state: Task is re-queued with a delay equal to the remaining circuit breaker open duration.

#### 3.1.6 Rate Limiting

**Source:** NT-FR-020, NT-FR-021, NT-FR-022

**Per-User Per-Channel Rate Limits:**

| Channel | Hourly Limit | Burst Limit (per minute) | Critical Event Bypass |
|---|---|---|---|
| Telegram | 20 messages | 5 | Yes |
| Discord | 10 messages | 3 | N/A (no critical events go to Discord by default) |
| Email | 5 emails | 2 | Yes |
| In-App | 60 notifications | No burst limit | N/A |
| Custom Webhook | 30 requests | 5 | Yes |

**Implementation:**
- Redis sliding window counters.
- Key format: `ratelimit:{user_id}:{channel}:hourly` (TTL: 3600s) and `ratelimit:{user_id}:{channel}:burst` (TTL: 60s).
- Before each dispatch, check both hourly and burst counters. If either is exceeded, the notification is rate-limited.

**Rate-Limited Notification Behavior:**
- Non-Critical: Queued into a Redis list `ratelimit_queue:{user_id}:{channel}`. When the rate limit window resets (detected via a Celery Beat task running every minute), all queued notifications are batched into a single summary message.
- Summary message format (Telegram example): `"You have {count} notifications that were batched due to rate limiting:\n• {notification_1_title}\n• {notification_2_title}\n..."`
- If the batch contains more than 10 notifications, show the first 10 and append: `"...and {remaining_count} more. View all in your dashboard."`
- Critical events (`trade.fill`, `risk.limit_breach`, `account.connection_lost`): Bypass rate limits entirely. These are always dispatched immediately.

**Edge Cases:**
- Redis unavailable: Fail open (allow the dispatch) and log a warning. Do NOT block notifications because rate limiting is down.
- Rate limit counter overflow (theoretically impossible with TTL but guarding against): Cap counter at 10,000; values above this indicate a bug.

#### 3.1.7 Quiet Hours / Do Not Disturb

**Source:** NT-FR-023, NT-FR-024, NT-FR-025, NT-FR-026

**Configuration Schema:**

| Field | Type | Constraints | Default |
|---|---|---|---|
| `enabled` | boolean | — | `false` |
| `start_time` | string | HH:MM format (00:00 to 23:59) | `"22:00"` |
| `end_time` | string | HH:MM format (00:00 to 23:59) | `"07:00"` |
| `timezone` | string | Valid IANA timezone (e.g., `America/New_York`) | User's account timezone |
| `days_of_week` | array of integers | Each: 0-6 (0=Sunday, 6=Saturday) | `[0,1,2,3,4,5,6]` |
| `bypass_critical` | boolean | — | `true` |

**Evaluation Logic (executed before channel routing):**

```
1. IF quiet_hours.enabled is false → NOT in quiet hours, proceed.
2. Convert current UTC time to user's quiet_hours.timezone.
3. Get current day_of_week (0=Sunday).
4. IF current day_of_week NOT IN quiet_hours.days_of_week → NOT in quiet hours, proceed.
5. IF start_time < end_time (same-day range, e.g., 22:00–23:00):
     IF current_time >= start_time AND current_time < end_time → IN quiet hours.
   IF start_time > end_time (overnight range, e.g., 22:00–07:00):
     IF current_time >= start_time OR current_time < end_time → IN quiet hours.
   IF start_time == end_time → NOT in quiet hours (invalid config, treat as disabled).
6. IF in quiet hours AND event is Critical AND bypass_critical is true → proceed (NOT deferred).
7. IF in quiet hours → DEFER notification.
```

**Deferred Notification Handling:**
- Deferred notifications are stored in Redis list `deferred:{user_id}` with the full notification payload and original timestamp.
- A Celery Beat task runs every minute checking if any user's quiet hours have ended. When quiet hours end for a user:
  1. Retrieve all deferred notifications from the Redis list.
  2. Batch them into a single summary message per channel.
  3. Summary format: `"While you were away ({count} notifications):\n\n{timestamp_1}: {title_1}\n{timestamp_2}: {title_2}\n..."`
  4. Dispatch the summary through the normal channel pipeline (subject to rate limiting).
  5. Clear the deferred queue.

**Edge Cases:**
- User changes timezone while quiet hours are active: Apply new timezone immediately on the next evaluation cycle (within 1 minute).
- User disables quiet hours while notifications are deferred: Immediately flush all deferred notifications as a batch summary.
- Quiet hours span midnight and cross a day boundary where one day is enabled and the next is not: Evaluate based on the day when quiet hours *started*, not the current day.
- No deferred notifications when quiet hours end: Do not send an empty summary.

---

### 3.2 Telegram Bot Integration

#### 3.2.1 Bot Registration and Setup

**Source:** NT-FR-027, NT-FR-028

**Bot Configuration:**
- Bot name: `TrendEdgeBot` (fallback: `TrendEdge_Bot`)
- Bot description: `"AI-powered futures trading alerts, fill confirmations, and account management."`
- Mode: Webhook mode in production (`POST /api/integrations/telegram/webhook`)
- Bot token: Environment variable `TELEGRAM_BOT_TOKEN` (never in source control)

**Webhook Security:**
- Every incoming request to `/api/integrations/telegram/webhook` MUST include the `X-Telegram-Bot-Api-Secret-Token` header.
- The secret token is set when registering the webhook with Telegram (`setWebhook` API call with `secret_token` parameter).
- Stored in environment variable `TELEGRAM_WEBHOOK_SECRET`.
- Validation: Compare request header value with stored secret using constant-time comparison.
- If the header is missing or does not match: Return HTTP 200 (to avoid leaking information to attackers) but do NOT process the update. Log at warning level: `"Telegram webhook request rejected: invalid secret token, source_ip: {ip}"`.

**Startup Behavior:**
- On application startup, the bot SHALL register its webhook URL with Telegram via `setWebhook` API.
- If webhook registration fails, log critical error and alert operations. The bot will not receive updates until this is resolved.

#### 3.2.2 User Linking

**Source:** NT-FR-029, NT-FR-030, NT-FR-031

**Linking Flow (step-by-step):**

| Step | Actor | Action | System Response |
|---|---|---|---|
| 1 | User | Navigates to Settings > Integrations > Telegram in the dashboard | Dashboard displays linking UI with a "Generate Link Code" button |
| 2 | User | Clicks "Generate Link Code" | System generates a 6-character alphanumeric code |
| 3 | System | — | Code stored in Redis: key=`telegram_link:{code}`, value=`{user_id}`, TTL=600 seconds (10 minutes) |
| 4 | System | — | Dashboard displays: `"Send this code to @TrendEdgeBot on Telegram: {code}"` with a copy button |
| 5 | User | Opens Telegram, starts conversation with @TrendEdgeBot, sends the code | — |
| 6 | Bot | Receives the message | Bot looks up `telegram_link:{code}` in Redis |
| 7a | System | Code found and valid | Store mapping in `user_integrations` table: `user_id`, `channel='telegram'`, `external_id={telegram_chat_id}`, `metadata={"username": "{telegram_username}"}`. Delete the Redis key. |
| 7b | Bot | — | Replies: `"Your Telegram account has been linked to TrendEdge. You will now receive trade alerts here. Type /help to see available commands."` |
| 8 | Dashboard | — | Updates to show `"Telegram: Connected"` with username and a "Disconnect" button |

**Code Generation Rules:**
- 6 characters, uppercase alphanumeric.
- Excluded characters: `I`, `O`, `0`, `1` (ambiguous).
- Character set: `ABCDEFGHJKLMNPQRSTUVWXYZ23456789` (32 characters).
- Generated using `secrets.choice()` for cryptographic randomness.
- Collision check: Before storing, verify the code does not already exist in Redis. If it does, regenerate (up to 3 attempts; if all collide, return error to user: `"Unable to generate link code. Please try again."`).

**Error States:**

| Condition | Bot Response |
|---|---|
| Code is expired (>10 minutes) | `"Invalid or expired code. Please generate a new code from your TrendEdge dashboard."` |
| Code is invalid (not found in Redis) | `"Invalid or expired code. Please generate a new code from your TrendEdge dashboard."` |
| Code is valid but user account is suspended | `"Your TrendEdge account is currently suspended. Please contact support."` |
| Database error during linking | `"An error occurred while linking your account. Please try again in a few minutes."` |
| User sends a non-code message before linking | `"Please link your TrendEdge account first. Visit Settings > Integrations > Telegram in your TrendEdge dashboard to generate a linking code."` |

**Re-Linking Behavior:**
- Each TrendEdge account links to exactly one Telegram chat.
- If a user links a new Telegram chat, the previous chat receives: `"Your Telegram account has been unlinked from TrendEdge. Another Telegram account has been linked."`
- The old mapping is deleted and replaced with the new one.

**Unlinking:**
- From dashboard: Click "Disconnect" button. System deletes the `user_integrations` record. Bot sends to the previously linked chat: `"Your Telegram account has been unlinked from TrendEdge."`
- From Telegram: User sends `/unlink`. Bot prompts with inline keyboard: `"Are you sure you want to unlink your Telegram account from TrendEdge? [Yes, Unlink] [Cancel]"`. On confirmation, system deletes the mapping and bot replies: `"Your Telegram account has been unlinked from TrendEdge."`
- Dashboard updates to show "Telegram: Not Connected" with a "Link Account" button.

#### 3.2.3 Alert Message Formatting

**Source:** NT-FR-032, NT-FR-033, NT-FR-034

**Formatting Rules:**
- All Telegram messages use Markdown V2 formatting.
- Special characters in Markdown V2 that must be escaped: `_`, `*`, `[`, `]`, `(`, `)`, `~`, `` ` ``, `>`, `#`, `+`, `-`, `=`, `|`, `{`, `}`, `.`, `!`.
- All monetary values: comma-separated with 2 decimal places (e.g., `$1,250.50`).
- Tick values: instrument's tick-size precision (e.g., ES ticks are 0.25, so display `5,205.25`; CL ticks are 0.01, so display `72.50`).

**Event-Specific Formatting:**

| Event | Emoji | Title Format | Content Fields |
|---|---|---|---|
| Trade Fill (Entry) | Direction arrow (up/down) | `{direction} {qty} {symbol} @ {price}` | Stop, target, risk $, R:R, source |
| Trade Fill (Exit) | Close icon | `CLOSED {qty} {symbol} @ {price}` | Entry price, P&L ($, R), duration, slippage, daily P&L |
| Trendline Alert | Alert triangle | `{alert_type}: {symbol}` | Grade, touch count, slope, duration |
| Daily P&L Summary | Calendar | `Daily Summary: {date}` | Net P&L, trade count (W/L), win rate, best/worst trade |
| Risk Warning | Warning sign | `Risk Warning: {limit_type}` | Current vs. max, percent used, recommended action |
| Risk Breach | Red alert | `RISK BREACH: {limit_type}` | Auto-action taken (e.g., "Execution paused") |
| Connection Lost | Red circle | `Connection Lost: {broker}` | Timestamp, "Attempting reconnect..." |
| Connection Restored | Green circle | `Connection Restored: {broker}` | Downtime duration |

**Inline Keyboard Buttons:**
- Every trade fill and close notification includes a button: `[View Trade Details]` linking to `https://app.trendedge.com/trades/{trade_id}`.
- Phase 3 only: Fill notifications additionally include `[Move Stop to BE]` and `[Close Position]` buttons.

#### 3.2.4 Interactive Commands

**Source:** NT-FR-035, NT-FR-036, NT-FR-037, NT-FR-038

**Command Catalog:**

| Command | Description | Auth Required | Response Time Target |
|---|---|---|---|
| `/start` | Initial greeting | No (pre-link) | < 1s |
| `/help` | List commands | Yes (linked) | < 1s |
| `/status` | Account overview | Yes | < 3s |
| `/positions` | Open positions table | Yes | < 3s |
| `/pnl` | Today's P&L | Yes | < 3s |
| `/pnl week` | Weekly P&L | Yes | < 3s |
| `/pnl month` | Monthly P&L | Yes | < 3s |
| `/pause` | Pause execution | Yes | < 2s |
| `/resume` | Resume execution | Yes | < 2s |
| `/alerts` | Active trendline alerts | Yes | < 3s |
| `/trade` | Manual trade entry | Yes | < 2s (parsing) |
| `/unlink` | Disconnect Telegram | Yes | < 2s |

**Authentication Check:** For all commands except `/start`, the bot SHALL verify the sender's `chat_id` has a linked TrendEdge account. If not linked, reply: `"Your Telegram account is not linked to TrendEdge. Visit Settings > Integrations > Telegram in your dashboard to link your account."`

**`/start` Response:**
```
Welcome to TrendEdge Bot!

I can send you real-time trade alerts, fill confirmations, and P&L summaries.

To get started, link your TrendEdge account:
1. Go to Settings > Integrations > Telegram in your TrendEdge dashboard
2. Click "Generate Link Code"
3. Send the code here

Already linked? Type /help to see available commands.
```

**`/help` Response:**
```
Available Commands:

/status    - Account overview (positions, P&L, margin)
/positions - Detailed open positions table
/pnl       - Today's P&L breakdown
/pnl week  - This week's P&L summary
/pnl month - This month's P&L summary
/pause     - Pause automated execution
/resume    - Resume automated execution
/alerts    - Active trendline alerts
/trade     - Manual trade entry
/unlink    - Disconnect Telegram account
```

**`/status` Response Format:**
```
Account Status

Execution: ACTIVE (or PAUSED)
Open Positions: {count}
Unrealized P&L: {sign}${amount}
Daily P&L: {sign}${amount} ({wins}W/{losses}L)
Available Margin: ${amount}
Daily Loss Remaining: ${amount}

Active Alerts: {count} trendline setups
```

If broker data is unavailable: Show cached data with disclaimer: `"Data as of {cached_timestamp}. Live data unavailable — broker connection may be down."`

**`/pause` Behavior:**
1. Bot sends confirmation prompt with inline keyboard: `"Are you sure you want to pause automated execution? Active positions will NOT be affected. New signals will be logged but NOT executed.\n[Yes, Pause] [Cancel]"`
2. User taps "Yes, Pause":
   - System sets `user.execution_paused = true` in the database.
   - Bot replies: `"Automated execution has been PAUSED. Existing positions are unaffected. New signals will be logged but not executed. Use /resume to re-enable."`
   - If the user has other active channels, a notification is sent to all: `"Automated execution has been PAUSED via Telegram."`
3. User taps "Cancel": Bot replies: `"Pause cancelled. Execution remains active."`

**`/pause` When Already Paused:** Bot replies: `"Execution is already PAUSED. Use /resume to re-enable."`

**`/resume` Behavior:**
1. System sets `user.execution_paused = false`.
2. Bot replies: `"Automated execution has been RESUMED. New signals will be processed normally. Note: {count} signals were received while paused and have been discarded (stale data)."`
3. Notify all active channels: `"Automated execution has been RESUMED via Telegram."`

**`/resume` When Not Paused:** Bot replies: `"Execution is already ACTIVE. No action needed."`

**Signal Handling During Pause:** When execution is paused and a signal is received (from TradingView webhook or trendline engine):
1. Log the signal in `signal_log` with status `paused_skipped`.
2. Send Telegram notification: `"Signal received but execution is PAUSED: {direction} {symbol} @ {price}. Use /resume to re-enable."`
3. Do NOT route to the execution engine.

#### 3.2.5 Manual Trade Entry via Telegram

**Source:** NT-FR-039, NT-FR-040, NT-FR-041

**Command Syntax:**
```
/trade <ACTION> <SYMBOL> <PRICE> SL:<STOP_LOSS> TP:<TAKE_PROFIT> [QTY:<QUANTITY>]
```

**Parsing Rules:**

| Parameter | Required | Format | Default | Validation |
|---|---|---|---|---|
| ACTION | Yes | `BUY` or `SELL` (case-insensitive) | — | Must be `BUY` or `SELL` |
| SYMBOL | Yes | Alphanumeric, 1-10 chars | — | Must resolve via SymbolResolver |
| PRICE | Yes | Numeric, positive | — | Must be a valid price for the instrument |
| SL | Yes | `SL:` prefix + numeric | — | For BUY: must be < PRICE. For SELL: must be > PRICE. |
| TP | Yes | `TP:` prefix + numeric | — | For BUY: must be > PRICE. For SELL: must be < PRICE. |
| QTY | No | `QTY:` prefix + positive integer | `1` | Must be >= 1 and <= user's max position size |

**Processing Steps:**

1. **Parse command:** Extract all parameters. If parsing fails, reply with usage help:
   ```
   Invalid command format. Usage:
   /trade BUY MES 5200 SL:5190 TP:5220
   /trade SELL CL 72.50 SL:73.25 TP:71.00 QTY:2
   ```

2. **Validate symbol:** Resolve via SymbolResolver. If unresolved:
   `"Unknown symbol: {symbol}. Supported symbols: ES, MES, NQ, MNQ, YM, CL, GC, PL, SI"`

3. **Validate prices:** Check stop/target on correct side.
   - BUY with SL >= PRICE: `"Stop loss must be below entry price for a BUY order. Entry: {price}, Stop: {sl}"`
   - SELL with SL <= PRICE: `"Stop loss must be above entry price for a SELL order. Entry: {price}, Stop: {sl}"`
   - BUY with TP <= PRICE: `"Take profit must be above entry price for a BUY order. Entry: {price}, Target: {tp}"`
   - SELL with TP >= PRICE: `"Take profit must be below entry price for a SELL order. Entry: {price}, Target: {tp}"`

4. **Calculate risk metrics:**
   - Risk per contract = |PRICE - SL| * tick_value / tick_size
   - Total risk = Risk per contract * QTY
   - Reward = |TP - PRICE| * tick_value / tick_size * QTY
   - R:R ratio = Reward / Total risk

5. **Run risk checks:** [Cross-reference: see FSD-006 for risk management rules]
   - Daily loss limit check
   - Max positions check
   - Position size limit check
   - If any fail: `"Cannot execute: {reason}. {details}"`
   - Example: `"Cannot execute: Daily loss limit would be exceeded. Remaining risk budget: $200.00. This trade risks $500.00."`

6. **Display confirmation:**
   ```
   Manual Trade Confirmation

   {ACTION} {QTY} {SYMBOL} @ {PRICE}
   Stop: {SL} | Target: {TP}
   Risk: ${risk} | Reward: ${reward} | R:R 1:{rr}

   [Confirm & Execute] [Cancel]
   ```

7. **On "Confirm & Execute":** Route to execution pipeline as `signal_source = "manual_telegram"`. Reply with fill confirmation template when filled.

8. **On "Cancel":** Reply: `"Trade cancelled."` Remove the inline keyboard.

**Timeout:** If user does not respond to the confirmation within 5 minutes, the inline keyboard is removed and the bot sends: `"Trade confirmation expired. Please submit a new /trade command if you still want to execute."`

---

### 3.3 Discord Webhook Integration

#### 3.3.1 Webhook Configuration

**Source:** NT-FR-042, NT-FR-043, NT-FR-044

**Configuration UI (Settings > Integrations > Discord):**

| Field | Type | Validation | Required |
|---|---|---|---|
| `webhook_url` | URL input | Must match: `https://discord.com/api/webhooks/{id}/{token}` | Yes |
| `channel_name` | Text input | Max 100 chars, auto-populated from Discord if possible | No |
| `enabled_events` | Multi-select checkboxes | At least one event type | Yes |
| `include_pnl` | Toggle | Boolean | No (default: `false`) |

**Available Event Types for Discord:**
- `trade.fill` (default: ON)
- `trade.closed` (default: ON)
- `trendline.alert` (default: ON)
- `risk.warning`
- `digest.daily`
- `digest.weekly`

**Multiple Webhooks:** Users can configure up to 3 Discord webhook URLs. Each webhook has independent event type filtering.

**Test Embed on Save:**
- When a user saves a webhook URL, the system sends a test embed:
  ```json
  {
    "embeds": [{
      "title": "TrendEdge Integration Active",
      "description": "Trade alerts will appear in this channel.",
      "color": 3447003,
      "footer": { "text": "TrendEdge | Test message" },
      "timestamp": "<current ISO timestamp>"
    }]
  }
  ```
- If the Discord API returns 2xx: Show success toast: `"Test message sent to Discord. Check your channel."`
- If the Discord API returns 404: Show error: `"Could not send to Discord. The webhook URL appears to be invalid or the channel has been deleted."`
- If the Discord API returns 401/403: Show error: `"Could not send to Discord. The webhook token is invalid. Please regenerate the webhook in Discord."`
- If the Discord API returns 429: Show error: `"Discord is rate limiting requests. Please try again in a few seconds."`
- If the Discord API times out (>5s): Show error: `"Could not reach Discord. Please check your internet connection and try again."`
- If any other error: Show error: `"Could not send to Discord. Please verify the webhook URL is correct and the channel exists."`

#### 3.3.2 Rich Embed Formatting

**Source:** NT-FR-045, NT-FR-046, NT-FR-047

**Embed Color Codes:**

| Scenario | Hex | Decimal | Usage |
|---|---|---|---|
| Long entries, winning closes | `#2ECC71` | `3066993` | Green |
| Short entries, losing closes | `#E74C3C` | `15158332` | Red |
| Trendline alerts | `#F1C40F` | `15844367` | Gold |
| Informational (summaries, status) | `#3498DB` | `3447003` | Blue |
| Warnings | `#E67E22` | `15105570` | Orange |

**Trade Fill Embed Structure:**
```json
{
  "embeds": [{
    "title": "Trade Fill: {direction} {symbol}",
    "color": "<color based on direction>",
    "fields": [
      { "name": "Direction", "value": "{LONG|SHORT}", "inline": true },
      { "name": "Entry", "value": "{entry_price}", "inline": true },
      { "name": "Quantity", "value": "{quantity}", "inline": true },
      { "name": "Stop Loss", "value": "{stop_loss}", "inline": true },
      { "name": "Target", "value": "{take_profit}", "inline": true },
      { "name": "R:R", "value": "1:{rr_ratio}", "inline": true },
      { "name": "Source", "value": "{signal_source_display}", "inline": true },
      { "name": "Grade", "value": "{trendline_grade}", "inline": true }
    ],
    "footer": { "text": "TrendEdge | {date} {time} ET" },
    "timestamp": "{iso_timestamp}"
  }]
}
```

**Privacy Control (`include_pnl`):**
- When `include_pnl` is `false`: Replace all dollar P&L amounts with R-multiple values only.
  - Instead of `"+$370.00 (+1.82R)"` show `"+1.82R"`
  - Instead of `"Risk: $305.00"` show `"Risk: 0.61R"` (relative to daily risk budget)
- When `include_pnl` is `true`: Show both dollar amounts and R-multiples.

**Discord API Limits to Respect:**
- Max 10 embeds per message.
- Max 25 fields per embed.
- Max 256 characters for embed title.
- Max 4096 characters for embed description.
- Max 1024 characters per field value.

#### 3.3.3 Daily/Weekly Summary Posts

**Source:** NT-FR-048, NT-FR-049

**Daily Summary (posted at 17:30 ET):**

```json
{
  "embeds": [{
    "title": "Daily Summary — {date}",
    "color": 3447003,
    "fields": [
      { "name": "Net P&L", "value": "{pnl_display}", "inline": true },
      { "name": "Trades", "value": "{wins}W / {losses}L / {be}BE", "inline": true },
      { "name": "Win Rate", "value": "{win_rate}%", "inline": true },
      { "name": "Best Trade", "value": "{symbol} {pnl_display}", "inline": true },
      { "name": "Worst Trade", "value": "{symbol} {pnl_display}", "inline": true },
      { "name": "Active Alerts", "value": "{count} setups", "inline": true }
    ],
    "footer": { "text": "TrendEdge | Daily Summary" },
    "timestamp": "{iso_timestamp}"
  }]
}
```

If no trades occurred: Post a lighter summary: `"No trades executed today. {count} active trendline setups being monitored."` This message is suppressible via user preferences.

**Weekly Summary (posted Saturday at 10:00 ET):**

```json
{
  "embeds": [{
    "title": "Weekly Summary — {start_date} to {end_date}",
    "color": 3447003,
    "fields": [
      { "name": "Net P&L", "value": "{pnl_display}", "inline": true },
      { "name": "Total Trades", "value": "{count} ({win_rate}% win rate)", "inline": true },
      { "name": "Avg R-Multiple", "value": "{avg_r}", "inline": true },
      { "name": "Top Playbooks", "value": "{playbook_summary}", "inline": false },
      { "name": "Top Trendline Setups", "value": "{trendline_summary}", "inline": false }
    ],
    "footer": { "text": "TrendEdge | Weekly Summary" },
    "timestamp": "{iso_timestamp}"
  }]
}
```

---

### 3.4 Email Notifications (SendGrid/Resend)

#### 3.4.1 Transactional Emails

**Source:** NT-FR-050, NT-FR-051, NT-FR-052

**Email Catalog:**

| Email | Trigger | From Address | Subject Template | Delivery Target |
|---|---|---|---|---|
| Welcome | User registration | `noreply@trendedge.com` | `"Welcome to TrendEdge — Let's get your first trendline detected"` | < 30s |
| Email Verification | Registration / email change | `noreply@trendedge.com` | `"Verify your email address"` | < 10s |
| Password Reset | Password reset request | `security@trendedge.com` | `"Reset your TrendEdge password"` | < 10s |
| Broker Connected | Broker API connected | `noreply@trendedge.com` | `"Your {broker_name} account is connected"` | < 30s |
| Trade Fill | `trade.fill` event | `alerts@trendedge.com` | `"{direction} {symbol} filled @ {price}"` | < 30s |
| Trade Closed | `trade.closed` event | `alerts@trendedge.com` | `"Trade closed: {symbol} {pnl_direction}{pnl_amount}"` | < 30s |
| Risk Breach | `risk.limit_breach` | `alerts@trendedge.com` | `"URGENT: {limit_type} limit reached — execution paused"` | < 30s |
| Subscription Change | Tier change | `billing@trendedge.com` | `"Your TrendEdge plan has been updated to {tier}"` | < 30s |

**Email Security Rule:** Subject lines SHALL NOT contain dollar amounts or account balances (these can be previewed on lock screens). Body content may include P&L values.

**Required Email Components:**
- TrendEdge logo (header)
- Link to dashboard
- Unsubscribe link (for non-security emails)
- Footer with company address (CAN-SPAM compliance)
- Social links in footer

**Provider Failover:**
- Primary: SendGrid
- Fallback: Resend
- Logic: If SendGrid API returns 5xx or times out (>10s), retry once with SendGrid. If still failing, switch to Resend for this email. Log the failover event.
- Failover is per-email, not a global switch. Each email independently tries SendGrid first.

#### 3.4.2 Digest Emails

**Source:** NT-FR-053, NT-FR-054, NT-FR-055

**Daily Digest (sent at 18:00 user timezone):**

| Section | Content | Notes |
|---|---|---|
| Header | Date, account name, tier badge | — |
| P&L Summary | Net P&L ($, R), trade count, win rate | — |
| Trade Table | Per trade: symbol, direction, entry/exit, P&L, R, duration, playbook | Max 20 trades; if more, show top 10 + bottom 10 |
| Equity Curve | Inline chart image (last 30 days) | Generated via matplotlib, hosted as CID attachment or URL |
| Trendline Activity | New setups detected, alerts fired, invalidated | — |
| Risk Status | Daily loss usage, max drawdown distance | — |
| Footer | Dashboard link, preferences link, unsubscribe link | — |

**Weekly Digest (sent Sunday at 09:00 user timezone):**

| Section | Content | Notes |
|---|---|---|
| Week Summary | Date range, net P&L, total trades, win rate, annualized Sharpe | — |
| Playbook Breakdown | Per playbook: count, win rate, avg R, total P&L | — |
| Best/Worst Trades | Top 3 winners, top 3 losers | — |
| Equity Curve | 90-day curve with current week highlighted | — |
| Behavioral Metrics | Rule compliance, mistake cost, consistency score | — |
| Trendline Report | Active setups, new A+ detections, accuracy | — |
| AI Insight | One-paragraph AI observation | Pro tier only; omit for other tiers |

**No-Activity Behavior:**
- If zero trades occurred on a day/week, send a lighter email: `"No trades were executed on {date}. You have {count} active trendline setups being monitored."`
- This email is suppressible via preferences (checkbox: "Skip digest on days with no trades").

#### 3.4.3 Unsubscribe Handling

**Source:** NT-FR-059, NT-FR-060, NT-FR-061

**One-Click Unsubscribe (RFC 8058):**
- Every non-security email includes `List-Unsubscribe` and `List-Unsubscribe-Post` headers.
- Clicking the unsubscribe link:
  1. Immediately unsubscribes from that email category.
  2. Displays confirmation page: `"You have been unsubscribed from {category} emails. You can re-enable this in your notification preferences."` with a link to preferences and an "Undo" button (valid for 7 days).
  3. Does NOT unsubscribe from security emails (password reset, email verification, risk limit breaches).

**Emails that cannot be unsubscribed:**
- Password reset
- Email verification
- Risk limit breach alerts
- Account security notifications

**SendGrid Suppression Integration:**
- Webhook endpoint: `POST /api/integrations/sendgrid/webhook`
- Events handled: `bounce`, `spam_report`, `unsubscribe`
- On `bounce`: Mark user's email as bounced in `user_integrations`. Stop sending until email is re-verified.
- On `spam_report`: Mark user's email preferences to stop all marketing/digest emails. Log the event. Alert the operations team if spam report rate exceeds 0.1%.
- On `unsubscribe`: Update `notification_preferences` to disable that email category.

---

### 3.5 TradingView Webhook Receiver

#### 3.5.1 Unique URL and API Key Generation

**Source:** NT-FR-062, NT-FR-063, NT-FR-064

**Webhook URL Format:** `https://api.trendedge.com/webhooks/tv/{user_webhook_id}`

- `user_webhook_id`: URL-safe Base62-encoded UUID (22 characters). This is NOT the user's account ID.
- Generated on account creation.
- Stored in `user_integrations` table with `channel = 'tradingview'`.

**API Key Format:** `te_wh_` + 32-character hex string (e.g., `te_wh_a1b2c3d4e5f6789012345678abcdef01`)

- Generated using `secrets.token_hex(32)` (256 bits of entropy).
- Stored as bcrypt hash (`cost=12`) in the database. Plaintext shown once at creation.
- On the settings page, after generation: `"Your API key has been generated. Copy it now — it will not be shown again."` followed by the key in a copy-to-clipboard field.

**Regeneration:**
- User clicks "Regenerate" button.
- Confirmation dialog: `"Are you sure? Your current API key will be immediately invalidated. Any TradingView alerts using the old key will fail."`
- On confirm: Generate new key, hash and store, invalidate old key immediately.
- Display new key (one-time view).

**Sample TradingView Alert JSON (shown in UI):**
```json
{
  "api_key": "YOUR_API_KEY",
  "ticker": "{{ticker}}",
  "action": "{{strategy.order.action}}",
  "price": "{{close}}",
  "quantity": "{{strategy.order.contracts}}",
  "stop_loss": "{{plot_0}}",
  "take_profit": "{{plot_1}}",
  "message": "{{strategy.order.comment}}"
}
```

#### 3.5.2 Payload Validation

**Source:** NT-FR-065, NT-FR-066, NT-FR-067

**Validation Pipeline (executed in strict order):**

| Step | Check | Failure Response | Status Code |
|---|---|---|---|
| 1 | URL: `user_webhook_id` exists and is active | `{"error": "unknown_endpoint"}` | 404 |
| 2 | Rate limit: 60/hour, burst 10/minute per user | `{"error": "rate_limited"}` + `Retry-After` header | 429 |
| 3 | Content-Type: must be `application/json` | `{"error": "unsupported_media_type"}` | 415 |
| 4 | Body size: must be <= 10KB | `{"error": "payload_too_large"}` | 413 |
| 5 | JSON parsing: must be valid JSON | `{"error": "invalid_json"}` | 400 |
| 6 | API key: `api_key` field must be present and valid | `{"error": "invalid_api_key"}` | 401 |
| 7 | HMAC (optional): if enabled, `X-TrendEdge-Signature` header must be valid | `{"error": "invalid_signature"}` | 401 |
| 8 | Required fields: `ticker` and `action` must be present | `{"error": "missing_required_fields", "fields": [...]}` | 422 |
| 9 | Action validation: must be `buy`, `sell`, `close`, `close_long`, or `close_short` | `{"error": "invalid_action", "value": "..."}` | 422 |
| 10 | Replay check: if same `correlation_id` seen within 5 min | `{"error": "duplicate_request"}` | 409 |

**Success Response:**
```json
{
  "status": "accepted",
  "signal_id": "sig_abc123def456",
  "message": "Signal accepted and queued for processing"
}
```
Status code: 200 OK.

**Response Time Requirement:** The endpoint SHALL respond within 500ms (p99). All downstream processing (risk checks, order construction, execution) happens asynchronously via Celery.

**Security Rules:**
- Invalid `user_webhook_id` returns generic 404 (not "user not found").
- Invalid `api_key` returns generic 401 (not "key does not match user X").
- Internal errors return 500 with `{"error": "internal_error"}` (no stack traces).
- API key comparison uses constant-time comparison (bcrypt.checkpw handles this).

#### 3.5.3 Symbol Mapping

**Source:** NT-FR-068, NT-FR-069, NT-FR-070, NT-FR-071

**Default Symbol Mapping Table:**

| TradingView | Base Symbol | IBKR Pattern | Tradovate Pattern |
|---|---|---|---|
| `ES1!` | ES | `ES` + expiry code | `ES` + month + year |
| `MES1!` | MES | `MES` + expiry code | `MES` + month + year |
| `NQ1!` | NQ | `NQ` + expiry code | `NQ` + month + year |
| `MNQ1!` | MNQ | `MNQ` + expiry code | `MNQ` + month + year |
| `YM1!` | YM | `YM` + expiry code | `YM` + month + year |
| `MYM1!` | MYM | `MYM` + expiry code | `MYM` + month + year |
| `CL1!` | CL | `CL` + expiry code | `CL` + month + year |
| `MCL1!` | MCL | `MCL` + expiry code | `MCL` + month + year |
| `GC1!` | GC | `GC` + expiry code | `GC` + month + year |
| `MGC1!` | MGC | `MGC` + expiry code | `MGC` + month + year |
| `PL1!` | PL | `PL` + expiry code | `PL` + month + year |
| `SI1!` | SI | `SI` + expiry code | `SI` + month + year |

**Front-Month Resolution:** The `contract_calendar` table determines which contract is currently active. The rollover date defaults to 7 days before expiration and is configurable per instrument.

**Unmapped Symbol Behavior:**
- Return `200 OK` to the webhook caller (to prevent TradingView from disabling the alert).
- Log the signal with status `symbol_unmapped` in `webhook_log`.
- Send a notification to the user: `"Webhook received but symbol '{ticker}' could not be mapped to a broker contract. Please add a custom mapping in Settings > Integrations > TradingView > Symbol Mappings."`
- Do NOT route to execution.

**Custom Symbol Mappings:** Users can define custom mappings in Settings > Integrations > TradingView > Symbol Mappings. Custom mappings take priority over default mappings.

#### 3.5.4 Webhook Activity Log

**Source:** NT-FR-074, NT-FR-075, NT-FR-076

**`webhook_log` Table Schema:**

| Field | Type | Constraints | Description |
|---|---|---|---|
| `id` | UUID | PK | Primary key |
| `user_id` | UUID | FK, NULLABLE, INDEX | Resolved user (null if URL invalid) |
| `received_at` | TIMESTAMPTZ | NOT NULL, INDEX | Request timestamp |
| `source_ip` | INET | NOT NULL | Source IP |
| `payload` | JSONB | NOT NULL | Raw body with `api_key` replaced by `"[REDACTED]"` |
| `validation_status` | VARCHAR(20) | NOT NULL, INDEX | `valid`, `invalid_key`, `invalid_payload`, `rate_limited`, `unknown_url` |
| `mapped_symbol` | VARCHAR(20) | NULLABLE | Resolved broker symbol |
| `signal_id` | UUID | FK, NULLABLE | Created signal reference |
| `response_code` | INTEGER | NOT NULL | HTTP status code returned |
| `processing_time_ms` | INTEGER | NOT NULL | Total processing time |

**Dashboard View:** Settings > Integrations > TradingView > Activity Log. Shows most recent 100 webhooks with:
- Filtering by status (all, valid, invalid_key, invalid_payload, rate_limited, unknown_url)
- Color-coded status badges: green (valid), red (invalid_key, invalid_payload), yellow (rate_limited), gray (unknown_url)
- Columns: timestamp, source symbol, mapped symbol, status, signal ID (linked)
- Click on a row expands to show full payload (with redacted API key)

**Retention:** 30 days. Daily Celery Beat task at 04:00 UTC purges older records.

---

### 3.6 In-App Notification Center

#### 3.6.1 Real-Time Delivery

**Source:** NT-FR-077, NT-FR-078, NT-FR-079, NT-FR-080

**WebSocket Channel:** `notifications:{user_id}` via Supabase Realtime (PostgreSQL LISTEN/NOTIFY).

**Subscription Lifecycle:**
1. On dashboard mount, frontend subscribes to `notifications:{user_id}`.
2. RLS policies ensure users only receive their own notifications.
3. On dashboard unmount (page close/navigate away), subscription is cleaned up.

**New Notification Arrival Behavior:**
1. Notification bell badge count increments by 1.
2. Toast notification appears in bottom-right corner:
   - Icon: event-type-specific icon
   - Title: notification title (max 50 chars, truncated with `...`)
   - Body: first line of message (max 100 chars, truncated with `...`)
   - Auto-dismiss: 5 seconds
   - Click: navigates to relevant detail page (if deep link available) or opens notification panel
3. If notification panel is open: new notification prepends to the list with a 1-second highlight animation (subtle background color pulse).

**WebSocket Disconnection Recovery:**
1. Display a subtle indicator near the notification bell: small orange dot with tooltip `"Reconnecting..."`.
2. Reconnect with exponential backoff: 1s, 2s, 4s, 8s, 16s, max 30s.
3. On successful reconnection: remove the indicator, fetch missed notifications via `GET /api/notifications?since={last_received_timestamp}`.
4. If reconnection fails after 5 minutes: show persistent banner: `"Live notifications unavailable. Refresh the page to reconnect."` with a "Refresh" button.

#### 3.6.2 Notification Panel UI

**Source:** NT-FR-081, NT-FR-082, NT-FR-083, NT-FR-084, NT-FR-085

**`notifications` Table Schema:**

| Field | Type | Constraints | Default | Description |
|---|---|---|---|---|
| `id` | UUID | PK | `gen_random_uuid()` | Primary key |
| `user_id` | UUID | FK, NOT NULL, INDEX | — | Target user |
| `event_type` | VARCHAR(50) | NOT NULL, INDEX | — | Event type |
| `title` | VARCHAR(200) | NOT NULL | — | Notification title |
| `body` | TEXT | NOT NULL | — | Body (Markdown) |
| `data` | JSONB | NULLABLE | `NULL` | Deep link data |
| `read` | BOOLEAN | NOT NULL, INDEX | `false` | Read status |
| `created_at` | TIMESTAMPTZ | NOT NULL, INDEX | `NOW()` | Creation timestamp |
| `expires_at` | TIMESTAMPTZ | NULLABLE | `NULL` | Expiration (null = uses default retention) |

**Panel Features:**

| Feature | Behavior |
|---|---|
| Pagination | Infinite scroll, 20 notifications per page. Load more on scroll to bottom. |
| Filter | Dropdown: All, Trades, Trendlines, Risk, System. Default: All. |
| Mark all as read | Button in panel header. Sets `read = true` for all user's unread notifications. Badge count resets to 0. |
| Mark individual as read | Click on a notification marks it as read. Visual change: bold text becomes normal weight. |
| Swipe to dismiss (mobile) | Marks as read, does NOT delete. Slide animation. |
| Clear all read | Button (secondary style). Deletes all notifications where `read = true` from the panel view (soft delete or hide; actual deletion via retention policy). |
| Empty state | Panel shows: `"No notifications yet. Your trade alerts, trendline signals, and system updates will appear here."` |

**Deep Linking:**
- Notification with `data.trade_id`: click navigates to `/trades/{trade_id}`.
- Notification with `data.trendline_id`: click navigates to `/trendlines/{trendline_id}`.
- Notification without deep link data: click opens notification panel (if not already open) or marks as read.

**Badge Count:**
- Fetched on page load: `GET /api/notifications/unread-count` returns `{"count": N}`.
- Updated in real time via WebSocket.
- Max display: `99+` (if count > 99, display `"99+"`).
- Badge hidden when count is 0.

**Retention:**
- Standard notifications: auto-deleted after 30 days.
- Critical notifications (`trade.fill`, `risk.limit_breach`): retained for 90 days.
- Cleanup: daily Celery Beat task at 05:00 UTC.

---

### 3.7 Market Data Integration

#### 3.7.1 Historical OHLCV (yfinance)

**Source:** NT-FR-086, NT-FR-087, NT-FR-088, NT-FR-089, NT-FR-090

**Instruments:**

| Instrument | yfinance Ticker | Description |
|---|---|---|
| E-mini S&P 500 | `ES=F` | Front-month continuous |
| Micro E-mini S&P | `MES=F` | Front-month continuous |
| E-mini Nasdaq 100 | `NQ=F` | Front-month continuous |
| Micro E-mini Nasdaq | `MNQ=F` | Front-month continuous |
| E-mini Dow | `YM=F` | Front-month continuous |
| Crude Oil | `CL=F` | Front-month continuous |
| Gold | `GC=F` | Front-month continuous |
| Platinum | `PL=F` | Front-month continuous |
| Silver | `SI=F` | Front-month continuous |

**Fetch Schedule:**
- Initial fetch: On instrument activation, fetch maximum available history (~2 years daily).
- Daily update: Celery Beat task at 18:30 ET fetches latest day's OHLCV and upserts into database.
- Gap detection: After each daily fetch, check for missing trading dates (excluding weekends and known market holidays). If gaps found, backfill automatically.

**`market_data_daily` Table:**

| Field | Type | Constraints | Description |
|---|---|---|---|
| `id` | BIGSERIAL | PK | Auto-increment ID |
| `symbol` | VARCHAR(10) | NOT NULL | Normalized symbol |
| `date` | DATE | NOT NULL | Trading date |
| `open` | NUMERIC(12,4) | NOT NULL | Open price |
| `high` | NUMERIC(12,4) | NOT NULL | High price |
| `low` | NUMERIC(12,4) | NOT NULL | Low price |
| `close` | NUMERIC(12,4) | NOT NULL | Close/settlement price |
| `volume` | BIGINT | NOT NULL | Total volume |
| `source` | VARCHAR(20) | NOT NULL | `yfinance`, `databento`, `broker` |
| `fetched_at` | TIMESTAMPTZ | NOT NULL | Fetch timestamp |

Unique constraint: `(symbol, date)`. Index: `(symbol, date DESC)`.

**Error Handling:**
- yfinance returns empty data: Log warning `"No data returned from yfinance for {ticker} on {date}"`. Retry in 1 hour.
- yfinance returns stale data (last date is >2 trading days old): Log warning, use cached data, alert operations.
- yfinance library error: Catch exception, log, retry in 30 minutes (max 3 retries per daily run).

#### 3.7.2 Real-Time Data

**Source:** NT-FR-091, NT-FR-092, NT-FR-093

**Data Sources:**
- IBKR: Level 1 market data via `ib_async`. Provides: bid, ask, last, volume, OHLC bar streaming.
- Tradovate: Market data via WebSocket. Provides: quotes, DOM, time & sales.

**Real-Time Data Usage:**
- Dashboard price display: updated every 1 second for active instruments.
- Unrealized P&L: recalculated on every price tick for open positions.
- Trendline proximity alerts: price approaching a qualifying trendline triggers a check.
- MAE/MFE tracking for open trades.

**Fallback (no broker connected or connection down):**
- Display delayed data (15-minute delay) from yfinance or most recent cached price.
- Show `"Delayed"` badge next to the price in the UI.
- Tooltip on delayed badge: `"Real-time data unavailable. Connect a broker for live prices."`

#### 3.7.3 Caching Strategy

**Source:** NT-FR-094, NT-FR-095, NT-FR-096

| Layer | Technology | TTL | Data | Invalidation |
|---|---|---|---|---|
| Hot | Redis | 5 seconds | Current bid/ask/last per instrument | Overwritten on every tick |
| Warm | Redis | 5 minutes | Recent 4H bars, daily bars, computed indicators | Rebuilt on 4H bar close or daily settlement |
| Cold | PostgreSQL | Permanent | Full historical OHLCV | Append-only via daily fetch job |

**Rules:**
- Trendline engine reads from warm cache for scheduled scans (every 4H).
- Trendline engine reads from cold cache for backtesting/historical analysis.
- Neither reads directly from external data APIs during scan execution.

#### 3.7.4 Contract Calendar and Symbol Resolution

**Source:** NT-FR-097, NT-FR-098, NT-FR-099

**`contract_calendar` Table:**

| Field | Type | Constraints | Description |
|---|---|---|---|
| `symbol` | VARCHAR(10) | NOT NULL | Base instrument |
| `contract_month` | CHAR(6) | NOT NULL, PK | Contract code (e.g., `ESH26`) |
| `first_trade_date` | DATE | NOT NULL | First trading date |
| `last_trade_date` | DATE | NOT NULL | Expiration |
| `rollover_date` | DATE | NOT NULL | Recommended rollover (default: 7 days before expiration) |
| `is_active` | BOOLEAN | NOT NULL | Current front-month flag |

**Rollover Behavior:**
- Daily Celery Beat task at 00:00 UTC checks if any instrument's rollover date has been reached.
- If yes: Set `is_active = false` on the expiring contract, set `is_active = true` on the next contract.
- Send notification to affected users: `"Contract rollover: {symbol} rolled from {old_contract} to {new_contract}. Active positions in the old contract are unaffected."`

**SymbolResolver Service:**
- Accepts input formats: TradingView continuous (`ES1!`), yfinance continuous (`ES=F`), specific contract (`ESH26`), or base symbol (`ES`).
- Returns the correct broker-specific contract symbol for the user's connected broker.
- If input cannot be resolved: Returns `None` and the caller handles the error appropriately.

---

### 3.8 Notification Preferences Management UI

#### 3.8.1 Channel Configuration Cards

**Source:** NT-FR-100, NT-FR-101

**Location:** Settings > Notifications

**Card Layout (top section):**

| Channel | Status States | Configuration | Tier Requirement |
|---|---|---|---|
| Email | Always available, shows verified status | Email address (read-only, from account) | All tiers |
| In-App | Always available | No configuration | All tiers |
| Telegram | Not Connected / Connected (username) | Link/Unlink button | Trader+ |
| Discord | Not Configured / Configured (channel name) | Webhook URL input, test button | Pro+ |
| Custom Webhook | Not Configured / Configured | URL + auth header, test button | Team only |

**Tier Gating UI:**
- If channel is unavailable on user's tier: Card is visually dimmed with a lock icon.
- Overlay text: `"Upgrade to {required_tier} to enable {channel_name} notifications"`.
- "Upgrade" button links to billing page.

#### 3.8.2 Per-Event Preferences Matrix

**Source:** NT-FR-102, NT-FR-103, NT-FR-104

**Matrix Table:**

| Event | Email | In-App | Telegram | Discord |
|---|---|---|---|---|
| Trade Fill (Entry) | toggle | toggle | toggle | toggle |
| Trade Fill (Exit) | toggle | toggle | toggle | toggle |
| Trade Closed (P&L) | toggle | toggle | toggle | toggle |
| Trendline Alert | toggle | toggle | toggle | toggle |
| Trendline Invalidated | toggle | toggle | toggle | toggle |
| Risk Warning | toggle | toggle | toggle | toggle |
| Risk Breach | ON (locked) | ON (locked) | toggle | toggle |
| Daily P&L Digest | toggle | — | toggle | toggle |
| Weekly Digest | toggle | — | — | toggle |
| Webhook Errors | toggle | toggle | toggle | — |
| Connection Lost | ON (locked) | ON (locked) | toggle | — |
| System Maintenance | toggle | toggle | — | — |

**Locked Toggles:** Risk Breach and Connection Lost have Email and In-App locked to ON. These cannot be disabled. Visual: toggle is ON with a lock icon; clicking shows tooltip: `"This notification cannot be disabled for safety reasons."`

**Unavailable Channel Columns:** Grayed out with lock icon. Hovering shows: `"Available on {tier_name} plan."` Toggles are non-interactive.

**Cell with `—`:** Not applicable for this event/channel combination. No toggle shown.

#### 3.8.3 Quiet Hours Configuration

**Source:** NT-FR-105

**UI Elements:**
- Enable/disable toggle (label: "Quiet Hours")
- Start time picker (HH:MM, 15-minute increments)
- End time picker (HH:MM, 15-minute increments)
- Timezone selector (IANA timezone database, default: user's account timezone)
- Day-of-week checkboxes (default: all checked)
- Checkbox: "Allow critical alerts during quiet hours" (default: checked)

**Validation:**
- Start time and end time must not be equal. If set equal, show: `"Start and end time cannot be the same."`

#### 3.8.4 Digest Schedule Configuration

**Source:** NT-FR-106

**UI Elements:**
- Daily digest: enable/disable toggle, time picker (default: 18:00 user timezone), checkbox "Skip if no trades" (default: unchecked)
- Weekly digest: enable/disable toggle, day selector (default: Sunday), time picker (default: 09:00 user timezone)

#### 3.8.5 Default Preferences

**Source:** NT-FR-107, NT-FR-108

**Persistence:** Preferences stored in `notification_preferences` JSONB column on the users table. Changes saved immediately on toggle (optimistic UI with rollback on error).

**Default Preferences for New Users:**

| Event | Email | In-App | Telegram | Discord |
|---|---|---|---|---|
| Trade fills | ON | ON | ON | OFF |
| Trade closed | ON | ON | ON | ON |
| Trendline alerts | OFF | ON | ON | OFF |
| Risk warnings | ON | ON | ON | OFF |
| Risk breaches | ON (locked) | ON (locked) | ON | ON |
| Daily digest | ON | — | ON | OFF |
| Weekly digest | ON | — | OFF | OFF |
| Webhook errors | ON | ON | OFF | — |
| Connection lost | ON (locked) | ON (locked) | ON | — |

**Optimistic UI Behavior:**
1. User clicks a toggle.
2. UI immediately reflects the new state.
3. API call `PATCH /api/notifications/preferences` fires in background.
4. If API succeeds: no further action.
5. If API fails: revert the toggle to its previous state, show toast: `"Failed to save preference. Please try again."`

---

## 4. Data Specifications

### 4.1 Entity Relationship Summary

```
users
  ├── notification_preferences (1:1, JSONB column or separate table)
  ├── user_integrations (1:many, one per channel)
  ├── notification_log (1:many)
  ├── notifications (1:many, in-app)
  └── webhook_log (1:many)

market_data_daily (standalone, shared across users)
market_data_intraday (standalone, shared across users)
contract_calendar (standalone, shared across users)
symbol_mappings (system defaults + per-user custom)
```

### 4.2 `user_integrations` Table

| Field | Type | Constraints | Description |
|---|---|---|---|
| `id` | UUID | PK | Primary key |
| `user_id` | UUID | FK -> users.id, NOT NULL | Owner |
| `channel` | VARCHAR(20) | NOT NULL | `telegram`, `discord`, `tradingview`, `custom_webhook` |
| `external_id` | VARCHAR(255) | NULLABLE | Channel-specific ID (e.g., Telegram chat_id) |
| `config` | JSONB | NOT NULL, DEFAULT '{}' | Channel-specific configuration |
| `is_active` | BOOLEAN | NOT NULL, DEFAULT true | Whether integration is active |
| `created_at` | TIMESTAMPTZ | NOT NULL | Creation timestamp |
| `updated_at` | TIMESTAMPTZ | NOT NULL | Last update |

Unique constraint: `(user_id, channel)` for single-instance channels (telegram, tradingview). Discord and custom_webhook allow multiple per user.

### 4.3 `symbol_mappings` Table

| Field | Type | Constraints | Description |
|---|---|---|---|
| `id` | SERIAL | PK | Primary key |
| `user_id` | UUID | FK, NULLABLE | NULL = system default, non-NULL = user custom |
| `source_symbol` | VARCHAR(20) | NOT NULL | Input symbol (e.g., `ES1!`) |
| `source_platform` | VARCHAR(20) | NOT NULL | `tradingview`, `yfinance`, `manual` |
| `base_symbol` | VARCHAR(10) | NOT NULL | Normalized base (e.g., `ES`) |
| `is_active` | BOOLEAN | NOT NULL, DEFAULT true | Active flag |

Unique constraint: `(user_id, source_symbol, source_platform)`.

### 4.4 Data Validation Rules

| Field | Rule | Error Message |
|---|---|---|
| Discord webhook_url | Must match `https://discord.com/api/webhooks/\d+/.+` | `"Invalid Discord webhook URL format."` |
| Quiet hours start_time | Must be HH:MM format, 00:00-23:59 | `"Invalid time format. Use HH:MM (e.g., 22:00)."` |
| Quiet hours timezone | Must be valid IANA timezone | `"Invalid timezone. Please select from the list."` |
| Quiet hours days_of_week | Each value 0-6, no duplicates | `"Invalid day selection."` |
| Custom webhook URL | Must be valid HTTPS URL | `"Webhook URL must use HTTPS."` |
| TradingView API key | Must match `te_wh_[a-f0-9]{32}` on input | `"Invalid API key format."` |
| Notification preferences | Valid event_type and channel combinations only | `"Invalid preference combination."` |

---

## 5. API Specifications

### 5.1 Notification Endpoints

**`GET /api/notifications/unread-count`**
- Auth: Bearer token (all tiers)
- Response 200: `{"count": 5}`
- Response 401: `{"error": "unauthorized", "message": "Authentication required"}`

**`GET /api/notifications?since={timestamp}&event_type={type}&limit={n}`**
- Auth: Bearer token
- Params: `since` (ISO 8601, optional), `event_type` (optional), `limit` (default 20, max 100)
- Response 200: `{"notifications": [...], "has_more": true}`
- Response 401: `{"error": "unauthorized"}`

**`PATCH /api/notifications/{id}/read`**
- Auth: Bearer token
- Response 200: `{"success": true}`
- Response 404: `{"error": "not_found", "message": "Notification not found"}`

**`POST /api/notifications/mark-all-read`**
- Auth: Bearer token
- Response 200: `{"updated_count": 12}`

**`GET /api/notifications/history?event_type={type}&channel={ch}&status={s}&date_from={d}&date_to={d}&page={n}`**
- Auth: Bearer token
- Response 200: `{"entries": [...], "total": 150, "page": 1, "pages": 8}`

### 5.2 Preferences Endpoints

**`GET /api/notifications/preferences`**
- Auth: Bearer token
- Response 200: Full preferences JSON object

**`PATCH /api/notifications/preferences`**
- Auth: Bearer token
- Body: `{"event_type": "trade.fill", "channel": "telegram", "enabled": false}`
- Response 200: `{"success": true}`
- Response 400: `{"error": "invalid_preference", "message": "Risk breach notifications cannot be disabled for email."}`
- Response 403: `{"error": "tier_restricted", "message": "Discord notifications require Pro plan or higher."}`

**`GET /api/notifications/preferences/quiet-hours`**
- Auth: Bearer token
- Response 200: Quiet hours configuration object

**`PUT /api/notifications/preferences/quiet-hours`**
- Auth: Bearer token
- Body: Full quiet hours object
- Response 200: `{"success": true}`
- Response 422: `{"error": "validation_error", "message": "Start and end time cannot be the same."}`

### 5.3 Integration Endpoints

**`POST /api/integrations/telegram/generate-code`**
- Auth: Bearer token (Trader+ tier)
- Response 200: `{"code": "ABC234", "expires_at": "2026-02-11T20:10:00Z"}`
- Response 403: `{"error": "tier_restricted", "message": "Telegram requires Trader plan or higher."}`

**`DELETE /api/integrations/telegram`**
- Auth: Bearer token
- Response 200: `{"success": true}`
- Response 404: `{"error": "not_found", "message": "No Telegram integration found."}`

**`POST /api/integrations/telegram/webhook`**
- Auth: `X-Telegram-Bot-Api-Secret-Token` header
- Body: Telegram Update JSON
- Response: always 200 (Telegram requirement)

**`POST /api/integrations/discord/webhook`**
- Auth: Bearer token (Pro+ tier)
- Body: `{"webhook_url": "...", "channel_name": "...", "enabled_events": [...], "include_pnl": false}`
- Response 200: `{"id": "...", "test_result": "success"}`
- Response 400: `{"error": "invalid_webhook_url", "message": "Invalid Discord webhook URL format."}`
- Response 422: `{"error": "test_failed", "message": "Could not send to Discord. Please verify the webhook URL."}`

**`DELETE /api/integrations/discord/{id}`**
- Auth: Bearer token
- Response 200: `{"success": true}`

**`POST /api/integrations/tradingview/regenerate-key`**
- Auth: Bearer token
- Response 200: `{"api_key": "te_wh_...", "message": "Copy this key now. It will not be shown again."}`

**`POST /webhooks/tv/{user_webhook_id}`**
- Auth: API key in payload
- See section 3.5.2 for full validation pipeline and responses.

**`GET /api/integrations/tradingview/activity-log?status={s}&page={n}`**
- Auth: Bearer token
- Response 200: `{"entries": [...], "total": 87, "page": 1, "pages": 5}`

### 5.4 Rate Limiting (API)

| Endpoint Category | Rate Limit | Window |
|---|---|---|
| Notification preferences | 30 requests | Per minute |
| Integration configuration | 10 requests | Per minute |
| TradingView webhook | 60 requests | Per hour per user |
| Telegram code generation | 5 requests | Per hour |
| API key regeneration | 3 requests | Per hour |

### 5.5 Error Response Format

All API errors follow this structure:
```json
{
  "error": "error_code",
  "message": "Human-readable description",
  "details": {}
}
```

Standard HTTP status codes: 400 (bad request), 401 (unauthorized), 403 (forbidden/tier restricted), 404 (not found), 409 (conflict), 413 (too large), 415 (unsupported media type), 422 (validation error), 429 (rate limited), 500 (internal error).

---

## 6. UI/UX Specifications

### 6.1 Component Inventory

| Component | Location | States |
|---|---|---|
| Notification Bell Icon | Dashboard header (always visible) | No notifications (no badge), has unread (badge with count), 99+ (max badge), reconnecting (orange dot) |
| Notification Panel | Slide-out panel from right side of screen | Empty, loading, populated, filtered, error |
| Toast Notification | Bottom-right overlay | Appear (slide in), visible (5s), dismiss (fade out) |
| Settings > Notifications | Full page | Loading, loaded, saving (per toggle), error |
| Settings > Integrations > Telegram | Card in integrations page | Not connected, generating code, code displayed, connected |
| Settings > Integrations > Discord | Card in integrations page | Not configured, configuring, testing, configured, test failed |
| Settings > Integrations > TradingView | Card in integrations page | URL/key display, activity log table |

### 6.2 Notification Bell Interaction Flow

1. **Initial page load:** Fetch `GET /api/notifications/unread-count`. Display badge if count > 0.
2. **Click bell:** Open notification panel. Fetch `GET /api/notifications?limit=20`.
3. **Panel loading state:** Show skeleton loaders (3 placeholder rows).
4. **Panel loaded:** Show notifications list.
5. **Scroll to bottom:** Fetch next page. Show spinner at bottom while loading.
6. **No more notifications:** Show subtle text: `"You've seen all your notifications."`
7. **Click notification:** Mark as read (via API), navigate to deep link if available.
8. **Click "Mark all as read":** Batch update via API, reset badge to 0.
9. **Click outside panel:** Close panel.

### 6.3 Responsive Behavior

| Viewport | Notification Panel | Preferences Matrix |
|---|---|---|
| Desktop (>1024px) | Right side panel, 400px wide | Full matrix table |
| Tablet (768-1024px) | Right side panel, 350px wide | Horizontal scroll on matrix |
| Mobile (<768px) | Full-screen overlay | Stacked cards per event type instead of matrix |

### 6.4 Accessibility Requirements

- All toggle switches have associated labels readable by screen readers.
- Toast notifications are announced via `aria-live="polite"` region.
- Notification bell badge count is announced: `aria-label="{count} unread notifications"`.
- Color is not the only indicator of status (icons + text accompany color-coded badges).
- All interactive elements are keyboard-navigable (Tab, Enter, Escape to close panel).
- Focus is trapped within the notification panel when open.

---

## 7. Integration Specifications

### 7.1 Telegram Bot API

| Action | Method | Endpoint | Rate Limit (Telegram) |
|---|---|---|---|
| Send message | POST | `https://api.telegram.org/bot{token}/sendMessage` | 30 msg/s to different chats; 1 msg/s per chat |
| Set webhook | POST | `https://api.telegram.org/bot{token}/setWebhook` | — |
| Edit message (for inline keyboard updates) | POST | `https://api.telegram.org/bot{token}/editMessageReplyMarkup` | Same as sendMessage |

**Error Handling:**

| Telegram Error | Our Response |
|---|---|
| 400 Bad Request | Log error with payload, mark notification failed, do NOT retry (payload issue) |
| 401 Unauthorized | CRITICAL: Bot token invalid. Alert operations immediately. |
| 403 Forbidden (user blocked bot) | Mark user's Telegram as disconnected. Send email: `"You appear to have blocked the TrendEdge bot on Telegram. Your Telegram notifications have been paused."` |
| 429 Too Many Requests | Respect `retry_after` from response, re-queue with that delay |
| 500+ Server Error | Retry with backoff per retry schedule |

### 7.2 Discord Webhook API

| Action | Method | Endpoint | Rate Limit (Discord) |
|---|---|---|---|
| Send embed | POST | `{webhook_url}` | 5 requests per 2 seconds per webhook |

**Error Handling:**

| Discord Error | Our Response |
|---|---|
| 400 Bad Request | Log error, check embed field limits, mark failed |
| 401/403 | Webhook token invalid. Mark integration as needs reconfiguration. Notify user. |
| 404 | Webhook deleted. Mark integration inactive. Notify user: `"Your Discord webhook appears to have been deleted. Please reconfigure in Settings."` |
| 429 | Respect `retry_after`, re-queue |
| 500+ | Retry with backoff |

### 7.3 SendGrid / Resend

**SendGrid:**
- Endpoint: `POST https://api.sendgrid.com/v3/mail/send`
- Auth: `Authorization: Bearer {SENDGRID_API_KEY}`
- Sandbox mode for testing: `"mail_settings": {"sandbox_mode": {"enable": true}}`

**Resend (fallback):**
- Endpoint: `POST https://api.resend.com/emails`
- Auth: `Authorization: Bearer {RESEND_API_KEY}`

### 7.4 Event/Message Contracts

**Internal Event Bus (Redis Pub/Sub):**
- Channel pattern: `events:{event_type}` (e.g., `events:trade.fill`)
- Message format: JSON-serialized event payload (see section 3.1.1)
- All subscribers receive all messages on a channel.

### 7.5 Retry and Fallback Strategies

| Integration | Retry Strategy | Fallback |
|---|---|---|
| Telegram | 5 retries with exponential backoff | Email + In-App for critical events |
| Discord | 5 retries with exponential backoff | None (non-critical) |
| SendGrid | 1 retry with SendGrid, then switch to Resend | Resend API |
| Resend | 3 retries with backoff | In-App notification for critical events |
| yfinance | 3 retries, 30-min intervals | Cached data; alert operations |
| Broker real-time | Auto-reconnect (broker adapter handles) | Delayed data from yfinance/cache |

---

## 8. Security Specifications

### 8.1 Authentication Requirements

| Endpoint Category | Auth Method |
|---|---|
| User notification APIs | Bearer token (JWT via Supabase Auth) |
| TradingView webhook | API key in payload (bcrypt-verified) |
| Telegram webhook | `X-Telegram-Bot-Api-Secret-Token` header |
| SendGrid webhook | Signature verification |
| WebSocket (Supabase Realtime) | JWT token on connection |

### 8.2 Authorization Matrix

| Role | Action | Resource | Allowed |
|---|---|---|---|
| Free user | Read/write | Own notification preferences | Yes (email + in-app channels only) |
| Free user | Configure | Telegram/Discord/Custom Webhook | No |
| Trader user | Configure | Telegram | Yes |
| Trader user | Configure | Discord/Custom Webhook | No |
| Pro user | Configure | Telegram, Discord | Yes |
| Pro user | Configure | Custom Webhook | No |
| Team user | Configure | All channels | Yes |
| Any user | Disable | Risk breach email/in-app | No (locked) |
| Any user | Read | Own notification log | Yes |
| Any user | Read | Other users' notifications | No (RLS enforced) |
| Admin | Read | Any notification log | Yes |
| Admin | Write | System maintenance notifications | Yes |

### 8.3 Data Encryption

| Data | At Rest | In Transit |
|---|---|---|
| Webhook API keys | bcrypt hash (cost=12) in PostgreSQL | HTTPS only |
| Telegram bot token | Environment variable (not in DB) | HTTPS to Telegram API |
| Notification content | PostgreSQL encryption at rest (Supabase default) | HTTPS (API), WSS (WebSocket) |
| Email content | Not stored after send (only in notification_log as rendered content) | TLS to SendGrid/Resend |
| Webhook payloads | Stored in webhook_log with API key redacted | HTTPS |

### 8.4 Input Sanitization

| Input | Sanitization Rule |
|---|---|
| Discord webhook URL | Strict regex match; reject if not matching expected pattern |
| Telegram message text (from user commands) | Escape Markdown V2 special characters |
| TradingView webhook payload | Validate JSON schema; reject unknown fields; size-limit 10KB |
| Custom webhook URL (Team tier) | Must be valid HTTPS URL; reject HTTP, FTP, file:// etc. |
| Notification preference values | Must be boolean; reject non-boolean |
| Symbol mapping inputs | Alphanumeric only, max 20 chars |

### 8.5 Audit Logging

| Event | Logged Data | Retention |
|---|---|---|
| Telegram link/unlink | user_id, action, chat_id (hashed), timestamp | 1 year |
| Webhook API key regeneration | user_id, timestamp, old_key_hash_prefix (first 8 chars) | 1 year |
| Notification preference change | user_id, event_type, channel, old_value, new_value, timestamp | 1 year |
| Failed webhook authentication | source_ip, user_webhook_id, timestamp | 90 days |
| Circuit breaker activation | channel, timestamp, failure_count | 90 days |
| Tier change affecting channels | user_id, old_tier, new_tier, disabled_channels | 1 year |

---

## 9. Performance Specifications

### 9.1 Response Time Requirements

| Operation | Target (p95) | Target (p99) | Measurement |
|---|---|---|---|
| Telegram message delivery | < 5s from event emission | < 8s | Event timestamp to Telegram API 200 response |
| Email delivery (to SendGrid) | < 30s from event emission | < 45s | Event timestamp to SendGrid API 202 response |
| In-app notification delivery | < 2s from event emission | < 3s | Event timestamp to WebSocket message received by browser |
| Discord webhook delivery | < 5s from event emission | < 8s | Event timestamp to Discord API 204 response |
| TradingView webhook response | < 300ms | < 500ms | Request received to response sent |
| `/status` Telegram command | < 3s | < 5s | Message received to reply sent |
| Notification preferences save | < 500ms | < 1s | Toggle click to API response |
| Unread count fetch | < 200ms | < 500ms | API request to response |

### 9.2 Throughput Requirements

| Operation | Sustained | Burst |
|---|---|---|
| Notification dispatch (Celery) | 100 concurrent dispatches | 500 in 1-minute spike |
| TradingView webhook ingestion | 100 requests/second | 200 requests/second for 30s |
| WebSocket connections | 1,000 concurrent | 2,000 concurrent |
| Market data updates | 10 instruments * 1 update/second = 10/s | 50/s during high volatility |

### 9.3 Caching Strategy (see section 3.7.3)

### 9.4 Resource Limits

| Resource | Limit | Action on Exceed |
|---|---|---|
| Notification queue depth | Warning at 500, critical at 2000 | Alert operations; scale Celery workers |
| In-app notifications per user | 10,000 | Retention policy prevents exceeding |
| Webhook log entries per user | ~1,000/month | 30-day retention purge |
| Discord webhooks per user | 3 | UI prevents adding more; API returns 400 |
| Deferred notification queue per user | 100 | If exceeded, oldest deferred notifications are dropped with a log warning |

---

## 10. Testing Specifications

### 10.1 Unit Test Scenarios

| Test Area | Scenarios | Expected Behavior |
|---|---|---|
| Channel routing | User has event disabled | No notification dispatched |
| Channel routing | Quiet hours active, non-critical event | Notification deferred |
| Channel routing | Quiet hours active, critical event, bypass=true | Notification dispatched |
| Channel routing | Free user, Telegram event | Telegram channel skipped |
| Template rendering | Complete payload | All variables populated correctly |
| Template rendering | Missing optional fields | Dash placeholder used, no error |
| Template rendering | Monetary formatting | `$1,250.50` format verified |
| Template rendering | Telegram Markdown V2 escaping | Special characters escaped |
| Rate limiting | 21st Telegram message in 1 hour | Message queued, not dispatched |
| Rate limiting | Critical event during rate limit | Message dispatched (bypass) |
| Retry logic | 1st failure | Retry scheduled at 10s delay |
| Retry logic | 5th failure (final) | Notification marked `failed` |
| Retry logic | Critical event all retries exhausted | Fallback channel triggered |
| Circuit breaker | 5 failures in 5 minutes | Breaker opens, dispatches paused |
| Circuit breaker | After 2-min cooldown, test succeeds | Breaker closes |
| Symbol mapping | `ES1!` input | Correct current contract returned |
| Symbol mapping | Unknown symbol | Returns None, logs warning |
| Quiet hours | Overnight range (22:00-07:00) at 23:00 | Correctly identified as in quiet hours |
| Quiet hours | Overnight range at 08:00 | Correctly identified as NOT in quiet hours |
| Webhook validation | Valid payload | 200 OK, signal created |
| Webhook validation | Invalid API key | 401, no signal created |
| Webhook validation | Missing ticker field | 422, fields listed |
| Webhook validation | Oversized payload (>10KB) | 413 |
| Webhook validation | Duplicate correlation_id | 409 |
| Telegram linking | Valid code | Account linked successfully |
| Telegram linking | Expired code | Error message, no linking |
| Telegram linking | Re-linking | Old chat notified, new mapping saved |

### 10.2 Integration Test Scenarios

| Test | Setup | Verification |
|---|---|---|
| End-to-end Telegram delivery | Emit `trade.fill` event | Test bot receives correctly formatted message |
| End-to-end Discord delivery | Emit `trade.closed` event | Test webhook receives correct embed |
| End-to-end email delivery | Emit `trade.fill` event | SendGrid sandbox confirms email structure |
| End-to-end in-app delivery | Emit `trendline.alert` event | WebSocket test client receives notification within 2s |
| TradingView webhook pipeline | POST valid payload to webhook endpoint | Signal created, notification sent to user |
| Tier gating | Free user attempts Telegram config | 403 returned, no configuration saved |
| Quiet hours end flush | Set quiet hours, defer notifications, end quiet hours | Batch summary dispatched |
| Provider failover | SendGrid returns 500 | Resend receives the email |
| Market data fetch | Trigger daily yfinance fetch | Data stored correctly, no duplicates |
| Contract rollover | Advance date past rollover | Active contract updated, users notified |

### 10.3 Performance Test Criteria

| Test | Target | Method |
|---|---|---|
| Webhook endpoint under load | < 500ms p99 at 100 req/s | Load test with k6 or locust |
| Notification dispatch throughput | 100 concurrent dispatches | Celery stress test |
| WebSocket fan-out | 1,000 concurrent connections | WebSocket load test |
| Database query performance | Notification log query < 200ms | Query explain analysis with production-like data |

### 10.4 Security Test Requirements

| Test | Method | Pass Criteria |
|---|---|---|
| Webhook brute force | Send 1,000 requests with random API keys | No information leakage; IP rate limit triggered |
| API key timing attack | Measure response time for valid vs invalid keys | Constant-time comparison (< 5ms variance) |
| XSS in notification content | Inject script tags in webhook payload | Content sanitized in all channels |
| RLS isolation | Attempt to read other user's notifications via API | 404 or empty result, never other user's data |
| Secret exposure | Search logs, responses, client code for secrets | No API keys, tokens, or secrets found |

---

## 11. Migration & Deployment

### 11.1 Database Migrations

**Phase 1 Migrations (in order):**
1. Create `notification_log` table with indexes
2. Create `notifications` table (in-app) with indexes and RLS policies
3. Create `webhook_log` table with indexes
4. Create `user_integrations` table with unique constraints
5. Create `market_data_daily` table with unique constraint on `(symbol, date)`
6. Create `contract_calendar` table, seed with current year's futures expiration dates
7. Create `symbol_mappings` table, seed with default TradingView-to-broker mappings
8. Add `notification_preferences` JSONB column to `users` table with default value
9. Add `execution_paused` boolean column to `users` table (default: `false`)

**Phase 2 Migrations:**
1. Create `market_data_intraday` table
2. Add template version tracking table

### 11.2 Feature Flags

| Flag | Purpose | Default | Phase |
|---|---|---|---|
| `notifications.telegram.enabled` | Enable/disable Telegram bot | `true` | 1 |
| `notifications.discord.enabled` | Enable/disable Discord integration | `false` | 2 |
| `notifications.email.digests.enabled` | Enable/disable digest emails | `false` | 2 |
| `notifications.inapp.enabled` | Enable/disable in-app notifications | `false` | 2 |
| `notifications.tier_gating.enabled` | Enable/disable tier-based channel restrictions | `false` | 3 |
| `notifications.custom_webhooks.enabled` | Enable/disable custom webhooks | `false` | 3 |
| `notifications.sentiment.enabled` | Enable/disable sentiment pipeline | `false` | 3 |
| `notifications.telegram.manual_trade` | Enable/disable `/trade` command | `false` | 2 |
| `notifications.telegram.inline_keyboards` | Enable/disable interactive buttons on fills | `false` | 3 |

### 11.3 Rollback Procedures

| Scenario | Rollback Action |
|---|---|
| Telegram bot sending malformed messages | Disable via feature flag; fix templates; re-enable |
| Webhook endpoint returning errors | Revert deployment; feature flag not sufficient (external endpoint) |
| Notification queue backing up | Scale Celery workers; if code issue, disable feature flag and drain queue |
| Email provider rejecting sends | Switch to fallback provider immediately; investigate SendGrid account |
| Database migration failure | Run reverse migration; all migrations must have `down` methods |

### 11.4 Deployment Dependencies

| Dependency | Must Be Ready Before |
|---|---|
| Redis instance | Phase 1 start |
| Celery workers configured | Phase 1 start |
| Telegram bot registered with BotFather | Phase 1 start |
| `TELEGRAM_BOT_TOKEN` in environment | Phase 1 start |
| SendGrid account + API key | Phase 2 start |
| Supabase Realtime configured | Phase 2 start |
| Contract calendar seeded | Phase 1 start |
| Symbol mappings seeded | Phase 1 start |

---

## 12. Open Questions & Assumptions

### 12.1 Assumptions

| # | Assumption | Impact if Wrong |
|---|---|---|
| A1 | Redis Pub/Sub is sufficient for event bus (vs. dedicated message broker like RabbitMQ) | May need to migrate to RabbitMQ if message loss is unacceptable; mitigated by event outbox pattern |
| A2 | yfinance free tier is reliable enough for daily OHLCV | May need to switch to paid Databento or Nasdaq Data Link sooner |
| A3 | Supabase Realtime can handle 1,000 concurrent WebSocket connections | May need to implement custom WebSocket server if Supabase limits are hit |
| A4 | Users have at most 20 active instruments requiring market data | Caching and data fetch strategies scale linearly with instrument count |
| A5 | Telegram Bot API rate limits (30 msg/s global) are sufficient | Unlikely to be an issue with <1,000 users |
| A6 | SendGrid free tier (100 emails/day) is sufficient for early phases | Will need paid tier once user base exceeds ~50 active users |
| A7 | Contract rollover dates are predictable and can be pre-seeded | Edge cases like early expiration or exchange schedule changes need manual intervention |

### 12.2 Items Requiring Clarification

| # | Question | Impact | Suggested Default |
|---|---|---|---|
| Q1 | Should the event outbox table be implemented in Phase 1 or Phase 2? | Affects delivery guarantees for critical notifications | Phase 1 (critical for trade.fill reliability) |
| Q2 | What is the exact MJML email template design? | Blocks email template implementation | Use a minimal responsive template; iterate on design |
| Q3 | Should custom symbol mappings support regex patterns or only exact matches? | Affects flexibility of TradingView integration | Exact matches only in Phase 1; regex in Phase 3 |
| Q4 | What is the maximum number of custom webhooks for Team tier? | Affects database schema and UI | Default to 5 |
| Q5 | Should the sentiment pipeline use FinBERT locally or Claude API? | Affects infrastructure requirements and cost | FinBERT locally for Phase 3; Claude API as premium feature |
| Q6 | How should the system handle broker-specific market data fees? | Affects user onboarding flow | Document in broker connection flow; outside scope of this FSD |

### 12.3 Deferred Decisions

| Decision | Deferred To | Reason |
|---|---|---|
| Pine Script companion indicator distribution | Separate initiative | Marketing asset, not core platform |
| SMS notification channel | Not planned | Cost and complexity; Telegram covers mobile use case |
| Slack integration | Future evaluation | Low demand signal in initial user research |
| Push notifications (native mobile) | Phase 4 | Requires mobile app (not yet planned) |

---

## 13. Appendices

### 13.1 Glossary

| Term | Definition |
|---|---|
| Channel | A delivery mechanism for notifications (Telegram, Discord, Email, In-App, Custom Webhook) |
| Channel Adapter | A module that formats and sends notifications for a specific channel |
| Circuit Breaker | A pattern that stops sending to a failing channel to prevent cascading failures |
| Continuous Contract | A synthetic futures symbol that always refers to the current front-month contract |
| Correlation ID | A unique identifier that traces a single event through all systems |
| Critical Event | An event requiring at-least-once delivery with fallback: trade.fill, trade.rejected, trade.closed, risk.limit_breach, account.connection_lost |
| Deferred Notification | A notification held during quiet hours for later batch delivery |
| Domain Event | A significant occurrence in the system (e.g., trade filled, risk limit breached) |
| Front Month | The nearest futures contract month that is actively trading |
| OHLCV | Open, High, Low, Close, Volume — standard market data bar format |
| R-Multiple | A trade's profit/loss expressed as a multiple of the initial risk amount |
| Rollover | The process of transitioning from an expiring futures contract to the next active one |
| RLS | Row-Level Security — PostgreSQL feature ensuring users can only access their own data |
| Tick | The minimum price movement for a futures instrument |

### 13.2 Related FSDs

- FSD-001: Infrastructure & DevOps
- FSD-002: Trendline Detection Engine
- FSD-003: Trade Execution Engine
- FSD-004: Trade Journaling
- FSD-005: Analytics & Performance
- FSD-006: Risk Management
- FSD-008: Authentication & Authorization
- FSD-009: Billing & Subscriptions

### 13.3 Event Payload Examples

**`trade.fill` event:**
```json
{
  "event_type": "trade.fill",
  "user_id": "usr_abc123",
  "timestamp": "2026-02-11T19:32:05Z",
  "correlation_id": "cor_def456",
  "payload": {
    "trade_id": "trd_ghi789",
    "signal_id": "sig_jkl012",
    "symbol": "MES",
    "contract": "MESH26",
    "direction": "BUY",
    "quantity": 2,
    "fill_price": 5205.25,
    "stop_loss": 5190.00,
    "take_profit": 5225.50,
    "risk_amount": 305.00,
    "rr_ratio": 2.03,
    "slippage_ticks": 0.5,
    "signal_source": "tradingview_webhook",
    "playbook": "A+ Trendline Break",
    "trendline_grade": "A+",
    "trendline_touches": 4
  }
}
```

**`risk.limit_breach` event:**
```json
{
  "event_type": "risk.limit_breach",
  "user_id": "usr_abc123",
  "timestamp": "2026-02-11T20:15:30Z",
  "correlation_id": "cor_xyz789",
  "payload": {
    "limit_type": "daily_loss",
    "current_value": 1050.00,
    "limit_value": 1000.00,
    "percent_used": 105,
    "auto_action": "execution_paused",
    "open_positions": 2
  }
}
```

**`digest.daily` event:**
```json
{
  "event_type": "digest.daily",
  "user_id": "usr_abc123",
  "timestamp": "2026-02-11T23:00:00Z",
  "correlation_id": "cor_mno345",
  "payload": {
    "date": "2026-02-11",
    "net_pnl": 425.00,
    "net_r": 3.42,
    "trades_count": 4,
    "wins": 3,
    "losses": 1,
    "win_rate": 0.75,
    "best_trade": { "symbol": "MES", "pnl": 370.00, "r": 1.82 },
    "worst_trade": { "symbol": "CL", "pnl": -125.00, "r": -0.65 },
    "active_alerts": 7,
    "daily_loss_used_pct": 0.32
  }
}
```

### 13.4 Telegram Command Quick Reference

```
/start     - Welcome and linking instructions
/help      - Show all available commands
/status    - Account overview (positions, P&L, margin)
/positions - Detailed open positions table
/pnl       - Today's P&L breakdown
/pnl week  - This week's P&L summary
/pnl month - This month's P&L summary
/pause     - Pause automated execution
/resume    - Resume automated execution
/alerts    - Active trendline alerts
/trade     - Manual trade entry
/unlink    - Disconnect Telegram account
```

### 13.5 Symbol Mapping Quick Reference

| TradingView | yfinance | Base | IBKR | Tradovate (Mar 2026) |
|---|---|---|---|---|
| `ES1!` | `ES=F` | ES | ES + expiry | ESH6 |
| `MES1!` | `MES=F` | MES | MES + expiry | MESH6 |
| `NQ1!` | `NQ=F` | NQ | NQ + expiry | NQH6 |
| `MNQ1!` | `MNQ=F` | MNQ | MNQ + expiry | MNQH6 |
| `YM1!` | `YM=F` | YM | YM + expiry | YMH6 |
| `CL1!` | `CL=F` | CL | CL + expiry | CLJ6 |
| `GC1!` | `GC=F` | GC | GC + expiry | GCJ6 |
| `PL1!` | `PL=F` | PL | PL + expiry | PLJ6 |
| `SI1!` | `SI=F` | SI | SI + expiry | SIH6 |

---

## Changelog

- 2026-02-11: Initial FSD created from PRD-010 v1.0 — Generated by Claude
