# FSD-003c: Broker Adapters

**TrendEdge -- AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-003c |
| Source | FSD-003 (Trade Execution) |
| Title | Broker Adapters |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-11 |

---

## 1. Introduction

### 1.1 Purpose

This sub-FSD specifies the broker adapter layer of the TrendEdge trade execution pipeline. It covers the abstract adapter interface, concrete implementations for Interactive Brokers (IBKR) and Tradovate, the paper trading simulator, and all supporting infrastructure: connection management, authentication, event handling, fill simulation, and paper-to-live transition.

### 1.2 Scope

This document covers:

- **Abstract Broker Interface**: The `BrokerAdapter` base class contract that all broker implementations must fulfill.
- **Broker Adapter Registry**: Per-user broker connection configuration and order routing logic.
- **IBKR Adapter**: Connection management via `ib_async`, order submission, event handling, account data, and IB-specific error handling.
- **Tradovate Adapter**: OAuth authentication, REST order submission, WebSocket streaming, heartbeat protocol, and account data retrieval.
- **Paper Trading Simulator**: Simulated fill model with configurable slippage, paper position monitoring, MAE/MFE tracking, and paper-to-live transition enforcement.
- **Broker Connection API Endpoints**: CRUD and test endpoints for broker connections.
- **Credential Security**: Encryption at rest, transmission security, and credential rotation.
- **Connection Resilience**: Auto-reconnection with exponential backoff, circuit breaker integration, and fallback behavior during broker outages.

### 1.3 Out of Scope

- Signal ingestion, normalization, and validation [see FSD-003a]
- Risk management engine and risk check audit [see FSD-003b]
- Order construction, bracket building, quantity calculation, order state machine, OCO group management, position lifecycle, fill reconciliation, and manual overrides [see FSD-003d]
- Notification delivery mechanisms [see FSD-008]
- User authentication and authorization [see FSD-009]
- Market data feed infrastructure [see FSD-010]

### 1.4 Glossary

| Term | Definition |
|---|---|
| Broker Adapter | A concrete implementation of the `BrokerAdapter` interface that translates TrendEdge orders into broker-specific API calls. |
| IB Gateway | Interactive Brokers' headless API server that runs on the application VPS and exposes a socket-based TWS API. |
| ib_async | Python async library for communicating with IB Gateway via the TWS API protocol. |
| OSO | One-Sends-Other: Tradovate's bracket order type where submitting a parent order automatically sends child orders. |
| OCA | One-Cancels-All: IB's grouping mechanism where filling one order in the group cancels the others. |
| Paper Mode | Simulated trading mode using the `PaperBrokerAdapter` instead of a live broker. Default for all new users. |
| Token Bucket | A rate-limiting algorithm that allows bursts up to a capacity while replenishing tokens at a fixed rate. |
| Circuit Breaker | A mechanism that halts order submission after consecutive broker failures. [Detailed in FSD-003d] |

---

## 2. System Context

### 2.1 Adapter Layer in the Pipeline

The broker adapter layer sits between order construction (FSD-003d) and the external broker APIs. Once an order is constructed and ready for submission, the routing logic selects the appropriate adapter based on the user's configuration and trading mode.

```
+-------------------+
| Order Construction|   [FSD-003d]
| (Bracket Orders)  |
+--------+----------+
         |
    Route to Broker
         |
+--------v----------+
| Broker Adapter     |
| Registry           |
+----+------+-------++
     |      |       |
     v      v       v
+----+--+ +-+----+ ++-------+
| IBKR  | | Trad.| | Paper  |
| Adapt.| | Adapt| | Simul. |
+----+--+ +-+----+ ++-------+
     |      |       |
     v      v       v
+----+--+ +-+----+ ++-------+
| IB    | | Trad.| | Internal|
| Gate- | | API  | | Ledger  |
| way   | | (VPS)| |         |
+-------+ +------+ +---------+
```

### 2.2 External Dependencies

| Dependency | Type | Description |
|---|---|---|
| IB Gateway | Hard (IBKR) | TWS API socket server running on the application VPS. Required for IBKR live/paper trading. |
| Tradovate API | Hard (Tradovate) | REST API + WebSocket for order submission and real-time updates. |
| Redis | Hard | Circuit breaker state, broker health checks. [Cross-reference: FSD-001] |
| PostgreSQL | Hard | Broker connections table, order/position persistence. [Cross-reference: FSD-001] |
| Market Data Cache | Soft | Redis-cached market prices for paper position monitoring. [Cross-reference: FSD-010] |
| Notification Service | Soft | Delivers alerts for broker failures, connection changes. [Cross-reference: FSD-008] |

---

## 3. Functional Specifications

### 3.1 EX-FR-028: Abstract Broker Interface

**Source**: PRD-003 Section 3.6

**Description**: The `BrokerAdapter` abstract base class defines the contract that all broker implementations must fulfill. All methods are async. All methods raise typed exceptions rather than returning error codes.

**Interface Methods**:

| Method | Input | Output | Exceptions |
|---|---|---|---|
| `connect()` | None | `ConnectionStatus` (CONNECTED, FAILED) | `BrokerConnectionError` |
| `disconnect()` | None | None | -- |
| `place_order(order)` | `Order` | `OrderResult` (broker_order_id, status) | `OrderRejectedError`, `InsufficientMarginError`, `InvalidSymbolError`, `BrokerConnectionError` |
| `place_bracket_order(entry, sl, tp)` | Three `Order` objects | `BracketOrderResult` (entry_id, sl_id, tp_id, status) | Same as place_order |
| `cancel_order(broker_order_id)` | string | `CancelResult` (success, reason) | `BrokerConnectionError`, `OrderNotFoundError` |
| `modify_order(broker_order_id, mods)` | string, `OrderModification` | `ModifyResult` (success, new_values) | `BrokerConnectionError`, `OrderNotFoundError`, `InvalidModificationError` |
| `get_positions()` | None | `list[Position]` | `BrokerConnectionError` |
| `get_order_status(broker_order_id)` | string | `OrderStatus` | `BrokerConnectionError`, `OrderNotFoundError` |
| `get_account_info()` | None | `AccountInfo` (balance, margin, buying_power) | `BrokerConnectionError` |
| `subscribe_order_updates(callback)` | Callable | None | `BrokerConnectionError` |
| `subscribe_position_updates(callback)` | Callable | None | `BrokerConnectionError` |
| `get_contract_details(symbol)` | string | `ContractDetails` | `InvalidSymbolError`, `BrokerConnectionError` |

**Exception Type Hierarchy**:

```
BrokerError (base)
  +-- BrokerConnectionError
  +-- OrderRejectedError
  +-- InsufficientMarginError
  +-- InvalidSymbolError
  +-- OrderNotFoundError
  +-- InvalidModificationError
```

**Business Rules**:
- All adapter implementations MUST implement every abstract method. Calling an unimplemented method must raise `NotImplementedError` at the class level, caught by the parameterized compliance test suite (see Section 8.3).
- All methods return typed result objects, never raw broker responses. Raw broker responses are stored in `order_events.raw_broker_response` for audit purposes.
- Connection state is managed internally by each adapter. External callers check connection status via the `broker_connections` table status field.

---

### 3.2 EX-FR-029: Broker Adapter Registry

**Source**: PRD-003 Section 3.6

**Description**: The system maintains a registry of available broker adapters. Configuration is stored per user in the `broker_connections` table.

**Routing Logic**:

When an order is ready for submission:

1. If the user is in paper mode (`user_settings.trading_mode = 'PAPER'`), the order is **always** routed to the `PaperBrokerAdapter`, regardless of any live broker connections.
2. If the user is in live mode, query `broker_connections` for the user's active connection (`is_active = true`).
3. If no active connection exists, reject the order with reason: `"No active broker connection. Configure a broker in Settings."`.
4. Instantiate (or retrieve from cache) the appropriate adapter based on `broker_type`.
5. Verify the adapter connection status. If DISCONNECTED or ERROR, attempt to connect. If connection fails, increment the circuit breaker counter and reject the order.

**Supported Broker Types**:

| Broker Type | Adapter Class | Status |
|---|---|---|
| `IBKR` | `IBKRBrokerAdapter` | Phase 1 (MVP) |
| `TRADOVATE` | `TradovateBrokerAdapter` | Phase 1 (MVP) |
| `PAPER` | `PaperBrokerAdapter` | Phase 1 (MVP) |
| `WEBULL` | `WebullBrokerAdapter` | Phase 3 (Future) |

**Business Rules**:
- Users may have multiple broker connections configured, but only one can be `is_active = true` at a time for live trading.
- The paper simulator is always available and does not require a `broker_connections` entry.
- Adapter instances are cached per user per broker type. A new instance is created only when connection parameters change.

---

### 3.3 EX-FR-030: IBKR Connection Management

**Source**: PRD-003 Section 3.7

**Description**: Manages the connection to IB Gateway via the `ib_async` Python library.

**Processing Logic**:

1. Connect to IB Gateway via `ib_async.IB.connectAsync(host='127.0.0.1', port=4001/4002, clientId=N)`.
   - Port 4001: live trading.
   - Port 4002: paper trading.
2. Set `clientId` to a unique integer per user connection: `hash(user_id) % 999 + 100` (range 100-1098, avoiding reserved IDs 0-99).
3. On connection success:
   - Subscribe to order updates via `ib.orderStatusEvent`.
   - Subscribe to position updates via `ib.positionEvent`.
   - Subscribe to account updates via `ib.accountSummaryEvent`.
   - Update `broker_connections.status = 'CONNECTED'` and `last_connected_at = NOW()`.
4. On connection failure or drop, auto-reconnect with exponential backoff:
   - Initial delay: 1 second.
   - Backoff multiplier: 2x.
   - Maximum delay: 60 seconds.
   - Jitter: +/- 500ms (random).
   - Update `broker_connections.status = 'RECONNECTING'`.
   - Retry indefinitely until connected or user disables the connection.
5. Handle IB's pacing violations (max 50 messages/second) via an internal token bucket rate limiter:
   - Bucket capacity: 45 tokens (5-message buffer below the 50/sec limit).
   - Refill rate: 45 tokens/second.
   - If the rate limit is reached, queue messages and process them at the allowed rate.

**Connection Environment**:
- IB Gateway runs on the application VPS.
- Communication is via local socket (127.0.0.1), no network traversal.
- If IB Gateway is on a separate host, the connection MUST use an SSH tunnel or VPN (see Section 6.2).

**Error Handling**:

| IB Error Code | Meaning | System Response |
|---|---|---|
| 110 | Price out of range | Set order status to REJECTED. Rejection reason: "Broker rejected: price out of acceptable range". Do not retry. |
| 201 | Order rejected | Set order status to REJECTED. Rejection reason: "Broker rejected order: {ib_message}". Do not retry. |
| 502 | Couldn't connect to TWS | Increment circuit breaker counter. Attempt reconnection with backoff. |
| 1100 | Connectivity lost | Mark connection as DISCONNECTED. Notify user. Begin reconnection. |
| 2104 | Market data farm connected | Log as INFO. No action needed. |
| 2106 | HMDS data farm connected | Log as INFO. No action needed. |
| 10197 | Order not found for cancellation | Log as WARNING. Treat cancel as successful (order may have already filled). |

**Fallback Behavior**: If IB Gateway is unavailable for > 5 minutes, the circuit breaker trips (see FSD-003d). Incoming signals are queued (up to 50). When connection is restored, queued signals are re-evaluated (price validity re-checked) and processed if still valid.

---

### 3.4 EX-FR-031: IBKR Order Submission

**Source**: PRD-003 Section 3.7

**Description**: Translates TrendEdge orders into IB-specific Contract and Order objects and submits them via `ib_async`.

**Processing Logic**:

1. **Translate instrument to IB Contract**:
   ```python
   Contract(
       symbol="MNQ",
       exchange="CME",
       secType="FUT",
       lastTradeDateOrContractMonth="202603"
   )
   ```
   The `lastTradeDateOrContractMonth` is derived from the resolved contract symbol (e.g., "MNQH6" -> March 2026 -> "202603").

2. **Create IB Order objects for bracket orders**:
   - **Entry Order**:
     ```python
     Order(
         action="BUY"/"SELL",
         orderType="MKT"/"LMT",
         totalQuantity=qty,
         lmtPrice=price,  # for LIMIT orders
         transmit=False    # do not transmit yet
     )
     ```
   - **Stop Loss Order** (child of entry):
     ```python
     Order(
         action="SELL"/"BUY",  # opposite of entry
         orderType="STP",
         auxPrice=stop_price,
         totalQuantity=qty,
         parentId=entry_orderId,
         transmit=False
     )
     ```
   - **Take Profit Order** (child of entry, last in group):
     ```python
     Order(
         action="SELL"/"BUY",  # opposite of entry
         orderType="LMT",
         lmtPrice=tp_price,
         totalQuantity=qty,
         parentId=entry_orderId,
         ocaGroup=oca_id,
         transmit=True  # transmit entire group atomically
     )
     ```

3. **Transmit flag protocol**: Set `transmit=False` on the parent (entry) and first child (stop loss), `transmit=True` on the last child (take profit). This ensures all three orders are submitted atomically when the final order is transmitted.

4. **OCA Group**: Set `ocaGroup` to a unique string (e.g., `"OCA_{bracket_group_id}"`) on both the stop loss and take profit orders so they form a One-Cancels-All group.

5. **Submit** via `ib.placeOrder(contract, order)` for each of the three orders in sequence (entry, stop, take profit).

6. **Capture IDs**: Store the `orderId` and `permId` returned by IB as `broker_order_id` in the `orders` table.

7. **Update order status** to `SUBMITTED` after successful submission.

**Business Rules**:
- The `transmit=False/True` protocol is critical. If the entry is transmitted without the children, the position would have no protective stop/target until the children are submitted.
- If submission of the entry succeeds but a child order fails, cancel the entry immediately and mark all orders in the bracket as REJECTED.

---

### 3.5 EX-FR-032: IBKR Event Handling

**Source**: PRD-003 Section 3.7

**Description**: Processes asynchronous events from IB Gateway and updates internal order/position state accordingly.

**Event Processing**:

| IB Event | Processing |
|---|---|
| `orderStatus` | Map IB status to TrendEdge states: `Submitted` -> `SUBMITTED`, `Filled` -> `FILLED`, `Cancelled` -> `CANCELLED`, `Inactive` -> `REJECTED`. Update `orders` table. Create `order_events` record with `raw_broker_response`. |
| `execDetails` | Record `fill_price`, `fill_quantity`, `commission`, `execution_time`, `exchange`. Calculate slippage = `fill_price - intended_price`. Update order and position records. Trigger OCO management (FSD-003d). |
| `error` | Handle by error code (see EX-FR-030 error handling table). Log all errors with code, message, and order context. |
| `position` | Reconcile with TrendEdge `positions` table. If discrepancy detected (quantity mismatch, unknown position), log as WARNING and flag for manual review. |

**IB Status to TrendEdge Status Mapping**:

| IB Status | TrendEdge Status | Notes |
|---|---|---|
| `PreSubmitted` | `SUBMITTED` | Order acknowledged but not yet working |
| `Submitted` | `SUBMITTED` | Order working at broker |
| `Filled` | `FILLED` | Fully filled |
| `Cancelled` | `CANCELLED` | Cancelled by user or system |
| `Inactive` | `REJECTED` | Order rejected by broker or exchange |
| `ApiCancelled` | `CANCELLED` | Cancelled via API |

---

### 3.6 EX-FR-033: IBKR Account Data

**Source**: PRD-003 Section 3.7

**Description**: Retrieves and caches account data from IB Gateway for margin checks and dashboard display.

**Processing Logic**:

Retrieve and cache (refresh every 30 seconds) via `ib.accountSummary()` and `ib.accountValues()`:

| IB Field | TrendEdge Field | Purpose |
|---|---|---|
| `NetLiquidation` | `account_balance` | Overall account value |
| `TotalCashValue` | `cash_balance` | Available cash |
| `InitMarginReq` | `margin_info.initial` | Initial margin requirement |
| `MaintMarginReq` | `margin_info.maintenance` | Maintenance margin requirement |
| `AvailableFunds` | `margin_info.available` | Available buying power |
| `RealizedPnL` | `daily_pnl.realized` | Today's realized P&L |
| `UnrealizedPnL` | `daily_pnl.unrealized` | Current unrealized P&L |

Open positions retrieved via `ib.positions()` are reconciled with the internal `positions` table on each refresh.

**Business Rules**:
- Account data is cached in memory and refreshed every 30 seconds to avoid excessive API calls.
- If the cache is stale (> 60 seconds old) when needed for a margin check, a forced refresh is triggered.
- Discrepancies between IB-reported positions and TrendEdge-tracked positions are logged and flagged for reconciliation.

---

### 3.7 EX-FR-034: Tradovate Authentication

**Source**: PRD-003 Section 3.8

**Description**: Manages OAuth-style token-based authentication with the Tradovate API.

**Processing Logic**:

1. **Initial authentication** via `POST https://live.tradovateapi.com/v1/auth/accessTokenRequest`:
   ```json
   {
     "name": "{username}",
     "password": "{password}",
     "appId": "{app_id}",
     "appVersion": "1.0",
     "deviceId": "{device_uuid}",
     "cid": "{client_id}",
     "sec": "{client_secret}"
   }
   ```
   - Live API: `https://live.tradovateapi.com/v1/`
   - Demo API: `https://demo.tradovateapi.com/v1/`

2. **Token storage**: Store the returned `accessToken` and `expirationTime` securely, encrypted at rest via AES-256-GCM (see Section 6.1).

3. **Proactive token refresh**: Set a timer to refresh the token at the 50-minute mark (10-minute buffer before the 60-minute expiry). Refresh via `POST /auth/renewAccessToken` with the current token.

4. **Refresh failure handling**: Retry 3 times with 5-second intervals. If all retries fail:
   - Mark connection as `ERROR` in `broker_connections.status`.
   - Set `broker_connections.last_error = "Authentication token refresh failed after 3 retries"`.
   - Notify the user: "Tradovate authentication failed. Please re-authenticate in dashboard settings."

5. **Transparent retry on 401**: On any 401 response during a regular API call, immediately attempt token refresh, then retry the original request exactly once.

---

### 3.8 EX-FR-035: Tradovate Order Submission

**Source**: PRD-003 Section 3.8

**Description**: Submits orders to Tradovate via REST API, using the OSO (One-Sends-Other) endpoint for bracket orders.

**Processing Logic**:

1. Submit bracket orders via `POST /order/placeOSO`:
   ```json
   {
     "accountSpec": "{account_name}",
     "accountId": "{account_id}",
     "action": "Buy"/"Sell",
     "symbol": "MNQH6",
     "orderQty": 1,
     "orderType": "Market"/"Limit",
     "price": 18450.25,
     "isAutomated": true,
     "bracket1": {
       "action": "Sell"/"Buy",
       "orderType": "Stop",
       "price": 18420.00
     },
     "bracket2": {
       "action": "Sell"/"Buy",
       "orderType": "Limit",
       "price": 18510.50
     }
   }
   ```

2. Set `isAutomated=true` for all programmatic orders (required by Tradovate for API-submitted orders).

3. Capture the returned order IDs for entry, stop, and target. Store as `broker_order_id` in the `orders` table.

4. Update order status to `SUBMITTED`.

**Business Rules**:
- The `accountSpec` and `accountId` are retrieved from the user's `broker_connections.default_account_id` and connection parameters.
- Tradovate's `action` field uses capitalized strings ("Buy", "Sell") unlike TrendEdge's uppercase enum ("BUY", "SELL"). The adapter performs this mapping.
- If the OSO submission fails, all three orders in the bracket are marked REJECTED.

---

### 3.9 EX-FR-036: Tradovate WebSocket Streaming

**Source**: PRD-003 Section 3.8

**Description**: Maintains a persistent WebSocket connection to Tradovate for real-time order, fill, and position updates.

**Processing Logic**:

1. **Connect** to the appropriate WebSocket endpoint:
   - Live: `wss://live.tradovateapi.com/v1/websocket`
   - Demo: `wss://demo.tradovateapi.com/v1/websocket`

2. **Authenticate** the WebSocket connection using the current access token.

3. **Subscribe** to event streams: `order/item`, `fill/item`, `position/item`.

4. **Heartbeat**: Send an empty array `[]` every 2.5 seconds as required by the Tradovate WebSocket specification.
   - If no heartbeat response is received within 10 seconds, consider the connection dead and initiate reconnection.

5. **Process events**: Map Tradovate order statuses to TrendEdge states, record fills, update positions, and trigger OCO management (FSD-003d).

6. **Reconnection**: On disconnect, reconnect with exponential backoff using the same parameters as the IBKR adapter (1s initial, 2x multiplier, 60s max, +/- 500ms jitter).

**Tradovate Status to TrendEdge Status Mapping**:

| Tradovate Status | TrendEdge Status |
|---|---|
| `Working` | `PENDING` |
| `Filled` | `FILLED` |
| `Cancelled` | `CANCELLED` |
| `Rejected` | `REJECTED` |
| `Expired` | `CANCELLED` |

---

### 3.10 EX-FR-037: Tradovate Account Data

**Source**: PRD-003 Section 3.8

**Description**: Retrieves account data from Tradovate via REST endpoints.

**Endpoints Used**:

| Data | Method | Endpoint |
|---|---|---|
| Account info | GET | `/account/item` |
| Cash balance | GET | `/cashBalance/getCashBalanceSnapshot` |
| Open positions | GET | `/position/list` |
| Open orders | GET | `/order/list` |

**Processing Logic**:
- Account balance and margin data are retrieved from `/account/item` and `/cashBalance/getCashBalanceSnapshot`.
- Open positions are reconciled with the internal `positions` table on each refresh (same 30-second cadence as IBKR).
- Open orders are cross-checked against the internal `orders` table for consistency.

---

### 3.11 EX-FR-038: Paper Trading Mode

**Source**: PRD-003 Section 3.9

**Description**: Paper mode uses the exact same code paths as live mode through signal ingestion, validation, enrichment, risk checks, and order construction. The only difference is at the broker routing step: instead of calling a live broker adapter, orders are routed to the `PaperBrokerAdapter` which simulates fills internally.

**Business Rules**:
- Paper mode is the **default** for all new users.
- Paper mode is controlled per user via `user_settings.trading_mode` (values: `PAPER` or `LIVE`).
- When in paper mode, orders are always routed to the paper simulator regardless of any configured live broker connections.
- Paper and live P&L are tracked separately and never aggregated.
- Users can run paper and live simultaneously on different broker connections.

---

### 3.12 EX-FR-039: Paper Fill Simulation

**Source**: PRD-003 Section 3.9

**Description**: The `PaperBrokerAdapter` simulates fills using a configurable slippage model.

**Processing Logic**:

1. **Market orders**: Fill immediately at `signal.entry_price + slippage`.
   - **Slippage model** (default):
     - Micro contracts: 1 tick adverse slippage.
     - Full-size contracts: 2 ticks adverse slippage.
   - Adverse direction: for BUY, `fill_price = entry_price + (slippage_ticks * tick_size)`. For SELL, `fill_price = entry_price - (slippage_ticks * tick_size)`.
   - Slippage is configurable per user via `user_risk_settings.paper_slippage_ticks` (range: 0 to 10 ticks).

2. **Limit orders**: In MVP, fill immediately at the limit price with no slippage. Future enhancement: use real-time market data to determine when the limit price is reached.

3. **Stop orders**: When the paper position monitoring loop (EX-FR-040) detects that the current market price has reached the stop price, the stop order is triggered and filled at `stop_price + slippage` (adverse direction).

4. Paper fills generate the same `order_events` records as live fills, with `is_paper = true`. This ensures identical downstream processing (journal entries, analytics events).

**Slippage Examples**:

| Instrument | Type | Side | Entry/Stop Price | Slippage Config | Fill Price |
|---|---|---|---|---|---|
| MNQ | Market | BUY | 18450.00 | 1 tick (0.25) | 18450.25 |
| MNQ | Market | SELL | 18450.00 | 1 tick (0.25) | 18449.75 |
| NQ | Market | BUY | 18450.00 | 2 ticks (0.50) | 18450.50 |
| MNQ | Limit | BUY | 18440.00 | N/A (MVP) | 18440.00 |
| MNQ | Stop | SELL | 18430.00 | 1 tick (0.25) | 18429.75 |

---

### 3.13 EX-FR-040: Paper Position Monitoring

**Source**: PRD-003 Section 3.9

**Description**: A background loop that monitors open paper positions and triggers stop/target fills when market prices reach those levels.

**Processing Logic**:

1. Paper positions are tracked in the same `positions` table with `is_paper = true`.
2. The paper position monitoring loop runs every **5 seconds** (configurable):
   a. For each open paper position, check the current market price from the market data cache (Redis key `market:price:{instrument}`) or last known price.
   b. **Stop loss trigger**: If the market price has reached the stop loss price:
      - For LONG: market_price <= stop_loss_price.
      - For SHORT: market_price >= stop_loss_price.
      - Fill the stop order (with slippage), cancel the take profit order, close the position with `exit_reason = 'STOP_LOSS'`.
   c. **Take profit trigger**: If the market price has reached the take profit price:
      - For LONG: market_price >= take_profit_price.
      - For SHORT: market_price <= take_profit_price.
      - Fill the take profit order, cancel the stop loss order, close the position with `exit_reason = 'TAKE_PROFIT'`.
   d. **Update tracking metrics** on each iteration:
      - Unrealized P&L: `(current_price - entry_price) * quantity * point_value` for LONG (inverted for SHORT).
      - **MAE** (Maximum Adverse Excursion): track the worst price the position has seen relative to entry. For LONG: `mae = max(0, entry_price - lowest_price_seen)`. Store in ticks and dollars.
      - **MFE** (Maximum Favorable Excursion): track the best price the position has seen relative to entry. For LONG: `mfe = max(0, highest_price_seen - entry_price)`. Store in ticks and dollars.

**Business Rules**:
- The monitoring interval (5 seconds) is configurable via environment variable `PAPER_MONITOR_INTERVAL_SECONDS`.
- If market data is unavailable (cache miss), the position retains its last known price. No stop/target triggers occur until fresh data is available.
- The monitoring loop is lightweight. It queries only the market data cache, not external APIs.

**Edge Cases**:
- Market gaps past the stop price (e.g., stop at 18430 but price gaps to 18400): the stop fills at the gap price + slippage, not the stop price. This simulates real-world gap behavior.
- Multiple positions in the same instrument: each is evaluated independently.

---

### 3.14 EX-FR-041: Paper-to-Live Transition

**Source**: PRD-003 Section 3.9

**Description**: Enforces a minimum paper trading period before users can enable live trading, with explicit multi-step confirmation.

**Processing Logic**:

1. **Minimum paper period check**:
   - `paper_start_date` is set automatically when the user's first paper trade fills.
   - `minimum_paper_days` is configurable per user via `user_risk_settings.min_paper_trading_days` (default: 60, range: 0-365).
   - If `(current_date - paper_start_date).days < minimum_paper_days`:
     - Reject the transition request with: `"You have {remaining} days remaining in your paper trading period. Paper start: {date}. Minimum period: {min_days} days."`.

2. **Eligibility notification**: If the minimum period is met, display a notification: "You are eligible to enable live trading."

3. **Transition flow** (requires explicit opt-in):
   a. User clicks "Enable Live Trading" in dashboard settings.
   b. User checks a checkbox: "I understand I am trading with real money and real losses."
   c. User types the confirmation text: `"I understand I am trading with real money"` in an input field.
   d. System validates the typed text matches exactly (case-insensitive).
   e. If match: set `user_settings.trading_mode = 'LIVE'`. Log the transition in `execution_audit_log` with `event_type = 'trading_mode.changed'`.
   f. If mismatch: display error `"Confirmation text does not match. Please type exactly: 'I understand I am trading with real money'"`.

4. **Skipping paper period**: Setting the minimum paper period to 0 requires an additional acknowledgment: "I acknowledge that skipping paper trading increases my risk of losses."

5. **Post-transition behavior**:
   - All paper trading history is retained permanently.
   - Paper and live P&L remain separated.
   - Users can switch back to paper mode at any time without restriction.
   - Users can run paper and live simultaneously on different broker connections.

---

## 4. Data Specifications

### 4.1 `broker_connections` Table

```sql
CREATE TABLE broker_connections (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    broker_type VARCHAR(20) NOT NULL CHECK (broker_type IN ('IBKR','TRADOVATE','WEBULL','PAPER')),
    connection_params_encrypted BYTEA NOT NULL,
    default_account_id VARCHAR(100),
    is_active BOOLEAN NOT NULL DEFAULT FALSE,
    is_paper BOOLEAN NOT NULL DEFAULT TRUE,
    status VARCHAR(20) NOT NULL DEFAULT 'DISCONNECTED'
        CHECK (status IN ('CONNECTED','DISCONNECTED','RECONNECTING','ERROR')),
    last_connected_at TIMESTAMPTZ,
    last_error TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_broker_connections_user_id ON broker_connections(user_id);
```

**Column Details**:

| Column | Description |
|---|---|
| `connection_params_encrypted` | AES-256-GCM encrypted JSONB blob containing broker-specific credentials. Never decrypted for display; only decrypted in-memory during active connection. |
| `default_account_id` | The account to route orders to. For IBKR, this is the account string (e.g., "DU12345"). For Tradovate, this is the numeric account ID. |
| `is_active` | Only one connection per user can be active at a time for live trading. |
| `is_paper` | Whether this connection targets a paper/demo account at the broker. |
| `status` | Current connection state. Updated by the adapter on connect/disconnect/error. |
| `last_error` | Human-readable description of the most recent connection error. Cleared on successful connection. |

### 4.2 Contract Specifications Reference Data

The `contract_specifications` table stores static instrument data used by all adapters for symbol translation and margin checks.

```sql
CREATE TABLE contract_specifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    symbol VARCHAR(10) NOT NULL UNIQUE,
    full_name VARCHAR(100) NOT NULL,
    exchange VARCHAR(10) NOT NULL,
    tick_size DECIMAL(10,6) NOT NULL,
    tick_value DECIMAL(10,4) NOT NULL,
    point_value DECIMAL(10,4) NOT NULL,
    contract_size DECIMAL(10,4),
    margin_day DECIMAL(10,2),
    margin_overnight DECIMAL(10,2),
    is_micro BOOLEAN NOT NULL DEFAULT TRUE,
    trading_hours_rth VARCHAR(50),
    trading_hours_eth VARCHAR(50)
);
```

**Reference Data**:

| Symbol | Full Name | Tick Size | Tick Value | Point Value | Exchange | Is Micro |
|---|---|---|---|---|---|---|
| MNQ | Micro E-mini Nasdaq-100 | 0.25 | $0.50 | $2.00 | CME | Yes |
| MES | Micro E-mini S&P 500 | 0.25 | $1.25 | $5.00 | CME | Yes |
| MYM | Micro E-mini Dow Jones | 1.00 | $0.50 | $0.50 | CBOT | Yes |
| M2K | Micro E-mini Russell 2000 | 0.10 | $0.50 | $5.00 | CME | Yes |
| MGC | Micro Gold | 0.10 | $1.00 | $10.00 | COMEX | Yes |
| MCL | Micro WTI Crude Oil | 0.01 | $1.00 | $100.00 | NYMEX | Yes |
| SIL | Micro Silver | 0.005 | $2.50 | $500.00 | COMEX | Yes |
| NQ | E-mini Nasdaq-100 | 0.25 | $5.00 | $20.00 | CME | No |
| ES | E-mini S&P 500 | 0.25 | $12.50 | $50.00 | CME | No |

### 4.3 `user_risk_settings` (Broker-Adapter-Relevant Fields)

The following fields in `user_risk_settings` are directly relevant to broker adapter behavior:

| Field | Type | Default | Description |
|---|---|---|---|
| `paper_slippage_ticks` | integer | 1 | Number of ticks of adverse slippage applied to paper fills (0-10). |
| `min_paper_trading_days` | integer | 60 | Minimum days of paper trading before live trading can be enabled (0-365). |
| `prefer_micro` | boolean | true | Whether TradingView continuous symbols map to micro or full-size contracts. |
| `stop_type` | enum | STOP_MARKET | Whether stop orders use STOP_MARKET or STOP_LIMIT at the broker. |

### 4.4 Commission Schedule Reference Data

| Broker | Instrument Type | Per-Contract Per-Side | Notes |
|---|---|---|---|
| IBKR | Micro futures | $0.25 - $0.85 | Varies by monthly volume tier. Default estimate: $0.62 |
| IBKR | Full-size futures | $0.85 | Standard rate |
| Tradovate | Micro futures | $0.79 | Standard pricing. Funded accounts may have $0 commissions. |
| Tradovate | Full-size futures | $1.29 | Standard pricing |
| Webull | Micro futures | ~$0.25 + exchange fees | Approximate; varies |

Exchange fees (approximate, per side):
- CME E-mini/Micro: $0.27 - $0.47
- CBOT: $0.25 - $0.45
- NYMEX: $0.25 - $0.50
- COMEX: $0.25 - $0.50

---

## 5. API Specifications

### 5.1 Broker Connection Endpoints

#### `GET /api/v1/brokers`

**Authentication**: Bearer token (session token).
**Description**: Returns all broker connections for the authenticated user.

**Response 200**:
```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440010",
    "broker_type": "IBKR",
    "default_account_id": "DU12345",
    "is_active": true,
    "is_paper": false,
    "status": "CONNECTED",
    "last_connected_at": "2026-02-11T14:00:00Z",
    "created_at": "2026-02-01T10:00:00Z"
  }
]
```

**Business Rules**:
- `connection_params_encrypted` is NEVER returned in API responses.
- `last_error` is included only when `status` is `ERROR`.

---

#### `POST /api/v1/brokers`

**Authentication**: Bearer token.
**Description**: Creates a new broker connection.

**Request**:
```json
{
  "broker_type": "IBKR",
  "connection_params": {
    "host": "127.0.0.1",
    "port": 4001,
    "client_id": 100
  },
  "default_account_id": "DU12345",
  "is_paper": false
}
```

**Processing Logic**:
1. Validate `broker_type` is one of the supported types.
2. Encrypt `connection_params` using AES-256-GCM (see Section 6.1).
3. Store in `broker_connections` with `is_active = false` and `status = 'DISCONNECTED'`.
4. Return the created connection (without credentials).

**Response 201**:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440010",
  "broker_type": "IBKR",
  "default_account_id": "DU12345",
  "is_active": false,
  "is_paper": false,
  "status": "DISCONNECTED",
  "created_at": "2026-02-11T15:00:00Z"
}
```

---

#### `PUT /api/v1/brokers/{connection_id}`

**Authentication**: Bearer token.
**Description**: Updates broker connection settings. Can update `connection_params`, `default_account_id`, `is_active`, `is_paper`.

**Business Rules**:
- Setting `is_active = true` on one connection automatically sets `is_active = false` on all other connections for the same user.
- Updating `connection_params` requires the connection to be re-tested (see test endpoint).
- If the connection is currently `CONNECTED`, updating connection parameters triggers a disconnect and reconnect with new parameters.

---

#### `DELETE /api/v1/brokers/{connection_id}`

**Authentication**: Bearer token.
**Description**: Removes a broker connection.

**Business Rules**:
- Active connections (`is_active = true`) must be deactivated first. Attempting to delete an active connection returns HTTP 400: `{"error": "Cannot delete an active connection. Deactivate it first."}`.
- Connected connections (`status = 'CONNECTED'`) are disconnected before deletion.

---

#### `POST /api/v1/brokers/{connection_id}/test`

**Authentication**: Bearer token.
**Description**: Tests a broker connection by attempting to connect and retrieve account info.

**Processing Logic**:
1. Decrypt the connection parameters.
2. Instantiate a temporary adapter instance.
3. Call `adapter.connect()`.
4. If connected, call `adapter.get_account_info()`.
5. Disconnect the temporary adapter.
6. Return the connection test result.

**Response 200** (success):
```json
{
  "status": "success",
  "broker_type": "IBKR",
  "account_id": "DU12345",
  "account_info": {
    "balance": 50000.00,
    "available_funds": 48000.00,
    "currency": "USD"
  },
  "latency_ms": 245
}
```

**Response 200** (failure):
```json
{
  "status": "failed",
  "broker_type": "IBKR",
  "error": "Connection refused on port 4001. Ensure IB Gateway is running."
}
```

---

### 5.2 WebSocket Events (Broker Status)

The execution WebSocket (`WS /api/v1/ws/execution`) emits broker-related events:

| Event Type | Payload | Description |
|---|---|---|
| `broker.status_changed` | `{broker_type, status, message}` | Broker connection status change (CONNECTED, DISCONNECTED, RECONNECTING, ERROR) |

---

## 6. Security Specifications

### 6.1 Broker Credential Encryption at Rest (EX-SEC-001)

All broker credentials (API keys, secrets, OAuth tokens, IB Gateway passwords) are encrypted at rest using AES-256-GCM.

**Implementation**:

1. **Encryption key**: Stored in environment variable `BROKER_ENCRYPTION_KEY` (or fetched from a secrets manager such as Railway's built-in secrets or AWS Secrets Manager). The key is 256 bits (32 bytes), hex-encoded in the environment variable.

2. **Per-credential nonce**: A unique 96-bit (12-byte) nonce is generated per encryption operation using `os.urandom(12)`.

3. **Storage format**: The encrypted output is stored as: `nonce (12 bytes) || ciphertext || tag (16 bytes)` in the `connection_params_encrypted` BYTEA column.

4. **Decryption**: Retrieve the nonce from the first 12 bytes, the tag from the last 16 bytes, and the ciphertext from the middle.

**Prohibitions**:
- Credentials SHALL NEVER appear in application logs. All logging of broker connection events must mask credential values: `"Tradovate auth with user: t***e"`.
- Credentials SHALL NEVER appear in API responses. The `GET /api/v1/brokers` endpoint returns `broker_type` and `status` but never `connection_params`.
- Credentials SHALL NEVER appear in error messages or stack traces. Exception handlers must sanitize credential data before logging.

### 6.2 Credential Transmission (EX-SEC-002)

- All external broker API calls (Tradovate) use **TLS 1.2+**. The application verifies TLS certificates and rejects connections with invalid or self-signed certificates (except in development mode).
- IB Gateway communication is local (`127.0.0.1`); socket communication does not traverse the network. If IB Gateway is on a separate host, the connection **must** use an SSH tunnel or VPN.
- Credentials are never included in URL query parameters. All credentials are sent in request bodies or headers.

### 6.3 Credential Rotation (EX-SEC-003)

- Users can update broker credentials via `PUT /api/v1/brokers/{connection_id}` with new `connection_params`.
- The system validates the new credentials by performing a test connection (`POST /api/v1/brokers/{connection_id}/test`) before replacing the old ones.
- Upon successful validation, the old encrypted credentials are overwritten (not retained).
- The broker adapter is disconnected and reconnected with the new credentials without application restart.

---

## 7. Performance Specifications

### 7.1 Latency Targets

| Metric | Target (p50) | Target (p95) | Measurement Point |
|---|---|---|---|
| Broker order submission to fill acknowledgment (IBKR) | < 500ms | < 2s | Time from `place_order` call to fill event received |
| Broker order submission to fill acknowledgment (Tradovate) | < 1s | < 3s | Time from REST call to WebSocket fill event received |
| IBKR connection establishment | < 2s | < 5s | Time from `connectAsync()` to connection confirmed |
| Tradovate token acquisition | < 1s | < 3s | Time from auth request to token received |
| Paper fill simulation | < 50ms | < 100ms | Time from order submission to simulated fill recorded |

### 7.2 Throughput Targets

| Metric | Target | Notes |
|---|---|---|
| Broker API calls (IBKR) | 45/second | IB pacing limit with 5-message buffer |
| Broker API calls (Tradovate) | 50/minute per endpoint | Tradovate rate limit |
| Paper position monitoring cycle | < 500ms for 100 positions | Per monitoring loop iteration |

### 7.3 Availability Targets

| Component | Target | Measurement |
|---|---|---|
| Broker connection (IBKR) | 99.5% during market hours | Excludes IB's own scheduled maintenance |
| Broker connection (Tradovate) | 99.5% during market hours | Excludes Tradovate's own scheduled maintenance |
| Paper trading simulator | 99.9% uptime | Internal component, no external dependencies |

### 7.4 Broker API Latency Tracking

Daily automated benchmark (paper mode):
1. Submit a LIMIT order far from market (will not fill).
2. Measure round-trip time to broker acknowledgment.
3. Cancel the order.
4. Measure cancel round-trip time.
5. Log results with timestamp for trend analysis.

Expected baselines:
- IBKR: < 500ms round-trip (local IB Gateway).
- Tradovate: < 1s round-trip (REST API).
- Alert if > 5x baseline.

---

## 8. Testing Specifications

### 8.1 Unit Tests

#### 8.1.1 Paper Fill Simulation Tests

| Test ID | Test Case | Input | Expected |
|---|---|---|---|
| UT-PF-001 | Market BUY with 1 tick slippage | MNQ, BUY, price=18450.00, slippage=1 tick | fill_price=18450.25 |
| UT-PF-002 | Market SELL with 1 tick slippage | MNQ, SELL, price=18450.00, slippage=1 tick | fill_price=18449.75 |
| UT-PF-003 | Full-size with 2 tick slippage | NQ, BUY, price=18450.00, slippage=2 ticks | fill_price=18450.50 |
| UT-PF-004 | Zero slippage configured | MNQ, BUY, price=18450.00, slippage=0 | fill_price=18450.00 |
| UT-PF-005 | Limit order fill | MNQ, LIMIT BUY at 18440.00 | fill_price=18440.00 (no slippage in MVP) |
| UT-PF-006 | Stop order fill with slippage | MNQ, STOP SELL at 18430.00, slippage=1 tick | fill_price=18429.75 |

#### 8.1.2 Paper Position Monitoring Tests

| Test ID | Test Case | Input | Expected |
|---|---|---|---|
| UT-PM-001 | Stop loss triggered LONG | LONG MNQ entry=18450, stop=18430, market_price=18429 | Stop triggered, position closed, exit_reason=STOP_LOSS |
| UT-PM-002 | Take profit triggered LONG | LONG MNQ entry=18450, target=18490, market_price=18491 | TP triggered, position closed, exit_reason=TAKE_PROFIT |
| UT-PM-003 | Stop loss triggered SHORT | SHORT MNQ entry=18450, stop=18470, market_price=18471 | Stop triggered, position closed, exit_reason=STOP_LOSS |
| UT-PM-004 | Price between stop and target | LONG MNQ entry=18450, stop=18430, target=18490, market=18460 | Position remains open, unrealized P&L updated, MAE/MFE updated |
| UT-PM-005 | MAE tracking | LONG entry=18450, prices seen: 18440, 18445, 18460 | MAE = 10 ticks ($5.00 for MNQ) |
| UT-PM-006 | MFE tracking | LONG entry=18450, prices seen: 18440, 18445, 18470 | MFE = 20 ticks ($10.00 for MNQ) |
| UT-PM-007 | Market data unavailable | No market price in cache | Position not updated, no triggers, warning logged |

#### 8.1.3 Paper-to-Live Transition Tests

| Test ID | Test Case | Input | Expected |
|---|---|---|---|
| UT-PT-001 | Within minimum paper period | paper_start=30 days ago, min=60 | Rejected: "You have 30 days remaining..." |
| UT-PT-002 | Past minimum paper period | paper_start=65 days ago, min=60 | Transition allowed |
| UT-PT-003 | Correct confirmation text | typed="I understand I am trading with real money" | Trading mode set to LIVE |
| UT-PT-004 | Incorrect confirmation text | typed="I understand" | Error: "Confirmation text does not match..." |
| UT-PT-005 | Min paper days set to 0 | min=0, additional_ack=true | Transition allowed immediately |
| UT-PT-006 | Min paper days set to 0, no ack | min=0, additional_ack=false | Rejected: requires additional acknowledgment |

### 8.2 Integration Tests

#### 8.2.1 IBKR Adapter Tests (EX-TEST-006)

Using mock `ib_async.IB` client:

| Test ID | Test Case | Verification |
|---|---|---|
| IT-IB-001 | Connection establishment | Verify `connectAsync` called with correct host, port, clientId. Connection status set to CONNECTED. |
| IT-IB-002 | Automatic reconnection after disconnect | Simulate disconnect. Verify reconnection attempt with exponential backoff (1s, 2s, 4s). Status set to RECONNECTING. |
| IT-IB-003 | Market order submission | Verify correct IB `Contract` and `Order` objects constructed. `orderType="MKT"`. |
| IT-IB-004 | Limit order submission | Verify `lmtPrice` set correctly on the IB `Order` object. |
| IT-IB-005 | Bracket order submission | Verify parent-child relationship (`parentId`), OCA group (`ocaGroup`), and transmit flags (`False, False, True`). |
| IT-IB-006 | Fill event processing | Simulate `execDetails` callback. Verify order status updated to FILLED with correct fill_price and commission. |
| IT-IB-007 | Partial fill | Simulate partial `execDetails`. Verify PARTIAL_FILL status and remaining quantity tracking. |
| IT-IB-008 | Order cancellation | Verify cancel request sent. Verify status updated to CANCELLED. |
| IT-IB-009 | Error 110 (price out of range) | Verify order marked REJECTED with appropriate message. No retry. |
| IT-IB-010 | Error 201 (order rejected) | Verify order marked REJECTED with IB error message. No retry. |
| IT-IB-011 | Error 502 (couldn't connect) | Verify circuit breaker counter incremented. Reconnection attempted. |
| IT-IB-012 | Error 1100 (connectivity lost) | Verify status set to DISCONNECTED, user notified, reconnection started. |
| IT-IB-013 | Error 10197 (order not found for cancel) | Verify cancel treated as successful. Warning logged. |
| IT-IB-014 | Pacing violation handling | Submit 50+ messages rapidly. Verify token bucket queues excess messages and processes at 45/sec. |

#### 8.2.2 Tradovate Adapter Tests (EX-TEST-007)

Using `httpx` mock responses and mock WebSocket:

| Test ID | Test Case | Verification |
|---|---|---|
| IT-TV-001 | OAuth token acquisition | Mock successful auth response. Verify token stored encrypted. |
| IT-TV-002 | Token refresh at 50 minutes | Verify proactive refresh timer fires before 60-minute expiry. |
| IT-TV-003 | Token refresh failure (3 retries) | Verify connection marked as ERROR after 3 failed retries. User notified. |
| IT-TV-004 | Order submission via REST | Mock 200 response. Verify correct JSON structure sent to `/order/placeOrder`. |
| IT-TV-005 | OSO bracket order submission | Mock 200 response. Verify correct bracket JSON structure sent to `/order/placeOSO`. |
| IT-TV-006 | WebSocket order event processing | Mock fill event on WebSocket. Verify order updated to FILLED. |
| IT-TV-007 | WebSocket heartbeat | Verify empty array `[]` sent every 2.5 seconds. |
| IT-TV-008 | HTTP 401 -> token refresh -> retry | Mock 401, then successful refresh, then successful retry. Verify seamless recovery. |
| IT-TV-009 | HTTP 429 rate limiting | Mock 429 response. Verify exponential backoff (1s, 2s, 4s). Max 3 retries. |
| IT-TV-010 | WebSocket disconnect and reconnect | Simulate WebSocket close. Verify reconnection with exponential backoff. |

#### 8.2.3 Adapter Interface Compliance (EX-TEST-008)

Parameterized test suite that runs against **every** `BrokerAdapter` implementation (IBKR, Tradovate, Paper):

| Test ID | Test Case | Verification |
|---|---|---|
| IT-AC-001 | All abstract methods implemented | No `NotImplementedError` raised on any method call. |
| IT-AC-002 | `connect()` returns `ConnectionStatus` | Return type is `ConnectionStatus` enum. |
| IT-AC-003 | `place_order()` returns `OrderResult` | Return type is `OrderResult` with `broker_order_id` and `status` fields. |
| IT-AC-004 | `place_bracket_order()` returns `BracketOrderResult` | Return type has `entry_id`, `sl_id`, `tp_id`, and `status` fields. |
| IT-AC-005 | Exceptions are typed | Connection errors raise `BrokerConnectionError`. Rejections raise `OrderRejectedError`. |

### 8.3 End-to-End Tests

#### 8.3.1 Webhook-to-Paper-Trade Flow (EX-TEST-009)

1. POST a TradingView-formatted webhook to the test user's webhook URL.
2. Verify HTTP 200 response with signal_id within 2 seconds.
3. Wait up to 10 seconds for async processing.
4. Query `GET /api/v1/signals/{signal_id}` and verify status is `FILLED`.
5. Query `GET /api/v1/positions` and verify a new OPEN position exists with correct instrument, direction, entry_price (with paper slippage), stop_loss, and take_profit.
6. Verify `order_events` records show the state transitions: CONSTRUCTED -> SUBMITTED -> FILLED.
7. Verify paper slippage was applied correctly (fill_price = entry_price + 1 tick for BUY).

#### 8.3.2 Broker Disconnection During Order (EX-TEST-014)

1. Start an order submission.
2. Simulate broker connection drop mid-submission (mock the adapter to raise `BrokerConnectionError` after sending the order but before receiving confirmation).
3. Verify the circuit breaker counter increments.
4. Verify the user receives a notification (check notification queue).
5. Simulate reconnection.
6. Verify the system queries the broker for the order status (fill reconciliation).
7. If the broker confirms the order was placed, verify TrendEdge updates its records accordingly.

### 8.4 Security Tests

| Test ID | Test Case | Expected |
|---|---|---|
| ST-006 | Search all logs for test broker credentials | Zero matches |
| ST-007 | GET /api/v1/brokers returns credentials | Credentials NOT in response body |
| ST-011 | Broker connection with expired TLS certificate | Connection refused (except dev mode) |
| ST-012 | Encrypted credentials in DB are not plaintext | Raw BYTEA value is not valid JSON |

---

## 9. Integration Protocol Details

### 9.1 IBKR Rate Limiting

IB Gateway enforces a maximum of 50 messages per second. TrendEdge implements an internal token bucket rate limiter:

- **Bucket capacity**: 45 tokens (5-message safety buffer).
- **Refill rate**: 45 tokens per second.
- **Behavior when exhausted**: Messages are queued in a FIFO queue and processed as tokens become available.
- **Queue overflow**: If the queue exceeds 100 messages, the oldest messages are dropped and logged as WARNING.

### 9.2 Tradovate Endpoints Reference

| Action | Method | Endpoint | Rate Limit |
|---|---|---|---|
| Authenticate | POST | /auth/accessTokenRequest | -- |
| Refresh token | POST | /auth/renewAccessToken | -- |
| Place order | POST | /order/placeOrder | 50/min |
| Place bracket (OSO) | POST | /order/placeOSO | 50/min |
| Cancel order | POST | /order/cancelOrder | 50/min |
| Modify order | POST | /order/modifyOrder | 50/min |
| Get positions | GET | /position/list | 120/min |
| Get orders | GET | /order/list | 120/min |
| Get account | GET | /account/item | 120/min |
| Get cash balance | GET | /cashBalance/getCashBalanceSnapshot | 120/min |

**Error Handling**:

| HTTP Status | Cause | Response |
|---|---|---|
| 401 | Token expired | Refresh token, retry request once. If refresh fails, mark connection ERROR, notify user. |
| 429 | Rate limited | Exponential backoff: 1s, 2s, 4s. Max 3 retries. |
| 500 | Server error | Retry once after 2s. If persistent, increment circuit breaker. |
| Timeout (>10s) | Network issue | Retry once. If persistent, increment circuit breaker. |

### 9.3 Redis Keys (Broker-Related)

| Key Pattern | Type | TTL | Purpose |
|---|---|---|---|
| `circuit_breaker:{user_id}` | Hash | -- | Circuit breaker state (failures, tripped_at, cooldown) |
| `broker:health:{user_id}:{broker_type}` | Hash | -- | Broker health check state |
| `market:price:{instrument}` | String | 30s | Latest market price cache (used by paper position monitor) |

### 9.4 Notification Events (Broker-Related)

| Event | Priority | Channels |
|---|---|---|
| Broker connection lost | Critical | Dashboard, Telegram, Email |
| Broker reconnected | Normal | Dashboard |
| Tradovate auth failure | High | Dashboard, Email |
| Order rejected by broker | High | Dashboard, Telegram |

---

## 10. UI/UX Specifications

### 10.1 Broker Connection Status

**Location**: Dashboard header bar.

**States**:
- **Connected**: Green dot + broker name (e.g., "IBKR: Connected").
- **Reconnecting**: Yellow dot + "Reconnecting..." + animated spinner.
- **Disconnected**: Red dot + "Disconnected" + "Reconnect" button.
- **Error**: Red dot + error icon + "Connection Error" + tooltip with error details.

### 10.2 Paper Trading Indicator

When the user is in paper mode, the entire dashboard shows:
- A persistent banner at the top: "PAPER TRADING MODE - No real money at risk" (blue background, white text).
- All P&L values are prefixed with "Paper:" (e.g., "Paper: +$125.50").
- The "New Trade" button shows "New Paper Trade".
- Paper trades have a distinct visual style (e.g., dashed borders on position cards, paper icon).

---

## 11. Environment Configuration

| Variable | Description | Example |
|---|---|---|
| `IBKR_ENABLED` | Enable IBKR adapter | `true` |
| `TRADOVATE_ENABLED` | Enable Tradovate adapter | `true` |
| `IBKR_GATEWAY_HOST` | IB Gateway hostname | `127.0.0.1` |
| `IBKR_GATEWAY_PORT_LIVE` | IB Gateway live port | `4001` |
| `IBKR_GATEWAY_PORT_PAPER` | IB Gateway paper port | `4002` |
| `BROKER_ENCRYPTION_KEY` | AES-256 key for credential encryption | (hex-encoded 32 bytes) |
| `PAPER_MONITOR_INTERVAL_SECONDS` | Paper position monitoring interval | `5` |

---

## 12. Open Questions & Assumptions

### 12.1 Open Questions

| ID | Question | Impact | Status |
|---|---|---|---|
| OQ-002 | What is the exact IB Gateway deployment model? One gateway instance per user, or shared gateway with multiple clientIds? | Affects VPS resource planning and connection management. | Open -- Assumed shared gateway with unique clientIds per user. |
| OQ-005 | What is the Webull futures API availability and authentication model? | Affects Phase 3 timeline. | Open -- Webull adapter is P1 (Phase 3). API documentation review needed. |
| OQ-001 | Should the paper trading simulator use real-time market data for stop/target triggers, or is periodic polling (every 5 seconds) sufficient for MVP? | Affects paper fill accuracy and resource usage. | Open -- MVP uses polling; real-time data enhancement deferred. |

### 12.2 Assumptions

| ID | Assumption | Risk if Wrong |
|---|---|---|
| AS-001 | IB Gateway will be hosted on the same VPS as the application, enabling local socket communication with <1ms latency. | If IB Gateway is remote, latency increases and TLS/SSH tunnel is required. |
| AS-004 | Users will have at most 1-2 active broker connections. The system does not need to optimize for users with 10+ broker connections. | Multi-account routing may need optimization if prop firm support requires many connections. |
| AS-005 | The paper trading simulator with periodic polling (5-second intervals) provides sufficient accuracy for validation purposes. Exact-tick simulation is not required for MVP. | Paper results may differ from live results by 1-2 ticks in fast-moving markets. This is acceptable. |
| AS-007 | The commission schedule is relatively stable. Commission tracking uses broker-reported values when available, with fallback to configured schedules. | If brokers change commission structures frequently, the fallback schedule may become inaccurate. |

---

## 13. Cross-References

| Document | Relationship |
|---|---|
| FSD-003a (Signal Ingestion & Normalization) | Upstream: signals arrive normalized before reaching broker adapter routing. |
| FSD-003b (Risk Management Engine) | Upstream: signals pass risk checks before orders are routed to broker adapters. |
| FSD-003d (Order Construction & Lifecycle) | Peer: order construction builds bracket orders that this layer submits. Order state machine and OCO management respond to fill events from adapters. Circuit breaker logic consumes adapter errors. Fill reconciliation queries adapters on reconnection. |
| FSD-001 (Infrastructure) | PostgreSQL and Redis infrastructure. |
| FSD-008 (Notifications) | Notification delivery for broker connection events. |
| FSD-009 (Auth & Multi-Tenancy) | User authentication for broker connection API endpoints. |
| FSD-010 (Market Data) | Market price cache used by paper position monitoring. |

---

## Changelog

- 2026-02-11: Initial sub-FSD extracted from FSD-003 v1.0 -- Generated by Claude

---

*FSD-003c v1.0 -- Broker Adapters*
*TrendEdge -- February 2026*
