# FSD-006c: Advanced Analytics (Pro Tier)

**TrendEdge â€” AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-006c |
| Source | FSD-006 (Performance Analytics) |
| Title | Advanced Analytics (Pro Tier) |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-12 |

---

## 1. Introduction

### 1.1 Purpose

This sub-FSD specifies all Pro-tier advanced analytics features for the TrendEdge Performance Analytics Dashboard. It covers Monte Carlo simulation, strategy correlation matrix, walk-forward analysis, advanced drawdown analysis, AI-powered natural language insights (Claude API integration), and comparative analytics. These features are gated to Pro ($99/month) and Team ($199/month) subscribers.

A developer should be able to implement the complete advanced analytics subsystem using only this document, with cross-references to sibling sub-FSDs where foundational data dependencies exist.

### 1.2 Scope

This FSD covers:

- Monte Carlo simulation engine (AN-FR-026)
- Strategy correlation matrix (AN-FR-027)
- Walk-forward analysis with decay detection (AN-FR-028)
- Advanced drawdown analysis (AN-FR-029)
- AI-powered natural language insights via Claude API (AN-FR-030)
- Comparative analytics: paper vs. live, period vs. period, strategy vs. strategy, month-over-month (AN-FR-032)
- Tier gating enforcement for all advanced features
- API endpoints, data models, caching, rate limiting, and security for the above

This FSD does NOT cover:

- Core metrics calculation engine (see FSD-006a)
- Dashboard layout, visualizations, charts, filtering, exports (see FSD-006b)
- Trade execution pipeline (see FSD-003)
- Trade journaling (see FSD-004)
- Playbook system (see FSD-005)
- User authentication and billing (see FSD-001)

### 1.3 Sibling Sub-FSDs

| Sub-FSD | Title | Relationship |
|---|---|---|
| FSD-006a | Metrics Engine | Provides computed metrics, R-multiples, daily P&L series, and equity curve data consumed by all advanced analytics features |
| FSD-006b | Visualization & Dashboard | Provides the dashboard shell, widget system, filter bar, and chart rendering infrastructure in which advanced analytics widgets are displayed |

### 1.4 Architecture Context

| Layer | Technology | Role |
|---|---|---|
| Frontend | Next.js 14+ (App Router) + TypeScript + Tailwind + shadcn/ui | Advanced analytics widget rendering, AI chat interface |
| Charting | Recharts (standard charts) + D3.js (custom visualizations) | Monte Carlo fan chart, correlation heatmap, walk-forward multi-line chart |
| Backend API | FastAPI (Python 3.12+) | Simulation engine, correlation computation, Claude API proxy, comparison logic |
| Database | PostgreSQL 16 (Supabase) | Trade data (via RLS), AI query history |
| Cache | Redis (Upstash) | Monte Carlo result caching (1-hr TTL), AI query rate limit counters |
| AI Provider | Anthropic Claude API | Natural language query processing |
| Hosting | Vercel (frontend) + Railway (backend) | Production deployment |

### 1.5 Data Dependencies

All advanced analytics features consume data produced by the Metrics Engine (FSD-006a):

| Data Required | Source | Used By |
|---|---|---|
| R-multiples per trade | FSD-006a metrics engine | Monte Carlo simulation |
| Daily P&L by playbook | `mv_daily_pnl` + playbook grouping (FSD-006a) | Strategy correlation matrix |
| Rolling metric windows | FSD-006a metric formulas | Walk-forward analysis |
| Drawdown series | FSD-006a equity curve computation | Advanced drawdown analysis |
| Aggregate statistics + trade schema | FSD-006a summary endpoint | AI-powered insights |
| Equity curves + metric comparisons | FSD-006a | Comparative analytics |
| Filter state | FSD-006b filter bar | All features (filter context passed through) |

---

## 2. Tier Gating

### 2.1 Feature Access Matrix

| Feature | Free | Trader ($49/mo) | Pro ($99/mo) | Team ($199/mo) |
|---|---|---|---|---|
| Monte Carlo simulation | Locked | Locked | Yes | Yes |
| Strategy correlation matrix | Locked | Locked | Yes | Yes |
| Walk-forward analysis | Locked | Locked | Yes | Yes |
| Advanced drawdown analysis | Locked | Locked | Yes | Yes |
| AI-powered insights | Locked | Locked | 20 queries/day | 50 queries/day |
| Comparative analytics | Locked | Locked | Yes | Yes |

### 2.2 Enforcement Behavior

**Frontend enforcement:**

- Locked widgets display a blurred preview using CSS `filter: blur(8px)` with an overlay containing a lock icon and CTA button: "Upgrade to Pro to unlock [feature name]".
- The overlay links to `/settings/billing`.

**Backend enforcement:**

- Every advanced analytics API endpoint checks `user.subscription_tier` from the JWT claims (`user_metadata.subscription_tier`) before processing.
- Insufficient tier returns HTTP 403:

```json
{
  "error": "forbidden",
  "message": "This feature requires the Pro plan.",
  "required_tier": "pro",
  "upgrade_url": "/settings/billing"
}
```

**AI query counter:**

- Stored in Redis key `ai_queries:{user_id}:{YYYY-MM-DD}` with 24-hour TTL.
- Incremented on successful query completion. Checked before query execution.
- Counter resets at midnight UTC.

**Tier change behavior:**

- Upgrade mid-session: WebSocket event `{ "type": "tier_changed", "new_tier": "pro" }` triggers the frontend to unlock advanced features without page reload.
- Downgrade: features lock immediately. Cached advanced analytics data becomes inaccessible. No data deletion; features re-unlock if user re-upgrades.

---

## 3. Functional Specifications

### 3.1 AN-FR-026: Monte Carlo Simulation

**Source:** PRD-006 Section 3.5

**Description:** Randomly resamples the trader's actual trade results (with replacement) to generate thousands of simulated equity curves. Projects the range of possible outcomes and computes probability of ruin.

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| R-multiples from closed trades | FSD-006a metrics engine | Array of DECIMAL values | Yes |
| Average initial risk per trade | Derived from trade records | DECIMAL(12,2) | Yes |
| Number of simulations | User selection | Integer (500, 1000, 5000, 10000) | Yes (default: 1000) |
| Ruin threshold | User selection | Percentage (default: 50%) | Yes (default: 50) |
| Active filters | FSD-006b filter state | Filter object | Yes (defaults apply) |

**Processing Logic:**

1. Collect array of R-multiples from all closed trades matching current filter criteria.
2. **Minimum trade requirement:** 30 trades. Below 30: display locked state with message "Minimum 30 closed trades required for Monte Carlo simulation. You have N trades."
3. **Configuration:** N = number of simulations (default 1,000; user options: 500, 1,000, 5,000, 10,000). Ruin threshold = configurable drawdown percentage (default 50%).
4. **Simulation loop:** For each of N simulations:
   - Randomly resample (with replacement) the same number of trades as actual history from the R-multiple array.
   - Convert each resampled R-multiple to dollar P&L using average initial risk: `dollar_pnl = r_multiple * average_initial_risk`.
   - Build a simulated equity curve as the cumulative sum of resampled dollar P&L values.
5. **Percentile curves:** At each trade number position (1 through total_trades), compute the 5th, 25th, 50th (median), 75th, and 95th percentile of simulated equity values across all N simulations.
6. **Probability of ruin:** `(count of simulations where max_drawdown_pct >= ruin_threshold / total_simulations) * 100`.
7. **Computation:** Server-side via FastAPI using NumPy vectorized operations. Avoid Python loops over individual simulations.
8. **Caching:** Results cached in Redis key `monte_carlo:{user_id}:{trade_count_hash}` with 1-hour TTL. Invalidated on new trade close.

**Display:**

- Fan chart visualization: shaded bands for each percentile range (5th-25th, 25th-75th, 75th-95th), with actual equity curve overlaid as a solid line.
- Summary statistics table:
  - Median final equity (50th percentile)
  - Best case (95th percentile)
  - Worst case (5th percentile)
  - Probability of ruin (percentage)
  - Number of simulations run

**Outputs:**

```json
{
  "percentile_curves": {
    "p5": [{ "trade_num": 1, "equity": -250.00 }, ...],
    "p25": [{ "trade_num": 1, "equity": -50.00 }, ...],
    "p50": [{ "trade_num": 1, "equity": 120.00 }, ...],
    "p75": [{ "trade_num": 1, "equity": 380.00 }, ...],
    "p95": [{ "trade_num": 1, "equity": 650.00 }, ...]
  },
  "actual_equity_curve": [{ "trade_num": 1, "equity": 85.00 }, ...],
  "summary": {
    "median_final_equity": 8450.00,
    "best_case_95th": 22100.00,
    "worst_case_5th": -3200.00,
    "probability_of_ruin_pct": 4.2,
    "num_simulations": 1000,
    "num_trades_resampled": 156,
    "ruin_threshold_pct": 50
  },
  "computed_at": "2026-02-11T14:35:00Z",
  "cached": false
}
```

**Error Handling:**

| Error Condition | HTTP Status | Error Message |
|---|---|---|
| Fewer than 30 trades | 400 | "Minimum 30 closed trades required for Monte Carlo simulation. You have {N} trades." |
| Computation timeout (> 30 seconds) | 504 | "Simulation timed out. Try reducing the number of iterations." |
| Free/Trader tier access | 403 | "Monte Carlo simulation is available on the Pro plan. Upgrade to access advanced analytics." |
| Rate limit exceeded (> 5/hour) | 429 | "Too many simulation requests. Please try again later." (with `Retry-After` header) |

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| Exactly 30 trades | Simulation runs successfully |
| 29 trades | HTTP 400 with minimum trade message |
| All trades are winners (no losing R-multiples) | Simulation runs; probability of ruin = 0.0% |
| All trades are losers | Simulation runs; probability of ruin will be very high |
| R-multiples with extreme outliers (e.g., +10R) | Outliers included in resampling pool; percentile bands will be wide |
| No R-multiples available (all trades missing stop loss) | HTTP 400: "R-multiple data required. Ensure trades have defined stop losses." |

---

### 3.2 AN-FR-027: Strategy Correlation Matrix

**Source:** PRD-006 Section 3.5

**Description:** Computes Pearson correlation coefficients of daily returns between each pair of the trader's playbooks. Helps identify diversification opportunities and hidden strategy dependencies.

**Processing Logic:**

1. Group trades by `playbook_id` and compute daily P&L per playbook (sum of `realized_pnl` for trades closed on each date).
2. For each pair of playbooks, compute Pearson correlation of their daily returns on overlapping trading days.
3. **Minimum data requirement:** 20 overlapping trading days per pair. Below 20: display "N/A" in the cell with tooltip "Insufficient overlapping data (minimum 20 trading days required)."
4. **Insight callouts:** Automatically generated for:
   - Correlation > 0.7: "High positive correlation between {Playbook A} and {Playbook B} ({value}). These strategies tend to win and lose together, reducing diversification benefit."
   - Correlation < -0.3: "Negative correlation between {Playbook A} and {Playbook B} ({value}). These strategies provide diversification."

**Display:**

- Heatmap with playbooks on both axes.
- Color scale: -1 = dark blue (`#1E40AF`), 0 = white (`#FFFFFF`), +1 = dark red (`#991B1B`).
- Diagonal cells show 1.00 (self-correlation) in neutral gray.
- Hover on any cell shows tooltip with exact correlation value and overlapping day count.

**Outputs:**

```json
{
  "playbooks": ["A+ Trendline Break", "Standard Break", "Bounce"],
  "matrix": [
    [1.00, 0.45, -0.12],
    [0.45, 1.00, 0.22],
    [-0.12, 0.22, 1.00]
  ],
  "overlapping_days": [
    [45, 32, 28],
    [32, 45, 25],
    [28, 25, 45]
  ],
  "insights": [
    {
      "type": "high_correlation",
      "playbooks": ["A+ Trendline Break", "Standard Break"],
      "value": 0.45,
      "message": "Moderate positive correlation..."
    }
  ]
}
```

**Error Handling:**

| Error Condition | HTTP Status | Error Message |
|---|---|---|
| Only 1 playbook | 200 | Single-cell matrix returned. Insight: "Correlation requires at least 2 playbooks." |
| No playbooks assigned | 200 | Empty matrix with message: "Assign playbooks to your trades to enable correlation analysis." |
| Free/Trader tier | 403 | "Strategy correlation requires the Pro plan." |

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| 100 trades all in same playbook | Single cell (1.00), no pair correlation. Message displayed. |
| 2 playbooks, only 15 overlapping days | Cell shows "N/A" with tooltip explaining minimum. |
| Playbook with 0 variance in daily returns | Correlation undefined; cell shows "N/A" with tooltip "Insufficient variance." |

---

### 3.3 AN-FR-028: Walk-Forward Analysis

**Source:** PRD-006 Section 3.5

**Description:** Applies rolling windows across the trade history and computes key metrics for each window. Detects strategy decay when performance degrades over consecutive windows.

**Processing Logic:**

1. **Rolling windows:** Configurable window size in trades: 20, 30, 50, or 100 (default: 30).
2. The window slides by 1 trade at a time across the entire trade history (or filtered subset).
3. **Metrics computed per window:**
   - Win rate (%)
   - Average R-multiple
   - Profit factor
   - Sharpe ratio (annualized, using daily returns within the window)
4. **Visualization:** Multi-line chart with one line per metric. Each metric plotted as its value at the window's ending trade number.
5. **Red shading:** When a metric drops below the all-history average for 2 or more consecutive windows, that region is shaded red on the chart.
6. **Decay alert:** Generated when profit factor declines by > 20% over 3 or more consecutive windows. Alert text: "Strategy decay detected: profit factor has declined {pct}% over the last {N} windows."
7. **Optional per-playbook analysis:** If `playbook_id` is provided, analysis runs only on trades for that playbook.

**Outputs:**

```json
{
  "window_size": 30,
  "data_points": [
    {
      "window_end_trade_num": 30,
      "window_end_date": "2025-12-15",
      "win_rate": 63.3,
      "avg_r": 0.92,
      "profit_factor": 2.10,
      "sharpe_ratio": 1.55
    },
    {
      "window_end_trade_num": 31,
      "window_end_date": "2025-12-16",
      "win_rate": 60.0,
      "avg_r": 0.85,
      "profit_factor": 1.95,
      "sharpe_ratio": 1.42
    }
  ],
  "all_history_averages": {
    "win_rate": 62.5,
    "avg_r": 0.85,
    "profit_factor": 1.87,
    "sharpe_ratio": 1.45
  },
  "below_average_regions": [
    {
      "metric": "profit_factor",
      "start_trade_num": 85,
      "end_trade_num": 92,
      "consecutive_windows": 8
    }
  ],
  "decay_alerts": [
    {
      "metric": "profit_factor",
      "decline_pct": 24.5,
      "over_windows": 5,
      "message": "Strategy decay detected: profit factor has declined 24.5% over the last 5 windows."
    }
  ]
}
```

**Error Handling:**

| Error Condition | HTTP Status | Error Message |
|---|---|---|
| Fewer trades than window size | 400 | "Walk-forward analysis requires at least {window_size} trades. You have {N} trades." |
| Invalid window size | 400 | "Invalid window size: {value}. Valid options: 20, 30, 50, 100." |
| Free/Trader tier | 403 | "Walk-forward analysis requires the Pro plan." |

---

### 3.4 AN-FR-029: Advanced Drawdown Analysis

**Source:** PRD-006 Section 3.5

**Description:** Extends the basic drawdown metrics from FSD-006a with clustering analysis, conditional breakdowns, and distribution visualizations.

**Processing Logic:**

1. **Drawdown clustering:** Apply Ljung-Box test on the drawdown occurrence series (binary: 1 = in drawdown, 0 = not) to detect whether drawdowns cluster or occur randomly.
   - If p-value < 0.05: insight "Your drawdowns tend to cluster. Consider reducing position size after a drawdown begins."
   - If p-value >= 0.05: insight "Your drawdowns appear randomly distributed."

2. **Time-to-recovery distribution:** Histogram of recovery times (in trading days) across all completed drawdown periods.

3. **Conditional drawdown breakdowns:**
   - By day of week: average drawdown depth per weekday
   - By instrument: average drawdown depth per instrument
   - By playbook: average drawdown depth per playbook
   - By emotional state: average drawdown depth per emotional tag (from journal entries)

4. **Duration vs. depth scatter plot:** Each drawdown period plotted with duration (trading days) on X-axis and depth (dollar or percentage) on Y-axis.

**Outputs:**

```json
{
  "clustering": {
    "ljung_box_statistic": 12.45,
    "p_value": 0.029,
    "clustered": true,
    "insight": "Your drawdowns tend to cluster. Consider reducing position size after a drawdown begins."
  },
  "recovery_distribution": {
    "bins": [
      { "days_range": "1-3", "count": 5 },
      { "days_range": "4-7", "count": 3 },
      { "days_range": "8-14", "count": 2 },
      { "days_range": "15+", "count": 1 }
    ],
    "avg_recovery_days": 6.2,
    "median_recovery_days": 4
  },
  "conditional_breakdowns": {
    "by_day_of_week": [
      { "day": "Monday", "avg_drawdown_depth": -820.00, "occurrence_count": 8 },
      { "day": "Tuesday", "avg_drawdown_depth": -450.00, "occurrence_count": 5 }
    ],
    "by_instrument": [...],
    "by_playbook": [...],
    "by_emotional_state": [...]
  },
  "duration_vs_depth": [
    { "drawdown_id": 1, "duration_days": 3, "depth_dollars": -800.00, "depth_pct": -2.8 },
    { "drawdown_id": 2, "duration_days": 5, "depth_dollars": -1200.00, "depth_pct": -4.1 }
  ]
}
```

**Error Handling:**

| Error Condition | HTTP Status | Error Message |
|---|---|---|
| No drawdown periods | 200 | Empty results with message: "No drawdown periods detected in the selected date range." |
| Insufficient drawdown periods for clustering (< 3) | 200 | Clustering section returns `null` with message: "Minimum 3 drawdown periods required for clustering analysis." |
| Free/Trader tier | 403 | "Advanced drawdown analysis requires the Pro plan." |

---

### 3.5 AN-FR-030: AI-Powered Natural Language Insights

**Source:** PRD-006 Section 3.5

**Description:** Chat interface within the analytics dashboard that allows traders to ask natural language questions about their trading performance. Queries are translated to analytical operations via the Anthropic Claude API.

**User Interface:**

- Chat input: text field with placeholder "Ask about your trading..."
- Positioned within the analytics dashboard as a collapsible panel.
- Response displays natural language text with optional inline data table and/or chart.
- Query history is saved and searchable.

**First-Use Consent:**

On first AI query, display a consent dialog:

> "AI-powered insights are processed by Anthropic's Claude AI. Your aggregated trading data (not personal information) is sent to generate answers. Continue?"

Buttons: "Enable AI Insights" | "Cancel"

- Consent stored in `user_settings.ai_insights_consent` as `{ consented: true, consented_at: timestamp }`.
- Queries rejected without consent: HTTP 403 with `{ "error": "consent_required", "message": "Please enable AI insights in your settings before using this feature." }`.

**Processing Logic:**

1. User submits natural language query.
2. Backend validates:
   - User has Pro or Team tier.
   - User has given AI consent.
   - Daily query limit not exceeded (20 for Pro, 50 for Team).
3. Backend constructs a prompt for the Claude API containing:
   - Trade data schema and available fields.
   - Current filter state (date range, instruments, playbooks).
   - Aggregate statistics for the filtered dataset.
   - Specific query-relevant data subsets (maximum 500 individual trade records; aggregated if more).
   - Instruction to answer only from provided data.
4. Send to Claude API and stream/return the response.
5. Save query and response to `ai_query_history` table.
6. Increment daily query counter in Redis.

**Claude API Integration:**

| Aspect | Specification |
|---|---|
| Provider | Anthropic Claude API |
| Model | claude-sonnet-4-20250514 (or latest; configurable via `CLAUDE_MODEL` env var) |
| Endpoint | `https://api.anthropic.com/v1/messages` |
| API Key | Environment variable: `ANTHROPIC_API_KEY` |
| System prompt | Includes: trade data schema, available fields, current filter context, user's aggregate statistics, instruction to answer only from provided data |
| Max tokens | Request: 2,000 tokens. Response: 4,000 tokens. |
| Timeout | 15 seconds |
| Retry on Anthropic rate limit | Exponential backoff: 1s, 2s, 4s. Max 3 retries. |
| Fallback | If Claude API unavailable: disable AI insights feature, show "AI insights temporarily unavailable. Please try again later." |
| Cost tracking | Log `tokens_used` per query in `ai_query_history` for billing monitoring |

**Data Security:**

- Data sent to Claude API: trade schema, aggregate statistics, filtered subsets relevant to the query. Maximum 500 individual trade records per query (aggregated if more).
- Data NEVER sent to Claude API: user email, real name, broker credentials, API keys, account numbers, team member identities.
- Per Anthropic's API terms, data sent via the API is not used for model training.

**Rate Limits:**

| Tier | Daily Limit | Counter Reset |
|---|---|---|
| Pro | 20 queries/day | Midnight UTC |
| Team | 50 queries/day | Midnight UTC |

**Error Handling:**

| Error Condition | HTTP Status | Error Message |
|---|---|---|
| AI consent not given | 403 | "Please enable AI insights in your settings before using this feature." |
| Daily limit exceeded (Pro) | 429 | "You've used all 20 AI queries for today. Your limit resets at midnight UTC." (with `resets_at` timestamp) |
| Daily limit exceeded (Team) | 429 | "You've used all 50 AI queries for today. Your limit resets at midnight UTC." (with `resets_at` timestamp) |
| Claude API timeout (> 15s) | 504 | "AI service is taking longer than expected. Please try again." |
| Claude API unavailable | 503 | "AI insights temporarily unavailable. Please try again later." |
| Free/Trader tier | 403 | "AI insights require the Pro plan." |

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| Query with no trades matching filters | Response: "No trades match the current filters. Try adjusting the date range or removing filters to analyze a broader dataset." |
| Ambiguous query | Claude responds with clarifying question based on available data dimensions |
| Query about data not available (e.g., "what is my broker latency?") | Claude responds that the requested data is not tracked in the current system |
| Follow-up questions | Each query is independent (no conversation memory between queries). User must provide full context in each query. |

---

### 3.6 AN-FR-032: Comparative Analytics

**Source:** PRD-006 Section 3.5

**Description:** Side-by-side comparisons across multiple dimensions: paper vs. live trading, two time periods, two strategies, and month-over-month trends.

#### 3.6.1 Paper vs. Live Comparison

- Side-by-side equity curves: paper trades rendered as dashed line, live trades as solid line.
- Two-sample t-test on mean R-multiples with significance level (p-value) reporting.
- If p-value < 0.05: highlight with insight "Statistically significant difference between paper and live performance."
- Metrics table comparing: win rate, avg R, profit factor, expectancy, total trades for each mode.

#### 3.6.2 Period vs. Period Comparison

- User selects two custom date ranges (Period A and Period B).
- Overlaid normalized equity curves (both starting from $0 for visual comparison).
- Full metrics computed for each period.
- Metrics with > 10% change highlighted:
  - Green up arrow for improvement (higher win rate, higher profit factor, etc.)
  - Red down arrow for degradation

#### 3.6.3 Strategy A vs. B Comparison

- User selects two playbooks from dropdown.
- Side-by-side metrics table + overlaid equity curves.
- Pearson correlation coefficient between the two strategies' daily returns.

#### 3.6.4 Month-over-Month Trends

- Automatic computation (no user input required).
- Sparklines for the last 6 months per key metric (win rate, avg R, profit factor, net P&L).
- Percentage change indicators between consecutive months.

**Outputs (Period vs. Period example):**

```json
{
  "comparison_type": "period_vs_period",
  "period_a": {
    "label": "Nov 1 - Dec 31, 2025",
    "metrics": {
      "total_trades": 82,
      "win_rate": 58.5,
      "avg_r": 0.72,
      "profit_factor": 1.65,
      "total_net_pnl": 6200.00,
      "sharpe_ratio": 1.20
    },
    "equity_curve": [{ "trade_num": 1, "equity": 120.00 }, ...]
  },
  "period_b": {
    "label": "Jan 1 - Feb 11, 2026",
    "metrics": {
      "total_trades": 74,
      "win_rate": 66.2,
      "avg_r": 0.98,
      "profit_factor": 2.12,
      "total_net_pnl": 9220.50,
      "sharpe_ratio": 1.65
    },
    "equity_curve": [{ "trade_num": 1, "equity": 85.00 }, ...]
  },
  "changes": [
    { "metric": "win_rate", "change_pct": 13.2, "direction": "improvement" },
    { "metric": "profit_factor", "change_pct": 28.5, "direction": "improvement" },
    { "metric": "sharpe_ratio", "change_pct": 37.5, "direction": "improvement" }
  ],
  "statistical_test": null
}
```

**Error Handling:**

| Error Condition | HTTP Status | Error Message |
|---|---|---|
| Overlapping date ranges (period vs. period) | 400 | "Selected date ranges overlap. Choose non-overlapping periods for comparison." |
| Same playbook selected for A and B | 400 | "Please select two different playbooks for comparison." |
| No paper trades or no live trades | 200 | Partial comparison with message: "No {paper/live} trades found. Paper vs. Live comparison requires trades in both modes." |
| Free/Trader tier | 403 | "Comparative analytics require the Pro plan." |

---

## 4. Data Specifications

### 4.1 Database Table: `ai_query_history`

| Column | Type | Nullable | Description |
|---|---|---|---|
| id | UUID | NOT NULL | PK, generated |
| user_id | UUID | NOT NULL | FK to `users.id` |
| query_text | TEXT | NOT NULL | User's natural language query |
| response_text | TEXT | NOT NULL | AI-generated response |
| response_data | JSONB | NULL | Structured data in response (tables, chart data) |
| filters_applied | JSONB | NOT NULL | Filter state at time of query |
| tokens_used | INTEGER | NOT NULL | Claude API tokens consumed |
| response_time_ms | INTEGER | NOT NULL | Response latency in milliseconds |
| created_at | TIMESTAMPTZ | NOT NULL | Query timestamp |

**RLS:** `auth.uid() = user_id`
**Retention:** 90 days, then archived to cold storage. After 1 year, permanently deleted.

### 4.2 Database Indexes

```sql
-- AI query history
CREATE INDEX idx_ai_query_history_user_date ON ai_query_history(user_id, created_at);
```

### 4.3 Redis Cache Schema

| Key Pattern | Value | TTL | Purpose |
|---|---|---|---|
| `monte_carlo:{user_id}:{trade_count_hash}` | JSON simulation results | 1 hour | Monte Carlo result cache |
| `ai_queries:{user_id}:{YYYY-MM-DD}` | Integer counter | 24 hours | Daily AI query rate limit |
| `ratelimit:monte_carlo:{user_id}:{hour_window}` | Integer counter | 1 hour | Monte Carlo hourly rate limit |

**Cache invalidation:** Monte Carlo cache invalidated when a new trade is closed (trade count changes). AI query counter auto-expires at TTL.

---

## 5. API Specifications

All endpoints require JWT authentication via `Authorization: Bearer {token}` header. All endpoints return JSON. Filter parameters (`start_date`, `end_date`, `instruments`, `playbooks`) are accepted as query parameters where applicable.

### 5.1 POST /api/v1/analytics/monte-carlo

- **Tier:** Pro+
- **Rate Limit:** 5 requests/hour
- **Request Body:**

```json
{
  "num_simulations": 1000,
  "ruin_threshold_pct": 50
}
```

- **Query Parameters:** `start_date`, `end_date`, `instruments`, `playbooks` (standard filters)
- **Response 200:** Percentile curves + summary statistics + probability of ruin (see Section 3.1 Outputs)
- **Response 400:** `{ "error": "bad_request", "message": "Minimum 30 closed trades required for Monte Carlo simulation. You have 18 trades." }`
- **Response 403:** `{ "error": "forbidden", "message": "Monte Carlo simulation requires the Pro plan.", "required_tier": "pro", "upgrade_url": "/settings/billing" }`
- **Response 429:** `{ "error": "rate_limited", "message": "Too many simulation requests. Please try again later.", "retry_after": 1800 }`
- **Response 504:** `{ "error": "timeout", "message": "Simulation timed out. Try reducing the number of iterations." }`

### 5.2 GET /api/v1/analytics/correlation-matrix

- **Tier:** Pro+
- **Query Parameters:** `start_date`, `end_date`, `instruments` (standard filters)
- **Response 200:** Correlation matrix data + insight callouts (see Section 3.2 Outputs)
- **Response 403:** `{ "error": "forbidden", "message": "Strategy correlation requires the Pro plan.", "required_tier": "pro", "upgrade_url": "/settings/billing" }`

### 5.3 GET /api/v1/analytics/walk-forward

- **Tier:** Pro+
- **Query Parameters:**
  - `window_size`: 20, 30, 50, or 100 (default: 30)
  - `playbook_id`: optional UUID for per-playbook analysis
  - Standard filter parameters
- **Response 200:** Rolling metric series + decay alerts (see Section 3.3 Outputs)
- **Response 400:** `{ "error": "bad_request", "message": "Invalid window size: 45. Valid options: 20, 30, 50, 100." }`
- **Response 403:** `{ "error": "forbidden", "message": "Walk-forward analysis requires the Pro plan.", "required_tier": "pro", "upgrade_url": "/settings/billing" }`

### 5.4 GET /api/v1/analytics/advanced-drawdown

- **Tier:** Pro+
- **Query Parameters:** Standard filter parameters
- **Response 200:** Clustering analysis + recovery distribution + conditional breakdowns + scatter data (see Section 3.4 Outputs)
- **Response 403:** `{ "error": "forbidden", "message": "Advanced drawdown analysis requires the Pro plan.", "required_tier": "pro", "upgrade_url": "/settings/billing" }`

### 5.5 POST /api/v1/analytics/ai-query

- **Tier:** Pro+ (20/day Pro, 50/day Team)
- **Request Body:**

```json
{
  "query": "What is my best setup on Tuesdays in crude oil?",
  "filters": { "start_date": "2025-11-01", "end_date": "2026-02-11" }
}
```

- **Response 200:**

```json
{
  "answer": "Your best-performing Tuesday setup in CL is A+ Trendline Break with a 75% win rate and 2.1R average across 12 trades.",
  "data_table": [...],
  "queries_remaining_today": 18,
  "query_id": "uuid"
}
```

- **Response 403 (no consent):** `{ "error": "consent_required", "message": "Please enable AI insights in your settings before using this feature." }`
- **Response 403 (wrong tier):** `{ "error": "forbidden", "message": "AI insights require the Pro plan.", "required_tier": "pro", "upgrade_url": "/settings/billing" }`
- **Response 429:** `{ "error": "rate_limited", "message": "You've used all 20 AI queries for today. Your limit resets at midnight UTC.", "resets_at": "2026-02-12T00:00:00Z" }`
- **Response 504:** `{ "error": "timeout", "message": "AI service is taking longer than expected. Please try again." }`
- **Response 503:** `{ "error": "service_unavailable", "message": "AI insights temporarily unavailable. Please try again later." }`

### 5.6 POST /api/v1/analytics/compare

- **Tier:** Pro+
- **Request Body:**

```json
{
  "comparison_type": "paper_vs_live" | "period_vs_period" | "strategy_vs_strategy",
  "params": {
    "period_a": { "start": "2025-11-01", "end": "2025-12-31" },
    "period_b": { "start": "2026-01-01", "end": "2026-02-11" }
  }
}
```

For `strategy_vs_strategy`:

```json
{
  "comparison_type": "strategy_vs_strategy",
  "params": {
    "playbook_a_id": "uuid-1",
    "playbook_b_id": "uuid-2"
  }
}
```

- **Response 200:** Side-by-side metrics + equity curve data + statistical tests (see Section 3.6 Outputs)
- **Response 400:** `{ "error": "bad_request", "message": "Selected date ranges overlap. Choose non-overlapping periods for comparison." }`
- **Response 403:** `{ "error": "forbidden", "message": "Comparative analytics require the Pro plan.", "required_tier": "pro", "upgrade_url": "/settings/billing" }`

### 5.7 GET /api/v1/analytics/month-over-month

- **Tier:** Pro+
- **Query Parameters:** `instruments`, `playbooks` (standard filters; date range is automatic: last 6 months)
- **Response 200:**

```json
{
  "months": [
    {
      "month": "2025-09",
      "win_rate": 55.2,
      "avg_r": 0.65,
      "profit_factor": 1.52,
      "net_pnl": 2100.00
    }
  ],
  "changes": [
    {
      "from_month": "2025-09",
      "to_month": "2025-10",
      "win_rate_change_pct": 5.8,
      "profit_factor_change_pct": 12.3
    }
  ]
}
```

- **Response 403:** `{ "error": "forbidden", "message": "Comparative analytics require the Pro plan.", "required_tier": "pro", "upgrade_url": "/settings/billing" }`

---

## 6. Security Specifications

### 6.1 Data Isolation

All advanced analytics queries enforce PostgreSQL Row-Level Security. See FSD-006a for base RLS policies. Additional RLS for this sub-FSD:

```sql
-- ai_query_history
ALTER TABLE ai_query_history ENABLE ROW LEVEL SECURITY;
CREATE POLICY ai_query_history_user_isolation ON ai_query_history
  FOR ALL
  USING (auth.uid() = user_id);
```

### 6.2 AI Query Security

- Data sent to Claude API: trade schema, aggregate statistics, filtered subsets relevant to the query. Maximum 500 individual trade records per query (aggregated if more).
- Data NEVER sent to Claude API: user email, real name, broker credentials, API keys, account numbers, team member identities.
- First-use consent required before any AI query is processed.
- AI query logs retained for 90 days in `ai_query_history`, then archived to cold storage. After 1 year, permanently deleted.
- Per Anthropic's API terms, data sent via the API is not used for model training.
- XSS prevention: AI response text is sanitized before rendering in the frontend. No script execution from AI responses.

### 6.3 Rate Limiting

| Endpoint | Limit | Window | Response |
|---|---|---|---|
| Monte Carlo | 5 requests | Per hour | HTTP 429 with `Retry-After: {seconds}` header |
| AI query (Pro) | 20 requests | Per day (UTC) | HTTP 429 with `resets_at` timestamp |
| AI query (Team) | 50 requests | Per day (UTC) | HTTP 429 with `resets_at` timestamp |
| Correlation matrix | 30 requests | Per minute | HTTP 429 with `Retry-After` header |
| Walk-forward | 30 requests | Per minute | HTTP 429 with `Retry-After` header |
| Compare | 30 requests | Per minute | HTTP 429 with `Retry-After` header |

Rate limits enforced via Redis counters. Key pattern: `ratelimit:{endpoint_category}:{user_id}:{window_id}`.

---

## 7. Performance Specifications

### 7.1 Monte Carlo Simulation Performance

| Simulations | Trades | Target Time | Server Resources |
|---|---|---|---|
| 500 | 100 | < 1 second | Single CPU core |
| 1,000 | 100 | < 2 seconds | Single CPU core |
| 1,000 | 500 | < 5 seconds | Single CPU core |
| 5,000 | 500 | < 15 seconds | May use multiprocessing |
| 10,000 | 1,000 | < 30 seconds | Multiprocessing recommended |

**Implementation:** NumPy vectorized operations for random resampling. Avoid Python loops over individual simulations. Maximum allowed simulations: 10,000 (env var `MONTE_CARLO_MAX_SIMS`).

### 7.2 Other Computation Targets

| Feature | Dataset | Target Time |
|---|---|---|
| Correlation matrix | 5 playbooks, 100 overlapping days | < 1 second |
| Walk-forward (window=30) | 2,000 trades | < 3 seconds |
| Walk-forward (window=100) | 10,000 trades | < 10 seconds |
| Advanced drawdown analysis | 50 drawdown periods | < 2 seconds |
| AI query (Claude API round-trip) | Any | < 15 seconds |
| Comparative analytics (period vs period) | 2 x 1,000 trades | < 3 seconds |

### 7.3 Caching Strategy

- Monte Carlo results: Redis cache with 1-hour TTL. Cache key includes user_id and a hash of the trade count and filter state. Invalidated on new trade close.
- AI query counter: Redis with 24-hour TTL (auto-expiry at midnight boundary).
- Correlation matrix, walk-forward, and drawdown analysis results are cached using the same 5-minute TTL metrics cache from FSD-006a (key: `metrics:{user_id}:{filter_hash}`).

---

## 8. Testing Specifications

### 8.1 Monte Carlo Tests

| Test ID | Scenario | Input | Expected Result |
|---|---|---|---|
| MC-001 | Exactly 30 trades | 30 closed trades with R-multiples | Simulation runs. Returns percentile curves + summary. |
| MC-002 | 29 trades | 29 closed trades | HTTP 400: "Minimum 30 closed trades required for Monte Carlo simulation. You have 29 trades." |
| MC-003 | Default parameters | 100 trades, 1000 sims, 50% ruin | Returns valid JSON with 5 percentile curves, each having 100 data points. |
| MC-004 | All winners | 50 trades, all R > 0 | Probability of ruin = 0.0%. All percentile curves trend upward. |
| MC-005 | All losers | 50 trades, all R < 0 | Probability of ruin near 100%. All percentile curves trend downward. |
| MC-006 | 10,000 simulations x 1,000 trades | Large dataset | Completes within 30 seconds. |
| MC-007 | Cached result re-request | Same params within 1 hour | Response has `"cached": true`. Faster response time. |
| MC-008 | 6th request in same hour | Rate limit | HTTP 429 with Retry-After header. |
| MC-009 | Trader tier user | Valid trade data | HTTP 403: "Monte Carlo simulation requires the Pro plan." |
| MC-010 | No R-multiples (all trades missing stop loss) | Trades without stop_loss_price | HTTP 400: "R-multiple data required." |

### 8.2 Strategy Correlation Tests

| Test ID | Scenario | Expected Result |
|---|---|---|
| SC-001 | 3 playbooks, 30+ overlapping days each pair | 3x3 matrix with all values populated. |
| SC-002 | 2 playbooks, only 15 overlapping days | Cell shows "N/A". Tooltip: "Insufficient overlapping data." |
| SC-003 | 1 playbook only | 1x1 matrix (1.00). Insight: "Correlation requires at least 2 playbooks." |
| SC-004 | No playbooks assigned | Empty matrix. Message: "Assign playbooks to enable correlation." |
| SC-005 | High correlation (> 0.7) | Insight callout generated about reduced diversification. |
| SC-006 | Negative correlation (< -0.3) | Insight callout about diversification benefit. |

### 8.3 Walk-Forward Tests

| Test ID | Scenario | Expected Result |
|---|---|---|
| WF-001 | 200 trades, window=30 | 171 data points (200-30+1). Metrics per window. |
| WF-002 | 25 trades, window=30 | HTTP 400: insufficient trades. |
| WF-003 | Window=45 (invalid) | HTTP 400: "Invalid window size." |
| WF-004 | Profit factor declining > 20% over 3 windows | Decay alert generated. |
| WF-005 | Metric below average for 2+ consecutive windows | Red shading region returned. |
| WF-006 | Per-playbook (playbook_id filter) | Only trades from specified playbook used. |

### 8.4 Advanced Drawdown Tests

| Test ID | Scenario | Expected Result |
|---|---|---|
| DD-001 | 10 drawdown periods | Clustering analysis, recovery histogram, conditional breakdowns, scatter plot all populated. |
| DD-002 | 0 drawdown periods | Empty results with message. |
| DD-003 | 2 drawdown periods (below clustering minimum) | Clustering returns null with insufficient data message. Recovery and other sections populated. |
| DD-004 | Drawdown clusters (p < 0.05) | Insight about clustering behavior. |

### 8.5 AI Insights Tests

| Test ID | Scenario | Expected Result |
|---|---|---|
| AI-001 | Valid query, Pro user with consent | Natural language response + remaining query count. |
| AI-002 | Query without consent | HTTP 403: "Please enable AI insights in your settings." |
| AI-003 | 21st query in a day (Pro) | HTTP 429: "You've used all 20 AI queries for today." |
| AI-004 | 51st query in a day (Team) | HTTP 429: "You've used all 50 AI queries for today." |
| AI-005 | Claude API timeout | HTTP 504: "AI service is taking longer than expected." |
| AI-006 | Claude API unavailable | HTTP 503: "AI insights temporarily unavailable." |
| AI-007 | Trader tier user | HTTP 403: "AI insights require the Pro plan." |
| AI-008 | Query counter resets at midnight UTC | At 00:00:01 UTC, counter = 0. Queries succeed again. |
| AI-009 | XSS in AI response | Response sanitized. No script execution. |
| AI-010 | Query with empty filter results | Response explains no matching trades. |

### 8.6 Comparative Analytics Tests

| Test ID | Scenario | Expected Result |
|---|---|---|
| CMP-001 | Paper vs. Live with trades in both | Side-by-side metrics + equity curves + t-test result. |
| CMP-002 | Paper vs. Live, no paper trades | Partial result with message about missing mode. |
| CMP-003 | Period vs. Period, non-overlapping | Both periods computed. Change indicators shown. |
| CMP-004 | Period vs. Period, overlapping | HTTP 400: "Selected date ranges overlap." |
| CMP-005 | Strategy A vs. B | Metrics + equity curves + correlation coefficient. |
| CMP-006 | Strategy A vs. A (same playbook) | HTTP 400: "Please select two different playbooks." |
| CMP-007 | Month-over-month, 6 months of data | 6 monthly entries + 5 change records. |
| CMP-008 | Month-over-month, < 1 month of data | Single month shown, no change indicators. |

### 8.7 Tier Restriction Tests (Advanced Analytics Specific)

| Test ID | Scenario | Expected Result |
|---|---|---|
| TR-ADV-001 | Trader user calls Monte Carlo API | HTTP 403: "This feature requires the Pro plan." |
| TR-ADV-002 | Free user calls any advanced endpoint | HTTP 403: tier upgrade message. |
| TR-ADV-003 | Pro user accesses all advanced endpoints | All succeed (within rate limits). |
| TR-ADV-004 | User upgrades Trader -> Pro mid-session | WebSocket tier_changed event. Advanced features unlock without reload. |
| TR-ADV-005 | User downgrades Pro -> Trader | Advanced features immediately locked. |

### 8.8 Performance Benchmark Tests

| Test ID | Scenario | Metric | Target |
|---|---|---|---|
| PB-MC-001 | Monte Carlo 1,000 x 100 | Server computation time | < 2 seconds |
| PB-MC-002 | Monte Carlo 1,000 x 500 | Server computation time | < 5 seconds |
| PB-MC-003 | Monte Carlo 10,000 x 1,000 | Server computation time | < 30 seconds |
| PB-WF-001 | Walk-forward (window=30, 2000 trades) | Server computation time | < 3 seconds |
| PB-AI-001 | AI query round-trip | Total response time | < 15 seconds |

---

## 9. Environment Configuration

| Variable | Description | Default |
|---|---|---|
| `ANTHROPIC_API_KEY` | Claude API key for AI insights | (required, no default) |
| `CLAUDE_MODEL` | Claude model ID for AI queries | `claude-sonnet-4-20250514` |
| `MONTE_CARLO_MAX_SIMS` | Maximum simulations allowed | `10000` |
| `AI_QUERY_LIMIT_PRO` | Daily AI query limit for Pro | `20` |
| `AI_QUERY_LIMIT_TEAM` | Daily AI query limit for Team | `50` |
| `REDIS_URL` | Upstash Redis connection string | (required, no default) |

---

## 10. Migration & Deployment

### 10.1 Phase 2: Full Dashboard (Weeks 11-12)

Advanced analytics is deployed as part of Phase 2, alongside the full dashboard:

**Database Migrations:**

1. Create `ai_query_history` table with RLS policy.
2. Create `idx_ai_query_history_user_date` index.

**Backend Deployment:**

1. Deploy Monte Carlo simulation engine (NumPy-based).
2. Deploy correlation matrix computation endpoint.
3. Deploy walk-forward analysis endpoint.
4. Deploy advanced drawdown analysis endpoint.
5. Deploy Claude API integration proxy for AI insights.
6. Deploy comparative analytics endpoint.
7. Configure Redis keys for Monte Carlo caching and AI rate limiting.
8. Deploy rate limiting middleware for advanced endpoints.

**Frontend Deployment:**

1. Deploy Monte Carlo fan chart widget (D3.js).
2. Deploy correlation heatmap widget (D3.js).
3. Deploy walk-forward multi-line chart widget (Recharts).
4. Deploy advanced drawdown widgets (histogram + scatter).
5. Deploy AI insights chat panel.
6. Deploy comparative analytics views.
7. Deploy tier-gated blur overlays with upgrade CTAs.

**Feature Flags:**

- `FEATURE_MONTE_CARLO`: Enable/disable Monte Carlo simulation.
- `FEATURE_AI_INSIGHTS`: Enable/disable AI-powered insights.
- Each advanced feature can be individually disabled without affecting other features.

**Rollback Plan:**

- Feature flags allow disabling individual advanced features without rolling back the entire deployment.
- `ai_query_history` table migration is additive (no existing tables modified). Rollback: drop the table.

---

## 11. Open Questions & Assumptions

### 11.1 Open Questions

| # | Question | Impact | Status |
|---|---|---|---|
| OQ-005 | What Claude model version should be used for AI insights, and should it be configurable? | Affects cost, latency, and response quality. | Assumed: claude-sonnet-4-20250514, configurable via env var |
| OQ-006 | Should Monte Carlo simulations support custom starting equity, or always start from $0? | Affects probability of ruin calculation. | Assumed: starts from $0 (cumulative P&L basis) |
| OQ-007 | For walk-forward analysis, should the rolling window be based on trade count or calendar time? | PRD says trade count. Confirm preferred. | Assumed: trade count per PRD |
| OQ-009 | Should AI insights support follow-up questions with conversation context, or are queries independent? | Affects system prompt design and token usage. | Assumed: independent queries (no conversation memory) |

### 11.2 Assumptions

| # | Assumption | Rationale |
|---|---|---|
| A-006 | The Supabase Auth JWT includes the user's subscription tier as a claim (`user_metadata.subscription_tier`). | Required for tier-based feature gating without additional DB lookup. |
| A-011 | R-multiples are available for trades with defined stop losses. Trades without stop losses have null R-multiples. | Monte Carlo requires R-multiples; trades without are excluded from simulation. |
| A-012 | Playbook assignments exist for at least some trades. | Correlation matrix requires 2+ playbooks. If no playbooks assigned, feature shows guidance message. |
| A-013 | The `trades` table includes a `paper_or_live` field to distinguish paper and live trades. | Required for paper vs. live comparison. |

---

## Appendix A: Glossary (Advanced Analytics Terms)

| Term | Definition |
|---|---|
| Monte Carlo Simulation | Statistical technique that randomly resamples actual trades (with replacement) to generate thousands of simulated equity curves, projecting the range of possible outcomes given the trader's actual trade distribution. |
| Walk-Forward Analysis | Rolling window analysis that recalculates metrics on successive subsets of data to detect performance changes over time. Used for strategy decay detection. |
| Pearson Correlation | Statistical measure of linear correlation between two datasets, ranging from -1 (perfect negative) to +1 (perfect positive). 0 indicates no linear relationship. |
| Ljung-Box Test | Statistical test used to determine whether autocorrelations in a time series are significantly different from zero. Used here to detect drawdown clustering. |
| Probability of Ruin | The likelihood that a trading account will experience a drawdown exceeding a specified threshold, based on Monte Carlo simulation of the trader's actual trade distribution. |
| Strategy Decay | Progressive degradation in trading strategy performance over time, detected by declining metrics across consecutive walk-forward windows. |
| R-Multiple | Trade P&L divided by initial risk (stop distance x contract value). A 2R trade earned twice the amount risked. |

---

## Appendix B: Error Message Reference (Advanced Analytics)

| Code | Context | Message |
|---|---|---|
| 400 | Monte Carlo insufficient trades | "Minimum 30 closed trades required for Monte Carlo simulation. You have {N} trades." |
| 400 | Monte Carlo no R-multiples | "R-multiple data required. Ensure trades have defined stop losses." |
| 400 | Invalid window size | "Invalid window size: {value}. Valid options: 20, 30, 50, 100." |
| 400 | Walk-forward insufficient trades | "Walk-forward analysis requires at least {window_size} trades. You have {N} trades." |
| 400 | Overlapping comparison periods | "Selected date ranges overlap. Choose non-overlapping periods for comparison." |
| 400 | Same playbook comparison | "Please select two different playbooks for comparison." |
| 403 | Tier restriction (generic) | "This feature requires the Pro plan." |
| 403 | Monte Carlo tier | "Monte Carlo simulation is available on the Pro plan. Upgrade to access advanced analytics." |
| 403 | AI consent required | "Please enable AI insights in your settings before using this feature." |
| 429 | Monte Carlo rate limit | "Too many simulation requests. Please try again later." |
| 429 | AI query limit (Pro) | "You've used all 20 AI queries for today. Your limit resets at midnight UTC." |
| 429 | AI query limit (Team) | "You've used all 50 AI queries for today. Your limit resets at midnight UTC." |
| 503 | AI service unavailable | "AI insights temporarily unavailable. Please try again later." |
| 504 | Monte Carlo timeout | "Simulation timed out. Try reducing the number of iterations." |
| 504 | AI query timeout | "AI service is taking longer than expected. Please try again." |

---

*Document version: 1.0 | Last updated: February 12, 2026*
*This document is part of the TrendEdge FSD suite (FSD-006c of FSD-006, sibling to FSD-006a, FSD-006b)*
