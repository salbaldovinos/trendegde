# FSD-006: Performance Analytics

**TrendEdge — AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-006 |
| Source PRD | PRD-006 |
| Title | Performance Analytics |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-11 |

---

## 1. Introduction

### 1.1 Purpose

This Functional Specification Document defines the complete behavioral requirements for the TrendEdge Performance Analytics Dashboard. It transforms the PRD-006 product requirements into implementable specifications with exact processing logic, error messages, state transitions, edge cases, and testable acceptance criteria. A developer should be able to implement the entire analytics system using only this document without asking clarifying questions.

### 1.2 Problem Statement

Retail futures traders lack a unified analytics system connecting trade execution data, journal context, playbook classification, and trendline quality metadata into a single performance dashboard. Existing tools (TradeZella, Edgewonk, Tradervue) cannot incorporate trendline detection metadata (touch count, slope angle, duration) because that data does not exist in their systems. TrendEdge closes this loop by generating analytics from the same system that detected the setup, executed the trade, and journaled the result.

### 1.3 Scope

This FSD covers:

- Core metrics calculation engine: 7 metric categories, 30+ individual metrics with exact formulas, precision, and edge-case handling
- Dashboard layout, responsive grid system, and widget behavior across all viewport sizes
- Interactive filtering system with AND logic across date range, instrument, and playbook dimensions
- Chart visualizations: equity curve, P&L calendar heatmap, R-multiple histogram, MAE/MFE scatter, drawdown chart, time analysis, session analysis, execution quality, behavioral metrics, trendline analytics
- Advanced Pro-tier analytics: Monte Carlo simulation, strategy correlation matrix, walk-forward analysis, advanced drawdown analysis, AI-powered natural language insights, comparative analytics
- Export system: PDF report generation and CSV data export
- Real-time WebSocket updates for live dashboard refresh
- Team-tier aggregated analytics with member drill-down and leaderboard
- Tier-based feature gating for Free, Trader, Pro, and Team subscription levels

This FSD does NOT cover:

- Trade execution pipeline mechanics (see FSD-003)
- Trade journaling entry/editing workflows (see FSD-004)
- Playbook creation and management (see FSD-005)
- User authentication, registration, or billing (see FSD-001)

### 1.4 Architecture Context

| Layer | Technology | Role |
|---|---|---|
| Frontend | Next.js 14+ (App Router) + TypeScript + Tailwind + shadcn/ui | Dashboard shell, layout, filters, responsive design |
| Charting | Recharts (standard charts) + D3.js (custom visualizations) | Equity curves, histograms, scatter plots, heatmaps, calendar |
| Backend API | FastAPI (Python 3.12+) | Metrics computation endpoints, WebSocket server, export generation |
| Database | PostgreSQL 16 (Supabase) | Trade data storage, materialized views for aggregations, RLS |
| Cache | Redis (Upstash) | Computed metrics cache, WebSocket pub/sub |
| PDF Export | WeasyPrint or Playwright PDF | Server-side PDF report generation |
| Hosting | Vercel (frontend) + Railway (backend) | Production deployment |

### 1.5 Dependencies on Other Systems

| System | FSD Reference | Data Required | Impact if Unavailable |
|---|---|---|---|
| Trade Execution Pipeline | [Cross-reference: see FSD-003 for trade execution details] | Closed trade records, MAE/MFE tick data, signal prices, trendline metadata, broker order data, paper/live flag | No analytics possible without trade records; MAE/MFE estimated from bar data; slippage shows "N/A"; trendline section empty |
| Trade Journaling | [Cross-reference: see FSD-004 for trade journaling details] | Conviction level, emotional state tags, mistake tags, rule compliance boolean | Behavioral metrics section shows "Journal data not available. Link journal entries to enable behavioral analytics." |
| Playbook System | [Cross-reference: see FSD-005 for playbook system details] | Playbook assignments per trade, playbook definitions | Playbook filter dropdown empty; trades appear as "Untagged" |

---

## 2. System Context

### 2.1 User Roles

| Role | Description | Analytics Access |
|---|---|---|
| Free Trader | Unsubscribed user exploring the platform | 5 basic metrics + basic equity curve only. All other widgets locked with blurred preview and upgrade CTA. |
| Trader (Paid) | $49/month subscriber | Full 25+ metrics, all chart visualizations, filtering, dashboard customization (5 presets), CSV export, PDF export (2/month) |
| Pro Trader | $99/month subscriber | Everything in Trader + Monte Carlo, strategy correlation, walk-forward analysis, advanced drawdown, AI insights (20 queries/day), comparative analytics, enhanced calendar, unlimited PDF exports, unlimited layout presets |
| Team Member | Part of Team tier ($199/month) | Everything in Pro + team dashboard visibility (if permitted by admin) |
| Team Admin | Team tier administrator | Everything in Pro + team aggregated dashboard, member drill-down, leaderboard, manager comparison view, AI insights (50 queries/day), team export |

### 2.2 Data Flow Overview

```
Trade Execution Pipeline (PRD-003)
        │
        ▼
   Closed Trade Record
   (entry/exit prices, timestamps, P&L, commissions,
    trendline metadata, MAE/MFE, signal price)
        │
        ├──► PostgreSQL trades table (with RLS)
        │         │
        │         ▼
        │    Materialized Views (mv_daily_pnl, mv_metrics_cache)
        │         │
        │         ▼
        │    FastAPI Metrics Engine ──► Redis Cache (5-min TTL)
        │         │
        │         ├──► REST API endpoints (JSON responses)
        │         └──► WebSocket pub/sub (real-time push)
        │                   │
        │                   ▼
        │              Next.js Dashboard
        │              (Recharts + D3.js rendering)
        │
        ├──► Journal Entries (PRD-004)
        │    (conviction, emotions, mistakes, compliance)
        │
        └──► Playbook Tags (PRD-005)
             (playbook_id per trade)
```

### 2.3 State Diagram: Dashboard Lifecycle

| State | Description | Transitions |
|---|---|---|
| UNINITIALIZED | User has never visited analytics | User navigates to `/dashboard/analytics` -> LOADING |
| LOADING | Fetching metrics from API | Data received -> LOADED; API error -> ERROR; Timeout (15s) -> ERROR |
| LOADED | All widgets rendered with data | Filter changed -> LOADING; New trade closed (WebSocket) -> UPDATING; Export requested -> EXPORTING |
| UPDATING | Incremental metric update via WebSocket | Update complete -> LOADED; Update fails -> LOADED (keep stale data, show warning) |
| ERROR | API unreachable or computation failed | User clicks "Retry" -> LOADING; Cached data available -> STALE |
| STALE | Displaying cached data with freshness warning | API recovers -> LOADING; User clicks "Refresh" -> LOADING |
| EXPORTING | PDF or CSV generation in progress | Export complete -> LOADED (download triggered); Export fails -> LOADED (show error toast) |
| EMPTY | No trades match current filters | Filters changed -> LOADING; New trade closed -> LOADING |

---

## 3. Functional Specifications

### 3.1 AN-FR-001: Trade Performance Metrics

**Source:** PRD-006 Section 3.1, AN-FR-001

**Description:** The system calculates 10 core trade performance metrics from the user's closed trade history. These metrics form the foundation of all analytics and are displayed in the summary stat cards and referenced by charts and advanced analytics.

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| Closed trade records | `trades` table (via RLS-filtered query) | Array of trade objects | Yes |
| Active filters | URL query parameters / filter state | `{ start_date, end_date, instruments[], playbooks[] }` | Yes (defaults apply) |
| Trade P&L | `trades.realized_pnl` (includes commissions and fees) | DECIMAL(12,2) | Yes |
| Entry/exit timestamps | `trades.entry_timestamp`, `trades.exit_timestamp` | TIMESTAMPTZ | Yes |
| Commission/fees | `trades.commission` + `trades.fees` | DECIMAL(8,2) | Yes |

**Processing Logic:**

1. Query all closed trades matching the active filter criteria using AND logic across all filter dimensions.
2. Calculate each metric as follows:

| Metric | Formula | Precision | Implementation Notes |
|---|---|---|---|
| Total Trades | `COUNT(*)` where `status = 'closed'` | Integer | Only closed trades; open/pending excluded |
| Win Rate | `(COUNT(WHERE realized_pnl > 0) / COUNT(*)) * 100` | 1 decimal, e.g., `62.5%` | Breakeven trades (realized_pnl = 0 after commissions) classified as LOSSES |
| Average Winner | `SUM(realized_pnl WHERE realized_pnl > 0) / COUNT(WHERE realized_pnl > 0)` | 2 decimals, currency, e.g., `$342.50` | Returns `null` if zero winners |
| Average Loser | `SUM(realized_pnl WHERE realized_pnl <= 0) / COUNT(WHERE realized_pnl <= 0)` | 2 decimals, currency, e.g., `-$215.75` | Includes breakeven trades; returns `null` if zero losers |
| Profit Factor | `ABS(SUM(realized_pnl WHERE realized_pnl > 0)) / ABS(SUM(realized_pnl WHERE realized_pnl <= 0))` | 2 decimals, e.g., `1.87` | Division by zero: see edge cases |
| Expectancy | `(win_rate/100 * avg_winner) + ((1 - win_rate/100) * avg_loser)` | 2 decimals, currency, e.g., `$47.25` | Uses absolute values of avg_loser in computation |
| Largest Win | `MAX(realized_pnl WHERE realized_pnl > 0)` | 2 decimals, currency | Returns `null` if zero winners |
| Largest Loss | `MIN(realized_pnl WHERE realized_pnl <= 0)` | 2 decimals, currency | Returns `null` if zero losers |
| Total Net P&L | `SUM(realized_pnl)` | 2 decimals, currency, e.g., `$15,420.50` | Includes all commissions and fees |
| Average Trade Duration | `AVG(exit_timestamp - entry_timestamp)` | Hours and minutes, e.g., `2h 35m` | If < 1 hour, display as minutes only e.g., `45m`. If < 1 minute, display `< 1m`. |

3. All P&L values MUST include commissions and fees. The formula is: `realized_pnl = (exit_price - entry_price) * contract_multiplier * quantity * direction_sign - commission - fees`.
4. Metrics recalculate whenever filters change. The frontend debounces filter changes by 300ms before triggering a new API call.

**Outputs:**

```json
{
  "total_trades": 156,
  "win_rate": 62.5,
  "average_winner": 342.50,
  "average_loser": -215.75,
  "profit_factor": 1.87,
  "expectancy": 47.25,
  "largest_win": 2850.00,
  "largest_loss": -1425.00,
  "total_net_pnl": 15420.50,
  "average_trade_duration_seconds": 9300,
  "average_trade_duration_display": "2h 35m",
  "winning_trades": 97,
  "losing_trades": 59,
  "breakeven_trades": 3,
  "filter_applied": {
    "start_date": "2026-01-12",
    "end_date": "2026-02-11",
    "instruments": ["CL", "GC"],
    "playbooks": ["all"]
  },
  "computed_at": "2026-02-11T14:30:05Z"
}
```

**Business Rules:**

- BR-001: Breakeven trades (realized_pnl = $0.00 after commissions) SHALL be classified as losses for win rate calculation.
- BR-002: All P&L calculations SHALL include commissions and fees. A trade with $100 gross profit and $12 commission has realized_pnl = $88.00.
- BR-003: Only trades with `status = 'closed'` are included. Open, pending, or cancelled trades are excluded.
- BR-004: Metrics recalculate when ANY filter changes (date range, instrument, playbook).
- BR-005: The default filter on first load is: date range = 30 Days, instruments = all, playbooks = all.

**Error Handling:**

| Error Condition | HTTP Status | Error Message | Behavior |
|---|---|---|---|
| Database query timeout (> 10s) | 504 | "Metrics calculation timed out. Please try a narrower date range or fewer filters." | Frontend shows error state in all metric cards with retry button |
| Database connection failure | 503 | "Analytics service temporarily unavailable. Please try again in a few minutes." | Frontend shows last cached values (if available) with "Data may be stale" warning |
| Invalid date range (start > end) | 400 | "Invalid date range: start date must be before end date." | Frontend prevents this via date picker validation; API rejects as fallback |
| Future end date | 400 | "End date cannot be in the future." | API clamps end_date to current date if future date submitted |
| Invalid instrument code | 400 | "Unknown instrument: '{code}'. Available instruments: {list}." | Frontend dropdown only shows valid instruments; API validates as fallback |

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| 0 trades match filters | All metrics return `null`. Frontend displays "No trades match the selected filters. Try adjusting the date range or removing instrument filters." in each metric card. |
| 1 trade (winner) | Win rate = 100.0%. Profit factor = display as "N/A" (no losses to divide by). Average loser = `null`, displayed as "—". Expectancy = average_winner value. |
| 1 trade (loser) | Win rate = 0.0%. Profit factor = 0.00. Average winner = `null`, displayed as "—". Expectancy = average_loser value. |
| All trades are winners | Profit factor returned as `null` with display hint `">99.99"`. Expectancy = average_winner. |
| All trades are losers | Profit factor = 0.00. Win rate = 0.0%. Expectancy = average_loser (negative). |
| Single breakeven trade ($0 P&L) | Win rate = 0.0% (classified as loss). Profit factor = 0.00. Average loser = $0.00. |
| Extremely large P&L (> $100,000 single trade) | No overflow. Currency formatting truncates to 2 decimals. Charts auto-scale Y-axis. Display uses abbreviation for large numbers: $100K, $1.2M. |
| Trade duration < 1 second | Display as "< 1m". Store actual duration_seconds for computation. |
| Trade spanning multiple calendar days | Duration computed from exact timestamps. Attributed to exit date for daily P&L aggregation. |

---

### 3.2 AN-FR-002: Risk-Adjusted Metrics

**Source:** PRD-006 Section 3.1, AN-FR-002

**Description:** The system calculates risk-adjusted performance metrics (Sharpe, Sortino, Calmar ratios and drawdown statistics) to enable traders to evaluate their strategy quality beyond raw P&L.

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| Daily P&L series | `mv_daily_pnl` materialized view | Array of `{ date, net_pnl }` | Yes |
| Risk-free rate | User settings, default 5.0% annual | DECIMAL(4,2) | No (default 5.0%) |
| Equity curve data points | Derived from cumulative daily P&L | Array of `{ date, equity }` | Yes |

**Processing Logic:**

1. **Daily Returns Calculation:**
   - Group closed trades by exit date (exchange timezone).
   - Sum realized_pnl per day to get daily P&L.
   - Days with no closed trades are EXCLUDED from return calculations (trading days only).
   - Daily return = daily_pnl / account_equity_at_start_of_day. If account equity tracking is not available, use cumulative P&L as a proxy.

2. **Sharpe Ratio:**
   - `daily_risk_free = (1 + annual_risk_free_rate)^(1/252) - 1`
   - `excess_returns = daily_returns - daily_risk_free` for each trading day
   - `sharpe = mean(excess_returns) / stdev(excess_returns) * sqrt(252)` (annualized)
   - Minimum 20 trading days with trades required. Below 20, return `null` with display text "Insufficient data (minimum 20 trading days required)".

3. **Sortino Ratio:**
   - Same as Sharpe but denominator uses only downside deviation.
   - `downside_returns = [r for r in excess_returns if r < 0]`
   - `downside_deviation = sqrt(mean(downside_returns^2))`
   - `sortino = mean(excess_returns) / downside_deviation * sqrt(252)`
   - If no negative returns exist, return `null` with display text "N/A (no negative return days)".
   - Minimum 20 trading days required.

4. **Calmar Ratio:**
   - `annualized_return = total_return * (252 / trading_days_count)`
   - `calmar = annualized_return / abs(max_drawdown_pct)`
   - Uses rolling 36-month window, or full available history if less than 36 months.
   - If max drawdown = 0 (no drawdown ever), return `null` with display text "N/A (no drawdown period)".

5. **Drawdown Calculations:**
   - Build equity curve as cumulative P&L series.
   - At each point: `drawdown = equity - running_max(equity)`. Drawdown is always <= 0.
   - `max_drawdown_dollars = min(drawdown_series)` (most negative value)
   - `max_drawdown_pct = max_drawdown_dollars / equity_at_peak * 100`
   - A drawdown period starts when equity drops below the previous peak and ends when equity reaches a new peak.
   - Recovery time = trading days from trough to new peak. If equity has not recovered, display "Ongoing".
   - `average_drawdown = mean(all drawdown period depths)`
   - `drawdown_count = number of distinct drawdown periods`

**Outputs:**

```json
{
  "sharpe_ratio": 1.45,
  "sortino_ratio": 2.12,
  "calmar_ratio": 3.85,
  "max_drawdown_dollars": -2400.00,
  "max_drawdown_pct": -8.3,
  "max_drawdown_peak_date": "2026-01-05",
  "max_drawdown_trough_date": "2026-01-12",
  "max_drawdown_recovery_date": "2026-01-20",
  "recovery_time_days": 8,
  "average_drawdown_dollars": -1200.00,
  "drawdown_count": 4,
  "trading_days_count": 45,
  "risk_free_rate_used": 5.0,
  "insufficient_data": false
}
```

**Business Rules:**

- BR-006: Risk-free rate is configurable per user in settings. Default: 5.0% annual. Valid range: 0.0% to 20.0%. Stored in `user_settings.risk_free_rate`.
- BR-007: Days with no closed trades are excluded from Sharpe/Sortino computation (trading days only, not calendar days).
- BR-008: Sharpe and Sortino require minimum 20 trading days with trades. This threshold is not configurable.
- BR-009: Drawdown periods are delineated by equity peaks. A new drawdown starts only after the previous drawdown has fully recovered (equity reaches a new high).

**Error Handling:**

| Error Condition | Response |
|---|---|
| Fewer than 20 trading days | Return `sharpe_ratio: null, sortino_ratio: null` with `insufficient_data: true` and `insufficient_data_message: "Minimum 20 trading days with trades required for ratio calculations."` |
| Standard deviation of returns = 0 | Return `sharpe_ratio: null` with message "All daily returns are identical. Sharpe ratio undefined." |
| No drawdown periods (equity never declined) | `max_drawdown_dollars: 0, max_drawdown_pct: 0, calmar_ratio: null` with message "No drawdown periods recorded." |
| Risk-free rate outside valid range | Clamp to 0.0-20.0 range. Log warning. |

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| Only 1 trading day | All ratios return `null` with insufficient data message. Drawdown = 0 if that day was profitable, or drawdown = that day's loss if negative. |
| All days negative | Sharpe will be negative. Sortino denominator = stdev of all returns. Max drawdown = total loss. |
| Single massive winning day skewing returns | Sharpe may be high but trade count warning displayed: "Metrics based on only N trading days — interpret with caution." for N < 30. |
| Ongoing drawdown (equity has not recovered) | `recovery_time_days: null`, display "Ongoing". `max_drawdown_recovery_date: null`. |

---

### 3.3 AN-FR-003: R-Multiple Analysis

**Source:** PRD-006 Section 3.1, AN-FR-003

**Description:** The system calculates R-multiple metrics measuring trade outcomes relative to initial risk, enabling traders to evaluate performance in risk-normalized units.

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| Trade realized P&L | `trades.realized_pnl` | DECIMAL(12,2) | Yes |
| Initial stop loss price | `trades.stop_loss_price` | DECIMAL(12,4) | Required for R-multiple calculation |
| Entry price | `trades.entry_price` | DECIMAL(12,4) | Yes |
| Contract multiplier | `instruments.contract_multiplier` | DECIMAL(10,2) | Yes |
| Quantity | `trades.quantity` | INTEGER | Yes |
| Trade direction | `trades.direction` (`'long'` or `'short'`) | VARCHAR(5) | Yes |

**Processing Logic:**

1. **Per-Trade R-Multiple:**
   - `initial_risk_per_contract = abs(entry_price - stop_loss_price) * contract_multiplier`
   - `total_initial_risk = initial_risk_per_contract * quantity`
   - `r_multiple = realized_pnl / total_initial_risk`
   - Precision: 2 decimal places.
   - If `stop_loss_price` is NULL, R-multiple for that trade = `null`, displayed as "N/A".

2. **Aggregate R Metrics:**
   - Only include trades where R-multiple is not null.
   - `average_r = mean(all r_multiples)`
   - `median_r = median(all r_multiples)`
   - `r_expectancy = mean(all r_multiples)` (same as average R; represents system expectancy in R terms)
   - `best_r = max(all r_multiples)`
   - `worst_r = min(all r_multiples)`
   - `cumulative_r = running sum of r_multiples ordered by exit_timestamp`
   - `r_std_dev = standard_deviation(all r_multiples)`
   - `r_skewness = skewness(all r_multiples)` using Fisher's definition

3. **Excluded Trade Count:** Count and return the number of trades excluded from R-multiple analysis due to missing stop loss.

**Outputs:**

```json
{
  "average_r": 0.85,
  "median_r": 0.42,
  "r_expectancy": 0.85,
  "best_r": 5.20,
  "worst_r": -2.80,
  "r_std_dev": 1.45,
  "r_skewness": 0.72,
  "trades_with_r": 142,
  "trades_without_r": 14,
  "cumulative_r_series": [
    { "trade_number": 1, "date": "2025-11-15", "r_multiple": 1.20, "cumulative_r": 1.20 },
    { "trade_number": 2, "date": "2025-11-16", "r_multiple": -0.80, "cumulative_r": 0.40 }
  ]
}
```

**Business Rules:**

- BR-010: Trades without a defined stop loss (`stop_loss_price IS NULL`) are excluded from ALL R-based aggregate metrics and display "N/A" for their individual R-multiple.
- BR-011: The count of excluded trades MUST be displayed to the user: "14 trades excluded from R-multiple analysis (no stop loss defined)."
- BR-012: R-multiple is directional. For long trades: R > 0 means profit. For short trades: the formula automatically handles direction since realized_pnl already accounts for direction.
- BR-013: If initial_risk = 0 (stop loss at entry price), R-multiple = `null` for that trade with note "Stop at entry — R-multiple undefined."

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| All trades missing stop loss | All R metrics return `null`. Display "R-multiple analysis requires trades with defined stop losses. Set stop loss when entering trades to enable this analysis." |
| Only 1 trade with R-multiple | Average R = that trade's R. Median R = same. Std dev = 0. Skewness = `null` (requires 3+ data points). |
| R-multiple > 10 | Valid. Display normally. No cap applied. |
| R-multiple < -5 | Valid. Display normally. Indicates stop was likely moved or not honored. |
| Initial risk = $0 (stop at entry) | R-multiple = `null`. Trade excluded from R aggregates. |

---

### 3.4 AN-FR-004: Time-Based Analysis Metrics

**Source:** PRD-006 Section 3.1, AN-FR-004

**Description:** The system calculates P&L and win rate segmented by time dimensions (hour, day of week, month, session) to identify temporal patterns in trading performance.

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| Trade entry timestamp | `trades.entry_timestamp` | TIMESTAMPTZ | Yes |
| Trade exit timestamp | `trades.exit_timestamp` | TIMESTAMPTZ | Yes |
| Trade realized P&L | `trades.realized_pnl` | DECIMAL(12,2) | Yes |
| Trade R-multiple | Computed per AN-FR-003 | DECIMAL(6,2) or null | No |
| Instrument | `trades.instrument` | VARCHAR(10) | Yes |
| RTH session config | `instrument_settings.rth_start`, `instrument_settings.rth_end` | TIME | Yes (defaults apply) |
| Exchange timezone | `instruments.exchange_timezone` | VARCHAR(50) | Yes |

**Processing Logic:**

1. **Hour of Day Analysis:**
   - Convert `entry_timestamp` to exchange local timezone for the trade's instrument.
   - Group trades by hour (0-23).
   - Per hour: calculate `net_pnl = SUM(realized_pnl)`, `trade_count = COUNT(*)`, `win_rate = (winners / total) * 100`, `avg_r = AVG(r_multiple) WHERE r_multiple IS NOT NULL`.

2. **Day of Week Analysis:**
   - Extract day of week from `entry_timestamp` (exchange timezone).
   - Group by Monday through Friday (0=Monday, 4=Friday).
   - Per day: calculate `net_pnl`, `trade_count`, `win_rate`, `avg_r`.

3. **Month Analysis (Calendar Year Aggregate):**
   - Group by month number (1=January through 12=December) across all years.
   - Per month: calculate `net_pnl`, `trade_count`, `win_rate`, `avg_r`.

4. **Month Analysis (Chronological):**
   - Group by specific year-month (e.g., "2026-01", "2026-02").
   - Per year-month: calculate `net_pnl`, `trade_count`, `win_rate`, `avg_r`.

5. **Session Analysis (RTH vs. Overnight):**
   - Default RTH hours by instrument:
     - ES, NQ, YM, MES, MNQ, MYM: 09:30-16:00 ET
     - CL, MCL: 09:00-14:30 ET
     - GC, MGC: 08:20-13:30 ET
     - PL: 08:20-13:05 ET
   - Classification: if `entry_timestamp` (in exchange timezone) falls within RTH hours, classify as "RTH". Otherwise, classify as "Overnight".
   - RTH hours are configurable per instrument in user settings. User overrides stored in `user_instrument_settings.rth_start` and `user_instrument_settings.rth_end`.

**Outputs:**

```json
{
  "by_hour": [
    { "hour": 9, "net_pnl": 3250.00, "trade_count": 28, "win_rate": 67.9, "avg_r": 1.15 },
    { "hour": 10, "net_pnl": 1820.00, "trade_count": 35, "win_rate": 60.0, "avg_r": 0.72 }
  ],
  "by_day_of_week": [
    { "day": "Monday", "day_index": 0, "net_pnl": 2100.00, "trade_count": 32, "win_rate": 65.6, "avg_r": 0.95 }
  ],
  "by_month_aggregate": [
    { "month": "January", "month_index": 1, "net_pnl": 4500.00, "trade_count": 45, "win_rate": 62.2, "avg_r": 0.88 }
  ],
  "by_month_chronological": [
    { "year_month": "2026-01", "net_pnl": 4500.00, "trade_count": 45, "win_rate": 62.2, "avg_r": 0.88 }
  ],
  "by_session": {
    "rth": { "net_pnl": 12500.00, "trade_count": 120, "win_rate": 64.2, "avg_r": 0.92, "profit_factor": 1.95, "avg_slippage_ticks": 0.8 },
    "overnight": { "net_pnl": 2920.50, "trade_count": 36, "win_rate": 55.6, "avg_r": 0.65, "profit_factor": 1.42, "avg_slippage_ticks": 1.2 }
  },
  "session_insight": "Your RTH trades outperform overnight by $9,579.50 (8.6% higher win rate)."
}
```

**Business Rules:**

- BR-014: A trade's time classification (hour, day, session) is based on the ENTRY timestamp, not exit.
- BR-015: Hour-of-day analysis uses the exchange's local timezone, not the user's local timezone.
- BR-016: RTH session times are configurable per instrument. Defaults are documented above.
- BR-017: Session insight callout generated when one session's win rate exceeds the other by 5+ percentage points or net P&L differs by more than 25%.

**Error Handling:**

| Error Condition | Response |
|---|---|
| No trades in a particular hour/day/month | That segment returns `{ net_pnl: 0, trade_count: 0, win_rate: null, avg_r: null }`. Chart bar is omitted or shown at zero height. |
| Invalid RTH configuration (start >= end) | Reject with error: "Invalid RTH configuration: start time must be before end time." Revert to default. |
| Exchange timezone not configured for instrument | Default to "America/New_York" and log warning. |

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| Trade entered at exactly RTH start time (e.g., 09:30:00) | Classified as RTH (inclusive start boundary). |
| Trade entered at exactly RTH end time (e.g., 16:00:00) | Classified as Overnight (exclusive end boundary). |
| Trade entered on weekend (Saturday/Sunday) | Classified under the day it occurs. If futures market is closed (no trades expected), display the day normally if trades exist. |
| All trades in single hour | Only one bar in hour-of-day chart. Other hours show no bar. |

---

### 3.5 AN-FR-005: Execution Quality Metrics

**Source:** PRD-006 Section 3.1, AN-FR-005

**Description:** The system calculates execution quality metrics including slippage, fill rate, MAE/MFE, and composite fill quality score.

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| Fill price | `trades.entry_fill_price`, `trades.exit_fill_price` | DECIMAL(12,4) | Yes |
| Signal price | `trades.signal_price` | DECIMAL(12,4) | Required for slippage |
| Order type | `trades.order_type` (`'market'`, `'limit'`, `'stop'`, `'stop_limit'`) | VARCHAR(20) | Yes |
| Broker ID | `trades.broker_connection_id` | UUID | Yes |
| Instrument | `trades.instrument` | VARCHAR(10) | Yes |
| Tick size | `instruments.tick_size` | DECIMAL(8,6) | Yes |
| Tick value | `instruments.tick_value` | DECIMAL(8,2) | Yes |
| MAE ticks | `trades.mae_ticks` | INTEGER | No |
| MFE ticks | `trades.mfe_ticks` | INTEGER | No |
| MAE data source flag | `trades.mae_source` (`'tick'`, `'bar'`, `null`) | VARCHAR(4) | No |
| Orders submitted count | From execution pipeline | INTEGER | For fill rate |
| Orders filled count | From execution pipeline | INTEGER | For fill rate |

**Processing Logic:**

1. **Slippage Calculation:**
   - Entry slippage (ticks): `(entry_fill_price - signal_price) / tick_size` for long trades; `(signal_price - entry_fill_price) / tick_size` for short trades.
   - Positive slippage = unfavorable (bought higher, sold lower than signal). Negative = favorable.
   - Entry slippage (dollars): `slippage_ticks * tick_value * quantity`.
   - Average slippage: `mean(all entry slippage ticks)`.
   - Slippage by instrument: group by instrument, calculate mean slippage ticks and dollars.
   - Slippage by broker: group by broker_connection_id, calculate mean slippage ticks.
   - Slippage by order type: group by order_type, calculate mean slippage ticks.
   - If `signal_price` is NULL, that trade is excluded from slippage calculations.

2. **MAE/MFE Calculation:**
   - MAE (dollars) = `mae_ticks * tick_value * quantity`.
   - MFE (dollars) = `mfe_ticks * tick_value * quantity`.
   - MAE in R-multiples = `mae_dollars / total_initial_risk` (from AN-FR-003).
   - MFE in R-multiples = `mfe_dollars / total_initial_risk`.
   - If `mae_source = 'bar'`, flag the value as "estimated" in the output.
   - If `mae_ticks IS NULL`, that trade is excluded from MAE/MFE analysis.

3. **Edge Ratio:** `avg(mfe_ticks) / avg(mae_ticks)`. Higher is better (favorable moves exceed adverse moves on average).

4. **Fill Quality Score (0-100):**
   - `normalized_slippage = min(avg_slippage_ticks / max_acceptable_slippage, 1.0)` where `max_acceptable_slippage = 3.0 ticks`.
   - `fill_quality = (1 - normalized_slippage) * fill_rate * 100`.
   - Clamped to 0-100 range.

**Outputs:**

```json
{
  "average_slippage_ticks": 0.85,
  "average_slippage_dollars": 8.50,
  "slippage_by_instrument": [
    { "instrument": "CL", "avg_slippage_ticks": 1.2, "avg_slippage_dollars": 12.00, "trade_count": 85 },
    { "instrument": "GC", "avg_slippage_ticks": 0.5, "avg_slippage_dollars": 5.00, "trade_count": 42 }
  ],
  "slippage_by_broker": [
    { "broker_id": "uuid-1", "broker_name": "Rithmic", "avg_slippage_ticks": 0.7, "trade_count": 100 }
  ],
  "slippage_by_order_type": [
    { "order_type": "market", "avg_slippage_ticks": 1.4, "trade_count": 90 },
    { "order_type": "limit", "avg_slippage_ticks": -0.2, "trade_count": 66 }
  ],
  "fill_rate": 97.5,
  "fill_quality_score": 82,
  "fill_quality_label": "Excellent",
  "edge_ratio": 1.65,
  "mae_mfe_data": [
    {
      "trade_id": "uuid",
      "date": "2026-01-15",
      "instrument": "CL",
      "playbook": "A+ Break",
      "entry_price": 72.50,
      "exit_price": 73.10,
      "mae_ticks": 8,
      "mae_dollars": 80.00,
      "mae_r": 0.40,
      "mfe_ticks": 22,
      "mfe_dollars": 220.00,
      "mfe_r": 1.10,
      "outcome_r": 0.85,
      "outcome_dollars": 170.00,
      "mae_source": "tick",
      "is_winner": true
    }
  ],
  "mae_mfe_insights": {
    "pct_winners_mae_above_half_r": 35.0,
    "avg_mfe_capture_pct": 68.5,
    "insight_mae": "35.0% of your winners had MAE > 0.5R, suggesting your stops may be optimally placed.",
    "insight_mfe": "On average, you capture 68.5% of the maximum favorable move."
  },
  "trades_without_signal_price": 8,
  "trades_without_mae_mfe": 22,
  "trades_with_estimated_mae": 15
}
```

**Business Rules:**

- BR-018: Slippage is signed. Positive = unfavorable (trader got a worse price than the signal). Negative = favorable (trader got a better price).
- BR-019: Trades without `signal_price` are excluded from slippage metrics. The count of excluded trades is reported.
- BR-020: MAE/MFE values from bar data (not tick data) MUST be flagged as "estimated" in the UI with an informational tooltip: "This value is estimated from bar data. Tick-level data was unavailable for this trade."
- BR-021: Fill Quality Score color coding: 80-100 = "Excellent" (green), 60-79 = "Good" (blue), 40-59 = "Fair" (yellow), 0-39 = "Poor" (red).

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| No trades have signal_price | Slippage metrics return `null`. Display: "Slippage data unavailable. Signal prices are required for slippage calculation." |
| No trades have MAE/MFE data | MAE/MFE section returns `null`. Display: "MAE/MFE data unavailable. Price data during trade holding period is required." |
| Zero fill rate | fill_quality_score = 0. |
| Negative average slippage (favorable) | Display in green: "Average slippage: -0.3 ticks (favorable)". fill_quality_score treats negative slippage as 0 for the normalized_slippage component (maximum quality). |
| Edge ratio with avg MAE = 0 | Edge ratio = `null`. Display "N/A (no adverse excursion recorded)". |

---

### 3.6 AN-FR-006: Behavioral Metrics

**Source:** PRD-006 Section 3.1, AN-FR-006

**Description:** The system calculates behavioral metrics from journal entries including rule compliance, cost of mistakes, Tiltmeter score, conviction analysis, and emotional state correlations. [Cross-reference: see FSD-004 for trade journaling details]

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| Rule compliance flag | `journal_entries.rules_followed` | BOOLEAN | No |
| Mistake tags | `journal_entries.mistake_tags` | TEXT[] (array) | No |
| Emotional state tags | `journal_entries.emotional_state` | TEXT[] (array) | No |
| Conviction level | `journal_entries.conviction` | INTEGER (1-5) | No |
| Trade realized P&L | `trades.realized_pnl` | DECIMAL(12,2) | Yes |
| Trade R-multiple | Computed per AN-FR-003 | DECIMAL(6,2) | No |
| Planned position size | `trades.planned_quantity` | INTEGER | No |
| Actual position size | `trades.quantity` | INTEGER | Yes |
| Trade entry timestamp | `trades.entry_timestamp` | TIMESTAMPTZ | Yes |

**Processing Logic:**

1. **Rule Compliance Rate:**
   - `rule_compliance_rate = (COUNT(WHERE rules_followed = true) / COUNT(WHERE rules_followed IS NOT NULL)) * 100`
   - Only trades with journal entries that include the rules_followed field are counted.
   - Trades without journal entries are excluded (not counted as violations).
   - Precision: 1 decimal place.

2. **Cost of Mistakes:**
   - `cost_of_mistakes = SUM(realized_pnl WHERE mistake_tags IS NOT NULL AND array_length(mistake_tags) > 0)`
   - Breakdown by mistake type: group by each unique mistake tag, sum P&L per tag.
   - Valid mistake types: `'moved_stop'`, `'entered_early'`, `'oversized'`, `'held_too_long'`, `'exited_too_early'`, `'revenge_trade'`, `'fomo_entry'`, `'ignored_rules'`, `'wrong_instrument'`, `'other'`.
   - A trade can have multiple mistake tags. It is counted once in each relevant category.

3. **Mistake Frequency:**
   - `mistake_frequency = (COUNT(WHERE mistake_tags IS NOT NULL AND array_length(mistake_tags) > 0) / COUNT(*)) * 100`
   - Precision: 1 decimal place.

4. **Tiltmeter Score (0-100):**
   - Rolling computation over the LAST 10 trades (most recent by exit_timestamp).
   - Components:

   | Component | Weight | Calculation |
   |---|---|---|
   | Emotional State | 25% | For each of the last 10 trades: score = 0 if tags include 'confident', 'patient', or 'disciplined'; score = 50 if tags include 'anxious' or 'uncertain'; score = 100 if tags include 'fomo', 'revenge', 'frustrated', or 'fearful'. Average the 10 scores. |
   | Mistake Rate | 30% | `(trades_with_mistakes_in_last_10 / 10) * 100` |
   | Position Size Deviation | 25% | For each of last 10 trades: `abs(quantity - planned_quantity) / planned_quantity * 100`, capped at 100. Average the 10 values. If `planned_quantity` is NULL, exclude that trade from this component and average over remaining trades. |
   | Trade Frequency Anomaly | 20% | `baseline_frequency = avg trades per week over trailing 30 calendar days`. `current_frequency = trades in last 7 calendar days * (30/7)` normalized to 30-day rate. `anomaly = max(0, (current_frequency / baseline_frequency - 1) * 100)`, capped at 100. If baseline is 0, anomaly = 0. |

   - `tiltmeter = emotional_state_score * 0.25 + mistake_rate_score * 0.30 + position_deviation_score * 0.25 + frequency_anomaly_score * 0.20`
   - Round to nearest integer.

5. **Conviction vs. Outcome Correlation:**
   - Pearson correlation coefficient between conviction level (1-5) and R-multiple.
   - Only include trades that have both conviction AND R-multiple values.
   - Minimum 10 trades required for meaningful correlation. Below 10: return `null` with "Insufficient data for correlation analysis (minimum 10 trades with both conviction and R-multiple required)."

6. **Emotional State P&L:**
   - Group trades by each emotional state tag.
   - Per state: `net_pnl = SUM(realized_pnl)`, `trade_count = COUNT(*)`, `win_rate`, `avg_r`.
   - A trade with multiple emotional tags contributes to each relevant group.

**Outputs:**

```json
{
  "rule_compliance_rate": 78.5,
  "trades_with_compliance_data": 121,
  "cost_of_mistakes_total": -4250.00,
  "mistake_breakdown": [
    { "type": "moved_stop", "count": 12, "total_pnl": -2100.00, "avg_pnl": -175.00 },
    { "type": "oversized", "count": 8, "total_pnl": -1350.00, "avg_pnl": -168.75 },
    { "type": "entered_early", "count": 6, "total_pnl": -800.00, "avg_pnl": -133.33 }
  ],
  "mistake_frequency": 16.7,
  "tiltmeter_score": 34,
  "tiltmeter_zone": "caution",
  "tiltmeter_components": {
    "emotional_state": 20.0,
    "mistake_rate": 30.0,
    "position_deviation": 45.0,
    "frequency_anomaly": 50.0
  },
  "tiltmeter_color": "#F59E0B",
  "conviction_correlation": 0.32,
  "conviction_correlation_significance": "weak_positive",
  "conviction_data_points": 98,
  "average_conviction": 3.4,
  "emotional_state_pnl": [
    { "state": "confident", "net_pnl": 8500.00, "trade_count": 45, "win_rate": 71.1, "avg_r": 1.20 },
    { "state": "anxious", "net_pnl": -1200.00, "trade_count": 18, "win_rate": 44.4, "avg_r": -0.35 },
    { "state": "fomo", "net_pnl": -2800.00, "trade_count": 12, "win_rate": 33.3, "avg_r": -0.95 }
  ]
}
```

**Business Rules:**

- BR-022: Tiltmeter color zones: 0-25 = green (#22C55E, "disciplined"), 26-50 = yellow (#F59E0B, "caution"), 51-75 = orange (#F97316, "elevated_risk"), 76-100 = red (#EF4444, "tilt").
- BR-023: Tiltmeter is computed over the last 10 trades. If fewer than 10 trades exist, compute over all available trades and display "(based on N trades)" note.
- BR-024: Baseline trade frequency uses trailing 30 calendar days. If the user has been trading for fewer than 30 days, use all available history.
- BR-025: A trade can have multiple mistake tags. Its P&L is counted in each mistake category independently. The total cost_of_mistakes counts the trade's P&L only once.
- BR-026: Trades without journal entries are excluded from behavioral metrics (not treated as compliant or non-compliant). The denominator is trades WITH journal data.

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| No journal entries linked to any trade | All behavioral metrics return `null`. Display: "No journal data available. Complete journal entries for your trades to enable behavioral analytics." |
| All trades followed rules | Rule compliance = 100.0%. Cost of mistakes = $0.00. |
| Tiltmeter with fewer than 10 trades | Compute over available trades. Display: "Tiltmeter score based on N trades (10 recommended for accuracy)." |
| Planned quantity = 0 or NULL | Exclude that trade from position size deviation component. |
| Conviction all same value (e.g., all 3) | Correlation = `null` (no variance). Display: "Insufficient variance in conviction levels for correlation analysis." |
| No emotional state tags on any trade | Emotional state P&L returns empty array. Tiltmeter emotional component = 0 (assumes disciplined). |

---

### 3.7 AN-FR-007: Trendline-Specific Analytics

**Source:** PRD-006 Section 3.1, AN-FR-007

**Description:** The system calculates performance metrics segmented by trendline characteristics, enabling traders to validate whether specific trendline criteria (touch count, slope, duration, grade) predict better trading outcomes.

**Inputs:**

| Input | Source | Type | Required |
|---|---|---|---|
| Trendline touch count | `trades.trendline_touch_count` | INTEGER | Required for trendline analytics |
| Trendline slope angle | `trades.trendline_slope_degrees` | DECIMAL(5,2) | Required for slope analysis |
| Trendline duration | `trades.trendline_duration_days` | INTEGER | Required for duration analysis |
| Trendline grade | `trades.trendline_grade` (`'A+'`, `'A'`, `'B'`) | VARCHAR(2) | Required for grade analysis |
| Setup type | `trades.setup_type` (`'break'`, `'bounce'`) | VARCHAR(10) | Required for setup comparison |
| Candle spacing | `trades.trendline_candle_spacing` | INTEGER | Required for spacing analysis |
| Trade realized P&L | `trades.realized_pnl` | DECIMAL(12,2) | Yes |
| Trade R-multiple | Computed per AN-FR-003 | DECIMAL(6,2) | No |

**Processing Logic:**

1. **Filter:** Only include trades where trendline metadata is present (`trendline_touch_count IS NOT NULL`). Count and report excluded trades.

2. **Segmented Metrics by Touch Count:**
   - Segments: 2 touches, 3 touches, 4 touches, 5+ touches.
   - Per segment: `win_rate`, `avg_r`, `profit_factor`, `trade_count`.

3. **Segmented Metrics by Slope Angle:**
   - Segments: 0-15 degrees, 15-30 degrees, 30-45 degrees, 45+ degrees.
   - Per segment: `win_rate`, `avg_r`, `profit_factor`, `trade_count`.
   - Boundary values: 15.00 degrees goes into 15-30 bucket (inclusive lower, exclusive upper, except last bucket which is inclusive).

4. **Segmented Metrics by Duration:**
   - Segments: <7 days, 7-21 days, 21-56 days, 56+ days.
   - Per segment: `win_rate`, `avg_r`, `profit_factor`, `trade_count`.

5. **Segmented Metrics by Grade:**
   - Segments: A+, A, B.
   - Per segment: `win_rate`, `avg_r`, `profit_factor`, `trade_count`.

6. **Segmented Metrics by Setup Type:**
   - Segments: Break, Bounce.
   - Per segment: `win_rate`, `avg_r`, `profit_factor`, `trade_count`.

7. **Segmented Metrics by Candle Spacing:**
   - Segments: <6 candles, 6-10 candles, 10-20 candles, 20+ candles.
   - Per segment: `win_rate`, `avg_r`, `profit_factor`, `trade_count`.

8. **Statistical Significance Indicator:**
   - Per segment: if `trade_count >= 30`, display "High Confidence (n=N)".
   - If `trade_count >= 10 AND < 30`, display "Moderate Confidence (n=N)".
   - If `trade_count < 10`, display "Low Confidence (n=N)" with visual de-emphasis (semi-transparent or hatched bar).

**Outputs:**

```json
{
  "trades_included": 128,
  "trades_excluded": 28,
  "excluded_reason": "28 trades excluded from trendline analytics (no trendline metadata attached).",
  "by_touch_count": [
    { "segment": "2", "win_rate": 52.0, "avg_r": 0.35, "profit_factor": 1.22, "trade_count": 25, "confidence": "Low Confidence (n=25)" },
    { "segment": "3", "win_rate": 64.0, "avg_r": 0.92, "profit_factor": 1.85, "trade_count": 50, "confidence": "High Confidence (n=50)" },
    { "segment": "4", "win_rate": 68.0, "avg_r": 1.15, "profit_factor": 2.10, "trade_count": 38, "confidence": "High Confidence (n=38)" },
    { "segment": "5+", "win_rate": 73.3, "avg_r": 1.42, "profit_factor": 2.55, "trade_count": 15, "confidence": "Low Confidence (n=15)" }
  ],
  "by_slope_angle": [],
  "by_duration": [],
  "by_grade": [],
  "by_setup_type": [],
  "by_candle_spacing": []
}
```

**Business Rules:**

- BR-027: Only trades with trendline metadata participate in trendline analytics. Manual/custom playbook trades without trendline metadata are excluded.
- BR-028: The count of excluded trades MUST be displayed: "N trades excluded from trendline analytics (no trendline metadata attached)."
- BR-029: Statistical significance thresholds: >=30 = High Confidence, 10-29 = Moderate Confidence, <10 = Low Confidence.
- BR-030: Segments with Low Confidence (<10 trades) are visually de-emphasized in charts (semi-transparent bars or hatched pattern) with tooltip: "Small sample size — interpret with caution."

**Edge Cases:**

| Scenario | Behavior |
|---|---|
| No trades have trendline metadata | All trendline metrics return `null`. Display: "No trendline data available. Trades must be auto-classified from the trendline engine to enable this analysis." |
| All trades in one segment | Only that segment has data. Other segments show `{ trade_count: 0, win_rate: null, avg_r: null, profit_factor: null }`. |
| Slope angle exactly 45.0 degrees | Falls into "45+" bucket. |
| Trendline duration = 0 days | Falls into "<7 days" bucket. |

---

### 3.8 AN-FR-008 through AN-FR-010: Dashboard Layout and Widget System

**Source:** PRD-006 Section 3.2, AN-FR-008, AN-FR-009, AN-FR-010

**Description:** The dashboard uses a responsive grid layout with configurable widgets that support expand/collapse, full-screen mode, loading/empty/error states, and drag-and-drop customization.

**3.8.1 Default Layout (Desktop, 1280px+):**

| Row | Content | Grid Columns |
|---|---|---|
| Row 0 | Filter Bar (date range, instrument, playbook selectors, trade count indicator, clear all button) | Full width |
| Row 1 | Summary Stat Cards: Total Net P&L, Win Rate, Profit Factor, Average R, Max Drawdown, Tiltmeter Score | 6 equal columns (each ~200px min) |
| Row 2 | Equity Curve Chart | Full width (12 columns) |
| Row 3 | P&L Calendar Heatmap (8 columns) + R-Multiple Histogram (4 columns) | 2:1 ratio |
| Row 4 | Win Rate by Dimension (6 columns) + Time Analysis (6 columns) | 1:1 ratio |
| Row 5 | MAE/MFE Scatter (6 columns) + Drawdown Chart (6 columns) | 1:1 ratio |
| Row 6 | Execution Quality Table (4 columns) + Behavioral Metrics (4 columns) + Trendline Analytics (4 columns) | 1:1:1 ratio |

**3.8.2 Tablet Layout (768px-1279px):**
- Two-column grid.
- Summary cards wrap to 3 columns x 2 rows.
- All 2-column chart rows stack to full-width single column.
- Row 6 widgets stack vertically.

**3.8.3 Mobile Layout (<768px):**
- Single-column stack.
- Summary cards display as horizontally scrollable carousel with snap scrolling. Each card 280px wide with 12px gap.
- Charts render at full viewport width with height reduced by 30%.
- Interactive elements use tap instead of hover.
- Touch targets: minimum 44x44px.
- No horizontal scrolling on the page body (data tables scroll horizontally within their container).

**3.8.4 Widget Behavior:**

Each widget MUST implement these states:

| State | Visual | Trigger |
|---|---|---|
| Loading | Skeleton loader (animated pulse placeholder matching widget dimensions) | Initial load, filter change |
| Loaded | Full data rendering | API response received |
| Empty | Centered icon + message, e.g., "No trades match the selected filters. Try adjusting the date range or removing instrument filters." | API returns 0 results |
| Error | Red-tinted background, error icon, message text, "Retry" button | API error or timeout |
| Locked (Free tier) | Blurred screenshot of the widget with centered overlay: lock icon + "Upgrade to Trader to unlock [widget name]" button | User is on Free tier |

Widget interactions:

- **Expand/Collapse:** Click the chevron icon in the widget header to toggle between compact (shows key metric only) and expanded (shows full chart/table) view. Default: expanded for above-the-fold widgets (rows 1-3), collapsed for below-the-fold on mobile.
- **Full-Screen Mode:** Click the expand icon (arrows pointing outward) in the widget header. Opens the chart in a modal overlay at full viewport dimensions. Press Escape or click the X button to close. Full-screen mode adds enhanced detail: additional axis labels, gridlines, and a data table below the chart.
- **Tooltip:** Desktop: hover over any data point to see detail values in a floating tooltip positioned above the cursor. Tooltip appears after 200ms hover delay and hides 100ms after mouse leaves. Mobile: tap a data point to show tooltip as a fixed popover. Tap elsewhere to dismiss.

**3.8.5 Dashboard Customization (Trader Tier+):**

- Drag-and-drop reordering: User clicks and holds the drag handle (6-dot grid icon) in the widget header, then drags to a new position. Drop zones highlighted with blue dashed border during drag.
- Hide/show widgets: Settings gear icon in widget header opens a dropdown with "Hide this widget" option. Hidden widgets are accessible from a "Hidden Widgets" tray at the bottom of the dashboard.
- Save layout preset: "Save Layout" button in the dashboard header. Modal: text input for preset name (1-50 characters, alphanumeric + spaces), "Save" and "Cancel" buttons. Preset limit: 5 for Trader, unlimited for Pro/Team. Attempting to save beyond limit: "Maximum 5 layout presets reached. Delete an existing preset to save a new one."
- Load layout preset: Dropdown in dashboard header listing saved presets. Selecting a preset immediately applies the layout.
- Reset to default: "Reset Layout" button confirms with dialog: "Reset dashboard to default layout? This does not delete your saved presets." Buttons: "Reset" (primary) and "Cancel".
- Layout stored in `user_settings.dashboard_layouts` as JSONB in PostgreSQL. Schema: `{ presets: [{ name: string, layout: WidgetPosition[], created_at: timestamp }], active_preset: string | null }`.

---

### 3.9 AN-FR-011 through AN-FR-014: Filtering System

**Source:** PRD-006 Section 3.3, AN-FR-011, AN-FR-012, AN-FR-013, AN-FR-014

**Description:** The dashboard filtering system supports date range, instrument, and playbook filters applied simultaneously with AND logic. Filter state persists in URL query parameters.

**3.9.1 Date Range Filter (AN-FR-011):**

| Preset | URL Parameter | Date Calculation (relative to current date in exchange timezone) |
|---|---|---|
| Today | `?range=today` | `start = today 00:00:00, end = today 23:59:59` |
| 7 Days | `?range=7d` | `start = today - 6 days, end = today` |
| 30 Days | `?range=30d` | `start = today - 29 days, end = today` (default) |
| 90 Days | `?range=90d` | `start = today - 89 days, end = today` |
| YTD | `?range=ytd` | `start = Jan 1 of current year, end = today` |
| All Time | `?range=all` | `start = first trade date, end = today` |
| Custom | `?start=YYYY-MM-DD&end=YYYY-MM-DD` | User-selected via date picker |

- Default on first load (no URL params): 30 Days.
- Date picker: shadcn/ui Calendar component. Click to select start date, click to select end date. Visual highlight on the selected range.
- Validation: start date must be <= end date. Start date must not be before user's first trade date (optimization). End date must not be in the future (clamp to today).
- Display: Selected range shown in the filter bar as text, e.g., "Jan 12 - Feb 11, 2026" for custom, or "Last 30 Days" for presets.

**3.9.2 Instrument Filter (AN-FR-012):**

- Multi-select dropdown with search/filter capability.
- Dynamically populated from `SELECT DISTINCT instrument FROM trades WHERE user_id = :uid ORDER BY instrument`.
- Display format: "CL - Crude Oil", "GC - Gold", "MES - Micro E-mini S&P 500".
- Default: all instruments selected.
- "Select All" button (selects all), "Clear All" button (deselects all, which will result in empty state).
- Active filters shown as dismissible chips below the filter bar. Click X on a chip to deselect that instrument.
- URL parameter: `?instruments=CL,GC,MES` (comma-separated).

**3.9.3 Playbook Filter (AN-FR-013):**

- Multi-select dropdown.
- Populated from user's playbooks with trade counts: "A+ Trendline Break (47)", "Standard Break (32)", "Bounce (28)". [Cross-reference: see FSD-005 for playbook system details]
- Includes "Untagged (14)" option for trades not assigned to any playbook.
- Default: all playbooks selected (including Untagged).
- URL parameter: `?playbooks=uuid1,uuid2,untagged` (comma-separated UUIDs, "untagged" literal for untagged trades).

**3.9.4 Combined Filter Logic (AN-FR-014):**

- All filters apply simultaneously: `WHERE exit_timestamp BETWEEN :start AND :end AND instrument IN (:instruments) AND (playbook_id IN (:playbooks) OR (playbook_id IS NULL AND 'untagged' IN (:playbooks)))`.
- Trade count indicator in filter bar: "Showing 23 of 156 trades".
- If 0 trades match: all widgets enter EMPTY state with message "No trades match the selected filters. Try adjusting the date range or removing instrument filters."
- "Clear All Filters" button resets to: range=30d, all instruments, all playbooks.
- Filter changes debounced by 300ms before triggering API call.
- Filter state persists across page refreshes via URL query parameters.
- Changing filters cancels any in-flight API requests before sending the new request.

---

### 3.10 AN-FR-015 through AN-FR-025: Chart Visualizations

**Source:** PRD-006 Section 3.4

Due to the extensive number of chart specifications, each chart is specified with its key behavioral requirements.

**3.10.1 Equity Curve (AN-FR-015):**

- Chart library: Recharts `<LineChart>`.
- X-axis: trade exit dates. Y-axis: cumulative P&L in dollars.
- Line color: segment-based. Green (`#22C55E`) when cumulative P&L > 0, red (`#EF4444`) when < 0. Color transition at the $0 crossing point.
- Gradient fill below line: green gradient (0.3 opacity at line, 0 at zero line) for positive area, red gradient for negative area.
- Hover tooltip content: `{ date: "Feb 11, 2026", cumulative_pnl: "$15,420.50", daily_pnl: "+$320.00", trade_count: 3 }`.
- Benchmark line: dashed gray horizontal line at $0 (breakeven), labeled "Breakeven".
- Annotations: clickable diamond markers at max drawdown start (red diamond) and end (green diamond), and largest single-day P&L (gold star). Click opens a detail panel with the relevant trades.
- Zoom: click-and-drag on chart area to select a date range for zoom. Selected area highlighted in blue (0.1 opacity). Release to zoom. Double-click anywhere to reset zoom to full range.
- Real-time update: when a WebSocket `trade_closed` event arrives, append a new data point to the curve with a smooth animation (300ms ease-out transition).
- Empty state: "Complete your first trade to see your equity curve" with a placeholder illustration.
- Single data point: render as a single dot with tooltip. No line drawn.

**3.10.2 P&L Calendar Heatmap (AN-FR-016):**

- Layout: GitHub-style grid. Weeks as columns, days (Mon-Sun) as rows.
- Color scale: 5-step diverging scale.
  - Dark red (`#991B1B`): worst 10% of days by P&L
  - Light red (`#FCA5A5`): 10th-40th percentile (losses)
  - White/light gray (`#F3F4F6`): no trades that day
  - Light green (`#86EFAC`): 60th-90th percentile (winners)
  - Dark green (`#166534`): top 10% of days by P&L
- Cell size: 14x14px desktop, 12x12px mobile.
- Hover tooltip: `{ date: "Mon, Jan 15 2026", net_pnl: "+$850.00", trade_count: 4, win_rate: "75.0%" }`.
- Click drill-down: opens a slide-over panel listing trades for that day: instrument, direction (Long/Short), playbook name, P&L (green/red colored), R-multiple. Each trade row links to its journal entry. [Cross-reference: see FSD-004 for trade journaling details]
- Navigation: left/right arrows to scroll months. Default view: current month + previous 11 months.
- Summary row: monthly totals below the calendar grid showing net P&L, trade count, win rate per month.

**3.10.3 R-Multiple Distribution Histogram (AN-FR-017):**

- Chart library: Recharts `<BarChart>`.
- X-axis: R-multiple bins. Default bin width: 0.5R. Configurable: 0.25R, 0.5R, 1.0R via dropdown.
- Y-axis: trade count.
- Bar color: red (`#EF4444`) for bins with negative R center, green (`#22C55E`) for positive.
- Overlay lines: vertical dashed line at average R (blue, `#3B82F6`, labeled), vertical dashed line at median R (purple, `#8B5CF6`, labeled).
- Hover tooltip: `{ r_range: "1.0R to 1.5R", trade_count: 18, pct_of_total: "11.5%" }`.
- Click on bin: filters a trade list panel below the histogram showing only trades in that R range.
- Summary stats displayed above chart: Average R, Median R, Std Dev, Skewness (all 2 decimal places).
- Trades without R-multiple excluded with note: "N trades excluded (no stop loss defined)."

**3.10.4 Win Rate by Dimension (AN-FR-018):**

- Six sub-views selectable via tab strip: By Instrument, By Day of Week, By Hour, By Playbook, By Month, By Setup Type.
- Metric toggle: "Win Rate" (default), "Average R", "Net P&L" — switches the Y-axis metric.
- Bar labels: each bar shows the metric value and trade count, e.g., "62.5% (n=32)".
- Low sample size: bars with fewer than 5 trades rendered with hatched pattern overlay and tooltip "Low sample size — interpret with caution."
- Sorting: By Instrument and By Playbook sorted by trade count descending. By Day/Hour/Month in natural order.

**3.10.5 MAE/MFE Scatter Plots (AN-FR-019):**

- Two scatter plots side by side (desktop) or stacked (mobile).
- Dot size: 8px. Green (`#22C55E`) for winners, red (`#EF4444`) for losers.
- Toggle: switch X/Y axes between R-multiples and ticks/dollars.
- MAE scatter: vertical reference line at 1R (current stop distance). Insight box below chart.
- MFE scatter: diagonal reference line from origin (MFE = outcome, i.e., 100% capture). Insight box below chart.
- Combined table below: sortable columns (date, instrument, playbook, entry, exit, MAE ticks, MAE $, MFE ticks, MFE $, outcome R, outcome $). Toggle to show winners only / losers only / all.

**3.10.6 Drawdown Chart (AN-FR-020):**

- Chart library: Recharts `<AreaChart>`.
- X-axis: date. Y-axis: drawdown from peak (displayed as positive numbers, e.g., "5%" not "-5%").
- Fill: red gradient, darker for deeper drawdowns.
- Hover tooltip: `{ date, drawdown_dollars, drawdown_pct, days_since_peak, current_equity, peak_equity }`.
- Annotations at each trough: marker showing drawdown depth and recovery time (or "Ongoing").
- Table below chart listing all drawdown periods with columns: #, Start Date, Trough Date, Recovery Date, Depth ($), Depth (%), Duration (days), Recovery (days).

**3.10.7 Time Analysis Charts (AN-FR-021):**

- Three sub-views via tab strip: By Hour, By Day of Week, By Month.
- Dual axis: bar height = net P&L (left Y-axis), overlaid line = trade count or win rate (right Y-axis).
- Color: green bars for net positive, red for net negative.
- Month view toggle: "Calendar Year" (all Januaries combined) vs. "Chronological" (Jan 2025, Feb 2025, ...).

**3.10.8 Session Analysis (AN-FR-022):**

- Side-by-side metric table: RTH vs. Overnight with Trade Count, Win Rate, Net P&L, Average R, Profit Factor, Average Slippage.
- Below table: overlaid equity curves (RTH = blue `#3B82F6`, Overnight = orange `#F97316`).
- Insight callout auto-generated when one session outperforms (>5% win rate difference or >25% P&L difference).

**3.10.9 Execution Quality Dashboard (AN-FR-023):**

- Slippage distribution histogram.
- Slippage over time: rolling 20-trade window line chart. Red shading when trend is increasing (linear regression slope > 0 over last 40 trades).
- Fill Quality Score gauge: circular gauge 0-100 with color zones.
- Slippage by instrument table: sortable.
- Slippage by order type: market vs. limit comparison.

**3.10.10 Behavioral Metrics Dashboard (AN-FR-024):**

- Tiltmeter gauge: circular gauge with 4 color zones, current score as large centered number, zone label below.
- Rule compliance trend: line chart, rolling 20-trade windows.
- Cost of mistakes waterfall: horizontal bars sorted by absolute cost descending.
- Mistake frequency donut chart.
- Conviction vs. outcome scatter: X = conviction (1-5), Y = R-multiple. Pearson r displayed.
- Emotional state P&L: bar chart per emotional state.

**3.10.11 Trendline Analytics Dashboard (AN-FR-025):**

- Bar charts for win rate by touch count, edge by slope angle, performance by duration, performance by candle spacing.
- Side-by-side metric cards for Grade (A+ vs. A vs. B) and Setup Type (Break vs. Bounce).
- Statistical significance badges on each segment bar.

---

### 3.11 AN-FR-026 through AN-FR-032: Advanced Analytics (Pro Tier)

**Source:** PRD-006 Section 3.5

**3.11.1 Monte Carlo Simulation (AN-FR-026):**

**Processing Logic:**
1. Input: array of R-multiples from closed trades.
2. Minimum 30 trades required. Below 30: display "Minimum 30 closed trades required for Monte Carlo simulation. You have N trades." with locked state.
3. Configuration: N = number of simulations (default 1,000; options: 500, 1,000, 5,000, 10,000). Ruin threshold = configurable drawdown percentage (default 50%).
4. For each simulation: randomly resample (with replacement) the same number of trades as actual history. Build simulated equity curve from resampled R-multiples converted to dollar P&L using average initial risk.
5. Compute percentile curves: 5th, 25th, 50th (median), 75th, 95th of simulated final equities at each trade number.
6. Probability of ruin: `(simulations hitting ruin threshold / total simulations) * 100`.
7. Run server-side via FastAPI. Computation target: <5 seconds for 1,000 sims on 500 trades.
8. Cache results in Redis for 1 hour. Invalidate on new trade close.
9. Display: fan chart with actual equity curve overlaid. Summary statistics table.

**Error Handling:**
- Fewer than 30 trades: HTTP 400, message: "Minimum 30 closed trades required for Monte Carlo simulation."
- Computation timeout (>30 seconds): HTTP 504, message: "Simulation timed out. Try reducing the number of iterations."
- Free/Trader tier access: HTTP 403, message: "Monte Carlo simulation is available on the Pro plan. Upgrade to access advanced analytics."

**3.11.2 Strategy Correlation Matrix (AN-FR-027):**

- Pearson correlation of daily returns between each pair of playbooks.
- Heatmap: playbooks on both axes. Color: -1 = dark blue (`#1E40AF`), 0 = white, +1 = dark red (`#991B1B`).
- Minimum 20 overlapping trading days required per pair. Below: display "N/A" in cell.
- Insight callouts for correlation > 0.7 and < -0.3.

**3.11.3 Walk-Forward Analysis (AN-FR-028):**

- Rolling windows of configurable trade counts: 20, 30, 50, 100.
- Metrics: win rate, average R, profit factor, Sharpe ratio.
- Multi-line chart with red shading when metric drops below all-history average for 2+ consecutive windows.
- Decay alert: generated when profit factor declines by >20% over 3+ consecutive windows.

**3.11.4 Advanced Drawdown Analysis (AN-FR-029):**

- Drawdown clustering: Ljung-Box test on drawdown occurrence series.
- Time-to-recovery distribution histogram.
- Conditional drawdown by: day of week, instrument, playbook, emotional state.
- Duration vs. depth scatter plot.

**3.11.5 AI-Powered Insights (AN-FR-030):**

- Chat interface within analytics dashboard. Input: text field with "Ask about your trading..." placeholder.
- Translates natural language to SQL/analytical operations via Claude API (Anthropic).
- Rate limit: 20 queries/day (Pro), 50 queries/day (Team). Counter resets at midnight UTC.
- Query context sent to AI: trade schema, available fields, current filter state, aggregate statistics. NOT sent: email, name, broker credentials.
- Response: natural language text with optional inline data table and/or chart.
- Query history saved and searchable.
- Error handling: API timeout (>15 seconds) shows "AI service is taking longer than expected. Please try again."; API unavailable shows "AI insights temporarily unavailable. Please try again later."; Rate limit exceeded shows "You've used all 20 AI queries for today. Your limit resets at midnight UTC." with time remaining.
- First-use consent: on first AI query, display dialog: "AI-powered insights are processed by Anthropic's Claude AI. Your aggregated trading data (not personal information) is sent to generate answers. Continue?" Buttons: "Enable AI Insights" and "Cancel". Consent stored in `user_settings.ai_insights_consent`.

**3.11.6 Comparative Analytics (AN-FR-032):**

- Paper vs. Live: side-by-side equity curves (paper = dashed, live = solid). Two-sample t-test on mean R-multiples with significance reporting.
- Period vs. Period: user selects two custom date ranges. Overlaid normalized equity curves. Metrics with >10% change highlighted (green arrow up for improvement, red arrow down for degradation).
- Strategy A vs. B: user selects two playbooks. Side-by-side metrics + overlaid equity curves + correlation coefficient.
- Month-over-Month: automatic. Sparklines for last 6 months per metric. Percentage change indicators.

---

### 3.12 AN-FR-033 and AN-FR-034: Export System

**Source:** PRD-006 Section 3.6

**3.12.1 PDF Export (AN-FR-033):**

- Triggered by "Export PDF" button in dashboard header.
- User confirmation dialog: "Generate PDF report for [date range] with current filters applied?" Buttons: "Generate Report" and "Cancel".
- Progress indicator: determinate progress bar with stages: "Preparing data... (20%)", "Rendering charts... (50%)", "Generating PDF... (80%)", "Finalizing... (95%)".
- Server-side generation via WeasyPrint or Playwright PDF. Maximum 30 seconds.
- Report sections: Cover Page (logo, user name, date range, timestamp), Executive Summary (key metrics), Equity Curve, P&L Calendar, Performance Breakdown tables, Charts (R-histogram, MAE/MFE, drawdown, time analysis), Trendline Analytics (if applicable), Advanced Analytics (Pro, if applicable).
- File name: `TrendEdge_Performance_Report_2026-02-11_30d.pdf`.
- Download link available for 24 hours. Stored in Cloudflare R2 with signed URL.
- Tier limits: Trader = 2 PDF exports per billing cycle. Pro/Team = unlimited. Free = locked.
- Exceeding Trader limit: "You've used 2 of 2 PDF exports this month. Upgrade to Pro for unlimited exports. Your limit resets on [billing cycle date]."
- Error: generation timeout shows toast "PDF generation failed. Please try again or use CSV export as an alternative."

**3.12.2 CSV Export (AN-FR-034):**

- Three export types via dropdown: "Complete Trade List", "Daily P&L Summary", "Metric Summary".
- Encoding: UTF-8 with BOM for Excel compatibility.
- Maximum: 50,000 rows. If exceeded: "Export limited to 50,000 rows. Apply filters to reduce the dataset."
- Respects current filter selections.
- Instant download (client-side for small datasets <1,000 rows, server-side for larger).

---

### 3.13 AN-FR-035: WebSocket Real-Time Updates

**Source:** PRD-006 Section 3.7

- WebSocket endpoint: `wss://{api_domain}/ws/analytics`.
- Authentication: JWT token sent as query parameter on connection: `wss://{api_domain}/ws/analytics?token={jwt}`.
- On new trade close: server recalculates affected metrics, publishes update payload to user's channel.
- Update payload:

```json
{
  "type": "trade_closed",
  "trade_id": "uuid",
  "timestamp": "2026-02-11T14:30:00Z",
  "updates": {
    "net_pnl": 15420.50,
    "win_rate": 63.2,
    "total_trades": 156,
    "profit_factor": 1.87,
    "equity_curve_point": { "date": "2026-02-11", "cumulative_pnl": 15420.50 },
    "tiltmeter": 22
  }
}
```

- Frontend animations: number fields use count-up animation (400ms). Equity curve extends with smooth line animation (300ms ease-out).
- "Last Updated" timestamp in dashboard header, e.g., "Last updated: 2:30 PM ET".
- Reconnection on disconnect: banner "Connection lost — reconnecting..." (yellow background). Exponential backoff: 1s, 2s, 4s, 8s, 16s, max 30s between attempts. On reconnection: fetch full state via REST API to ensure consistency, then dismiss banner.
- Heartbeat: server sends `{ "type": "ping" }` every 30 seconds. Client responds with `{ "type": "pong" }`. If no ping received for 60 seconds, client initiates reconnection.

---

### 3.14 AN-FR-036 through AN-FR-039: Tier Restrictions

**Source:** PRD-006 Section 3.8

**Feature Access Matrix:**

| Feature | Free | Trader ($49/mo) | Pro ($99/mo) | Team ($199/mo) |
|---|---|---|---|---|
| Basic 5 metrics (Net P&L, Win Rate, Total Trades, Avg Winner, Avg Loser) | Yes | Yes | Yes | Yes |
| Basic equity curve (no annotations/zoom) | Yes | Yes | Yes | Yes |
| Full 25+ metrics | Locked | Yes | Yes | Yes |
| All chart visualizations | Locked | Yes | Yes | Yes |
| Date/instrument/playbook filters | Locked | Yes | Yes | Yes |
| Calendar heatmap with drill-down | Locked | Yes | Yes | Yes |
| Dashboard customization | Locked | Yes (5 presets) | Yes (unlimited) | Yes (unlimited + shared) |
| CSV export | Locked | Yes | Yes | Yes |
| PDF export | Locked | 2/month | Unlimited | Unlimited |
| Monte Carlo simulation | Locked | Locked | Yes | Yes |
| Strategy correlation | Locked | Locked | Yes | Yes |
| Walk-forward analysis | Locked | Locked | Yes | Yes |
| Advanced drawdown | Locked | Locked | Yes | Yes |
| AI insights | Locked | Locked | 20/day | 50/day |
| Comparative analytics | Locked | Locked | Yes | Yes |
| Enhanced calendar | Locked | Locked | Yes | Yes |
| Team dashboard | Locked | Locked | Locked | Yes |
| Team leaderboard | Locked | Locked | Locked | Yes |
| Team exports | Locked | Locked | Locked | Yes |

**Enforcement behavior:**

- Frontend: locked widgets show blurred preview (CSS `filter: blur(8px)`) with overlay containing lock icon and "Upgrade to [required tier] to unlock [feature name]" CTA button.
- Backend: API endpoints check `user.subscription_tier` before processing. Insufficient tier returns HTTP 403 with body: `{ "error": "forbidden", "message": "This feature requires the [tier] plan.", "required_tier": "[tier]", "upgrade_url": "/settings/billing" }`.
- PDF export counter: stored in `user_usage.pdf_exports_this_cycle`. Incremented on successful PDF generation. Reset on billing cycle date. Checked before generation starts.
- AI query counter: stored in Redis key `ai_queries:{user_id}:{date}` with TTL of 24 hours. Incremented on successful query. Checked before query execution.
- Tier upgrade: when a user upgrades mid-session, a WebSocket event `{ "type": "tier_changed", "new_tier": "pro" }` triggers the frontend to unlock all newly available features without page reload.
- Tier downgrade: features lock immediately. Cached data from higher-tier features becomes inaccessible. No data deletion; features re-unlock if user re-upgrades.

---

## 4. Data Specifications

### 4.1 Database Tables (Analytics-Specific)

**4.1.1 Materialized View: `mv_daily_pnl`**

| Column | Type | Nullable | Description |
|---|---|---|---|
| user_id | UUID | NOT NULL | FK to `users.id`. RLS policy: `auth.uid() = user_id` |
| trade_date | DATE | NOT NULL | Date of trade exit (exchange timezone) |
| net_pnl | DECIMAL(12,2) | NOT NULL | Net P&L for the day |
| trade_count | INTEGER | NOT NULL | Number of trades closed that day |
| winning_trades | INTEGER | NOT NULL | Count of trades with realized_pnl > 0 |
| losing_trades | INTEGER | NOT NULL | Count of trades with realized_pnl <= 0 |
| gross_profit | DECIMAL(12,2) | NOT NULL | Sum of positive realized_pnl |
| gross_loss | DECIMAL(12,2) | NOT NULL | Sum of negative realized_pnl (stored as negative) |
| total_r | DECIMAL(8,2) | NULL | Sum of R-multiples (null if no trades have R) |
| avg_slippage_ticks | DECIMAL(6,2) | NULL | Average slippage in ticks |

Primary key: `(user_id, trade_date)`.
Refresh: incremental update on trade close (upsert for the trade's exit date), full nightly refresh at 00:00 UTC.

**4.1.2 Materialized View: `mv_metrics_cache`**

| Column | Type | Nullable | Description |
|---|---|---|---|
| user_id | UUID | NOT NULL | FK to `users.id` |
| filter_hash | VARCHAR(64) | NOT NULL | SHA-256 hash of `{start_date}:{end_date}:{sorted_instruments}:{sorted_playbooks}` |
| metrics_json | JSONB | NOT NULL | Complete computed metrics as JSON |
| computed_at | TIMESTAMPTZ | NOT NULL | Computation timestamp |
| trade_count | INTEGER | NOT NULL | Trades included in computation |

Primary key: `(user_id, filter_hash)`.
Cache invalidation: on new trade close (delete all entries for user), on data correction.
TTL: 5 minutes (enforced by checking `computed_at` before serving cached results).

**4.1.3 Table: `dashboard_layouts`**

| Column | Type | Nullable | Description |
|---|---|---|---|
| id | UUID | NOT NULL | PK, generated |
| user_id | UUID | NOT NULL | FK to `users.id` |
| name | VARCHAR(50) | NOT NULL | Preset name |
| layout_json | JSONB | NOT NULL | Widget positions and visibility |
| is_active | BOOLEAN | NOT NULL DEFAULT false | Currently active preset |
| created_at | TIMESTAMPTZ | NOT NULL | Creation timestamp |
| updated_at | TIMESTAMPTZ | NOT NULL | Last update timestamp |

Unique constraint: `(user_id, name)`.
RLS: `auth.uid() = user_id`.

**4.1.4 Table: `ai_query_history`**

| Column | Type | Nullable | Description |
|---|---|---|---|
| id | UUID | NOT NULL | PK, generated |
| user_id | UUID | NOT NULL | FK to `users.id` |
| query_text | TEXT | NOT NULL | User's natural language query |
| response_text | TEXT | NOT NULL | AI-generated response |
| response_data | JSONB | NULL | Structured data in response (tables, chart data) |
| filters_applied | JSONB | NOT NULL | Filter state at time of query |
| tokens_used | INTEGER | NOT NULL | Claude API tokens consumed |
| response_time_ms | INTEGER | NOT NULL | Response latency |
| created_at | TIMESTAMPTZ | NOT NULL | Query timestamp |

RLS: `auth.uid() = user_id`.
Retention: 90 days, then archived.

**4.1.5 Table: `export_files`**

| Column | Type | Nullable | Description |
|---|---|---|---|
| id | UUID | NOT NULL | PK, generated |
| user_id | UUID | NOT NULL | FK to `users.id` |
| file_type | VARCHAR(4) | NOT NULL | `'pdf'` or `'csv'` |
| file_name | VARCHAR(255) | NOT NULL | Generated file name |
| storage_url | TEXT | NOT NULL | Cloudflare R2 signed URL |
| filters_applied | JSONB | NOT NULL | Filter state used for export |
| file_size_bytes | INTEGER | NOT NULL | File size |
| expires_at | TIMESTAMPTZ | NOT NULL | 24 hours after creation |
| created_at | TIMESTAMPTZ | NOT NULL | Generation timestamp |

RLS: `auth.uid() = user_id`.
Cleanup: scheduled job deletes expired files from R2 and removes DB rows.

### 4.2 Database Indexes

```sql
-- Core trade queries
CREATE INDEX idx_trades_user_exit ON trades(user_id, exit_timestamp);
CREATE INDEX idx_trades_user_instrument ON trades(user_id, instrument);
CREATE INDEX idx_trades_user_playbook ON trades(user_id, playbook_id);
CREATE INDEX idx_trades_user_exit_instrument ON trades(user_id, exit_timestamp, instrument);
CREATE INDEX idx_trades_user_exit_playbook ON trades(user_id, exit_timestamp, playbook_id);
CREATE INDEX idx_trades_user_exit_instrument_playbook ON trades(user_id, exit_timestamp, instrument, playbook_id);

-- Journal entries
CREATE INDEX idx_journal_entries_trade ON journal_entries(trade_id);

-- Materialized views
CREATE INDEX idx_mv_daily_pnl_user_date ON mv_daily_pnl(user_id, trade_date);
CREATE INDEX idx_mv_metrics_cache_user_hash ON mv_metrics_cache(user_id, filter_hash);

-- Dashboard layouts
CREATE INDEX idx_dashboard_layouts_user ON dashboard_layouts(user_id);

-- AI query history
CREATE INDEX idx_ai_query_history_user_date ON ai_query_history(user_id, created_at);

-- Export files
CREATE INDEX idx_export_files_user ON export_files(user_id);
CREATE INDEX idx_export_files_expires ON export_files(expires_at);
```

### 4.3 Redis Cache Schema

| Key Pattern | Value | TTL | Purpose |
|---|---|---|---|
| `metrics:{user_id}:{filter_hash}` | JSON metrics blob | 5 minutes | Computed metrics cache |
| `equity_curve:{user_id}:{filter_hash}` | JSON array of data points | 5 minutes | Equity curve data |
| `ai_queries:{user_id}:{YYYY-MM-DD}` | Integer counter | 24 hours | Daily AI query rate limit |
| `pdf_exports:{user_id}:{billing_cycle_id}` | Integer counter | Until cycle end | Monthly PDF export limit |
| `ws:channel:{user_id}` | WebSocket channel metadata | Session duration | WebSocket pub/sub |
| `monte_carlo:{user_id}:{trade_count_hash}` | JSON simulation results | 1 hour | Monte Carlo cache |

---

## 5. API Specifications

### 5.1 Endpoint Reference

All endpoints require JWT authentication via `Authorization: Bearer {token}` header. All endpoints return JSON. All endpoints accept query parameters for filtering: `start_date` (YYYY-MM-DD), `end_date` (YYYY-MM-DD), `instruments` (comma-separated), `playbooks` (comma-separated UUIDs or "untagged").

**5.1.1 GET /api/v1/analytics/summary**

- **Tier:** Free+ (Free tier receives 5 basic metrics only)
- **Description:** Returns core metrics summary.
- **Rate Limit:** 60 requests/minute
- **Query Parameters:** `start_date`, `end_date`, `instruments`, `playbooks`
- **Response 200:**

```json
{
  "data": {
    "total_trades": 156,
    "win_rate": 62.5,
    "average_winner": 342.50,
    "average_loser": -215.75,
    "profit_factor": 1.87,
    "expectancy": 47.25,
    "largest_win": 2850.00,
    "largest_loss": -1425.00,
    "total_net_pnl": 15420.50,
    "average_trade_duration_seconds": 9300,
    "average_trade_duration_display": "2h 35m",
    "winning_trades": 97,
    "losing_trades": 59,
    "breakeven_trades": 3,
    "sharpe_ratio": 1.45,
    "sortino_ratio": 2.12,
    "calmar_ratio": 3.85,
    "max_drawdown_dollars": -2400.00,
    "max_drawdown_pct": -8.3,
    "average_r": 0.85,
    "median_r": 0.42,
    "tiltmeter_score": 34,
    "tiltmeter_zone": "caution",
    "rule_compliance_rate": 78.5,
    "fill_quality_score": 82
  },
  "filter_applied": { "start_date": "2026-01-12", "end_date": "2026-02-11", "instruments": ["CL", "GC"], "playbooks": ["all"] },
  "total_trades_unfiltered": 256,
  "computed_at": "2026-02-11T14:30:05Z",
  "cached": true
}
```

- **Response 200 (Free tier):** Same structure but only `total_trades`, `win_rate`, `total_net_pnl`, `average_winner`, `average_loser` populated. All other fields: `null` with `"restricted": true`.
- **Response 400:** `{ "error": "bad_request", "message": "Invalid date range: start date must be before end date." }`
- **Response 401:** `{ "error": "unauthorized", "message": "Authentication required." }`
- **Response 429:** `{ "error": "rate_limited", "message": "Too many requests. Please try again later.", "retry_after": 30 }`
- **Response 503:** `{ "error": "service_unavailable", "message": "Analytics service temporarily unavailable." }`

**5.1.2 GET /api/v1/analytics/equity-curve**

- **Tier:** Free+ (basic curve; Pro+ for comparative overlays)
- **Rate Limit:** 30 requests/minute
- **Response 200:**

```json
{
  "data": [
    { "date": "2025-11-15", "cumulative_pnl": 320.00, "daily_pnl": 320.00, "trade_count": 2 },
    { "date": "2025-11-16", "cumulative_pnl": 185.00, "daily_pnl": -135.00, "trade_count": 1 }
  ],
  "annotations": {
    "max_drawdown_start": { "date": "2026-01-05", "equity": 12500.00 },
    "max_drawdown_trough": { "date": "2026-01-12", "equity": 10100.00 },
    "best_day": { "date": "2026-01-28", "daily_pnl": 1850.00 }
  }
}
```

**5.1.3 GET /api/v1/analytics/calendar**

- **Tier:** Trader+
- **Response 200:** Array of `{ date, net_pnl, trade_count, win_rate }` objects. Monthly summary array.

**5.1.4 GET /api/v1/analytics/calendar/{date}**

- **Tier:** Trader+
- **Path Parameter:** `date` in YYYY-MM-DD format.
- **Response 200:** Array of trade objects for that date: `{ trade_id, instrument, direction, playbook_name, realized_pnl, r_multiple, journal_entry_id }`.
- **Response 404:** `{ "error": "not_found", "message": "No trades found for 2026-02-11." }`

**5.1.5 GET /api/v1/analytics/r-distribution**

- **Tier:** Trader+
- **Query Parameter:** `bin_width` (0.25, 0.5, or 1.0; default 0.5)
- **Response 200:** Array of `{ r_range_start, r_range_end, trade_count, pct_of_total }` + summary stats.

**5.1.6 GET /api/v1/analytics/win-rate/{dimension}**

- **Tier:** Trader+
- **Path Parameter:** `dimension` = `instrument` | `day_of_week` | `hour` | `playbook` | `month` | `setup_type`
- **Response 200:** Array of `{ segment, win_rate, avg_r, net_pnl, trade_count }`.

**5.1.7 GET /api/v1/analytics/mae-mfe**

- **Tier:** Trader+
- **Response 200:** MAE/MFE data array + insights object.

**5.1.8 GET /api/v1/analytics/drawdown**

- **Tier:** Trader+
- **Response 200:** Drawdown chart data series + drawdown periods table.

**5.1.9 GET /api/v1/analytics/time-analysis**

- **Tier:** Trader+
- **Response 200:** by_hour, by_day_of_week, by_month_aggregate, by_month_chronological arrays.

**5.1.10 GET /api/v1/analytics/session**

- **Tier:** Trader+
- **Response 200:** RTH and overnight metric objects + session insight string.

**5.1.11 GET /api/v1/analytics/execution-quality**

- **Tier:** Trader+
- **Response 200:** Slippage metrics, fill quality, slippage distribution, slippage by instrument/broker/order type.

**5.1.12 GET /api/v1/analytics/behavioral**

- **Tier:** Trader+
- **Response 200:** Rule compliance, tiltmeter, mistake breakdown, conviction correlation, emotional state P&L.

**5.1.13 GET /api/v1/analytics/trendline**

- **Tier:** Trader+
- **Response 200:** Segmented trendline analytics by all dimensions.

**5.1.14 POST /api/v1/analytics/monte-carlo**

- **Tier:** Pro+
- **Rate Limit:** 5 requests/hour
- **Request Body:**

```json
{
  "num_simulations": 1000,
  "ruin_threshold_pct": 50
}
```

- **Response 200:** Percentile curves + summary statistics + probability of ruin.
- **Response 400:** `{ "error": "bad_request", "message": "Minimum 30 closed trades required for Monte Carlo simulation. You have 18 trades." }`
- **Response 403:** `{ "error": "forbidden", "message": "Monte Carlo simulation requires the Pro plan.", "required_tier": "pro", "upgrade_url": "/settings/billing" }`

**5.1.15 GET /api/v1/analytics/correlation-matrix**

- **Tier:** Pro+
- **Response 200:** Correlation matrix data + insight callouts.

**5.1.16 GET /api/v1/analytics/walk-forward**

- **Tier:** Pro+
- **Query Parameter:** `window_size` (20, 30, 50, 100; default 30), `playbook_id` (optional, for per-playbook analysis)
- **Response 200:** Rolling metric series + decay alerts.

**5.1.17 POST /api/v1/analytics/compare**

- **Tier:** Pro+
- **Request Body:**

```json
{
  "comparison_type": "paper_vs_live" | "period_vs_period" | "strategy_vs_strategy",
  "params": {
    "period_a": { "start": "2025-11-01", "end": "2025-12-31" },
    "period_b": { "start": "2026-01-01", "end": "2026-02-11" }
  }
}
```

- **Response 200:** Side-by-side metrics + equity curve data + statistical tests.

**5.1.18 POST /api/v1/analytics/ai-query**

- **Tier:** Pro+
- **Rate Limit:** 20/day (Pro), 50/day (Team)
- **Request Body:**

```json
{
  "query": "What is my best setup on Tuesdays in crude oil?",
  "filters": { "start_date": "2025-11-01", "end_date": "2026-02-11" }
}
```

- **Response 200:**

```json
{
  "answer": "Your best-performing Tuesday setup in CL is A+ Trendline Break with a 75% win rate and 2.1R average across 12 trades.",
  "data_table": [...],
  "queries_remaining_today": 18,
  "query_id": "uuid"
}
```

- **Response 429:** `{ "error": "rate_limited", "message": "You've used all 20 AI queries for today. Your limit resets at midnight UTC.", "resets_at": "2026-02-12T00:00:00Z" }`

**5.1.19 POST /api/v1/analytics/export/pdf**

- **Tier:** Trader+
- **Rate Limit:** 5/hour
- **Response 202:**

```json
{
  "export_id": "uuid",
  "status": "processing",
  "estimated_seconds": 15
}
```

- **Response 200 (polling GET /api/v1/analytics/export/{export_id}):**

```json
{
  "export_id": "uuid",
  "status": "completed",
  "download_url": "https://r2.trendedge.com/exports/uuid.pdf?token=signed",
  "expires_at": "2026-02-12T14:30:00Z",
  "file_size_bytes": 2450000
}
```

- **Response 429:** `{ "error": "rate_limited", "message": "You've used 2 of 2 PDF exports this month. Upgrade to Pro for unlimited exports.", "resets_at": "2026-03-01T00:00:00Z" }`

**5.1.20 GET /api/v1/analytics/export/csv**

- **Tier:** Trader+
- **Query Parameter:** `type` = `trades` | `daily_summary` | `metrics`
- **Response 200:** CSV file download (Content-Type: text/csv; charset=utf-8).
- **Response 400:** `{ "error": "bad_request", "message": "Export limited to 50,000 rows. Apply filters to reduce the dataset." }`

**5.1.21 GET /api/v1/analytics/team/summary**

- **Tier:** Team
- **Response 200:** Aggregated team metrics.
- **Response 403:** `{ "error": "forbidden", "message": "Team analytics requires the Team plan." }`

**5.1.22 GET /api/v1/analytics/team/leaderboard**

- **Tier:** Team
- **Query Parameter:** `metric` = `net_pnl` | `win_rate` | `sharpe_ratio` | `avg_r` (default: `net_pnl`)
- **Response 200:** Ranked array of `{ member_id, display_name, metric_value, rank }`.

**5.1.23 GET /api/v1/analytics/team/member/{member_id}**

- **Tier:** Team (with permission check)
- **Response 200:** Full analytics summary for the specified team member.
- **Response 403:** `{ "error": "forbidden", "message": "You do not have permission to view this team member's analytics." }`

**5.1.24 WebSocket: wss://{api_domain}/ws/analytics**

- **Authentication:** JWT in query parameter.
- **Messages received by client:** `trade_closed`, `tier_changed`, `ping`.
- **Messages sent by client:** `pong`.
- See Section 3.13 for full WebSocket specification.

---

## 6. UI/UX Specifications

### 6.1 Page Route

- URL: `/dashboard/analytics`
- Page title: "Performance Analytics | TrendEdge"
- Breadcrumb: Dashboard > Analytics

### 6.2 Visual Design

- Follow shadcn/ui design system with TrendEdge color palette.
- Font: Inter for body text, JetBrains Mono for metric values and numbers.
- Metric card design: white background, 1px border (`border-gray-200`), rounded corners (`rounded-lg`), subtle shadow (`shadow-sm`). Metric label in gray-500, value in gray-900, large bold font. Delta indicator (if applicable): green up arrow for positive change, red down arrow for negative.
- Chart backgrounds: white. Grid lines: gray-100. Axis labels: gray-500 text-xs.
- Dark mode: supported. All colors have dark mode variants. Charts use dark backgrounds (`gray-900`) with lighter grid lines (`gray-700`).

### 6.3 Loading Behavior

- Page-level loading: show filter bar skeleton + 6 summary card skeletons + equity curve skeleton on initial load.
- Widget-level loading: individual skeleton per widget on filter changes. Already-loaded widgets remain visible until new data arrives, then transition with a 200ms fade.
- Above-the-fold widgets (summary cards + equity curve) loaded first via priority fetch. Below-the-fold widgets lazy-loaded as user scrolls (IntersectionObserver with 200px root margin).

### 6.4 Empty States

| Context | Message | Visual |
|---|---|---|
| No trades at all | "Complete your first trade to see your analytics. Your performance dashboard will populate automatically as you close trades." | Illustration of empty chart with sparkle icon |
| No trades match filters | "No trades match the selected filters. Try adjusting the date range or removing instrument filters." | Filter icon with X mark |
| No journal data | "No journal data available. Complete journal entries for your trades to enable behavioral analytics." | Journal icon with plus sign |
| No trendline data | "No trendline data available. Trades must be auto-classified from the trendline engine to enable this analysis." | Trendline icon with question mark |
| Insufficient data for metric | "[Metric name] requires at least [N] [data points]. You currently have [M]." | Information icon |

### 6.5 Error States

| Context | Message | Action |
|---|---|---|
| API error (500) | "Something went wrong loading your analytics. Our team has been notified." | "Try Again" button |
| Network error | "Unable to connect to the analytics service. Check your internet connection." | "Retry" button |
| Timeout | "Loading is taking longer than expected. This may be due to a large dataset." | "Retry" button + "Try narrower filters" suggestion |
| WebSocket disconnect | "Connection lost — reconnecting..." | Auto-reconnect with countdown |

### 6.6 Accessibility

- All charts have a "View as Table" toggle button that renders the same data in an accessible `<table>` element with proper `<th>`, `<td>`, and `<caption>` elements.
- Color is never the sole means of conveying information. Chart bars use patterns (hatched for low-confidence), icons supplement color in metric cards (up/down arrows alongside green/red).
- WCAG 2.1 AA contrast ratios: 4.5:1 minimum for body text, 3:1 for large text and UI components.
- All interactive elements keyboard navigable. Focus ring visible on tab navigation.
- Screen reader: metric cards announce "Total Net P&L: fifteen thousand four hundred twenty dollars and fifty cents, up three hundred twenty dollars from previous period."
- Skip navigation link: "Skip to analytics content" link at page top for screen reader users.

---

## 7. Integration Specifications

### 7.1 Trade Execution Pipeline Integration

[Cross-reference: see FSD-003 for trade execution details]

| Integration Point | Method | Data Flow | Error Handling |
|---|---|---|---|
| Closed trade event | PostgreSQL trigger / application event | Trade record written to `trades` table -> trigger fires -> analytics materialized views refreshed -> WebSocket event published | If MV refresh fails: log error, stale data served until next refresh cycle. WebSocket event still published with available data. |
| MAE/MFE tick data | Read from `trade_price_history` table | Queried on demand for MAE/MFE scatter plot | If tick data unavailable: estimate from bar data, flag as "estimated" |
| Signal price | Read from `trades.signal_price` | Used for slippage calculation | If null: exclude trade from slippage metrics |
| Trendline metadata | Read from `trades.trendline_*` columns | Used for trendline analytics | If null: exclude from trendline analytics, increment excluded count |

### 7.2 Trade Journaling Integration

[Cross-reference: see FSD-004 for trade journaling details]

| Integration Point | Method | Data Flow | Error Handling |
|---|---|---|---|
| Journal entry data | JOIN `journal_entries` ON `trade_id` | Conviction, emotional state, mistakes, rule compliance read per trade | If journal_entries table inaccessible: behavioral metrics section shows "Journal data temporarily unavailable" error state |
| Journal entry link | Frontend navigation | Calendar drill-down trade list links to `/dashboard/journal/{trade_id}` | If journal entry not found: link disabled with tooltip "No journal entry for this trade" |

### 7.3 Playbook System Integration

[Cross-reference: see FSD-005 for playbook system details]

| Integration Point | Method | Data Flow | Error Handling |
|---|---|---|---|
| Playbook assignments | Read `trades.playbook_id` + JOIN `playbooks` table | Playbook name, ID used for filtering and per-playbook analytics | If playbooks table inaccessible: playbook filter shows "Unable to load playbooks" error; trades display playbook_id instead of name |
| Auto-classification | Read from trade record (populated by execution pipeline) | Trades auto-tagged with playbook_id based on trendline criteria | If auto-classification fails upstream: trade appears as "Untagged" |

### 7.4 Claude AI Integration (for AI-Powered Insights)

| Aspect | Specification |
|---|---|
| Provider | Anthropic Claude API |
| Model | claude-sonnet-4-20250514 (or latest available) |
| Purpose | Natural language query processing for AN-FR-030 |
| API Key | Environment variable: `ANTHROPIC_API_KEY` |
| Endpoint | `https://api.anthropic.com/v1/messages` |
| System prompt | Includes: trade data schema, available fields, current filter context, user's aggregate statistics, instruction to answer only from provided data |
| Data sent | Aggregate statistics, schema description, specific query-relevant data subsets. NEVER: email, name, password, broker credentials, API keys |
| Max tokens | Request: 2,000 tokens. Response: 4,000 tokens. |
| Timeout | 15 seconds. On timeout: "AI service is taking longer than expected. Please try again." |
| Rate limit (Anthropic side) | Handled with exponential backoff: 1s, 2s, 4s. Max 3 retries. |
| Fallback | If Claude API unavailable: disable AI insights feature, show "AI insights temporarily unavailable. Please try again later." |
| Cost tracking | Log tokens_used per query in `ai_query_history` for billing monitoring |

### 7.5 Cloudflare R2 Integration (Export Storage)

| Aspect | Specification |
|---|---|
| Provider | Cloudflare R2 |
| Bucket | `trendedge-exports` |
| Key pattern | `exports/{user_id}/{export_id}.{pdf|csv}` |
| Access | Signed URLs with 24-hour expiry |
| Cleanup | Scheduled job runs hourly, deletes objects past `expires_at` |
| Fallback | If R2 unavailable: store in Railway local filesystem with 1-hour retention, warn user "Export available for limited time" |

### 7.6 Redis (Upstash) Integration

| Aspect | Specification |
|---|---|
| Provider | Upstash Redis |
| Connection | TLS-encrypted, connection string in `REDIS_URL` env var |
| Usage | Metrics caching (5-min TTL), rate limit counters, WebSocket pub/sub, Monte Carlo result caching (1-hr TTL) |
| Fallback | If Redis unavailable: skip cache (compute on every request with degraded performance), use in-memory rate limit counters (single-instance only), WebSocket updates still function via direct computation |
| Max memory policy | `allkeys-lru` (evict least recently used keys when memory limit reached) |

---

## 8. Security Specifications

### 8.1 Data Isolation

#### 8.1.1 Row-Level Security (RLS)

All analytics queries MUST enforce PostgreSQL Row-Level Security policies. RLS is applied at the database level, not solely at the application level.

**RLS Policies:**

```sql
-- trades table
ALTER TABLE trades ENABLE ROW LEVEL SECURITY;
CREATE POLICY trades_user_isolation ON trades
  FOR ALL
  USING (auth.uid() = user_id);

-- mv_daily_pnl materialized view
ALTER TABLE mv_daily_pnl ENABLE ROW LEVEL SECURITY;
CREATE POLICY mv_daily_pnl_user_isolation ON mv_daily_pnl
  FOR SELECT
  USING (auth.uid() = user_id);

-- mv_metrics_cache
ALTER TABLE mv_metrics_cache ENABLE ROW LEVEL SECURITY;
CREATE POLICY mv_metrics_cache_user_isolation ON mv_metrics_cache
  FOR ALL
  USING (auth.uid() = user_id);

-- dashboard_layouts
ALTER TABLE dashboard_layouts ENABLE ROW LEVEL SECURITY;
CREATE POLICY dashboard_layouts_user_isolation ON dashboard_layouts
  FOR ALL
  USING (auth.uid() = user_id);

-- ai_query_history
ALTER TABLE ai_query_history ENABLE ROW LEVEL SECURITY;
CREATE POLICY ai_query_history_user_isolation ON ai_query_history
  FOR ALL
  USING (auth.uid() = user_id);

-- export_files
ALTER TABLE export_files ENABLE ROW LEVEL SECURITY;
CREATE POLICY export_files_user_isolation ON export_files
  FOR ALL
  USING (auth.uid() = user_id);
```

**Team Tier RLS Extension:**

```sql
-- Team members can view other members' trades when permission is granted
CREATE POLICY trades_team_read ON trades
  FOR SELECT
  USING (
    auth.uid() = user_id
    OR (
      EXISTS (
        SELECT 1 FROM team_memberships tm1
        JOIN team_memberships tm2 ON tm1.team_id = tm2.team_id
        WHERE tm1.user_id = auth.uid()
        AND tm2.user_id = trades.user_id
        AND tm1.team_id IN (
          SELECT team_id FROM team_permissions
          WHERE permission_type = 'view_analytics'
          AND granted = true
        )
      )
    )
  );
```

#### 8.1.2 Application-Level Enforcement

Even with RLS, the application layer MUST:

- Validate that the `user_id` in every query matches the authenticated user's ID from the JWT token.
- For team endpoints: verify team membership AND permission level before executing the query.
- Never accept `user_id` as a request parameter from the client. Always derive from the authenticated session.
- Log and alert on any RLS policy violation attempts (query returns fewer rows than expected after manual user_id check).

### 8.2 Authentication

#### 8.2.1 API Authentication

- All analytics API endpoints require a valid JWT token in the `Authorization: Bearer {token}` header.
- JWT validation: verify signature (RS256), check `exp` (expiry), check `aud` (audience = TrendEdge API), check `iss` (issuer = Supabase Auth or Clerk).
- Expired token: return HTTP 401 with `{ "error": "unauthorized", "message": "Authentication token has expired. Please log in again." }`.
- Missing token: return HTTP 401 with `{ "error": "unauthorized", "message": "Authentication required." }`.
- Invalid token (bad signature): return HTTP 401 with `{ "error": "unauthorized", "message": "Invalid authentication token." }`. Log the attempt with IP address.

#### 8.2.2 WebSocket Authentication

- JWT token passed as query parameter on connection: `wss://api.trendedge.com/ws/analytics?token={jwt}`.
- Server validates token before accepting the WebSocket upgrade. Invalid/expired token: reject connection with WebSocket close code 4401 and reason "Authentication failed".
- Token refresh during active session: client sends `{ "type": "token_refresh", "token": "{new_jwt}" }`. Server validates and updates the session token. If invalid: close connection with code 4401.
- If token expires during an active WebSocket session and no refresh is received within 60 seconds: server closes connection with code 4401 and reason "Token expired".

### 8.3 Export Security

- PDF and CSV exports contain ONLY data belonging to the authenticated user (enforced by RLS).
- Export download URLs are signed with a time-limited token (24-hour expiry). Format: `https://r2.trendedge.com/exports/{uuid}.pdf?token={hmac_signature}&expires={unix_timestamp}`.
- Signature computation: `HMAC-SHA256(secret_key, "{export_id}:{user_id}:{expires_timestamp}")`.
- Export URLs use UUID-based keys, not sequential IDs. An attacker cannot enumerate export files.
- Expired download URL: return HTTP 403 with `{ "error": "expired", "message": "This download link has expired. Generate a new export from your dashboard." }`.
- Invalid signature: return HTTP 403 with `{ "error": "forbidden", "message": "Invalid download link." }`. Log with IP address.
- Scheduled cleanup: cron job runs every hour, deletes files from R2 where `expires_at < NOW()`, removes corresponding `export_files` DB rows.
- Team tier: a team member cannot export another member's data unless the team admin has explicitly granted `export_data` permission. Attempting to export without permission: HTTP 403 with `{ "error": "forbidden", "message": "You do not have permission to export this team member's data." }`.

### 8.4 Data Protection

#### 8.4.1 Data in Transit

- All API communication uses HTTPS (TLS 1.2+). HTTP requests are redirected to HTTPS with 301.
- WebSocket connections use WSS (WebSocket Secure). Plain WS connections are rejected.
- No trade data is transmitted in URL query parameters. Filter parameters (date ranges, instrument codes) are acceptable in URLs. Actual P&L values, trade details, and metric results are transmitted in response bodies only.
- CORS: allow only `https://app.trendedge.com` and `https://trendedge.com` origins. Reject requests from unauthorized origins with no CORS headers.

#### 8.4.2 Data at Rest

- PostgreSQL data encrypted at rest via Supabase default (AES-256).
- Export files in Cloudflare R2 stored with server-side encryption (SSE-S3).
- Redis cache entries do NOT contain full trade details. Cache keys are user-scoped: `metrics:{user_id}:{filter_hash}`. Cache values contain aggregate metrics only, not individual trade records.
- Backups: PostgreSQL backups encrypted. No trade data in application logs (log trade_id only, not P&L or prices).

### 8.5 AI Query Security

- Data sent to Claude API: trade schema, aggregate statistics, filtered subsets relevant to the query. Maximum 500 individual trade records per query (aggregated if more).
- Data NEVER sent to Claude API: user email, real name, broker credentials, API keys, account numbers, team member identities.
- First-use consent required: dialog shown before first AI query. Consent stored in `user_settings.ai_insights_consent` as `{ consented: true, consented_at: timestamp }`. Queries rejected without consent: HTTP 403 with `{ "error": "consent_required", "message": "Please enable AI insights in your settings before using this feature." }`.
- AI query logs retained for 90 days in `ai_query_history` table, then archived to cold storage. After 1 year, permanently deleted.
- Anthropic data retention: per Anthropic's API terms, data sent via the API is not used for model training.

### 8.6 Rate Limiting

| Endpoint Category | Limit | Window | Response |
|---|---|---|---|
| Metrics endpoints | 60 requests | Per minute | HTTP 429 with `Retry-After: {seconds}` header |
| Chart data endpoints | 30 requests | Per minute | HTTP 429 with `Retry-After: {seconds}` header |
| Export endpoints | 5 requests | Per hour | HTTP 429 with `Retry-After: {seconds}` header |
| Monte Carlo | 5 requests | Per hour | HTTP 429 with `Retry-After: {seconds}` header |
| AI query (Pro) | 20 requests | Per day (UTC) | HTTP 429 with `resets_at` timestamp |
| AI query (Team) | 50 requests | Per day (UTC) | HTTP 429 with `resets_at` timestamp |
| WebSocket connections | 3 concurrent | Per user | Connection rejected with code 4429 "Too many connections" |

Rate limits enforced via Redis counters. Key pattern: `ratelimit:{endpoint_category}:{user_id}:{window_id}`.

---

## 9. Performance Specifications

### 9.1 Dashboard Load Performance

| Scenario | Dataset Size | Target Load Time | Cache State |
|---|---|---|---|
| Small account | 50 trades | < 1 second | Cold or warm |
| Medium account | 500 trades | < 2 seconds | Cold or warm |
| Standard account (target user) | 2,000 trades | < 3 seconds | Cold cache |
| Standard account (cached) | 2,000 trades | < 1 second | Warm cache |
| Large account | 10,000 trades | < 5 seconds | Cold cache |
| Large account (cached) | 10,000 trades | < 2 seconds | Warm cache |
| Very large account | 50,000 trades | < 8 seconds | Cold cache |

Load time measured from: navigation start to Largest Contentful Paint (summary cards + equity curve rendered with data).

**Optimization Strategy:**

1. **Materialized Views:** Pre-compute `mv_daily_pnl` for daily aggregations. Avoids scanning full trades table on every request.
2. **Redis Caching:** Cache computed metric results with 5-minute TTL. Cache key includes filter hash for per-filter-combination caching.
3. **Lazy Loading:** Above-the-fold widgets (rows 0-2: filter bar, summary cards, equity curve) loaded with initial page render. Below-the-fold widgets loaded when scrolled into view (IntersectionObserver, 200px root margin).
4. **Incremental Computation:** On new trade close, update running sums/counts rather than full recomputation. Full recomputation only on filter change or data correction.
5. **Query Optimization:** Compound indexes on common filter patterns. EXPLAIN ANALYZE all analytics queries during development to ensure index usage.

### 9.2 Metrics Recalculation Performance

- New trade closed -> affected metrics recalculated and pushed via WebSocket: < 5 seconds.
- Filter change -> full recomputation: < 10 seconds for 10,000 trades.
- If recomputation exceeds 10 seconds: return partial results (summary metrics first, chart data streamed via multiple WebSocket messages).

### 9.3 Chart Rendering Performance

- All charts render within 500ms after data is received by the frontend.
- Datasets exceeding 5,000 data points: apply Largest Triangle Three Buckets (LTTB) downsampling algorithm to reduce to 1,000 points while preserving visual shape.
- Datasets exceeding 1,000 points: use canvas rendering (Recharts canvas mode or D3 canvas) instead of SVG.
- Chart animations (transitions, tooltips): 60fps target. Use `requestAnimationFrame`. No layout thrashing during animations.
- Tooltip display latency: < 50ms from hover event to tooltip render.

### 9.4 Monte Carlo Simulation Performance

| Simulations | Trades | Target Time | Server Resources |
|---|---|---|---|
| 500 | 100 | < 1 second | Single CPU core |
| 1,000 | 100 | < 2 seconds | Single CPU core |
| 1,000 | 500 | < 5 seconds | Single CPU core |
| 5,000 | 500 | < 15 seconds | May use multiprocessing |
| 10,000 | 1,000 | < 30 seconds | Multiprocessing recommended |

Implementation: NumPy vectorized operations for random resampling. Avoid Python loops over individual simulations.

### 9.5 PDF Export Performance

- Maximum generation time: 30 seconds for a complete report with all chart sections.
- Chart rendering for PDF: server-side Playwright browser instance renders each chart to PNG, then assembles into PDF via WeasyPrint.
- Target file size: < 5MB for standard report, < 10MB for report with all Pro-tier sections.

### 9.6 Concurrent User Support

| Concurrent Users | Behavior |
|---|---|
| 10 simultaneous dashboard loads | All load within target times |
| 50 simultaneous dashboard loads | 95th percentile load time within 2x target |
| 100 simultaneous dashboard loads | 95th percentile load time within 3x target; degraded mode acceptable (stale cache served) |
| 500+ simultaneous | Queue excess requests; return HTTP 503 with "Service busy, please retry in a few seconds" |

### 9.7 WebSocket Performance

- Maximum concurrent WebSocket connections: 10,000 across all users.
- Per-user: maximum 3 concurrent WebSocket connections (multiple tabs).
- Message delivery latency: < 500ms from trade close event to client receipt.
- Heartbeat: server sends ping every 30 seconds. If no pong received within 10 seconds, server considers connection dead and cleans up resources.

---

## 10. Testing Specifications

### 10.1 Unit Tests: Metrics Calculation Accuracy

#### 10.1.1 Reference Dataset (AN-TEST-001)

Create a reference dataset of 100 trades with manually pre-calculated expected values for every metric. The dataset MUST include:

- 55 winning trades, 42 losing trades, 3 breakeven trades (P&L = $0.00 after commissions)
- Trades across 5 instruments: CL (30), GC (25), PL (15), YM (20), MES (10)
- Trades across 3 playbooks: A+ Trendline Break (47), Standard Break (32), Bounce (21)
- R-multiples ranging from -3.00R to +5.20R
- 86 trades with defined stop losses (R-multiple calculable), 14 without
- Trades on all 5 weekdays, spread across hours 8-16
- 75 trades in RTH, 25 in overnight session
- 60 trades with journal entries (conviction 1-5, emotional states, mistakes), 40 without
- 10 trades with mistake tags: 3 moved_stop, 3 oversized, 2 entered_early, 1 held_too_long, 1 exited_too_early
- Emotional states: 25 confident, 12 patient, 8 disciplined, 6 anxious, 5 fomo, 2 revenge, 2 uncertain
- 12 trades with MAE/MFE tick data
- 4 drawdown periods with known depths ($800, $1,200, $2,400, $650) and recovery times (3, 5, 8, ongoing)
- Date range spanning 90 calendar days with 45 trading days

**Assertion Tolerances:**

| Metric Category | Metric | Tolerance |
|---|---|---|
| Trade Performance | Win Rate | Exact match to 1 decimal |
| Trade Performance | Average Winner/Loser | Within $0.01 |
| Trade Performance | Profit Factor | Within 0.01 |
| Trade Performance | Expectancy | Within $0.01 |
| Trade Performance | Total Net P&L | Exact match |
| Trade Performance | Total Trades | Exact match |
| Risk-Adjusted | Sharpe Ratio | Within 0.01 |
| Risk-Adjusted | Sortino Ratio | Within 0.01 |
| Risk-Adjusted | Calmar Ratio | Within 0.01 |
| Risk-Adjusted | Max Drawdown ($) | Exact match |
| Risk-Adjusted | Max Drawdown (%) | Within 0.01% |
| R-Multiple | R-Multiple per trade | Within 0.01R |
| R-Multiple | Average R | Within 0.01R |
| R-Multiple | Median R | Within 0.01R |
| Behavioral | Tiltmeter Score | Within 1 point |
| Behavioral | Rule Compliance Rate | Exact match to 1 decimal |
| Behavioral | Cost of Mistakes | Within $0.01 |
| Execution | Average Slippage | Within 0.1 ticks |
| Execution | Fill Quality Score | Within 1 point |

#### 10.1.2 Edge Case Tests (AN-TEST-002)

| Test ID | Scenario | Input | Expected Output |
|---|---|---|---|
| EC-001 | Zero trades | Empty trades array | All metrics `null`. API returns `{ total_trades: 0 }`. Frontend shows empty state message. |
| EC-002 | Single winning trade | 1 trade, realized_pnl = $500 | Win rate = 100.0%. Profit factor = "N/A". Avg loser = "—". Sharpe = "Insufficient data". |
| EC-003 | Single losing trade | 1 trade, realized_pnl = -$300 | Win rate = 0.0%. Profit factor = 0.00. Avg winner = "—". Sharpe = "Insufficient data". |
| EC-004 | All winners (50 trades) | 50 trades, all realized_pnl > 0 | Win rate = 100.0%. Profit factor = ">99.99". Sortino = "N/A". Max drawdown = $0.00. |
| EC-005 | All losers (50 trades) | 50 trades, all realized_pnl < 0 | Win rate = 0.0%. Profit factor = 0.00. Expectancy = avg_loser. |
| EC-006 | Breakeven trade | 1 trade, realized_pnl = $0.00 | Classified as loss. Win rate = 0.0%. |
| EC-007 | No stop loss on any trade | 100 trades, all stop_loss_price = NULL | All R metrics = `null`. Message: "R-multiple analysis requires trades with defined stop losses." |
| EC-008 | Extremely large P&L | 1 trade, realized_pnl = $150,000 | No overflow. Display: "$150.0K". Chart Y-axis auto-scales. |
| EC-009 | Sub-second trade duration | entry and exit 0.5s apart | Duration display: "< 1m". |
| EC-010 | Overnight trade spanning midnight | Entry 23:45, exit 00:30 next day | Duration correct. Attributed to exit date. Session: overnight. |
| EC-011 | Simultaneous same-instrument trades | 2 CL trades open at same time | Tracked independently. Both appear in analytics. |
| EC-012 | Timezone change by user | User changes from ET to CT | All time-based analysis recalculates. RTH boundaries adjust per instrument exchange timezone (not user timezone). |
| EC-013 | Stop at entry price | stop_loss_price = entry_price | R-multiple = `null`. Trade excluded from R aggregates. |
| EC-014 | Monte Carlo with exactly 30 trades | 30 trades | Simulation runs successfully. |
| EC-015 | Monte Carlo with 29 trades | 29 trades | HTTP 400: "Minimum 30 closed trades required." |
| EC-016 | All trades in same playbook | 100 trades, 1 playbook | Correlation matrix: single cell, no correlation calculable. Walk-forward analysis works for that playbook. |
| EC-017 | Conviction all same value | All conviction = 3 | Correlation = `null`. "Insufficient variance." |
| EC-018 | 50,001 row CSV export | 50,001 matching trades | HTTP 400: "Export limited to 50,000 rows." |

### 10.2 Filter Combination Tests (AN-TEST-003)

| Test ID | Filter State | Validation |
|---|---|---|
| FC-001 | 7 Days, all instruments, all playbooks | Metrics match manual computation for last 7 days |
| FC-002 | 30 Days, CL only | Metrics match CL trades in last 30 days |
| FC-003 | 90 Days, CL + GC | Metrics match CL and GC trades in last 90 days |
| FC-004 | YTD, A+ Trendline Break only | Metrics match A+ playbook trades since Jan 1 |
| FC-005 | Custom range, multiple playbooks | Correct intersection of all filters |
| FC-006 | Filters resulting in 0 trades | All widgets show empty state. Trade count = "Showing 0 of N trades". |
| FC-007 | Filters resulting in 1 trade | All metrics computed for single trade. Charts show single data point. |
| FC-008 | Rapid filter changes (< 300ms between) | Debounce prevents intermediate API calls. Only final filter state triggers request. Previous in-flight request cancelled. |
| FC-009 | Filter state after page refresh | URL parameters restore exact filter state. Metrics match pre-refresh state. |
| FC-010 | "Clear All Filters" button | Resets to 30d, all instruments, all playbooks. URL parameters cleared to `?range=30d`. |

### 10.3 Visual Regression Tests (AN-TEST-004)

Implement with Playwright screenshot comparison at 1% pixel difference threshold:

- Equity curve with 100-trade reference dataset at 1280px width
- Equity curve at 375px width (mobile)
- P&L calendar heatmap with known daily P&L values
- R-multiple histogram with known distribution
- MAE/MFE scatter plot with known data points
- Drawdown chart with known drawdown periods
- All charts in empty state (0 trades)
- All charts with single data point
- Tiltmeter gauge at score 0, 25, 50, 75, 100
- Locked widget (blurred preview with upgrade CTA)

### 10.4 Chart Interactivity Tests (AN-TEST-005)

| Test ID | Chart | Interaction | Expected Result |
|---|---|---|---|
| CI-001 | Equity curve | Hover on data point | Tooltip with date, cumulative P&L, daily P&L, trade count |
| CI-002 | Equity curve | Click-and-drag zoom | Chart zooms to selected date range |
| CI-003 | Equity curve | Double-click | Zoom resets to full range |
| CI-004 | Calendar | Click on date with trades | Slide-over panel with trade list for that date |
| CI-005 | Calendar | Click on date with no trades | No action (cell is not clickable) |
| CI-006 | R-histogram | Click on bin | Trade list filters to show only trades in that R range |
| CI-007 | Widget | Click full-screen button | Widget expands to full viewport modal |
| CI-008 | Widget | Press Escape in full-screen | Modal closes, returns to dashboard |
| CI-009 | Widget | Click expand/collapse chevron | Widget toggles between compact and expanded |
| CI-010 | MAE scatter | Toggle R-multiples / ticks | Axis units switch, data points reposition |

### 10.5 Performance Benchmark Tests (AN-TEST-006, AN-TEST-007)

Run as automated performance tests in CI pipeline:

| Test ID | Scenario | Metric | Target |
|---|---|---|---|
| PB-001 | 50-trade cold load | Time to LCP | < 1 second |
| PB-002 | 500-trade cold load | Time to LCP | < 2 seconds |
| PB-003 | 2,000-trade cold load | Time to LCP | < 3 seconds |
| PB-004 | 10,000-trade cold load | Time to LCP | < 5 seconds |
| PB-005 | 50,000-trade cold load | Time to LCP | < 8 seconds |
| PB-006 | Filter change (2,000 trades) | Time to all widgets updated | < 2 seconds |
| PB-007 | Monte Carlo 1,000 x 100 | Server computation time | < 2 seconds |
| PB-008 | Monte Carlo 1,000 x 500 | Server computation time | < 5 seconds |
| PB-009 | Monte Carlo 10,000 x 1,000 | Server computation time | < 30 seconds |
| PB-010 | PDF generation (full report) | Generation time | < 30 seconds |
| PB-011 | 10 concurrent dashboard loads | 95th percentile LCP | Within 2x individual target |
| PB-012 | Chart render (1,000 data points) | Render time | < 500ms |
| PB-013 | Chart render (5,000 data points, downsampled) | Render time | < 500ms |

### 10.6 Export Tests (AN-TEST-008, AN-TEST-009)

| Test ID | Export Type | Validation |
|---|---|---|
| EX-001 | PDF content | All sections from AN-FR-033 present |
| EX-002 | PDF charts | Visual match with on-screen charts (manual comparison) |
| EX-003 | PDF compatibility | Renders correctly in Adobe Reader, Chrome PDF viewer, macOS Preview |
| EX-004 | PDF file size | < 10MB for full report |
| EX-005 | PDF generation time | < 30 seconds |
| EX-006 | PDF filter respect | Filtered data matches on-screen data |
| EX-007 | PDF cover page | Correct user name, date range, generation timestamp |
| EX-008 | CSV headers | Match documented field names |
| EX-009 | CSV values | Match on-screen metric values |
| EX-010 | CSV Excel compatibility | Opens correctly in Excel (UTF-8 BOM) |
| EX-011 | CSV special characters | Commas, quotes, newlines properly escaped |
| EX-012 | CSV row count | Matches filtered trade count |

### 10.7 Tier Restriction Tests (AN-TEST-010)

| Test ID | Scenario | Expected Result |
|---|---|---|
| TR-001 | Free user views dashboard | Only 5 basic metrics visible. All other widgets blurred with upgrade CTA. |
| TR-002 | Free user calls locked API | HTTP 403 with tier upgrade message |
| TR-003 | Trader user accesses Monte Carlo API | HTTP 403: "This feature requires the Pro plan." |
| TR-004 | Trader user attempts 3rd PDF export | HTTP 429: "You've used 2 of 2 PDF exports this month." |
| TR-005 | Pro user 21st AI query in a day | HTTP 429: "You've used all 20 AI queries for today." |
| TR-006 | Team user 51st AI query in a day | HTTP 429: "You've used all 50 AI queries for today." |
| TR-007 | Pro user accesses team dashboard URL | HTTP 403: "Team analytics requires the Team plan." |
| TR-008 | User upgrades Trader -> Pro mid-session | WebSocket pushes tier_changed event. Pro features unlock without page reload. |
| TR-009 | User downgrades Pro -> Trader | Pro features immediately locked. Cached Pro data inaccessible. |
| TR-010 | PDF counter resets on billing cycle | After billing cycle date, counter resets to 0. User can generate new PDFs. |
| TR-011 | AI query counter resets at midnight UTC | At 00:00:01 UTC, counter resets. User can submit new queries. |
| TR-012 | Trader user saves 6th layout preset | Error: "Maximum 5 layout presets reached." |
| TR-013 | Non-team-member accesses team URL | HTTP 403 |
| TR-014 | Team member views teammate without permission | HTTP 403: "You do not have permission to view this team member's analytics." |

### 10.8 Security Tests

| Test ID | Scenario | Expected Result |
|---|---|---|
| SEC-001 | User A queries User B's data via API | RLS blocks. Returns only User A's data. |
| SEC-002 | Expired JWT on API call | HTTP 401: "Authentication token has expired." |
| SEC-003 | Missing JWT on API call | HTTP 401: "Authentication required." |
| SEC-004 | Invalid JWT signature | HTTP 401: "Invalid authentication token." Attempt logged. |
| SEC-005 | Export URL with expired signature | HTTP 403: "This download link has expired." |
| SEC-006 | Export URL with tampered signature | HTTP 403: "Invalid download link." Attempt logged. |
| SEC-007 | Sequential export ID guessing | UUIDs are non-sequential. Returns 404 or 403. |
| SEC-008 | AI query without consent | HTTP 403: "Please enable AI insights in your settings." |
| SEC-009 | WebSocket connection without JWT | Connection rejected with close code 4401. |
| SEC-010 | WebSocket with expired JWT, no refresh | Connection closed after 60 seconds with code 4401. |
| SEC-011 | SQL injection in filter parameters | Parameterized queries prevent injection. Returns 400 for malformed input. |
| SEC-012 | XSS in AI query response | Response sanitized before rendering. No script execution. |
| SEC-013 | CORS from unauthorized origin | No CORS headers returned. Request blocked by browser. |

### 10.9 WebSocket Tests

| Test ID | Scenario | Expected Result |
|---|---|---|
| WS-001 | New trade closed | Dashboard updates within 5 seconds. Metrics animate to new values. |
| WS-002 | Connection lost | Banner appears: "Connection lost — reconnecting..." |
| WS-003 | Reconnection successful | Banner dismissed. Full state fetched via REST. Data consistency verified. |
| WS-004 | Exponential backoff | Reconnection attempts at 1s, 2s, 4s, 8s, 16s, 30s (max). |
| WS-005 | Heartbeat timeout | If no ping for 60s, client initiates reconnection. |
| WS-006 | Tier change event | Frontend unlocks/locks features immediately. |
| WS-007 | 4th concurrent connection | Connection rejected with code 4429. |

---

## 11. Migration & Deployment

### 11.1 Phase 1: Basic Analytics (Weeks 7-8)

**Database Migrations:**

1. Create `mv_daily_pnl` materialized view with refresh function.
2. Create initial indexes on `trades` table (if not already present from trade execution pipeline).
3. No new tables required in Phase 1.

**Backend Deployment:**

1. Deploy FastAPI analytics service to Railway.
2. Endpoints: `GET /api/v1/analytics/summary` (5 basic metrics), `GET /api/v1/analytics/equity-curve`.
3. No Redis caching in Phase 1 (direct PostgreSQL queries).
4. No WebSocket in Phase 1.

**Frontend Deployment:**

1. Deploy Next.js page `/dashboard/analytics` to Vercel.
2. Components: 5 summary stat cards, basic Recharts line chart for equity curve.
3. No filter bar, no chart interactivity, no exports.

**Rollback Plan:**

- Remove analytics page route from Next.js. No data loss (read-only feature).
- Drop materialized view if causing performance issues on trades table.

### 11.2 Phase 2: Full Dashboard (Weeks 11-12)

**Database Migrations:**

1. Create `mv_metrics_cache` table.
2. Create `dashboard_layouts` table.
3. Create `ai_query_history` table.
4. Create `export_files` table.
5. Create additional compound indexes.
6. Add RLS policies to all new tables.
7. Set up nightly materialized view refresh cron job.

**Backend Deployment:**

1. Deploy full analytics API with all endpoints.
2. Deploy Redis caching layer (Upstash connection).
3. Deploy WebSocket server.
4. Deploy Monte Carlo simulation engine.
5. Deploy Claude API integration for AI insights.
6. Deploy PDF generation service (WeasyPrint/Playwright).
7. Deploy Cloudflare R2 integration for export storage.
8. Deploy rate limiting middleware.

**Frontend Deployment:**

1. Deploy full dashboard with all widgets, charts, and filter bar.
2. Deploy dashboard customization (drag-and-drop, presets).
3. Deploy export UI (PDF and CSV).
4. Deploy AI insights chat interface.
5. Deploy tier restriction UI (blurred previews, upgrade CTAs).
6. Deploy WebSocket client for real-time updates.

**Rollback Plan:**

- Feature flags for each major component (Monte Carlo, AI insights, exports, WebSocket).
- Can disable individual features without rolling back entire deployment.
- Database migrations are non-destructive (additive tables only). Rollback: drop new tables.

### 11.3 Phase 3: Team Analytics (Weeks 19-20)

**Database Migrations:**

1. Create `team_permissions` table (if not already present from team infrastructure).
2. Update RLS policies with team-aware rules.
3. Create team-specific materialized views or query patterns.

**Backend Deployment:**

1. Deploy team analytics endpoints.
2. Deploy team leaderboard computation.
3. Deploy team export functionality.

**Frontend Deployment:**

1. Deploy team dashboard page.
2. Deploy team member drill-down navigation.
3. Deploy leaderboard component.
4. Deploy team comparison view.

**Rollback Plan:**

- Disable team analytics routes. Individual user analytics unaffected.
- Revert RLS policies to user-only isolation.

### 11.4 Environment Configuration

| Variable | Phase | Description |
|---|---|---|
| `DATABASE_URL` | 1+ | PostgreSQL connection string (Supabase) |
| `REDIS_URL` | 2+ | Upstash Redis connection string |
| `ANTHROPIC_API_KEY` | 2+ | Claude API key for AI insights |
| `R2_ACCESS_KEY_ID` | 2+ | Cloudflare R2 access key |
| `R2_SECRET_ACCESS_KEY` | 2+ | Cloudflare R2 secret key |
| `R2_BUCKET_NAME` | 2+ | Export storage bucket name |
| `R2_ENDPOINT` | 2+ | R2 endpoint URL |
| `EXPORT_SIGNING_SECRET` | 2+ | HMAC secret for signed export URLs |
| `WS_REDIS_CHANNEL_PREFIX` | 2+ | Redis pub/sub channel prefix |
| `PDF_RENDERER` | 2+ | `weasyprint` or `playwright` |
| `RISK_FREE_RATE_DEFAULT` | 1+ | Default risk-free rate (5.0) |
| `MONTE_CARLO_MAX_SIMS` | 2+ | Maximum simulations allowed (10000) |
| `AI_QUERY_LIMIT_PRO` | 2+ | Daily AI query limit for Pro (20) |
| `AI_QUERY_LIMIT_TEAM` | 2+ | Daily AI query limit for Team (50) |

---

## 12. Open Questions & Assumptions

### 12.1 Open Questions

| # | Question | Impact | Status |
|---|---|---|---|
| OQ-001 | Should the risk-free rate be editable per analytics session or only in global user settings? | Affects Sharpe/Sortino/Calmar display. Current assumption: global setting only. | Open |
| OQ-002 | What is the exact contract multiplier and tick size for each supported instrument? Need a canonical reference table. | Affects R-multiple, slippage, MAE/MFE dollar calculations. | Open — awaiting instrument configuration from PRD-003 |
| OQ-003 | Should the P&L calendar heatmap use the user's local timezone or the exchange timezone for date boundaries? | Affects which trades appear on which calendar day. | Assumed: exchange timezone (consistent with time analysis) |
| OQ-004 | For team analytics, can a team admin revoke view permission for a specific member while granting it for others? | Affects RLS policy granularity. | Assumed: per-member permission granularity |
| OQ-005 | What Claude model version should be used for AI insights, and should it be configurable? | Affects cost, latency, and response quality. | Assumed: claude-sonnet-4-20250514, configurable via env var |
| OQ-006 | Should Monte Carlo simulations support custom starting equity, or always start from $0? | Affects probability of ruin calculation. | Assumed: starts from $0 (cumulative P&L basis) |
| OQ-007 | For walk-forward analysis, should the rolling window be based on trade count or calendar time? | PRD says trade count. Confirm this is preferred over time-based windows. | Assumed: trade count per PRD |
| OQ-008 | What happens to a Trader user's 6+ saved layout presets if they were on Pro and downgraded? | Options: delete excess, keep but prevent new saves, lock access to presets 6+. | Open |
| OQ-009 | Should the AI insights feature support follow-up questions with conversation context, or are queries independent? | Affects system prompt design and token usage. | Assumed: independent queries (no conversation memory between queries) |
| OQ-010 | Is there a maximum team size beyond 25 members? What happens at 26? | Affects team analytics performance. | Assumed: hard cap at 25 per PRD. Team admin sees "Maximum team size reached (25 members)." |

### 12.2 Assumptions

| # | Assumption | Rationale |
|---|---|---|
| A-001 | All trade P&L values in the `trades` table already include commissions and fees in the `realized_pnl` column. | Simplifies analytics calculations. Commission/fee breakdown stored separately for reporting but not needed for metric computation. |
| A-002 | The `trades` table schema and RLS policies are established by the trade execution pipeline (PRD-003/FSD-003) before analytics development begins. | Analytics is a read-only consumer of trade data. |
| A-003 | Journal entries are linked to trades via `journal_entries.trade_id` foreign key. | Required for behavioral metrics. Schema assumed from PRD-004. |
| A-004 | Playbook assignments are stored as `trades.playbook_id` referencing a `playbooks` table. | Required for playbook filtering and per-playbook analytics. Schema assumed from PRD-005. |
| A-005 | Trendline metadata (touch count, slope, duration, grade, candle spacing, setup type) is stored directly on the trade record, populated by the trendline detection engine during trade creation. | Avoids complex JOINs for trendline analytics. |
| A-006 | The Supabase Auth JWT includes the user's subscription tier as a claim (`user_metadata.subscription_tier`). | Required for tier-based feature gating without an additional database lookup. |
| A-007 | Exchange timezones are mapped to IANA timezone identifiers (e.g., "America/New_York" for CME products). | Required for accurate time-based analysis. |
| A-008 | The frontend build system (Next.js 14+) supports dynamic imports and code splitting for chart libraries. | Required for lazy loading of below-the-fold chart widgets. |
| A-009 | Upstash Redis supports pub/sub for WebSocket message distribution. | Required for multi-instance WebSocket server deployment. |
| A-010 | The Cloudflare R2 SDK supports generating pre-signed URLs with custom expiry times. | Required for secure export file distribution. |

---

## 13. Appendices

### Appendix A: Glossary

| Term | Definition |
|---|---|
| R-Multiple | Trade P&L divided by initial risk (stop distance x contract value). A 2R trade earned twice the amount risked. A -1R trade lost exactly the planned risk amount. |
| MAE | Maximum Adverse Excursion — the largest unrealized loss during a trade's holding period. Measures how far a trade went against the trader before the final outcome. |
| MFE | Maximum Favorable Excursion — the largest unrealized gain during a trade's holding period. Measures how much potential profit was available during the trade. |
| Sharpe Ratio | Risk-adjusted return metric: (mean return - risk-free rate) / standard deviation of returns. Annualized by multiplying by sqrt(252). Values above 1.0 are generally considered good; above 2.0 is very good. |
| Sortino Ratio | Like Sharpe but uses only downside deviation (standard deviation of negative returns), ignoring upside volatility. Higher values indicate better risk-adjusted returns with less penalty for positive variance. |
| Calmar Ratio | Annualized return divided by maximum drawdown. Higher is better. Measures return per unit of maximum drawdown risk. |
| Profit Factor | Gross profit divided by gross loss (absolute value). Values above 1.0 mean the system is profitable. Values above 2.0 are considered strong. |
| Expectancy | Expected dollar value per trade: (win_rate x avg_winner) + (loss_rate x avg_loser). Positive expectancy indicates a profitable system over time. |
| Tiltmeter | Composite behavioral score (0-100) measuring emotional discipline across the last 10 trades. Components: emotional state, mistake frequency, position size deviation, trade frequency anomaly. Inspired by the Edgewonk journaling tool. |
| RTH | Regular Trading Hours — the primary trading session for a futures contract (e.g., 09:30-16:00 ET for E-mini S&P 500). |
| Drawdown | Peak-to-trough decline in equity. Measured in dollars and as a percentage of peak equity. A drawdown period starts when equity falls below the previous high and ends when equity makes a new high. |
| Walk-Forward Analysis | Rolling window analysis that recalculates metrics on successive subsets of data to detect performance changes over time. Used for strategy decay detection. |
| Monte Carlo Simulation | Statistical technique that randomly resamples actual trades (with replacement) to generate thousands of simulated equity curves, projecting the range of possible outcomes given the trader's actual trade distribution. |
| RLS | Row-Level Security — PostgreSQL feature that restricts which rows a user can access based on declarative policies. Enforced at the database engine level. |
| LTTB | Largest Triangle Three Buckets — a downsampling algorithm that reduces the number of data points in a time series while preserving the visual shape of the data. Used for chart performance optimization. |
| Edge Ratio | Average MFE divided by average MAE. Values above 1.0 indicate that favorable price excursions exceed adverse excursions on average. |
| Fill Quality Score | Composite metric (0-100) combining normalized slippage and fill rate. Higher scores indicate better execution quality. |

### Appendix B: RTH Session Defaults

| Instrument | Exchange | RTH Start | RTH End | Timezone |
|---|---|---|---|---|
| ES (E-mini S&P 500) | CME | 09:30 | 16:00 | America/New_York |
| NQ (E-mini Nasdaq) | CME | 09:30 | 16:00 | America/New_York |
| YM (E-mini Dow) | CBOT | 09:30 | 16:00 | America/New_York |
| MES (Micro E-mini S&P) | CME | 09:30 | 16:00 | America/New_York |
| MNQ (Micro Nasdaq) | CME | 09:30 | 16:00 | America/New_York |
| MYM (Micro Dow) | CBOT | 09:30 | 16:00 | America/New_York |
| CL (Crude Oil) | NYMEX | 09:00 | 14:30 | America/New_York |
| MCL (Micro Crude Oil) | NYMEX | 09:00 | 14:30 | America/New_York |
| GC (Gold) | COMEX | 08:20 | 13:30 | America/New_York |
| MGC (Micro Gold) | COMEX | 08:20 | 13:30 | America/New_York |
| PL (Platinum) | NYMEX | 08:20 | 13:05 | America/New_York |

### Appendix C: Tiltmeter Score Calculation Reference

**Formula:**

```
tiltmeter = (emotional_component * 0.25) + (mistake_component * 0.30) + (size_deviation_component * 0.25) + (frequency_component * 0.20)
```

**Component Details:**

1. **Emotional State Component (0-100):**
   - For each of the last 10 trades, assign a score based on emotional tags:
     - Tags `confident`, `patient`, `disciplined` -> score = 0
     - Tags `anxious`, `uncertain` -> score = 50
     - Tags `fomo`, `revenge`, `frustrated`, `fearful` -> score = 100
   - If a trade has multiple emotional tags, use the highest score.
   - Component = average of 10 scores.

2. **Mistake Rate Component (0-100):**
   - Count trades with any mistake tag in last 10 trades.
   - Component = (count / 10) * 100.

3. **Position Size Deviation Component (0-100):**
   - For each of last 10 trades with `planned_quantity`:
     - deviation = abs(actual_quantity - planned_quantity) / planned_quantity * 100
     - Cap at 100.
   - Component = average of available deviations.
   - If no trades have `planned_quantity`: component = 0 (assume disciplined).

4. **Trade Frequency Anomaly Component (0-100):**
   - baseline = average trades per week over trailing 30 calendar days.
   - current = trades in last 7 calendar days, normalized to weekly rate.
   - anomaly = max(0, (current / baseline - 1) * 100)
   - Cap at 100.
   - If baseline = 0 (no prior trades): anomaly = 0.

**Color Zones:**

| Score Range | Zone | Color (Hex) | Label |
|---|---|---|---|
| 0-25 | Green | #22C55E | Disciplined |
| 26-50 | Yellow | #F59E0B | Caution |
| 51-75 | Orange | #F97316 | Elevated Risk |
| 76-100 | Red | #EF4444 | Tilt |

### Appendix D: Error Message Reference

| Code | Context | Message |
|---|---|---|
| 400 | Invalid date range | "Invalid date range: start date must be before end date." |
| 400 | Future end date | "End date cannot be in the future." |
| 400 | Invalid instrument | "Unknown instrument: '{code}'. Available instruments: {list}." |
| 400 | Monte Carlo insufficient trades | "Minimum 30 closed trades required for Monte Carlo simulation. You have {N} trades." |
| 400 | CSV export too large | "Export limited to 50,000 rows. Apply filters to reduce the dataset." |
| 400 | Invalid bin width | "Invalid bin width: {value}. Valid options: 0.25, 0.5, 1.0." |
| 400 | Invalid window size | "Invalid window size: {value}. Valid options: 20, 30, 50, 100." |
| 401 | Missing token | "Authentication required." |
| 401 | Expired token | "Authentication token has expired. Please log in again." |
| 401 | Invalid token | "Invalid authentication token." |
| 403 | Tier restriction | "This feature requires the {tier} plan." |
| 403 | Team permission denied | "You do not have permission to view this team member's analytics." |
| 403 | Export permission denied | "You do not have permission to export this team member's data." |
| 403 | AI consent required | "Please enable AI insights in your settings before using this feature." |
| 403 | Expired download link | "This download link has expired. Generate a new export from your dashboard." |
| 403 | Invalid download signature | "Invalid download link." |
| 404 | Calendar date no trades | "No trades found for {date}." |
| 429 | Rate limit exceeded | "Too many requests. Please try again later." |
| 429 | PDF export limit | "You've used {N} of {M} PDF exports this month. Upgrade to Pro for unlimited exports." |
| 429 | AI query limit | "You've used all {N} AI queries for today. Your limit resets at midnight UTC." |
| 429 | WebSocket limit | Close code 4429: "Too many connections." |
| 503 | Service unavailable | "Analytics service temporarily unavailable. Please try again in a few minutes." |
| 504 | Computation timeout | "Metrics calculation timed out. Please try a narrower date range or fewer filters." |
| 504 | Monte Carlo timeout | "Simulation timed out. Try reducing the number of iterations." |

---

## Changelog

- 2026-02-11: Initial FSD created from PRD-006 v1.0 — Generated by Claude

---

*Document version: 1.0 | Last updated: February 11, 2026*
*This document is part of the TrendEdge FSD suite (FSD-006 of 11)*