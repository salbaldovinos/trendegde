# FSD-012b: Account Deletion

**TrendEdge -- AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-012b |
| Source | PRD-012 (Completion Sweep), PRD-008 (Auth & User Management) |
| Title | Account Deletion |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-12 |

---

## Table of Contents

1. [Introduction](#1-introduction)
2. [State Machine](#2-state-machine)
3. [Functional Flows](#3-functional-flows)
4. [API Specifications](#4-api-specifications)
5. [Data Specifications](#5-data-specifications)
6. [UI Specifications](#6-ui-specifications)
7. [Email Templates](#7-email-templates)
8. [Security](#8-security)
9. [Edge Cases](#9-edge-cases)
10. [Testing Specifications](#10-testing-specifications)
11. [Compliance](#11-compliance)

---

## 1. Introduction

### 1.1 Purpose

This sub-FSD specifies the GDPR-compliant account deletion lifecycle for TrendEdge. It covers the complete flow from a user requesting deletion through a 30-day grace period to permanent hard deletion of all user data across all tables, external storage, and the Supabase auth provider.

Account deletion is a legal requirement under GDPR Article 17 (Right to Erasure). TrendEdge handles financial data, broker credentials, and proprietary trading strategies -- the deletion flow must be thorough, auditable, and irreversible after the grace period.

This document provides exact field names, state transitions, API contracts, SQL cascade order, email content, and UI layouts required for implementation without ambiguity.

### 1.2 Scope

This document covers:

- **Deletion Request Initiation** -- UI flow, confirmation dialog, re-authentication, input validation.
- **Soft Delete Processing** -- Immediate synchronous actions (timestamp, session revocation, API key deactivation) and asynchronous actions (Stripe cancellation, broker disconnection, email).
- **30-Day Grace Period** -- Login detection, restoration prompt, data recovery, re-activation of deactivated resources.
- **Hard Deletion Cascade** -- Celery Beat scheduling, 19-table deletion order, external resource cleanup, deletion audit log.
- **API Endpoints** -- POST `/api/v1/account/delete`, POST `/api/v1/account/restore`, GET `/api/v1/account/deletion-status`.
- **Email Lifecycle** -- Deletion scheduled, account restored, hard delete complete.
- **Deletion Audit Log** -- Anonymized compliance record retained for 2 years.

### 1.3 Out of Scope

- Data export to ZIP (AU-FR-090) -- separate deliverable under PRD-008 Phase 3. Data export should be offered to the user before deletion but is independently scoped.
- Team/organization account deletion -- deferred to PRD-009 Phase 3 team features. This FSD covers individual account deletion only.
- Admin-initiated account suspension or termination -- covered by FSD-008d (Authorization).
- Billing and subscription management beyond cancellation on deletion -- see FSD-009a (Stripe Subscriptions).
- Account anonymization as an alternative to deletion -- not supported in the current tier model.

### 1.4 GDPR Context

GDPR Article 17 ("Right to Erasure") requires that a data controller erase personal data without undue delay when requested by the data subject. TrendEdge implements this as follows:

| GDPR Requirement | TrendEdge Implementation |
|---|---|
| Erasure without undue delay | Soft delete within 2 seconds; hard delete within 30 days + 24 hours |
| Confirmation of request | Immediate API response + email confirmation |
| Right to withdraw request | 30-day grace period with login-triggered restoration |
| Notification to processors | Stripe subscription cancelled, broker connections disconnected, R2 files deleted |
| Record of erasure | `deletion_audit_log` table with anonymized hash, retained 2 years |
| Communication of erasure | Email sent at each lifecycle stage (scheduled, restored, completed) |

### 1.5 Dependencies

| Dependency | What This FSD Needs |
|---|---|
| Supabase Auth (Admin API) | `auth.admin.signOut(user_id, 'global')` for session revocation; `auth.admin.deleteUser(user_id)` for auth record removal |
| PostgreSQL (Supabase) | `users.deleted_at` column (already exists), `deletion_audit_log` table (new), cascade DELETE across all user-owned tables |
| Redis (Upstash) | Rate limiting on deletion endpoint, lock for concurrent deletion prevention |
| Celery + Redis broker | `purge_deleted_accounts` Beat task (daily 03:00 UTC), async soft-delete side effects (queue: `high`) |
| Stripe API | Subscription cancellation via `stripe.subscriptions.cancel()` (if PRD-009 implemented; graceful skip otherwise) |
| SendGrid | Transactional emails for deletion lifecycle |
| Cloudflare R2 | Avatar and export file deletion |
| Sentry | User context cleanup (best-effort) |

---

## 2. State Machine

### 2.1 Account States

```
                          +-----------+
                          |  active   |
                          +-----------+
                               |
                  CS-FR-020: User requests deletion
                  (confirmation + re-auth)
                               |
                               v
                    +--------------------+
                    | pending_deletion   |
                    +--------------------+
                         |           |
          CS-FR-022:     |           |  CS-FR-023: 30-day grace
          User logs in   |           |  period expires
          + restores     |           |
                         v           v
                  +-----------+  +-----------+
                  |  active   |  |  deleted   |
                  +-----------+  +-----------+
```

### 2.2 State Definitions

| State | `deleted_at` | `settings.account_status` | User Can Log In | Data Present |
|---|---|---|---|---|
| `active` | NULL | absent or `'active'` | Yes | Yes |
| `pending_deletion` | Timestamp (non-NULL) | `'pending_deletion'` | Yes (restoration prompt shown) | Yes (read-only, no new trades/signals) |
| `deleted` | N/A (row removed) | N/A (row removed) | No (auth record removed) | No (all data purged) |

### 2.3 State Transitions

| Transition | From | To | Trigger | Guard | Actions |
|---|---|---|---|---|---|
| T1: Request Deletion | `active` | `pending_deletion` | `POST /api/v1/account/delete` | `confirmation == "DELETE"` AND re-auth succeeds AND `deleted_at IS NULL` AND no concurrent deletion lock | Set `deleted_at`, set `settings.account_status`, revoke sessions, deactivate API keys, dispatch async task |
| T2: Restore Account | `pending_deletion` | `active` | `POST /api/v1/account/restore` | `deleted_at IS NOT NULL` AND `deleted_at > NOW() - INTERVAL '30 days'` | Clear `deleted_at`, clear `settings.account_status`, re-activate API keys, send email |
| T3: Hard Delete | `pending_deletion` | `deleted` | `purge_deleted_accounts` Celery Beat task | `deleted_at IS NOT NULL` AND `deleted_at < NOW() - INTERVAL '30 days'` | Cascade delete all tables, delete auth record, delete R2 files, write audit log, send final email |

### 2.4 State Guards

| Guard | Check | Error if Failed |
|---|---|---|
| Confirmation valid | `request.confirmation == "DELETE"` (case-sensitive exact match) | 422 `VALIDATION_ERROR` |
| Re-auth valid | Password verified against Supabase Auth OR OAuth re-auth completed | 401 `AUTHENTICATION_REQUIRED` |
| Not already pending | `users.deleted_at IS NULL` | 409 `CONFLICT` |
| No concurrent lock | Redis lock `lock:account_deletion:{user_id}` not held | 409 `CONFLICT` |
| Grace period active | `users.deleted_at > NOW() - INTERVAL '30 days'` | 410 `GONE` (account already hard-deleted or grace period expired) |

---

## 3. Functional Flows

### 3.1 Deletion Request Flow

**Source requirement:** CS-FR-020, CS-FR-021

**Actor:** Authenticated user

**Preconditions:**
- User is authenticated with a valid session.
- User's account is in `active` state (`deleted_at IS NULL`).

**Flow:**

```
Step  Actor      Action
───── ────────── ──────────────────────────────────────────────────────────────
1     User       Navigates to /settings/account, clicks "Delete my account"
2     Frontend   Displays confirmation dialog (Section 6.2)
3     User       Types "DELETE" in confirmation input
4     User       Enters current password (or confirms OAuth re-auth)
5     Frontend   Sends POST /api/v1/account/delete
                 Body: { "confirmation": "DELETE", "password": "..." }
6     Backend    Validates confirmation string == "DELETE"
7     Backend    Verifies password via Supabase Auth (supabase.auth.sign_in_with_password)
                 OR validates OAuth re-auth token
8     Backend    Acquires Redis lock: lock:account_deletion:{user_id} (TTL 30s)
9     Backend    BEGIN TRANSACTION
10    Backend    UPDATE users SET deleted_at = NOW(),
                   settings = settings || '{"account_status": "pending_deletion"}'
                   WHERE id = :user_id AND deleted_at IS NULL
11    Backend    Verify row count == 1 (guard against race condition)
12    Backend    UPDATE api_keys SET is_active = false, deactivated_by = 'deletion'
                   WHERE user_id = :user_id AND is_active = true
13    Backend    COMMIT TRANSACTION
14    Backend    Call supabase.auth.admin.sign_out(user_id, scope='global')
15    Backend    Dispatch Celery task: process_deletion_side_effects.apply_async(
                   args=[user_id], queue='high')
16    Backend    Release Redis lock
17    Backend    Return 200 { status: "scheduled", deletion_date: ..., message: ... }
18    Frontend   Redirect to /goodbye page
```

**Celery task: `process_deletion_side_effects`**

```
Step  Action
───── ──────────────────────────────────────────────────────────────────
1     Cancel Stripe subscription (if active):
        stripe.subscriptions.cancel(subscription_id)
        Log event to audit_logs
      If Stripe not configured or no subscription: skip, log INFO
2     Disconnect broker connections:
        For each broker_connection WHERE user_id = :user_id AND status = 'connected':
          - Tradovate: revoke OAuth token via Tradovate API
          - IBKR: close WebSocket connection (if active worker)
          - All: UPDATE broker_connections SET status = 'disconnected'
3     Send deletion confirmation email (Section 7.1)
4     Log deletion event to audit_logs:
        { action: 'account_deletion_requested', user_id, metadata: { deletion_date } }
```

**Error handling:**
- If Stripe cancellation fails: log ERROR, retry up to 3 times with exponential backoff (1s, 2s, 4s). If all retries fail, log CRITICAL and continue. The Celery Beat purge task will re-attempt before hard deletion.
- If broker disconnection fails: log WARNING, continue. Credentials will be deleted during hard deletion regardless.
- If email fails: log ERROR, retry up to 3 times. User will still see the /goodbye page confirmation.

### 3.2 Restoration Flow

**Source requirement:** CS-FR-022

**Actor:** User with `pending_deletion` status who logs in during grace period

**Preconditions:**
- User's `deleted_at` is non-NULL and less than 30 days ago.
- User successfully authenticates (Supabase Auth session tokens were revoked, but the auth record still exists -- user can re-authenticate).

**Flow:**

```
Step  Actor      Action
───── ────────── ──────────────────────────────────────────────────────────────
1     User       Navigates to login page, enters credentials
2     Supabase   Authenticates user, issues new JWT
3     Backend    On session creation, checks users.deleted_at
4     Backend    If deleted_at IS NOT NULL AND within 30 days:
                   Returns 200 with header X-Account-Status: pending_deletion
5     Frontend   Detects X-Account-Status header, shows restoration prompt (Section 6.4)
6     User       Clicks "Restore Account"
7     Frontend   Sends POST /api/v1/account/restore
8     Backend    BEGIN TRANSACTION
9     Backend    UPDATE users SET deleted_at = NULL,
                   settings = settings - 'account_status'
                   WHERE id = :user_id AND deleted_at IS NOT NULL
10    Backend    Verify row count == 1
11    Backend    UPDATE api_keys SET is_active = true
                   WHERE user_id = :user_id AND deactivated_by = 'deletion'
12    Backend    COMMIT TRANSACTION
13    Backend    Send restoration confirmation email (Section 7.2)
14    Backend    Log restoration event to audit_logs
15    Backend    Return 200 { status: "restored", message: ... }
16    Frontend   Redirect to /dashboard
```

**If user clicks "Continue with Deletion":**
- Frontend dismisses the restoration prompt.
- User remains in `pending_deletion` state.
- Frontend shows a read-only banner: "Your account is scheduled for deletion on {date}."
- User can still view their data but cannot create new trades, signals, or API keys.
- User can restore at any time during the grace period by calling `POST /api/v1/account/restore`.

**Read-only enforcement during `pending_deletion`:**
- Backend middleware checks `users.deleted_at` on every authenticated request.
- If `deleted_at IS NOT NULL`, the following endpoints return `403 FORBIDDEN` with message "Account is pending deletion. Restore your account to perform this action.":
  - POST/PUT/DELETE on `/api/v1/signals/*`
  - POST/PUT/DELETE on `/api/v1/orders/*`
  - POST/PUT/DELETE on `/api/v1/positions/*`
  - POST/PUT/DELETE on `/api/v1/broker-connections/*`
  - POST/PUT/DELETE on `/api/v1/api-keys/*`
  - POST/PUT/DELETE on `/api/v1/webhooks/*`
  - POST/PUT/DELETE on `/api/v1/trendlines/*` (manual operations)
  - POST/PUT/DELETE on `/api/v1/risk-settings/*`
- GET endpoints remain accessible (user can view their data).
- The restoration endpoint (`POST /api/v1/account/restore`) and deletion status endpoint (`GET /api/v1/account/deletion-status`) are exempt from this restriction.

### 3.3 Hard Deletion Flow

**Source requirement:** CS-FR-023

**Actor:** Celery Beat scheduler

**Trigger:** `purge_deleted_accounts` task runs daily at 03:00 UTC

**Flow:**

```
Step  Action
───── ──────────────────────────────────────────────────────────────────
1     Query: SELECT id, email FROM users
         WHERE deleted_at IS NOT NULL
         AND deleted_at < NOW() - INTERVAL '30 days'
2     For each user returned:
3       Capture email address and user_id before deletion
4       Compute anonymized hash: SHA-256(user_id || email || secret_salt)
5       Acquire Redis lock: lock:hard_deletion:{user_id} (TTL 120s)
6       BEGIN TRANSACTION
7       Execute deletion cascade (Section 5.3) in order
8       DELETE FROM users WHERE id = :user_id
9       INSERT INTO deletion_audit_log (anonymized_hash, deleted_at,
          categories, table_counts)
10      COMMIT TRANSACTION
11      Delete auth record: supabase.auth.admin.delete_user(user_id)
12      Delete R2 files (best-effort):
          - avatars/{user_id}.*
          - exports/{user_id}/*
13      Release Redis lock
14      Send final deletion email to captured email address (Section 7.3)
15      Log hard deletion event (no PII): { action: 'account_hard_deleted',
          anonymized_hash, tables_cleared: 19 }
```

**Transaction handling:**
- Steps 6-10 execute within a single PostgreSQL transaction.
- If any DELETE statement fails, the entire transaction rolls back.
- The task logs the error, releases the lock, and skips to the next user.
- On the next daily run (03:00 UTC + 24h), the task re-attempts the failed user.
- After 3 consecutive failures for the same user, log CRITICAL and alert via Sentry.

**Concurrency:**
- The Redis lock (`lock:hard_deletion:{user_id}`, TTL 120s) prevents overlapping hard deletion attempts for the same user (e.g., if the Beat task overlaps with a manual admin trigger in the future).
- The `purge_deleted_accounts` task itself acquires a global lock (`lock:purge_deleted_accounts`, TTL 600s) to prevent concurrent Beat executions.

**Performance target:** < 60 seconds per account (CS-NFR-004). The cascade is executed via indexed DELETE statements. The largest tables (signals, orders, trendlines) have indexes on `user_id`.

---

## 4. API Specifications

### 4.1 POST /api/v1/account/delete

**Description:** Initiate account deletion (soft delete).

**Authentication:** Required. Bearer JWT in Authorization header.

**Re-authentication:** The request body must include the user's current password. The backend verifies the password by calling `supabase.auth.sign_in_with_password(email, password)`. If this verification succeeds, the deletion proceeds. For OAuth users without a password, see Section 9.1.

**Rate limiting:** 3 requests per hour per user (Redis sliding window: `ratelimit:account_delete:{user_id}`).

**Request:**

```
POST /api/v1/account/delete
Content-Type: application/json
Authorization: Bearer <jwt>

{
  "confirmation": "DELETE",
  "password": "user_current_password"
}
```

**Request schema (Pydantic):**

```python
class AccountDeleteRequest(BaseModel):
    confirmation: str = Field(
        ...,
        description="Must be exactly 'DELETE' (case-sensitive)",
    )
    password: str | None = Field(
        None,
        description="Current password. Required for email/password users. "
                    "NULL for OAuth-only users (OAuth re-auth handled separately).",
        min_length=1,
        max_length=128,
    )
    oauth_token: str | None = Field(
        None,
        description="OAuth re-auth token. Required for OAuth-only users.",
    )

    @field_validator("confirmation")
    @classmethod
    def confirmation_must_be_delete(cls, v: str) -> str:
        if v != "DELETE":
            raise ValueError("Confirmation must be exactly 'DELETE'")
        return v
```

**Response (200 OK):**

```json
{
  "status": "scheduled",
  "deletion_date": "2026-03-14T03:00:00Z",
  "message": "Your account has been scheduled for deletion."
}
```

**Response schema (Pydantic):**

```python
class AccountDeleteResponse(BaseModel):
    status: Literal["scheduled"]
    deletion_date: datetime
    message: str
```

**Error responses:**

| Condition | HTTP | Error Code | Message |
|---|---|---|---|
| Missing or invalid confirmation | 422 | `VALIDATION_ERROR` | "Confirmation field must be exactly 'DELETE'." |
| No password or OAuth token provided | 422 | `VALIDATION_ERROR` | "Password or OAuth re-authentication token is required." |
| Invalid password | 401 | `AUTHENTICATION_REQUIRED` | "Invalid password. Please try again." |
| Invalid OAuth token | 401 | `AUTHENTICATION_REQUIRED` | "OAuth re-authentication failed. Please try again." |
| Account already pending deletion | 409 | `CONFLICT` | "Account is already scheduled for deletion on {date}." |
| Concurrent deletion request | 409 | `CONFLICT` | "A deletion request is already being processed. Please wait." |
| Rate limited | 429 | `RATE_LIMITED` | "Too many deletion attempts. Please try again later." |
| JWT expired or invalid | 401 | `AUTHENTICATION_REQUIRED` | "Authentication required." |

### 4.2 POST /api/v1/account/restore

**Description:** Restore account during 30-day grace period.

**Authentication:** Required. Bearer JWT in Authorization header.

**Rate limiting:** 5 requests per hour per user (Redis sliding window: `ratelimit:account_restore:{user_id}`).

**Request:**

```
POST /api/v1/account/restore
Content-Type: application/json
Authorization: Bearer <jwt>
```

No request body required.

**Response (200 OK):**

```json
{
  "status": "restored",
  "message": "Your account has been restored. All your data is intact."
}
```

**Response schema (Pydantic):**

```python
class AccountRestoreResponse(BaseModel):
    status: Literal["restored"]
    message: str
```

**Error responses:**

| Condition | HTTP | Error Code | Message |
|---|---|---|---|
| Account not pending deletion | 400 | `VALIDATION_ERROR` | "Account is not pending deletion." |
| Grace period expired | 410 | `GONE` | "Grace period has expired. Account data has been permanently deleted." |
| Rate limited | 429 | `RATE_LIMITED` | "Too many restoration attempts. Please try again later." |
| JWT expired or invalid | 401 | `AUTHENTICATION_REQUIRED` | "Authentication required." |

### 4.3 GET /api/v1/account/deletion-status

**Description:** Check current deletion status and scheduled date.

**Authentication:** Required. Bearer JWT in Authorization header.

**Request:**

```
GET /api/v1/account/deletion-status
Authorization: Bearer <jwt>
```

**Response (200 OK) -- active account:**

```json
{
  "status": "active",
  "deletion_scheduled": false,
  "deletion_date": null,
  "days_remaining": null
}
```

**Response (200 OK) -- pending deletion:**

```json
{
  "status": "pending_deletion",
  "deletion_scheduled": true,
  "deletion_date": "2026-03-14T03:00:00Z",
  "days_remaining": 28
}
```

**Response schema (Pydantic):**

```python
class DeletionStatusResponse(BaseModel):
    status: Literal["active", "pending_deletion"]
    deletion_scheduled: bool
    deletion_date: datetime | None
    days_remaining: int | None
```

**Error responses:**

| Condition | HTTP | Error Code | Message |
|---|---|---|---|
| JWT expired or invalid | 401 | `AUTHENTICATION_REQUIRED` | "Authentication required." |

---

## 5. Data Specifications

### 5.1 Existing Column: `users.deleted_at`

The `users` table already has a `deleted_at` column (nullable timestamp with timezone) and an index (`ix_users_deleted_at`). No migration needed.

```sql
-- Already exists in users table:
deleted_at TIMESTAMP WITH TIME ZONE DEFAULT NULL
-- Index already exists:
CREATE INDEX ix_users_deleted_at ON users (deleted_at);
```

### 5.2 New Column: `api_keys.deactivated_by`

A new nullable text column to track why an API key was deactivated, enabling selective re-activation on account restoration.

```sql
ALTER TABLE api_keys ADD COLUMN deactivated_by TEXT DEFAULT NULL;
-- Values: 'deletion' (deactivated by account deletion), 'user' (deactivated manually), NULL (active)
```

### 5.3 New Table: `deletion_audit_log`

This table retains an anonymized record of each hard deletion for GDPR compliance. It is append-only -- no UPDATE or DELETE operations are permitted by application code or RLS policy.

```sql
CREATE TABLE deletion_audit_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    anonymized_hash TEXT NOT NULL,
    deleted_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    categories TEXT[] NOT NULL,
    table_counts JSONB NOT NULL DEFAULT '{}'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- No RLS policy: this table is accessed only by the service role (Celery worker).
-- No user_id column: no PII stored.

COMMENT ON TABLE deletion_audit_log IS 'Anonymized record of hard-deleted accounts. Retained for 2 years. Append-only.';
COMMENT ON COLUMN deletion_audit_log.anonymized_hash IS 'SHA-256(user_id || email || secret_salt). Not reversible without the salt.';
COMMENT ON COLUMN deletion_audit_log.categories IS 'Data categories that were deleted, e.g. {trades, journal, trendlines, broker_connections}';
COMMENT ON COLUMN deletion_audit_log.table_counts IS 'Row counts per table deleted, e.g. {"signals": 42, "orders": 15}';
```

**ORM model:**

```python
class DeletionAuditLog(Base):
    """Anonymized record of hard-deleted accounts. Append-only."""

    __tablename__ = "deletion_audit_log"

    id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True),
        primary_key=True,
        server_default=text("gen_random_uuid()"),
    )
    anonymized_hash: Mapped[str] = mapped_column(Text, nullable=False)
    deleted_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, server_default=text("NOW()")
    )
    categories: Mapped[list[str]] = mapped_column(
        ARRAY(Text), nullable=False
    )
    table_counts: Mapped[dict] = mapped_column(
        JSONB, nullable=False, server_default=text("'{}'::jsonb")
    )
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, server_default=text("NOW()")
    )
```

### 5.4 Deletion Cascade Order

The hard deletion cascade must respect foreign key constraints. Tables are deleted in dependency order (children before parents). All DELETEs within a single transaction.

| Step | Table | FK Parent | Operation | Expected Volume per User |
|---|---|---|---|---|
| 1 | `order_events` | `orders.id` | DELETE WHERE order_id IN (SELECT id FROM orders WHERE user_id = :uid) | 0-500 |
| 2 | `orders` | `users.id` | DELETE WHERE user_id = :uid | 0-200 |
| 3 | `signals` | `users.id` | DELETE WHERE user_id = :uid | 0-500 |
| 4 | `positions` | `users.id` | DELETE WHERE user_id = :uid | 0-100 |
| 5 | `risk_check_audits` | `users.id` | DELETE WHERE user_id = :uid | 0-1000 |
| 6 | `user_risk_settings` | `users.id` | DELETE WHERE user_id = :uid | 1 |
| 7 | `risk_settings_changelog` | `users.id` | DELETE WHERE user_id = :uid | 0-50 |
| 8 | `trendline_events` | `trendlines.id` | DELETE WHERE trendline_id IN (SELECT id FROM trendlines WHERE user_id = :uid) | 0-200 |
| 9 | `trendlines` | `users.id` | DELETE WHERE user_id = :uid | 0-100 |
| 10 | `alerts` | `users.id` | DELETE WHERE user_id = :uid | 0-50 |
| 11 | `user_detection_config` | `users.id` | DELETE WHERE user_id = :uid | 0-10 |
| 12 | `user_watchlist` | `users.id` | DELETE WHERE user_id = :uid | 0-20 |
| 13 | `broker_connections` | `users.id` | DELETE WHERE user_id = :uid | 0-3 |
| 14 | `api_keys` | `users.id` | DELETE WHERE user_id = :uid | 0-10 |
| 15 | `webhook_urls` | `users.id` | DELETE WHERE user_id = :uid | 0-5 |
| 16 | `audit_logs` | `users.id` | DELETE WHERE user_id = :uid | 0-500 |
| 17 | `users` | `auth.users.id` | DELETE WHERE id = :uid | 1 |

**Post-transaction (external):**

| Step | Target | Operation |
|---|---|---|
| 18 | `auth.users` | `supabase.auth.admin.delete_user(user_id)` |
| 19 | Cloudflare R2 | Delete `avatars/{user_id}.*` and `exports/{user_id}/*` |

**Notes:**
- Steps 1-17 execute within a single PostgreSQL transaction.
- Steps 18-19 execute after the transaction commits. If they fail, log ERROR and retry on next daily run.
- Tables that do not exist yet (e.g., `journal_entries`, `playbooks`) are omitted from the cascade. When those tables are created in future PRDs, the deletion cascade must be updated to include them.
- Tables with CASCADE FK constraints (e.g., `order_events` cascading from `orders`, `trendline_events` cascading from `trendlines`) could be handled by PostgreSQL's ON DELETE CASCADE. However, the explicit ordered DELETE approach is used to capture per-table row counts for the audit log.
- Tables without a `user_id` column (e.g., `instruments`, `candles`, `pivots`, `contract_specifications`, `contract_calendar`, `instrument_correlation`) are shared data and are NOT deleted.

### 5.5 Row Count Capture

Before each DELETE statement, a SELECT COUNT(*) is executed to record the number of rows being deleted. These counts are stored in the `deletion_audit_log.table_counts` JSONB field.

```python
table_counts = {}
for table_name, delete_query in CASCADE_ORDER:
    count = await session.scalar(
        select(func.count()).select_from(table_model).where(
            table_model.user_id == user_id
        )
    )
    table_counts[table_name] = count
    await session.execute(delete_query)
```

---

## 6. UI Specifications

### 6.1 Settings Account Section

**Route:** `/settings/account`

**Location:** Below existing account settings (display name, email, timezone), separated by a visual divider.

```
┌─────────────────────────────────────────────────────┐
│  Account Settings                                    │
│  ────────────────                                    │
│  Display Name: [John Doe]                            │
│  Email: john@example.com                             │
│  Timezone: [America/New_York ▼]                      │
│                                                      │
│  ─────────────── Danger Zone ──────────────          │
│                                                      │
│  Delete Account                                      │
│  Permanently delete your account and all associated  │
│  data. This action cannot be undone after 30 days.   │
│                                                      │
│  [Delete my account]  (destructive button, red)      │
│                                                      │
└─────────────────────────────────────────────────────┘
```

**Styling:**
- "Danger Zone" heading uses `text-destructive` color with a `border-destructive/20` top border.
- "Delete my account" button uses `variant="destructive"` from shadcn/ui (`bg-destructive text-destructive-foreground`).
- Descriptive text uses `text-muted-foreground`, `text-sm`.

### 6.2 Confirmation Dialog

**Trigger:** Clicking "Delete my account" opens a modal dialog.

```
┌──────────────────────────────────────────────────────┐
│  ⚠  Delete Your Account                       [X]   │
│  ────────────────────────────────────────────────     │
│                                                      │
│  This action is permanent and cannot be undone       │
│  after the 30-day grace period.                      │
│                                                      │
│  All your data will be permanently deleted:          │
│  - Trades, orders, and positions                     │
│  - Journal entries and playbooks                     │
│  - Trendlines and signals                            │
│  - Broker connections and API keys                   │
│  - Settings and preferences                          │
│                                                      │
│  ┌────────────────────────────────────────┐          │
│  │ Your subscription will be cancelled    │          │
│  │ immediately. No refund will be issued  │          │
│  │ for the current billing period.        │          │
│  └────────────────────────────────────────┘          │
│  (only shown if user has active subscription)        │
│                                                      │
│  ┌────────────────────────────────────────┐          │
│  │ All active broker connections will be  │          │
│  │ disconnected.                          │          │
│  └────────────────────────────────────────┘          │
│  (only shown if user has active broker connections)  │
│                                                      │
│  Type "DELETE" to confirm:                           │
│  ┌────────────────────────────────────────┐          │
│  │                                        │          │
│  └────────────────────────────────────────┘          │
│                                                      │
│  Enter your password:                                │
│  ┌────────────────────────────────────────┐          │
│  │ ●●●●●●●●                              │          │
│  └────────────────────────────────────────┘          │
│                                                      │
│  [Cancel]              [Confirm Deletion] (disabled) │
│                                                      │
└──────────────────────────────────────────────────────┘
```

**Component:** shadcn/ui `AlertDialog` with custom content.

**Behavior:**
- "Confirm Deletion" button is disabled (`disabled={true}`) until:
  1. Confirmation input value is exactly "DELETE" (case-sensitive).
  2. Password field is non-empty (for email/password users).
- For OAuth users without a password: the password field is replaced with an "Re-authenticate with {provider}" button that triggers the OAuth re-auth flow (see Section 9.1).
- "Cancel" button closes the dialog with no side effects.
- While the deletion request is in flight, "Confirm Deletion" shows a loading spinner and is disabled.
- On error, display the error message inline below the password field in `text-destructive`.
- On success, redirect to `/goodbye`.

**Subscription notice:** Only shown if the user has `subscription_tier != 'free'`. The frontend checks the user's tier from the auth context / user profile.

**Broker notice:** Only shown if the user has at least one broker connection with `status = 'connected'`. The frontend fetches this from the existing broker connections endpoint.

### 6.3 Goodbye Page

**Route:** `/goodbye`

**Access:** Public (no authentication required). Shown after successful deletion request.

```
┌──────────────────────────────────────────────────────┐
│                                                      │
│            Your account has been scheduled            │
│                  for deletion.                        │
│                                                      │
│  You will receive a confirmation email shortly.      │
│                                                      │
│  Changed your mind? You can log in within the        │
│  next 30 days to restore your account.               │
│                                                      │
│  [Return to login]                                   │
│                                                      │
└──────────────────────────────────────────────────────┘
```

**Styling:**
- Centered layout, max-width 480px.
- Heading uses `text-xl font-semibold`.
- Body text uses `text-muted-foreground`.
- "Return to login" is a `variant="outline"` button linking to `/auth/login`.
- No sidebar or header (standalone page layout, like the login page).

### 6.4 Grace Period Restoration Prompt

**Trigger:** Shown after successful login when `users.deleted_at IS NOT NULL` and within 30 days.

**Implementation:** The frontend detects the `X-Account-Status: pending_deletion` response header (set by backend middleware on all authenticated responses for pending-deletion users) and renders a full-screen interstitial before the dashboard.

```
┌──────────────────────────────────────────────────────┐
│                                                      │
│          Your account is scheduled for               │
│              deletion on March 14, 2026.             │
│                                                      │
│  Would you like to restore your account?             │
│  All your data is still intact.                      │
│                                                      │
│  [Restore Account]    [Continue with Deletion]       │
│   (primary button)     (ghost button)                │
│                                                      │
│  28 days remaining until permanent deletion.         │
│                                                      │
└──────────────────────────────────────────────────────┘
```

**Behavior:**
- "Restore Account" calls `POST /api/v1/account/restore`, then redirects to `/dashboard`.
- "Continue with Deletion" dismisses the interstitial and proceeds to the dashboard with a persistent banner.
- The user's choice is stored in session storage (`dismissedRestorationPrompt: true`) so the interstitial is only shown once per login session. The banner persists regardless.

**Persistent banner (shown on all dashboard pages during `pending_deletion`):**

```
┌──────────────────────────────────────────────────────┐
│ ⚠ Your account is scheduled for deletion on          │
│   March 14, 2026. [Restore Account]                  │
└──────────────────────────────────────────────────────┘
```

- Banner uses `bg-destructive/10 text-destructive border-destructive/20`.
- "Restore Account" link calls the restore endpoint.
- Banner is shown at the top of the main content area, below the header.

---

## 7. Email Templates

All emails are sent via SendGrid using the existing transactional email infrastructure. Emails are dispatched from Celery tasks on the `notifications` queue.

### 7.1 Deletion Scheduled

**Trigger:** Dispatched by `process_deletion_side_effects` task after soft delete.

**Subject:** Your TrendEdge account is scheduled for deletion

**From:** TrendEdge <noreply@trendedge.io>

**Body (plain text):**

```
Hi {display_name},

Your TrendEdge account has been scheduled for deletion. All your data will
be permanently removed on {deletion_date}.

If this was a mistake, you can restore your account by logging in within
the next 30 days at https://app.trendedge.io/auth/login.

After {deletion_date}, this action cannot be reversed.

What will be deleted:
- All trades, orders, and positions
- Journal entries and playbooks
- Trendlines, signals, and alerts
- Broker connections and API keys
- Account settings and preferences

If you did not request this deletion, please contact support immediately
at support@trendedge.io.

Best regards,
The TrendEdge Team
```

**Variables:**
- `{display_name}`: `users.display_name` or "there" if NULL.
- `{deletion_date}`: `users.deleted_at + 30 days`, formatted as "March 14, 2026".

### 7.2 Account Restored

**Trigger:** Dispatched after successful account restoration.

**Subject:** Your TrendEdge account has been restored

**Body (plain text):**

```
Hi {display_name},

Your TrendEdge account has been restored. All your data is intact.

Please note:
- Broker connections were disconnected during the deletion request.
  You will need to re-connect your brokers from Settings > Broker Connections.
- If you had an active subscription, it was cancelled. You can re-subscribe
  from Settings > Billing.

If you have any questions, contact us at support@trendedge.io.

Best regards,
The TrendEdge Team
```

### 7.3 Hard Delete Complete

**Trigger:** Dispatched after successful hard deletion (step 14 of Section 3.3).

**Subject:** Your TrendEdge account has been permanently deleted

**Body (plain text):**

```
Hi,

Your TrendEdge account and all associated data have been permanently
deleted. This action cannot be reversed.

The following data was removed:
- Account profile and settings
- All trading data (signals, orders, positions)
- Trendlines and detection configurations
- Broker connections and API keys
- Audit logs and activity history

A record of this deletion has been retained for compliance purposes.
No personally identifiable information is included in this record.

If you wish to use TrendEdge in the future, you are welcome to create
a new account at https://app.trendedge.io.

Best regards,
The TrendEdge Team
```

**Note:** This email is sent to the email address captured before deletion (step 3 of Section 3.3). The display name is not used in the greeting because user data has already been deleted at this point.

---

## 8. Security

### 8.1 Re-Authentication

Account deletion is a high-risk action. The following re-authentication requirements apply:

| User Type | Re-Auth Method | Implementation |
|---|---|---|
| Email/password user | Enter current password | Backend calls `supabase.auth.sign_in_with_password(email, password)` to verify |
| Google OAuth user (no password set) | Re-authenticate via Google | Frontend triggers `supabase.auth.signInWithOAuth({ provider: 'google' })` with a redirect back to the deletion flow; backend validates the resulting fresh session timestamp |
| GitHub OAuth user (no password set) | Re-authenticate via GitHub | Same as Google, with `provider: 'github'` |
| Magic link user (no password set) | Re-authenticate via magic link | Frontend triggers `supabase.auth.signInWithOtp({ email })`, user clicks link, returns to deletion flow |
| User with password + OAuth | Enter current password (password takes precedence) | Same as email/password user |

**Session freshness check:** The backend verifies that the user's last authentication timestamp (`auth.users.last_sign_in_at`) is within 5 minutes of the deletion request. If not, the request is rejected with 401 and the frontend must trigger re-authentication.

### 8.2 Rate Limiting

| Endpoint | Limit | Window | Key |
|---|---|---|---|
| `POST /api/v1/account/delete` | 3 requests | 1 hour | `ratelimit:account_delete:{user_id}` |
| `POST /api/v1/account/restore` | 5 requests | 1 hour | `ratelimit:account_restore:{user_id}` |
| `GET /api/v1/account/deletion-status` | 30 requests | 1 minute | `ratelimit:deletion_status:{user_id}` |

Rate limiting uses the existing Redis sliding window implementation (sorted sets, as defined in FSD-001).

### 8.3 Session Revocation

On successful deletion request:
1. Backend calls `supabase.auth.admin.sign_out(user_id, scope='global')` to revoke all active sessions across all devices.
2. The user's current session (used to make the deletion request) is also invalidated.
3. Any existing refresh tokens for the user are invalidated.
4. The user is redirected to `/goodbye` (a public page that does not require authentication).

### 8.4 API Key Deactivation

On soft delete:
- All active API keys are deactivated: `UPDATE api_keys SET is_active = false, deactivated_by = 'deletion' WHERE user_id = :user_id AND is_active = true`.
- The `deactivated_by = 'deletion'` marker allows selective re-activation on restoration (only keys deactivated by the deletion process are re-activated; keys the user manually deactivated before deletion remain inactive).

On restoration:
- `UPDATE api_keys SET is_active = true, deactivated_by = NULL WHERE user_id = :user_id AND deactivated_by = 'deletion'`.

### 8.5 Redis Lock Strategy

Two locks prevent race conditions:

| Lock | Key | TTL | Purpose |
|---|---|---|---|
| Deletion request lock | `lock:account_deletion:{user_id}` | 30 seconds | Prevents concurrent soft-delete requests for the same user |
| Hard deletion lock | `lock:hard_deletion:{user_id}` | 120 seconds | Prevents concurrent hard-delete executions for the same user |
| Purge task lock | `lock:purge_deleted_accounts` | 600 seconds | Prevents concurrent Beat task executions |

All locks use Redis SET with NX and PX (set-if-not-exists with millisecond expiry) to ensure atomicity.

---

## 9. Edge Cases

### 9.1 OAuth Users Without Password

Users who registered via Google or GitHub OAuth and never set a password cannot provide a password for re-authentication.

**Detection:** The backend checks `auth.users.encrypted_password` for the user. If NULL or empty, the user is an OAuth-only user.

**Flow:**
1. Frontend displays the confirmation dialog without a password field.
2. Instead, a "Re-authenticate with {provider}" button is shown (where `{provider}` is derived from `auth.users.raw_app_meta_data.provider`).
3. User clicks the button, triggering `supabase.auth.signInWithOAuth({ provider })`.
4. After OAuth redirect back, the frontend checks that `auth.users.last_sign_in_at` is within 5 minutes.
5. Frontend sends `POST /api/v1/account/delete` with `oauth_token` field set to the fresh access token from the OAuth re-auth.
6. Backend verifies the token is valid and fresh (issued within 5 minutes).

**Error:** If the OAuth provider is unavailable, the user cannot delete their account. They should contact support. The error message is: "Unable to connect to {provider} for re-authentication. Please try again later or contact support."

### 9.2 Users with Active Subscriptions

**Detection:** Check `users.subscription_tier != 'free'` and/or query Stripe for active subscriptions.

**Behavior:**
1. The confirmation dialog shows the subscription cancellation notice (Section 6.2).
2. On soft delete, the `process_deletion_side_effects` task cancels the Stripe subscription.
3. If Stripe integration is not yet implemented (PRD-009 not delivered), the task logs an INFO message and skips the cancellation step. The subscription field on the user is irrelevant after hard deletion.
4. No prorated refund is issued for the current billing period (stated in terms of service).

### 9.3 Users with Active Broker Connections

**Detection:** Query `broker_connections WHERE user_id = :uid AND status = 'connected'`.

**Behavior:**
1. The confirmation dialog shows the broker disconnection notice (Section 6.2).
2. On soft delete, the `process_deletion_side_effects` task disconnects all broker connections:
   - Tradovate: Revoke OAuth token via `POST /auth/logout` on Tradovate API.
   - IBKR: Send disconnect command if a worker is currently connected for this user.
   - All brokers: `UPDATE broker_connections SET status = 'disconnected'`.
3. Encrypted broker credentials are retained during the grace period (they are stored in `broker_connections.credentials`, which is not deleted until hard deletion).
4. On account restoration, broker connections are NOT automatically re-connected. The user must manually re-connect from Settings. This is because OAuth tokens have been revoked and IBKR sessions are transient.

### 9.4 Concurrent Deletion Requests

**Scenario:** User clicks "Confirm Deletion" twice in rapid succession, or the same user sends the request from two browser tabs.

**Prevention:**
1. Frontend: The "Confirm Deletion" button is disabled immediately after the first click (loading spinner shown).
2. Backend: Redis lock (`lock:account_deletion:{user_id}`, TTL 30s) acquired before processing. Second request fails with 409 `CONFLICT`.
3. Database: The UPDATE statement includes `WHERE deleted_at IS NULL`, so even if the lock fails, the second update affects 0 rows and the backend returns 409.

### 9.5 Deletion During Active Trade

**Scenario:** User has an open position with a live broker when requesting deletion.

**Behavior:**
1. The deletion request proceeds -- there is no guard that blocks deletion for users with open positions. The user has explicitly confirmed they want to delete.
2. The `process_deletion_side_effects` task disconnects broker connections, which will prevent new order submissions.
3. Open positions on the broker side are NOT automatically closed by TrendEdge. The position remains open on the broker's platform.
4. The confirmation dialog includes a warning when open positions are detected: "You have {n} open position(s). TrendEdge will disconnect your broker but will NOT close open positions. You must manage open positions directly with your broker."
5. This warning is derived from querying `positions WHERE user_id = :uid AND status = 'open'`.

### 9.6 Hard Deletion Failure (Partial)

**Scenario:** The hard deletion transaction fails partway through (e.g., database error, connection drop).

**Behavior:**
1. The entire transaction rolls back (all 17 DELETE statements are within one transaction).
2. No data is lost -- the user remains in `pending_deletion` state.
3. The error is logged with full context (user_id, table that failed, error message).
4. On the next daily run (03:00 UTC), the task retries the deletion for this user.
5. After 3 consecutive failures, a CRITICAL alert is sent via Sentry. Manual intervention may be required.

### 9.7 User Logs In After Grace Period But Before Purge Task

**Scenario:** It is day 31 but the 03:00 UTC purge task hasn't run yet. User logs in.

**Behavior:**
1. The user can still log in (auth record exists, sessions can be created).
2. The backend checks `deleted_at` and computes remaining days: `30 - (NOW() - deleted_at).days`.
3. If `days_remaining <= 0`, the restoration prompt shows: "Your account is past the grace period and will be permanently deleted within 24 hours. Restoration is no longer available."
4. The "Restore Account" button is disabled.
5. The `POST /api/v1/account/restore` endpoint returns 410 `GONE` if `deleted_at < NOW() - INTERVAL '30 days'`.

---

## 10. Testing Specifications

### 10.1 Unit Tests

| Test ID | Component | Test Case | Expected Result |
|---|---|---|---|
| UT-DEL-001 | `AccountDeleteRequest` validator | `confirmation="DELETE"` | Passes validation |
| UT-DEL-002 | `AccountDeleteRequest` validator | `confirmation="delete"` | Raises `ValueError` |
| UT-DEL-003 | `AccountDeleteRequest` validator | `confirmation=""` | Raises `ValueError` |
| UT-DEL-004 | `AccountDeleteRequest` validator | `confirmation="DELETE "` (trailing space) | Raises `ValueError` |
| UT-DEL-005 | `DeletionStatusResponse` | Active account (deleted_at=None) | `status="active"`, `deletion_scheduled=false` |
| UT-DEL-006 | `DeletionStatusResponse` | Pending account (deleted_at=15 days ago) | `status="pending_deletion"`, `days_remaining=15` |
| UT-DEL-007 | Deletion cascade order | Verify FK dependency ordering | No FK violation when executed in order |
| UT-DEL-008 | Anonymized hash computation | `SHA-256(user_id + email + salt)` | Deterministic, not reversible without salt |
| UT-DEL-009 | Grace period calculation | `deleted_at = NOW() - 29 days` | `days_remaining = 1`, restoration allowed |
| UT-DEL-010 | Grace period calculation | `deleted_at = NOW() - 31 days` | `days_remaining = 0`, restoration blocked |

### 10.2 Integration Tests

| Test ID | Scenario | Setup | Steps | Expected Result | PRD Ref |
|---|---|---|---|---|---|
| IT-DEL-001 | Successful deletion request | Active user, valid password | POST /api/v1/account/delete with valid payload | 200, `deleted_at` set, sessions revoked, API keys deactivated | CS-TEST-010 |
| IT-DEL-002 | Wrong confirmation string | Active user | POST with `confirmation="delete"` | 422, `deleted_at` remains NULL | CS-TEST-010 |
| IT-DEL-003 | Wrong password | Active user | POST with invalid password | 401, `deleted_at` remains NULL | CS-TEST-010 |
| IT-DEL-004 | Already pending deletion | User with `deleted_at` set | POST /api/v1/account/delete | 409, no state change | CS-TEST-010 |
| IT-DEL-005 | Deletion with active subscription | User with `subscription_tier='pro'`, mock Stripe | POST /api/v1/account/delete | 200, Stripe cancel called, deletion proceeds | CS-TEST-010 |
| IT-DEL-006 | Deletion with broker connections | User with 2 connected brokers | POST /api/v1/account/delete | 200, both brokers disconnected | CS-TEST-010 |
| IT-DEL-007 | Login during grace period | User with `deleted_at` 15 days ago | Authenticate, GET any protected endpoint | Response includes `X-Account-Status: pending_deletion` | CS-TEST-011 |
| IT-DEL-008 | Account restoration | User with `deleted_at` 15 days ago | POST /api/v1/account/restore | 200, `deleted_at` cleared, API keys re-activated | CS-TEST-011 |
| IT-DEL-009 | Grace period expiry | User with `deleted_at` 31 days ago | Run `purge_deleted_accounts` task | All data deleted from all tables, audit log created | CS-TEST-011 |
| IT-DEL-010 | Post-hard-delete login | User after hard deletion | Attempt authentication | Authentication fails (auth record removed) | CS-TEST-011 |
| IT-DEL-011 | Data completeness verification | After hard delete | Query all 17 user-owned tables for user_id | 0 rows in each table | CS-TEST-012 |
| IT-DEL-012 | Auth record removal | After hard delete | Query `auth.users` for user_id | 0 rows | CS-TEST-012 |
| IT-DEL-013 | R2 file cleanup | After hard delete, user had avatar | Check R2 for `avatars/{user_id}.*` | 404 Not Found | CS-TEST-012 |
| IT-DEL-014 | Deletion audit log created | After hard delete | Query `deletion_audit_log` for anonymized_hash | 1 row with correct categories and table_counts | CS-TEST-012 |
| IT-DEL-015 | Rate limiting on delete endpoint | Active user | Send 4 requests within 1 hour | 4th request returns 429 | -- |
| IT-DEL-016 | Concurrent deletion requests | Active user | Send 2 simultaneous POST /api/v1/account/delete | One succeeds (200), other fails (409) | -- |
| IT-DEL-017 | Read-only enforcement | User in `pending_deletion` | POST /api/v1/signals | 403 FORBIDDEN | -- |

### 10.3 E2E Tests

| Test ID | Scenario | Steps | Expected Result | PRD Ref |
|---|---|---|---|---|
| E2E-DEL-001 | Full deletion flow | Navigate to /settings/account, click delete, type DELETE, enter password, confirm | Redirected to /goodbye, email received | CS-AC-010, CS-AC-012 |
| E2E-DEL-002 | Restoration flow | Soft-delete account, log in, see restoration prompt, click Restore | Redirected to /dashboard, data accessible | CS-AC-013, CS-AC-014 |
| E2E-DEL-003 | Disabled confirm button | Open deletion dialog, type "delete" (lowercase) | Confirm button remains disabled | CS-AC-010 |
| E2E-DEL-004 | Goodbye page | Complete deletion flow | /goodbye page shown with correct messaging, "Return to login" link works | CS-AC-010 |
| E2E-DEL-005 | Grace period banner | Soft-delete, log in, dismiss restoration prompt | Persistent banner visible on dashboard pages | -- |
| E2E-DEL-006 | OAuth user deletion | OAuth user (no password), open deletion dialog | "Re-authenticate with Google" button shown instead of password field | -- |

---

## 11. Compliance

### 11.1 GDPR Article 17 Mapping

| Article 17 Clause | TrendEdge Implementation |
|---|---|
| 17(1)(a): Data subject withdraws consent | Account deletion initiated by user from `/settings/account` |
| 17(1)(b): Data no longer necessary | After account deletion, no user data is retained except the anonymized audit log |
| 17(2): Controller shall inform other controllers | Stripe subscription cancelled; broker OAuth tokens revoked; R2 files deleted |
| 17(3)(b): Compliance with legal obligation | `deletion_audit_log` retained for 2 years (financial services record-keeping) |
| 17(3)(e): Legal claims | The 30-day grace period allows reversal; after hard deletion, only the anonymized audit log remains |

### 11.2 Deletion Audit Log Retention

- **Retention period:** 2 years from `deleted_at` timestamp.
- **Cleanup:** A separate Celery Beat task (`cleanup_deletion_audit_log`) runs monthly at 03:00 UTC on the 1st of each month. It deletes records where `deleted_at < NOW() - INTERVAL '2 years'`.
- **Access:** Service role only. No RLS policy (table has no `user_id` column). Read access limited to admin users via an admin API endpoint (not specified in this FSD; deferred to FSD-008d admin tools).
- **Immutability:** Application code never issues UPDATE or DELETE on this table (except the 2-year cleanup task). PostgreSQL policies can enforce this if needed, but the primary enforcement is at the application layer.

### 11.3 Data Categories

The `deletion_audit_log.categories` array records which categories of data were deleted. This provides compliance officers with a summary without storing any PII.

| Category | Tables Included |
|---|---|
| `account` | `users` |
| `auth` | `auth.users` |
| `trading` | `signals`, `orders`, `order_events`, `positions` |
| `risk` | `risk_check_audits`, `user_risk_settings`, `risk_settings_changelog` |
| `trendlines` | `trendlines`, `trendline_events` |
| `alerts` | `alerts` |
| `detection_config` | `user_detection_config`, `user_watchlist` |
| `broker` | `broker_connections` |
| `api_keys` | `api_keys`, `webhook_urls` |
| `audit` | `audit_logs` |
| `storage` | R2 files (avatars, exports) |

---

*This document is FSD-012b of the TrendEdge platform. It specifies the GDPR-compliant account deletion lifecycle as part of the PRD-012 Completion Sweep. Source requirements: CS-FR-020 through CS-FR-024, CS-TEST-010 through CS-TEST-012, CS-AC-010 through CS-AC-018.*
