# FSD-003d: Order Construction & Lifecycle

**TrendEdge -- AI-Powered Futures Trading Platform**

| Field | Value |
|---|---|
| FSD ID | FSD-003d |
| Source FSD | FSD-003 (Trade Execution) |
| Title | Order Construction & Lifecycle |
| Version | 1.0 |
| Status | Draft |
| Author | Generated by Claude |
| Created | 2026-02-11 |

---

## 1. Introduction

### 1.1 Purpose

This sub-FSD specifies the complete order lifecycle for TrendEdge: bracket order construction from validated signals, quantity calculation, the order state machine, OCO group management, position tracking, fill reconciliation, and manual override operations. It provides all behavioral detail necessary for implementation.

### 1.2 Scope

- **Bracket Order Construction**: Building entry + stop loss + take profit as linked OCO groups from risk-approved signals.
- **Quantity Calculation**: Risk-based position sizing with configurable fixed-risk parameters.
- **Safety Line Stop Loss & S/R Take Profit**: Specialized logic for internal engine signals.
- **Order State Machine**: All states, valid transitions, side effects, and terminal conditions.
- **OCO Group Management**: Automatic cancellation of paired orders on fill.
- **Position Management**: Real-time position tracking, MAE/MFE calculation, P&L computation.
- **Fill Reconciliation**: Detecting and resolving discrepancies between broker and internal records.
- **Manual Overrides**: Order cancellation, modification, position close, and emergency flatten-all.
- **Order Metadata & Traceability**: Full signal-to-order-to-position linkage.

### 1.3 Out of Scope

- Signal ingestion, normalization, and validation [see FSD-003a]
- Risk management engine (pre-trade risk checks) [see FSD-003b]
- Broker adapter implementations (IBKR, Tradovate, Paper Simulator) [see FSD-003c]
- Trade journaling [see FSD-004]
- Analytics and playbook computation [see FSD-005]

### 1.4 Glossary

| Term | Definition |
|---|---|
| Bracket Order | An entry order with attached stop loss and take profit orders linked as an OCO group. |
| OCO | One-Cancels-Other: when one order in the group fills, the other is automatically cancelled. |
| R-Multiple | Net P&L divided by planned risk per trade; 1R = risk amount, 2R = twice the risk amount. |
| MAE | Maximum Adverse Excursion: the worst unrealized loss during a trade's lifetime. |
| MFE | Maximum Favorable Excursion: the best unrealized profit during a trade's lifetime. |
| Safety Line | The opposing trendline projected forward, used as a stop loss reference point. |
| Slippage | The difference between the intended order price and the actual fill price. |

---

## 2. Functional Specifications

### 2.1 EX-FR-023: Bracket Order Construction

**Source**: PRD-003 Section 3.5

**Description**: For each signal that passes all risk checks (status = `RISK_PASSED`), the system constructs a bracket order group consisting of an entry order, a stop loss order, and a take profit order.

**Processing Logic**:

1. Generate a `bracket_group_id` (UUID) to link the three orders.
2. **Entry Order**:
   - `order_type`: `MARKET` or `LIMIT` (from signal `entry_type`).
   - `side`: `BUY` for LONG, `SELL` for SHORT.
   - `price`: for LIMIT orders, set to `signal.entry_price`. For MARKET, null.
   - `quantity`: from signal (or calculated by EX-FR-026).
   - `time_in_force`: configurable per user (default: `GTC`; options: `DAY`, `GTC`, `GTD`).
   - `bracket_role`: `ENTRY`.
   - `status`: `CONSTRUCTED`.
3. **Stop Loss Order**:
   - `order_type`: `STOP` (default stop-market) or `STOP_LIMIT` (user-configurable via `user_risk_settings.stop_type`).
   - `side`: `SELL` for LONG (closing the position), `BUY` for SHORT.
   - `stop_price`: `signal.stop_loss_price`.
   - `price`: for `STOP_LIMIT`, set to `stop_price - (2 * tick_size)` for sells, `stop_price + (2 * tick_size)` for buys (2-tick limit offset from stop price).
   - `quantity`: same as entry.
   - `bracket_role`: `STOP_LOSS`.
   - `status`: `CONSTRUCTED`.
4. **Take Profit Order**:
   - `order_type`: `LIMIT`.
   - `side`: `SELL` for LONG, `BUY` for SHORT.
   - `price`: `signal.take_profit_price`.
   - `quantity`: same as entry.
   - `bracket_role`: `TAKE_PROFIT`.
   - `status`: `CONSTRUCTED`.
5. All three orders share the same `bracket_group_id`.
6. The stop loss and take profit are linked as an OCO pair: when one fills, the system cancels the other.
7. Persist all three orders to the `orders` table.
8. Update signal status to `EXECUTING`.

**Outputs**:
- Three `Order` records in the `orders` table with `status = 'CONSTRUCTED'` and a shared `bracket_group_id`.
- Signal status updated to `EXECUTING`.

**Business Rules**:
- The bracket group is always constructed as a unit. If any order fails to persist, the entire group is rolled back.
- The entry order is the parent. Stop loss and take profit are child orders that depend on the entry filling.
- Stop loss and take profit orders are NOT submitted to the broker until the entry order fills.
- The `client_order_id` (UUID) on each order is generated by TrendEdge and sent to the broker for correlation.

**Error Handling**:

| Error Condition | System Behavior |
|---|---|
| Database write failure during order construction | Retry 3 times with 1s delay. If all retries fail, set signal status to `REJECTED` with reason `"Order construction failed: database error"`. Log CRITICAL. |
| Signal missing stop_loss_price | Use default stop distance via EX-FR-024 (for INTERNAL signals) or reject signal for WEBHOOK/MANUAL sources if minimum R:R > 0. |
| Signal missing take_profit_price | Use default take profit via EX-FR-025 (for INTERNAL signals) or construct without take profit order for WEBHOOK/MANUAL sources if minimum R:R = 0. |

---

### 2.2 EX-FR-024: Safety Line Stop Loss Calculation

**Source**: PRD-003 Section 3.5

**Description**: For internal engine signals, the stop loss price is derived from the safety line (opposing trendline projected forward). If not available, a fallback default is used.

**Processing Logic**:

1. The stop loss price is the `safety_line_price` value provided in the signal payload (the opposing trendline projected forward by 4 candles).
2. If `safety_line_price` is null or missing, fall back to default stop distance:
   - Micro index futures (MNQ, MES, MYM, M2K): 20 ticks from entry.
   - Micro metals/energy (MGC, MCL, SIL): 10 ticks from entry.
3. Calculate fallback stop: for LONG, `entry_price - (default_ticks * tick_size)`. For SHORT, `entry_price + (default_ticks * tick_size)`.

**Business Rules**:
- The fallback stop distances are configurable in the `contract_specifications` reference data but default to the values above.
- For WEBHOOK and MANUAL signals, the stop loss comes directly from the signal payload. This function only applies to INTERNAL signals missing a stop.

---

### 2.3 EX-FR-025: Take Profit at Support/Resistance

**Source**: PRD-003 Section 3.5

**Description**: For internal engine signals, the take profit price is selected from candidate S/R levels that satisfy the minimum R:R requirement.

**Processing Logic**:

1. The signal payload includes an array of `candidate_sr_levels` (support/resistance prices from the trendline engine).
2. For each level, compute the reward: `abs(level - entry_price) / tick_size * tick_value`.
3. Compute the risk: `abs(entry_price - stop_loss_price) / tick_size * tick_value`.
4. Select the first level (closest to entry) that provides reward >= 2R.
5. If no qualifying level exists, use default: `take_profit_price = entry_price + (stop_distance * 2.5)` for LONG (inverted for SHORT), where `stop_distance = abs(entry_price - stop_loss_price)`.

**Business Rules**:
- The 2R minimum for S/R level selection respects the user's configured `min_risk_reward_ratio` from `user_risk_settings`. [Cross-reference: FSD-003b for risk parameter details]
- If the user's minimum R:R is set to 3.0, the S/R level must provide >= 3R.
- The default 2.5x multiplier is used only when no candidate S/R levels satisfy the minimum.

---

### 2.4 EX-FR-026: Order Quantity Calculation

**Source**: PRD-003 Section 3.5

**Description**: When the signal does not specify a quantity, the system calculates the number of contracts based on the user's fixed risk per trade and the stop distance.

**Processing Logic** (when `signal.quantity` is null):

1. Retrieve user's fixed risk per trade from `user_risk_settings.fixed_risk_per_trade` (default: $100).
2. Retrieve `tick_size` and `tick_value` from `contract_specifications` for the signal's instrument.
3. Calculate stop distance in ticks: `stop_distance_ticks = abs(entry_price - stop_loss_price) / tick_size`.
4. Calculate risk per contract: `risk_per_contract = stop_distance_ticks * tick_value`.
5. Calculate quantity: `floor(fixed_risk / risk_per_contract)`.
6. Clamp to maximum position size: `min(quantity, max_position_size - existing_position)`. [Cross-reference: FSD-003b EX-FR-016 for max position size]
7. Enforce minimum quantity of 1: `max(quantity, 1)`.
8. If `risk_per_contract > fixed_risk`, quantity is 1 and a warning is logged: `"Risk per contract (${risk_per_contract}) exceeds fixed risk per trade (${fixed_risk}). Proceeding with minimum quantity of 1."`.

**Example**:
- User fixed risk: $100. MNQ stop distance: 40 ticks. MNQ tick value: $0.50.
- Risk per contract: 40 * $0.50 = $20.
- Quantity: floor(100 / 20) = 5.
- If max position size is 2: quantity = 2.

**Edge Cases**:
- Stop distance is 0 (entry equals stop): this should be caught earlier by price validation [FSD-003a EX-FR-013], but if it reaches here, set quantity to 0 and reject the signal with `"Cannot calculate quantity: stop distance is zero"`.
- `max_position_size - existing_position <= 0`: rejected earlier by position size risk check [FSD-003b EX-FR-016], but if reached here, reject with `"No remaining position capacity"`.

---

### 2.5 EX-FR-027: Order Metadata Attachment

**Source**: PRD-003 Section 3.5

**Description**: Each order record carries full traceability metadata linking it back to the originating signal and trendline.

**Metadata Fields on Each Order**:

| Field | Source | Description |
|---|---|---|
| `signal_id` | Signal record | Links order to the originating signal |
| `user_id` | Signal record | Owner of the order |
| `broker` | Broker routing | Adapter name (IBKR, TRADOVATE, PAPER) |
| `order_type` | Construction logic | MARKET, LIMIT, STOP, STOP_LIMIT |
| `side` | Signal direction | BUY or SELL |
| `instrument` | Signal (resolved) | Specific contract symbol (e.g., MNQH6) |
| `quantity` | Calculated or signal | Number of contracts |
| `price` | Signal/construction | Limit price (null for market orders) |
| `stop_price` | Signal | Stop trigger price |
| `bracket_group_id` | Generated | UUID linking the bracket group |
| `bracket_role` | Construction logic | ENTRY, STOP_LOSS, or TAKE_PROFIT |
| `client_order_id` | Generated | UUID for broker correlation |
| `is_paper` | User settings | Whether this is a paper trade |

This metadata enables full traceability from any order back to the originating signal and trendline.

---

## 3. Order State Machine

### 3.1 EX-FR-044: States and Transitions

**States**:

| State | Type | Description |
|---|---|---|
| `CONSTRUCTED` | Initial | Order created in TrendEdge, not yet sent to broker |
| `SUBMITTED` | Active | Sent to broker adapter, awaiting acknowledgment |
| `PENDING` | Active | Broker acknowledged, order is working (limit/stop waiting to trigger) |
| `PARTIAL_FILL` | Active | Part of the order quantity has been filled |
| `FILLED` | Terminal (for entry), Active (for exit tracking) | Full quantity filled |
| `REJECTED` | Terminal | Broker rejected the order |
| `CANCELLED` | Terminal | Order cancelled (user, OCO, or system) |
| `CLOSED` | Terminal | Position fully exited (applies to FILLED entry orders after position close) |

### 3.2 State Machine Diagram

```
                        +-------------+
                        | CONSTRUCTED |
                        +------+------+
                               |
                         place_order()
                               |
                        +------v------+
                   +--->| SUBMITTED   |<---+
                   |    +------+------+    |
                   |           |           |
                   |     +-----+-----+    |
                   |     |           |    |
                   |     v           v    |
              +----+-----+   +------+----+-+
              | REJECTED  |   | PENDING     |
              | (terminal)|   +------+------+
              +-----------+          |
                               +-----+-----+
                               |           |
                               v           v
                        +------+------+ +--+--------+
                        | PARTIAL_FILL| | CANCELLED  |
                        +------+------+ | (terminal) |
                               |        +-----------+
                               v
                        +------+------+
                        | FILLED      |
                        +------+------+
                               |
                         position exit
                               |
                        +------v------+
                        | CLOSED      |
                        | (terminal)  |
                        +-------------+
```

### 3.3 Valid State Transitions

| From | To | Trigger | Side Effects |
|---|---|---|---|
| CONSTRUCTED | SUBMITTED | `place_order()` called on broker adapter | `submitted_at` set, `order_events` record created |
| SUBMITTED | PENDING | Broker acknowledges order (limit/stop working) | `order_events` record created |
| SUBMITTED | FILLED | Market order filled immediately | `filled_at` set, fill details recorded, position created/updated |
| SUBMITTED | REJECTED | Broker rejects order | `rejection_reason` set, signal status updated, user notified |
| PENDING | FILLED | Limit/stop price reached and filled | Same as SUBMITTED->FILLED |
| PENDING | PARTIAL_FILL | Part of quantity filled | Partial fill details recorded |
| PENDING | CANCELLED | User cancels, OCO triggers, circuit breaker | `cancelled_at` set, cancel reason logged |
| PARTIAL_FILL | FILLED | Remaining quantity filled | Same as PENDING->FILLED |
| PARTIAL_FILL | CANCELLED | User cancels remaining quantity | Partial position may exist |
| FILLED | CLOSED | Position fully exited (SL, TP, manual close) | `exit_reason` set, journal entry created |

### 3.4 Order Event Logging

Every state transition is persisted to the `order_events` table with:
- `previous_state`: the state before the transition
- `new_state`: the state after the transition
- `broker_order_id`: the broker's identifier for the order
- `fill_price`: if the transition involves a fill
- `fill_quantity`: if the transition involves a fill
- `commission`: if reported by the broker
- `rejection_reason`: if the transition is to REJECTED
- `raw_broker_response`: the complete broker response as JSONB
- `created_at`: timestamp of the event

**Business Rules**:
- Invalid state transitions are rejected and logged as ERROR. For example, a CANCELLED order cannot transition to FILLED.
- If a broker event arrives for an already-terminal order, the event is logged but the state is not changed. A WARNING is logged.
- Order events are append-only. They are never updated or deleted.

---

## 4. OCO Group Management

### 4.1 EX-FR-046: OCO Lifecycle

**Description**: Within a bracket order group, the stop loss and take profit orders form an OCO (One-Cancels-Other) pair. When one fills, the system automatically cancels the other.

**Processing Logic**:

1. **When stop loss fills**:
   a. Set stop loss order status to `FILLED` with fill details.
   b. Cancel the take profit order via the broker adapter.
   c. Set take profit order status to `CANCELLED` with cancel reason `OCO_TRIGGERED`.
   d. Close the position with `exit_reason = 'STOP_LOSS'`.
   e. Calculate realized P&L, R-multiple, slippage, and commissions.
   f. Emit `trade.closed` event for journal and analytics services. [Cross-reference: FSD-004, FSD-005]
   g. Notify user via WebSocket and notification service. [Cross-reference: FSD-010]

2. **When take profit fills**:
   a. Set take profit order status to `FILLED` with fill details.
   b. Cancel the stop loss order via the broker adapter.
   c. Set stop loss order status to `CANCELLED` with cancel reason `OCO_TRIGGERED`.
   d. Close the position with `exit_reason = 'TAKE_PROFIT'`.
   e. Calculate realized P&L, R-multiple, slippage, and commissions.
   f. Emit `trade.closed` event for journal and analytics services.
   g. Notify user via WebSocket and notification service.

3. **When entry order is rejected or cancelled**:
   a. Cancel both stop loss and take profit orders (they were not yet submitted to the broker since they depend on entry fill).
   b. Set both to `CANCELLED` with cancel reason `ENTRY_REJECTED` or `ENTRY_CANCELLED`.
   c. Update signal status to `REJECTED` with reason from the broker.

**Edge Case -- Double Fill**:

If both stop loss and take profit fill due to a race condition (e.g., fast market with delayed cancel):
1. Detect the double fill: both exit orders have status `FILLED`.
2. Alert the user immediately via all notification channels: `"Double fill detected for position {id}. Both stop loss and take profit filled. Please check your broker account."`.
3. Log as CRITICAL with full order details.
4. Mark the position as CLOSED with a `discrepancy` flag in metadata.
5. The user must reconcile the extra position directly with the broker.

**Business Rules**:
- OCO cancellation is best-effort. The cancel request is sent to the broker, but the broker may have already filled the order. This is why double-fill detection exists.
- When the broker adapter cannot reach the broker to cancel (connection issue), the system retries the cancel 3 times with 1-second intervals. If all retries fail, a CRITICAL alert is sent to the user.
- For paper trading, OCO management is handled internally by the paper simulator with no race condition risk. [Cross-reference: FSD-003c EX-FR-039, EX-FR-040]

---

## 5. Position Management

### 5.1 Position Creation

When an entry order fills:

1. Create a `Position` record:
   - `user_id`: from the order.
   - `signal_id`: from the order.
   - `entry_order_id`: the filled entry order's ID.
   - `instrument`: from the order.
   - `direction`: `LONG` if entry side is BUY, `SHORT` if SELL.
   - `quantity`: fill quantity.
   - `entry_price`: fill price (actual, not the signal's intended price).
   - `stop_loss_price`: from the signal.
   - `take_profit_price`: from the signal.
   - `stop_loss_order_id`: the stop loss order's ID.
   - `take_profit_order_id`: the take profit order's ID.
   - `planned_risk`: `stop_distance_ticks * tick_value * quantity`.
   - `status`: `OPEN`.
   - `is_paper`: from the order.
   - `opened_at`: fill timestamp.

2. Submit stop loss and take profit orders to the broker (they were in CONSTRUCTED state, waiting for entry fill).

3. Begin position monitoring (MAE/MFE tracking, unrealized P&L updates).

### 5.2 Position Monitoring

For all OPEN positions, the system continuously tracks:

1. **Current Price**: Retrieved from market data cache (Redis key `market:price:{instrument}`). [Cross-reference: FSD-010 for market data]
2. **Unrealized P&L**:
   - For LONG: `(current_price - entry_price) / tick_size * tick_value * quantity`.
   - For SHORT: `(entry_price - current_price) / tick_size * tick_value * quantity`.
3. **MAE (Maximum Adverse Excursion)**:
   - Track the worst price seen relative to entry.
   - For LONG: `mae_ticks = max(0, (entry_price - lowest_price_seen) / tick_size)`.
   - `mae_dollars = mae_ticks * tick_value * quantity`.
4. **MFE (Maximum Favorable Excursion)**:
   - Track the best price seen relative to entry.
   - For LONG: `mfe_ticks = max(0, (highest_price_seen - entry_price) / tick_size)`.
   - `mfe_dollars = mfe_ticks * tick_value * quantity`.

**Update Frequency**:
- Paper positions: monitored by a polling loop every 5 seconds (configurable). [Cross-reference: FSD-003c EX-FR-040]
- Live positions: updated in real-time via broker WebSocket events.
- Dashboard updates: pushed via WebSocket as `position.updated` events.

### 5.3 Position Closing

A position is closed when:

| Exit Trigger | Exit Reason | Process |
|---|---|---|
| Stop loss order fills | `STOP_LOSS` | OCO cancels take profit. Position closed. |
| Take profit order fills | `TAKE_PROFIT` | OCO cancels stop loss. Position closed. |
| User clicks "Close" on dashboard | `MANUAL_CLOSE` | Market order submitted to close. Both SL and TP cancelled. |
| User clicks "Flatten All" | `FLATTEN_ALL` | Market order submitted to close. Both SL and TP cancelled. |
| Broker-initiated liquidation | `BROKER_LIQUIDATION` | Detected during fill reconciliation. Position marked closed. |

**On Position Close**:

1. Set position `status = 'CLOSED'`.
2. Set `closed_at` to the exit fill timestamp.
3. Set `exit_reason` to the appropriate value.
4. Calculate realized P&L:
   - For LONG: `realized_pnl = (exit_price - entry_price) / tick_size * tick_value * quantity`.
   - For SHORT: `realized_pnl = (entry_price - exit_price) / tick_size * tick_value * quantity`.
5. Calculate net P&L: `net_pnl = realized_pnl - commission_total`.
6. Calculate R-multiple: `r_multiple = net_pnl / planned_risk`.
7. Record final MAE and MFE values.
8. Update the entry order status to `CLOSED`.
9. Emit `trade.closed` event containing: position_id, signal_id, instrument, direction, entry_price, exit_price, realized_pnl, r_multiple, mae, mfe, exit_reason, trendline metadata (if available), risk check audit trail reference, and all order events. [Cross-reference: FSD-004, FSD-005]
10. Notify user via WebSocket (`position.closed` event) and notification service.

---

## 6. Fill Reconciliation

### 6.1 EX-FR-056-058: Reconciliation Process

**Description**: On every broker reconnection (and periodically during normal operation), the system reconciles internal order records with the broker's records.

**Processing Logic**:

1. **On Broker Reconnection**:
   a. Query the broker for all fills since the last known fill timestamp for this user.
   b. Compare each broker fill against the `orders` table.
   c. For each broker fill with no matching internal record: create the order_event, update order status, log as `RECONCILIATION_MISSING_FILL`.
   d. For each internal order that shows SUBMITTED/PENDING but the broker shows it as FILLED: update internal records to match.

2. **Discrepancy Detection**:

| Discrepancy Type | Detection | Action |
|---|---|---|
| Missing fill in TrendEdge | Broker reports fill; no matching order_event | Create order_event, update order status, update position, alert user |
| Extra fill in TrendEdge | Internal record shows fill; broker does not confirm | Flag as suspicious, alert user, do NOT reverse the internal record |
| Price difference > 1 tick | Broker fill price differs from internal fill price by > 1 tick | Log as WARNING, update internal record to match broker, recalculate slippage |
| Quantity mismatch | Broker fill quantity differs from internal record | Log as WARNING, update internal record to match broker |

3. **Slippage Calculation** (for every fill):
   - For entry orders: `slippage = fill_price - intended_price` (positive = adverse for BUY, negative = adverse for SELL).
   - `slippage_ticks = abs(slippage) / tick_size`.
   - `slippage_dollars = slippage_ticks * tick_value * quantity`.
   - Stored on the `orders` table: `slippage_ticks`, `slippage_dollars`.

4. **Commission Tracking**:
   - Commissions are recorded per order as reported by the broker.
   - If the broker does not report commissions in the fill event, use the fallback commission schedule:

| Broker | Instrument Type | Per-Contract Per-Side | Notes |
|---|---|---|---|
| IBKR | Micro futures | $0.62 | Default estimate (varies by volume tier: $0.25-$0.85) |
| IBKR | Full-size futures | $0.85 | Standard rate |
| Tradovate | Micro futures | $0.79 | Standard pricing |
| Tradovate | Full-size futures | $1.29 | Standard pricing |

   - Exchange fees (approximate, per side): CME: $0.27-$0.47, CBOT: $0.25-$0.45, NYMEX/COMEX: $0.25-$0.50.
   - Total commission per trade (round-trip) = (broker commission + exchange fees) * 2 sides * quantity.
   - Position `commission_total` accumulates all commissions from entry and exit fills.

**Business Rules**:
- Reconciliation runs automatically on broker reconnection and every 5 minutes during normal operation.
- All discrepancies are logged to `execution_audit_log` with event_type `RECONCILIATION_DISCREPANCY`.
- High-severity discrepancies (missing fills, price differences > 5 ticks) trigger immediate user notification.

---

## 7. Manual Overrides

### 7.1 EX-FR-052: Order Cancellation

**Endpoint**: `DELETE /api/v1/orders/{order_id}`

**Processing Logic**:

1. Authenticate the user. Verify the order belongs to the authenticated user.
2. Verify the order is in a cancellable state: `PENDING` or `PARTIAL_FILL`.
3. If the order is already `FILLED`, `CANCELLED`, `CLOSED`, or `REJECTED`, return HTTP 400: `{"error": "Order cannot be cancelled. Current status: {status}"}`.
4. Send cancel request to the broker adapter.
5. On broker confirmation: set order status to `CANCELLED`, set `cancelled_at`, create `order_events` record with cancel reason `USER_CANCELLED`.
6. If the cancelled order is part of a bracket group:
   - If cancelling the entry order (before fill): cancel the entire bracket group (entry, SL, TP).
   - If cancelling a SL or TP individually: log a warning -- the user is removing a risk level. The paired order remains active.
7. Log to `execution_audit_log`: event_type=`manual.cancel`, order_id, user_id, timestamp.

**Business Rules**:
- Users cannot cancel a FILLED order. To exit a position, they must use the "Close Position" action.
- Cancelling a stop loss leaves the position unprotected. The system displays a warning: `"Warning: Cancelling the stop loss will leave your position unprotected."` The cancellation proceeds if the user confirms.

### 7.2 EX-FR-053: Order Modification

**Endpoint**: `PATCH /api/v1/orders/{order_id}`

**Request Body** (all fields optional):

| Field | Type | Validation |
|---|---|---|
| `price` | Decimal | New limit price. Must pass price validation rules. |
| `stop_price` | Decimal | New stop trigger price. Must pass price validation rules. |
| `quantity` | Integer | Reduce only. Must be >= 1 and <= current quantity. |

**Processing Logic**:

1. Authenticate the user. Verify the order belongs to the authenticated user.
2. Verify the order is in a modifiable state: `PENDING` or `PARTIAL_FILL`.
3. Validate the new values:
   - Price/stop_price: must pass the same price validation rules as signal creation (correct side of entry, minimum distance). [Cross-reference: FSD-003a EX-FR-013]
   - Quantity: can only be reduced, never increased. Must be >= 1.
4. Send modification request to the broker adapter.
5. On broker confirmation: update the order record, create `order_events` record with previous and new values.
6. If modifying a stop loss order: update the position's `stop_loss_price` and recalculate `planned_risk`.
7. If modifying a take profit order: update the position's `take_profit_price`.
8. Log to `execution_audit_log`: event_type=`manual.modify`, order_id, original values, new values, user_id, timestamp.

**Error Handling**:

| Condition | Response |
|---|---|
| Order not found | HTTP 404 `{"error": "Order not found"}` |
| Order not modifiable | HTTP 400 `{"error": "Order cannot be modified. Current status: {status}"}` |
| Quantity increase attempted | HTTP 400 `{"error": "Quantity can only be reduced, not increased. Current: {current}, Requested: {requested}"}` |
| Price violates risk rules | HTTP 400 `{"error": "{specific validation message}"}` |
| Broker rejects modification | HTTP 502 `{"error": "Broker rejected modification: {broker_message}"}` |

### 7.3 EX-FR-054: Manual Position Close

**Endpoint**: `POST /api/v1/positions/{position_id}/close`

**Processing Logic**:

1. Authenticate the user. Verify the position belongs to the authenticated user.
2. Verify the position `status = 'OPEN'`.
3. Submit a market order to close the position:
   - `side`: `SELL` for LONG, `BUY` for SHORT.
   - `quantity`: position's current quantity.
   - `order_type`: `MARKET`.
4. Cancel the position's stop loss and take profit orders (via broker adapter).
5. On fill: close the position with `exit_reason = 'MANUAL_CLOSE'`.
6. Log to `execution_audit_log`: event_type=`manual.close_position`, position_id, user_id, timestamp.

**Error Handling**:

| Condition | Response |
|---|---|
| Position not found | HTTP 404 `{"error": "Position not found"}` |
| Position already closed | HTTP 400 `{"error": "Position is already closed"}` |
| Broker connection unavailable | HTTP 503 `{"error": "Broker connection unavailable. Please try again or manage the position directly with your broker."}` |

### 7.4 EX-FR-055: Emergency Flatten All

**Endpoint**: `POST /api/v1/positions/flatten-all`

**Request Body**: `{"confirm": true}`

**Processing Logic**:

1. Authenticate the user.
2. Verify `confirm` is `true` in the request body. If missing or false, return HTTP 400: `{"error": "Confirmation required. Send {\"confirm\": true}"}`.
3. Query all OPEN positions for the user.
4. For each position: submit a market order to close.
5. Cancel ALL pending orders for the user (not just those associated with open positions).
6. Disable signal processing for the user (set a flag that pauses new signal acceptance).
7. Target completion: all close orders submitted within 5 seconds.
8. Return HTTP 200 with summary:
   ```json
   {
     "positions_closed": 3,
     "orders_cancelled": 6,
     "signal_processing": "paused",
     "message": "All positions closed and orders cancelled. Signal processing paused. Re-enable in settings."
   }
   ```
9. Log to `execution_audit_log`: event_type=`manual.flatten_all`, positions_closed count, orders_cancelled count, user_id, timestamp.

**Business Rules**:
- Flatten-all uses a single confirmation step (not multi-step) for fast emergency action.
- Close orders are submitted in parallel for speed.
- Signal processing remains paused until the user explicitly re-enables it in settings.
- If any individual close order fails, the system continues closing other positions. Failures are reported in the response:
  ```json
  {
    "positions_closed": 2,
    "positions_failed": 1,
    "failed_positions": [{"position_id": "uuid", "error": "Broker connection unavailable"}],
    "orders_cancelled": 4,
    "signal_processing": "paused"
  }
  ```

---

## 8. Data Specifications

### 8.1 `orders` Table

```sql
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    signal_id UUID NOT NULL REFERENCES signals(id),
    user_id UUID NOT NULL REFERENCES users(id),
    broker VARCHAR(20) NOT NULL,
    broker_order_id VARCHAR(100),
    client_order_id UUID NOT NULL UNIQUE DEFAULT gen_random_uuid(),
    order_type VARCHAR(15) NOT NULL CHECK (order_type IN ('MARKET','LIMIT','STOP','STOP_LIMIT')),
    side VARCHAR(5) NOT NULL CHECK (side IN ('BUY', 'SELL')),
    instrument VARCHAR(20) NOT NULL,
    quantity INTEGER NOT NULL,
    price DECIMAL(12,4),
    stop_price DECIMAL(12,4),
    time_in_force VARCHAR(5) DEFAULT 'GTC' CHECK (time_in_force IN ('DAY','GTC','GTD')),
    status VARCHAR(20) NOT NULL DEFAULT 'CONSTRUCTED'
        CHECK (status IN ('CONSTRUCTED','SUBMITTED','PENDING','PARTIAL_FILL','FILLED','REJECTED','CANCELLED','CLOSED')),
    bracket_group_id UUID,
    bracket_role VARCHAR(15) CHECK (bracket_role IN ('ENTRY', 'STOP_LOSS', 'TAKE_PROFIT')),
    fill_price DECIMAL(12,4),
    fill_quantity INTEGER,
    commission DECIMAL(8,4),
    slippage_ticks DECIMAL(6,2),
    slippage_dollars DECIMAL(8,4),
    is_paper BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    submitted_at TIMESTAMPTZ,
    filled_at TIMESTAMPTZ,
    cancelled_at TIMESTAMPTZ
);

CREATE INDEX idx_orders_signal_id ON orders(signal_id);
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_bracket_group_id ON orders(bracket_group_id);
CREATE INDEX idx_orders_client_order_id ON orders(client_order_id);
CREATE INDEX idx_orders_broker_order_id ON orders(broker_order_id);
```

**Column Notes**:
- `broker_order_id`: populated after broker acknowledges the order. Null for CONSTRUCTED orders.
- `client_order_id`: generated by TrendEdge, sent to broker for correlation. Always populated.
- `fill_price`: the actual execution price. Null until the order fills.
- `slippage_ticks` / `slippage_dollars`: calculated on fill. Positive = adverse slippage.
- `bracket_group_id`: links entry, stop loss, and take profit orders.

### 8.2 `order_events` Table

```sql
CREATE TABLE order_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES orders(id),
    previous_state VARCHAR(20),
    new_state VARCHAR(20) NOT NULL,
    broker_order_id VARCHAR(100),
    fill_price DECIMAL(12,4),
    fill_quantity INTEGER,
    commission DECIMAL(8,4),
    rejection_reason TEXT,
    raw_broker_response JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_order_events_order_id ON order_events(order_id);
CREATE INDEX idx_order_events_created_at ON order_events(created_at);
```

**Usage**:
- One record per state transition. Multiple events per order over its lifetime.
- `raw_broker_response` stores the complete broker message for debugging and audit.
- `previous_state` is null for the first event (CONSTRUCTED has no predecessor).

### 8.3 `positions` Table

```sql
CREATE TABLE positions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    signal_id UUID REFERENCES signals(id),
    entry_order_id UUID REFERENCES orders(id),
    instrument VARCHAR(20) NOT NULL,
    direction VARCHAR(5) NOT NULL,
    quantity INTEGER NOT NULL,
    entry_price DECIMAL(12,4) NOT NULL,
    current_price DECIMAL(12,4),
    stop_loss_price DECIMAL(12,4),
    take_profit_price DECIMAL(12,4),
    stop_loss_order_id UUID REFERENCES orders(id),
    take_profit_order_id UUID REFERENCES orders(id),
    unrealized_pnl DECIMAL(12,4),
    realized_pnl DECIMAL(12,4),
    commission_total DECIMAL(8,4),
    net_pnl DECIMAL(12,4),
    r_multiple DECIMAL(6,2),
    planned_risk DECIMAL(12,4),
    mae_ticks DECIMAL(8,2),
    mfe_ticks DECIMAL(8,2),
    mae_dollars DECIMAL(12,4),
    mfe_dollars DECIMAL(12,4),
    status VARCHAR(10) NOT NULL DEFAULT 'OPEN' CHECK (status IN ('OPEN', 'CLOSED')),
    exit_reason VARCHAR(20) CHECK (exit_reason IN ('STOP_LOSS','TAKE_PROFIT','MANUAL_CLOSE','FLATTEN_ALL','BROKER_LIQUIDATION')),
    is_paper BOOLEAN NOT NULL DEFAULT TRUE,
    opened_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    closed_at TIMESTAMPTZ
);

CREATE INDEX idx_positions_user_id ON positions(user_id);
CREATE INDEX idx_positions_status ON positions(status);
CREATE INDEX idx_positions_instrument ON positions(instrument);
CREATE INDEX idx_positions_user_status ON positions(user_id, status);
```

**Column Notes**:
- `entry_price`: the actual fill price, not the signal's intended entry price.
- `current_price`: updated periodically for open positions. Null for closed positions.
- `stop_loss_order_id` / `take_profit_order_id`: foreign keys to the exit orders in the bracket group.
- `planned_risk`: calculated at position open: `stop_distance_ticks * tick_value * quantity`. Used for R-multiple calculation.
- `r_multiple`: calculated at position close: `net_pnl / planned_risk`. Positive = profit in R terms.
- `mae_ticks` / `mae_dollars`: worst drawdown during position lifetime. Final values stored at close.
- `mfe_ticks` / `mfe_dollars`: best unrealized profit during position lifetime. Final values stored at close.

---

## 9. API Specifications

### 9.1 Order Management Endpoints

#### `GET /api/v1/orders`

**Authentication**: Bearer token (session token).

Returns all orders for the authenticated user.

**Query Parameters**:

| Parameter | Type | Default | Description |
|---|---|---|---|
| `status` | string | all | Filter by status (CONSTRUCTED, SUBMITTED, PENDING, PARTIAL_FILL, FILLED, REJECTED, CANCELLED, CLOSED) |
| `instrument` | string | all | Filter by instrument |
| `is_paper` | boolean | all | Filter by paper/live |
| `from_date` | ISO 8601 | none | Orders created on or after this date |
| `to_date` | ISO 8601 | none | Orders created on or before this date |
| `page` | integer | 1 | Page number |
| `per_page` | integer | 50 | Results per page (max 200) |

**Response 200**:
```json
{
  "orders": [
    {
      "id": "uuid",
      "signal_id": "uuid",
      "instrument": "MNQH6",
      "side": "BUY",
      "order_type": "MARKET",
      "quantity": 2,
      "price": null,
      "stop_price": null,
      "status": "FILLED",
      "bracket_group_id": "uuid",
      "bracket_role": "ENTRY",
      "fill_price": "18450.50",
      "fill_quantity": 2,
      "commission": "1.24",
      "slippage_ticks": "1.00",
      "slippage_dollars": "1.00",
      "is_paper": true,
      "created_at": "2026-02-11T14:30:00Z",
      "submitted_at": "2026-02-11T14:30:01Z",
      "filled_at": "2026-02-11T14:30:02Z"
    }
  ],
  "pagination": {
    "page": 1,
    "per_page": 50,
    "total": 127,
    "total_pages": 3
  }
}
```

#### `GET /api/v1/orders/{order_id}`

**Authentication**: Bearer token. User can only access their own orders.

Returns a single order with full details including order events history.

**Response 200**:
```json
{
  "id": "uuid",
  "signal_id": "uuid",
  "instrument": "MNQH6",
  "side": "BUY",
  "order_type": "MARKET",
  "quantity": 2,
  "status": "FILLED",
  "bracket_group_id": "uuid",
  "bracket_role": "ENTRY",
  "fill_price": "18450.50",
  "events": [
    {"previous_state": null, "new_state": "CONSTRUCTED", "created_at": "2026-02-11T14:30:00Z"},
    {"previous_state": "CONSTRUCTED", "new_state": "SUBMITTED", "created_at": "2026-02-11T14:30:01Z"},
    {"previous_state": "SUBMITTED", "new_state": "FILLED", "fill_price": "18450.50", "fill_quantity": 2, "commission": "1.24", "created_at": "2026-02-11T14:30:02Z"}
  ]
}
```

**Error Responses**:

| HTTP Status | Condition | Response |
|---|---|---|
| 404 | Order not found or belongs to another user | `{"error": "Order not found"}` |

#### `DELETE /api/v1/orders/{order_id}`

**Authentication**: Bearer token.

Cancels a pending/working order. See Section 7.1 for full processing logic.

**Response 200**:
```json
{
  "id": "uuid",
  "status": "CANCELLED",
  "cancelled_at": "2026-02-11T15:00:00Z",
  "message": "Order cancelled successfully"
}
```

**Error Responses**:

| HTTP Status | Condition | Response |
|---|---|---|
| 400 | Order already filled/cancelled | `{"error": "Order cannot be cancelled. Current status: FILLED"}` |
| 404 | Order not found | `{"error": "Order not found"}` |

#### `PATCH /api/v1/orders/{order_id}`

**Authentication**: Bearer token.

Modifies a pending order. See Section 7.2 for full processing logic.

**Request Body** (all fields optional):
```json
{
  "price": 18445.00,
  "stop_price": 18425.00,
  "quantity": 1
}
```

**Response 200**:
```json
{
  "id": "uuid",
  "status": "PENDING",
  "price": "18445.00",
  "stop_price": "18425.00",
  "quantity": 1,
  "message": "Order modified successfully"
}
```

**Error Responses**:

| HTTP Status | Condition | Response |
|---|---|---|
| 400 | Order not modifiable / validation failure | `{"error": "{specific message}"}` |
| 404 | Order not found | `{"error": "Order not found"}` |
| 502 | Broker rejected modification | `{"error": "Broker rejected modification: {broker_message}"}` |

### 9.2 Position Management Endpoints

#### `GET /api/v1/positions`

**Authentication**: Bearer token.

Returns all positions for the authenticated user.

**Query Parameters**:

| Parameter | Type | Default | Description |
|---|---|---|---|
| `status` | string | all | `OPEN` or `CLOSED` |
| `instrument` | string | all | Filter by instrument |
| `is_paper` | boolean | all | Filter by paper/live |
| `from_date` | ISO 8601 | none | Positions opened on or after this date |
| `to_date` | ISO 8601 | none | Positions opened on or before this date |
| `page` | integer | 1 | Page number |
| `per_page` | integer | 50 | Results per page (max 200) |

**Response 200**:
```json
{
  "positions": [
    {
      "id": "uuid",
      "instrument": "MNQH6",
      "direction": "LONG",
      "quantity": 2,
      "entry_price": "18450.50",
      "current_price": "18475.25",
      "stop_loss_price": "18420.00",
      "take_profit_price": "18510.50",
      "unrealized_pnl": "49.50",
      "planned_risk": "61.00",
      "mae_ticks": "4.00",
      "mfe_ticks": "99.00",
      "status": "OPEN",
      "is_paper": true,
      "opened_at": "2026-02-11T14:30:02Z"
    }
  ],
  "pagination": {
    "page": 1,
    "per_page": 50,
    "total": 5,
    "total_pages": 1
  }
}
```

#### `POST /api/v1/positions/{position_id}/close`

**Authentication**: Bearer token.

Closes an open position at market. See Section 7.3 for full processing logic.

**Response 200**:
```json
{
  "position_id": "uuid",
  "status": "CLOSED",
  "exit_reason": "MANUAL_CLOSE",
  "realized_pnl": "49.50",
  "net_pnl": "47.02",
  "r_multiple": "0.77",
  "close_order_id": "uuid",
  "message": "Position closed at market"
}
```

**Error Responses**:

| HTTP Status | Condition | Response |
|---|---|---|
| 400 | Position already closed | `{"error": "Position is already closed"}` |
| 404 | Position not found | `{"error": "Position not found"}` |
| 503 | Broker unavailable | `{"error": "Broker connection unavailable. Please try again or manage the position directly with your broker."}` |

#### `POST /api/v1/positions/flatten-all`

**Authentication**: Bearer token.

Emergency flatten all positions. See Section 7.4 for full processing logic.

**Request Body**: `{"confirm": true}`

**Response 200**:
```json
{
  "positions_closed": 3,
  "orders_cancelled": 6,
  "signal_processing": "paused",
  "message": "All positions closed and orders cancelled. Signal processing paused. Re-enable in settings."
}
```

**Error Responses**:

| HTTP Status | Condition | Response |
|---|---|---|
| 400 | Missing confirmation | `{"error": "Confirmation required. Send {\"confirm\": true}"}` |

### 9.3 WebSocket Events (Order & Position)

**Connection**: `WS /api/v1/ws/execution` [Cross-reference: FSD-003a for full WebSocket specification]

| Event Type | Payload | Description |
|---|---|---|
| `order.status_changed` | `{order_id, previous_status, new_status, fill_price, timestamp}` | Order state transition |
| `position.updated` | `{position_id, current_price, unrealized_pnl, mae, mfe}` | Position P&L update (real-time) |
| `position.closed` | `{position_id, exit_reason, realized_pnl, r_multiple}` | Position closed |

---

## 10. UI/UX Specifications

### 10.1 Active Orders Panel

**Location**: Dashboard, below the chart or in a side panel.

**Columns**: Order ID (truncated), Instrument, Side (BUY/SELL), Type (MKT/LMT/STP), Qty, Price, Status, Actions.

**Status Indicators**:
- CONSTRUCTED: gray dot
- SUBMITTED: blue dot + spinner
- PENDING: yellow dot
- PARTIAL_FILL: orange dot + "X/Y filled"
- FILLED: green dot
- REJECTED: red dot + tooltip with rejection reason
- CANCELLED: gray strikethrough

**Actions**:
- Cancel button (X icon) on PENDING orders. Confirmation tooltip: "Cancel this order?"
- Modify button (pencil icon) on PENDING orders. Opens inline edit for price/stop/target.

### 10.2 Open Positions Panel

**Location**: Dashboard, prominent position.

**Columns**: Instrument, Direction (LONG/SHORT with color), Qty, Entry, Current, P&L ($), P&L (R), Stop, Target, Time In Position, Actions.

**P&L Color**: Green for positive, red for negative. Flashes briefly on update.

**Actions**:
- "Close" button on each position. Confirmation: "Close {instrument} {direction} position at market?"
- "Modify Stop" and "Modify Target" inline edit buttons.

### 10.3 Emergency Flatten All Button

**Location**: Dashboard header bar, always visible. Red button labeled "FLATTEN ALL".

**Confirmation Dialog**: Modal with:
- Text: "This will immediately close ALL open positions and cancel ALL pending orders. This action cannot be undone."
- Single "Confirm Flatten All" button (red).
- "Cancel" button.
- No additional confirmation steps (fast path per PRD requirement).

---

## 11. Performance Specifications

### 11.1 Latency Targets

| Metric | Target (p50) | Target (p95) | Measurement Point |
|---|---|---|---|
| Order construction (signal to CONSTRUCTED) | < 100ms | < 300ms | Time from risk check pass to orders persisted |
| Broker order submission (CONSTRUCTED to SUBMITTED) | < 200ms | < 500ms | Time from construction to broker adapter call |
| Fill event to position update | < 100ms | < 500ms | Time from fill event to position record updated |
| Fill event to dashboard update (WebSocket) | < 500ms | < 2s | Time from fill event to WebSocket push sent |
| Flatten-all completion (all close orders submitted) | < 3s | < 5s | Time from confirm to all close orders sent |

### 11.2 Throughput Targets

| Metric | Target | Notes |
|---|---|---|
| Concurrent order constructions | 50/second across all users | Limited by database write throughput |
| Position monitoring updates | 500 positions per polling cycle | Paper simulator polling loop capacity |
| WebSocket position.updated events | 10/second per client | Rate-limited to avoid flooding the dashboard |

---

## 12. Testing Specifications

### 12.1 Unit Tests -- Order Quantity Calculation

| Test ID | Test Case | Input | Expected |
|---|---|---|---|
| UT-QC-001 | Standard calculation | risk=$100, stop=40 ticks, tick_val=$0.50 | qty=5 (100/20=5) |
| UT-QC-002 | Clamped to max position size | risk=$100, stop=10 ticks, tick_val=$0.50, max=2 | qty=2 (floor(100/5)=20, clamped to 2) |
| UT-QC-003 | Minimum of 1 (risk < per-contract) | risk=$100, stop=300 ticks, tick_val=$0.50 | qty=1 (floor(100/150)=0, min=1) + warning |
| UT-QC-004 | Exact division | risk=$100, stop=200 ticks, tick_val=$0.50 | qty=1 (floor(100/100)=1) |
| UT-QC-005 | Zero stop distance | risk=$100, stop=0 ticks | REJECTED: "Cannot calculate quantity: stop distance is zero" |

### 12.2 Unit Tests -- Order State Machine

| Test ID | Test Case | Input | Expected |
|---|---|---|---|
| UT-SM-001 | CONSTRUCTED -> SUBMITTED | place_order() called | Status=SUBMITTED, submitted_at set, order_event created |
| UT-SM-002 | SUBMITTED -> FILLED (market order) | Broker fill event | Status=FILLED, filled_at set, position created |
| UT-SM-003 | SUBMITTED -> REJECTED | Broker rejection | Status=REJECTED, rejection_reason set, signal updated |
| UT-SM-004 | SUBMITTED -> PENDING (limit order) | Broker acknowledgment | Status=PENDING, order_event created |
| UT-SM-005 | PENDING -> FILLED | Price reached | Status=FILLED, fill details recorded |
| UT-SM-006 | PENDING -> CANCELLED (user cancel) | User DELETE request | Status=CANCELLED, cancelled_at set |
| UT-SM-007 | PENDING -> PARTIAL_FILL | Partial fill event | Status=PARTIAL_FILL, partial fill recorded |
| UT-SM-008 | PARTIAL_FILL -> FILLED | Remaining fills | Status=FILLED, all fills accumulated |
| UT-SM-009 | PARTIAL_FILL -> CANCELLED | User cancels remainder | Status=CANCELLED, partial position exists |
| UT-SM-010 | Invalid transition: CANCELLED -> FILLED | Fill event on cancelled | State NOT changed, WARNING logged |
| UT-SM-011 | Invalid transition: REJECTED -> SUBMITTED | Re-submit attempt | Transition rejected, ERROR logged |

### 12.3 Unit Tests -- OCO Management

| Test ID | Test Case | Input | Expected |
|---|---|---|---|
| UT-OCO-001 | Stop loss fills -> cancel take profit | SL fill event | SL=FILLED, TP=CANCELLED(OCO_TRIGGERED), position closed, exit_reason=STOP_LOSS |
| UT-OCO-002 | Take profit fills -> cancel stop loss | TP fill event | TP=FILLED, SL=CANCELLED(OCO_TRIGGERED), position closed, exit_reason=TAKE_PROFIT |
| UT-OCO-003 | Entry rejected -> cancel both exits | Entry REJECTED event | Entry=REJECTED, SL=CANCELLED(ENTRY_REJECTED), TP=CANCELLED(ENTRY_REJECTED), signal=REJECTED |
| UT-OCO-004 | Double fill (race condition) | Both SL and TP fill | Both FILLED, CRITICAL alert to user, position closed with discrepancy flag |
| UT-OCO-005 | Cancel fails (broker unreachable) | SL fills, TP cancel fails | 3 retry attempts, CRITICAL alert to user if all fail |

### 12.4 Unit Tests -- Position P&L

| Test ID | Test Case | Input | Expected |
|---|---|---|---|
| UT-PNL-001 | LONG unrealized profit | entry=18450, current=18460, qty=2, tick_size=0.25, tick_val=$0.50 | unrealized_pnl = $40.00 ((18460-18450)/0.25 * 0.50 * 2) |
| UT-PNL-002 | LONG unrealized loss | entry=18450, current=18440, qty=2 | unrealized_pnl = -$40.00 |
| UT-PNL-003 | SHORT unrealized profit | entry=18450, current=18440, qty=1 | unrealized_pnl = $20.00 |
| UT-PNL-004 | Realized P&L with commission | entry=18450, exit=18490, qty=2, commission=$2.48 | realized_pnl=$80.00, net_pnl=$77.52 |
| UT-PNL-005 | R-multiple calculation | net_pnl=$77.52, planned_risk=$40.00 | r_multiple=1.94 |
| UT-PNL-006 | MAE tracking (LONG) | entry=18450, prices seen: 18445, 18460, 18440, 18475 | mae_ticks=40 ((18450-18440)/0.25), mae_dollars=$40.00 |
| UT-PNL-007 | MFE tracking (LONG) | entry=18450, prices seen: 18445, 18460, 18440, 18475 | mfe_ticks=100 ((18475-18450)/0.25), mfe_dollars=$100.00 |

### 12.5 Integration Tests

#### 12.5.1 Bracket Order Construction & Submission (EX-TEST-023)

1. Create a signal that passes all risk checks (status=RISK_PASSED).
2. Verify three orders are created with the same bracket_group_id.
3. Verify entry order has correct side, type, quantity, and price.
4. Verify stop loss order has correct side, stop_price, and bracket_role.
5. Verify take profit order has correct side, price, and bracket_role.
6. Verify signal status is updated to EXECUTING.
7. Verify entry order is submitted to broker adapter.
8. Simulate entry fill. Verify position is created with correct values.
9. Verify stop loss and take profit orders are submitted to broker after entry fill.

#### 12.5.2 Full Lifecycle: Entry to Stop Loss Exit (EX-TEST-044)

1. Submit a webhook signal.
2. Wait for order construction and submission.
3. Simulate entry fill.
4. Verify position opens with correct entry_price, planned_risk.
5. Simulate price moving adversely to stop loss level.
6. Simulate stop loss fill.
7. Verify take profit is cancelled (OCO).
8. Verify position closes with exit_reason=STOP_LOSS.
9. Verify realized_pnl, net_pnl, r_multiple are calculated correctly.
10. Verify trade.closed event is emitted.

#### 12.5.3 Full Lifecycle: Entry to Take Profit Exit (EX-TEST-045)

Same as above but price moves favorably to take profit. Exit reason = TAKE_PROFIT. R-multiple should be positive (>= 2.0 if minimum R:R is 2.0).

#### 12.5.4 Manual Close During Open Position (EX-TEST-052)

1. Open a position via signal.
2. Call `POST /api/v1/positions/{id}/close`.
3. Verify market close order is submitted.
4. Verify stop loss and take profit are cancelled.
5. Verify position closes with exit_reason=MANUAL_CLOSE.

#### 12.5.5 Flatten All with Multiple Positions (EX-TEST-055)

1. Open 3 positions across different instruments.
2. Call `POST /api/v1/positions/flatten-all` with `{"confirm": true}`.
3. Verify all 3 positions are closed.
4. Verify all pending exit orders are cancelled.
5. Verify signal processing is paused.
6. Verify response contains correct counts.
7. Verify total time < 5 seconds.

### 12.6 Failover Tests

#### 12.6.1 Double Fill Detection (EX-TEST-046-edge)

1. Simulate a scenario where both stop loss and take profit fill simultaneously (race condition).
2. Verify the system detects the double fill.
3. Verify an alert is sent to the user: "Double fill detected for position {id}. Both stop loss and take profit filled. Please check your broker account."
4. Verify the position is marked as CLOSED with a discrepancy flag.

#### 12.6.2 Broker Disconnection During Order Submission (EX-TEST-014)

1. Start an order submission.
2. Simulate broker connection drop mid-submission.
3. Verify the circuit breaker counter increments. [Cross-reference: FSD-003c EX-FR-050]
4. Verify the user receives a notification.
5. Simulate reconnection.
6. Verify the system queries the broker for the order status.
7. If the broker confirms the order was placed, verify TrendEdge updates its records accordingly.

---

## 13. Cross-References

| Topic | Sub-FSD | Key Specifications |
|---|---|---|
| Signal ingestion, normalization, validation, deduplication | FSD-003a | EX-FR-001 through EX-FR-015 |
| Risk management engine, risk checks, risk settings | FSD-003b | EX-FR-016 through EX-FR-022 |
| Broker adapters (IBKR, Tradovate, Paper Simulator), circuit breaker | FSD-003c | EX-FR-028 through EX-FR-041, EX-FR-050 |
| Trade journaling | FSD-004 | trade.closed event consumption |
| Analytics and playbook | FSD-005 | trade.closed event consumption |
| Market data and pricing | FSD-010 | Redis market price cache, position monitoring data |

---

## Changelog

- 2026-02-11: Initial sub-FSD extracted from FSD-003 v1.0

---

*FSD-003d v1.0 -- Order Construction & Lifecycle*
*TrendEdge -- February 2026*
